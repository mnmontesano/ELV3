<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertical Terminal</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        /* Add these CSS variables right after the <style> tag */
        :root {
            /* Light theme (default) */
            --bg-color: #ffffff;
            --text-color: #000000;
            --card-bg: #f5f5f5;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --panel-bg: #f0f0f0;
            --highlight-bg: #e0e0e0;
            --result-bg: #f5f5f5;
            --header-color: #333333;
            --button-bg: #000000;
            --button-text: #ffffff;
            --button-hover-bg: #333333;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark theme */
                --bg-color: #1a1a1a;
                --text-color: #ffffff;
                --card-bg: #2c2c2c;
                --card-shadow: rgba(0, 0, 0, 0.3);
                --input-bg: #1c1c1c;
                --input-border: #444444;
                --panel-bg: #333333;
                --highlight-bg: #3c3c3c;
                --result-bg: #2c2c2c;
                --header-color: #4a9eff;
                --button-bg: #ffffff;
                --button-text: #000000;
                --button-hover-bg: #cccccc;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-weight: 900;
            margin: 20px 0;
        }

        .logo {
            display: block;
            margin: 5px auto;
            max-width: 100px;
            height: auto;
        }

        .input-group {
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        input {
            width: 80%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 5px auto;
            display: block;
        }

        .result {
            margin: 10px auto;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            width: 80%;
            display: block;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #333;
        }

        .image-viewer {
            width: 100%;
            height: 80vh;
            margin: 20px 0;
        }

        .image-viewer iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #fff;
            }

            input {
                background-color: #333;
                color: #fff;
                border-color: #666;
            }

            .result {
                background-color: #333;
            }

            button {
                background-color: #fff;
                color: #000;
            }

            button:hover {
                background-color: #ccc;
            }
        }

        @media (max-width: 600px) {
            .input-group {
                width: 90%;
            }
            
            input, .result {
                width: 90%;
            }

            .notes-textarea {
                width: 90%;
            }

            .date-buttons-group {
                display: none !important;
            }
            .date-dropdown-group {
                display: block !important;
            }
        }

        .feedback-button {
            margin-top: 40px;
            margin-bottom: 40px;
        }

        .notes-container {
            max-width: 500px;
            margin: 30px auto;
            text-align: center;
        }

        .notes-textarea {
            width: 80%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            margin: 10px auto;
            resize: vertical;
            display: block;
        }

        @media (prefers-color-scheme: dark) {
            .notes-textarea {
                background-color: #333;
                color: #fff;
                border-color: #666;
            }
        }

        .credit-text {
            text-align: center;
            color: #666;  /* grey color */
            opacity: 0.7;  /* adds transparency */
            font-size: 0.9em;
            margin: 20px 0;
        }

        .social-icons {
            display: flex;
            justify-content: center;
            gap: 20px;  /* space between icons */
            margin: 15px 0;
        }

        .social-icon {
            width: 24px;  /* size of icons */
            height: 24px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .social-icon:hover {
            opacity: 1;
        }

        .dob-viewer {
            width: 100%;
            height: 80vh;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: both;
            overflow: hidden;
            min-height: 300px;
            min-width: 300px;
            max-height: 90vh;
            max-width: 100%;
            position: relative;
        }

        .dob-viewer iframe {
            width: 150%;
            height: 150%;
            border: none;
            transform: scale(0.67);
            transform-origin: 0 0;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;     /* Changed from 2px to 15px for a larger gap */
            margin: 20px 0;
        }

        .tab-button {
            margin: 0;
            border-radius: 0;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .disclaimer {
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        /* Show buttons by default; hide dropdown */
        #tabButtons {
            display: flex;
        }

        #tabDropdown {
            display: none;
        }

        /* For small screens, hide buttons and show dropdown */
        @media (max-width: 900px) {
            #tabButtons {
                display: none;
            }
            #tabDropdown {
                display: block;
            }
            
            .dropdown {
                position: static;
                margin: 10px auto;
                text-align: center;
            }
            
            .dropdown-button {
                display: block;
                margin: 10px auto;
                width: fit-content;
            }

            .dropdown-content {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 200px;
            }
        }

        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-left {
            flex: 1;
            min-width: 0;  /* Prevents flex item from overflowing */
        }

        .reference-panel {
            width: 350px;  /* Slightly wider to accommodate content */
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 80vh;  /* Set a fixed height */
            overflow-y: auto;  /* Enable scrolling */
            display: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .reference-panel ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .reference-panel li {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .reference-panel h3 {
            background-color: #f5f5f5;
            padding: 10px 0;
            margin: 0;
            clear: both;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel {
                background-color: #333;
                box-shadow: 0 0 10px rgba(255,255,255,0.1);
            }
            .reference-panel h3 {
                background-color: #333;
            }
        }

        @media (max-width: 900px) {
            .reference-panel {
                width: 90%;
                max-height: 80vh;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        }

        .show-reference-mobile {
            display: none;
        }

        @media (max-width: 900px) {
            .show-reference-mobile {
                display: block;
                margin: 10px auto;
            }
        }

        .toggle-reference {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1001;
            padding: 8px 16px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Add this media query to adjust button position on smaller screens */
        @media (max-width: 900px) {
            .toggle-reference {
                position: static;  /* Change from fixed to static positioning */
                display: block;
                margin: 10px auto;  /* Center the button */
                width: fit-content;
            }
        }

        /* Existing dark mode styles */
        @media (prefers-color-scheme: dark) {
            .toggle-reference {
                background-color: #fff;
                color: #000;
            }
            .toggle-reference:hover {
                background-color: #ccc;
            }
        }

        /* Add these styles to your existing CSS */
        .reference-panel {
            /* ... existing styles ... */
            position: fixed;
            z-index: 1000;
        }

        .reference-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .close-reference {
            position: sticky;  /* Change from absolute to sticky */
            top: 0;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;  /* Make it slightly bigger */
            cursor: pointer;
            color: #666;
            padding: 5px 10px;
            float: right;     /* Add float to position it on the right */
            z-index: 2;       /* Ensure it's above other content */
            margin-top: -5px; /* Adjust vertical position */
        }

        .reference-panel h3 {
            background-color: #f5f5f5;
            padding: 10px 0;
            margin: 0;
            clear: both;
        }

        .close-reference:hover {
            color: #000;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel h3 {
                background-color: #333;
            }
            .close-reference {
                color: #999;
            }
            .close-reference:hover {
                color: #fff;
            }
        }

        .reference-panel ul li[style*="font-weight: bold"] {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 20px;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel ul li[style*="font-weight: bold"] {
                border-bottom-color: #666;
            }
        }

        .dropdown {
            position: fixed;  /* Change from absolute to fixed */
            top: 20px;
            left: 20px;
            z-index: 1001;  /* Ensure it stays above other content */
        }

        /* Add this media query to match Quick Reference button behavior */
        @media (max-width: 900px) {
            .dropdown {
                position: static;  /* Change from fixed to static */
                margin: 10px auto;
                text-align: center;
            }
            
            .dropdown-button {
                display: block;
                margin: 10px auto;
                width: fit-content;
            }

            .dropdown-content {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 200px;
            }
        }

        .dropdown-button {
            background-color: #000;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            margin-top: 5px;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            margin: 0;
            display: block;
            background: none;
            color: black;
            text-align: left;
            border-radius: 0;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            width: 300px;
        }

        @media (prefers-color-scheme: dark) {
            .dropdown-button {
                background-color: #fff;
                color: #000;
            }
            .dropdown-content {
                background-color: #333;
            }
            .dropdown-content button {
                color: white;
            }
            .dropdown-content button:hover {
                background-color: #444;
            }
            .settings-modal {
                background: #333;
                color: white;
            }
        }

        @media (max-width: 600px) {
            .dropdown {
                position: static;
                margin: 20px auto;
                text-align: center;
            }
            .dropdown-content {
                position: relative;
                width: 100%;
                margin: 5px auto;
            }
        }

        /* Add a search icon class */
        .search-icon {
            display: none;  /* Hidden by default */
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Add media query for small screens */
        @media (max-width: 400px) {
            .lookup-button {
                width: 40px !important;
                height: 40px !important;
                padding: 10px !important;
                border-radius: 8px !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
            }

            .lookup-button span {
                display: none;  /* Hide text */
            }

            .lookup-button .search-icon {
                display: block;  /* Show icon */
            }
        }

        @media (max-width: 600px) {
            .button-text {
                display: none;
            }
            .button-icon {
                display: block !important;
            }
            [onclick="toggleQuickLookup()"] {
                padding: 12px !important;
                border-radius: 50% !important;
                width: 48px !important;
                height: 48px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }

        /* Update the lookup button styles */
        .lookup-button {
            padding: 12px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;  /* Set minimum width for text mode */
        }

        /* Style for the clear (X) button */
        button[onclick*="clearDeviceSearch"] {
            padding: 12px;
            background: #333;
            color: #ff6b6b;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 5px;
        }

        /* Style for the search icon */
        .button-icon {
            width: 24px;
            height: 24px;
            display: none;  /* Hide icon by default */
        }

        /* Mobile styles */
        @media (max-width: 600px) {
            .lookup-button {
                width: 48px !important;
                height: 48px !important;
                min-width: unset !important;  /* Remove min-width on mobile */
                padding: 12px !important;
            }

            .button-text {
                display: none !important;
            }

            .button-icon {
                display: block !important;
            }
        }

        /* Add these styles to your existing CSS */
        .close-reference {
            color: #ff6b6b !important;
            transition: color 0.2s;
        }

        .close-reference:hover {
            color: #ff3333 !important;
        }

        #quickLookupPanel button[onclick="toggleQuickLookup()"]:hover {
            color: #ff3333;
        }

        /* Add these CSS rules to force light/dark mode on all DOB lookup results */
        #deviceResult div, 
        #binResult div,
        #bulkResult div,
        #quickDeviceResult div,
        #quickBinResult div,
        #quickAddressResult div,
        #quickBulkResult div {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        #deviceResult [style*="background: #1c1c1c"],
        #deviceResult [style*="background: #2c2c2c"],
        #deviceResult [style*="background:#1c1c1c"],
        #deviceResult [style*="background:#2c2c2c"],
        #binResult [style*="background: #1c1c1c"],
        #binResult [style*="background: #2c2c2c"],
        #bulkResult [style*="background: #1c1c1c"],
        #bulkResult [style*="background: #2c2c2c"] {
            background: var(--panel-bg) !important;
        }

        #deviceResult strong,
        #binResult strong,
        #bulkResult strong,
        #quickDeviceResult strong,
        #quickBinResult strong,
        #quickAddressResult strong,
        #quickBulkResult strong {
            color: var(--header-color) !important;
        }

        /* Force buttons inside results to use theme colors */
        #deviceResult button,
        #binResult button,
        #bulkResult button {
            background-color: var(--panel-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        /* Override any inline styles that might be causing dark backgrounds */
        [style*="background: #1c1c1c"],
        [style*="background:#1c1c1c"],
        [style*="background: #2c2c2c"],
        [style*="background:#2c2c2c"] {
            background: var(--input-bg) !important;
        }

        /* For nested elements with dark backgrounds */
        [style*="background: #1c1c1c"] div,
        [style*="background:#1c1c1c"] div,
        [style*="background: #2c2c2c"] div,
        [style*="background:#2c2c2c"] div {
            background: var(--input-bg) !important;
        }

        /* Add responsive styles for ELV3 Lookup panel */
        @media (max-width: 600px) {
            #quickLookupPanel {
                top: 60px !important;
                right: 0 !important;
                left: 0 !important;
                margin: 0 auto !important;
                max-width: calc(100% - 20px) !important;
                width: calc(100% - 20px) !important;
                padding: 15px !important;
            }
            
            #quickLookupPanel input,
            #quickLookupPanel div[id$="Result"] {
                font-size: 16px !important; /* Larger font size for better mobile readability */
            }
            
            /* Make the toggle button more touch-friendly on mobile */
            button[onclick="toggleQuickLookup()"] {
                padding: 10px !important;
                border-radius: 50% !important;
                width: 44px !important;
                height: 44px !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            /* Class for centered panel on mobile */
            .panel-centered-mobile {
                right: 0 !important;
                left: 0 !important;
                margin: 0 auto !important;
            }
        }
        
        /* Add medium screen size responsiveness */
        @media (min-width: 601px) and (max-width: 900px) {
            #quickLookupPanel {
                width: 300px !important;
                max-width: calc(100% - 40px) !important;
                right: 20px !important;
                left: auto !important;
            }
        }
        
        /* Ensure all inputs and result boxes use border-box sizing */
        #quickLookupPanel input,
        #quickLookupPanel div[id$="Result"],
        #quickLookupPanel button {
            box-sizing: border-box;
        }
        
        /* Ensure text wraps properly in result boxes */
        #quickLookupPanel div[id$="Result"] {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* Add transition styles for the overlay and panel */
        #quickLookupOverlay {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #quickLookupPanel {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Add these mobile-specific styles in the <style> section */
        @media (max-width: 600px) {
            /* Filter buttons adjustments */
            .filter-buttons-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .filter-buttons-group button,
            .filter-buttons-group div {
                width: 100% !important;
            }
            
            /* Device listing adjustments */
            .device-item {
                margin-bottom: 15px;
            }
            
            /* Make the status and test status stack on mobile */
            .device-status-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .device-status-container > div {
                width: 100%;
            }
            
            /* Adjust the test status badge */
            .test-status-badge {
                justify-content: center;
                margin-top: 5px;
            }
            
            /* Make buttons more touch-friendly */
            .device-action-button {
                padding: 12px 5px !important;
                margin-top: 8px !important;
            }
            
            /* Adjust spacing for better readability */
            .device-info-section {
                margin-top: 12px;
                padding: 12px;
            }
            
            /* Make the filter dropdown full width */
            #deviceTypeFilter {
                width: 100% !important;
            }
            
            /* Adjust the device type sections */
            .device-type-section {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Make sure this is right after the opening <body> tag -->
    <div id="quickLookupOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <!-- Quick Lookup Panel moved here so it's available for all tabs -->
    <div style="position: fixed; top: 80px; right: 20px; width: 350px; max-width: calc(100% - 40px); background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--card-shadow); z-index: 1000; display: none; transition: all 0.3s ease; left: auto;" id="quickLookupPanel">
        <button onclick="toggleQuickLookup()" style="position: absolute; right: 10px; top: 10px; background: none; border: none; color: #ff6b6b; font-size: 24px; cursor: pointer; transition: color 0.2s;">×</button>
        <h3 style="color: var(--text-color); margin-bottom: 15px; text-align: center;">ELV3 Lookup</h3>
        
        <!-- ELV3 Lookup Fields -->
        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickNumInput" 
                   placeholder="Enter Elevator Part Number"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickLetterInput" 
                   placeholder="Enter Violating Condition"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickLetterResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickSecondaryNumInput" 
                   placeholder="Enter Suggested Remedy"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickSecondaryNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <button onclick="quickClearInputs()" 
                style="width: 100%; padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; box-sizing: border-box;">
            Clear
        </button>

        <!-- Add BIN display section -->
        <div id="quickBinDisplay" style="text-align: center; margin-top: 5px; padding: 8px; background: var(--panel-bg); border-radius: 4px; color: var(--text-color);">
            <strong>BIN:</strong> <span id="quickBinValue">-</span>
        </div>
    </div>

    <div class="dropdown">
        <button onclick="toggleDropdown()" class="dropdown-button">Menu ☰</button>
        <div id="dropdownContent" class="dropdown-content">
            <button onclick="openSettings()">Settings</button>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal">
        <h3>Settings</h3>
        <label for="defaultTab">Default Starting Tab:</label>
        <select id="defaultTab" style="width: 100%; padding: 8px; margin: 10px 0;">
            <option value="main">ELV3 Terminal</option>
            <option value="dob">DOB Terminal</option>
            <option value="dates">Dates Terminal</option>
            <option value="pdf">PDF Terminal</option>
        </select>
        <button onclick="saveSettings()">Save</button>
        <button onclick="closeSettings()" style="background-color: #666;">Cancel</button>
    </div>

    <div id="settingsOverlay" class="reference-overlay"></div>

    <a href="javascript:window.location.reload()">
        <img src="https://github.com/mnmontesano/ELV3/blob/main/ELV3%20Cheat%20Sheet%20Icon.png?raw=true" alt="Logo" class="logo">
    </a>
    <h1 id="pageTitle">ELV3 Terminal</h1>

    <!-- Button-based Tabs (default for larger screens) -->
    <div id="tabButtons" class="tab-buttons">
        <button onclick="showTab('main')" id="mainTab" class="tab-button">ELV3</button>
        <button onclick="showTab('dob')" id="dobTab" class="tab-button">DOB</button>
        <button onclick="showTab('dates')" id="datesTab" class="tab-button">DATES</button>
        <button onclick="showTab('pdf')" id="pdfTab" class="tab-button">PDF</button>
    </div>

    <!-- Dropdown-based Tabs (visible on small screens) -->
    <div id="tabDropdown" class="tab-dropdown" style="margin: 20px auto; text-align: center;">
        <select id="tabSelect" onchange="showTab(this.value)" style="font-size: 1.2em; padding: 5px; text-align: center; text-align-last: center;">
            <option value="main">ELV3</option>
            <option value="dob">DOB</option>
            <option value="dates">DATES</option>
            <option value="pdf">PDF</option>
        </select>
    </div>

    <div id="mainContent" class="content-section active">
        <button class="toggle-reference" onclick="toggleReference()">ELV3 Reference</button>
        <div class="main-container">
            <div class="main-left">
                <div class="input-group">
                    <input type="text" id="numInput" placeholder="Enter Elevator Part Number">
                    <div id="numResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="letterInput" placeholder="Enter Violating Condition">
                    <div id="letterResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="secondaryNumInput" placeholder="Enter Suggested Remedy">
                    <div id="secondaryNumResult" class="result"></div>
                </div>

                <button onclick="clearInputs()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em;">Clear</button>
                <button onclick="togglePdfViewer()" id="pdfToggleButton">Show PDF</button>

                <div class="image-viewer hidden" id="pdfViewer">
                    <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                        onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                        <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
                    </iframe>
                </div>

                <div class="notes-container">
                    <h3>Notes</h3>
                    <textarea id="Notes" class="notes-textarea" 
                        placeholder="Enter your notes here..."></textarea>
                </div>
            </div>
        </div>

        <!-- Add this div right after your mainContent div opens -->
        <div class="reference-overlay" onclick="toggleReference()"></div>

        <!-- Modify your reference panel div to include the close button -->
        <div class="reference-panel">
            <button class="close-reference" onclick="toggleReference()" style="position: sticky; top: 0; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #ff6b6b; padding: 5px 10px; float: right; z-index: 2; margin-top: -5px;">×</button>
            <h3>ELV3 Reference</h3>
            
            <p><strong>Part Numbers:</strong></p>
            <ul>
                <li style="font-weight: bold; color: #666;">Inside Car (01-15)</li>
                <li>01: Emergency Stop Switch</li>
                <li>02: Alarm System</li>
                <li>03: Car Enclosure</li>
                <li>04: Side Emergency Exit</li>
                <li>05: Car Door/Gate</li>
                <li>06: Car Door/Gate Contact</li>
                <li>07: Door Reopening Device</li>
                <li>08: Car Floor to Landing Still</li>
                <li>09: Car Floor</li>
                <li>10: Car Door Gibs</li>
                <li>11: Car Button Station</li>
                <li>12: Car Lighting</li>
                <li>13: Emergency Lighting</li>
                <li>14: Car Mirror</li>
                <li>15: Certificate Frame</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Outside Hoistway (16-25)</li>
                <li>16: Hoistway Doors</li>
                <li>17: Hoistway Door Gibs</li>
                <li>18: Hoistway Door Reinforcements</li>
                <li>19: Hoistway Door Safety Retainer</li>
                <li>20: Vision Panel</li>
                <li>21: Interlocks</li>
                <li>22: Parking Device</li>
                <li>23: Hall Button Station</li>
                <li>24: Indicators</li>
                <li>25: Door Safety Retainer</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Top of Car (26-39)</li>
                <li>26: Top Emergency Exit Cover</li>
                <li>27: Governor Release Carrier</li>
                <li>28: Door Hangers & Connectors</li>
                <li>29: Door Operator</li>
                <li>30: Normal Limits</li>
                <li>31: Final Limits</li>
                <li>32: Guide Shoes / Roller Guides</li>
                <li>33: Counterweight</li>
                <li>34: Hoistway</li>
                <li>35: Electrical Wiring</li>
                <li>36: Pipes and Ducts</li>
                <li>37: Overhead & Deflector Sheave</li>
                <li>38: Traveling Cable & Junction</li>
                <li>39: Car Top</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Machine Room (40-69)</li>
                <li>40: Machine Room</li>
                <li>41: Machine Room Door</li>
                <li>42: Controller—Selector</li>
                <li>43: Reverse Phase Relay</li>
                <li>44: Traction Sheave</li>
                <li>45: Governor</li>
                <li>46: Governor Switch</li>
                <li>47: Drum</li>
                <li>48: Pump Unit</li>
                <li>49: Drum Machine Limit SW</li>
                <li>50: Generator</li>
                <li>51: Slack Rope Switch</li>
                <li>52: Hoist Cables</li>
                <li>53: Governor Ropes</li>
                <li>54: Car Counterweight Rope</li>
                <li>55: Drum Counterweight Rope</li>
                <li>56: Hoist Machine</li>
                <li>57: Hoist Motor</li>
                <li>58: Worm / Gear / Bearings</li>
                <li>59: Machine Brake</li>
                <li>60: Lighting Machine Space</li>
                <li>61: Machine Disconnect SW</li>
                <li>62: Commutator</li>
                <li>63: Motor Brushes</li>
                <li>64: NYC Device #</li>
                <li>65: Unintended Car Movement</li>
                <li>66: Emergency Brake/Rope Gripper</li>
                <li>67: Communication</li>
                <li>68: Maintenance Log</li>
                <li>69: Code Data Plate</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Pit (70-82)</li>
                <li>70: Pit</li>
                <li>71: Pit Light</li>
                <li>72: Pit Stop Switch</li>
                <li>73: Car Guide-Rails & Brackets</li>
                <li>74: Cwt Guide-Rails & Brackets</li>
                <li>75: Buffers</li>
                <li>76: Car Safety & Tail Rope</li>
                <li>77: Underside Platform</li>
                <li>78: Tension Weight</li>
                <li>79: Comp / Chains / Ropes / Switch</li>
                <li>80: Counterweight Runby</li>
                <li>81: Counterweight Runby Signage</li>
                <li>82: Plunger Gripper</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Escalator/Moving Walk (83-96)</li>
                <li>83: Fire Shutters</li>
                <li>84: Skirt Switch</li>
                <li>85: Skirt Deflection Device</li>
                <li>86: Comb Plate / Comb Plate Teeth</li>
                <li>87: Landing Plate / Impact Switches</li>
                <li>88: Handrails / Handrail Safeties</li>
                <li>89: Step / Thread</li>
                <li>90: Key Switch</li>
                <li>91: Emergency Stop Button</li>
                <li>92: Decking and Ballistrades</li>
                <li>93: Ceiling Guards</li>
                <li>94: Deck Barricades</li>
                <li>95: Internal Safeties</li>
                <li>96: Safety Signage</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">All Types (97-100)</li>
                <li>97: Entire Device</li>
                <li>98: Current Five Year Tag</li>
                <li>99: Current One Year Tag</li>
                <li>100: Miscellaneous</li>
            </ul>

            <p><strong>Violations:</strong></p>
            <ul>
                <li>A: Altered</li>
                <li>B: Insufficient</li>
                <li>C: Padlocked</li>
                <li>D: Unsecured</li>
                <li>E: Rubbing</li>
                <li>F: Lost Motion</li>
                <li>G: Improper Fuses</li>
                <li>H: Worn</li>
                <li>I: Damaged</li>
                <li>J: Misaligned</li>
                <li>K: Rusted</li>
                <li>L: Defective</li>
                <li>M: Missing</li>
                <li>N: By-Passed</li>
                <li>O: Dirty</li>
                <li>P: No Means Of Access</li>
                <li>Q: Unguarded</li>
                <li>R: Illegal</li>
                <li>S: Not Fire Retardant</li>
                <li>T: Unlabeled</li>
                <li>U: Device Not Tagged</li>
                <li>V: Not Level</li>
                <li>W: Unlocked</li>
                <li>X: Inoperative</li>
                <li>Y: Oil Leak</li>
                <li>Z: Water Leak</li>
                <li>AA: Carbon Buildup</li>
                <li>BB: Expired Tag</li>
            </ul>

            <p><strong>Remedies:</strong></p>
            <ul>
                <li>01: Adjust</li>
                <li>02: Clean</li>
                <li>03: Install Guards</li>
                <li>04: Patch</li>
                <li>05: Perform & File Test</li>
                <li>06: Properly Secure</li>
                <li>07: Provide</li>
                <li>08: Regroove</li>
                <li>09: Remove</li>
                <li>10: Repair</li>
                <li>11: Replace</li>
                <li>12: Reshackle</li>
                <li>13: Seal</li>
                <li>14: Shorten</li>
                <li>15: Tag Device</li>
                <li>16: Provide Means of Access</li>
                <li>17: Re-inspection Required</li>
            </ul>
        </div>
    </div>

    <div id="dobContent" class="content-section">
        <!-- The quickLookupPanel has been moved outside the tab for access from any tab -->
        
        <!-- Add ELV3 Lookup toggle button -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>

        <!-- Replace the Device & BIN Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Device & BIN Lookup</h3>
            
            <!-- Add this right after the <h3>Device & BIN Lookup</h3> line, around line 986 -->
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Elevator Device API</span>
                <br>
                <span>Last Updated: <span id="apiLastUpdated">March 15, 2024</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Elevator-Device-Information/e5aq-a4j2" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
            </div>

            <!-- Device Number Search -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by Device Number:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="deviceNumber" 
                           placeholder="Enter Device Number"
                           oninput="this.value = this.value.toUpperCase()"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupBIN()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Look up BIN</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
                <div id="binResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- BIN Search -->
            <div style="margin-top: 20px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by BIN:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="binNumber" 
                           placeholder="Enter BIN Number"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupDevices()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Find Devices</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
                <div id="deviceResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Device results will be displayed here -->
                </div>
            </div>

            <!-- Move export button here, before Clear All -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="binExportButton" 
                        onclick="exportBinToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <!-- Add Clear Button -->
            <button onclick="clearLookups()" 
                    style="display: block; margin: 25px auto 5px; padding: 12px 30px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                Clear All
            </button>
        </div>

        <!-- Replace the Bulk Device Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Bulk Device Lookup</h3>
            
            <div style="margin-bottom: 15px; padding: 0 5px;">
                <textarea id="bulkDeviceNumbers" 
                         placeholder="Enter multiple device numbers (one per line)"
                         oninput="this.value = this.value.toUpperCase()"
                         style="width: calc(100% - 10px); height: 100px; padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); resize: vertical;"></textarea>
            </div>

            <!-- Modified buttons div to stack vertically -->
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <button onclick="lookupBulkDevices()" 
                        style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Look up All Devices
                </button>
                <button onclick="clearBulkLookup()" 
                        style="padding: 12px 20px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Clear
                </button>
                <button id="exportButton" 
                        onclick="exportToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <div id="bulkResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                <!-- Results will be displayed here -->
            </div>
        </div>

        <!-- Show DOB NOW button -->
        <div style="text-align: center; margin: 20px 0;">
            <button id="showDobNowBtn" onclick="toggleDobNowSection()" style="padding: 12px 24px; font-size: 16px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show DOB NOW Interface
            </button>
        </div>

        <!-- DOB NOW content - initially hidden -->
        <div id="dobNowSection" style="display: none;">
            <div style="display: flex; justify-content: center; gap: 10px; margin: 10px auto;">
                <button onclick="refreshDOB()" style="display: inline-block; margin: 0; padding: 8px 16px;">Refresh DOB Page</button>
                <button onclick="popoutDOB()" style="display: inline-block; margin: 0; padding: 8px 16px;">Open in New Window</button>
            </div>
            <div id="dobWindows">
                <div class="dob-viewer">
                    <iframe src="https://a810-dobnow.nyc.gov/publish/Index.html#!/" frameborder="0"></iframe>
                </div>
            </div>
            <button onclick="addDOBWindow()" style="display: block; margin: 10px auto 30px auto; padding: 8px 16px;">
                <span style="font-size: 20px;">+</span> Add DOB Window
            </button>
            <div class="disclaimer" style="margin-top: 20px;">
                <span style="color: red;">Disclaimer: The DOB NOW page is provided by the New York City Department of Buildings. This embeded page should not be used as an official source for filing and should only be used to quickly look up information related to a building or device.</span>
            </div>
        </div>
        
        <!-- Add the violations API data source section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Violations API Information</h3>
            
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Safety Violations API</span>
                <br>
                <span>Last Updated: <span id="violationsApiLastUpdated">Loading...</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Safety-Violations/855j-jady" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
                <div id="violationsDaysSinceUpdate" style="text-align: center; font-size: 0.9em; color: #4CAF50; opacity: 0.8; margin-top: 5px;">
                    Checking...
                </div>
                <script>
                    // Fetch actual last updated date from NYC Open Data API
                    (function() {
                        const datasetId = '855j-jady'; // DOB Safety Violations dataset ID
                        const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                        
                        fetch(metadataUrl)
                            .then(response => response.json())
                            .then(data => {
                                // Extract the last updated date from the metadata
                                const updateDateStr = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                }) : 'Unknown';
                                
                                // Update the displayed date
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement) {
                                    lastUpdatedElement.textContent = updateDateStr;
                                }
                                
                                // Calculate days since update
                                const today = new Date();
                                const updateDate = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000) : today;
                                const timeDiff = today - updateDate;
                                const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement) {
                                    daysSinceElement.textContent = daysSinceUpdate === 0 ? 'Updated Today' : `Updated ${daysSinceUpdate} days ago`;
                                    daysSinceElement.style.color = daysSinceUpdate < 14 ? "#4CAF50" : 
                                                                  daysSinceUpdate < 30 ? "#FFA500" : "#FF6B6B";
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching dataset metadata:', error);
                                // Fallback to a default behavior on error
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement && lastUpdatedElement.textContent === 'Loading...') {
                                    lastUpdatedElement.textContent = 'Unable to fetch update date';
                                }
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement && daysSinceElement.textContent === 'Checking...') {
                                    daysSinceElement.textContent = 'Update status unavailable';
                                    daysSinceElement.style.color = "#FFA500";
                                }
                            });
                    })();
                </script>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: var(--text-color);">
                    This website uses the NYC Department of Buildings Safety Violations API to provide up-to-date information about elevator violations.
                </p>
                <p style="color: var(--text-color);">
                    The API provides information about violations issued for elevator devices, including violation numbers, issue dates, statuses, types, and remarks.
                </p>
            </div>
        </div>
    </div>

    <div id="datesContent" class="content-section">
        <!-- Add ELV3 Lookup toggle button for Dates tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        
        <div class="input-group">
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput">
        </div>
        
        <!-- Adding back the buttons -->
        <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center;">
            <button id="days30" onclick="calculateDateWithMode(30)" style="display: inline-block; margin: 0;">30 Days</button>
            <button id="days60" onclick="calculateDateWithMode(60)" style="display: inline-block; margin: 0;">60 Days</button>
            <button id="days91" onclick="calculateDateWithMode(91)" style="display: inline-block; margin: 0;">91 Days</button>
        </div>
        
        <!-- Adding back the dropdown for small screens -->
        <div class="date-dropdown-group" style="display: none; text-align: center; margin: 10px auto;">
            <select id="daysSelect" onchange="calculateDateWithMode(parseInt(this.value))" style="padding: 8px; width: 200px; margin-bottom: 10px;">
                <option value="">Select Days</option>
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="91">91 Days</option>
            </select>
            <select id="modeSelect" onchange="toggleDateModeFromDropdown(this.value)" style="padding: 8px; width: 200px;">
                <option value="positive">Add Days</option>
                <option value="negative">Subtract Days</option>
            </select>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <!-- Mode toggle buttons above custom days input -->
            <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center; margin-bottom: 15px;">
                <button id="negativeToggle" onclick="toggleDateMode('negative')" style="display: inline-block; margin: 0; background-color: #f0f0f0; color: #666; border: 1px solid #ccc; padding: 8px 16px;">Prior</button>
                <button id="positiveToggle" onclick="toggleDateMode('positive')" style="display: inline-block; margin: 0; background-color: #000; color: #fff; border: 1px solid #000; padding: 8px 16px;">Future</button>
            </div>
            <input type="number" id="customDays" placeholder="Enter number of days" style="width: 200px;">
            <button onclick="calculateCustomDate()" style="display: inline-block; margin: 10px;">Calculate Custom Days</button>
        </div>
        <div id="dateResult" class="result" style="width:80%;"></div>
        <div id="dateSpelledResult" class="result" style="width:80%;"></div>

        <!-- Modify the 90-day start date div -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                91 Days Past
                <span style="cursor: pointer; color: #4a9eff; display: inline-flex; align-items: center;" 
                      onclick="toggleExplanation(event)"
                      data-explanation="Any device tested on or before below date has past the required 91 days and the next test can be completed">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </span>
            </div>
            <div id="explanationText" style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--text-color); max-width: 400px; margin-left: auto; margin-right: auto;"></div>
            <div id="ninetyDayStart" style="margin: 10px 0;"></div>
        </div>

        <script>
            function toggleExplanation(event) {
                const explanationDiv = document.getElementById('explanationText');
                const explanation = event.currentTarget.getAttribute('data-explanation');
                
                if (explanationDiv.style.display === 'none') {
                    explanationDiv.textContent = explanation;
                    explanationDiv.style.display = 'block';
                    
                    // Position the explanation
                    const rect = event.currentTarget.getBoundingClientRect();
                    explanationDiv.style.position = 'relative';
                    explanationDiv.style.zIndex = '1000';
                    
                    // Add animation
                    explanationDiv.style.opacity = '0';
                    explanationDiv.style.transform = 'translateY(-10px)';
                    explanationDiv.style.transition = 'all 0.3s ease';
                    
                    // Trigger animation
                    setTimeout(() => {
                        explanationDiv.style.opacity = '1';
                        explanationDiv.style.transform = 'translateY(0)';
                    }, 10);
                } else {
                    // Add fade-out animation
                    explanationDiv.style.opacity = '0';
                    explanationDiv.style.transform = 'translateY(-10px)';
                    
                    // Hide after animation
                    setTimeout(() => {
                        explanationDiv.style.display = 'none';
                    }, 300);
                }
                
                // Stop event propagation
                event.stopPropagation();
            }
            
            // Close explanation when clicking anywhere else on the page
            document.addEventListener('click', function(event) {
                const explanationDiv = document.getElementById('explanationText');
                if (explanationDiv.style.display === 'block' && !event.target.closest('[onclick="toggleExplanation(event)"]')) {
                    explanationDiv.style.opacity = '0';
                    explanationDiv.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        explanationDiv.style.display = 'none';
                    }, 300);
                }
            });
        </script>

        <button onclick="clearDateInput()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em;">Clear</button>
    </div>

    <div id="pdfContent" class="content-section">
        <div class="pdf-viewer" style="width: 100%; height: 80vh;">
            <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
            </iframe>
        </div>
    </div>

    <script>
        function numberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "00": "Invalid number",
                "01": "Emergency Stop Switch",
                "1": "Emergency Stop Switch",
                "emergency stop switch": "01",
                "02": "Alarm System",
                "2": "Alarm System",
                "alarm system": "02",
                "03": "Car Enclosure",
                "3": "Car Enclosure",
                "car enclosure": "03",
                "04": "Side Emergency Exit",
                "4": "Side Emergency Exit",
                "side emergency exit": "04",
                "05": "Car Door/Gate",
                "5": "Car Door/Gate",
                "car door/gate": "05",
                "06": "Car Door/Gate Contact",
                "6": "Car Door/Gate Contact",
                "car door/gate contact": "06",
                "07": "Door Reopening Device",
                "7": "Door Reopening Device",
                "door reopening device": "07",
                "08": "Car Floor to Landing Still",
                "8": "Car Floor to Landing Still",
                "car floor to landing still": "08",
                "09": "Car Floor",
                "9": "Car Floor",
                "car floor": "09",
                "10": "Car Door Gibs",
                "car door gibs": "10",
                "11": "Car Button Station",
                "car button station": "11",
                "12": "Car Lighting",
                "car lighting": "12",
                "13": "Emergency Lighting",
                "emergency lighting": "13",
                "14": "Car Mirror",
                "car mirror": "14",
                "15": "Certificate Frame",
                "certificate frame": "15",
                "16": "Hoistway Doors",
                "hoistway doors": "16",
                "17": "Hoistway Door Gibs",
                "hoistway door gibs": "17",
                "18": "Hoistway Door Reinforcements",
                "hoistway door reinforcements": "18",
                "19": "Hoistway Door Safety Retainer",
                "hoistway door safety retainer": "19",
                "20": "Vision Panel",
                "vision panel": "20",
                "21": "Interlocks",
                "interlocks": "21",
                "22": "Parking Device",
                "parking device": "22",
                "23": "Hall Button Station",
                "hall button station": "23",
                "24": "Indicators",
                "indicators": "24",
                "25": "Door Safety Retainer",
                "door safety retainer": "25",
                "26": "Top Emergency Exit Cover",
                "top emergency exit cover": "26",
                "27": "Governor Release Carrier",
                "governor release carrier": "27",
                "28": "Door Hangers & Connectors",
                "door hangers & connectors": "28",
                "29": "Door Operator",
                "door operator": "29",
                "30": "Normal Limits",
                "normal limits": "30",
                "31": "Final Limits",
                "final limits": "31",
                "32": "Guide Shoes / Roller Guides",
                "guide shoes / roller guides": "32",
                "33": "Counterweight",
                "counterweight": "33",
                "34": "Hoistway",
                "hoistway": "34",
                "35": "Electrical Wiring",
                "electrical wiring": "35",
                "36": "Pipes and Ducts",
                "pipes and ducts": "36",
                "37": "Overhead & Deflector Sheave",
                "overhead & deflector sheave": "37",
                "38": "Traveling Cable & Junction",
                "traveling cable & junction": "38",
                "39": "Car Top",
                "car top": "39",
                "40": "Machine Room",
                "machine room": "40",
                "41": "Machine Room Door",
                "machine room door": "41",
                "42": "Controller—Selector",
                "controller—selector": "42",
                "43": "Reverse Phase Relay",
                "reverse phase relay": "43",
                "44": "Traction Sheave",
                "traction sheave": "44",
                "45": "Governor",
                "governor": "45",
                "46": "Governor Switch",
                "governor switch": "46",
                "47": "Drum",
                "drum": "47",
                "48": "Pump Unit",
                "pump unit": "48",
                "49": "Drum Machine Limit SW",
                "drum machine limit sw": "49",
                "50": "Generator",
                "generator": "50",
                "51": "Slack Rope Switch",
                "slack rope switch": "51",
                "52": "Hoist Cables",
                "hoist cables": "52",
                "53": "Governor Ropes",
                "governor ropes": "53",
                "54": "Car Counterweight Rope",
                "car counterweight rope": "54",
                "55": "Drum Counterweight Rope",
                "drum counterweight rope": "55",
                "56": "Hoist Machine",
                "hoist machine": "56",
                "57": "Hoist Motor",
                "hoist motor": "57",
                "58": "Worm / Gear / Bearings",
                "worm / gear / bearings": "58",
                "59": "Machine Brake",
                "machine brake": "59",
                "60": "Lighting Machine Space",
                "lighting machine space": "60",
                "61": "Machine Disconnect SW",
                "machine disconnect sw": "61",
                "62": "Commutator",
                "commutator": "62",
                "63": "Motor Brushes",
                "motor brushes": "63",
                "64": "NYC Device #",
                "nyc device #": "64",
                "65": "Unintended Car Movement",
                "unintended car movement": "65",
                "66": "Emergency Brake/Rope Gripper",
                "emergency brake/rope gripper": "66",
                "67": "Communication",
                "communication": "67",
                "68": "Maintenance Log",
                "maintenance log": "68",
                "69": "Code Data Plate",
                "code data plate": "69",
                "70": "Pit",
                "pit": "70",
                "71": "Pit Light",
                "pit light": "71",
                "72": "Pit Stop Switch",
                "pit stop switch": "72",
                "73": "Car Guide-Rails & Brackets",
                "car guide-rails & brackets": "73",
                "74": "Cwt Guide-Rails & Brackets",
                "cwt guide-rails & brackets": "74",
                "75": "Buffers",
                "buffers": "75",
                "76": "Car Safety & Tail Rope",
                "car safety & tail rope": "76",
                "77": "Underside Platform",
                "underside platform": "77",
                "78": "Tension Weight",
                "tension weight": "78",
                "79": "Comp / Chains / Ropes / Switch",
                "comp / chains / ropes / switch": "79",
                "80": "Counterweight Runby",
                "counterweight runby": "80",
                "81": "Counterweight Runby Signage",
                "counterweight runby signage": "81",
                "82": "Plunger Gripper",
                "plunger gripper": "82",
                "83": "Fire Shutters",
                "fire shutters": "83",
                "84": "Skirt Switch",
                "skirt switch": "84",
                "85": "Skirt Deflection Device",
                "skirt deflection device": "85",
                "86": "Comb Plate / Comb Plate Teeth",
                "comb plate / comb plate teeth": "86",
                "87": "Landing Plate / Impact Switches",
                "landing plate / impact switches": "87",
                "88": "Handrails / Handrail Safeties",
                "handrails / handrail safeties": "88",
                "89": "Step / Thread",
                "step / thread": "89",
                "90": "Key Switch",
                "key switch": "90",
                "91": "Emergency Stop Button",
                "emergency stop button": "91",
                "92": "Decking and Ballistrades",
                "decking and ballistrades": "92",
                "93": "Ceiling Guards",
                "ceiling guards": "93",
                "94": "Deck Barricades",
                "deck barricades": "94",
                "95": "Internal Safeties",
                "internal safeties": "95",
                "96": "Safety Signage",
                "safety signage": "96",
                "97": "Entire Device",
                "entire device": "97",
                "98": "Current Five Year Tag",
                "current five year tag": "98",
                "99": "Current One Year Tag",
                "current one year tag": "99",
                "100": "Miscellaneous",
                "miscellaneous": "100"
            };
            let result = mapping[input] || "Invalid Number";
            
            // Only add location information if the result is a description (not a code)
            if (result !== "Invalid Number" && result !== "Enter Number" && !result.match(/^\d+$/)) {
                var intValue = parseInt(input);
                if (intValue >= 1 && intValue <= 15) {
                    result += " (Inside Car)";
                }
                
                if (intValue >= 16 && intValue <= 25) {
                    result += " (Outside Hoistway)";
                }
                
                if (intValue >= 26 && intValue <= 39) {
                    result += " (Top of Car)";
                }
                
                if (intValue >= 40 && intValue <= 69) {
                    result += " (Machine Room)";
                }
                
                if (intValue >= 70 && intValue <= 82) {
                    result += " (Pit)";
                }
                
                if (intValue >= 83 && intValue <= 96) {
                    result += " (Escalator/Moving Walk)";
                }
                
                if (intValue >= 97 && intValue <= 100) {
                    result += " (All Types)";
                }
            }
            
            return result;
        }

        function letterToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Letter",
                "a": "Altered",
                "altered": "A",
                "b": "Insufficient",
                "insufficient": "B",
                "c": "Padlocked",
                "padlocked": "C",
                "d": "Unsecured",
                "unsecured": "D",
                "e": "Rubbing",
                "rubbing": "E",
                "f": "Lost Motion",
                "lost motion": "F",
                "g": "Improper Fuses",
                "improper fuses": "G",
                "h": "Worn",
                "worn": "H",
                "i": "Damaged",
                "damaged": "I",
                "j": "Misaligned",
                "misaligned": "J",
                "k": "Rusted",
                "rusted": "K",
                "l": "Defective",
                "defective": "L",
                "m": "Missing",
                "missing": "M",
                "n": "By-Passed",
                "by-passed": "N",
                "o": "Dirty",
                "dirty": "O",
                "p": "No Means Of Access",
                "no means of access": "P",
                "q": "Unguarded",
                "unguarded": "Q",
                "r": "Illegal",
                "illegal": "R",
                "s": "Not Fire Retardant",
                "not fire retardant": "S",
                "t": "Unlabeled",
                "unlabeled": "T",
                "u": "Device Not Tagged",
                "device not tagged": "U",
                "v": "Not Level",
                "not level": "V",
                "w": "Unlocked",
                "unlocked": "W",
                "x": "Inoperative",
                "inoperative": "X",
                "y": "Oil Leak",
                "oil leak": "Y",
                "z": "Water Leak",
                "water leak": "Z",
                "aa": "Carbon Buildup",
                "carbon buildup": "AA",
                "bb": "Expired Tag",
                "expired tag": "BB"
            };
            
            return mapping[input] || "Invalid Letter";
        }

        function secondaryNumberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "01": "Adjust",
                "1": "Adjust", 
                "adjust": "01",
                "02": "Clean",
                "2": "Clean",
                "clean": "02", 
                "03": "Install Guards",
                "3": "Install Guards",
                "install guards": "03",
                "04": "Patch",
                "4": "Patch",
                "patch": "04",
                "05": "Perform & File Test",
                "5": "Perform & File Test", 
                "perform & file test": "05",
                "06": "Properly Secure",
                "6": "Properly Secure",
                "properly secure": "06",
                "07": "Provide",
                "7": "Provide",
                "provide": "07",
                "08": "Regroove", 
                "8": "Regroove",
                "regroove": "08",
                "09": "Remove",
                "9": "Remove",
                "remove": "09",
                "10": "Repair",
                "repair": "10",
                "11": "Replace",
                "replace": "11",
                "12": "Reshackle",
                "reshackle": "12",
                "13": "Seal",
                "seal": "13",
                "14": "Shorten",
                "shorten": "14",
                "15": "Tag Device",
                "tag device": "15",
                "16": "Provide Means of Access",
                "provide means of access": "16",
                "17": "Re-inspection Required",
                "re-inspection required": "17"
            };
            
            return mapping[input] || "Invalid Number";
        }

        document.getElementById('numInput').addEventListener('input', function(e) {
            let result = numberToWord(e.target.value);
            document.getElementById('numResult').textContent = result;
        });

        document.getElementById('letterInput').addEventListener('input', function(e) {
            let result = letterToWord(e.target.value);
            document.getElementById('letterResult').textContent = result;
        });

        document.getElementById('secondaryNumInput').addEventListener('input', function(e) {
            let result = secondaryNumberToWord(e.target.value);
            document.getElementById('secondaryNumResult').textContent = result;
        });

        function clearInputs() {
            document.getElementById('numInput').value = '';
            document.getElementById('letterInput').value = '';
            document.getElementById('secondaryNumInput').value = '';
            document.getElementById('numResult').textContent = '';
            document.getElementById('letterResult').textContent = '';
            document.getElementById('secondaryNumResult').textContent = '';
            document.getElementById('numInput').focus();
        }

        function togglePdfViewer() {
            const viewer = document.getElementById('pdfViewer');
            const button = document.getElementById('pdfToggleButton');
            viewer.classList.toggle('hidden');
            button.textContent = viewer.classList.contains('hidden') ? 'Show PDF' : 'Hide PDF';
        }
        function showTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName + 'Content').classList.add('active');
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.backgroundColor = '';
            });
            document.getElementById(tabName + 'Tab').style.backgroundColor = '#333';
            updatePageTitle(tabName);
            
            // After switching to the DOB tab, fetch the update date
            if (tabName === 'dob') {
                fetchAPILastUpdateDate();
            }
        }

        function updatePageTitle(tabName) {
            const titleMapping = {
                main: 'ELV3 Terminal',
                dob: 'DOB Terminal',
                dates: 'DATES Terminal',
                pdf: 'PDF Terminal'
            };
            // Keep document title static as "Vertical Terminal"
            document.title = "Vertical Terminal";
            // Still update the visible page title element
            document.getElementById('pageTitle').textContent = titleMapping[tabName];
        }

        function submitFeedback() {
            window.location.href = "mailto:michaelmontesano@gmail.com?subject=ELV3 Cheat Sheet Feedback";
        }

        // Add this function to initialize all event listeners
        function initializeQuickLookup() {
            // Quick Lookup panel event listeners
            const quickNumInput = document.getElementById('quickNumInput');
            const quickLetterInput = document.getElementById('quickLetterInput');
            const quickSecondaryNumInput = document.getElementById('quickSecondaryNumInput');

            if (quickNumInput) {
                quickNumInput.addEventListener('input', function(e) {
                    let result = numberToWord(e.target.value);
                    document.getElementById('quickNumResult').textContent = result;
                });
            }

            if (quickLetterInput) {
                quickLetterInput.addEventListener('input', function(e) {
                    let result = letterToWord(e.target.value);
                    document.getElementById('quickLetterResult').textContent = result;
                });
            }

            if (quickSecondaryNumInput) {
                quickSecondaryNumInput.addEventListener('input', function(e) {
                    let result = secondaryNumberToWord(e.target.value);
                    document.getElementById('quickSecondaryNumResult').textContent = result;
                });
            }
        }

        // Add this to your existing window.onload function
        window.onload = function() {
            const savedNotes = localStorage.getItem('elevatorNotes');
            if (savedNotes) {
                document.getElementById('Notes').value = savedNotes;
            }
            calculateNinetyDayStart();

            // Load default tab if set
            const defaultTab = localStorage.getItem('defaultTab');
            if (defaultTab) {
                showTab(defaultTab);
            }

            // Initialize Quick Lookup panel
            initializeQuickLookup();
            
            // Make sure overlay click closes the panel
            document.getElementById('quickLookupOverlay').addEventListener('click', function() {
                toggleQuickLookup();
            });
            
            // Add event listeners for date calculations
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // Add direct event listener to the custom days input
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', function() {
                    if (dateInput.value && customDaysInput.value && !isNaN(parseInt(customDaysInput.value))) {
                        calculateCustomDate();
                    }
                });
            }
        }

        // Save notes when user types
        document.getElementById('Notes').addEventListener('input', function(e) {
            localStorage.setItem('elevatorNotes', e.target.value);
        });

        let lastCalculation = null; // Track the last calculation performed
        let dateMode = 'positive'; // Track whether we're adding or subtracting days ('positive' or 'negative')

        function calculateDate(days) {
            const dateStr = document.getElementById('dateInput').value;
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Clear the custom days input when using preset buttons
            document.getElementById('customDays').value = '';
            
            // Store the last calculation type and value
            lastCalculation = { type: 'standard', days: days };
            
            // Create date object and set to noon UTC
            const inputDate = new Date(dateStr);
            inputDate.setUTCHours(12, 0, 0, 0);
            
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            // Handle positive and negative days properly in text output
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            // Spelled-out format using long options
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = "" + spelledInput + " becomes " + spelledResult;
        }

        // New function to handle mode-based date calculation
        function calculateDateWithMode(days) {
            const effectiveDays = dateMode === 'negative' ? -days : days;
            calculateDate(effectiveDays);
        }

        // Function to toggle between positive and negative date calculation modes
        function toggleDateMode(mode) {
            dateMode = mode;
            
            // Update button styles for desktop
            const negativeToggle = document.getElementById('negativeToggle');
            const positiveToggle = document.getElementById('positiveToggle');
            
            // Get the date buttons to update their text
            const days30 = document.getElementById('days30');
            const days60 = document.getElementById('days60');
            const days91 = document.getElementById('days91');
            
            // Get the dropdown options
            const daysSelect = document.getElementById('daysSelect');
            const options = daysSelect.options;
            
            // Update mobile mode dropdown
            const modeSelect = document.getElementById('modeSelect');
            if (modeSelect) {
                modeSelect.value = mode;
            }
            
            if (mode === 'negative') {
                // Negative mode active - change button text to "Prior"
                days30.textContent = '30 Days Prior';
                days60.textContent = '60 Days Prior';
                days91.textContent = '91 Days Prior';
                
                // Update dropdown options
                options[1].textContent = '30 Days Prior';
                options[2].textContent = '60 Days Prior';
                options[3].textContent = '91 Days Prior';
                
                // Update toggle button styles
                negativeToggle.style.backgroundColor = '#000';
                negativeToggle.style.color = '#fff';
                negativeToggle.style.borderColor = '#000';
                
                positiveToggle.style.backgroundColor = '#f0f0f0';
                positiveToggle.style.color = '#666';
                positiveToggle.style.borderColor = '#ccc';
            } else {
                // Positive mode active (default) - revert to original text
                days30.textContent = '30 Days';
                days60.textContent = '60 Days';
                days91.textContent = '91 Days';
                
                // Update dropdown options
                options[1].textContent = '30 Days';
                options[2].textContent = '60 Days';
                options[3].textContent = '91 Days';
                
                // Update toggle button styles
                positiveToggle.style.backgroundColor = '#000';
                positiveToggle.style.color = '#fff';
                positiveToggle.style.borderColor = '#000';
                
                negativeToggle.style.backgroundColor = '#f0f0f0';
                negativeToggle.style.color = '#666';
                negativeToggle.style.borderColor = '#ccc';
            }
        }

        // Function to handle mode selection from mobile dropdown
        function toggleDateModeFromDropdown(mode) {
            toggleDateMode(mode);
            
            // If there's already a day value selected, recalculate with the new mode
            const daysSelect = document.getElementById('daysSelect');
            if (daysSelect && daysSelect.value && daysSelect.value !== "") {
                calculateDateWithMode(parseInt(daysSelect.value));
            }
        }

        // Modify the calculateCustomDate function to work with event triggers
        function calculateCustomDate() {
            const dateStr = document.getElementById('dateInput').value;
            const customDaysInput = document.getElementById('customDays');
            const days = parseInt(customDaysInput.value);
            
            if (isNaN(days)) {
                document.getElementById('dateResult').textContent = "Please enter a valid number.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Add maximum reasonable limit
            if (Math.abs(days) > 36500) { // 100 years
                document.getElementById('dateResult').textContent = "Please enter a more reasonable number of days.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Store the last calculation type and value
            lastCalculation = { type: 'custom', days: days };
            
            const inputDate = new Date(dateStr + "T12:00:00");
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = 
                absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = 
                spelledInput + " becomes " + spelledResult;
        }

        function clearDateInput() {
            document.getElementById('dateInput').value = '';
            document.getElementById('customDays').value = '';
            document.getElementById('daysSelect').value = ''; // Reset dropdown
            document.getElementById('dateResult').textContent = '';
            document.getElementById('dateSpelledResult').textContent = '';
            lastCalculation = null; // Reset the last calculation
        }

        // Add this new function to reapply the last calculation when date changes
        function dateChanged() {
            if (lastCalculation) {
                if (lastCalculation.type === 'standard') {
                    calculateDate(lastCalculation.days);
                } else if (lastCalculation.type === 'custom') {
                    calculateCustomDate();
                }
            }
        }

        // Add event listener for the date input
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
        });

        function refreshDOB() {
            const iframe = document.querySelector('#dobContent .dob-viewer iframe');
            if (iframe) {
                // Reassigning src forces the iframe to reload
                iframe.src = iframe.src;
            }
        }

        function popoutDOB() {
            window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank', 'width=1200,height=800');
        }

        function addDOBWindow() {
            const newWindow = document.createElement('div');
            newWindow.className = 'dob-viewer';
            newWindow.innerHTML = '<iframe src="https://a810-dobnow.nyc.gov/publish/Index.html#!/" frameborder="0"></iframe>';
            document.getElementById('dobWindows').appendChild(newWindow);
        }

        function toggleReference() {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'ELV3 Reference';
            } else {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                button.textContent = 'Hide Reference';
            }
            
            event.stopPropagation();
        }

        // Update the click outside handler
        document.addEventListener('click', function(event) {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            // Check if the click is outside the panel and not on the toggle button
            if (panel.style.display === 'block' && 
                !panel.contains(event.target) && 
                event.target !== button) {
                
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'ELV3 Reference';
            }
        });

        // Update the panel click handler
        document.querySelector('.reference-panel').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        function calculateNinetyDayStart() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 91);
            
            // Format for the simple date
            const simpleDate = startDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = startDate.toLocaleDateString('en-US', options);
            
            document.getElementById('ninetyDayStart').innerHTML = 
                `<div>Any date on or before: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownContent');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Load current setting
            const savedTab = localStorage.getItem('defaultTab') || 'main';
            document.getElementById('defaultTab').value = savedTab;
            
            // Close dropdown
            document.getElementById('dropdownContent').style.display = 'none';

            // Add click event listener to close settings when clicking outside
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    closeSettings();
                }
            });

            // Prevent clicks inside the modal from closing it
            modal.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function saveSettings() {
            const defaultTab = document.getElementById('defaultTab').value;
            localStorage.setItem('defaultTab', defaultTab);
            closeSettings();
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-button')) {
                const dropdown = document.getElementById('dropdownContent');
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                }
            }
        }

        // Add this new function to your script section
        async function lookupBIN() {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const resultDiv = document.getElementById('binResult');
            const binInput = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                quickBinValue.textContent = '-';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    quickBinValue.textContent = device.bin || '-';
                    if (device.bin) {
                        lookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('deviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">▼</span>
                            </button>
                            <div id="deviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                    
                    resultDiv.innerHTML = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('device_violations_${deviceNumber}')" 
                                            id="violationsBtn_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">▼</span>
                                    </button>
                                    <div id="violations_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <strong style="color: var(--header-color); margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span>${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span>${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span>${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span>${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            ${deviceSpecsHTML}
                            
                            <!-- Add More Info button and dropdown -->
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <button onclick="toggleMoreInfo('moreInfo_${device.device_number}')"
                                        style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span>More Info</span>
                                    <span class="arrow">▼</span>
                                </button>
                                <div id="moreInfo_${device.device_number}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> 
                                        <span>${device.block || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> 
                                        <span>${device.lot || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this function to toggle device information
        function toggleDeviceInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                element.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                element.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Add this new function to handle the device details dropdown toggle
        function toggleDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            const button = document.getElementById(`detailsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (detailsElement.style.display === 'none') {
                // Fetch additional device details if not already loaded
                if (detailsElement.getAttribute('data-loaded') !== 'true') {
                    fetchDeviceDetails(deviceNumber);
                }
                detailsElement.style.display = 'block';
                arrow.textContent = '▲';
                if (buttonText) {
                    buttonText.textContent = 'Hide Details';
                }
            } else {
                detailsElement.style.display = 'none';
                arrow.textContent = '▼';
                if (buttonText) {
                    buttonText.textContent = 'Show Details';
                }
            }
        }

        // Function to fetch additional device details
        async function fetchDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            detailsElement.innerHTML = '<span style="color: var(--text-color);">Loading details...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    
                    // Get inspection dates directly from the device data
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Get recent inspections if available
                    let inspectionHistory = '';
                    try {
                        const inspResponse = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                        if (inspResponse.ok) {
                            const inspData = await inspResponse.json();
                            if (inspData && inspData.length > 0) {
                                // Sort inspections by date (newest first)
                                const inspections = inspData.filter(insp => insp.inspection_date);
                                inspections.sort((a, b) => {
                                    return new Date(b.inspection_date) - new Date(a.inspection_date);
                                });
                                
                                // Get the most recent inspections
                                const recentInspections = inspections.slice(0, 5);
                                
                                if (recentInspections.length > 0) {
                                    inspectionHistory = `
                                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Recent Inspections:</strong>
                                            ${recentInspections.map(insp => `
                                                <div style="margin-bottom: 8px; padding: 5px; background: var(--input-bg); border-radius: 4px;">
                                                    <div><strong style="color: var(--header-color);">Date:</strong> ${insp.inspection_date ? new Date(insp.inspection_date).toLocaleDateString() : 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Type:</strong> ${insp.inspection_type || 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Result:</strong> ${insp.inspection_result || 'N/A'}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching inspection history:', error);
                    }
                    
                    // Fetch permit information for this BIN
                    let permitInfo = '';
                    try {
                        if (binNumber) {
                            const permitResponse = await fetch(`https://data.cityofnewyork.us/resource/ipu4-2q9a.json?bin=${binNumber}`);
                            if (permitResponse.ok) {
                                const permitData = await permitResponse.json();
                                if (permitData && permitData.length > 0) {
                                    // Sort permits by issue date (newest first)
                                    const permits = permitData.filter(permit => permit.issuance_date);
                                    permits.sort((a, b) => {
                                        return new Date(b.issuance_date) - new Date(a.issuance_date);
                                    });
                                    
                                    // Get the most recent permits
                                    const recentPermits = permits.slice(0, 5);
                                    
                                    if (recentPermits.length > 0) {
                                        permitInfo = `
                                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                                <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Permit Information:</strong>
                                                ${recentPermits.map(permit => `
                                                    <div style="margin-bottom: 12px; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border);">
                                                        <div><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issue Date:</strong> ${permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                                        ${permit.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching permit information:', error);
                    }
                    
                    let html = `
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Device Type:</strong> ${device.device_type || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Borough:</strong> ${device.borough || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Block:</strong> ${device.block || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Lot:</strong> ${device.lot || 'N/A'}
                        </div>
                        ${device.house_number && device.street_name ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Address:</strong> ${device.house_number} ${device.street_name}
                            </div>
                        ` : ''}
                        ${device.bin ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">BIN:</strong> ${device.bin}
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Inspection Dates:</strong>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 1:</strong> ${cat1Display}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 5:</strong> ${cat5Display}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest PVI:</strong> ${pviDisplay}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest Inspection:</strong> ${mostRecentDisplay}
                                ${mostRecentDate ? 
                                    `<br><span style="color: var(--text-muted); margin-left: 10px; font-size: 0.9em;">
                                        (from ${
                                            mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                            mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                            'PVI'
                                        })
                                    </span>` : 
                                    ''}
                            </div>
                            ${daysSinceInspection !== null ? 
                                `<div style="margin-bottom: 5px;">
                                    <strong style="color: var(--header-color);">Days Since Last Inspection:</strong> 
                                    <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                        ${daysSinceInspection} days
                                    </span>
                                </div>` : 
                                ''}
                        </div>
                        ${permitInfo}
                        ${inspectionHistory}
                    `;
                    
                    detailsElement.innerHTML = html;
                    detailsElement.setAttribute('data-loaded', 'true');
                } else {
                    detailsElement.innerHTML = '<span style="color: var(--text-color);">No additional details found</span>';
                }
            } catch (error) {
                detailsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading details</span>';
                console.error('Error fetching device details:', error);
            }
        }

        // Add this new function to handle the violations dropdown toggle
        function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                arrow.textContent = '▲';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (violationsDiv.innerHTML.trim() === '') {
                    fetchViolations(deviceNumber);
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = '▼';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Function to fetch violations for a device
        async function fetchViolations(deviceNumber) {
            const violationsElement = document.getElementById(`violations_${deviceNumber}`);
            violationsElement.innerHTML = '<span style="color: var(--text-color);">Loading violations...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Filter for active violations
                    const activeViolations = data.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    if (activeViolations.length > 0) {
                        let html = '';
                        activeViolations.forEach(v => {
                            html += `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                    <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Status:</strong> ${v.violation_status || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Date:</strong> ${v.violation_date ? new Date(v.violation_date).toLocaleDateString() : 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}</div>
                                </div>
                            `;
                        });
                        violationsElement.innerHTML = html;
                    } else {
                        violationsElement.innerHTML = '<span style="color: var(--text-color);">No active violations found</span>';
                    }
                } else {
                    violationsElement.innerHTML = '<span style="color: var(--text-color);">No violations found</span>';
                }
            } catch (error) {
                violationsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading violations</span>';
                console.error('Error fetching violations:', error);
            }

        }

        // Add event listener for Enter key
        document.getElementById('deviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupBIN();
            }
        });

        // Add input event listener for device number
        document.getElementById('deviceNumber').addEventListener('input', function(e) {
            const deviceNumber = e.target.value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
            }
        });

        // Add input event listener for BIN number
        document.getElementById('binNumber').addEventListener('input', function(e) {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = e.target.value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
            }
        });

        // Add the new lookupDevices function
        async function lookupDevices() {
            const binNumber = document.getElementById('binNumber').value.trim();
            const resultDiv = document.getElementById('deviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    // Fetch violations for all devices in this BIN
                    const violationsByDevice = await fetchViolationsForBin(binNumber);
                    window.violationsByDevice = violationsByDevice; // Store for later use
                    
                    // Calculate total active violations
                    let totalActiveViolations = 0;
                    for (const deviceNum in violationsByDevice) {
                        const deviceViolations = violationsByDevice[deviceNum];
                        const activeDeviceViolations = deviceViolations.filter(v => 
                            v.violation_status?.toUpperCase() === 'ACTIVE' || 
                            v.violation_status?.toUpperCase() === 'OPEN');
                        totalActiveViolations += activeDeviceViolations.length;
                    }
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices
                    const removedDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Calculate test eligibility counts
                    const eligibleDevices = data.filter(device => {
                        // Skip removed devices as they don't need testing
                        if (device.device_status && device.device_status.toUpperCase() === 'REMOVED') {
                            return false;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        return isEligibleForTesting(mostRecentDate);
                    }).length;
                    
                    const notEligibleDevices = data.filter(device => {
                        // Skip removed devices as they don't need testing
                        if (device.device_status && device.device_status.toUpperCase() === 'REMOVED') {
                            return false;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        return !isEligibleForTesting(mostRecentDate);
                    }).length;

                    // Group devices by type
                    const deviceTypes = {};
                    data.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!deviceTypes[type]) {
                            deviceTypes[type] = [];
                        }
                        deviceTypes[type].push(device);
                    });

                    let html = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: var(--header-color);">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: var(--header-color);">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--header-color);">Total Active Violations:</strong> 
                                        <span style="color: ${totalActiveViolations > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${totalActiveViolations > 0 ? totalActiveViolations : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">• Active Devices: ${activeDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">• Removed Devices: ${removedDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">• Dismantled Devices: ${dismantledDevices}</span>
                                    <br>
                                    <div style="margin-top: 10px;">
                                        <strong style="color: var(--header-color);">Test Eligibility:</strong>
                                        <br>
                                        <span style="margin-left: 20px; color: #4CAF50;">• Ready for Test: ${eligibleDevices}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${notEligibleDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">• Not Ready: ${notEligibleDevices}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; margin-bottom: 15px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                    <button 
                                        onclick="toggleViolationsFilter()" 
                                        id="violationsFilterBtn"
                                        data-filtering="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; display: flex; align-items: center; gap: 5px; width: 240px;">
                                        <span id="violationsFilterText">Show Only Devices with Violations</span>
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="testEligibilityFilter" style="color: var(--text-color); font-size: 0.9em;">Test Eligibility:</label>
                                        <select 
                                            id="testEligibilityFilter" 
                                            onchange="filterByTestEligibility()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Devices</option>
                                            <option value="eligible">Eligible Only</option>
                                            <option value="not-eligible">Not Eligible Only</option>
                                        </select>
                                    </div>
                                    
                                    <button 
                                        onclick="toggleAllViolations()" 
                                        id="toggleAllViolationsBtn"
                                        data-showing="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 180px;">
                                        Show All Violations
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="deviceTypeFilter" style="color: var(--text-color); font-size: 0.9em;">Filter by Type:</label>
                                        <select 
                                            id="deviceTypeFilter" 
                                            onchange="filterDevicesByType()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Types</option>
                                            ${Object.keys(deviceTypes).map(type => 
                                                `<option value="${type}">${type}</option>`
                                            ).join('')}
                                            <option value="REMOVED">Removed</option>
                                        </select>
                                    </div>
                                    
                                    
                                    
                                    <button 
                                        onclick="resetFilters()" 
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 120px;">
                                        Reset Filters
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: var(--header-color); display: block; margin-bottom: 10px;">Devices by Type:</strong>
                                <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;" id="deviceTypeSections">
                    `;
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        const elevatorSection = await generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR'], violationsByDevice);
                        html += elevatorSection;
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    
                    // Then display the rest of the device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        const deviceSection = await generateDeviceTypeSection(type, devices, violationsByDevice);
                        html += deviceSection;
                    }
                    
                    html += `</div></div></div>`;
                    resultDiv.innerHTML = html;
                        } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
            }
        }

        // Add this function before generateDeviceTypeSection
        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            return daysSinceInspection >= 91;
        }

        // Update the generateDeviceTypeSection function
        async function generateDeviceTypeSection(type, devices, violationsByDevice = {}) {
            // First, fetch all permit data for the devices
            const devicePermits = await Promise.all(
                devices.map(device => fetchPermitInfo(device.device_number))
            );

            return `
                <div class="device-type-section" data-device-type="${type}">
                    <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                            <strong style="color: var(--header-color);">${type} (${devices.length}):</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${devices.map((device, index) => {
                                // Get violations for this device
                                const deviceViolations = violationsByDevice[device.device_number] || [];
                                const activeViolations = deviceViolations.filter(v => 
                                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                    v.violation_status?.toUpperCase() === 'OPEN');
                                const violationCount = activeViolations.length;
                                
                                // Get the pre-fetched permit data
                                const permitData = devicePermits[index];
                                const hasPermits = permitData.success && permitData.permits && permitData.permits.length > 0;

                                // Calculate most recent inspection date
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                                
                                // Find most recent date
                                const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                                const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                                
                                // Calculate test eligibility
                                const isEligible = isEligibleForTesting(mostRecentDate);
                                const today = new Date();
                                const daysSinceInspection = mostRecentDate ? 
                                    Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                                
                                // Determine which type of inspection was most recent
                                const lastInspectionType = mostRecentDate ? 
                                    mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT1' :
                                    mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT5' :
                                    'PVI' : null;
                                
                                return `
                                    <div class="device-item" 
                                         data-has-violations="${violationCount > 0}" 
                                         data-device-type="${type}"
                                         data-device-status="${(device.device_status || '').toUpperCase()}">
                                        <div style="padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                            <div><strong style="color: var(--header-color);">Device #:</strong> ${device.device_number}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}</div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">Test Status:</strong>
                                                    <span data-test-status="${isEligible}" style="padding: 4px 8px; border-radius: 4px; background: ${isEligible ? '#4CAF50' : '#ff6b6b'}; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 4px;">
                                                        ${isEligible ? 
                                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                            </svg>Eligible` : 
                                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                            </svg>Not Eligible`}
                                                    </span>
                                                </div>
                                            </div>
                                            ${mostRecentDate ? `
                                                <div style="margin-top: 5px; color: ${isEligible ? '#4CAF50' : '#ff6b6b'};">
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span>Last Inspection: ${mostRecentDate.toLocaleDateString()}</span>
                                                        <span style="padding: 2px 6px; background: var(--panel-bg); border-radius: 3px; color: var(--header-color);">${lastInspectionType}</span>
                                                        <span>• ${daysSinceInspection} days ago</span>
                                                    </div>
                                                    <div style="margin-top: 5px; color: ${isEligible ? '#4CAF50' : '#ff6b6b'};">
                                                        ${isEligible ? 
                                                            `Eligible for testing since: ${new Date(mostRecentDate.getTime() + (91 * 24 * 60 * 60 * 1000)).toLocaleDateString('en-US', { 
                                                                weekday: 'long',
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric'
                                                            })}` : 
                                                            `Will be eligible for testing on: ${new Date(mostRecentDate.getTime() + (91 * 24 * 60 * 60 * 1000)).toLocaleDateString('en-US', { 
                                                                weekday: 'long',
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric'
                                                            })}`
                                                        }
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${violationCount > 0 ? `
                                                <div style="margin-top: 5px;">
                                                    <span style="color: #ff6b6b; font-weight: 500;">
                                                        ${violationCount} Active Violation${violationCount !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="margin-top: 5px;">
                                                    <button onclick="toggleViolations('${device.device_number}')" 
                                                        id="violationsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Violation Details</span>
                                                        <span class="arrow">▼</span>
                                    </button>
                                                    <div id="violations_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                <div style="margin-top: 10px;">
                                                <button onclick="toggleDeviceDetails('${device.device_number}')" 
                                                    id="detailsBtn_${device.device_number}"
                                                    style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                           border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                           font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                    <span>Show Details</span>
                                                    <span class="arrow">▼</span>
                                    </button>
                                                <div id="details_${device.device_number}" style="display: none; margin-top: 8px; 
                                                     padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                </div>
                            </div>
                                            ${hasPermits ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="togglePermitInfo('${device.device_number}')" 
                                                        id="permitsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Permit Information</span>
                                                        <span class="arrow">▼</span>
                                                    </button>
                                                    <div id="permits_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Add this function to toggle violations display for a device
        async function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                arrow.textContent = '▲';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (deviceNumber.startsWith('device_violations_') || deviceNumber.startsWith('quick_device_violations_')) {
                    // The violations are already pre-rendered in the HTML, so we don't need to do anything
                    return;
                }
                
                // Use pre-fetched violations if available
                let activeViolations = [];
                if (window.violationsByDevice && window.violationsByDevice[deviceNumber]) {
                    const deviceViolations = window.violationsByDevice[deviceNumber];
                    activeViolations = deviceViolations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                } else {
                    // Fallback to fetching for this specific device if needed
                    const violations = await fetchViolations(deviceNumber);
                    activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                }
                
                if (activeViolations.length > 0) {
                    let violationsHtml = `
                        <div style="margin-bottom: 5px; color: var(--header-color);">
                            <strong>Active Violations (${activeViolations.length}):</strong>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
                    `;
                    
                    activeViolations.forEach(v => {
                        const issueDate = v.violation_issue_date ? new Date(v.violation_issue_date).toLocaleDateString() : 'Unknown';
                        violationsHtml += `
                            <div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); 
                                 border-radius: 4px; border: 1px solid var(--input-border); box-shadow: 0 1px 2px var(--card-shadow);">
                                <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'Unknown'}</div>
                                <div><strong style="color: var(--header-color);">Issued:</strong> ${issueDate}</div>
                                <div><strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'Not specified'}</div>
                                ${v.violation_category ? 
                                    `<div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category}</div>` : ''}
                                ${v.violation_severity ? 
                                    `<div><strong style="color: var(--header-color);">Severity:</strong> ${v.violation_severity}</div>` : ''}
                                ${v.violation_remarks ? 
                                    `<div style="margin-top: 5px;"><strong style="color: var(--header-color);">Remarks:</strong> 
                                        <div style="white-space: pre-wrap; margin-top: 3px;">${v.violation_remarks}</div>
                                    </div>` : ''}
                            </div>
                        `;
                    });
                    
                    violationsHtml += `</div>`;
                    violationsDiv.innerHTML = violationsHtml;
                } else {
                    violationsDiv.innerHTML = `<div style="text-align: center; color: var(--text-color);">No active violations found</div>`;
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = '▼';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Update the exportBinToCSV function to include violations
        function exportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations column
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Active Violations\n';

            // Create an array of promises to fetch violations for each device
            const promises = data.map(async device => {
                const violations = await fetchViolations(device.device_number);
                const activeViolations = violations.filter(v => 
                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                    v.violation_status?.toUpperCase() === 'OPEN');
                
                return {
                    device: device,
                    violationCount: activeViolations.length,
                    violationNumbers: activeViolations.map(v => v.violation_number || 'Unknown').join('; ')
                };
            });

            // Process all promises and then create the CSV
            Promise.all(promises).then(results => {
                results.forEach(result => {
                    const device = result.device;
                    const row = [
                        device.device_number,
                        device.bin,
                        `${device.house_number} ${device.street_name}`,
                        device.borough,
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        `${result.violationCount} (${result.violationNumbers})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `bin_${data[0].bin}_devices_with_violations.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('binNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupDevices();
            }
        });

        // Add this new function to your script section
        function clearLookups() {
            // Clear input fields
            document.getElementById('deviceNumber').value = '';
            document.getElementById('binNumber').value = '';
            document.getElementById('binResult').style.display = 'none';
            document.getElementById('deviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
            document.getElementById('quickBinValue').textContent = '-'; // Add this line to clear the BIN in ELV3 Lookup
            window.lastBinSearchResults = null;
        }

        // Add these new functions to your script section
        async function lookupBulkDevices() {
            const textarea = document.getElementById('bulkDeviceNumbers');
            const resultDiv = document.getElementById('bulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                    } else {
                        notFound.push(deviceNumber);
                    }
                }

                    let html = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--header-color); display: inline-block; width: 180px;">Total Devices Searched:</strong> 
                            <span>${deviceNumbers.length}</span>
                        </div>
                        <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices
                for (const [bin, group] of Object.entries(binGroups)) {
                    html += `
                        <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">BIN:</strong> ${bin}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> ${group.address}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Devices Found:</strong> ${group.devices.length}
                            </div>
                            <div style="padding-left: 15px;">
                    `;

                    group.devices.forEach(device => {
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Number:</strong> ${device.device_number}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Type:</strong> ${device.device_type || 'N/A'}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Status:</strong> ${device.device_status || 'N/A'}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> ${device.block || 'N/A'}<br>
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> ${device.lot || 'N/A'}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid var(--input-border);">
                            <div style="color: #ff6b6b;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Devices Not Found:</strong>
                                <div style="margin-top: 5px; padding-left: 120px;">
                                    ${notFound.join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearBulkLookup() {
            document.getElementById('bulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('bulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function lookupAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('addressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }
                const [_, houseNumber, streetName] = match;
                
                // Build the query
                const query = `$where=UPPER(house_number)='${houseNumber}' AND UPPER(street_name) like '${streetName}%'${borough ? ` AND UPPER(borough) like '${borough}%'` : ''}`;
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${query}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
            // Group results by BIN to avoid duplicates
            const binGroups = {};
            data.forEach(device => {
                if (!binGroups[device.bin]) {
                    binGroups[device.bin] = {
                        address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                        devices: []
                    };
                }
                binGroups[device.bin].devices.push(device);
            });

            let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                    <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                    </div>
                    <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
            `;

            for (const [bin, group] of Object.entries(binGroups)) {
                html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;
            resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearAddressLookup() {
            document.getElementById('fullAddress').value = '';
            const resultDiv = document.getElementById('addressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('fullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAddress();
            }
        });

        // Add this new function to your script section
        function exportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Block,Lot\n';

            // Add found devices
            for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                group.devices.forEach(device => {
                    const row = [
                        device.device_number,
                        bin,
                        `${device.house_number} ${device.street_name}`,
                        device.borough,
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        device.block || 'N/A',
                        device.lot || 'N/A'
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_lookup_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add all devices
            data.forEach(device => {
                const row = [
                    device.device_number,
                    device.bin,
                    `${device.house_number} ${device.street_name}`,
                    device.borough,
                    device.device_type || 'N/A',
                    device.device_status || 'N/A'
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bin_${data[0].bin}_devices.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add this function to fetch violations
        async function fetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the lookupDeviceDetails function
        async function lookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
                const violations = await fetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong>Violation #:</strong> ${v.violation_number}<br>
                                    <strong>Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong>Status:</strong> ${v.violation_status}<br>
                                    <strong>Type:</strong> ${v.violation_type}<br>
                                    <strong>Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            deviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong>Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            deviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function exportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await fetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function handleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to your JavaScript section
        function clearDeviceSearch() {
            const deviceNumber = document.getElementById('deviceNumber');
            const binNumber = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            // If this was triggered by an X button next to device search
            if (deviceNumber === document.activeElement || deviceNumber.value) {
                deviceNumber.value = '';
                document.getElementById('binResult').style.display = 'none';
            }
            
            // If this was triggered by an X button next to BIN search
            if (binNumber === document.activeElement || binNumber.value) {
                binNumber.value = '';
                document.getElementById('deviceResult').style.display = 'none';
            }
            
            // Clear BIN display if both fields are empty
            if (!deviceNumber.value && !binNumber.value) {
                quickBinValue.textContent = '-';
            }
            
            document.getElementById('binExportButton').style.display = 'none';
        }

        // Add this new function to your script section
        async function quickLookupBIN() {
            const deviceNumber = document.getElementById('quickDeviceNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            const binInput = document.getElementById('quickBinNumber');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    if (device.bin) {
                        quickLookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('quickDeviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: #2c2c2c; color: #ffffff; border: 1px solid #444; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">▼</span>
                            </button>
                            <div id="quickDeviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: #2c2c2c; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                        
                    resultDiv.innerHTML = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : '#ffffff'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('quick_device_violations_${deviceNumber}')" 
                                            id="violationsBtn_quick_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">▼</span>
                                    </button>
                                    <div id="violations_quick_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                                <strong style="color: #4a9eff; margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span>${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span>${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span>${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span>${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            ${deviceSpecsHTML}
                            
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                element.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Add event listener for Enter key
        document.getElementById('quickDeviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupBIN();
            }
        });

        // Add the new lookupDevices function
        async function quickLookupDevices() {
            const binNumber = document.getElementById('quickBinNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices
                    const removedDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Add back the device grouping code
                    const deviceTypes = {};
                    data.forEach(device => {
                            const type = device.device_type || 'Unknown';
                            if (!deviceTypes[type]) {
                                deviceTypes[type] = [];
                            }
                            deviceTypes[type].push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #4a9eff;">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: #4a9eff;">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: #4a9eff;">Total Active Violations:</strong> 
                                        <span style="color: ${activeDevices > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${activeDevices > 0 ? activeDevices : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">• Active Devices: ${activeDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">• Removed Devices: ${removedDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">• Dismantled Devices: ${dismantledDevices}</span>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: #4a9eff; display: block; margin-bottom: 10px;">Devices by Type:</strong>
                                <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        html += generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR']);
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    // Then display the rest of the device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        html += generateDeviceTypeSection(type, devices);
                    }
                    
                    html += `</div></div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
            }
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('quickBinNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupDevices();
            }
        });

        // Add this new function to your script section
        function clearQuickLookups() {
            // Clear input fields
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickBinResult').style.display = 'none';
            document.getElementById('quickDeviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
            window.lastBinSearchResults = null;
        }

        // Add these new functions to your script section
        async function quickLookupBulkDevices() {
            const textarea = document.getElementById('quickBulkDeviceNumbers');
            const resultDiv = document.getElementById('quickBulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                    } else {
                        notFound.push(deviceNumber);
                    }
                }

                    let html = `
                    <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #4a9eff;">Total Devices Searched:</strong> 
                            <span>${deviceNumbers.length}</span>
                            </div>
                        <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices
                for (const [bin, group] of Object.entries(binGroups)) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                <strong style="color: #4a9eff;">Devices Found:</strong> ${group.devices.length}
                            </div>
                            <div style="padding-left: 15px;">
                    `;

                    group.devices.forEach(device => {
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                <strong style="color: #4a9eff;">Device Number:</strong> ${device.device_number}<br>
                                <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Block:</strong> ${device.block || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Lot:</strong> ${device.lot || 'N/A'}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="color: #ff6b6b;">
                                <strong>Devices Not Found:</strong>
                                <div style="margin-top: 5px;">
                                    ${notFound.join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                document.getElementById('exportButton').style.display = 'none';
            }
        }

        function clearQuickBulkLookup() {
            document.getElementById('quickBulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('quickBulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function quickLookupAddress() {
            const fullAddress = document.getElementById('quickFullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('quickAddressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }

                const [_, houseNumber, streetName] = match;
                
                // Build the query
                const query = `$where=UPPER(house_number)='${houseNumber}' AND UPPER(street_name) like '${streetName}%'${borough ? ` AND UPPER(borough) like '${borough}%'` : ''}`;
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${query}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Group results by BIN to avoid duplicates
                    const binGroups = {};
                    data.forEach(device => {
                        if (!binGroups[device.bin]) {
                            binGroups[device.bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[device.bin].devices.push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                            </div>
                            <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;

                    for (const [bin, group] of Object.entries(binGroups)) {
                        html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearQuickAddressLookup() {
            document.getElementById('quickFullAddress').value = '';
            const resultDiv = document.getElementById('quickAddressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('quickFullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupAddress();
            }
        });

        // Add this new function to your script section
        function quickExportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Block,Lot\n';
            // Add found devices
            for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                group.devices.forEach(device => {
                    const row = [
                        device.device_number,
                        bin,
                        `${device.house_number} ${device.street_name}`,
                        device.borough,
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        device.block || 'N/A',
                        device.lot || 'N/A'
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_lookup_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function quickExportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add all devices
            data.forEach(device => {
                const row = [
                    device.device_number,
                    device.bin,
                    `${device.house_number} ${device.street_name}`,
                    device.borough,
                    device.device_type || 'N/A',
                    device.device_status || 'N/A'
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bin_${data[0].bin}_devices.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add this function to fetch violations
        async function quickFetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the quickLookupDeviceDetails function
        async function quickLookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
            const violations = await quickFetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong style="color: #4a9eff;">Violation #:</strong> ${v.violation_number}<br>
                                    <strong style="color: #4a9eff;">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong style="color: #4a9eff;">Status:</strong> ${v.violation_status}<br>
                                    <strong style="color: #4a9eff;">Type:</strong> ${v.violation_type}<br>
                                    <strong style="color: #4a9eff;">Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            quickDeviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #4a9eff;">Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            quickDeviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function quickExportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await quickFetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'quick_device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function quickHandleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to ensure proper light/dark mode in results
        function applyColorTheme() {
            // Force theme on any elements with hardcoded dark backgrounds
            document.querySelectorAll('[style*="background: #1c1c1c"], [style*="background: #2c2c2c"]').forEach(el => {
                el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--input-bg');
                el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
            });
        }

        // Call this function after generating results
        // Add these lines at the end of the lookupDevices() function
        resultDiv.innerHTML = html;
        applyColorTheme();

        // Updated function to also display days since the last update
        async function fetchAPILastUpdateDate() {
            try {
                // Get reference to the element displaying the update date
                const apiLastUpdatedElement = document.getElementById('apiLastUpdated');
                if (!apiLastUpdatedElement) return;
                
                // Set loading state
                apiLastUpdatedElement.textContent = "Loading...";
                
                try {
                    // Try to fetch the most current data
                    const response = await fetch('https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$limit=1');
                    if (!response.ok) {
                        throw new Error('Failed to fetch API data');
                    }
                    
                    // Get the dataset metadata
                    const metadataResponse = await fetch('https://data.cityofnewyork.us/api/views/metadata/e5aq-a4j2.json');
                    if (!metadataResponse.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    
                    const metadata = await metadataResponse.json();
                    
                    // Look for the update date in different possible locations
                    let updateDateString = metadata.rowsUpdatedAt || 
                                          (metadata.customFields && metadata.customFields.last_update) || 
                                          metadata.dataUpdatedAt ||
                                          metadata.viewLastModified;
                    
                    let updateDate;
                    if (updateDateString) {
                        updateDate = new Date(updateDateString);
                        // Only update if we got a valid date
                        if (!isNaN(updateDate.getTime())) {
                            const formattedDate = updateDate.toLocaleDateString('en-US', { 
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric'
                            });
                            apiLastUpdatedElement.textContent = formattedDate;
                            console.log("API data last updated:", formattedDate);
                        } else {
                            throw new Error('Invalid date format from API');
                        }
                    } else {
                        throw new Error('No update date found in metadata');
                    }
                    
                    // Calculate days since update
                    const today = new Date();
                    const timeDiff = today - updateDate;
                    const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Get or create the days since element
                    let daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (!daysSinceElement) {
                        daysSinceElement = document.createElement('div');
                        daysSinceElement.id = 'daysSinceUpdate';
                        daysSinceElement.style.textAlign = 'center';
                        daysSinceElement.style.fontSize = '0.9em';
                        daysSinceElement.style.color = 'var(--text-color)';
                        daysSinceElement.style.opacity = '0.8';
                        daysSinceElement.style.marginTop = '5px';
                        
                        // Insert after the apiLastUpdated parent element
                        const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                        parentElement.appendChild(daysSinceElement);
                    }
                    
                    // Display appropriate message based on days with new color thresholds
                    if (daysSinceUpdate <= 0) {
                        daysSinceElement.textContent = "Updated today";
                        daysSinceElement.style.color = "#4CAF50"; // Green for today
                    } else if (daysSinceUpdate === 1) {
                        daysSinceElement.textContent = "Updated 1 day ago";
                        daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                    } else if (daysSinceUpdate < 14) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                    } else if (daysSinceUpdate < 30) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                    } else {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                    }
                } catch (innerError) {
                    console.error('Error in primary fetch:', innerError);
                    
                    // If we can't fetch the date, try to fetch from the actual dataset with a fallback
                    try {
                        const apiResponse = await fetch('https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$query=SELECT%20:created_at,%20:updated_at%20LIMIT%201');
                        if (apiResponse.ok) {
                            const apiData = await apiResponse.json();
                            if (apiData && apiData.length > 0) {
                                // Try to get the updated_at timestamp from the actual data
                                let updateTimeString = apiData[0][":updated_at"] || apiData[0][":created_at"];
                                if (updateTimeString) {
                                    const updateDate = new Date(updateTimeString);
                                    if (!isNaN(updateDate.getTime())) {
                                        const formattedDate = updateDate.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        });
                                        
                                        apiLastUpdatedElement.textContent = formattedDate;
                                        
                                        // Calculate and display days since update
                                        const today = new Date();
                                        const timeDiff = today - updateDate;
                                        const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                        
                                        let daysSinceElement = document.getElementById('daysSinceUpdate');
                                        if (!daysSinceElement) {
                                            daysSinceElement = document.createElement('div');
                                            daysSinceElement.id = 'daysSinceUpdate';
                                            daysSinceElement.style.textAlign = 'center';
                                            daysSinceElement.style.fontSize = '0.9em';
                                            daysSinceElement.style.color = 'var(--text-color)';
                                            daysSinceElement.style.opacity = '0.8';
                                            daysSinceElement.style.marginTop = '5px';
                                            
                                            const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                                            parentElement.appendChild(daysSinceElement);
                                        }
                                        
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = daysSinceUpdate < 14 ? "#4CAF50" : 
                                                                      daysSinceUpdate < 30 ? "#FFA500" : "#FF6B6B";
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Fallback fetch also failed:', fallbackError);
                    }
                    
                    // If all else fails, display an error message
                    apiLastUpdatedElement.textContent = "Unable to fetch update date";
                    
                    // Remove the days since update element if it exists
                    const daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (daysSinceElement) {
                        daysSinceElement.parentElement.removeChild(daysSinceElement);
                    }
                }
            } catch (outerError) {
                console.error('Outer error in fetchAPILastUpdateDate:', outerError);
            }
        }

        // Call this function when the DOB tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on the DOB tab initially or when tab changes
            const dobTab = document.getElementById('dobTab');
            if (dobTab) {
                dobTab.addEventListener('click', fetchAPILastUpdateDate);
            }
            
            // Also check if DOB tab is the default tab on load
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            if (defaultTab === 'dob') {
                fetchAPILastUpdateDate();
            }
        });
        // Restore the missing functions for ELV3 lookup functionality
        function toggleQuickLookup() {
            const panel = document.getElementById('quickLookupPanel');
            const overlay = document.getElementById('quickLookupOverlay');
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                
                // Position panel based on screen width
                if (window.innerWidth <= 600) {
                    panel.classList.add('panel-centered-mobile');
                } else {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
                
                // Add a small delay before adding opacity for smooth transition
                setTimeout(() => {
                    overlay.style.opacity = '1';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(0)';
                }, 10);
                
                // Ensure the panel is visible regardless of which tab is active
                panel.style.zIndex = '2000'; // Higher than any tab content
                
                // Bring the panel to the front of all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    if (panel.parentElement === section) {
                        // If the panel is inside this section, move it to the body
                        document.body.appendChild(panel);
                    }
                });
            } else {
                overlay.style.opacity = '0';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-20px)';
                
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    panel.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        // Add click handler to close panel when clicking overlay
        document.getElementById('quickLookupOverlay').addEventListener('click', function() {
            toggleQuickLookup();
        });
        // Add these new functions for the quick lookup panel
        document.getElementById('quickNumInput').addEventListener('input', function(e) {
            let result = numberToWord(e.target.value);
            document.getElementById('quickNumResult').textContent = result;
        });

        document.getElementById('quickLetterInput').addEventListener('input', function(e) {
            let result = letterToWord(e.target.value);
            document.getElementById('quickLetterResult').textContent = result;
        });

        document.getElementById('quickSecondaryNumInput').addEventListener('input', function(e) {
            let result = secondaryNumberToWord(e.target.value);
            document.getElementById('quickSecondaryNumResult').textContent = result;
        });

        function quickClearInputs() {
            document.getElementById('quickNumInput').value = '';
            document.getElementById('quickLetterInput').value = '';
            document.getElementById('quickSecondaryNumInput').value = '';
            document.getElementById('quickNumResult').textContent = '';
            document.getElementById('quickLetterResult').textContent = '';
            document.getElementById('quickSecondaryNumResult').textContent = '';
            document.getElementById('quickNumInput').focus();
        }

        function quickClearDeviceSearch() {
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickDeviceResult').style.display = 'none';
        }

        // Add this function to fetch violations for all devices by BIN
        async function fetchViolationsForBin(bin) {
            try {
                // This will get all violations for the given BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?$where=bin='${bin}'`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Group violations by device number for easier lookup
                const violationsByDevice = {};
                data.forEach(violation => {
                    const deviceNum = violation.device_number;
                    if (!violationsByDevice[deviceNum]) {
                        violationsByDevice[deviceNum] = [];
                    }
                    violationsByDevice[deviceNum].push(violation);
                });
                
                return violationsByDevice;
            } catch (error) {
                console.error('Error fetching violations for BIN:', error);
                return {};
            }
        }

        // Add this function to handle custom days input changes
        function customDaysChanged() {
            const dateStr = document.getElementById('dateInput').value;
            const customDays = document.getElementById('customDays').value;
            
            // Only perform the calculation if we have both a date and a days value
            if (dateStr && customDays && !isNaN(parseInt(customDays))) {
                calculateCustomDate();
            }
        }

        // Add event listener for the custom days input
        document.addEventListener('DOMContentLoaded', function() {
            // Existing date input listener
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // New custom days input listener
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', customDaysChanged);
            }
        });

        // Add media query handling for responsive ELV3 Lookup button
        function handleResponsiveELV3Button() {
            const buttonTexts = document.querySelectorAll('.button-text');
            const buttonIcons = document.querySelectorAll('.button-icon');
            const lookupButton = document.querySelector('button[onclick="toggleQuickLookup()"]');
            const panel = document.getElementById('quickLookupPanel');
            
            if (window.innerWidth < 600) {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'none';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'block';
                });
                // Make button more compact on mobile
                if (lookupButton) {
                    lookupButton.style.padding = '10px';
                    lookupButton.style.borderRadius = '50%';
                    lookupButton.style.width = '44px';
                    lookupButton.style.height = '44px';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.add('panel-centered-mobile');
                }
            } else {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'block';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'none';
                });
                // Restore button style on desktop
                if (lookupButton) {
                    lookupButton.style.padding = '12px 20px';
                    lookupButton.style.borderRadius = '4px';
                    lookupButton.style.width = 'auto';
                    lookupButton.style.height = 'auto';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
            }
        }
        
        // Run on page load
        handleResponsiveELV3Button();
        
        // Run on window resize
        window.addEventListener('resize', handleResponsiveELV3Button);

        // Toggle DOB NOW section
        function toggleDobNowSection() {
            const dobNowSection = document.getElementById('dobNowSection');
            const showDobNowBtn = document.getElementById('showDobNowBtn');
            
            if (dobNowSection.style.display === 'none') {
                dobNowSection.style.display = 'block';
                showDobNowBtn.textContent = 'Hide DOB NOW Interface';
            } else {
                dobNowSection.style.display = 'none';
                showDobNowBtn.textContent = 'Show DOB NOW Interface';
            }
        }

        // Function to fetch the last update date for the violations API
        async function fetchViolationsAPILastUpdateDate() {
            try {
                // Set the default date based on known information
                const defaultDate = "February 28, 2025";
                const violationsApiLastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                
                // Start with the known date from screenshot
                violationsApiLastUpdatedElement.textContent = defaultDate;
                
                // Calculate and display days since update
                let updateDate = new Date(defaultDate);
                
                // Try to fetch the most current data
                const metadataResponse = await fetch('https://data.cityofnewyork.us/api/views/metadata/855j-jady.json');
                if (metadataResponse.ok) {
                    const metadata = await metadataResponse.json();
                    
                    // Look for the update date in different possible locations
                    let updateDateString = metadata.rowsUpdatedAt || 
                                          (metadata.customFields && metadata.customFields.last_update) || 
                                          metadata.dataUpdatedAt ||
                                          metadata.viewLastModified;
                    
                    if (updateDateString) {
                        updateDate = new Date(updateDateString);
                        // Only update if we got a valid date
                        if (!isNaN(updateDate.getTime())) {
                            const formattedDate = updateDate.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            violationsApiLastUpdatedElement.textContent = formattedDate;
                            console.log("Violations API data last updated:", formattedDate);
                        }
                    }
                }
                
                // Calculate days since update (whether we got a new date or are using the default)
                const today = new Date();
                const timeDiff = today - updateDate;
                const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                // Get the days since element
                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                
                daysSinceElement.textContent = daysSinceUpdate === 0 ? 'Updated Today' : `Updated ${daysSinceUpdate} days ago`;
                daysSinceElement.style.color = daysSinceUpdate < 14 ? "#4CAF50" : 
                                              daysSinceUpdate < 30 ? "#FFA500" : "#FF6B6B";
            } catch (error) {
                console.error('Error fetching Violations API update date:', error);
                // Display days since the default date even if there's an error
                const today = new Date();
                const defaultDate = new Date("February 28, 2025");
                const timeDiff = today - defaultDate;
                const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                // Get the days since element
                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                
                daysSinceElement.textContent = daysSinceUpdate === 0 ? 'Updated Today' : `Updated ${daysSinceUpdate} days ago`;
                daysSinceElement.style.color = daysSinceUpdate < 14 ? "#4CAF50" : 
                                              daysSinceUpdate < 30 ? "#FFA500" : "#FF6B6B";
            }
        }

        // Add event listener to call the function when the violations tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Call the function immediately when the page loads
            fetchViolationsAPILastUpdateDate();
            
            // Also set up the tab click listener
            const violationsTab = document.getElementById('violationsTab');
            if (violationsTab) {
                violationsTab.addEventListener('click', fetchViolationsAPILastUpdateDate);
            }
            
            // Also check if violations tab is the default tab on load
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            if (defaultTab === 'violations') {
                fetchViolationsAPILastUpdateDate();
            }
            
            // Update API data on page load
            updateAllAPIData();
        });

        // Function to update all API data
        function updateAllAPIData() {
            // Update both APIs immediately
            fetchAPILastUpdateDate();
            fetchViolationsAPILastUpdateDate();
            console.log(`API data updated at ${new Date().toLocaleTimeString()}`);
        }

        // Add these new functions for filtering
        function toggleViolationsFilter() {
            const button = document.getElementById('violationsFilterBtn');
            const buttonText = document.getElementById('violationsFilterText');
            const deviceItems = document.querySelectorAll('.device-item');
            const isFiltering = button.getAttribute('data-filtering') === 'true';
            
            if (!isFiltering) {
                // Enable filtering - show only devices with violations
                deviceItems.forEach(item => {
                    if (item.getAttribute('data-has-violations') === 'false') {
                        item.style.display = 'none';
                    }
                });
                button.setAttribute('data-filtering', 'true');
                buttonText.textContent = 'Show All Devices';
                button.style.background = '#1a73e8';
                button.style.color = 'white';
                // Keep the width consistent
                button.style.width = '240px';
            } else {
                // Disable filtering - show all devices (respecting type filter)
                const typeFilter = document.getElementById('deviceTypeFilter').value;
                deviceItems.forEach(item => {
                    if (typeFilter === 'all' || item.getAttribute('data-device-type') === typeFilter) {
                        item.style.display = '';
                    }
                });
                button.setAttribute('data-filtering', 'false');
                buttonText.textContent = 'Show Only Devices with Violations';
                button.style.background = 'var(--panel-bg)';
                button.style.color = 'var(--text-color)';
                // Keep the width consistent
                button.style.width = '240px';
            }
            
            updateDeviceTypeSectionVisibility();
        }
        
        function filterDevicesByType() {
            const typeFilter = document.getElementById('deviceTypeFilter').value;
            const deviceItems = document.querySelectorAll('.device-item');
            const violationsFiltering = document.getElementById('violationsFilterBtn').getAttribute('data-filtering') === 'true';
            
            deviceItems.forEach(item => {
                const deviceType = item.getAttribute('data-device-type');
                const hasViolations = item.getAttribute('data-has-violations') === 'true';
                
                if ((typeFilter === 'all' || deviceType === typeFilter) && 
                    (!violationsFiltering || hasViolations)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateDeviceTypeSectionVisibility();
        }
        
        function resetFilters() {
            // Reset violations filter
            const violationsFilterBtn = document.getElementById('violationsFilterBtn');
            violationsFilterBtn.setAttribute('data-filtering', 'false');
            document.getElementById('violationsFilterText').textContent = 'Show Only Devices with Violations';
            violationsFilterBtn.style.background = 'var(--panel-bg)';
            violationsFilterBtn.style.color = 'var(--text-color)';
            violationsFilterBtn.style.width = '240px';
            
            // Reset type filter
            document.getElementById('deviceTypeFilter').value = 'all';
            
            // Show all devices
            document.querySelectorAll('.device-item').forEach(item => {
                item.style.display = '';
            });
            
            // Show all sections
            document.querySelectorAll('.device-type-section').forEach(section => {
                section.style.display = '';
            });
        }
        
        function updateDeviceTypeSectionVisibility() {
            // Hide sections that have no visible devices
            document.querySelectorAll('.device-type-section').forEach(section => {
                const visibleDevices = section.querySelectorAll('.device-item:not([style*="display: none"])');
                const totalDevices = section.querySelectorAll('.device-item');
                
                if (visibleDevices.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            });
        }
        
        // Function to toggle all violations (show or hide)
        function toggleAllViolations() {
            const toggleButton = document.getElementById('toggleAllViolationsBtn');
            const isShowing = toggleButton.getAttribute('data-showing') === 'true';
            
            // Find all devices with violations
            const devicesWithViolations = document.querySelectorAll('.device-item[data-has-violations="true"]');
            
            if (!isShowing) {
                // Show all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display === 'none') {
                                // Only click if violations are not already shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Hide All Violations';
                toggleButton.setAttribute('data-showing', 'true');
            } else {
                // Hide all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display !== 'none') {
                                // Only click if violations are currently shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Show All Violations';
                toggleButton.setAttribute('data-showing', 'false');
            }
        }

        // Function to fetch permit information for a device's BIN
        async function fetchPermitInfo(deviceNumber) {
            try {
                // First get the device details to get the BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    let allPermits = [];
                    let success = false;
                    
                    // Try to find permits that specifically mention this device number
                    if (binNumber) {
                        try {
                            // First try to find permits that specifically mention this device number in the description
                            const deviceQuery = `$where=bin='${binNumber}' AND descriptionofwork like '%${deviceNumber}%'`;
                            const deviceSpecificResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?${deviceQuery}`);
                            
                            if (deviceSpecificResponse.ok) {
                                const deviceSpecificData = await deviceSpecificResponse.json();
                                if (deviceSpecificData && deviceSpecificData.length > 0) {
                                    // Normalize the data structure to match our expected format
                                    const normalizedData = deviceSpecificData.map(permit => ({
                                        permit_number: permit.job_filing_number || permit.job_number,
                                        permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                            `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                            permit.applicant_businessname || 'N/A',
                                        issuance_date: permit.filing_date,
                                        expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                        house_number: permit.house_number,
                                        street_name: permit.street_name,
                                        application_type: permit.filing_type,
                                        work_type: permit.elevatordevicetype,
                                        filing_status: permit.filing_status,
                                        job_filing_number: permit.job_filing_number,
                                        business_name: permit.applicant_businessname || permit.owner_businessname,
                                        description: permit.descriptionofwork,
                                        device_specific: true
                                    }));
                                    allPermits = [...normalizedData];
                                    success = true;
                                }
                            }
                            
                            // If no exact match found, try looking for permits that might be for this device
                            if (allPermits.length === 0) {
                                // Get all permits for this BIN
                                const binResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?bin=${binNumber}`);
                                if (binResponse.ok) {
                                    const binData = await binResponse.json();
                                    
                                    // Get the device type and other identifiers
                                    const deviceType = device.device_type ? device.device_type.toUpperCase() : 'ELEVATOR';
                                    const deviceLocation = device.device_location || '';
                                    
                                    // Look for permits that might be for this specific device
                                    const potentialMatches = binData.filter(permit => {
                                        if (!permit.descriptionofwork) return false;
                                        
                                        const desc = permit.descriptionofwork.toUpperCase();
                                        
                                        // Check for exact device number match
                                        if (desc.includes(deviceNumber)) return true;
                                        
                                        // Check for location match if available
                                        if (deviceLocation && desc.includes(deviceLocation.toUpperCase())) return true;
                                        
                                        // Check for specific identifiers that might indicate this device
                                        // For example, "Car 3" or "Elevator #3" if device number ends with 3
                                        const deviceNumberEnd = deviceNumber.slice(-1);
                                        if (desc.includes(`CAR ${deviceNumberEnd}`) || 
                                            desc.includes(`ELEVATOR #${deviceNumberEnd}`) ||
                                            desc.includes(`ELEVATOR ${deviceNumberEnd}`)) {
                                            return true;
                                        }
                                        
                                        return false;
                                    });
                                    
                                    if (potentialMatches.length > 0) {
                                        const normalizedData = potentialMatches.map(permit => ({
                                            permit_number: permit.job_filing_number || permit.job_number,
                                            permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                                `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                                permit.applicant_businessname || 'N/A',
                                            issuance_date: permit.filing_date,
                                            expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                            house_number: permit.house_number,
                                            street_name: permit.street_name,
                                            application_type: permit.filing_type,
                                            work_type: permit.elevatordevicetype,
                                            filing_status: permit.filing_status,
                                            job_filing_number: permit.job_filing_number,
                                            business_name: permit.applicant_businessname || permit.owner_businessname,
                                            description: permit.descriptionofwork,
                                            device_specific: permit.descriptionofwork.includes(deviceNumber)
                                        }));
                                        allPermits = [...normalizedData];
                                        success = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching device-specific permits:', error);
                        }
                    }
                    
                    // Return the permits found
                    return {
                        success: success,
                        device: device,
                        permits: allPermits,
                        deviceNumber: deviceNumber
                    };
                }
                
                return {
                    success: false,
                    message: 'No device or BIN information found'
                };
            } catch (error) {
                console.error('Error fetching permit information:', error);
                return {
                    success: false,
                    message: 'Error fetching permit information'
                };
            }
        }
        
        // Add this function to toggle permit information display for a device
        async function togglePermitInfo(deviceNumber) {
            const permitElement = document.getElementById(`permits_${deviceNumber}`);
            const button = document.getElementById(`permitsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (permitElement.style.display === 'none') {
                permitElement.style.display = 'block';
                arrow.textContent = '▲';
                if (buttonText) {
                    buttonText.textContent = 'Hide Permit Information';
                }
                
                // Check if permit info is already loaded
                if (permitElement.getAttribute('data-loaded') !== 'true') {
                    permitElement.innerHTML = '<span style="color: var(--text-color);">Loading permit information...</span>';
                    
                    const result = await fetchPermitInfo(deviceNumber);
                    
                    if (result.success && result.permits.length > 0) {
                        // Sort permits by device-specific first, then by issue date (newest first)
                        const permits = result.permits.filter(permit => permit.issuance_date);
                        permits.sort((a, b) => {
                            // First prioritize device-specific permits
                            if (a.device_specific && !b.device_specific) return -1;
                            if (!a.device_specific && b.device_specific) return 1;
                            
                            // Then sort by date (newest first)
                            return new Date(b.issuance_date) - new Date(a.issuance_date);
                        });
                        
                        // Get the most recent permits (up to 5)
                        const recentPermits = permits.slice(0, 5);
                        
                        let html = `
                            <div style="margin-bottom: 5px; color: var(--header-color);">
                                <strong>Permit Information for Device #${deviceNumber} (${permits.length} total):</strong>
                                                    </div>
                            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                        `;
                        
                        recentPermits.forEach(permit => {
                            const issueDate = permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'Unknown';
                            const expirationDate = permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'Unknown';
                            
                            // Add a special highlight for device-specific permits
                            const isDeviceSpecific = permit.device_specific || 
                                (permit.description && (
                                    permit.description.includes(deviceNumber) || 
                                    permit.description.includes(result.deviceNumber)
                                ));
                            
                            html += `
                                <div style="margin-bottom: 12px; padding: 8px; background: ${isDeviceSpecific ? 'rgba(74, 158, 255, 0.1)' : 'var(--input-bg)'}; 
                                     border-radius: 4px; border: 1px solid ${isDeviceSpecific ? '#4a9eff' : 'var(--input-border)'};">
                                    ${isDeviceSpecific ? 
                                        `<div style="margin-bottom: 8px; padding: 4px; background: #4a9eff; color: white; border-radius: 3px; font-size: 0.85em; display: inline-block;">
                                            Device-Specific Permit
                                        </div>` : ''
                                    }
                                    <div><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Issue Date:</strong> ${issueDate}</div>
                                    <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${expirationDate}</div>
                                    <div><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                    ${permit.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                    ${permit.description ? 
                                        `<div style="margin-top: 8px;">
                                            <strong style="color: var(--header-color);">Description:</strong> 
                                            <div style="margin-top: 4px; padding: 8px; background: var(--panel-bg); border-radius: 4px; white-space: pre-wrap; font-size: 0.9em;">
                                                ${permit.description}
                                                </div>
                                        </div>` : ''
                                    }
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                        permitElement.innerHTML = html;
                        permitElement.setAttribute('data-loaded', 'true');
                    } else {
                        // Try to provide more helpful information when no permits are found
                        let message = '';
                        
                        if (result.success) {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>No permits found for device #${deviceNumber} in the NYC DOB database.</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">This could be because:</p>
                                    <ul style="text-align: left; margin-top: 5px; font-size: 0.9em;">
                                        <li>The permit may be filed under a different BIN</li>
                                        <li>The permit may be older and not included in the digital records</li>
                                        <li>The device may not require a specific permit</li>
                                        <li>The permit may not specifically mention this device number</li>
                                    </ul>
                                    <p style="margin-top: 10px; font-size: 0.9em;">You can try searching directly on the <a href="https://a810-dobnow.nyc.gov/publish/Index.html#!/" target="_blank" style="color: #4a9eff;">DOB NOW portal</a> using the BIN number: ${result.device?.bin || 'N/A'}</p>
                                </div>
                            `;
                        } else {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>${result.message || 'Error fetching permit information'}</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">Please try again later or check the device information.</p>
                                </div>
                            `;
                        }
                        
                        permitElement.innerHTML = message;
                        permitElement.setAttribute('data-loaded', 'true');
                    }
                }
            } else {
                permitElement.style.display = 'none';
                arrow.textContent = '▼';
                if (buttonText) {
                    buttonText.textContent = 'Show Permit Information';
                }
            }
        }

        // Add this new function to fetch detailed device information from the API
        async function fetchDeviceInfo(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/juyv-2jek.json?device_id=${deviceNumber}`);
                
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Error fetching device info:', error);
                return null;
            }
        }

        // Add this function to handle the "X" button clicks
        function handleClearButtonClick(event) {
            const button = event.target;
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
            }
        }

        // Add event listeners for the "X" buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Find all clear buttons (X buttons) next to the lookup buttons
            const clearButtons = document.querySelectorAll('button[onclick="clearDeviceSearch()"]');
            clearButtons.forEach(button => {
                button.addEventListener('click', handleClearButtonClick);
            });
        });

        // Add this new function to handle copying BIN to clipboard
        async function copyBinToClipboard(bin, event) {
            try {
                // Prevent any default behavior
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Get the clicked element
                const span = event ? event.target.closest('span') : document.querySelector(`span[onclick*="${bin}"]`);
                if (!span) return;

                // Store original styles
                const originalBg = span.style.backgroundColor;
                const originalColor = span.style.color;
                const originalBorder = span.style.borderColor;

                // Try modern clipboard API first
                try {
                    await navigator.clipboard.writeText(bin);
                } catch (err) {
                    // Fallback for browsers that don't support clipboard API
                    const textarea = document.createElement('textarea');
                    textarea.value = bin;
                    textarea.style.position = 'fixed';  // Prevent scrolling to bottom
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                // Show success state
                span.style.backgroundColor = '#4CAF50';
                span.style.color = 'white';
                span.style.borderColor = '#4CAF50';
                span.title = 'Copied!';

                // Find the SVG and change its color
                const svg = span.querySelector('svg');
                if (svg) {
                    svg.style.opacity = '1';
                }

                // Reset after 2 seconds
                setTimeout(() => {
                    span.style.backgroundColor = originalBg;
                    span.style.color = originalColor;
                    span.style.borderColor = originalBorder;
                    span.title = 'Click to copy';
                    if (svg) {
                        svg.style.opacity = '0.7';
                    }
                }, 2000);
            } catch (err) {
                console.error('Failed to copy BIN:', err);
                alert('Failed to copy BIN to clipboard');
            }
        }

        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            return daysSinceInspection >= 91;
        }

        function toggleTestEligibilityFilter() {
            const button = document.getElementById('testEligibilityFilterBtn');
            const currentFilter = button.getAttribute('data-filter') || 'all';
            const deviceItems = document.querySelectorAll('.device-item');
            
            let newFilter;
            if (currentFilter === 'all') {
                newFilter = 'eligible';
                button.textContent = 'Show Not Eligible Only';
                button.style.background = '#4CAF50';
            } else if (currentFilter === 'eligible') {
                newFilter = 'not-eligible';
                button.textContent = 'Show All Devices';
                button.style.background = '#ff6b6b';
            } else {
                newFilter = 'all';
                button.textContent = 'Show Eligible Only';
                button.style.background = 'var(--panel-bg)';
            }
            
            button.setAttribute('data-filter', newFilter);
            
            deviceItems.forEach(item => {
                const testStatusElement = item.querySelector('[data-test-status]');
                const isEligible = testStatusElement?.getAttribute('data-test-status') === 'true';
                
                if (newFilter === 'all' || 
                    (newFilter === 'eligible' && isEligible) || 
                    (newFilter === 'not-eligible' && !isEligible)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateDeviceTypeSectionVisibility();
        }
    </script>

    <button onclick="submitFeedback()" class="feedback-button">Submit Feedback</button>
    <div class="credit-text">Created by <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">Michael N. Montesano</a></div>
    <div class="social-icons">
        <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">
            <img src="linkedin-icon.svg" alt="LinkedIn" class="social-icon" onerror="this.innerText='LinkedIn'">
        </a>
    </div>
</body>
</html>

<script src="device-filter-functions.js"></script>
