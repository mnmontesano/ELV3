<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertical Terminal</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Inline theme application to prevent flash: always follow system -->
    <script>
        (function() {
            document.documentElement.classList.remove('light-theme', 'dark-theme', 'system-theme');
            document.documentElement.classList.add('system-theme');
            // Pre-detect popout to avoid flashing the full UI
            try {
                var params = new URLSearchParams(window.location.search);
                if (params.get('popout') === 'lookup') {
                    document.documentElement.classList.add('lookup-popout-boot');
                }
            } catch (e) {}
        })();
    </script>
    <style>
        /* Ensure only the ELV3 Lookup panel shows in popout mode, with minimal flash */
        html.lookup-popout-boot body { max-width: none !important; margin: 0 !important; padding: 0 !important; }
        html.lookup-popout-boot body > *:not(#quickLookupPanel) { display: none !important; }
        html.lookup-popout-boot #quickLookupPanel {
            display: block !important;
            position: fixed !important;
            top: 24px !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translateX(-50%) !important;
            width: min(440px, 100% - 32px) !important;
            max-height: calc(100vh - 48px) !important;
            overflow-y: auto !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
            padding: 16px !important;
            opacity: 1 !important;
            z-index: 1 !important;
        }
    </style>
    
    <script src="theme_script.js"></script>
</head>
<body data-active-tab="main">
    <!-- Make sure this is right after the opening <body> tag -->
    <div id="quickLookupOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <!-- Global DOB Now button (visible on all tabs/pages) -->
    <button id="dobNowBtn" onclick="window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=yes,menubar=yes,location=yes')" 
            style="position: fixed; top: 80px; right: 20px; z-index: 999; padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
        <span class="button-text">DOB Now</span>
        <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
        </svg>
    </button>

    <!-- Quick Lookup Panel moved here so it's available for all tabs -->
    <div style="position: fixed; top: 80px; right: 20px; width: 350px; max-width: calc(100% - 40px); max-height: calc(100vh - 100px); background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--card-shadow); z-index: 1000; display: none; transition: all 0.3s ease; left: auto; overflow-y: auto; overflow-x: hidden;" id="quickLookupPanel">
        <button onclick="popoutQuickLookup()" title="Open in new window" style="position: absolute; right: 44px; top: 10px; background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; transition: color 0.2s; line-height: 1;" aria-label="Pop out">â¤¢</button>
        <button onclick="toggleQuickLookup()" style="position: absolute; right: 10px; top: 10px; background: none; border: none; color: #ff6b6b; font-size: 20px; cursor: pointer; transition: color 0.2s; line-height: 1;">Ã—</button>
        <h3 style="color: var(--text-color); margin-bottom: 15px; text-align: center;">ELV3 Lookup</h3>
        
        <!-- ELV3 Lookup Fields -->
        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickNumInput" 
                   placeholder="Enter Elevator Part Number"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickLetterInput" 
                   placeholder="Enter Violating Condition"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickLetterResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickSecondaryNumInput" 
                   placeholder="Enter Suggested Remedy"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickSecondaryNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="quickClearInputs()" 
                    style="flex: 1; padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease;">
                Clear
            </button>
            <button onclick="toggleLogModal()" 
                    style="padding: 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: all 0.3s ease; min-width: 50px; display: flex; align-items: center; justify-content: center;" 
                    title="View Lookup Log">
                ðŸ“‹
            </button>
        </div>

        <!-- ELV3 Lookup Log Section -->
        <div id="inlineLogSection" style="display: none; margin: 10px 0; padding: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; max-height: 80vh; min-height: 100px; overflow-y: auto; resize: vertical;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: var(--text-color); font-size: 1.1em;">Recent Lookups</h4>
                <button onclick="clearLogEntries()" 
                        style="padding: 4px 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    Clear
                </button>
            </div>
            <div id="inlineLogEntries" style="color: var(--text-color);">
                <p style="text-align: center; color: #666; font-style: italic; font-size: 0.85em;">No log entries yet.</p>
            </div>
            <!-- Resize handle indicator -->
            <div class="resize-handle" style="text-align: center; margin-top: 10px; color: #999; font-size: 12px; cursor: ns-resize; user-select: none;">
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
            </div>
        </div>

        <!-- Add BIN display section -->
        <div id="quickBinDisplay" style="text-align: center; margin-top: 5px; padding: 8px; background: var(--panel-bg); border-radius: 4px; color: var(--text-color);">
            <strong>BIN:</strong> <span id="quickBinValue" 
                                      style="padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s ease; position: relative; display: inline-flex; align-items: center; gap: 6px;" 
                                      onclick="copyBinToClipboard(this.textContent.replace('ðŸ“‹', '').trim(), event)">-</span>
        </div>
        
        <!-- Device Number Search Dropdown -->
        <div style="margin-top: 10px;">
            <button onclick="toggleDeviceSearch()" 
                    style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: all 0.3s ease;"
                    title="Search Device Number">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <span>Device Search</span>
                <span id="deviceSearchArrow" style="margin-left: auto;">â–¼</span>
            </button>
            
            <div id="deviceSearchFields" style="display: none; margin-top: 5px; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                    <input type="text" 
                           id="quickDeviceInput" 
                           placeholder="Enter Device Number"
                           oninput="this.value = this.value.toUpperCase(); updateMainDeviceField(this.value); searchDeviceInLookup(this.value);"
                           style="flex: 1; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 14px; box-sizing: border-box; height: 40px;">
                    <button onclick="refreshDeviceLookup()"
                            style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                            title="Refresh Device Lookup">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                        </svg>
                    </button>
                    <button onclick="clearDeviceLookup()"
                            style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                            title="Clear Device Lookup">
                        âœ•
                    </button>
                </div>
                <div id="quickDeviceResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 12px; display: none;"></div>
            </div>
        </div>

        <!-- Filing Information Section -->
        <div class="quick-filing-info-container" style="margin: 15px 0;">
                    <button onclick="toggleQuickFilingInfo()" id="quickFilingInfoToggle" class="filing-info-toggle">
            <span>Filing Information</span>
            <span id="quickFilingInfoArrow" class="filing-info-arrow">â–¼</span>
        </button>
            
            <div id="quickFilingInfoFields" class="filing-info-fields" style="display: none;">
                <div class="field-group">
                    <label>Owner:</label>
                    <div class="field-controls">
                        <input type="text" id="quickOwnerInput" placeholder="Enter Owner Name">
                        <button onclick="copyToClipboard('quickOwnerInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickOwnerInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Elevator Company:</label>
                    <div class="field-controls">
                        <input type="text" id="quickElevatorCompanyInput" placeholder="Enter Elevator Company">
                        <button onclick="copyToClipboard('quickElevatorCompanyInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickElevatorCompanyInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>BIN #:</label>
                    <div class="field-controls">
                        <input type="text" id="quickBinInput" placeholder="Enter BIN Number">
                        <button onclick="copyToClipboard('quickBinInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickBinInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Groups:</label>
                    <div class="field-controls">
                        <input type="text" id="quickGroupsInput" placeholder="Enter Groups">
                        <button onclick="copyToClipboard('quickGroupsInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickGroupsInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Director/Co-Directors:</label>
                    <div class="field-controls">
                        <input type="text" id="quickDirectorsInput" placeholder="Enter Director/Co-Directors">
                        <button onclick="copyToClipboard('quickDirectorsInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickDirectorsInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Additional:</label>
                    <div class="field-controls">
                        <input type="text" id="quickAdditionalInput" placeholder="Enter Additional Information">
                        <button onclick="copyToClipboard('quickAdditionalInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickAdditionalInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <!-- Clear All Button -->
                <div class="clear-all-container">
                    <button onclick="clearAllQuickFilingInfo()" class="clear-all-btn">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Add Notes section as dropdown -->
        <div class="quick-notes-container" style="margin-top: 15px;">
                    <button onclick="toggleQuickNotes()" id="quickNotesToggle" class="notes-toggle">
            <span>Notes</span>
            <span id="quickNotesArrow" class="notes-arrow">â–¼</span>
        </button>
            
            <div id="quickNotesFields" class="notes-fields" style="display: none;">
                <textarea id="quickNotesInput" 
                          placeholder="Enter your notes here..."
                          class="notes-textarea-quick"></textarea>
                <button onclick="clearQuickNotes()" class="quick-lookup-clear-btn">
                    Clear Notes
                </button>
            </div>
        </div>

        <!-- ELV3 Reference section as dropdown inside Quick Lookup Panel -->
        <div class="quick-reference-container" style="margin-top: 15px;">
            <button onclick="toggleQuickReference()" id="quickReferenceToggle" class="filing-info-toggle">
                <span>ELV3 Reference</span>
                <span id="quickReferenceArrow" class="filing-info-arrow">â–¼</span>
            </button>
            <div id="quickReferenceFields" class="filing-info-fields" style="display: none;">
                <div id="quickReferenceContent" style="max-height: 60vh; overflow-y: auto; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; color: var(--text-color);"></div>
            </div>
        </div>
    </div>

    

    <div id="settingsModal" class="settings-modal">
        <h3>Settings</h3>
        <label for="defaultTab">Default Starting Tab:</label>
        <select id="defaultTab" style="width: 100%; padding: 8px; margin: 10px 0;">
            <option value="main">ELV3 Terminal</option>
            <option value="dob">DOB Terminal</option>
            <option value="dates">Dates Terminal</option>
            <option value="pdf">PDF Terminal</option>
            <!-- <option value="devices">Device Lookup Terminal</option> -->
        </select>
        <button onclick="saveSettings()">Save</button>
        <button onclick="closeSettings()" style="background-color: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Cancel</button>
    </div>

    <div id="settingsOverlay" class="reference-overlay"></div>



    <img src="https://github.com/mnmontesano/ELV3/blob/main/ELV3%20Cheat%20Sheet%20Icon.png?raw=true" alt="Logo" class="logo">
    <h1 id="pageTitle">ELV3 Terminal</h1>

    <!-- Button-based Tabs (default for larger screens) -->
    <div id="tabButtons" class="tab-buttons">
        <button onclick="showTab('main')" id="mainTab" class="tab-button">ELV3</button>
        <button onclick="showTab('dob')" id="dobTab" class="tab-button">DOB</button>
        <button onclick="showTab('dates')" id="datesTab" class="tab-button">DATES</button>
        <button onclick="showTab('pdf')" id="pdfTab" class="tab-button">PDF</button>
        <button onclick="showTab('devices')" id="devicesTab" class="tab-button" style="display: none;">DEVICES</button>
    </div>

    <!-- Dropdown-based Tabs (visible on small screens) -->
    <div id="tabDropdown" class="tab-dropdown" style="margin: 20px auto; text-align: center;">
        <select id="tabSelect" onchange="showTab(this.value)" style="font-size: 1.2em; padding: 5px; text-align: center; text-align-last: center;">
            <option value="main">ELV3</option>
            <option value="dob">DOB</option>
            <option value="dates">DATES</option>
            <option value="pdf">PDF</option>
            <!-- <option value="devices">DEVICES</option> -->
        </select>
    </div>

    <div id="mainContent" class="content-section active">
        <!-- Add ELV3 Lookup toggle button for Main tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        
        <div class="main-container">
            <div class="main-left">
                <div class="input-group">
                    <input type="text" id="numInput" placeholder="Enter Elevator Part Number">
                    <div id="numResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="letterInput" placeholder="Enter Violating Condition">
                    <div id="letterResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="secondaryNumInput" placeholder="Enter Suggested Remedy">
                    <div id="secondaryNumResult" class="result"></div>
                </div>

                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px auto; width: fit-content;">
                    <button onclick="clearInputs()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear</button>
                    <button onclick="toggleMainLogModal()" 
                            style="padding: 10px 20px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: all 0.3s ease; font-size: 1.2em; display: flex; align-items: center; justify-content: center;" 
                            title="View Lookup Log">
                        ðŸ“‹
                    </button>
                </div>
                
                <!-- Main Tab Log Section -->
                <div id="mainLogSection" style="display: none; margin: 10px 0; padding: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; max-height: 80vh; min-height: 100px; overflow-y: auto; resize: vertical;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: var(--text-color); font-size: 1.1em;">Recent Lookups</h4>
                        <button onclick="clearMainLogEntries()" 
                                style="padding: 4px 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                            Clear
                        </button>
                    </div>
                    <div id="mainLogEntries" style="color: var(--text-color);">
                        <p style="text-align: center; color: #666; font-style: italic; font-size: 0.85em;">No log entries yet.</p>
                    </div>
                    <!-- Resize handle indicator -->
                    <div class="resize-handle" style="text-align: center; margin-top: 10px; color: #999; font-size: 12px; cursor: ns-resize; user-select: none;">
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                    </div>
                </div>
                
                <!-- Filing Information Dropdown -->
                <div class="filing-info-container" style="margin: 30px auto; max-width: 500px;">
                            <button onclick="toggleFilingInfo()" id="filingInfoToggle" class="filing-info-toggle">
            <span>Filing Information</span>
            <span id="filingInfoArrow" class="filing-info-arrow">â–¼</span>
        </button>
                    
                    <div id="filingInfoFields" class="filing-info-fields" style="display: none;">
                        <div class="field-group">
                            <label>Owner:</label>
                            <div class="field-controls">
                                <input type="text" id="ownerInput" placeholder="Enter Owner Name">
                                <button onclick="copyToClipboard('ownerInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('ownerInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Elevator Company:</label>
                            <div class="field-controls">
                                <input type="text" id="elevatorCompanyInput" placeholder="Enter Elevator Company">
                                <button onclick="copyToClipboard('elevatorCompanyInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('elevatorCompanyInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>BIN #:</label>
                            <div class="field-controls">
                                <input type="text" id="binInput" placeholder="Enter BIN Number">
                                <button onclick="copyToClipboard('binInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('binInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Groups:</label>
                            <div class="field-controls">
                                <input type="text" id="groupsInput" placeholder="Enter Groups">
                                <button onclick="copyToClipboard('groupsInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('groupsInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Director/Co-Directors:</label>
                            <div class="field-controls">
                                <input type="text" id="directorsInput" placeholder="Enter Director/Co-Directors">
                                <button onclick="copyToClipboard('directorsInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('directorsInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Additional:</label>
                            <div class="field-controls">
                                <input type="text" id="additionalInput" placeholder="Enter Additional Information">
                                <button onclick="copyToClipboard('additionalInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('additionalInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Clear All Button -->
                        <div class="clear-all-container">
                            <button onclick="clearAllFilingInfo()" class="clear-all-btn">Clear All</button>
                        </div>
                    </div>
                </div>
                
                <button onclick="togglePdfViewer()" id="pdfToggleButton">Show PDF</button>

                <div class="image-viewer hidden" id="pdfViewer">
                    <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                        onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                        <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
                    </iframe>
                </div>

                <div class="notes-container">
                    <h3>Notes</h3>
                    <textarea id="Notes" class="notes-textarea" 
                        placeholder="Enter your notes here..."></textarea>
                    <button onclick="clearNotes()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear Notes</button>
                </div>
            </div>
        </div>

        <!-- Add this div right after your mainContent div opens -->
        <div class="reference-overlay" onclick="toggleReference()"></div>

        <!-- Modify your reference panel div to include the close button -->
        <div class="reference-panel">
            <button class="close-reference" onclick="toggleReference()" style="position: sticky; top: 0; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #ff6b6b; padding: 5px 10px; float: right; z-index: 2; margin-top: -5px;">Ã—</button>
            <h3>ELV3 Reference</h3>
            
            <p><strong>Part Numbers:</strong></p>
            <ul>
                <li style="font-weight: bold; color: #666;">Inside Car (01-15)</li>
                <li>01: Emergency Stop Switch</li>
                <li>02: Alarm System</li>
                <li>03: Car Enclosure</li>
                <li>04: Side Emergency Exit</li>
                <li>05: Car Door/Gate</li>
                <li>06: Car Door/Gate Contact</li>
                <li>07: Door Reopening Device</li>
                <li>08: Car Floor to Landing Still</li>
                <li>09: Car Floor</li>
                <li>10: Car Door Gibs</li>
                <li>11: Car Button Station</li>
                <li>12: Car Lighting</li>
                <li>13: Emergency Lighting</li>
                <li>14: Car Mirror</li>
                <li>15: Certificate Frame</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Outside Hoistway (16-25)</li>
                <li>16: Hoistway Doors</li>
                <li>17: Hoistway Door Gibs</li>
                <li>18: Hoistway Door Reinforcements</li>
                <li>19: Hoistway Door Safety Retainer</li>
                <li>20: Vision Panel</li>
                <li>21: Interlocks</li>
                <li>22: Parking Device</li>
                <li>23: Hall Button Station</li>
                <li>24: Indicators</li>
                <li>25: Door Safety Retainer</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Top of Car (26-39)</li>
                <li>26: Top Emergency Exit Cover</li>
                <li>27: Governor Release Carrier</li>
                <li>28: Door Hangers & Connectors</li>
                <li>29: Door Operator</li>
                <li>30: Normal Limits</li>
                <li>31: Final Limits</li>
                <li>32: Guide Shoes / Roller Guides</li>
                <li>33: Counterweight</li>
                <li>34: Hoistway</li>
                <li>35: Electrical Wiring</li>
                <li>36: Pipes and Ducts</li>
                <li>37: Overhead & Deflector Sheave</li>
                <li>38: Traveling Cable & Junction</li>
                <li>39: Car Top</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Machine Room (40-69)</li>
                <li>40: Machine Room</li>
                <li>41: Machine Room Door</li>
                <li>42: Controllerâ€”Selector</li>
                <li>43: Reverse Phase Relay</li>
                <li>44: Traction Sheave</li>
                <li>45: Governor</li>
                <li>46: Governor Switch</li>
                <li>47: Drum</li>
                <li>48: Pump Unit</li>
                <li>49: Drum Machine Limit SW</li>
                <li>50: Generator</li>
                <li>51: Slack Rope Switch</li>
                <li>52: Hoist Cables</li>
                <li>53: Governor Ropes</li>
                <li>54: Car Counterweight Rope</li>
                <li>55: Drum Counterweight Rope</li>
                <li>56: Hoist Machine</li>
                <li>57: Hoist Motor</li>
                <li>58: Worm / Gear / Bearings</li>
                <li>59: Machine Brake</li>
                <li>60: Lighting Machine Space</li>
                <li>61: Machine Disconnect SW</li>
                <li>62: Commutator</li>
                <li>63: Motor Brushes</li>
                <li>64: NYC Device #</li>
                <li>65: Unintended Car Movement</li>
                <li>66: Emergency Brake/Rope Gripper</li>
                <li>67: Communication</li>
                <li>68: Maintenance Log</li>
                <li>69: Code Data Plate</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Pit (70-82)</li>
                <li>70: Pit</li>
                <li>71: Pit Light</li>
                <li>72: Pit Stop Switch</li>
                <li>73: Car Guide-Rails & Brackets</li>
                <li>74: Cwt Guide-Rails & Brackets</li>
                <li>75: Buffers</li>
                <li>76: Car Safety & Tail Rope</li>
                <li>77: Underside Platform</li>
                <li>78: Tension Weight</li>
                <li>79: Comp / Chains / Ropes / Switch</li>
                <li>80: Counterweight Runby</li>
                <li>81: Counterweight Runby Signage</li>
                <li>82: Plunger Gripper</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Escalator/Moving Walk (83-96)</li>
                <li>83: Fire Shutters</li>
                <li>84: Skirt Switch</li>
                <li>85: Skirt Deflection Device</li>
                <li>86: Comb Plate / Comb Plate Teeth</li>
                <li>87: Landing Plate / Impact Switches</li>
                <li>88: Handrails / Handrail Safeties</li>
                <li>89: Step / Thread</li>
                <li>90: Key Switch</li>
                <li>91: Emergency Stop Button</li>
                <li>92: Decking and Ballistrades</li>
                <li>93: Ceiling Guards</li>
                <li>94: Deck Barricades</li>
                <li>95: Internal Safeties</li>
                <li>96: Safety Signage</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">All Types (97-100)</li>
                <li>97: Entire Device</li>
                <li>98: Current Five Year Tag</li>
                <li>99: Current One Year Tag</li>
                <li>100: Miscellaneous</li>
            </ul>

            <p><strong>Violations:</strong></p>
            <ul>
                <li>A: Altered</li>
                <li>B: Insufficient</li>
                <li>C: Padlocked</li>
                <li>D: Unsecured</li>
                <li>E: Rubbing</li>
                <li>F: Lost Motion</li>
                <li>G: Improper Fuses</li>
                <li>H: Worn</li>
                <li>I: Damaged</li>
                <li>J: Misaligned</li>
                <li>K: Rusted</li>
                <li>L: Defective</li>
                <li>M: Missing</li>
                <li>N: By-Passed</li>
                <li>O: Dirty</li>
                <li>P: No Means Of Access</li>
                <li>Q: Unguarded</li>
                <li>R: Illegal</li>
                <li>S: Not Fire Retardant</li>
                <li>T: Unlabeled</li>
                <li>U: Device Not Tagged</li>
                <li>V: Not Level</li>
                <li>W: Unlocked</li>
                <li>X: Inoperative</li>
                <li>Y: Oil Leak</li>
                <li>Z: Water Leak</li>
                <li>AA: Carbon Buildup</li>
                <li>BB: Expired Tag</li>
            </ul>

            <p><strong>Remedies:</strong></p>
            <ul>
                <li>01: Adjust</li>
                <li>02: Clean</li>
                <li>03: Install Guards</li>
                <li>04: Patch</li>
                <li>05: Perform & File Test</li>
                <li>06: Properly Secure</li>
                <li>07: Provide</li>
                <li>08: Regroove</li>
                <li>09: Remove</li>
                <li>10: Repair</li>
                <li>11: Replace</li>
                <li>12: Reshackle</li>
                <li>13: Seal</li>
                <li>14: Shorten</li>
                <li>15: Tag Device</li>
                <li>16: Provide Means of Access</li>
                <li>17: Re-inspection Required</li>
            </ul>
        </div>
    </div>

    <div id="dobContent" class="content-section">
        <!-- The quickLookupPanel has been moved outside the tab for access from any tab -->
        
        <!-- Add ELV3 Lookup toggle button -->
        <button id="dobLookupToggleBtn" onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>

        

        <!-- Replace the Device & BIN Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Device & BIN Lookup</h3>
            
            <!-- Add this right after the <h3>Device & BIN Lookup</h3> line, around line 986 -->
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Elevator Device API</span>
                <br>
                <span>Last Updated: <span id="apiLastUpdated">March 15, 2024</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Elevator-Device-Information/e5aq-a4j2" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
            </div>

            <!-- Device Number Search -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by Device Number:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="deviceNumber" 
                           placeholder="Enter Device Number"
                           oninput="if(this.value !== '') { this.value = this.value.toUpperCase(); }"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupBIN()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Search Device</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                âœ•
                            </button>
                        </div>
                    </div>
                </div>
                <div id="binResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- Address Search -->
            <div id="addressSearchSection" style="margin-bottom: 25px; margin-top: 20px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by Address:</h4>
                <div style="padding: 0 5px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" 
                               id="houseNumber" 
                               placeholder="House Number"
                               style="width: calc(40% - 5px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color);">
                        <input type="text" 
                               id="streetName" 
                               placeholder="Street Name"
                               oninput="this.value = this.value.toUpperCase()"
                               style="width: calc(60% - 5px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color);">
                    </div>
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupByAddress()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Search Address</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearAddressSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease, color 0.3s ease;">
                                âœ•
                            </button>
                        </div>
                    </div>
                </div>
                <div id="addressResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- BIN Search -->
            <div style="margin-top: 20px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by BIN:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="binNumber" 
                           placeholder="Enter BIN Number"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupDevices()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Find Devices</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                âœ•
                            </button>
                        </div>
                    </div>
                </div>
                <div id="deviceResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Device results will be displayed here -->
                </div>
            </div>

            <!-- Move export button here, before Clear All -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="binExportButton" 
                        onclick="exportBinToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <!-- Add Clear Button -->
            <button onclick="clearLookups()" 
                    style="display: block; margin: 25px auto 5px; padding: 12px 30px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                Clear All
            </button>
        </div>

        <!-- Replace the Bulk Device Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Bulk Device Lookup</h3>
            
            <div style="margin-bottom: 15px; padding: 0 5px;">
                <textarea id="bulkDeviceNumbers" 
                         placeholder="Enter multiple device numbers (one per line)"
                         oninput="this.value = this.value.toUpperCase()"
                         style="width: calc(100% - 10px); height: 100px; padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); resize: vertical;"></textarea>
            </div>

            <!-- Modified buttons div to stack vertically -->
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <button onclick="lookupBulkDevices()" 
                        style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Look up All Devices
                </button>
                <button onclick="clearBulkLookup()" 
                        style="padding: 12px 20px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Clear
                </button>
                <button id="exportButton" 
                        onclick="exportToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <div id="bulkResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                <!-- Results will be displayed here -->
            </div>
        </div>


        
        <!-- Add the violations API data source section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Violations API Information</h3>
            
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Safety Violations API</span>
                <br>
                <span>Last Updated: <span id="violationsApiLastUpdated">Loading...</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Safety-Violations/855j-jady" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
                <div id="violationsDaysSinceUpdate" style="text-align: center; font-size: 0.9em; color: #4CAF50; opacity: 0.8; margin-top: 5px;">
                    Checking...
                </div>
                <script>
                    // Fetch actual last updated date from NYC Open Data API
                    (function() {
                        const datasetId = '855j-jady'; // DOB Safety Violations dataset ID
                        const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                        
                        fetch(metadataUrl)
                            .then(response => response.json())
                            .then(data => {
                                // Extract the last updated date from the metadata
                                const updateDateStr = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                }) : 'Unknown';
                                
                                // Update the displayed date
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement) {
                                    lastUpdatedElement.textContent = updateDateStr;
                                }
                                
                                // Calculate days since update
                                // Normalize both dates to midnight to compare calendar days, not hours
                                const today = new Date();
                                const updateDate = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000) : today;
                                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                                const timeDiff = todayMidnight - updateDateMidnight;
                                const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement) {
                                    // Display appropriate message based on days
                                    if (daysSinceUpdate <= 0) {
                                        daysSinceElement.textContent = "Updated today";
                                        daysSinceElement.style.color = "#4CAF50"; // Green for today
                                    } else if (daysSinceUpdate === 1) {
                                        daysSinceElement.textContent = "Updated 1 day ago";
                                        daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                                    } else if (daysSinceUpdate < 14) {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                                    } else if (daysSinceUpdate < 30) {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                                    } else {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching dataset metadata:', error);
                                // Fallback to a default behavior on error
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement && lastUpdatedElement.textContent === 'Loading...') {
                                    lastUpdatedElement.textContent = 'Unable to fetch update date';
                                }
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement && daysSinceElement.textContent === 'Checking...') {
                                    daysSinceElement.textContent = 'Update status unavailable';
                                    daysSinceElement.style.color = "#FFA500";
                                }
                            });
                    })();
                </script>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: var(--text-color);">
                    This website uses the NYC Department of Buildings Safety Violations API to provide up-to-date information about elevator violations.
                </p>
                <p style="color: var(--text-color);">
                    The API provides information about violations issued for elevator devices, including violation numbers, issue dates, statuses, types, and remarks.
                </p>
            </div>
        </div>
    </div>

    <div id="datesContent" class="content-section">
        <!-- Add ELV3 Lookup toggle button for Dates tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        
        <div class="input-group">
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput">
        </div>
        
        <!-- Adding back the buttons -->
        <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center;">
            <button id="days10" onclick="calculateDateWithMode(10)" style="display: inline-block; margin: 0;">10 Days</button>
            <button id="days30" onclick="calculateDateWithMode(30)" style="display: inline-block; margin: 0;">30 Days</button>
            <button id="days60" onclick="calculateDateWithMode(60)" style="display: inline-block; margin: 0;">60 Days</button>
            <button id="days91" onclick="calculateDateWithMode(91)" style="display: inline-block; margin: 0;">91 Days</button>
        </div>
        
        <!-- Adding back the dropdown for small screens -->
        <div class="date-dropdown-group" style="display: none; text-align: center; margin: 10px auto;">
            <select id="daysSelect" onchange="calculateDateWithMode(parseInt(this.value))" style="padding: 8px; width: 200px; margin-bottom: 10px;">
                <option value="">Select Days</option>
                <option value="10">10 Days</option>
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="91">91 Days</option>
            </select>
            <select id="modeSelect" onchange="toggleDateModeFromDropdown(this.value)" style="padding: 8px; width: 200px;">
                <option value="positive">Add Days</option>
                <option value="negative">Subtract Days</option>
            </select>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <!-- Mode toggle buttons above custom days input -->
            <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center; margin-bottom: 15px;">
                <button id="negativeToggle" onclick="toggleDateMode('negative')" style="display: inline-block; margin: 0; background-color: #f0f0f0; color: #666; border: 1px solid #ccc; padding: 8px 16px;">Prior</button>
                <button id="positiveToggle" onclick="toggleDateMode('positive')" style="display: inline-block; margin: 0; background-color: #000; color: #fff; border: 1px solid #000; padding: 8px 16px;">Future</button>
            </div>
            <input type="number" id="customDays" placeholder="Enter number of days" style="width: 200px;">
            <button onclick="calculateCustomDate()" style="display: inline-block; margin: 10px;">Calculate Custom Days</button>
        </div>
        <div id="dateResult" class="result" style="width:80%;"></div>
        <div id="dateSpelledResult" class="result" style="width:80%;"></div>

        <!-- Modify the 90-day start date div -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                91 Days Past
                <span style="cursor: pointer; color: #4a9eff; display: inline-flex; align-items: center;" 
                      onclick="toggleExplanation(event)"
                      data-explanation="Any device tested on or before below date has past the required 91 days and the next test can be completed">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </span>
            </div>
            <div id="explanationText" style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--text-color); max-width: 400px; margin-left: auto; margin-right: auto;"></div>
            <div id="ninetyDayStart" style="margin: 10px 0;"></div>
        </div>

        <!-- 10 Days After section -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                10 Days After
                <span style="cursor: pointer; color: #4a9eff; display: inline-flex; align-items: center;" 
                      onclick="toggleExplanation(event)"
                      data-explanation="This date is 10 days after the current date">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </span>
            </div>
            <div id="explanationText10Days" style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--text-color); max-width: 400px; margin-left: auto; margin-right: auto;"></div>
            <div id="tenDaysAfter" style="margin: 10px 0;"></div>
        </div>

        <script>
                    function toggleExplanation(event) {
            // Find the parent container and then the explanation div within it
            const parentContainer = event.currentTarget.closest('div[style*="text-align: center"]');
            const explanationDiv = parentContainer ? parentContainer.querySelector('div[id^="explanationText"]') : document.getElementById('explanationText');
            const explanation = event.currentTarget.getAttribute('data-explanation');
            
            if (explanationDiv && explanationDiv.style.display === 'none') {
                explanationDiv.textContent = explanation;
                explanationDiv.style.display = 'block';
                
                // Position the explanation
                const rect = event.currentTarget.getBoundingClientRect();
                explanationDiv.style.position = 'relative';
                explanationDiv.style.zIndex = '1000';
                
                // Add animation
                explanationDiv.style.opacity = '0';
                explanationDiv.style.transform = 'translateY(-10px)';
                explanationDiv.style.transition = 'all 0.3s ease';
                
                // Trigger animation
                setTimeout(() => {
                    explanationDiv.style.opacity = '1';
                    explanationDiv.style.transform = 'translateY(0)';
                }, 10);
            } else if (explanationDiv) {
                // Add fade-out animation
                explanationDiv.style.opacity = '0';
                explanationDiv.style.transform = 'translateY(-10px)';
                
                // Hide after animation
                setTimeout(() => {
                    explanationDiv.style.display = 'none';
                }, 300);
            }
            
            // Stop event propagation
            event.stopPropagation();
        }

        // Function to toggle Important dropdown
        function toggleImportantDropdown(deviceNumber) {
            const dropdown = document.getElementById('important_' + deviceNumber);
            const arrow = document.querySelector(`[onclick="toggleImportantDropdown('${deviceNumber}')"] .arrow`);
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }
            
            // Close explanation when clicking anywhere else on the page
            document.addEventListener('click', function(event) {
                const explanationDiv = document.getElementById('explanationText');
                if (explanationDiv.style.display === 'block' && !event.target.closest('[onclick="toggleExplanation(event)"]')) {
                    explanationDiv.style.opacity = '0';
                    explanationDiv.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        explanationDiv.style.display = 'none';
                    }, 300);
                }
            });
        </script>

        <button onclick="clearDateInput()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear</button>
    </div>

    <div id="pdfContent" class="content-section">
        <!-- Add ELV3 Lookup toggle button for PDF tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        <div class="pdf-viewer" style="width: 100%; height: 80vh;">
            <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
            </iframe>
        </div>
    </div>

    <div id="devicesContent" class="content-section" style="display: none;">
        <div style="width: 100%; height: calc(100vh - 100px); border: none;">
            <iframe src="device_search.html" 
                    style="width: 100%; height: 100%; border: none; background: #1c1c1c;"
                    title="Device Search">
            </iframe>
        </div>
    </div>

    <script>
        function numberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "00": "Invalid number",
                "01": "Emergency Stop Switch",
                "1": "Emergency Stop Switch",
                "emergency stop switch": "01",
                "02": "Alarm System",
                "2": "Alarm System",
                "alarm system": "02",
                "03": "Car Enclosure",
                "3": "Car Enclosure",
                "car enclosure": "03",
                "04": "Side Emergency Exit",
                "4": "Side Emergency Exit",
                "side emergency exit": "04",
                "05": "Car Door/Gate",
                "5": "Car Door/Gate",
                "car door/gate": "05",
                "06": "Car Door/Gate Contact",
                "6": "Car Door/Gate Contact",
                "car door/gate contact": "06",
                "07": "Door Reopening Device",
                "7": "Door Reopening Device",
                "door reopening device": "07",
                "08": "Car Floor to Landing Still",
                "8": "Car Floor to Landing Still",
                "car floor to landing still": "08",
                "09": "Car Floor",
                "9": "Car Floor",
                "car floor": "09",
                "10": "Car Door Gibs",
                "car door gibs": "10",
                "11": "Car Button Station",
                "car button station": "11",
                "12": "Car Lighting",
                "car lighting": "12",
                "13": "Emergency Lighting",
                "emergency lighting": "13",
                "14": "Car Mirror",
                "car mirror": "14",
                "15": "Certificate Frame",
                "certificate frame": "15",
                "16": "Hoistway Doors",
                "hoistway doors": "16",
                "17": "Hoistway Door Gibs",
                "hoistway door gibs": "17",
                "18": "Hoistway Door Reinforcements",
                "hoistway door reinforcements": "18",
                "19": "Hoistway Door Safety Retainer",
                "hoistway door safety retainer": "19",
                "20": "Vision Panel",
                "vision panel": "20",
                "21": "Interlocks",
                "interlocks": "21",
                "22": "Parking Device",
                "parking device": "22",
                "23": "Hall Button Station",
                "hall button station": "23",
                "24": "Indicators",
                "indicators": "24",
                "25": "Door Safety Retainer",
                "door safety retainer": "25",
                "26": "Top Emergency Exit Cover",
                "top emergency exit cover": "26",
                "27": "Governor Release Carrier",
                "governor release carrier": "27",
                "28": "Door Hangers & Connectors",
                "door hangers & connectors": "28",
                "29": "Door Operator",
                "door operator": "29",
                "30": "Normal Limits",
                "normal limits": "30",
                "31": "Final Limits",
                "final limits": "31",
                "32": "Guide Shoes / Roller Guides",
                "guide shoes / roller guides": "32",
                "33": "Counterweight",
                "counterweight": "33",
                "34": "Hoistway",
                "hoistway": "34",
                "35": "Electrical Wiring",
                "electrical wiring": "35",
                "36": "Pipes and Ducts",
                "pipes and ducts": "36",
                "37": "Overhead & Deflector Sheave",
                "overhead & deflector sheave": "37",
                "38": "Traveling Cable & Junction",
                "traveling cable & junction": "38",
                "39": "Car Top",
                "car top": "39",
                "40": "Machine Room",
                "machine room": "40",
                "41": "Machine Room Door",
                "machine room door": "41",
                "42": "Controllerâ€”Selector",
                "controllerâ€”selector": "42",
                "43": "Reverse Phase Relay",
                "reverse phase relay": "43",
                "44": "Traction Sheave",
                "traction sheave": "44",
                "45": "Governor",
                "governor": "45",
                "46": "Governor Switch",
                "governor switch": "46",
                "47": "Drum",
                "drum": "47",
                "48": "Pump Unit",
                "pump unit": "48",
                "49": "Drum Machine Limit SW",
                "drum machine limit sw": "49",
                "50": "Generator",
                "generator": "50",
                "51": "Slack Rope Switch",
                "slack rope switch": "51",
                "52": "Hoist Cables",
                "hoist cables": "52",
                "53": "Governor Ropes",
                "governor ropes": "53",
                "54": "Car Counterweight Rope",
                "car counterweight rope": "54",
                "55": "Drum Counterweight Rope",
                "drum counterweight rope": "55",
                "56": "Hoist Machine",
                "hoist machine": "56",
                "57": "Hoist Motor",
                "hoist motor": "57",
                "58": "Worm / Gear / Bearings",
                "worm / gear / bearings": "58",
                "59": "Machine Brake",
                "machine brake": "59",
                "60": "Lighting Machine Space",
                "lighting machine space": "60",
                "61": "Machine Disconnect SW",
                "machine disconnect sw": "61",
                "62": "Commutator",
                "commutator": "62",
                "63": "Motor Brushes",
                "motor brushes": "63",
                "64": "NYC Device #",
                "nyc device #": "64",
                "65": "Unintended Car Movement",
                "unintended car movement": "65",
                "66": "Emergency Brake/Rope Gripper",
                "emergency brake/rope gripper": "66",
                "67": "Communication",
                "communication": "67",
                "68": "Maintenance Log",
                "maintenance log": "68",
                "69": "Code Data Plate",
                "code data plate": "69",
                "70": "Pit",
                "pit": "70",
                "71": "Pit Light",
                "pit light": "71",
                "72": "Pit Stop Switch",
                "pit stop switch": "72",
                "73": "Car Guide-Rails & Brackets",
                "car guide-rails & brackets": "73",
                "74": "Cwt Guide-Rails & Brackets",
                "cwt guide-rails & brackets": "74",
                "75": "Buffers",
                "buffers": "75",
                "76": "Car Safety & Tail Rope",
                "car safety & tail rope": "76",
                "77": "Underside Platform",
                "underside platform": "77",
                "78": "Tension Weight",
                "tension weight": "78",
                "79": "Comp / Chains / Ropes / Switch",
                "comp / chains / ropes / switch": "79",
                "80": "Counterweight Runby",
                "counterweight runby": "80",
                "81": "Counterweight Runby Signage",
                "counterweight runby signage": "81",
                "82": "Plunger Gripper",
                "plunger gripper": "82",
                "83": "Fire Shutters",
                "fire shutters": "83",
                "84": "Skirt Switch",
                "skirt switch": "84",
                "85": "Skirt Deflection Device",
                "skirt deflection device": "85",
                "86": "Comb Plate / Comb Plate Teeth",
                "comb plate / comb plate teeth": "86",
                "87": "Landing Plate / Impact Switches",
                "landing plate / impact switches": "87",
                "88": "Handrails / Handrail Safeties",
                "handrails / handrail safeties": "88",
                "89": "Step / Thread",
                "step / thread": "89",
                "90": "Key Switch",
                "key switch": "90",
                "91": "Emergency Stop Button",
                "emergency stop button": "91",
                "92": "Decking and Ballistrades",
                "decking and ballistrades": "92",
                "93": "Ceiling Guards",
                "ceiling guards": "93",
                "94": "Deck Barricades",
                "deck barricades": "94",
                "95": "Internal Safeties",
                "internal safeties": "95",
                "96": "Safety Signage",
                "safety signage": "96",
                "97": "Entire Device",
                "entire device": "97",
                "98": "Current Five Year Tag",
                "current five year tag": "98",
                "99": "Current One Year Tag",
                "current one year tag": "99",
                "100": "Miscellaneous",
                "miscellaneous": "100"
            };
            let result = mapping[input] || "Invalid Number";
            
            // Only add location information if the result is a description (not a code)
            if (result !== "Invalid Number" && result !== "Enter Number" && !result.match(/^\d+$/)) {
                var intValue = parseInt(input);
                if (intValue >= 1 && intValue <= 15) {
                    result += " (Inside Car)";
                }
                
                if (intValue >= 16 && intValue <= 25) {
                    result += " (Outside Hoistway)";
                }
                
                if (intValue >= 26 && intValue <= 39) {
                    result += " (Top of Car)";
                }
                
                if (intValue >= 40 && intValue <= 69) {
                    result += " (Machine Room)";
                }
                
                if (intValue >= 70 && intValue <= 82) {
                    result += " (Pit)";
                }
                
                if (intValue >= 83 && intValue <= 96) {
                    result += " (Escalator/Moving Walk)";
                }
                
                if (intValue >= 97 && intValue <= 100) {
                    result += " (All Types)";
                }
            }
            
            return result;
        }

        function letterToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Letter",
                "a": "Altered",
                "altered": "A",
                "b": "Insufficient",
                "insufficient": "B",
                "c": "Padlocked",
                "padlocked": "C",
                "d": "Unsecured",
                "unsecured": "D",
                "e": "Rubbing",
                "rubbing": "E",
                "f": "Lost Motion",
                "lost motion": "F",
                "g": "Improper Fuses",
                "improper fuses": "G",
                "h": "Worn",
                "worn": "H",
                "i": "Damaged",
                "damaged": "I",
                "j": "Misaligned",
                "misaligned": "J",
                "k": "Rusted",
                "rusted": "K",
                "l": "Defective",
                "defective": "L",
                "m": "Missing",
                "missing": "M",
                "n": "By-Passed",
                "by-passed": "N",
                "o": "Dirty",
                "dirty": "O",
                "p": "No Means Of Access",
                "no means of access": "P",
                "q": "Unguarded",
                "unguarded": "Q",
                "r": "Illegal",
                "illegal": "R",
                "s": "Not Fire Retardant",
                "not fire retardant": "S",
                "t": "Unlabeled",
                "unlabeled": "T",
                "u": "Device Not Tagged",
                "device not tagged": "U",
                "v": "Not Level",
                "not level": "V",
                "w": "Unlocked",
                "unlocked": "W",
                "x": "Inoperative",
                "inoperative": "X",
                "y": "Oil Leak",
                "oil leak": "Y",
                "z": "Water Leak",
                "water leak": "Z",
                "aa": "Carbon Buildup",
                "carbon buildup": "AA",
                "bb": "Expired Tag",
                "expired tag": "BB"
            };
            
            return mapping[input] || "Invalid Letter";
        }

        function secondaryNumberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "01": "Adjust",
                "1": "Adjust", 
                "adjust": "01",
                "02": "Clean",
                "2": "Clean",
                "clean": "02", 
                "03": "Install Guards",
                "3": "Install Guards",
                "install guards": "03",
                "04": "Patch",
                "4": "Patch",
                "patch": "04",
                "05": "Perform & File Test",
                "5": "Perform & File Test", 
                "perform & file test": "05",
                "06": "Properly Secure",
                "6": "Properly Secure",
                "properly secure": "06",
                "07": "Provide",
                "7": "Provide",
                "provide": "07",
                "08": "Regroove", 
                "8": "Regroove",
                "regroove": "08",
                "09": "Remove",
                "9": "Remove",
                "remove": "09",
                "10": "Repair",
                "repair": "10",
                "11": "Replace",
                "replace": "11",
                "12": "Reshackle",
                "reshackle": "12",
                "13": "Seal",
                "seal": "13",
                "14": "Shorten",
                "shorten": "14",
                "15": "Tag Device",
                "tag device": "15",
                "16": "Provide Means of Access",
                "provide means of access": "16",
                "17": "Re-inspection Required",
                "re-inspection required": "17"
            };
            
            return mapping[input] || "Invalid Number";
        }

        const numInput = document.getElementById('numInput');
        if (numInput) {
            numInput.addEventListener('input', function(e) {
                let result = numberToWord(e.target.value);
                const numResult = document.getElementById('numResult');
                if (numResult) numResult.textContent = result;
            });
        }

        const letterInput = document.getElementById('letterInput');
        if (letterInput) {
            letterInput.addEventListener('input', function(e) {
                let result = letterToWord(e.target.value);
                const letterResult = document.getElementById('letterResult');
                if (letterResult) letterResult.textContent = result;
            });
        }

        const secondaryNumInput = document.getElementById('secondaryNumInput');
        if (secondaryNumInput) {
            secondaryNumInput.addEventListener('input', function(e) {
                let result = secondaryNumberToWord(e.target.value);
                const secondaryNumResult = document.getElementById('secondaryNumResult');
                if (secondaryNumResult) secondaryNumResult.textContent = result;
            });
        }

        function clearInputs() {
            // Capture current values before clearing
            const numInput = document.getElementById('numInput');
            const letterInput = document.getElementById('letterInput');
            const secondaryNumInput = document.getElementById('secondaryNumInput');
            const numResult = document.getElementById('numResult');
            const letterResult = document.getElementById('letterResult');
            const secondaryNumResult = document.getElementById('secondaryNumResult');
            
            const numValue = numInput ? numInput.value : '';
            const letterValue = letterInput ? letterInput.value : '';
            const secondaryNumValue = secondaryNumInput ? secondaryNumInput.value : '';
            const numResultText = numResult ? numResult.textContent : '';
            const letterResultText = letterResult ? letterResult.textContent : '';
            const secondaryNumResultText = secondaryNumResult ? secondaryNumResult.textContent : '';
            
            // Save to history before clearing
            saveToMainLogWithResults(numValue, letterValue, secondaryNumValue, numResultText, letterResultText, secondaryNumResultText);
            
            // Clear the inputs and results
            if (numInput) numInput.value = '';
            if (letterInput) letterInput.value = '';
            if (secondaryNumInput) secondaryNumInput.value = '';
            if (numResult) numResult.textContent = '';
            if (letterResult) letterResult.textContent = '';
            if (secondaryNumResult) secondaryNumResult.textContent = '';
            
            // Clear additional fields
            const ownerInput = document.getElementById('ownerInput');
            const elevatorCompanyInput = document.getElementById('elevatorCompanyInput');
            const binInput = document.getElementById('binInput');
            const groupsInput = document.getElementById('groupsInput');
            const directorsInput = document.getElementById('directorsInput');
            const additionalInput = document.getElementById('additionalInput');
            
            if (ownerInput) ownerInput.value = '';
            if (elevatorCompanyInput) elevatorCompanyInput.value = '';
            if (binInput) binInput.value = '';
            if (groupsInput) groupsInput.value = '';
            if (directorsInput) directorsInput.value = '';
            if (additionalInput) additionalInput.value = '';
            
            if (numInput) numInput.focus();
        }

        // Function to copy text from a specific input field to clipboard
        function copyToClipboard(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement && inputElement.value.trim() !== '') {
                navigator.clipboard.writeText(inputElement.value).then(function() {
                    // Visual feedback - briefly change button text and style
                    const copyButton = event.target;
                    const originalText = copyButton.innerHTML;
                    const originalBg = copyButton.style.background;
                    copyButton.innerHTML = 'Copied!';
                    copyButton.style.background = '#28a745';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                        copyButton.style.background = originalBg;
                    }, 1200);
                }).catch(function(err) {
                    console.error('Failed to copy text: ', err);
                });
            }
        }

        // Function to clear a specific input field
        function clearField(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.value = '';
                inputElement.focus();
                
                // Clear from localStorage as well
                localStorage.removeItem(inputId + 'Info');
                
                // Visual feedback - briefly change button style
                const clearButton = event.target;
                const originalBg = clearButton.style.background;
                clearButton.style.background = '#dc3545';
                setTimeout(() => {
                    clearButton.style.background = originalBg;
                }, 1200);
            }
        }

        // Function to toggle Filing Information dropdown
        function toggleFilingInfo() {
            const fieldsContainer = document.getElementById('filingInfoFields');
            const arrow = document.getElementById('filingInfoArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to clear all Filing Information fields
        function clearAllFilingInfo() {
            const fields = ['ownerInput', 'elevatorCompanyInput', 'binInput', 'groupsInput', 'directorsInput', 'additionalInput'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Clear from localStorage
                    localStorage.removeItem(fieldId + 'Info');
                }
            });
            
            // Focus on the first field
            document.getElementById('ownerInput').focus();
        }

        // Function to toggle Quick Filing Information dropdown
        function toggleQuickFilingInfo() {
            const fieldsContainer = document.getElementById('quickFilingInfoFields');
            const arrow = document.getElementById('quickFilingInfoArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to clear all Quick Filing Information fields
        function clearAllQuickFilingInfo() {
            const fields = ['quickOwnerInput', 'quickElevatorCompanyInput', 'quickBinInput', 'quickGroupsInput', 'quickDirectorsInput', 'quickAdditionalInput'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Clear from localStorage
                    localStorage.removeItem(fieldId + 'Info');
                }
            });
            
            // Focus on the first field
            const firstField = document.getElementById('quickOwnerInput');
            if (firstField) {
                firstField.focus();
            }
        }

        // Function to toggle Quick Notes dropdown
        function toggleQuickNotes() {
            const fieldsContainer = document.getElementById('quickNotesFields');
            const arrow = document.getElementById('quickNotesArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle Quick ELV3 Reference dropdown
        function toggleQuickReference() {
            const fieldsContainer = document.getElementById('quickReferenceFields');
            const arrow = document.getElementById('quickReferenceArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Populate Quick ELV3 Reference content from the main reference panel
        document.addEventListener('DOMContentLoaded', function() {
            const quickRefContent = document.getElementById('quickReferenceContent');
            const sourcePanel = document.querySelector('.reference-panel');
            if (quickRefContent && sourcePanel && quickRefContent.childElementCount === 0) {
                const fragment = document.createDocumentFragment();
                Array.from(sourcePanel.children).forEach((child) => {
                    // Skip close button and title
                    if (child.classList && child.classList.contains('close-reference')) return;
                    if (child.tagName === 'H3') return;
                    fragment.appendChild(child.cloneNode(true));
                });
                quickRefContent.appendChild(fragment);
            }
        });

        // Function to clear Notes field
        function clearNotes() {
            const notesField = document.getElementById('Notes');
            if (notesField) {
                notesField.value = '';
                // Clear from localStorage
                localStorage.removeItem('elevatorNotes');
                notesField.focus();
            }
        }

        function togglePdfViewer() {
            const viewer = document.getElementById('pdfViewer');
            const button = document.getElementById('pdfToggleButton');
            viewer.classList.toggle('hidden');
            button.textContent = viewer.classList.contains('hidden') ? 'Show PDF' : 'Hide PDF';
        }
        function showTab(tabName) {
            const panel = document.getElementById('quickLookupPanel');
            const dobContent = document.getElementById('dobContent');
            const wasDOBActive = dobContent && dobContent.classList.contains('active');
            const panelIsOpen = panel && panel.style.display === 'block';
            
            // If switching away from DOB tab, remove shift classes
            if (wasDOBActive && tabName !== 'dob') {
                document.body.classList.remove('dob-shifted-for-lookup');
                if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                if (dobContent) {
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                }
            }
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const contentElement = document.getElementById(tabName + 'Content');
            if (contentElement) {
                contentElement.classList.add('active');
            }
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.backgroundColor = '';
            });
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.backgroundColor = '#333';
            }
            updatePageTitle(tabName);
            
            // After switching to the DOB tab, fetch the update date
            if (tabName === 'dob') {
                fetchAPILastUpdateDate();
                fetchViolationsAPILastUpdateDate();
                
                // Don't apply shift classes when switching to DOB tab - panel will overlay instead
            }

            // Tag body with active tab for CSS-driven layout tweaks
            document.body.setAttribute('data-active-tab', tabName);
        }

        function updatePageTitle(tabName) {
            const titleMapping = {
                main: 'ELV3 Terminal',
                dob: 'DOB Terminal',
                dates: 'DATES Terminal',
                pdf: 'PDF Terminal',
                devices: 'Device Lookup Terminal'
            };
            // Keep document title static as "Vertical Terminal"
            document.title = "Vertical Terminal";
            // Still update the visible page title element
            const pageTitleElement = document.getElementById('pageTitle');
            if (pageTitleElement) {
                pageTitleElement.textContent = titleMapping[tabName] || titleMapping.main;
            }
        }

        function submitFeedback() {
            window.location.href = "mailto:michaelnmontesano@gmail.com?subject=Vertical Terminal Feedback";
        }

        // Add this function to initialize all event listeners
        function initializeQuickLookup() {
            // Quick Lookup panel event listeners
            const quickNumInput = document.getElementById('quickNumInput');
            const quickLetterInput = document.getElementById('quickLetterInput');
            const quickSecondaryNumInput = document.getElementById('quickSecondaryNumInput');

            if (quickNumInput) {
                quickNumInput.addEventListener('input', function(e) {
                    let result = numberToWord(e.target.value);
                    document.getElementById('quickNumResult').textContent = result;
                });
            }

            if (quickLetterInput) {
                quickLetterInput.addEventListener('input', function(e) {
                    let result = letterToWord(e.target.value);
                    document.getElementById('quickLetterResult').textContent = result;
                });
            }

            if (quickSecondaryNumInput) {
                quickSecondaryNumInput.addEventListener('input', function(e) {
                    let result = secondaryNumberToWord(e.target.value);
                    document.getElementById('quickSecondaryNumResult').textContent = result;
                });
            }
        }

        // Add this to your existing window.onload function
        window.onload = function() {
            const savedNotes = localStorage.getItem('elevatorNotes');
            if (savedNotes) {
                document.getElementById('Notes').value = savedNotes;
            }
            
            // Load all saved Filing Information fields
            const filingFields = [
                { id: 'ownerInput', key: 'ownerInputInfo' },
                { id: 'elevatorCompanyInput', key: 'elevatorCompanyInputInfo' },
                { id: 'binInput', key: 'binInputInfo' },
                { id: 'groupsInput', key: 'groupsInputInfo' },
                { id: 'directorsInput', key: 'directorsInputInfo' },
                { id: 'additionalInput', key: 'additionalInputInfo' }
            ];
            
            filingFields.forEach(field => {
                const savedValue = localStorage.getItem(field.key);
                if (savedValue) {
                    document.getElementById(field.id).value = savedValue;
                }
            });

            // Load all saved Quick Filing Information fields
            const quickFilingFields = [
                { id: 'quickOwnerInput', key: 'quickOwnerInputInfo' },
                { id: 'quickElevatorCompanyInput', key: 'quickElevatorCompanyInputInfo' },
                { id: 'quickBinInput', key: 'quickBinInputInfo' },
                { id: 'quickGroupsInput', key: 'quickGroupsInputInfo' },
                { id: 'quickDirectorsInput', key: 'quickDirectorsInputInfo' },
                { id: 'quickAdditionalInput', key: 'quickAdditionalInputInfo' }
            ];
            
            quickFilingFields.forEach(field => {
                const savedValue = localStorage.getItem(field.key);
                if (savedValue) {
                    const element = document.getElementById(field.id);
                    if (element) {
                        element.value = savedValue;
                    }
                }
            });

            // Load saved Quick Notes content
            const savedQuickNotes = localStorage.getItem('quickNotesContent');
            if (savedQuickNotes) {
                const quickNotesElement = document.getElementById('quickNotesInput');
                if (quickNotesElement) {
                    quickNotesElement.value = savedQuickNotes;
                }
            }
            
            calculateNinetyDayStart();
            calculateTenDaysAfter();

            // Load default tab if set
            const defaultTab = localStorage.getItem('defaultTab');
            if (defaultTab) {
                showTab(defaultTab);
            }

            // Initialize Quick Lookup panel
            initializeQuickLookup();
            
            // Make sure overlay click closes the panel
            document.getElementById('quickLookupOverlay').addEventListener('click', function() {
                toggleQuickLookup();
            });
            
            // Add event listeners for date calculations
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // Add direct event listener to the custom days input
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', function() {
                    if (dateInput.value && customDaysInput.value && !isNaN(parseInt(customDaysInput.value))) {
                        calculateCustomDate();
                    }
                });
            }

            // Ensure body has data-active-tab set based on currently active section
            if (!document.body.getAttribute('data-active-tab')) {
                const activeSection = document.querySelector('.content-section.active');
                if (activeSection && activeSection.id.endsWith('Content')) {
                    const tabName = activeSection.id.replace('Content', '');
                    document.body.setAttribute('data-active-tab', tabName);
                } else {
                    // Fallback to main
                    document.body.setAttribute('data-active-tab', 'main');
                }
            }
        }

        // Save notes when user types
        document.getElementById('Notes').addEventListener('input', function(e) {
            localStorage.setItem('elevatorNotes', e.target.value);
        });

        // Save all Filing Information fields when user types
        document.getElementById('ownerInput').addEventListener('input', function(e) {
            localStorage.setItem('ownerInputInfo', e.target.value);
        });
        
        document.getElementById('elevatorCompanyInput').addEventListener('input', function(e) {
            localStorage.setItem('elevatorCompanyInputInfo', e.target.value);
        });
        
        document.getElementById('binInput').addEventListener('input', function(e) {
            localStorage.setItem('binInputInfo', e.target.value);
        });
        
        document.getElementById('groupsInput').addEventListener('input', function(e) {
            localStorage.setItem('groupsInputInfo', e.target.value);
        });
        
        document.getElementById('directorsInput').addEventListener('input', function(e) {
            localStorage.setItem('directorsInputInfo', e.target.value);
        });
        
        document.getElementById('additionalInput').addEventListener('input', function(e) {
            localStorage.setItem('additionalInputInfo', e.target.value);
        });

        // Add event listeners for Quick Filing Information fields with error handling
        function addQuickFilingEventListeners() {
            const quickFilingFields = [
                { id: 'quickOwnerInput', key: 'quickOwnerInputInfo' },
                { id: 'quickElevatorCompanyInput', key: 'quickElevatorCompanyInputInfo' },
                { id: 'quickBinInput', key: 'quickBinInputInfo' },
                { id: 'quickGroupsInput', key: 'quickGroupsInputInfo' },
                { id: 'quickDirectorsInput', key: 'quickDirectorsInputInfo' },
                { id: 'quickAdditionalInput', key: 'quickAdditionalInputInfo' }
            ];

            quickFilingFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('input', function(e) {
                        localStorage.setItem(field.key, e.target.value);
                    });
                }
            });

            // Add event listener for Quick Notes
            const quickNotesInput = document.getElementById('quickNotesInput');
            if (quickNotesInput) {
                quickNotesInput.addEventListener('input', function(e) {
                    localStorage.setItem('quickNotesContent', e.target.value);
                });
            }
        }

        // Initialize quick filing event listeners when page loads
        window.addEventListener('load', function() {
            addQuickFilingEventListeners();
        });

        let lastCalculation = null; // Track the last calculation performed
        let dateMode = 'positive'; // Track whether we're adding or subtracting days ('positive' or 'negative')

        function calculateDate(days) {
            const dateStr = document.getElementById('dateInput').value;
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Clear the custom days input when using preset buttons
            document.getElementById('customDays').value = '';
            
            // Store the last calculation type and value
            lastCalculation = { type: 'standard', days: days };
            
            // Create date object and set to noon UTC
            const inputDate = new Date(dateStr);
            inputDate.setUTCHours(12, 0, 0, 0);
            
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            // Handle positive and negative days properly in text output
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            // Spelled-out format using long options
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = "" + spelledInput + " becomes " + spelledResult;
        }

        // New function to handle mode-based date calculation
        function calculateDateWithMode(days) {
            const effectiveDays = dateMode === 'negative' ? -days : days;
            calculateDate(effectiveDays);
        }

        // Function to toggle between positive and negative date calculation modes
        function toggleDateMode(mode) {
            dateMode = mode;
            
            // Update button styles for desktop
            const negativeToggle = document.getElementById('negativeToggle');
            const positiveToggle = document.getElementById('positiveToggle');
            
            // Get the date buttons to update their text
            const days10 = document.getElementById('days10');
            const days30 = document.getElementById('days30');
            const days60 = document.getElementById('days60');
            const days91 = document.getElementById('days91');
            
            // Get the dropdown options
            const daysSelect = document.getElementById('daysSelect');
            const options = daysSelect.options;
            
            // Update mobile mode dropdown
            const modeSelect = document.getElementById('modeSelect');
            if (modeSelect) {
                modeSelect.value = mode;
            }
            
            if (mode === 'negative') {
                // Negative mode active - change button text to "Prior"
                days10.textContent = '10 Days Prior';
                days30.textContent = '30 Days Prior';
                days60.textContent = '60 Days Prior';
                days91.textContent = '91 Days Prior';
                
                // Update dropdown options (options[0] is "Select Days", so start at [1])
                options[1].textContent = '10 Days Prior';
                options[2].textContent = '30 Days Prior';
                options[3].textContent = '60 Days Prior';
                options[4].textContent = '91 Days Prior';
                
                // Update toggle button styles
                negativeToggle.style.backgroundColor = '#000';
                negativeToggle.style.color = '#fff';
                negativeToggle.style.borderColor = '#000';
                
                positiveToggle.style.backgroundColor = '#f0f0f0';
                positiveToggle.style.color = '#666';
                positiveToggle.style.borderColor = '#ccc';
            } else {
                // Positive mode active (default) - revert to original text
                days10.textContent = '10 Days';
                days30.textContent = '30 Days';
                days60.textContent = '60 Days';
                days91.textContent = '91 Days';
                
                // Update dropdown options (options[0] is "Select Days", so start at [1])
                options[1].textContent = '10 Days';
                options[2].textContent = '30 Days';
                options[3].textContent = '60 Days';
                options[4].textContent = '91 Days';
                
                // Update toggle button styles
                positiveToggle.style.backgroundColor = '#000';
                positiveToggle.style.color = '#fff';
                positiveToggle.style.borderColor = '#000';
                
                negativeToggle.style.backgroundColor = '#f0f0f0';
                negativeToggle.style.color = '#666';
                negativeToggle.style.borderColor = '#ccc';
            }
        }

        // Function to handle mode selection from mobile dropdown
        function toggleDateModeFromDropdown(mode) {
            toggleDateMode(mode);
            
            // If there's already a day value selected, recalculate with the new mode
            const daysSelect = document.getElementById('daysSelect');
            if (daysSelect && daysSelect.value && daysSelect.value !== "") {
                calculateDateWithMode(parseInt(daysSelect.value));
            }
        }

        // Modify the calculateCustomDate function to work with event triggers
        function calculateCustomDate() {
            const dateStr = document.getElementById('dateInput').value;
            const customDaysInput = document.getElementById('customDays');
            const days = parseInt(customDaysInput.value);
            
            if (isNaN(days)) {
                document.getElementById('dateResult').textContent = "Please enter a valid number.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Add maximum reasonable limit
            if (Math.abs(days) > 36500) { // 100 years
                document.getElementById('dateResult').textContent = "Please enter a more reasonable number of days.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Store the last calculation type and value
            lastCalculation = { type: 'custom', days: days };
            
            const inputDate = new Date(dateStr + "T12:00:00");
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = 
                absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = 
                spelledInput + " becomes " + spelledResult;
        }

        function clearDateInput() {
            document.getElementById('dateInput').value = '';
            document.getElementById('customDays').value = '';
            document.getElementById('daysSelect').value = ''; // Reset dropdown
            document.getElementById('dateResult').textContent = '';
            document.getElementById('dateSpelledResult').textContent = '';
            lastCalculation = null; // Reset the last calculation
        }

        // Add this new function to reapply the last calculation when date changes
        function dateChanged() {
            if (lastCalculation) {
                if (lastCalculation.type === 'standard') {
                    calculateDate(lastCalculation.days);
                } else if (lastCalculation.type === 'custom') {
                    calculateCustomDate();
                }
            }
        }

        // Add event listener for the date input
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
        });



        function toggleReference() {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            if (panel.style.display === 'block') {
                // Closing animation
                overlay.style.opacity = '0';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-50%) translateY(-20px)';
                button.textContent = 'ELV3 Reference';
                
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    panel.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            } else {
                // Opening animation
                panel.style.display = 'block';
                overlay.style.display = 'block';
                button.textContent = 'Hide Reference';
                
                // Small delay to ensure display is set before animating
                setTimeout(() => {
                    overlay.style.opacity = '1';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(-50%) translateY(0)';
                }, 10);
            }
            
            event.stopPropagation();
        }

        // Update the click outside handler
        document.addEventListener('click', function(event) {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            // Check if the click is outside the panel and not on the toggle button
            if (panel.style.display === 'block' && 
                !panel.contains(event.target) && 
                event.target !== button) {
                
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'ELV3 Reference';
            }
        });

        // Update the panel click handler
        document.querySelector('.reference-panel').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        function calculateNinetyDayStart() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 91);
            
            // Format for the simple date
            const simpleDate = startDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = startDate.toLocaleDateString('en-US', options);
            
            document.getElementById('ninetyDayStart').innerHTML = 
                `<div>Any date on or before: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        function calculateTenDaysAfter() {
            const today = new Date();
            const futureDate = new Date(today);
            futureDate.setDate(today.getDate() + 10);
            
            // Format for the simple date
            const simpleDate = futureDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = futureDate.toLocaleDateString('en-US', options);
            
            document.getElementById('tenDaysAfter').innerHTML = 
                `<div>Date: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        // Removed dropdown menu; function no longer needed

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Load current setting
            const savedTab = localStorage.getItem('defaultTab') || 'main';
            document.getElementById('defaultTab').value = savedTab;
            
            // Close dropdown
            document.getElementById('dropdownContent').style.display = 'none';

            // Add click event listener to close settings when clicking outside
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    closeSettings();
                }
            });

            // Prevent clicks inside the modal from closing it
            modal.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function saveSettings() {
            const defaultTab = document.getElementById('defaultTab').value;
            localStorage.setItem('defaultTab', defaultTab);
            closeSettings();
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-button')) {
                const dropdown = document.getElementById('dropdownContent');
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                }
            }
        }

        // Add this new function to your script section
        async function lookupBIN() {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const resultDiv = document.getElementById('binResult');
            const binInput = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    quickBinValue.textContent = device.bin || '-';
                    updateBinDisplayStyle();
                    if (device.bin) {
                        lookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('deviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">â–¼</span>
                            </button>
                            <div id="deviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                    
                    resultDiv.innerHTML = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Number:</strong> 
                                <span style="${dateStyle}">${device.device_number || deviceNumber}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('device_violations_${deviceNumber}')" 
                                            id="violationsBtn_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">â–¼</span>
                                    </button>
                                    <div id="violations_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <strong style="color: var(--header-color); margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            <!-- Add Important dropdown for red devices -->
                            ${allDatesAreSame ? `
                                <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                    <button onclick="toggleImportantDropdown('${device.device_number || deviceNumber}')"
                                            style="width: 100%; padding: 10px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                        <span>âš ï¸ Important</span>
                                        <span class="arrow">â–¼</span>
                                    </button>
                                    <div id="important_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b;">
                                        <div style="margin-bottom: 8px;">
                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that a final acceptance test was performed on this device. If a final acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${deviceSpecsHTML}
                            
                            <!-- Add More Info button and dropdown -->
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <button onclick="toggleMoreInfo('moreInfo_${device.device_number}')"
                                        style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span>More Info</span>
                                    <span class="arrow">â–¼</span>
                                </button>
                                <div id="moreInfo_${device.device_number}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> 
                                        <span>${device.block || 'N/A'}</span>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> 
                                        <span>${device.lot || 'N/A'}</span>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="https://a836-pts-access.nyc.gov/care/forms/htmlframe.aspx?mode=content/home.htm" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           onmouseover="this.style.opacity='0.8';"
                                           onmouseout="this.style.opacity='1';"
                                           style="display: inline-block; padding: 6px 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-weight: 500; transition: opacity 0.2s ease;">
                                            NYC Finance
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this function to toggle device information
        function toggleDeviceInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                element.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                element.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }

        // Add this new function to toggle building devices in bulk lookup
        function toggleBuildingDevices(bin) {
            const devicesContainer = document.getElementById(`buildingDevices_${bin}`);
            const arrow = document.getElementById(`buildingArrow_${bin}`);
            
            if (devicesContainer.style.display === 'none') {
                devicesContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                devicesContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle function for bulk test completion status lists
        function toggleBulkTestList(listType) {
            const listIds = {
                'bothTests': 'bulkBothTestsList',
                'oneTest': 'bulkOneTestList',
                'warning': 'bulkWarningList',
                'noTests': 'bulkNoTestsList',
                'noTestRequired': 'bulkNoTestRequiredList'
            };
            
            const targetId = listIds[listType];
            if (!targetId) return;
            
            const targetList = document.getElementById(targetId);
            if (!targetList) return;
            
            // Close all other lists first
            Object.values(listIds).forEach(id => {
                const list = document.getElementById(id);
                if (list && id !== targetId) {
                    list.style.display = 'none';
                }
            });
            
            // Toggle the target list
            if (targetList.style.display === 'none' || targetList.style.display === '') {
                targetList.style.display = 'block';
                // Smooth scroll to the list
                targetList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                targetList.style.display = 'none';
            }
        }

        // Filter function for bulk results search
        function filterBulkResults(searchTerm) {
            const term = searchTerm.toUpperCase().trim();
            
            // Filter summary table rows
            const summaryRows = document.querySelectorAll('.summary-row');
            summaryRows.forEach(row => {
                const bin = row.dataset.bin || '';
                const address = row.dataset.address || '';
                const devices = row.dataset.devices || '';
                
                const matches = bin.toUpperCase().includes(term) || 
                               address.toUpperCase().includes(term) || 
                               devices.toUpperCase().includes(term);
                
                row.style.display = matches ? '' : 'none';
            });
            
            // Filter building cards
            const buildingCards = document.querySelectorAll('.building-card');
            buildingCards.forEach(card => {
                const bin = card.dataset.bin || '';
                const address = card.dataset.address || '';
                const devices = card.dataset.devices || '';
                
                const matches = bin.toUpperCase().includes(term) || 
                               address.toUpperCase().includes(term) || 
                               devices.toUpperCase().includes(term);
                
                card.style.display = matches ? '' : 'none';
            });
        }

        // Add this new function to handle the device details dropdown toggle
        function toggleDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            const button = document.getElementById(`detailsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (detailsElement.style.display === 'none') {
                // Fetch additional device details if not already loaded
                if (detailsElement.getAttribute('data-loaded') !== 'true') {
                    fetchDeviceDetails(deviceNumber);
                }
                detailsElement.style.display = 'block';
                arrow.textContent = 'â–²';
                if (buttonText) {
                    buttonText.textContent = 'Hide Details';
                }
            } else {
                detailsElement.style.display = 'none';
                arrow.textContent = 'â–¼';
                if (buttonText) {
                    buttonText.textContent = 'Show Details';
                }
            }
        }

        // Function to fetch additional device details
        async function fetchDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            detailsElement.innerHTML = '<span style="color: var(--text-color);">Loading details...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    
                    // Get inspection dates directly from the device data
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Get recent inspections if available
                    let inspectionHistory = '';
                    try {
                        const inspResponse = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                        if (inspResponse.ok) {
                            const inspData = await inspResponse.json();
                            if (inspData && inspData.length > 0) {
                                // Sort inspections by date (newest first)
                                const inspections = inspData.filter(insp => insp.inspection_date);
                                inspections.sort((a, b) => {
                                    return new Date(b.inspection_date) - new Date(a.inspection_date);
                                });
                                
                                // Get the most recent inspections
                                const recentInspections = inspections.slice(0, 5);
                                
                                if (recentInspections.length > 0) {
                                    inspectionHistory = `
                                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Recent Inspections:</strong>
                                            ${recentInspections.map(insp => `
                                                <div style="margin-bottom: 8px; padding: 5px; background: var(--input-bg); border-radius: 4px;">
                                                    <div><strong style="color: var(--header-color);">Date:</strong> ${insp.inspection_date ? new Date(insp.inspection_date).toLocaleDateString() : 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Type:</strong> ${insp.inspection_type || 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Result:</strong> ${insp.inspection_result || 'N/A'}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching inspection history:', error);
                    }
                    
                    // Fetch permit information for this BIN
                    let permitInfo = '';
                    try {
                        if (binNumber) {
                            const permitResponse = await fetch(`https://data.cityofnewyork.us/resource/ipu4-2q9a.json?bin=${binNumber}`);
                            if (permitResponse.ok) {
                                const permitData = await permitResponse.json();
                                if (permitData && permitData.length > 0) {
                                    // Sort permits by issue date (newest first)
                                    const permits = permitData.filter(permit => permit.issuance_date);
                                    permits.sort((a, b) => {
                                        return new Date(b.issuance_date) - new Date(a.issuance_date);
                                    });
                                    
                                    // Get the most recent permits
                                    const recentPermits = permits.slice(0, 5);
                                    
                                    if (recentPermits.length > 0) {
                                        permitInfo = `
                                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                                <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Permit Information:</strong>
                                                ${recentPermits.map(permit => `
                                                    <div style="margin-bottom: 12px; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border);">
                                                        <div><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issue Date:</strong> ${permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                                        ${permit.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching permit information:', error);
                    }
                    
                    let html = `
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Device Type:</strong> ${device.device_type || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Borough:</strong> ${device.borough || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Block:</strong> ${device.block || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Lot:</strong> ${device.lot || 'N/A'}
                        </div>
                        ${device.house_number && device.street_name ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Address:</strong> ${device.house_number} ${device.street_name}
                            </div>
                        ` : ''}
                        ${device.bin ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">BIN:</strong> ${device.bin}
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Inspection Dates:</strong>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 1:</strong> <span style="${dateStyle}">${cat1Display}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 5:</strong> <span style="${dateStyle}">${cat5Display}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest PVI:</strong> <span style="${dateStyle}">${pviDisplay}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest Inspection:</strong> <span style="${dateStyle}">${mostRecentDisplay}</span>
                                ${mostRecentDate ? 
                                    ` <span style="color: var(--text-muted); font-size: 0.9em;">
                                        (from ${
                                            mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                            mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                            'PVI'
                                        })
                                    </span>` : 
                                    ''}
                            </div>
                            ${daysSinceInspection !== null ? 
                                `<div style="margin-bottom: 5px;">
                                    <strong style="color: var(--header-color);">Days Since Last Inspection:</strong> 
                                    <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                        ${daysSinceInspection} days
                                    </span>
                                </div>` : 
                                ''}
                        </div>
                        ${permitInfo}
                        ${inspectionHistory}
                    `;
                    
                    detailsElement.innerHTML = html;
                    detailsElement.setAttribute('data-loaded', 'true');
                } else {
                    detailsElement.innerHTML = '<span style="color: var(--text-color);">No additional details found</span>';
                }
            } catch (error) {
                detailsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading details</span>';
                console.error('Error fetching device details:', error);
            }
        }

        // Add this new function to handle the violations dropdown toggle
        function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                arrow.textContent = 'â–²';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (violationsDiv.innerHTML.trim() === '') {
                    fetchViolations(deviceNumber);
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = 'â–¼';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Function to fetch violations for a device
        async function fetchViolations(deviceNumber) {
            const violationsElement = document.getElementById(`violations_${deviceNumber}`);
            violationsElement.innerHTML = '<span style="color: var(--text-color);">Loading violations...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Filter for active violations
                    const activeViolations = data.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    if (activeViolations.length > 0) {
                        let html = '';
                        activeViolations.forEach(v => {
                            html += `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                    <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Status:</strong> ${v.violation_status || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Date:</strong> ${v.violation_date ? new Date(v.violation_date).toLocaleDateString() : 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}</div>
                                </div>
                            `;
                        });
                        violationsElement.innerHTML = html;
                    } else {
                        violationsElement.innerHTML = '<span style="color: var(--text-color);">No active violations found</span>';
                    }
                } else {
                    violationsElement.innerHTML = '<span style="color: var(--text-color);">No violations found</span>';
                }
            } catch (error) {
                violationsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading violations</span>';
                console.error('Error fetching violations:', error);
            }

        }

        // Add event listener for Enter key
        document.getElementById('deviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupBIN();
            }
        });

        // Add input event listener for device number
        document.getElementById('deviceNumber').addEventListener('input', function(e) {
            const deviceNumber = e.target.value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
            
            // Toggle address search visibility based on device number field
            toggleAddressSearchVisibility(deviceNumber);
        });

        // Function to hide/show address search based on device number input
        function toggleAddressSearchVisibility(deviceNumber) {
            const addressSearchSection = document.getElementById('addressSearchSection');
            
            if (deviceNumber && deviceNumber.length > 0) {
                // Hide address search when device number has content
                if (addressSearchSection) {
                    addressSearchSection.style.display = 'none';
                }
            } else {
                // Show address search when device number is empty
                if (addressSearchSection) {
                    addressSearchSection.style.display = 'block';
                }
            }
        }

        // Add input event listener for BIN number
        document.getElementById('binNumber').addEventListener('input', function(e) {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = e.target.value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        });

        // Add the new lookupDevices function
        async function lookupDevices() {
            const binNumber = document.getElementById('binNumber').value.trim();
            const resultDiv = document.getElementById('deviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            // Show progress bar
            resultDiv.innerHTML = `
                <div id="binProgressContainer" style="padding: 20px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                    <div style="margin-bottom: 15px; text-align: center;">
                        <span id="binProgressText" style="color: var(--text-color); font-weight: 500; font-size: 1.1em;">
                            Fetching devices for BIN ${binNumber}...
                        </span>
                    </div>
                    <div style="background: var(--panel-bg); border-radius: 10px; height: 24px; overflow: hidden; border: 1px solid var(--input-border);">
                        <div id="binProgressBar" style="background: linear-gradient(90deg, #1a73e8, #4CAF50); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <span id="binProgressStatus" style="color: var(--text-color); font-size: 0.9em; opacity: 0.8;">
                            Step 1 of 3: Retrieving device list...
                        </span>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';

            // Helper function to update BIN lookup progress
            function updateBinProgress(percentage, statusText, progressText) {
                const progressBar = document.getElementById('binProgressBar');
                const progressStatus = document.getElementById('binProgressStatus');
                const progressTextEl = document.getElementById('binProgressText');
                
                if (progressBar) progressBar.style.width = percentage + '%';
                if (progressStatus) progressStatus.textContent = statusText;
                if (progressTextEl && progressText) progressTextEl.textContent = progressText;
            }

            try {
                // Step 1: Fetch device list (0-33%)
                updateBinProgress(10, 'Step 1 of 3: Retrieving device list...', `Fetching devices for BIN ${binNumber}...`);
                
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                updateBinProgress(33, 'Step 1 of 3: Device list retrieved', `Found ${data.length} device(s)...`);
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    // Step 2: Fetch violations (33-66%)
                    updateBinProgress(40, 'Step 2 of 3: Fetching violation data...', `Loading violations for ${data.length} device(s)...`);
                    
                    // Fetch violations for all devices in this BIN
                    const violationsByDevice = await fetchViolationsForBin(binNumber);
                    
                    updateBinProgress(66, 'Step 2 of 3: Violations loaded', 'Processing device data...');
                    
                    // Step 3: Generate results (66-100%)
                    updateBinProgress(75, 'Step 3 of 3: Generating results...', 'Building device information...');
                    window.violationsByDevice = violationsByDevice; // Store for later use
                    
                    // Calculate total active violations
                    let totalActiveViolations = 0;
                    for (const deviceNum in violationsByDevice) {
                        const deviceViolations = violationsByDevice[deviceNum];
                        const activeDeviceViolations = deviceViolations.filter(v => 
                            v.violation_status?.toUpperCase() === 'ACTIVE' || 
                            v.violation_status?.toUpperCase() === 'OPEN');
                        totalActiveViolations += activeDeviceViolations.length;
                    }
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices
                    const removedDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Calculate test eligibility counts
                    const currentYearForEligibility = new Date().getFullYear();
                    const todayForEligibility = new Date();
                    
                    // Calculate eligible devices and break down by completion status
                    // Completed devices should NOT count toward Ready count
                    let eligibleDevices = 0; // Only non-completed eligible devices
                    let eligibleCompletedDevices = 0;
                    
                    data.forEach(device => {
                        // Skip removed devices as they don't need testing
                        if (device.device_status && device.device_status.toUpperCase() === 'REMOVED') {
                            return;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        // Check if device is completed for the year
                        const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYearForEligibility;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYearForEligibility;
                        
                        // Check if CAT 5 is required (Dumbwaiters and Conveyors do not need CAT 5 testing)
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && cat5Date) {
                            const yearsSinceCat5 = currentYearForEligibility - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        } else {
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYearForEligibility) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYearForEligibility);
                        }
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        // Check if this is a warning device (CAT 1 & PVI done but CAT 5 required and not done)
                        const isWarningDevice = requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Check if device is completed FIRST - if completed, count as Completed regardless of eligibility
                        if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            const relevantDate = isDismantled ? pviDate : mostRecentDate;
                            const testYear = relevantDate ? relevantDate.getFullYear() : null;
                            
                            if (testYear === currentYearForEligibility && todayForEligibility.getFullYear() === currentYearForEligibility) {
                                // Device is completed - count as completed but NOT as ready (regardless of eligibility)
                                eligibleCompletedDevices++;
                            }
                        } else if (!isWarningDevice) {
                            // Device is not completed - check eligibility for Ready/Not Ready
                            let isEligible = isEligibleForTesting(mostRecentDate);
                            
                            if (isEligible) {
                                // Device is eligible but not completed - count as ready
                                eligibleDevices++;
                            }
                        }
                    });
                    
                    const notEligibleDevices = data.filter(device => {
                        // Skip removed devices as they don't need testing
                        if (device.device_status && device.device_status.toUpperCase() === 'REMOVED') {
                            return false;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        // Check if device is eligible based on 91-day rule
                        let isEligible = isEligibleForTesting(mostRecentDate);
                        
                        // Check if this is a warning device (CAT 1 & PVI done but CAT 5 required and not done)
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYearForEligibility;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYearForEligibility;
                        
                        // Dumbwaiters and Conveyors do not need CAT 5 testing
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && cat5Date) {
                            const yearsSinceCat5 = currentYearForEligibility - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        } else {
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYearForEligibility) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYearForEligibility);
                        }
                        
                        const isWarningDevice = requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Check if device is completed
                        const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        // Exclude completed devices from Not Ready count - they're in Completed section
                        if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            const relevantDate = isDismantled ? pviDate : mostRecentDate;
                            const testYear = relevantDate ? relevantDate.getFullYear() : null;
                            
                            if (testYear === currentYearForEligibility && todayForEligibility.getFullYear() === currentYearForEligibility) {
                                return false; // Device is completed - don't count as Not Ready
                            }
                        }
                        
                        // Exclude warning devices from Not Ready count - they're in Warning section
                        if (isWarningDevice) {
                            return false;
                        }
                        
                        return !isEligible;
                    }).length;

                    // Separate devices into active and removed
                    const activeDevicesData = data.filter(device => 
                        !device.device_status || device.device_status.toUpperCase() !== 'REMOVED'
                    );
                    const removedDevicesData = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    );

                    // Group active devices by type
                    const deviceTypes = {};
                    activeDevicesData.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!deviceTypes[type]) {
                            deviceTypes[type] = [];
                        }
                        deviceTypes[type].push(device);
                    });

                    // Group removed devices by type for the removed section
                    const removedDeviceTypes = {};
                    removedDevicesData.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!removedDeviceTypes[type]) {
                            removedDeviceTypes[type] = [];
                        }
                        removedDeviceTypes[type].push(device);
                    });

                    // Count devices with both periodic and category tests completed in current year
                    // Note: currentYear automatically updates each year - no hardcoded year needed
                    const currentYear = new Date().getFullYear();
                    let devicesWithBothTests = 0;
                    let devicesWithOneTest = 0;
                    let devicesWithNoTests = 0;
                    let devicesWithWarning = 0;
                    const devicesWithOneTestList = []; // Store device info with one test completed
                    const devicesWithBothTestsList = []; // Store device info with both tests completed
                    const devicesWithNoTestsList = []; // Store device info with no tests completed
                    const devicesWithWarningList = []; // Store device info with CAT 5 required but not done
                    
                    // Get dismantled devices separately
                    const dismantledDevicesData = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    );
                    
                    // Count active devices (not removed or dismantled) - exclude dismantled from active devices loop
                    activeDevicesData.filter(device => 
                        !device.device_status || device.device_status.toUpperCase() !== 'DISMANTLED'
                    ).forEach(device => {
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        // Check if periodic inspection was done this year
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        
                        // Check if category test was done this year
                        // CAT 5 is only required every 5 years, so check if CAT 5 is required this year
                        // Dumbwaiters and Conveyors do not need CAT 5 testing
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && cat5Date) {
                            const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        } else {
                            // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYear);
                        }
                        
                        // Check if CAT 1 & PVI are done but CAT 5 is required and not done (Warning case)
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        
                        if (requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear) {
                            // CAT 5 is required but not done, even though CAT 1 & PVI were done - add to warning list
                            devicesWithWarning++;
                            devicesWithWarningList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: false,
                                hasCat1: hasCat1ThisYear,
                                requiresCat5: true,
                                lastCat5Year: cat5Date ? cat5Date.getFullYear() : null,
                                isDismantled: false
                            });
                        } else if (conveyorCompleted || (hasPVIThisYear && hasCategoryTestThisYear)) {
                            devicesWithBothTests++;
                            devicesWithBothTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: hasCategoryTestThisYear,
                                isDismantled: false,
                                isConveyor: isConveyor
                            });
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            devicesWithOneTest++;
                            devicesWithOneTestList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: hasCategoryTestThisYear,
                                isDismantled: false
                            });
                        } else {
                            // Device has neither PVI nor Category test completed this year
                            devicesWithNoTests++;
                            devicesWithNoTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: false,
                                hasCategory: false,
                                isDismantled: false
                            });
                        }
                    });
                    
                    // Count dismantled devices - they only need PVI to be considered completed
                    dismantledDevicesData.forEach(device => {
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        
                        // Dismantled devices only need PVI to be considered completed
                        if (hasPVIThisYear) {
                            devicesWithBothTests++;
                            devicesWithBothTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: false,
                                isDismantled: true
                            });
                        } else {
                            // Dismantled device without PVI - add to no tests list
                            devicesWithNoTests++;
                            devicesWithNoTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: false,
                                hasCategory: false,
                                isDismantled: true
                            });
                        }
                    });
                    
                    // Store the lists globally for filtering
                    window.devicesWithOneTestList = devicesWithOneTestList;
                    window.devicesWithBothTestsList = devicesWithBothTestsList;
                    window.devicesWithNoTestsList = devicesWithNoTestsList;
                    window.devicesWithWarningList = devicesWithWarningList;

                    // Build device type summary with counts
                    // Order matches the output: active device types first (in their order), then removed-only types
                    const deviceTypeSummary = (() => {
                        const typeCounts = [];
                        const processedTypes = new Set();
                        
                        // Process active device types first (in the order they appear)
                        Object.keys(deviceTypes).forEach(type => {
                            const activeCount = deviceTypes[type] ? deviceTypes[type].length : 0;
                            const removedCount = removedDeviceTypes[type] ? removedDeviceTypes[type].length : 0;
                            const totalCount = activeCount + removedCount;
                            
                            // Format the type name and handle pluralization for elevator
                            let formattedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
                            if (type.toUpperCase() === 'ELEVATOR' && totalCount > 1) {
                                formattedType = 'Elevators';
                            }
                            
                            let countStr = formattedType + ' (' + activeCount + ' active';
                            if (removedCount > 0) {
                                countStr += ', ' + removedCount + ' removed';
                            }
                            countStr += ')';
                            typeCounts.push(countStr);
                            processedTypes.add(type);
                        });
                        
                        // Add any removed-only device types (types that only exist in removed, not active)
                        Object.keys(removedDeviceTypes).forEach(type => {
                            if (!processedTypes.has(type)) {
                                const removedCount = removedDeviceTypes[type].length;
                                let formattedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
                                if (type.toUpperCase() === 'ELEVATOR' && removedCount > 1) {
                                    formattedType = 'Elevators';
                                }
                                let countStr = formattedType + ' (0 active, ' + removedCount + ' removed)';
                                typeCounts.push(countStr);
                            }
                        });
                        
                        return typeCounts.join(', ');
                    })();

                    let html = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: var(--header-color);">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px; padding: 12px; background: var(--panel-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <!-- Year updates automatically via currentYear variable (new Date().getFullYear()) -->
                                    <strong style="color: var(--header-color);">${currentYear} Test Completion Status:</strong>
                                    <button onclick="toggleTestCompletionStatus()" 
                                            id="testCompletionStatusBtn"
                                            data-showing="false"
                                            style="padding: 6px 12px; background: var(--input-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; transition: all 0.2s ease;">
                                        <span id="testCompletionStatusText">Show</span>
                                    </button>
                                </div>
                                <div id="testCompletionStatusContent" style="display: none; margin-left: 10px;">
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ff9800;">âš  Warning (CAT 5 Required): ${devicesWithWarning}</span>
                                            ${devicesWithWarning > 0 ? `
                                                <button onclick="toggleWarningList()" 
                                                        id="warningListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="warningListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="warningDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithWarningList.map(device => {
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) - CAT 1 & PVI completed, CAT 5 required
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #4CAF50;">âœ“ Both Tests Completed: ${devicesWithBothTests}</span>
                                            ${devicesWithBothTests > 0 ? `
                                                <button onclick="toggleBothTestsList()" 
                                                        id="bothTestsListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="bothTestsListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="bothTestsDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithBothTestsList.map(device => {
                                                    let testInfo = '';
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        testInfo = 'PVI completed (Dismantled devices only need PVI)';
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    } else {
                                                        const tests = [];
                                                        if (device.hasPVI) tests.push('PVI');
                                                        if (device.hasCategory) tests.push('Category test');
                                                        testInfo = tests.join(' + ');
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - ${testInfo}
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ffd700;">âš  One Test Completed: ${devicesWithOneTest}</span>
                                            ${devicesWithOneTest > 0 ? `
                                                <button onclick="toggleOneTestList()" 
                                                        id="oneTestListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="oneTestListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="oneTestDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithOneTestList.map(device => {
                                                    let testType = '';
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        testType = 'No PVI test (Dismantled devices only need PVI)';
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    } else {
                                                        testType = device.hasPVI ? 'PVI only' : 'Category test only';
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - ${testType}
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ff6b6b;">âœ— No Test Completed: ${devicesWithNoTests}</span>
                                            ${devicesWithNoTests > 0 ? `
                                                <button onclick="toggleNoTestsList()" 
                                                        id="noTestsListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="noTestsListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="noTestsDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithNoTestsList.map(device => {
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - No tests completed this year
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: var(--header-color);">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--header-color);">Total Active Violations:</strong> 
                                        <span style="color: ${totalActiveViolations > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${totalActiveViolations > 0 ? totalActiveViolations : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">â€¢ Active Devices: ${activeDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">â€¢ Dismantled Devices: ${dismantledDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">â€¢ Removed Devices: ${removedDevices}</span>
                                    <br>
                                    <div style="margin-top: 10px;">
                                        <strong style="color: var(--header-color);">Test Eligibility:</strong>
                                        <br>
                                        <span style="margin-left: 20px; color: ${devicesWithWarning > 0 ? '#ff9800' : 'var(--text-color)'};">â€¢ Warning: ${devicesWithWarning}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${eligibleCompletedDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">â€¢ Completed: ${eligibleCompletedDevices}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${eligibleDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">â€¢ Ready: ${eligibleDevices}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${notEligibleDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">â€¢ Not Ready: ${notEligibleDevices}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; margin-bottom: 15px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                    <button 
                                        onclick="toggleViolationsFilter()" 
                                        id="violationsFilterBtn"
                                        data-filtering="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; display: flex; align-items: center; gap: 5px; width: 240px;">
                                        <span id="violationsFilterText">Show Only Devices with Violations</span>
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="testEligibilityFilter" style="color: var(--text-color); font-size: 0.9em;">Test Eligibility:</label>
                                        <select 
                                            id="testEligibilityFilter" 
                                            onchange="filterByTestEligibility()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Devices</option>
                                            <option value="eligible">Ready</option>
                                            <option value="not-eligible">Not Ready</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    
                                    <button 
                                        onclick="toggleAllViolations()" 
                                        id="toggleAllViolationsBtn"
                                        data-showing="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 180px;">
                                        Show All Violations
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="deviceTypeFilter" style="color: var(--text-color); font-size: 0.9em;">Filter by Type:</label>
                                        <select 
                                            id="deviceTypeFilter" 
                                            onchange="filterDevicesByType()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Types</option>
                                            ${Object.keys(deviceTypes).map(type => 
                                                `<option value="${type}">${type}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="deviceNumberFilter" style="color: var(--text-color); font-size: 0.9em;">Search:</label>
                                        <input 
                                            type="text" 
                                            id="deviceNumberFilter" 
                                            placeholder="Enter device number"
                                            oninput="filterByDeviceNumber()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="dateSortFilter" style="color: var(--text-color); font-size: 0.9em;">Sort by Date:</label>
                                        <select 
                                            id="dateSortFilter" 
                                            onchange="sortByDateTested()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="default">Default Order</option>
                                            <option value="oldest">Oldest First</option>
                                            <option value="newest">Newest First</option>
                                        </select>
                                    </div>
                                    
                                    <button 
                                        onclick="resetFilters()" 
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 120px;">
                                        Reset Filters
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: var(--header-color); display: block; margin-bottom: 10px;">Active Devices by Type:</strong>
                                <div style="color: var(--text-color); font-size: 0.9em; margin-bottom: 10px; margin-left: 5px;">${deviceTypeSummary}</div>
                                <div id="testEligibilityCount" style="color: var(--text-color); font-size: 0.9em; font-weight: 500; margin-bottom: 10px; margin-left: 5px;"></div>
                                <div style="height: 600px; overflow-y: auto; padding-right: 10px; resize: vertical; border: 2px solid var(--input-border); border-radius: 5px; min-height: 300px;" id="deviceTypeSections">
                    `;
                    
                    // Update progress for device section generation
                    updateBinProgress(85, 'Step 3 of 3: Generating device sections...', `Processing ${data.length} device(s)...`);
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        const elevatorSection = await generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR'], violationsByDevice);
                        html += elevatorSection;
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    
                    // Then display the rest of the active device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        const deviceSection = await generateDeviceTypeSection(type, devices, violationsByDevice);
                        html += deviceSection;
                    }
                    
                    // Update progress after device sections
                    updateBinProgress(95, 'Step 3 of 3: Finalizing...', 'Almost done...');

                    html += `</div>`;

                    // Add removed devices section if there are any
                    if (removedDevicesData.length > 0) {
                        html += `
                            <div style="margin-top: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #ff6b6b;">Removed Devices (${removedDevicesData.length}):</strong>
                                    <button onclick="toggleRemovedDevices()" 
                                            id="removedDevicesToggleBtn"
                                            data-showing="false"
                                            style="padding: 6px 12px; background: var(--input-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                                        <span id="removedDevicesToggleText">Show</span>
                                        <svg id="removedDevicesToggleIcon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="transition: transform 0.2s ease;">
                                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div id="removedDeviceTypeSections" style="display: none; height: 400px; overflow-y: auto; padding-right: 10px; resize: vertical; border: 2px solid var(--input-border); border-radius: 5px; min-height: 200px;">
                        `;
                        
                        // Display removed devices grouped by their original type
                        for (const [type, devices] of Object.entries(removedDeviceTypes)) {
                            const removedSection = await generateRemovedDeviceTypeSection(type, devices, violationsByDevice);
                            html += removedSection;
                        }
                        
                        html += `</div>`;
                    }

                                        html += `</div></div>`;
                    
                    // Final progress update before displaying results
                    updateBinProgress(100, 'Complete!', 'Loading results...');
                    
                    resultDiv.innerHTML = html;
                    // Initialize filter count display
                    if (typeof window.applyAllFilters === 'function') {
                        window.applyAllFilters();
                    }
                        } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                    // Clear count display when no results
                    const countElement = document.getElementById('testEligibilityCount');
                    if (countElement) {
                        countElement.textContent = '';
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
                // Clear count display on error
                const countElement = document.getElementById('testEligibilityCount');
                if (countElement) {
                    countElement.textContent = '';
                }
            }
        }

        // Add this function before generateDeviceTypeSection
        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            return daysSinceInspection >= 91;
        }

        // Add function to generate removed device type section
        async function generateRemovedDeviceTypeSection(type, devices, violationsByDevice = {}) {
            // First, fetch all permit data for the devices
            const devicePermits = await Promise.all(
                devices.map(device => fetchPermitInfo(device.device_number))
            );

            return `
                <div class="device-type-section removed-devices" data-device-type="${type}" data-device-status="REMOVED">
                    <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ff6b6b;">
                        <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                            <strong style="color: #ff6b6b;">Removed ${type} (${devices.length}):</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${devices.map((device, index) => {
                                // Get violations for this device
                                const deviceViolations = violationsByDevice[device.device_number] || [];
                                const activeViolations = deviceViolations.filter(v => 
                                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                    v.violation_status?.toUpperCase() === 'OPEN');
                                const violationCount = activeViolations.length;
                                
                                // Get the pre-fetched permit data
                                const permitData = devicePermits[index];
                                const hasPermits = permitData.success && permitData.permits && permitData.permits.length > 0;

                                // Calculate dates for red styling check
                                const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                                const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                                const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                                
                                // Check if all dates are the same (CAT 1, CAT 5, and PVI)
                                const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                    cat1Date.getTime() === cat5Date.getTime() &&
                                    cat5Date.getTime() === pviDate.getTime();
                                
                                // Apply red styling if all dates are the same
                                const deviceNumberStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';

                                return `
                                    <div class="device-item removed-device" 
                                         data-has-violations="${violationCount > 0}" 
                                         data-device-type="${type}"
                                         data-device-status="REMOVED">
                                        <div style="padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid #ff6b6b; opacity: 0.8;">
                                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Device #:</strong> 
                                                    <span style="${deviceNumberStyle}">${device.device_number}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">BIN:</strong> 
                                                    ${device.bin ? `
                                                        <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                                              title="Click to copy BIN number"
                                                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                                     transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                                     border: 1px solid var(--input-border); background: var(--panel-bg);">
                                                            ${device.bin}
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                                                <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                                            </svg>
                                                        </span>
                                                    ` : '<span>N/A</span>'}
                                                </div>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Type:</strong> ${type}</div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">Status:</strong>
                                                    <span style="padding: 4px 8px; border-radius: 4px; background: #ff6b6b; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 4px;">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                        </svg>REMOVED
                                                    </span>
                                                </div>
                                            </div>
                                            ${violationCount > 0 ? `
                                                <div style="margin-top: 12px; margin-bottom: 8px;">
                                                    <span style="color: #ff6b6b; font-weight: 500;">
                                                        ${violationCount} Active Violation${violationCount !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <button onclick="toggleViolations('${device.device_number}')" 
                                                        id="violationsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Violation Details</span>
                                                        <span class="arrow">â–¼</span>
                                                    </button>
                                                    <div id="violations_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <div style="margin-top: 12px;">
                                                <button onclick="toggleDeviceDetails('${device.device_number}')" 
                                                    id="detailsBtn_${device.device_number}"
                                                    style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                           border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                           font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                    <span>Show Details</span>
                                                    <span class="arrow">â–¼</span>
                                                </button>
                                                <div id="details_${device.device_number}" style="display: none; margin-top: 8px; 
                                                     padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 1em;">
                                                </div>
                                            </div>
                                            ${hasPermits ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="togglePermitInfo('${device.device_number}')" 
                                                        id="permitsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Permit Information</span>
                                                        <span class="arrow">â–¼</span>
                                                    </button>
                                                    <div id="permits_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${allDatesAreSame ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="toggleImportantDropdown('${device.device_number}')"
                                                            style="width: 100%; padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                        <span>âš ï¸ Important</span>
                                                        <span class="arrow">â–¼</span>
                                                    </button>
                                                    <div id="important_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b; font-size: 0.9em;">
                                                        <div style="margin-bottom: 8px;">
                                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                                        </div>
                                                        <div style="margin-bottom: 8px;">
                                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to calculate test status for sorting
        function calculateTestStatusForSorting(device) {
            const currentYear = new Date().getFullYear();
            const today = new Date();
            
            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
            
            // Check if all dates are the same (acceptance test indicator)
            const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                cat1Date.getTime() === cat5Date.getTime() &&
                cat5Date.getTime() === pviDate.getTime();
            
            // Check if acceptance test was done in a previous year
            const acceptanceTestInPreviousYear = allDatesAreSame && 
                cat1Date.getFullYear() < currentYear;
            
            const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
            const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
            
            const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
            
            // Dumbwaiters and Conveyors do not need CAT 5 testing
            const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
            const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
            let requiresCat5 = false;
            if (!isDumwaiter && !isConveyor && cat5Date) {
                const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                requiresCat5 = yearsSinceCat5 >= 5;
            }
            
            // Determine if a valid category test was completed this year
            let hasCategoryTestThisYear = false;
            if (requiresCat5) {
                // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
            } else {
                // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                          (cat5Date && cat5Date.getFullYear() === currentYear);
            }
            
            const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
            // Conveyors only need CAT 1 testing (no PVI required)
            const conveyorCompleted = isConveyor && hasCat1ThisYear;
            const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
            const cat5NotRequired = !requiresCat5;
            const dismantledCompleted = isDismantled && hasPVIThisYear;
            
            // Conveyors are completed when CAT 1 is done this year
            if (conveyorCompleted) {
                if (today.getFullYear() === currentYear) {
                    return 'Completed';
                } else {
                    return isEligibleForTesting(cat1Date) ? 'Ready' : 'Not Ready';
                }
            }
            
            // Check if CAT 5 is required but not done, and CAT 1 & PVI are done this year
            if (requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear) {
                return 'CAT 5 Required';
            }
            
            // If acceptance test was done in previous year, both tests are required in new year
            // So we can't show "Completed" unless both tests are done in current year
            if (acceptanceTestInPreviousYear) {
                // Both tests must be completed in current year to show "Completed"
                if (bothTestsCompleted) {
                    const relevantDate = mostRecentDate;
                    const testYear = relevantDate ? relevantDate.getFullYear() : null;
                    
                    if (testYear === currentYear && today.getFullYear() === currentYear) {
                        return 'Completed';
                    } else {
                        // Calendar year has ended - check eligibility based on 91 days rule
                        return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
                    }
                } else {
                    // Both tests not completed in current year - check eligibility
                    return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
                }
            } else if (bothTestsCompleted || dismantledCompleted) {
                const relevantDate = isDismantled ? pviDate : mostRecentDate;
                const testYear = relevantDate ? relevantDate.getFullYear() : null;
                
                // Only show "Completed" if tests were done in current year and we're still in current year
                if (testYear === currentYear && today.getFullYear() === currentYear) {
                    return 'Completed';
                } else {
                    // Calendar year has ended - check eligibility based on 91 days rule
                    const eligibilityDate = isDismantled ? pviDate : mostRecentDate;
                    return isEligibleForTesting(eligibilityDate) ? 'Ready' : 'Not Ready';
                }
            } else {
                return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
            }
        }

        // Update the generateDeviceTypeSection function
        async function generateDeviceTypeSection(type, devices, violationsByDevice = {}) {
            // First, fetch all permit data for the devices
            const devicePermits = await Promise.all(
                devices.map(device => fetchPermitInfo(device.device_number))
            );

            // Create array with devices, permits, and status for sorting
            const devicesWithStatus = devices.map((device, index) => ({
                device: device,
                permit: devicePermits[index],
                status: calculateTestStatusForSorting(device)
            }));

            // Sort devices: "CAT 5 Required" first (most important), then "Not Ready", then "Ready", then "Completed"
            devicesWithStatus.sort((a, b) => {
                const statusOrder = { 'CAT 5 Required': -1, 'Not Ready': 0, 'Ready': 1, 'Completed': 2 };
                const orderA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 3;
                const orderB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 3;
                return orderA - orderB;
            });

            return `
                <div class="device-type-section" data-device-type="${type}">
                    <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                            <strong style="color: var(--header-color);">${type} (${devices.length}):</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${devicesWithStatus.map((item, index) => {
                                const device = item.device;
                                const permitData = item.permit;
                                // Get violations for this device
                                const deviceViolations = violationsByDevice[device.device_number] || [];
                                const activeViolations = deviceViolations.filter(v => 
                                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                    v.violation_status?.toUpperCase() === 'OPEN');
                                const violationCount = activeViolations.length;
                                
                                // Get the pre-fetched permit data (already from sorted array)
                                const hasPermits = permitData.success && permitData.permits && permitData.permits.length > 0;

                                // Calculate most recent inspection date
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                                
                                // Check if all dates are the same (CAT 1, CAT 5, and PVI) - acceptance test indicator
                                const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                    cat1Date.getTime() === cat5Date.getTime() &&
                                    cat5Date.getTime() === pviDate.getTime();
                                
                                // Apply red styling if all dates are the same
                                const deviceNumberStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                                
                                // Find most recent date
                                const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                                const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                                
                                // Calculate test status based on new requirements
                                const currentYear = new Date().getFullYear();
                                const today = new Date();
                                
                                // Check if acceptance test was done in a previous year
                                const acceptanceTestInPreviousYear = allDatesAreSame && 
                                    cat1Date.getFullYear() < currentYear;
                                
                                // Check if periodic inspection was done this year
                                const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                                
                                // Check if CAT 5 is required this year (Dumbwaiters and Conveyors do not need CAT 5 testing)
                                const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                                const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                                let requiresCat5 = false;
                                if (!isDumwaiter && !isConveyor && cat5Date) {
                                    const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                                    requiresCat5 = yearsSinceCat5 >= 5;
                                }
                                // If no CAT 5 date exists, CAT 5 is not required (CAT 1 is acceptable)
                                
                                // Determine if a valid category test was completed this year
                                let hasCategoryTestThisYear = false;
                                if (requiresCat5) {
                                    // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                                    hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                                } else {
                                    // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                                    hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                              (cat5Date && cat5Date.getFullYear() === currentYear);
                                }
                                
                                // Check if device is dismantled
                                const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                                const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                                
                                // Conveyors only need CAT 1 testing (no PVI required)
                                const conveyorCompleted = isConveyor && hasCat1ThisYear;
                                
                                // Check if both tests completed and CAT 5 not required
                                const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
                                const cat5NotRequired = !requiresCat5;
                                
                                // For dismantled devices, only PVI is required
                                const dismantledCompleted = isDismantled && hasPVIThisYear;
                                
                                // Determine test status
                                let testStatus = 'Not Ready';
                                let testStatusColor = '#ff6b6b';
                                let testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                            </svg>`;
                                let isEligible = false;
                                
                                // Conveyors are completed when CAT 1 is done this year
                                if (conveyorCompleted) {
                                    if (today.getFullYear() === currentYear) {
                                        testStatus = 'Completed';
                                        testStatusColor = '#4CAF50';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                            </svg>`;
                                    } else {
                                        isEligible = isEligibleForTesting(cat1Date);
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                }
                                // If acceptance test was done in previous year, both tests are required in new year
                                // So we can't show "Completed" unless both tests are done in current year
                                // Exception: Dismantled devices only need PVI, Conveyors only need CAT 1
                                else if (acceptanceTestInPreviousYear) {
                                    // For dismantled devices, only PVI is required; for regular devices, both tests must be completed
                                    if (isDismantled && hasPVIThisYear) {
                                        // Dismantled device with PVI completed this year
                                        const relevantDate = pviDate;
                                        const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                        
                                        if (testYear === currentYear && today.getFullYear() === currentYear) {
                                            // Still in the same calendar year as the PVI - show "Completed"
                                            testStatus = 'Completed';
                                            testStatusColor = '#4CAF50';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                                </svg>`;
                                        } else {
                                            // Calendar year has ended - check eligibility based on 91 days rule
                                            isEligible = isEligibleForTesting(pviDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                    } else if (bothTestsCompleted) {
                                        // Regular device - both tests must be completed in current year to show "Completed"
                                        const relevantDate = mostRecentDate;
                                        const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                        
                                        if (testYear === currentYear && today.getFullYear() === currentYear) {
                                            // Still in the same calendar year as the tests - show "Completed"
                                            testStatus = 'Completed';
                                            testStatusColor = '#4CAF50';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                                </svg>`;
                                        } else {
                                            // Calendar year has ended - check eligibility based on 91 days rule
                                            isEligible = isEligibleForTesting(mostRecentDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                    } else {
                                        // Tests not completed in current year - check eligibility
                                        // For dismantled devices without PVI, check eligibility based on PVI date
                                        if (isDismantled && !hasPVIThisYear) {
                                            // Dismantled device without PVI this year
                                            const eligibilityDate = pviDate || mostRecentDate;
                                            isEligible = isEligibleForTesting(eligibilityDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        } else {
                                            // Regular device - check if CAT 5 is required but not done this year
                                            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                                            if (requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear) {
                                            // CAT 5 is required but not done, even though CAT 1 & PVI were done - show warning but still Ready
                                            testStatus = 'CAT 5 Required';
                                            testStatusColor = '#ff9800';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                            </svg>`;
                                            isEligible = true; // Still count as eligible/Ready
                                        } else {
                                            isEligible = isEligibleForTesting(mostRecentDate);
                                            // If CAT 1 & PVI are done this year but CAT 5 is required and not done, still count as eligible (Ready)
                                            if (!isEligible && hasCat1ThisYear && hasPVIThisYear && requiresCat5 && !hasCategoryTestThisYear) {
                                                isEligible = true;
                                            }
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                        }
                                    }
                                } else if (bothTestsCompleted || dismantledCompleted) {
                                    // Check if we're still in the same calendar year as the tests
                                    // For dismantled devices, use PVI date; for regular devices, use most recent date
                                    const relevantDate = isDismantled ? pviDate : mostRecentDate;
                                    const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                    
                                    // Only show "Completed" if tests were done in current year and we're still in current year
                                    if (testYear === currentYear && today.getFullYear() === currentYear) {
                                        // Still in the same calendar year as the tests - show "Completed"
                                        testStatus = 'Completed';
                                        testStatusColor = '#4CAF50';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                            </svg>`;
                                    } else {
                                        // Calendar year has ended - check eligibility based on 91 days rule
                                        // For dismantled devices, use PVI date; for regular devices, use most recent date
                                        const eligibilityDate = isDismantled ? pviDate : mostRecentDate;
                                        isEligible = isEligibleForTesting(eligibilityDate);
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                } else {
                                    // Check if CAT 5 is required but not done this year
                                    const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                                    if (requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear) {
                                        // CAT 5 is required but not done, even though CAT 1 & PVI were done - show warning but still Ready
                                        testStatus = 'CAT 5 Required';
                                        testStatusColor = '#ff9800';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                        </svg>`;
                                        isEligible = true; // Still count as eligible/Ready
                                    } else {
                                        // Standard eligibility check
                                        isEligible = isEligibleForTesting(mostRecentDate);
                                        // If CAT 1 & PVI are done this year but CAT 5 is required and not done, still count as eligible (Ready)
                                        if (!isEligible && hasCat1ThisYear && hasPVIThisYear && requiresCat5 && !hasCategoryTestThisYear) {
                                            isEligible = true;
                                        }
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                }
                                
                                const daysSinceInspection = mostRecentDate ? 
                                    Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                                
                                // Determine which type of inspection was most recent
                                const lastInspectionType = mostRecentDate ? 
                                    mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT1' :
                                    mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT5' :
                                    'PVI' : null;
                                
                                return `
                                    <div class="device-item" 
                                         data-has-violations="${violationCount > 0}" 
                                         data-device-type="${type}"
                                         data-device-status="${(device.device_status || '').toUpperCase()}"
                                         data-original-index="${index}">
                                        <div style="padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Device #:</strong> 
                                                    <span style="${deviceNumberStyle}">${device.device_number}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">BIN:</strong> 
                                                    ${device.bin ? `
                                                        <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                                              title="Click to copy BIN number"
                                                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                                     transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                                     border: 1px solid var(--input-border); background: var(--panel-bg);">
                                                            ${device.bin}
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                                                <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                                            </svg>
                                                        </span>
                                                    ` : '<span>N/A</span>'}
                                                </div>
                                            </div>
                                                <div class="device-status-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <div><strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}</div>
                                                <div class="test-status-container" style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">Test Status:</strong>
                                                    <span class="test-status-badge" data-test-status="${isEligible}" data-test-status-text="${testStatus}" style="padding: 4px 8px; border-radius: 4px; background: ${testStatusColor}; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 4px;">
                                                        ${testStatusIcon}${testStatus}
                                                    </span>
                                                </div>
                                            </div>
                                            ${mostRecentDate ? `
                                                <div style="margin-top: 12px; margin-bottom: 12px; color: ${testStatusColor};">
                                                    ${testStatus === 'Completed' ? `
                                                        <div style="margin-bottom: 8px; color: #4CAF50; font-weight: 500;">
                                                            ${isDismantled || isConveyor ? 'Testing completed for the year' : 'Both tests completed for the year'}
                                                        </div>
                                                        ${isDismantled ? `
                                                            <div style="margin-bottom: 8px; color: #ffd700; font-size: 0.9em; font-style: italic;">
                                                                Dismantled devices are required to have a PVI completed for the calendar year. If dismantled device information is contradicting please verify information with the DOB and associated building contacts.
                                                            </div>
                                                        ` : ''}
                                                    ` : ''}
                                                    ${(() => {
                                                        // Check if device has one test completed but needs another
                                                        let needsOneMoreTest = false;
                                                        let missingTest = '';
                                                        
                                                        if (isDismantled) {
                                                            // Dismantled devices only need PVI
                                                            if (!hasPVIThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'PVI';
                                                            }
                                                        } else if (isConveyor) {
                                                            // Conveyors only need CAT 1 (no PVI required)
                                                            if (!hasCat1ThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'CAT 1';
                                                            }
                                                            // If CAT 1 is done, Conveyor is complete - no warning needed
                                                        } else {
                                                            // Regular devices need both PVI and Category test
                                                            if (hasPVIThisYear && !hasCategoryTestThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = requiresCat5 ? 'CAT 5' : 'CAT 1';
                                                            } else if (!hasPVIThisYear && hasCategoryTestThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'PVI';
                                                            }
                                                        }
                                                        
                                                        if (needsOneMoreTest) {
                                                            // Calculate days remaining in the current year
                                                            const today = new Date();
                                                            const endOfYear = new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999);
                                                            const timeDiff = endOfYear - today;
                                                            const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                                                            
                                                            // Only show message if 100 days or less remaining
                                                            if (daysRemaining <= 100) {
                                                                return `
                                                                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">
                                                                        <div style="color: #ff9800; font-weight: 500; margin-bottom: 4px;">
                                                                            âš  One test completed, ${missingTest} still required
                                                                        </div>
                                                                        <div style="color: var(--text-color); font-size: 0.9em;">
                                                                            ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining in ${today.getFullYear()} to complete ${missingTest}
                                                                        </div>
                                                                    </div>
                                                                `;
                                                            }
                                                        }
                                                        return '';
                                                    })()}
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                        <span>Last Inspection: ${mostRecentDate.toLocaleDateString()}</span>
                                                        <span style="padding: 2px 6px; background: var(--panel-bg); border-radius: 3px; color: var(--header-color);">${lastInspectionType}</span>
                                                        <span>â€¢ ${daysSinceInspection} days ago</span>
                                                    </div>
                                                    ${testStatus !== 'Completed' ? `
                                                        <div style="margin-bottom: 8px; color: ${testStatusColor};">
                                                            ${(() => {
                                                                // Determine which test is required next
                                                                let requiredTest = '';
                                                                if (isDismantled) {
                                                                    // For dismantled devices, only PVI is required
                                                                    requiredTest = !hasPVIThisYear ? 'PVI' : '';
                                                                } else if (isConveyor) {
                                                                    // For Conveyors, only CAT 1 is required (no PVI)
                                                                    requiredTest = !hasCat1ThisYear ? 'CAT 1' : '';
                                                                } else {
                                                                    // For regular devices, check what's missing for current year
                                                                    if (!hasPVIThisYear && !hasCategoryTestThisYear) {
                                                                        // Both tests missing - determine which category test is needed
                                                                        requiredTest = requiresCat5 ? 'CAT 5 and PVI' : 'CAT 1 and PVI';
                                                                    } else if (!hasPVIThisYear) {
                                                                        // Only PVI missing
                                                                        requiredTest = 'PVI';
                                                                    } else if (!hasCategoryTestThisYear) {
                                                                        // Only category test missing
                                                                        requiredTest = requiresCat5 ? 'CAT 5' : 'CAT 1';
                                                                    } else {
                                                                        // Both tests completed this year, but past calendar year - both required again
                                                                        // This handles the case where tests were done last year
                                                                        requiredTest = requiresCat5 ? 'CAT 5 and PVI' : 'CAT 1 and PVI';
                                                                    }
                                                                }
                                                                
                                                                const eligibilityDate = new Date(mostRecentDate.getTime() + (91 * 24 * 60 * 60 * 1000));
                                                                const formattedDate = eligibilityDate.toLocaleDateString('en-US', { 
                                                                    weekday: 'long',
                                                                    year: 'numeric',
                                                                    month: 'long',
                                                                    day: 'numeric'
                                                                });
                                                                
                                                                if (isEligible) {
                                                                    return requiredTest ? 
                                                                        `Eligible for ${requiredTest} testing since: ${formattedDate}` :
                                                                        `Eligible for testing since: ${formattedDate}`;
                                                                } else {
                                                                    return requiredTest ? 
                                                                        `Will be eligible for ${requiredTest} testing on: ${formattedDate}` :
                                                                        `Will be eligible for testing on: ${formattedDate}`;
                                                                }
                                                            })()}
                                                        </div>
                                                    ` : ''}
                                                    ${cat5Date ? `
                                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                                            Next CAT 5 test required: ${new Date(cat5Date.getTime() + (5 * 365 * 24 * 60 * 60 * 1000)).toLocaleDateString('en-US', { 
                                                                year: 'numeric',
                                                                month: 'long'
                                                            })}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            ${violationCount > 0 ? `
                                                <div style="margin-top: 12px; margin-bottom: 8px;">
                                                    <span style="color: #ff6b6b; font-weight: 500;">
                                                        ${violationCount} Active Violation${violationCount !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <button onclick="toggleViolations('${device.device_number}')" 
                                                        id="violationsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Violation Details</span>
                                                        <span class="arrow">â–¼</span>
                                    </button>
                                                    <div id="violations_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;
                                                         overflow-y: auto; overflow-x: hidden; max-height: 80vh; max-width: 100%;
                                                         position: relative; border: 1px solid var(--input-border); width: 100%;
                                                         box-sizing: border-box;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                <div style="margin-top: 12px;">
                                                <button onclick="toggleDeviceDetails('${device.device_number}')" 
                                                    id="detailsBtn_${device.device_number}"
                                                    style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                           border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                           font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                    <span>Show Details</span>
                                                    <span class="arrow">â–¼</span>
                                    </button>
                                                <div id="details_${device.device_number}" style="display: none; margin-top: 8px; 
                                                     padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 1em;">
                                </div>
                            </div>
                                            ${hasPermits ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="togglePermitInfo('${device.device_number}')" 
                                                        id="permitsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Permit Information</span>
                                                        <span class="arrow">â–¼</span>
                                                    </button>
                                                    <div id="permits_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${allDatesAreSame ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="toggleImportantDropdown('${device.device_number}')"
                                                            style="width: 100%; padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                        <span>âš ï¸ Important</span>
                                                        <span class="arrow">â–¼</span>
                                                    </button>
                                                    <div id="important_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b; font-size: 0.9em;">
                                                        <div style="margin-bottom: 8px;">
                                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                                        </div>
                                                        <div style="margin-bottom: 8px;">
                                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Add this function to toggle violations display for a device
        async function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                // Remove any fixed height to allow auto-expansion
                violationsDiv.style.height = 'auto';
                violationsDiv.style.overflowY = 'visible';
                violationsDiv.style.maxHeight = 'none';
                arrow.textContent = 'â–²';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (deviceNumber.startsWith('device_violations_') || deviceNumber.startsWith('quick_device_violations_')) {
                    // The violations are already pre-rendered in the HTML, so we don't need to do anything
                    return;
                }
                
                // Use pre-fetched violations if available
                let activeViolations = [];
                if (window.violationsByDevice && window.violationsByDevice[deviceNumber]) {
                    const deviceViolations = window.violationsByDevice[deviceNumber];
                    activeViolations = deviceViolations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                } else {
                    // Fallback to fetching for this specific device if needed
                    const violations = await fetchViolations(deviceNumber);
                    activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                }
                
                if (activeViolations.length > 0) {
                    let violationsHtml = `
                        <div style="margin-bottom: 8px; color: var(--header-color);">
                            <strong>Active Violations (${activeViolations.length}):</strong>
                        </div>
                        <div style="overflow: visible; padding-right: 5px;">
                    `;
                    
                    activeViolations.forEach(v => {
                        const issueDate = v.violation_issue_date ? new Date(v.violation_issue_date).toLocaleDateString() : 'Unknown';
                        violationsHtml += `
                            <div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); 
                                 border-radius: 4px; border: 1px solid var(--input-border); box-shadow: 0 1px 2px var(--card-shadow);">
                                <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'Unknown'}</div>
                                <div><strong style="color: var(--header-color);">Issued:</strong> ${issueDate}</div>
                                <div><strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'Not specified'}</div>
                                ${v.violation_category ? 
                                    `<div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category}</div>` : ''}
                                ${v.violation_severity ? 
                                    `<div><strong style="color: var(--header-color);">Severity:</strong> ${v.violation_severity}</div>` : ''}
                                ${v.violation_remarks ? 
                                    `<div style="margin-top: 5px;"><strong style="color: var(--header-color);">Remarks:</strong> 
                                        <div style="white-space: pre-wrap; margin-top: 3px;">${v.violation_remarks}</div>
                                    </div>` : ''}
                            </div>
                        `;
                    });
                    
                    violationsHtml += `</div>`;
                    violationsDiv.innerHTML = violationsHtml;
                    // After content is loaded, check if we need to enable scrolling
                    setTimeout(() => {
                        const rect = violationsDiv.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        // If content exceeds 80% of viewport, enable scrolling
                        if (rect.height > viewportHeight * 0.8) {
                            violationsDiv.style.maxHeight = '80vh';
                            violationsDiv.style.overflowY = 'auto';
                        }
                    }, 50);
                } else {
                    violationsDiv.innerHTML = `<div style="text-align: center; color: var(--text-color);">No active violations found</div>`;
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = 'â–¼';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Update the exportBinToCSV function to include all information displayed in the output field
        async function exportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Show loading message
            const exportButton = document.getElementById('binExportButton');
            const originalText = exportButton.textContent;
            exportButton.textContent = 'Exporting...';
            exportButton.disabled = true;

            try {
                // Get building address from first device
                const buildingAddress = data[0] ? `${data[0].house_number || ''} ${data[0].street_name || ''}, ${data[0].borough || ''}`.trim() : 'N/A';
                const binNumber = data[0]?.bin || 'N/A';
                const currentYear = new Date().getFullYear();

                // Create CSV header with reordered fields (user requested order first, then others)
                let csvContent = 'BIN,Device Number,Device Type,Status,Address,Borough,ZIP Code,Block,Lot,' +
                    `Latest CAT 1,Latest CAT 5,Latest PVI,Category Test ${currentYear},PVI ${currentYear},Test Completion Status,` +
                    'Building Address,Latest Inspection,' +
                    'Violation Count,Violation Numbers,Violation Issue Dates,Violation Statuses,Violation Types,Violation Descriptions,' +
                    'Manufacturer,Machine Type,Governor Type,Car Buffer Type,Mode Operation,Safety Type,Fireman Service,Working Pressure,' +
                    'Controller Manufacturer,Elevator Control,Capacity (lbs),Speed (fpm)\n';

                // Create an array of promises to fetch all data for each device
                const promises = data.map(async device => {
                    // Fetch violations
                    const violations = await fetchViolations(device.device_number);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    // Fetch device info
                    const deviceInfo = await fetchDeviceInfo(device.device_number);
                    
                    // Calculate inspection dates
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Format dates for CSV
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check test completion status for current year
                    const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                    
                    // Check if category test was done this year (Dumbwaiters and Conveyors do not need CAT 5 testing)
                    const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                    const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                    let requiresCat5 = false;
                    if (!isDumwaiter && !isConveyor && cat5Date) {
                        const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                        requiresCat5 = yearsSinceCat5 >= 5;
                    }
                    
                    // Determine if a valid category test was completed this year
                    let hasCategoryTestThisYear = false;
                    if (requiresCat5) {
                        // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                        hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                    } else {
                        // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                        hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                  (cat5Date && cat5Date.getFullYear() === currentYear);
                    }
                    
                    // Check if device is dismantled or removed
                    const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                    const isRemoved = device.device_status && device.device_status.toUpperCase() === 'REMOVED';
                    
                    // For dismantled devices, only PVI is required
                    // For Conveyors, only CAT 1 is required
                    // For removed devices, set test completion status to N/A
                    const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                    let testCompletionStatus = 'N/A';
                    if (isRemoved) {
                        testCompletionStatus = 'N/A';
                    } else if (isDismantled) {
                        testCompletionStatus = hasPVIThisYear ? 'Complete (PVI only required)' : 'Incomplete';
                    } else if (isConveyor) {
                        testCompletionStatus = hasCat1ThisYear ? 'Complete (CAT 1 only required)' : 'Incomplete';
                    } else {
                        if (hasPVIThisYear && hasCategoryTestThisYear) {
                            testCompletionStatus = 'Complete (Both tests)';
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    }
                    
                    // Set Category Test to N/A for dismantled and removed devices
                    let categoryTestValue = 'N/A';
                    if (!isDismantled && !isRemoved) {
                        categoryTestValue = hasCategoryTestThisYear ? 'Yes' : 'No';
                    }
                    
                    // Set PVI to N/A for removed devices
                    let pviValue = 'N/A';
                    if (!isRemoved) {
                        pviValue = hasPVIThisYear ? 'Yes' : 'No';
                    }
                    
                    // Format violation details
                    const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                    const violationIssueDates = activeViolations.map(v => {
                        const date = v.violation_issue_date || v.violation_date;
                        return date ? new Date(date).toLocaleDateString() : 'N/A';
                    }).join('; ');
                    const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                    const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                    // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                    const violationDescriptions = activeViolations.map(v => {
                        const desc = v.violation_description || v.violation_remarks || 'N/A';
                        return desc.replace(/"/g, '""');
                    }).join('; ');
                    
                    // Build CSV row in the requested order
                    const row = [
                        // 1-15: User requested order
                        binNumber,
                        device.device_number || 'N/A',
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        `${device.house_number || ''} ${device.street_name || ''}`.trim() || 'N/A',
                        device.borough || 'N/A',
                        device.zip_code || 'N/A',
                        device.block || 'N/A',
                        device.lot || 'N/A',
                        cat1Display,
                        cat5Display,
                        pviDisplay,
                        categoryTestValue,
                        pviValue,
                        testCompletionStatus,
                        // Then all other fields
                        buildingAddress,
                        mostRecentDisplay,
                        activeViolations.length,
                        violationNumbers || 'N/A',
                        violationIssueDates || 'N/A',
                        violationStatuses || 'N/A',
                        violationTypes || 'N/A',
                        violationDescriptions || 'N/A',
                        deviceInfo?.elevator_manufacturer || 'N/A',
                        deviceInfo?.machine_type || 'N/A',
                        deviceInfo?.governor || 'N/A',
                        deviceInfo?.car_buffer_type || 'N/A',
                        deviceInfo?.mode_of_operation || 'N/A',
                        deviceInfo?.car_safety_type || 'N/A',
                        deviceInfo?.fire_emergency_phase || 'N/A',
                        deviceInfo?.working_pressure || 'N/A',
                        deviceInfo?.controller_manufacturer || 'N/A',
                        deviceInfo?.elevator_control || 'N/A',
                        deviceInfo?.elevator_capacity_lbs || 'N/A',
                        deviceInfo?.elevator_speed_fpm || 'N/A'
                    ].map(field => {
                        // Escape quotes and wrap in quotes
                        const fieldStr = String(field || '');
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }).join(',');
                    
                    return row;
                });

                // Wait for all promises to resolve
                const rows = await Promise.all(promises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `bin_${binNumber}_complete_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Restore button
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            }
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('binNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupDevices();
            }
        });

        // Add this new function to your script section
        function clearLookups() {
            // Clear input fields
            document.getElementById('deviceNumber').value = '';
            document.getElementById('binNumber').value = '';
            document.getElementById('houseNumber').value = '';
            document.getElementById('streetName').value = '';
            
            // Clear and hide result displays
            document.getElementById('binResult').innerHTML = '';
            document.getElementById('binResult').style.display = 'none';
            document.getElementById('deviceResult').innerHTML = '';
            document.getElementById('deviceResult').style.display = 'none';
            document.getElementById('addressResult').innerHTML = '';
            document.getElementById('addressResult').style.display = 'none';
            
            document.getElementById('binExportButton').style.display = 'none';
            document.getElementById('quickBinValue').textContent = '-'; // Add this line to clear the BIN in ELV3 Lookup
            window.lastBinSearchResults = null;
        }

        // Helper function to update bulk lookup progress indicator
        function updateBulkProgress(processed, total, deviceTimes) {
            const progressText = document.getElementById('bulkProgressText');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressEstimate = document.getElementById('bulkProgressEstimate');
            
            if (!progressText || !progressBar || !progressEstimate) return;
            
            const percentage = Math.round((processed / total) * 100);
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Processing device ${processed} of ${total}...`;
            
            // Calculate estimated time remaining based on average time per device
            if (deviceTimes.length >= 3) {
                // Use the last 10 times for a more accurate recent average
                const recentTimes = deviceTimes.slice(-10);
                const avgTime = recentTimes.reduce((a, b) => a + b, 0) / recentTimes.length;
                const remainingDevices = total - processed;
                const estimatedMs = Math.round(avgTime * remainingDevices);
                
                if (estimatedMs > 60000) {
                    const minutes = Math.floor(estimatedMs / 60000);
                    const seconds = Math.round((estimatedMs % 60000) / 1000);
                    progressEstimate.textContent = `Estimated time remaining: ${minutes}m ${seconds}s`;
                } else if (estimatedMs > 1000) {
                    progressEstimate.textContent = `Estimated time remaining: ${Math.round(estimatedMs / 1000)}s`;
                } else {
                    progressEstimate.textContent = 'Almost done...';
                }
            } else {
                progressEstimate.textContent = 'Calculating estimated time...';
            }
        }

        // Add these new functions to your script section
        async function lookupBulkDevices() {
            const textarea = document.getElementById('bulkDeviceNumbers');
            const resultDiv = document.getElementById('bulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            // Create progress indicator HTML
            resultDiv.innerHTML = `
                <div id="bulkProgressContainer" style="padding: 20px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                    <div style="margin-bottom: 15px; text-align: center;">
                        <span id="bulkProgressText" style="color: var(--text-color); font-weight: 500; font-size: 1.1em;">
                            Preparing to look up ${deviceNumbers.length} devices...
                        </span>
                    </div>
                    <div style="background: var(--panel-bg); border-radius: 10px; height: 24px; overflow: hidden; border: 1px solid var(--input-border);">
                        <div id="bulkProgressBar" style="background: linear-gradient(90deg, #1a73e8, #4CAF50); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <span id="bulkProgressEstimate" style="color: var(--text-color); font-size: 0.9em; opacity: 0.8;">
                            Calculating estimated time...
                        </span>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];
                let processedCount = 0;
                const deviceTimes = []; // Track time per device for estimation

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const deviceStartTime = Date.now();
                    
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        // Fetch violations for this device
                        const violations = await fetchViolations(deviceNumber);
                        const activeViolations = violations.filter(v => 
                            v.violation_status?.toUpperCase() === 'ACTIVE' || 
                            v.violation_status?.toUpperCase() === 'OPEN');
                        
                        // Store violations with device
                        device.violations = activeViolations;
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                        
                        processedCount++;
                        const deviceDuration = Date.now() - deviceStartTime;
                        deviceTimes.push(deviceDuration);
                        
                        // Update progress indicator
                        updateBulkProgress(processedCount, deviceNumbers.length, deviceTimes);
                    } else {
                        notFound.push(deviceNumber);
                        processedCount++;
                        const deviceDuration = Date.now() - deviceStartTime;
                        deviceTimes.push(deviceDuration);
                        
                        // Update progress indicator
                        updateBulkProgress(processedCount, deviceNumbers.length, deviceTimes);
                    }
                }

                    let html = `
                        <div style="background: var(--input-bg); padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                            <div style="font-size: 1.15em; font-weight: 600; color: var(--header-color);">
                                Total Devices Searched: 
                                <span style="color: var(--text-color);">${deviceNumbers.length}</span>
                            </div>
                        </div>
                `;

                // Generate building summary
                const buildingCount = Object.keys(binGroups).length;
                const totalViolationsAll = Object.values(binGroups).reduce((sum, group) => 
                    sum + group.devices.reduce((dSum, device) => 
                        dSum + (device.violations ? device.violations.length : 0), 0), 0);
                const buildingsWithViolations = Object.values(binGroups).filter(group => 
                    group.devices.some(device => device.violations && device.violations.length > 0)).length;

                // Calculate test completion statistics for the current year
                const currentYear = new Date().getFullYear();
                let devicesWithBothTests = 0;
                let devicesWithOneTest = 0;
                let devicesWithNoTests = 0;
                let devicesNoTestRequired = 0;
                let devicesWithWarning = 0;
                let totalDevicesFound = 0;
                
                // Store device lists for each category
                const bulkDevicesWithBothTestsList = [];
                const bulkDevicesWithOneTestList = [];
                const bulkDevicesWithNoTestsList = [];
                const bulkDevicesNoTestRequiredList = [];
                const bulkDevicesWithWarningList = [];

                // Count test completion across all devices
                Object.values(binGroups).forEach(group => {
                    group.devices.forEach(device => {
                        totalDevicesFound++;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        // Check device type and status
                        const deviceType = (device.device_type || '').toUpperCase();
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED');
                        const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                        const isConveyor = deviceType.includes('CONVEYOR');
                        
                        // Removed devices don't require any tests
                        if (isRemoved) {
                            devicesNoTestRequired++;
                            bulkDevicesNoTestRequiredList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                address: `${device.house_number} ${device.street_name}`,
                                bin: device.bin
                            });
                            return;
                        }
                        
                        // CAT 5 is only required every 5 years (Dumbwaiters and Conveyors don't need CAT 5)
                        let requiresCat5 = false;
                        let yearsSinceCat5 = null;
                        if (!isDumbwaiter && !isConveyor && cat5Date) {
                            yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        if (isDismantled) {
                            // Dismantled devices only need PVI
                            hasCategoryTestThisYear = true;
                        } else if (requiresCat5) {
                            // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                            hasCategoryTestThisYear = hasCat5ThisYear;
                        } else {
                            // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                            hasCategoryTestThisYear = hasCat1ThisYear || hasCat5ThisYear;
                        }
                        
                        // Check for Warning case: CAT 1 & PVI done but CAT 5 required and not done
                        const isWarningDevice = requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        const deviceInfo = {
                            device_number: device.device_number,
                            device_type: device.device_type || 'Unknown',
                            address: `${device.house_number} ${device.street_name}`,
                            bin: device.bin,
                            hasPVI: hasPVIThisYear,
                            hasCat1: hasCat1ThisYear,
                            hasCat5: hasCat5ThisYear,
                            hasCategory: hasCategoryTestThisYear,
                            isDismantled: isDismantled,
                            isDumbwaiter: isDumbwaiter,
                            isConveyor: isConveyor,
                            requiresCat5: requiresCat5,
                            yearsSinceCat5: yearsSinceCat5
                        };
                        
                        if (isWarningDevice) {
                            devicesWithWarning++;
                            bulkDevicesWithWarningList.push(deviceInfo);
                        } else if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            devicesWithBothTests++;
                            bulkDevicesWithBothTestsList.push(deviceInfo);
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            devicesWithOneTest++;
                            bulkDevicesWithOneTestList.push(deviceInfo);
                        } else {
                            devicesWithNoTests++;
                            bulkDevicesWithNoTestsList.push(deviceInfo);
                        }
                    });
                });

                // Sort buildings by violations (those with violations first)
                const sortedBinEntries = Object.entries(binGroups).sort((a, b) => {
                    const aViolations = a[1].devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                    const bViolations = b[1].devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                    return bViolations - aViolations;
                });

                html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                Summary
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border);">
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--header-color);">${buildingCount}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Buildings</div>
                                </div>
                                <div style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border);">
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${totalViolationsAll > 0 ? '#ff6b6b' : '#4CAF50'};">${totalViolationsAll}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Total Violations</div>
                                </div>
                                <div style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border);">
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${buildingsWithViolations > 0 ? '#ff6b6b' : '#4CAF50'};">${buildingsWithViolations}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Buildings w/ Violations</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px; padding: 15px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="font-size: 1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                    ${currentYear} Test Completion Status <span style="font-size: 0.8em; font-weight: 400; opacity: 0.7;">(click to view devices)</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                                    <div onclick="toggleBulkTestList('bothTests')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #4CAF50; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(76,175,80,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #4CAF50;">${devicesWithBothTests}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">âœ“ All Tests Done</div>
                                    </div>
                                    <div onclick="toggleBulkTestList('oneTest')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ffd700; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,215,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ffd700;">${devicesWithOneTest}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">âš  One Test Done</div>
                                    </div>
                                    ${devicesWithWarning > 0 ? `
                                    <div onclick="toggleBulkTestList('warning')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ff9800; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,152,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ff9800;">${devicesWithWarning}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">âš  CAT 5 Required</div>
                                    </div>
                                    ` : ''}
                                    <div onclick="toggleBulkTestList('noTests')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ff6b6b; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ff6b6b;">${devicesWithNoTests}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">âœ— No Tests Done</div>
                                    </div>
                                    ${devicesNoTestRequired > 0 ? `
                                    <div onclick="toggleBulkTestList('noTestRequired')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #9e9e9e; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(158,158,158,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #9e9e9e;">${devicesNoTestRequired}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">â€” No Test Required</div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Expandable device lists -->
                                <div id="bulkBothTestsList" style="display: none; margin-top: 15px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border: 1px solid #4CAF50; max-height: 300px; overflow-y: auto;">
                                    <div style="font-weight: 600; color: #4CAF50; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>âœ“ All Tests Completed (${devicesWithBothTests})</span>
                                        <button onclick="toggleBulkTestList('bothTests')" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.2em;">Ã—</button>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">
                                        ${bulkDevicesWithBothTestsList.length > 0 ? bulkDevicesWithBothTestsList.map(d => {
                                            let testInfo = d.isDismantled ? 'PVI completed (Dismantled - PVI only required)' : 'PVI + Category test completed';
                                            let statusNote = d.isDismantled ? '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span> ' : '';
                                            return `<div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); border-radius: 4px; border-left: 2px solid #4CAF50;">
                                                <strong>Device #${d.device_number}</strong> (${d.device_type}) ${statusNote}<br>
                                                <span style="font-size: 0.85em; opacity: 0.8;">${d.address} | ${testInfo}</span>
                                            </div>`;
                                        }).join('') : '<div style="opacity: 0.7;">No devices in this category</div>'}
                                    </div>
                                </div>
                                
                                <div id="bulkOneTestList" style="display: none; margin-top: 15px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border: 1px solid #ffd700; max-height: 300px; overflow-y: auto;">
                                    <div style="font-weight: 600; color: #ffd700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>âš  One Test Completed (${devicesWithOneTest})</span>
                                        <button onclick="toggleBulkTestList('oneTest')" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.2em;">Ã—</button>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">
                                        ${bulkDevicesWithOneTestList.length > 0 ? bulkDevicesWithOneTestList.map(d => {
                                            let testInfo;
                                            if (d.isConveyor) {
                                                // Conveyors only need CAT 1, so if they're in this list, CAT 1 is pending
                                                testInfo = 'CAT 1 pending';
                                            } else if (d.isDismantled) {
                                                testInfo = 'PVI pending';
                                            } else {
                                                testInfo = d.hasPVI ? 'PVI completed, Category test pending' : 'Category test completed, PVI pending';
                                            }
                                            return `<div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); border-radius: 4px; border-left: 2px solid #ffd700;">
                                                <strong>Device #${d.device_number}</strong> (${d.device_type})<br>
                                                <span style="font-size: 0.85em; opacity: 0.8;">${d.address} | ${testInfo}</span>
                                            </div>`;
                                        }).join('') : '<div style="opacity: 0.7;">No devices in this category</div>'}
                                    </div>
                                </div>
                                
                                <div id="bulkWarningList" style="display: none; margin-top: 15px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border: 1px solid #ff9800; max-height: 300px; overflow-y: auto;">
                                    <div style="font-weight: 600; color: #ff9800; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>âš  CAT 5 Required (${devicesWithWarning})</span>
                                        <button onclick="toggleBulkTestList('warning')" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.2em;">Ã—</button>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">
                                        ${bulkDevicesWithWarningList.length > 0 ? bulkDevicesWithWarningList.map(d => {
                                            return `<div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); border-radius: 4px; border-left: 2px solid #ff9800;">
                                                <strong>Device #${d.device_number}</strong> (${d.device_type})<br>
                                                <span style="font-size: 0.85em; opacity: 0.8;">${d.address} | CAT 1 & PVI done, but CAT 5 required (last CAT 5: ${d.yearsSinceCat5} years ago)</span>
                                            </div>`;
                                        }).join('') : '<div style="opacity: 0.7;">No devices in this category</div>'}
                                    </div>
                                </div>
                                
                                <div id="bulkNoTestsList" style="display: none; margin-top: 15px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border: 1px solid #ff6b6b; max-height: 300px; overflow-y: auto;">
                                    <div style="font-weight: 600; color: #ff6b6b; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>âœ— No Tests Completed (${devicesWithNoTests})</span>
                                        <button onclick="toggleBulkTestList('noTests')" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.2em;">Ã—</button>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">
                                        ${bulkDevicesWithNoTestsList.length > 0 ? bulkDevicesWithNoTestsList.map(d => {
                                            let statusNote = d.isDismantled ? '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span> ' : '';
                                            return `<div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); border-radius: 4px; border-left: 2px solid #ff6b6b;">
                                                <strong>Device #${d.device_number}</strong> (${d.device_type}) ${statusNote}<br>
                                                <span style="font-size: 0.85em; opacity: 0.8;">${d.address} | No tests completed this year</span>
                                            </div>`;
                                        }).join('') : '<div style="opacity: 0.7;">No devices in this category</div>'}
                                    </div>
                                </div>
                                
                                <div id="bulkNoTestRequiredList" style="display: none; margin-top: 15px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border: 1px solid #9e9e9e; max-height: 300px; overflow-y: auto;">
                                    <div style="font-weight: 600; color: #9e9e9e; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>â€” No Test Required (${devicesNoTestRequired})</span>
                                        <button onclick="toggleBulkTestList('noTestRequired')" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.2em;">Ã—</button>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">
                                        ${bulkDevicesNoTestRequiredList.length > 0 ? bulkDevicesNoTestRequiredList.map(d => {
                                            return `<div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); border-radius: 4px; border-left: 2px solid #9e9e9e;">
                                                <strong>Device #${d.device_number}</strong> (${d.device_type}) <span style="color: #9e9e9e; font-weight: bold;">[REMOVED]</span><br>
                                                <span style="font-size: 0.85em; opacity: 0.8;">${d.address} | Device removed from service</span>
                                            </div>`;
                                        }).join('') : '<div style="opacity: 0.7;">No devices in this category</div>'}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <input type="text" 
                                       id="bulkResultsSearch" 
                                       placeholder="Search by address, BIN, or device number..." 
                                       oninput="filterBulkResults(this.value)"
                                       style="width: 100%; padding: 10px 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; box-sizing: border-box;">
                            </div>
                            <div style="font-size: 0.95em; font-weight: 600; color: var(--header-color); margin-bottom: 10px;">
                                Building Breakdown:
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: var(--input-bg); position: sticky; top: 0;">
                                            <th style="padding: 8px 10px; text-align: left; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Address</th>
                                            <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Devices</th>
                                            <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Violations</th>
                                        </tr>
                                    </thead>
                                    <tbody id="summaryTableBody">
                                        ${sortedBinEntries
                                            .map(([bin, group]) => {
                                                const violations = group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                                                const deviceNumbers = group.devices.map(d => d.device_number).join(' ');
                                                return `
                                                    <tr class="summary-row" data-bin="${bin}" data-address="${group.address}" data-devices="${deviceNumbers}" style="border-bottom: 1px solid var(--input-border);">
                                                        <td style="padding: 8px 10px; color: var(--text-color);">${group.address}</td>
                                                        <td style="padding: 8px 10px; text-align: center; color: var(--text-color); font-weight: 500;">${group.devices.length}</td>
                                                        <td style="padding: 8px 10px; text-align: center; font-weight: 600; color: ${violations > 0 ? '#ff6b6b' : '#4CAF50'};">${violations}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="buildingsContainer" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices (using sorted entries)
                for (const [bin, group] of sortedBinEntries) {
                    // Count violations across all devices in this building
                    const totalViolations = group.devices.reduce((sum, device) => 
                        sum + (device.violations ? device.violations.length : 0), 0);
                    const deviceNumbers = group.devices.map(d => d.device_number).join(' ');
                    
                    html += `
                        <div class="building-card" data-bin="${bin}" data-address="${group.address}" data-devices="${deviceNumbers}" style="background: var(--panel-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                            <div onclick="toggleBuildingDevices('${bin}')" style="cursor: pointer; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.1em; margin-bottom: 8px;">
                                            <strong style="color: var(--header-color); font-size: 1.2em;">BIN:</strong> 
                                            <span style="font-weight: 600; color: var(--text-color);">${bin}</span>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong style="color: var(--header-color);">Address:</strong> 
                                            <span style="color: var(--text-color);">${group.address}</span>
                                        </div>
                                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                            <div>
                                                <strong style="color: var(--header-color);">Devices:</strong> 
                                                <span style="color: var(--text-color); font-weight: 600;">${group.devices.length}</span>
                                            </div>
                                            <div>
                                                <strong style="color: var(--header-color);">Active Violations:</strong> 
                                                <span style="color: ${totalViolations > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${totalViolations}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="buildingArrow_${bin}" style="font-size: 1.5em; color: var(--header-color); transition: transform 0.3s ease; transform: rotate(0deg); margin-left: 15px;">
                                        â–¼
                                    </div>
                                </div>
                            </div>
                            <div id="buildingDevices_${bin}" style="display: none; padding-left: 10px; margin-top: 15px;">
                    `;

                    // Sort devices so those with violations appear first
                    const sortedDevices = [...group.devices].sort((a, b) => {
                        const aViolations = a.violations ? a.violations.length : 0;
                        const bViolations = b.violations ? b.violations.length : 0;
                        return bViolations - aViolations; // Higher violations first
                    });

                    sortedDevices.forEach((device, index) => {
                        // Calculate test completion status for this device
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                        const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                        const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                        
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        // Check device type and status
                        const deviceType = (device.device_type || '').toUpperCase();
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED');
                        const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                        const isConveyor = deviceType.includes('CONVEYOR');
                        const noTestRequired = isRemoved;
                        
                        // CAT 5 is only required every 5 years (Dumbwaiters and Conveyors don't need CAT 5)
                        let requiresCat5 = false;
                        let yearsSinceCat5 = null;
                        if (!isDumbwaiter && !isConveyor && cat5Date) {
                            yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        let categoryTestNote = '';
                        if (noTestRequired) {
                            hasCategoryTestThisYear = true;
                            categoryTestNote = '';
                        } else if (isDismantled) {
                            hasCategoryTestThisYear = true;
                            categoryTestNote = '(Dismantled - PVI only required)';
                        } else if (isDumbwaiter || isConveyor) {
                            // Dumbwaiters and Conveyors don't need CAT 5
                            hasCategoryTestThisYear = hasCat1ThisYear || hasCat5ThisYear;
                            categoryTestNote = isDumbwaiter ? '(Dumbwaiter - CAT 5 not required)' : '(Conveyor - CAT 5 not required)';
                        } else if (requiresCat5) {
                            // CAT 5 is required (5+ years since last CAT 5)
                            hasCategoryTestThisYear = hasCat5ThisYear;
                            categoryTestNote = `(CAT 5 required - last CAT 5 was ${yearsSinceCat5} years ago)`;
                        } else {
                            // CAT 5 not required yet, CAT 1 or CAT 5 counts
                            hasCategoryTestThisYear = hasCat1ThisYear || hasCat5ThisYear;
                            if (cat5Date && yearsSinceCat5 !== null) {
                                categoryTestNote = `(CAT 5 due in ${5 - yearsSinceCat5} year${5 - yearsSinceCat5 !== 1 ? 's' : ''})`;
                            }
                        }
                        
                        // Check for Warning case: CAT 1 & PVI done but CAT 5 required and not done
                        const isWarningDevice = requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = noTestRequired || (hasPVIThisYear && hasCategoryTestThisYear);
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        const oneTestCompleted = !noTestRequired && !isWarningDevice && !conveyorCompleted && (hasPVIThisYear || hasCategoryTestThisYear) && !bothTestsCompleted && !dismantledCompleted;
                        
                        // Determine completion status display
                        let completionStatus, completionColor, completionIcon;
                        if (noTestRequired) {
                            completionStatus = 'No Test Required';
                            completionColor = '#9e9e9e';
                            completionIcon = 'â€”';
                        } else if (conveyorCompleted) {
                            completionStatus = 'Testing Completed';
                            completionColor = '#4CAF50';
                            completionIcon = 'âœ“';
                            categoryTestNote = '(Conveyor - CAT 1 only required)';
                        } else if (isWarningDevice) {
                            completionStatus = 'CAT 5 Required';
                            completionColor = '#ff9800';
                            completionIcon = 'âš ';
                            categoryTestNote = `(CAT 1 & PVI done, but CAT 5 required - last CAT 5 was ${yearsSinceCat5} years ago)`;
                        } else if (bothTestsCompleted || dismantledCompleted) {
                            completionStatus = 'All Tests Completed';
                            completionColor = '#4CAF50';
                            completionIcon = 'âœ“';
                        } else if (oneTestCompleted) {
                            let pendingTest;
                            if (isConveyor) {
                                // Conveyors only need CAT 1
                                pendingTest = 'CAT 1';
                            } else {
                                pendingTest = hasPVIThisYear ? 'Category Test' : 'PVI';
                            }
                            completionStatus = `Pending: ${pendingTest}`;
                            completionColor = '#ffd700';
                            completionIcon = 'âš ';
                        } else if (isConveyor && !hasCat1ThisYear) {
                            // Conveyor without CAT 1 - not completed
                            completionStatus = 'Pending: CAT 1';
                            completionColor = '#ffd700';
                            completionIcon = 'âš ';
                        } else {
                            completionStatus = 'No Tests Completed';
                            completionColor = '#ff6b6b';
                            completionIcon = 'âœ—';
                        }
                        
                        html += `
                            <div style="margin-bottom: 20px; padding: 15px; background: var(--input-bg); border-radius: 6px; border: 1px solid var(--input-border); ${index > 0 ? 'margin-top: 15px;' : ''}">
                                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--input-border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 1.05em; color: var(--header-color); font-weight: 600;">
                                            Device #${device.device_number}
                                        </div>
                                        <span style="padding: 4px 10px; background: ${completionColor}22; color: ${completionColor}; border-radius: 4px; font-weight: 600; font-size: 0.85em; border: 1px solid ${completionColor};">
                                            ${completionIcon} ${currentYear}
                                        </span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 20px; margin-top: 8px;">
                                        <div>
                                            <strong style="color: var(--header-color);">Type:</strong> 
                                            <span style="color: var(--text-color);">${device.device_type || 'N/A'}</span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--header-color);">Status:</strong> 
                                            <span style="color: var(--text-color);">${device.device_status || 'N/A'}</span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--header-color);">Block:</strong> 
                                            <span style="color: var(--text-color);">${device.block || 'N/A'}</span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--header-color);">Lot:</strong> 
                                            <span style="color: var(--text-color);">${device.lot || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                ${noTestRequired ? `
                                <div style="margin-bottom: 12px; padding: 15px; background: var(--panel-bg); border-radius: 6px; border-left: 3px solid ${completionColor}; text-align: center;">
                                    <div style="font-weight: 600; color: ${completionColor}; font-size: 1.1em;">
                                        ${completionIcon} No Test Required
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--text-color); margin-top: 5px; opacity: 0.8;">
                                        Device has been removed from service
                                    </div>
                                </div>
                                ` : `
                                <div style="margin-bottom: 12px; padding: 12px; background: var(--panel-bg); border-radius: 6px; border-left: 3px solid ${completionColor};">
                                    <div style="font-weight: 600; color: var(--header-color); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>${currentYear} Test Status</span>
                                        <span style="color: ${completionColor}; font-size: 0.9em;">${completionIcon} ${completionStatus}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                                        <div style="text-align: center; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid ${hasPVIThisYear ? '#4CAF50' : 'var(--input-border)'};">
                                            <div style="font-weight: 600; color: var(--header-color); margin-bottom: 4px;">PVI</div>
                                            <div style="color: ${hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${hasPVIThisYear ? '600' : '400'};">${pviDisplay}</div>
                                            ${hasPVIThisYear ? '<div style="color: #4CAF50; font-size: 0.8em;">âœ“ Done</div>' : '<div style="color: var(--text-color); opacity: 0.7; font-size: 0.8em;">Pending</div>'}
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid ${hasCat1ThisYear ? '#4CAF50' : 'var(--input-border)'};">
                                            <div style="font-weight: 600; color: var(--header-color); margin-bottom: 4px;">CAT 1</div>
                                            <div style="color: ${hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${hasCat1ThisYear ? '600' : '400'};">${cat1Display}</div>
                                            ${hasCat1ThisYear ? '<div style="color: #4CAF50; font-size: 0.8em;">âœ“ Done</div>' : '<div style="color: var(--text-color); opacity: 0.7; font-size: 0.8em;">-</div>'}
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid ${hasCat5ThisYear ? '#4CAF50' : (requiresCat5 && !isDismantled ? '#ff9800' : 'var(--input-border)')};">
                                            <div style="font-weight: 600; color: var(--header-color); margin-bottom: 4px;">CAT 5</div>
                                            <div style="color: ${hasCat5ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${hasCat5ThisYear ? '600' : '400'};">${cat5Display}</div>
                                            ${hasCat5ThisYear ? '<div style="color: #4CAF50; font-size: 0.8em;">âœ“ Done</div>' : ((isDumbwaiter || isConveyor) ? '<div style="color: var(--text-color); opacity: 0.7; font-size: 0.8em;">Not Required</div>' : (isDismantled ? '<div style="color: var(--text-color); opacity: 0.7; font-size: 0.8em;">N/A</div>' : (requiresCat5 ? '<div style="color: #ff9800; font-size: 0.8em;">âš  Required</div>' : '<div style="color: var(--text-color); opacity: 0.7; font-size: 0.8em;">Not Due</div>')))}
                                        </div>
                                    </div>
                                    ${categoryTestNote && !noTestRequired ? `<div style="margin-top: 8px; font-size: 0.85em; color: var(--text-color); opacity: 0.8; text-align: center;">${categoryTestNote}</div>` : ''}
                                </div>
                                `}
                        `;
                        
                        // Display violations if any
                        if (device.violations && device.violations.length > 0) {
                            html += `
                                <div style="margin-top: 12px;">
                                    <div style="margin-bottom: 10px; padding: 8px; background: var(--panel-bg); border-radius: 4px; border-left: 3px solid #ff6b6b;">
                                        <strong style="color: var(--header-color); font-size: 1.05em;">Active Violations: </strong>
                                        <span style="color: #ff6b6b; font-weight: 600; font-size: 1.05em;">${device.violations.length}</span>
                                    </div>
                                    <div style="margin-top: 10px;">
                            `;
                            
                            device.violations.forEach((v, vIndex) => {
                                const issueDate = v.violation_issue_date || v.violation_date;
                                const formattedDate = issueDate ? new Date(issueDate).toLocaleDateString() : 'Unknown';
                                const complianceDate = v.compliance_date ? new Date(v.compliance_date).toLocaleDateString() : null;
                                const dismissalDate = v.dismissal_date ? new Date(v.dismissal_date).toLocaleDateString() : null;
                                
                                // Determine severity color
                                let severityColor = 'var(--text-color)';
                                if (v.violation_severity) {
                                    const severity = v.violation_severity.toUpperCase();
                                    if (severity.includes('HAZARD') || severity.includes('MAJOR') || severity === 'A') {
                                        severityColor = '#ff4444';
                                    } else if (severity.includes('LESS') || severity === 'B' || severity === 'C') {
                                        severityColor = '#ff9800';
                                    }
                                }
                                
                                html += `
                                    <div style="margin-bottom: 12px; padding: 12px; background: var(--panel-bg); 
                                         border-radius: 5px; border: 1px solid var(--input-border); border-left: 3px solid #ff9800; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <div>
                                                <strong style="color: var(--header-color); font-size: 1.05em;">Violation #:</strong> 
                                                <span style="color: var(--text-color); font-weight: 600; font-size: 1.05em;">${v.violation_number || 'Unknown'}</span>
                                            </div>
                                            ${v.violation_severity ? 
                                                `<span style="padding: 4px 10px; background: ${severityColor}22; color: ${severityColor}; border-radius: 4px; font-weight: 600; font-size: 0.85em; border: 1px solid ${severityColor};">
                                                    ${v.violation_severity}
                                                </span>` : ''}
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; margin-bottom: 8px;">
                                            <div>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> 
                                                <span style="color: var(--text-color);">${formattedDate}</span>
                                            </div>
                                            <div>
                                                <strong style="color: var(--header-color);">Status:</strong> 
                                                <span style="color: ${v.violation_status?.toUpperCase() === 'ACTIVE' ? '#ff6b6b' : 'var(--text-color)'}; font-weight: 500;">${v.violation_status || 'N/A'}</span>
                                            </div>
                                            ${v.violation_type ? 
                                                `<div>
                                                    <strong style="color: var(--header-color);">Type:</strong> 
                                                    <span style="color: var(--text-color);">${v.violation_type}</span>
                                                </div>` : ''}
                                            ${v.violation_category ? 
                                                `<div>
                                                    <strong style="color: var(--header-color);">Category:</strong> 
                                                    <span style="color: var(--text-color);">${v.violation_category}</span>
                                                </div>` : ''}
                                            ${v.ecb_number ? 
                                                `<div>
                                                    <strong style="color: var(--header-color);">ECB #:</strong> 
                                                    <span style="color: var(--text-color);">${v.ecb_number}</span>
                                                </div>` : ''}
                                            ${v.isn_dob_bis_extract ? 
                                                `<div>
                                                    <strong style="color: var(--header-color);">ISN:</strong> 
                                                    <span style="color: var(--text-color);">${v.isn_dob_bis_extract}</span>
                                                </div>` : ''}
                                        </div>
                                        ${(complianceDate || dismissalDate || v.respondent) ? 
                                            `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--input-border);">
                                                ${complianceDate ? 
                                                    `<div>
                                                        <strong style="color: var(--header-color);">Compliance Date:</strong> 
                                                        <span style="color: var(--text-color);">${complianceDate}</span>
                                                    </div>` : ''}
                                                ${dismissalDate ? 
                                                    `<div>
                                                        <strong style="color: var(--header-color);">Dismissal Date:</strong> 
                                                        <span style="color: #4CAF50;">${dismissalDate}</span>
                                                    </div>` : ''}
                                                ${v.respondent ? 
                                                    `<div style="grid-column: span 2;">
                                                        <strong style="color: var(--header-color);">Respondent:</strong> 
                                                        <span style="color: var(--text-color);">${v.respondent}</span>
                                                    </div>` : ''}
                                            </div>` : ''}
                                        ${v.penalty_imposed || v.amount_paid ? 
                                            `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--input-border);">
                                                ${v.penalty_imposed ? 
                                                    `<div>
                                                        <strong style="color: var(--header-color);">Penalty Imposed:</strong> 
                                                        <span style="color: #ff6b6b; font-weight: 500;">$${parseFloat(v.penalty_imposed).toLocaleString()}</span>
                                                    </div>` : ''}
                                                ${v.amount_paid ? 
                                                    `<div>
                                                        <strong style="color: var(--header-color);">Amount Paid:</strong> 
                                                        <span style="color: #4CAF50; font-weight: 500;">$${parseFloat(v.amount_paid).toLocaleString()}</span>
                                                    </div>` : ''}
                                            </div>` : ''}
                                        ${(v.violation_description || v.violation_remarks) ? 
                                            `<div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color); display: block; margin-bottom: 5px;">Description:</strong> 
                                                <div style="white-space: pre-wrap; color: var(--text-color); line-height: 1.5; padding: 8px; background: var(--input-bg); border-radius: 4px;">${v.violation_description || v.violation_remarks}</div>
                                            </div>` : ''}
                                        ${v.aggravated_level ? 
                                            `<div style="margin-top: 8px;">
                                                <strong style="color: var(--header-color);">Aggravated Level:</strong> 
                                                <span style="color: #ff6b6b; font-weight: 500;">${v.aggravated_level}</span>
                                            </div>` : ''}
                                    </div>
                                `;
                            });
                            
                            html += `
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div style="margin-top: 12px; padding: 10px; background: var(--panel-bg); border-radius: 4px; border-left: 3px solid #4CAF50; text-align: center;">
                                    <strong style="color: var(--header-color);">Active Violations: </strong>
                                    <span style="color: #4CAF50; font-weight: 600;">None</span>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: var(--panel-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; margin-top: 20px; border: 2px solid #ff6b6b; border-left: 4px solid #ff6b6b; box-shadow: 0 2px 4px var(--card-shadow);">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: var(--header-color); font-size: 1.1em;">Devices Not Found:</strong>
                                <span style="color: #ff6b6b; font-weight: 600; margin-left: 8px;">${notFound.length}</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                ${notFound.map(deviceNum => `
                                    <span style="display: inline-block; padding: 6px 12px; background: var(--input-bg); border-radius: 4px; border: 1px solid #ff6b6b; color: #ff6b6b; font-weight: 500; font-family: monospace;">
                                        ${deviceNum}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearBulkLookup() {
            document.getElementById('bulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('bulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function lookupAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('addressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }
                const [_, houseNumber, streetName] = match;
                
                // Build a safely encoded SoQL query
                const escapeQuotes = value => value.replace(/'/g, "''");
                const whereParts = [
                    `UPPER(house_number)='${escapeQuotes(houseNumber)}'`,
                    `UPPER(street_name) like '${escapeQuotes(streetName)}%'`
                ];

                if (borough) {
                    whereParts.push(`UPPER(borough) like '${escapeQuotes(borough)}%'`);
                }

                const params = new URLSearchParams();
                params.set('$where', whereParts.join(' AND '));
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
            // Group results by BIN to avoid duplicates
            const binGroups = {};
            data.forEach(device => {
                if (!binGroups[device.bin]) {
                    binGroups[device.bin] = {
                        address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                        devices: []
                    };
                }
                binGroups[device.bin].devices.push(device);
            });

            let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                    <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                    </div>
                    <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
            `;

            for (const [bin, group] of Object.entries(binGroups)) {
                html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;
            resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearAddressLookup() {
            document.getElementById('fullAddress').value = '';
            const resultDiv = document.getElementById('addressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('fullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAddress();
            }
        });

        // Add this new function to your script section
        async function exportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Show loading message
            const exportButton = document.getElementById('exportButton');
            const originalText = exportButton ? exportButton.textContent : 'Export to CSV';
            if (exportButton) {
                exportButton.textContent = 'Exporting...';
                exportButton.disabled = true;
            }

            try {
                // Create CSV content with violation and test completion columns
                const currentYear = new Date().getFullYear();
                let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Block,Lot,' +
                    'PVI Date,CAT 1 Date,CAT 5 Date,Test Status,' +
                    'Violation Count,Violation Numbers,Violation Issue Dates,Violation Statuses,Violation Types,Violation Descriptions\n';

                // Create an array of promises to fetch violations for all devices
                const devicePromises = [];
                for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                    group.devices.forEach(device => {
                        devicePromises.push((async () => {
                            // Fetch violations for this device
                            const violations = await fetchViolations(device.device_number);
                            const activeViolations = violations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            
                            // Format violation details (same format as BIN export)
                            const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                            const violationIssueDates = activeViolations.map(v => {
                                const date = v.violation_issue_date || v.violation_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                            const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                            // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                            const violationDescriptions = activeViolations.map(v => {
                                const desc = v.violation_description || v.violation_remarks || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');

                            // Calculate test completion status
                            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                            
                            const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                            const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                            const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                            
                            const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                            const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                            
                            // Check device type and status
                            const deviceType = (device.device_type || '').toUpperCase();
                            const deviceStatus = (device.device_status || '').toUpperCase();
                            const isDismantled = deviceStatus.includes('DISMANTLED');
                            const isRemoved = deviceStatus.includes('REMOVED');
                            const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                            const isConveyor = deviceType.includes('CONVEYOR');
                            
                            // CAT 5 is only required every 5 years (Dumbwaiters and Conveyors don't need CAT 5)
                            let requiresCat5 = false;
                            if (!isDumbwaiter && !isConveyor && cat5Date) {
                                const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                                requiresCat5 = yearsSinceCat5 >= 5;
                            }
                            
                            // Determine test status
                            let testStatus;
                            if (isRemoved) {
                                testStatus = 'No Test Required';
                            } else {
                                let hasCategoryTestThisYear = false;
                                if (isDismantled) {
                                    hasCategoryTestThisYear = true;
                                } else if (requiresCat5) {
                                    // CAT 5 is required (5+ years since last), so only CAT 5 counts
                                    hasCategoryTestThisYear = hasCat5ThisYear;
                                } else {
                                    // CAT 5 not required, CAT 1 or CAT 5 counts
                                    hasCategoryTestThisYear = hasCat1ThisYear || hasCat5ThisYear;
                                }
                                
                                // Check for Warning case: CAT 1 & PVI done but CAT 5 required and not done
                                const isWarningDevice = requiresCat5 && !hasCategoryTestThisYear && hasCat1ThisYear && hasPVIThisYear;
                                
                                // Conveyors only need CAT 1 testing (no PVI required)
                                const conveyorCompleted = isConveyor && hasCat1ThisYear;
                                const bothTestsCompleted = hasPVIThisYear && hasCategoryTestThisYear;
                                const dismantledCompleted = isDismantled && hasPVIThisYear;
                                
                                if (conveyorCompleted) {
                                    testStatus = 'Testing Completed';
                                } else if (isWarningDevice) {
                                    testStatus = 'CAT 5 Required (Warning)';
                                } else if (bothTestsCompleted || dismantledCompleted) {
                                    testStatus = 'All Tests Completed';
                                } else if (isConveyor && !hasCat1ThisYear) {
                                    // Conveyor without CAT 1 - pending CAT 1 only
                                    testStatus = 'Pending: CAT 1';
                                } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                                    const pendingTest = hasPVIThisYear ? 'Category Test' : 'PVI';
                                    testStatus = `Pending: ${pendingTest}`;
                                } else {
                                    testStatus = 'No Tests Completed';
                                }
                            }

                            const row = [
                                device.device_number,
                                bin,
                                `${device.house_number} ${device.street_name}`,
                                device.borough,
                                device.device_type || 'N/A',
                                device.device_status || 'N/A',
                                device.block || 'N/A',
                                device.lot || 'N/A',
                                pviDisplay,
                                cat1Display,
                                cat5Display,
                                testStatus,
                                activeViolations.length,
                                violationNumbers || 'N/A',
                                violationIssueDates || 'N/A',
                                violationStatuses || 'N/A',
                                violationTypes || 'N/A',
                                violationDescriptions || 'N/A'
                            ].map(field => {
                                // Escape quotes and wrap in quotes
                                const fieldStr = String(field || '');
                                return `"${fieldStr.replace(/"/g, '""')}"`;
                            }).join(',');
                            
                            return row;
                        })());
                    });
                }

                // Wait for all promises to resolve
                const rows = await Promise.all(devicePromises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Add not found devices
                if (deviceData.notFound && deviceData.notFound.length > 0) {
                    deviceData.notFound.forEach(deviceNumber => {
                        csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                    });
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'device_lookup_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Restore button
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            }
        }


        // Add this function to fetch violations
        async function fetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the lookupDeviceDetails function
        async function lookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
                const violations = await fetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong>Violation #:</strong> ${v.violation_number}<br>
                                    <strong>Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong>Status:</strong> ${v.violation_status}<br>
                                    <strong>Type:</strong> ${v.violation_type}<br>
                                    <strong>Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            deviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong>Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            deviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function exportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await fetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function handleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to your JavaScript section
        function clearDeviceSearch() {
            const deviceNumber = document.getElementById('deviceNumber');
            const binNumber = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            
            // Force clear all device-related fields with explicit empty values
            if (deviceNumber) {
                deviceNumber.value = '';
                // Force trigger input event to clear any cached values
                deviceNumber.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            if (quickDeviceInput) {
                quickDeviceInput.value = '';
            }
            
            // If this was triggered by an X button next to BIN search
            if (binNumber && (binNumber === document.activeElement || binNumber.value)) {
                binNumber.value = '';
                document.getElementById('deviceResult').style.display = 'none';
            }
            
            // Clear all result displays
            document.getElementById('binResult').innerHTML = '';
            document.getElementById('binResult').style.display = 'none';
            const quickDeviceResult = document.getElementById('quickDeviceResult');
            if (quickDeviceResult) {
                quickDeviceResult.innerHTML = '';
                quickDeviceResult.style.display = 'none';
            }
            
            // Clear BIN display
            quickBinValue.textContent = '-';
            updateBinDisplayStyle();
            
            // Hide export button
            document.getElementById('binExportButton').style.display = 'none';
            
            // Show address search section when device number is cleared
            toggleAddressSearchVisibility('');
            
            // Small delay to ensure all clearing operations complete
            setTimeout(() => {
                if (deviceNumber) deviceNumber.value = '';
                if (quickDeviceInput) quickDeviceInput.value = '';
            }, 10);
        }

        // Add address lookup function
        async function lookupByAddress() {
            const houseNumber = document.getElementById('houseNumber').value.trim();
            const streetName = document.getElementById('streetName').value.trim();
            const resultDiv = document.getElementById('addressResult');
            const binInput = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!houseNumber || !streetName) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter both house number and street name</span>';
                resultDiv.style.display = 'block';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // First try exact match
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?house_number=${houseNumber}&street_name=${streetName}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Exact match found - proceed as normal
                    const binNumber = data[0].bin;
                    
                    if (binNumber) {
                        resultDiv.innerHTML = '<span style="color: var(--text-color);">Found address. Searching for all devices in building...</span>';
                        
                        binInput.value = binNumber;
                        quickBinValue.textContent = binNumber;
                        updateBinDisplayStyle();
                        
                        await lookupDevices();
                        resultDiv.style.display = 'none';
                    } else {
                        resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No BIN number found for this address</span>';
                    }
                } else {
                    // No exact match found - search for similar addresses
                    resultDiv.innerHTML = '<span style="color: var(--text-color);">No exact match found. Searching for similar addresses...</span>';
                    
                    await searchForSimilarAddresses(houseNumber, streetName, resultDiv, binInput, quickBinValue);
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Function to search for similar addresses when exact match fails
        async function searchForSimilarAddresses(targetHouseNumber, streetName, resultDiv, binInput, quickBinValue) {
            try {
                // Search for all addresses on the same street
                const streetResponse = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?street_name=${streetName}&$limit=1000`);
                
                if (!streetResponse.ok) {
                    throw new Error('Street search failed');
                }

                const streetData = await streetResponse.json();
                
                if (streetData && streetData.length > 0) {
                    const targetNum = parseInt(targetHouseNumber);
                    
                    // Get unique addresses and calculate distance from target
                    const uniqueAddresses = {};
                    const deviceCounts = {};
                    
                    streetData.forEach(device => {
                        const houseNum = device.house_number;
                        const key = `${houseNum}_${device.street_name}`;
                        
                        // Count devices per address
                        if (!deviceCounts[key]) {
                            deviceCounts[key] = 0;
                        }
                        deviceCounts[key]++;
                        
                        if (!uniqueAddresses[key] && houseNum) {
                            const numDiff = Math.abs(parseInt(houseNum) - targetNum);
                            uniqueAddresses[key] = {
                                house_number: houseNum,
                                street_name: device.street_name,
                                borough: device.borough,
                                bin: device.bin,
                                distance: numDiff,
                                deviceCount: deviceCounts[key]
                            };
                        } else if (uniqueAddresses[key]) {
                            // Update device count for existing address
                            uniqueAddresses[key].deviceCount = deviceCounts[key];
                        }
                    });
                    
                    // Sort by distance and get top 10 closest
                    const suggestions = Object.values(uniqueAddresses)
                        .filter(addr => addr.distance <= 50) // Only show addresses within 50 numbers
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 10);
                    
                    if (suggestions.length > 0) {
                        let suggestionsHtml = `
                            <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                                <h4 style="color: var(--header-color); margin-bottom: 15px;">No exact match for "${targetHouseNumber} ${streetName}"</h4>
                                <p style="margin-bottom: 15px; color: var(--text-color);">Did you mean one of these addresses?</p>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        `;
                        
                        suggestions.forEach(addr => {
                            const fullAddress = `${addr.house_number} ${addr.street_name}`;
                            const deviceText = addr.deviceCount === 1 ? 'device' : 'devices';
                            suggestionsHtml += `
                                <div style="padding: 10px; background: var(--panel-bg); border-radius: 4px; border: 1px solid var(--input-border); cursor: pointer; transition: background-color 0.2s ease;"
                                     onclick="selectSuggestedAddress('${addr.house_number}', '${addr.street_name}')"
                                     onmouseover="this.style.backgroundColor='rgba(26, 115, 232, 0.1)'"
                                     onmouseout="this.style.backgroundColor='var(--panel-bg)'">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <strong style="color: var(--header-color);">${fullAddress}</strong>
                                            ${addr.borough ? `<span style="color: var(--text-color); opacity: 0.8;"> â€¢ ${addr.borough}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 15px; font-size: 0.9em;">
                                            <span style="color: var(--header-color); font-weight: 500;">
                                                ${addr.deviceCount} ${deviceText}
                                            </span>
                                            <span style="color: var(--text-color); opacity: 0.7;">
                                                ${addr.distance === 0 ? 'Exact match' : `Â±${addr.distance} numbers`}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        suggestionsHtml += `
                                </div>
                                <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                                    Click on any address above to search for devices at that location.
                                </p>
                            </div>
                        `;
                        
                        resultDiv.innerHTML = suggestionsHtml;
                    } else {
                        resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No similar addresses found on this street</span>';
                    }
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No addresses found on this street</span>';
                }
            } catch (error) {
                console.error('Error searching for similar addresses:', error);
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error searching for similar addresses</span>';
            }
        }

        // Function to handle clicking on a suggested address
        async function selectSuggestedAddress(houseNumber, streetName) {
            // Update the input fields
            document.getElementById('houseNumber').value = houseNumber;
            document.getElementById('streetName').value = streetName;
            
            // Trigger a new search with the selected address
            await lookupByAddress();
        }

        // Function to load full device details from the address search results
        async function loadDeviceDetails(deviceNumber) {
            const detailsContainer = document.getElementById(`details_${deviceNumber}`);
            if (!detailsContainer) return;

            detailsContainer.innerHTML = '<span style="color: var(--text-color);">Loading full details...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('deviceInfo_${deviceNumber}_inline')"
                                    style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">â–¼</span>
                            </button>
                            <div id="deviceInfo_${deviceNumber}_inline" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${Object.entries({
                                    'Manufacturer': deviceInfo.elevator_manufacturer,
                                    'Machine Type': deviceInfo.machine_type,
                                    'Governor Type': deviceInfo.governor,
                                    'Car Buffer Type': deviceInfo.car_buffer_type,
                                    'Mode Operation': deviceInfo.mode_of_operation,
                                    'Safety Type': deviceInfo.car_safety_type,
                                    'Fireman\'s Service': deviceInfo.fire_emergency_phase,
                                    'Working Pressure': deviceInfo.working_pressure,
                                    'Controller Manufacturer': deviceInfo.controller_manufacturer,
                                    'Elevator Control': deviceInfo.elevator_control,
                                    'Capacity': deviceInfo.elevator_capacity_lbs ? `${deviceInfo.elevator_capacity_lbs} lbs` : null,
                                    'Speed': deviceInfo.elevator_speed_fpm ? `${deviceInfo.elevator_speed_fpm} fpm` : null
                                }).filter(([key, value]) => value).map(([key, value]) => `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">${key}:</strong> 
                                        <span>${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '';
                    
                    detailsContainer.innerHTML = `
                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border); margin-top: 15px;">
                            <h4 style="color: var(--header-color); margin-bottom: 15px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">Complete Device Details</h4>
                            
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> 
                                <span>${device.block || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> 
                                <span>${device.lot || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('device_violations_${deviceNumber}_inline')" 
                                            id="violationsBtn_device_violations_${deviceNumber}_inline"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">â–¼</span>
                                    </button>
                                    <div id="violations_device_violations_${deviceNumber}_inline" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <strong style="color: var(--header-color); margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            ${deviceSpecsHTML}
                        </div>
                    `;
                } else {
                    detailsContainer.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Device details not found</span>';
                }
            } catch (error) {
                detailsContainer.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error loading device details. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        // Clear address search function
        function clearAddressSearch() {
            document.getElementById('houseNumber').value = '';
            document.getElementById('streetName').value = '';
            document.getElementById('addressResult').innerHTML = '';
            document.getElementById('addressResult').style.display = 'none';
        }

        // Add this new function to your script section
        async function quickLookupBIN() {
            const deviceNumber = document.getElementById('quickDeviceNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            const binInput = document.getElementById('quickBinNumber');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    if (device.bin) {
                        quickLookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('quickDeviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: #2c2c2c; color: #ffffff; border: 1px solid #444; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">â–¼</span>
                            </button>
                            <div id="quickDeviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: #2c2c2c; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                        
                    resultDiv.innerHTML = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Number:</strong> 
                                <span style="${dateStyle}">${device.device_number || deviceNumber}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : '#ffffff'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('quick_device_violations_${deviceNumber}')" 
                                            id="violationsBtn_quick_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">â–¼</span>
                                    </button>
                                    <div id="violations_quick_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                                <strong style="color: #4a9eff; margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            <!-- Add Important dropdown for red devices -->
                            ${allDatesAreSame ? `
                                <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                                    <button onclick="toggleImportantDropdown('${device.device_number || deviceNumber}')"
                                            style="width: 100%; padding: 10px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                        <span>âš ï¸ Important</span>
                                        <span class="arrow">â–¼</span>
                                    </button>
                                    <div id="important_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b;">
                                        <div style="margin-bottom: 8px;">
                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                        </div>
                                        <div style="margin-bottom: 8px; color: #ffffff;">
                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${deviceSpecsHTML}
                            
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                element.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }

        // Add event listener for Enter key
        document.getElementById('quickDeviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupBIN();
            }
        });

        // Add the new lookupDevices function
        async function quickLookupDevices() {
            const binNumber = document.getElementById('quickBinNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices
                    const removedDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Add back the device grouping code
                    const deviceTypes = {};
                    data.forEach(device => {
                            const type = device.device_type || 'Unknown';
                            if (!deviceTypes[type]) {
                                deviceTypes[type] = [];
                            }
                            deviceTypes[type].push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #4a9eff;">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: #4a9eff;">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: #4a9eff;">Total Active Violations:</strong> 
                                        <span style="color: ${activeDevices > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${activeDevices > 0 ? activeDevices : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">â€¢ Active Devices: ${activeDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">â€¢ Dismantled Devices: ${dismantledDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">â€¢ Removed Devices: ${removedDevices}</span>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: #4a9eff; display: block; margin-bottom: 10px;">Devices by Type:</strong>
                                <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        html += generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR']);
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    // Then display the rest of the device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        html += generateDeviceTypeSection(type, devices);
                    }
                    
                    html += `</div></div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
            }
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('quickBinNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupDevices();
            }
        });

        // Add this new function to your script section
        function clearQuickLookups() {
            // Clear input fields
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickBinResult').style.display = 'none';
            document.getElementById('quickDeviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
            window.lastBinSearchResults = null;
        }

        // Add these new functions to your script section
        async function quickLookupBulkDevices() {
            const textarea = document.getElementById('quickBulkDeviceNumbers');
            const resultDiv = document.getElementById('quickBulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                    } else {
                        notFound.push(deviceNumber);
                    }
                }

                    let html = `
                    <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #4a9eff;">Total Devices Searched:</strong> 
                            <span>${deviceNumbers.length}</span>
                            </div>
                        <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices
                for (const [bin, group] of Object.entries(binGroups)) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                <strong style="color: #4a9eff;">Devices Found:</strong> ${group.devices.length}
                            </div>
                            <div style="padding-left: 15px;">
                    `;

                    group.devices.forEach(device => {
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                <strong style="color: #4a9eff;">Device Number:</strong> ${device.device_number}<br>
                                <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Block:</strong> ${device.block || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Lot:</strong> ${device.lot || 'N/A'}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="color: #ff6b6b;">
                                <strong>Devices Not Found:</strong>
                                <div style="margin-top: 5px;">
                                    ${notFound.join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                document.getElementById('exportButton').style.display = 'none';
            }
        }

        function clearQuickBulkLookup() {
            document.getElementById('quickBulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('quickBulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function quickLookupAddress() {
            const fullAddress = document.getElementById('quickFullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('quickAddressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }

                const [_, houseNumber, streetName] = match;
                
                // Build the query
                const query = `$where=UPPER(house_number)='${houseNumber}' AND UPPER(street_name) like '${streetName}%'${borough ? ` AND UPPER(borough) like '${borough}%'` : ''}`;
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${query}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Group results by BIN to avoid duplicates
                    const binGroups = {};
                    data.forEach(device => {
                        if (!binGroups[device.bin]) {
                            binGroups[device.bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[device.bin].devices.push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                            </div>
                            <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;

                    for (const [bin, group] of Object.entries(binGroups)) {
                        html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearQuickAddressLookup() {
            document.getElementById('quickFullAddress').value = '';
            const resultDiv = document.getElementById('quickAddressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('quickFullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupAddress();
            }
        });

        // Add this new function to your script section
        async function quickExportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            try {
                // Create CSV content with violation columns
                let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Block,Lot,' +
                    'Violation Count,Violation Numbers,Violation Issue Dates,Violation Statuses,Violation Types,Violation Descriptions\n';
                
                // Create an array of promises to fetch violations for all devices
                const devicePromises = [];
                for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                    group.devices.forEach(device => {
                        devicePromises.push((async () => {
                            // Fetch violations for this device
                            const violations = await fetchViolations(device.device_number);
                            const activeViolations = violations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            
                            // Format violation details (same format as BIN export)
                            const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                            const violationIssueDates = activeViolations.map(v => {
                                const date = v.violation_issue_date || v.violation_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                            const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                            // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                            const violationDescriptions = activeViolations.map(v => {
                                const desc = v.violation_description || v.violation_remarks || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');

                            const row = [
                                device.device_number,
                                bin,
                                `${device.house_number} ${device.street_name}`,
                                device.borough,
                                device.device_type || 'N/A',
                                device.device_status || 'N/A',
                                device.block || 'N/A',
                                device.lot || 'N/A',
                                activeViolations.length,
                                violationNumbers || 'N/A',
                                violationIssueDates || 'N/A',
                                violationStatuses || 'N/A',
                                violationTypes || 'N/A',
                                violationDescriptions || 'N/A'
                            ].map(field => {
                                // Escape quotes and wrap in quotes
                                const fieldStr = String(field || '');
                                return `"${fieldStr.replace(/"/g, '""')}"`;
                            }).join(',');
                            
                            return row;
                        })());
                    });
                }

                // Wait for all promises to resolve
                const rows = await Promise.all(devicePromises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Add not found devices
                if (deviceData.notFound && deviceData.notFound.length > 0) {
                    deviceData.notFound.forEach(deviceNumber => {
                        csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                    });
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'device_lookup_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
            }
        }

        function quickExportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add all devices
            data.forEach(device => {
                const row = [
                    device.device_number,
                    device.bin,
                    `${device.house_number} ${device.street_name}`,
                    device.borough,
                    device.device_type || 'N/A',
                    device.device_status || 'N/A'
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bin_${data[0].bin}_devices.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add this function to fetch violations
        async function quickFetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the quickLookupDeviceDetails function
        async function quickLookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
            const violations = await quickFetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong style="color: #4a9eff;">Violation #:</strong> ${v.violation_number}<br>
                                    <strong style="color: #4a9eff;">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong style="color: #4a9eff;">Status:</strong> ${v.violation_status}<br>
                                    <strong style="color: #4a9eff;">Type:</strong> ${v.violation_type}<br>
                                    <strong style="color: #4a9eff;">Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            quickDeviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #4a9eff;">Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            quickDeviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function quickExportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await quickFetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'quick_device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function quickHandleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to ensure proper light/dark mode in results
        function applyColorTheme() {
            // Force theme on any elements with hardcoded dark backgrounds
            document.querySelectorAll('[style*="background: #1c1c1c"], [style*="background: #2c2c2c"]').forEach(el => {
                el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--input-bg');
                el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
            });
        }

        // Call this function after generating results
        // Add these lines at the end of the lookupDevices() function
        resultDiv.innerHTML = html;
        applyColorTheme();

        // Updated function to also display days since the last update
        async function fetchAPILastUpdateDate() {
            try {
                // Get reference to the element displaying the update date
                const apiLastUpdatedElement = document.getElementById('apiLastUpdated');
                if (!apiLastUpdatedElement) return;
                
                // Set loading state
                apiLastUpdatedElement.textContent = "Loading...";
                
                try {
                    // Get the dataset metadata using the correct endpoint format (same as violations API)
                    const datasetId = 'e5aq-a4j2'; // DOB Elevator Device dataset ID
                    const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                    
                    const metadataResponse = await fetch(metadataUrl);
                    if (!metadataResponse.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    
                    const metadata = await metadataResponse.json();
                    
                    // Extract the last updated date from the metadata
                    // rowsUpdatedAt is typically a Unix timestamp in seconds, so multiply by 1000
                    let updateDate;
                    if (metadata.rowsUpdatedAt) {
                        // Handle Unix timestamp (seconds) - multiply by 1000 to get milliseconds
                        updateDate = new Date(metadata.rowsUpdatedAt * 1000);
                    } else if (metadata.dataUpdatedAt) {
                        // Try dataUpdatedAt as fallback
                        updateDate = new Date(metadata.dataUpdatedAt * 1000);
                    } else if (metadata.viewLastModified) {
                        // Try viewLastModified as fallback
                        updateDate = new Date(metadata.viewLastModified);
                    } else {
                        throw new Error('No update date found in metadata');
                    }
                    
                    // Only update if we got a valid date
                    if (!isNaN(updateDate.getTime())) {
                        const formattedDate = updateDate.toLocaleDateString('en-US', { 
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric'
                        });
                        apiLastUpdatedElement.textContent = formattedDate;
                        console.log("API data last updated:", formattedDate);
                    } else {
                        throw new Error('Invalid date format from API');
                    }
                    
                    // Calculate days since update
                    // Normalize both dates to midnight to compare calendar days, not hours
                    const today = new Date();
                    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                    const timeDiff = todayMidnight - updateDateMidnight;
                    const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Get or create the days since element
                    let daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (!daysSinceElement) {
                        daysSinceElement = document.createElement('div');
                        daysSinceElement.id = 'daysSinceUpdate';
                        daysSinceElement.style.textAlign = 'center';
                        daysSinceElement.style.fontSize = '0.9em';
                        daysSinceElement.style.color = 'var(--text-color)';
                        daysSinceElement.style.opacity = '0.8';
                        daysSinceElement.style.marginTop = '5px';
                        
                        // Insert after the apiLastUpdated parent element
                        const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                        parentElement.appendChild(daysSinceElement);
                    }
                    
                    // Display appropriate message based on days with new color thresholds
                    if (daysSinceUpdate <= 0) {
                        daysSinceElement.textContent = "Updated today";
                        daysSinceElement.style.color = "#4CAF50"; // Green for today
                    } else if (daysSinceUpdate === 1) {
                        daysSinceElement.textContent = "Updated 1 day ago";
                        daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                    } else if (daysSinceUpdate < 14) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                    } else if (daysSinceUpdate < 30) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                    } else {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                    }
                } catch (innerError) {
                    console.error('Error in primary fetch:', innerError);
                    
                    // If we can't fetch the date, try to fetch from the actual dataset with a fallback
                    try {
                        const apiResponse = await fetch('https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$query=SELECT%20:created_at,%20:updated_at%20LIMIT%201');
                        if (apiResponse.ok) {
                            const apiData = await apiResponse.json();
                            if (apiData && apiData.length > 0) {
                                // Try to get the updated_at timestamp from the actual data
                                let updateTimeString = apiData[0][":updated_at"] || apiData[0][":created_at"];
                                if (updateTimeString) {
                                    const updateDate = new Date(updateTimeString);
                                    if (!isNaN(updateDate.getTime())) {
                                        const formattedDate = updateDate.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        });
                                        
                                        apiLastUpdatedElement.textContent = formattedDate;
                                        
                                        // Calculate and display days since update
                                        // Normalize both dates to midnight to compare calendar days, not hours
                                        const today = new Date();
                                        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                        const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                                        const timeDiff = todayMidnight - updateDateMidnight;
                                        const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                        
                                        let daysSinceElement = document.getElementById('daysSinceUpdate');
                                        if (!daysSinceElement) {
                                            daysSinceElement = document.createElement('div');
                                            daysSinceElement.id = 'daysSinceUpdate';
                                            daysSinceElement.style.textAlign = 'center';
                                            daysSinceElement.style.fontSize = '0.9em';
                                            daysSinceElement.style.color = 'var(--text-color)';
                                            daysSinceElement.style.opacity = '0.8';
                                            daysSinceElement.style.marginTop = '5px';
                                            
                                            const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                                            parentElement.appendChild(daysSinceElement);
                                        }
                                        
                                        // Display appropriate message based on days
                                        if (daysSinceUpdate <= 0) {
                                            daysSinceElement.textContent = "Updated today";
                                            daysSinceElement.style.color = "#4CAF50"; // Green for today
                                        } else if (daysSinceUpdate === 1) {
                                            daysSinceElement.textContent = "Updated 1 day ago";
                                            daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                                        } else if (daysSinceUpdate < 14) {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                                        } else if (daysSinceUpdate < 30) {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                                        } else {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                                        }
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Fallback fetch also failed:', fallbackError);
                    }
                    
                    // If all else fails, display an error message
                    apiLastUpdatedElement.textContent = "Unable to fetch update date";
                    
                    // Remove the days since update element if it exists
                    const daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (daysSinceElement) {
                        daysSinceElement.parentElement.removeChild(daysSinceElement);
                    }
                }
            } catch (outerError) {
                console.error('Outer error in fetchAPILastUpdateDate:', outerError);
            }
        }

        // Call this function when the DOB tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on the DOB tab initially or when tab changes
            const dobTab = document.getElementById('dobTab');
            if (dobTab) {
                dobTab.addEventListener('click', function() {
                    fetchAPILastUpdateDate();
                    fetchViolationsAPILastUpdateDate();
                });
            }
            
            // Check if DOB tab is the default tab on load or if DOB content is currently active
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            const dobContent = document.getElementById('dobContent');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            
            if (defaultTab === 'dob' || isDOBActive) {
                fetchAPILastUpdateDate();
                fetchViolationsAPILastUpdateDate();
            }
        });
        // Restore the missing functions for ELV3 lookup functionality
        function toggleQuickLookup() {
            const panel = document.getElementById('quickLookupPanel');
            const overlay = document.getElementById('quickLookupOverlay');
            const dobContent = document.getElementById('dobContent');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            const dobLookupToggleBtn = document.getElementById('dobLookupToggleBtn');
            const dobNowBtn = document.getElementById('dobNowBtn');

            const opening = (panel.style.display === 'none' || panel.style.display === '');

            if (opening) {
                panel.style.display = 'block';

                // If we're on the DOB tab, don't show overlay (no shading)
                if (isDOBActive) {
                    // Don't shift the page and don't show overlay - panel overlays without dimming
                    overlay.style.display = 'none';
                    document.body.style.overflow = '';
                } else {
                    // Mobile or other tabs: use overlay to focus the panel
                    overlay.style.display = 'block';
                    // Prevent background scrolling when overlay is used
                    document.body.style.overflow = 'hidden';
                }

                // Hide the floating DOB buttons while panel is open on DOB tab (all sizes)
                if (isDOBActive) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                }

                // Position panel based on screen width
                if (window.innerWidth <= 600) {
                    panel.classList.add('panel-centered-mobile');
                } else {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }

                // Add a small delay before adding opacity for smooth transition
                setTimeout(() => {
                    if (overlay.style.display === 'block') overlay.style.opacity = '1';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(0)';
                }, 10);

                // Ensure the panel is visible regardless of which tab is active
                panel.style.zIndex = '2000';

                // Bring the panel to the front of all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    if (panel.parentElement === section) {
                        document.body.appendChild(panel);
                    }
                });
            } else {
                // Closing
                if (isDOBActive) {
                    document.body.classList.remove('dob-shifted-for-lookup');
                    if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                    if (dobContent) {
                        dobContent.style.marginRight = '';
                        dobContent.style.marginLeft = '';
                    }
                }
                // Show the floating DOB buttons again
                if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                if (dobNowBtn) dobNowBtn.style.display = '';

                // Restore background scrolling when panel is closed
                document.body.style.overflow = '';

                overlay.style.opacity = '0';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-20px)';

                // Wait for transition to complete before hiding
                setTimeout(() => {
                    panel.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        // Add click handler to close panel when clicking overlay
        document.getElementById('quickLookupOverlay').addEventListener('click', function() {
            toggleQuickLookup();
        });

        // Open the ELV3 Lookup panel in a dedicated window
        function popoutQuickLookup() {
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('popout', 'lookup');
                const features = 'width=440,height=720,resizable=yes,scrollbars=yes';
                window.open(url.toString(), '_blank', features);
            } catch (e) {
                // Fallback if URL API not supported
                const href = window.location.href + (window.location.search ? '&' : '?') + 'popout=lookup';
                window.open(href, '_blank', 'width=440,height=720,resizable=yes,scrollbars=yes');
            }
        }

        // If opened with popout=lookup, render only the ELV3 Lookup panel full-screen
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('popout') === 'lookup') {
                document.body.classList.add('lookup-popout-mode');

                const panel = document.getElementById('quickLookupPanel');
                const overlay = document.getElementById('quickLookupOverlay');

                if (panel) {
                    panel.style.display = 'block';
                    panel.style.opacity = '1';
                    panel.style.transform = 'none';
                    panel.style.zIndex = '1';

                    // Make the close button close the window in popout mode
                    const closeBtn = panel.querySelector('button[onclick="toggleQuickLookup()"]');
                    if (closeBtn) {
                        closeBtn.title = 'Close window';
                        closeBtn.onclick = function() { window.close(); };
                    }
                    // Reposition popout icon away from the edge in popout mode and align with X
                    const popBtn = panel.querySelector('button[onclick="popoutQuickLookup()"]');
                    if (popBtn) {
                        popBtn.style.right = '44px';
                        popBtn.style.top = '10px';
                        popBtn.style.fontSize = '20px';
                    }
                }
                if (overlay) {
                    overlay.style.display = 'none';
                }

                // Hide everything except the panel
                const hideSelectors = ['.content-section', '#dobNowBtn'];
                hideSelectors.forEach(sel => {
                    document.querySelectorAll(sel).forEach(el => { el.style.display = 'none'; });
                });
            }
        });

        // Add scroll event handling to prevent background scrolling
        document.addEventListener('DOMContentLoaded', function() {
            const panel = document.getElementById('quickLookupPanel');
            
            if (panel) {
                // Prevent scroll events from bubbling up to the document
                panel.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                    
                    // Check if the panel is scrollable and at the boundary
                    const scrollTop = panel.scrollTop;
                    const scrollHeight = panel.scrollHeight;
                    const clientHeight = panel.clientHeight;
                    
                    // If scrolling up and already at the top
                    if (e.deltaY < 0 && scrollTop === 0) {
                        e.preventDefault();
                        panel.scrollTop = 0;
                    }
                    // If scrolling down and already at the bottom
                    else if (e.deltaY > 0 && scrollTop + clientHeight >= scrollHeight) {
                        e.preventDefault();
                        panel.scrollTop = scrollHeight - clientHeight;
                    }
                }, { passive: false });
                
                // Handle touch events for mobile
                panel.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }
        });
        // Add these new functions for the quick lookup panel
        document.getElementById('quickNumInput').addEventListener('input', function(e) {
            let result = numberToWord(e.target.value);
            document.getElementById('quickNumResult').textContent = result;
        });

        document.getElementById('quickLetterInput').addEventListener('input', function(e) {
            let result = letterToWord(e.target.value);
            document.getElementById('quickLetterResult').textContent = result;
        });

        document.getElementById('quickSecondaryNumInput').addEventListener('input', function(e) {
            let result = secondaryNumberToWord(e.target.value);
            document.getElementById('quickSecondaryNumResult').textContent = result;
        });

        function quickClearInputs() {
            const numInput = document.getElementById('quickNumInput');
            const letterInput = document.getElementById('quickLetterInput');
            const secondaryNumInput = document.getElementById('quickSecondaryNumInput');
            const numResult = document.getElementById('quickNumResult');
            const letterResult = document.getElementById('quickLetterResult');
            const secondaryNumResult = document.getElementById('quickSecondaryNumResult');
            
            // Capture input and result values BEFORE clearing
            const numValue = numInput.value;
            const letterValue = letterInput.value;
            const secondaryNumValue = secondaryNumInput.value;
            const numResultValue = numResult.textContent;
            const letterResultValue = letterResult.textContent;
            const secondaryNumResultValue = secondaryNumResult.textContent;
            
            // Save to log before clearing
            saveToLogWithResults(numValue, letterValue, secondaryNumValue, numResultValue, letterResultValue, secondaryNumResultValue);
            
            // Now clear everything
            numInput.value = '';
            letterInput.value = '';
            secondaryNumInput.value = '';
            numResult.textContent = '';
            letterResult.textContent = '';
            secondaryNumResult.textContent = '';
            numInput.focus();
        }

        function clearQuickNotes() {
            const notesField = document.getElementById('quickNotesInput');
            if (notesField) {
                notesField.value = '';
                // Clear from localStorage
                localStorage.removeItem('quickNotesContent');
                notesField.focus();
            }
        }

        function quickClearDeviceSearch() {
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickDeviceResult').style.display = 'none';
        }

        // Add this function to fetch violations for all devices by BIN
        async function fetchViolationsForBin(bin) {
            try {
                // This will get all violations for the given BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?$where=bin='${bin}'`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Group violations by device number for easier lookup
                const violationsByDevice = {};
                data.forEach(violation => {
                    const deviceNum = violation.device_number;
                    if (!violationsByDevice[deviceNum]) {
                        violationsByDevice[deviceNum] = [];
                    }
                    violationsByDevice[deviceNum].push(violation);
                });
                
                return violationsByDevice;
            } catch (error) {
                console.error('Error fetching violations for BIN:', error);
                return {};
            }
        }

        // Add this function to handle custom days input changes
        function customDaysChanged() {
            const dateStr = document.getElementById('dateInput').value;
            const customDays = document.getElementById('customDays').value;
            
            // Only perform the calculation if we have both a date and a days value
            if (dateStr && customDays && !isNaN(parseInt(customDays))) {
                calculateCustomDate();
            }
        }

        // Add event listener for the custom days input
        document.addEventListener('DOMContentLoaded', function() {
            // Existing date input listener
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // New custom days input listener
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', customDaysChanged);
            }
        });

        // Add media query handling for responsive ELV3 Lookup button
        function handleResponsiveELV3Button() {
            const buttonTexts = document.querySelectorAll('.button-text');
            const buttonIcons = document.querySelectorAll('.button-icon');
            const lookupButton = document.querySelector('button[onclick="toggleQuickLookup()"]');
            const panel = document.getElementById('quickLookupPanel');
            const dobContent = document.getElementById('dobContent');
            const dobLookupToggleBtn = document.getElementById('dobLookupToggleBtn');
            const dobNowBtn = document.getElementById('dobNowBtn');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            const panelOpen = panel && panel.style.display === 'block';
            
            if (window.innerWidth < 600) {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'none';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'block';
                });
                // Make button more compact on mobile
                if (lookupButton) {
                    lookupButton.style.padding = '10px';
                    lookupButton.style.borderRadius = '50%';
                    lookupButton.style.width = '44px';
                    lookupButton.style.height = '44px';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.add('panel-centered-mobile');
                }
                // Hide DOB buttons if panel open on DOB
                if (isDOBActive && panelOpen) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                }
            } else if (window.innerWidth <= 900) {
                // Medium screens: remove body/content shift; keep overlay behavior
                document.body.classList.remove('dob-shifted-for-lookup');
                if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                if (dobContent) {
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                }
                
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'block';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'none';
                });
                if (lookupButton) {
                    lookupButton.style.padding = '12px 20px';
                    lookupButton.style.borderRadius = '4px';
                    lookupButton.style.width = 'auto';
                    lookupButton.style.height = 'auto';
                }
                if (panel && panel.style.display === 'block') {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
                // Hide DOB buttons if panel open on DOB
                if (isDOBActive && panelOpen) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                } else {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                    if (dobNowBtn) dobNowBtn.style.display = '';
                }
            } else {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'block';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'none';
                });
                // Restore button style on desktop
                if (lookupButton) {
                    lookupButton.style.padding = '12px 20px';
                    lookupButton.style.borderRadius = '4px';
                    lookupButton.style.width = 'auto';
                    lookupButton.style.height = 'auto';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
                // If panel open on DOB, compute centered margins and hide buttons
                if (isDOBActive && panelOpen) {
                    // Ensure inline margins cleared; class drives spacing
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                } else {
                    if (dobContent) {
                        dobContent.style.marginRight = '';
                        dobContent.style.marginLeft = '';
                    }
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                    if (dobNowBtn) dobNowBtn.style.display = '';
                }
            }
        }
        
        // Run on page load
        handleResponsiveELV3Button();
        
        // Run on window resize
        window.addEventListener('resize', handleResponsiveELV3Button);



        // Function to fetch the last update date for the violations API
        async function fetchViolationsAPILastUpdateDate() {
            try {
                // Get reference to the element displaying the update date
                const violationsApiLastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                if (!violationsApiLastUpdatedElement) return;
                
                // Set loading state
                violationsApiLastUpdatedElement.textContent = "Loading...";
                
                try {
                    // Get the dataset metadata using the correct endpoint format
                    const datasetId = '855j-jady'; // DOB Safety Violations dataset ID
                    const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                    
                    const metadataResponse = await fetch(metadataUrl);
                    if (!metadataResponse.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    
                    const metadata = await metadataResponse.json();
                    
                    // Extract the last updated date from the metadata
                    // rowsUpdatedAt is typically a Unix timestamp in seconds, so multiply by 1000
                    let updateDate;
                    if (metadata.rowsUpdatedAt) {
                        // Handle Unix timestamp (seconds) - multiply by 1000 to get milliseconds
                        updateDate = new Date(metadata.rowsUpdatedAt * 1000);
                    } else if (metadata.dataUpdatedAt) {
                        // Try dataUpdatedAt as fallback
                        updateDate = new Date(metadata.dataUpdatedAt * 1000);
                    } else if (metadata.viewLastModified) {
                        // Try viewLastModified as fallback
                        updateDate = new Date(metadata.viewLastModified);
                    } else {
                        throw new Error('No update date found in metadata');
                    }
                    
                    // Only update if we got a valid date
                    if (!isNaN(updateDate.getTime())) {
                        const formattedDate = updateDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        violationsApiLastUpdatedElement.textContent = formattedDate;
                        console.log("Violations API data last updated:", formattedDate);
                    } else {
                        throw new Error('Invalid date format from API');
                    }
                    
                    // Calculate days since update
                    // Normalize both dates to midnight to compare calendar days, not hours
                    const today = new Date();
                    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                    const timeDiff = todayMidnight - updateDateMidnight;
                    const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Get the days since element
                    const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                    
                    if (daysSinceElement) {
                        // Display appropriate message based on days
                        if (daysSinceUpdate <= 0) {
                            daysSinceElement.textContent = "Updated today";
                            daysSinceElement.style.color = "#4CAF50"; // Green for today
                        } else if (daysSinceUpdate === 1) {
                            daysSinceElement.textContent = "Updated 1 day ago";
                            daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                        } else if (daysSinceUpdate < 14) {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                        } else if (daysSinceUpdate < 30) {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                        } else {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                        }
                    }
                } catch (innerError) {
                    console.error('Error in primary fetch:', innerError);
                    
                    // If we can't fetch the date, show an error message
                    violationsApiLastUpdatedElement.textContent = "Unable to fetch update date";
                    
                    // Remove the days since update element if it exists
                    const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                    if (daysSinceElement) {
                        daysSinceElement.parentElement.removeChild(daysSinceElement);
                    }
                }
            } catch (outerError) {
                console.error('Outer error in fetchViolationsAPILastUpdateDate:', outerError);
            }
        }

        // Add event listener to call the function when the violations tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Call the function immediately when the page loads
            fetchViolationsAPILastUpdateDate();
            
            // Also set up the tab click listener
            const violationsTab = document.getElementById('violationsTab');
            if (violationsTab) {
                violationsTab.addEventListener('click', fetchViolationsAPILastUpdateDate);
            }
            
            // Also check if violations tab is the default tab on load
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            if (defaultTab === 'violations') {
                fetchViolationsAPILastUpdateDate();
            }
            
            // Update API data on page load
            updateAllAPIData();
        });

        // Function to update all API data
        function updateAllAPIData() {
            // Update both APIs immediately
            fetchAPILastUpdateDate();
            fetchViolationsAPILastUpdateDate();
            console.log(`API data updated at ${new Date().toLocaleTimeString()}`);
        }

        // Add these new functions for filtering
        function toggleViolationsFilter() {
            const button = document.getElementById('violationsFilterBtn');
            const buttonText = document.getElementById('violationsFilterText');
            const isFiltering = button.getAttribute('data-filtering') === 'true';
            
            if (!isFiltering) {
                // Enable filtering - show only devices with violations
                button.setAttribute('data-filtering', 'true');
                buttonText.textContent = 'Show All Devices';
                button.style.background = '#1a73e8';
                button.style.color = 'white';
                button.style.width = '240px';
            } else {
                // Disable filtering - show all devices
                button.setAttribute('data-filtering', 'false');
                buttonText.textContent = 'Show Only Devices with Violations';
                button.style.background = 'var(--panel-bg)';
                button.style.color = 'var(--text-color)';
                button.style.width = '240px';
            }
            
            // Re-apply all filters using the centralized function
            if (typeof window.applyAllFilters === 'function') {
                window.applyAllFilters();
            } else {
                filterDevicesByType();
            }
        }
        
        function filterDevicesByType() {
            const deviceTypeFilter = document.getElementById('deviceTypeFilter');
            if (!deviceTypeFilter) return;
            
            const typeFilter = deviceTypeFilter.value;
            const deviceItems = document.querySelectorAll('.device-item');
            const violationsFilterBtn = document.getElementById('violationsFilterBtn');
            const violationsFiltering = violationsFilterBtn ? violationsFilterBtn.getAttribute('data-filtering') === 'true' : false;
            
            deviceItems.forEach(item => {
                const deviceType = item.getAttribute('data-device-type');
                const deviceStatus = item.getAttribute('data-device-status');
                const hasViolations = item.getAttribute('data-has-violations') === 'true';
                
                let shouldShow = false;
                
                if (typeFilter === 'all') {
                    shouldShow = true;
                } else if (typeFilter === 'REMOVED') {
                    // Show only removed devices regardless of their original type
                    shouldShow = deviceStatus === 'REMOVED';
                } else {
                    // Show devices of specific type that are not removed
                    shouldShow = deviceType === typeFilter && deviceStatus !== 'REMOVED';
                }
                
                // Apply violations filter if active
                if (shouldShow && violationsFiltering && !hasViolations) {
                    shouldShow = false;
                }
                
                item.style.display = shouldShow ? '' : 'none';
            });
            
            updateDeviceTypeSectionVisibility();
        }
        
        function toggleBothTestsList() {
            const button = document.getElementById('bothTestsListBtn');
            const listDiv = document.getElementById('bothTestsDevicesList');
            const buttonText = document.getElementById('bothTestsListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#4CAF50';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleOneTestList() {
            const button = document.getElementById('oneTestListBtn');
            const listDiv = document.getElementById('oneTestDevicesList');
            const buttonText = document.getElementById('oneTestListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ffd700';
                button.style.color = '#000';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleNoTestsList() {
            const button = document.getElementById('noTestsListBtn');
            const listDiv = document.getElementById('noTestsDevicesList');
            const buttonText = document.getElementById('noTestsListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ff6b6b';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleWarningList() {
            const button = document.getElementById('warningListBtn');
            const listDiv = document.getElementById('warningDevicesList');
            const buttonText = document.getElementById('warningListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ff9800';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleRemovedDevices() {
            const button = document.getElementById('removedDevicesToggleBtn');
            const listDiv = document.getElementById('removedDeviceTypeSections');
            const buttonText = document.getElementById('removedDevicesToggleText');
            const icon = document.getElementById('removedDevicesToggleIcon');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the removed devices
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide';
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
                button.style.background = '#ff6b6b';
                button.style.color = '#fff';
            } else {
                // Hide the removed devices
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show';
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleTestCompletionStatus() {
            const button = document.getElementById('testCompletionStatusBtn');
            const contentDiv = document.getElementById('testCompletionStatusContent');
            const buttonText = document.getElementById('testCompletionStatusText');
            
            if (!button || !contentDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the content
                button.setAttribute('data-showing', 'true');
                contentDiv.style.display = 'block';
                buttonText.textContent = 'Hide';
                button.style.background = 'var(--header-color)';
                button.style.color = '#fff';
            } else {
                // Hide the content
                button.setAttribute('data-showing', 'false');
                contentDiv.style.display = 'none';
                buttonText.textContent = 'Show';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function resetFilters() {
            // Reset violations filter
            const violationsFilterBtn = document.getElementById('violationsFilterBtn');
            if (violationsFilterBtn) {
                violationsFilterBtn.setAttribute('data-filtering', 'false');
                violationsFilterBtn.style.background = 'var(--panel-bg)';
                violationsFilterBtn.style.color = 'var(--text-color)';
                violationsFilterBtn.style.width = '240px';
            }
            
            const violationsFilterText = document.getElementById('violationsFilterText');
            if (violationsFilterText) {
                violationsFilterText.textContent = 'Show Only Devices with Violations';
            }
            
            // Reset type filter
            const deviceTypeFilter = document.getElementById('deviceTypeFilter');
            if (deviceTypeFilter) {
                deviceTypeFilter.value = 'all';
            }
            
            // Reset test eligibility filter
            const testEligibilityFilter = document.getElementById('testEligibilityFilter');
            if (testEligibilityFilter) {
                testEligibilityFilter.value = 'all';
            }
            
            // Hide both tests list if it's showing
            const bothTestsListBtn = document.getElementById('bothTestsListBtn');
            if (bothTestsListBtn && bothTestsListBtn.getAttribute('data-showing') === 'true') {
                toggleBothTestsList();
            }
            
            // Hide one test list if it's showing
            const oneTestListBtn = document.getElementById('oneTestListBtn');
            if (oneTestListBtn && oneTestListBtn.getAttribute('data-showing') === 'true') {
                toggleOneTestList();
            }
            
            // Hide warning list if it's showing
            const warningListBtn = document.getElementById('warningListBtn');
            if (warningListBtn && warningListBtn.getAttribute('data-showing') === 'true') {
                toggleWarningList();
            }
            
            // Show all devices
            document.querySelectorAll('.device-item').forEach(item => {
                item.style.display = '';
            });
            
            // Show all sections
            document.querySelectorAll('.device-type-section').forEach(section => {
                section.style.display = '';
            });
            
            // Show removed devices section if it exists
            const removedDevicesContainer = document.getElementById('removedDeviceTypeSections');
            if (removedDevicesContainer && removedDevicesContainer.parentElement) {
                removedDevicesContainer.parentElement.style.display = '';
            }
        }
        
        function updateDeviceTypeSectionVisibility() {
            // Hide sections that have no visible devices
            document.querySelectorAll('.device-type-section').forEach(section => {
                const visibleDevices = section.querySelectorAll('.device-item:not([style*="display: none"])');
                const totalDevices = section.querySelectorAll('.device-item');
                
                if (visibleDevices.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            });
            
            // Also handle the removed devices section container
            const removedDevicesContainer = document.getElementById('removedDeviceTypeSections');
            if (removedDevicesContainer) {
                const visibleRemovedSections = removedDevicesContainer.querySelectorAll('.device-type-section:not([style*="display: none"])');
                const removedSectionTitle = removedDevicesContainer.previousElementSibling;
                
                if (visibleRemovedSections.length === 0) {
                    removedDevicesContainer.parentElement.style.display = 'none';
                } else {
                    removedDevicesContainer.parentElement.style.display = '';
                }
            }
        }
        
        // Function to toggle all violations (show or hide)
        function toggleAllViolations() {
            const toggleButton = document.getElementById('toggleAllViolationsBtn');
            const isShowing = toggleButton.getAttribute('data-showing') === 'true';
            
            // Find all devices with violations
            const devicesWithViolations = document.querySelectorAll('.device-item[data-has-violations="true"]');
            
            if (!isShowing) {
                // Show all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display === 'none') {
                                // Only click if violations are not already shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Hide All Violations';
                toggleButton.setAttribute('data-showing', 'true');
            } else {
                // Hide all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display !== 'none') {
                                // Only click if violations are currently shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Show All Violations';
                toggleButton.setAttribute('data-showing', 'false');
            }
        }

        // Function to fetch permit information for a device's BIN
        async function fetchPermitInfo(deviceNumber) {
            try {
                // First get the device details to get the BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    let allPermits = [];
                    let success = false;
                    
                    // Try to find permits that specifically mention this device number
                    if (binNumber) {
                        try {
                            // First try to find permits that specifically mention this device number in the description
                            const deviceQuery = `$where=bin='${binNumber}' AND descriptionofwork like '%${deviceNumber}%'`;
                            const deviceSpecificResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?${deviceQuery}`);
                            
                            if (deviceSpecificResponse.ok) {
                                const deviceSpecificData = await deviceSpecificResponse.json();
                                if (deviceSpecificData && deviceSpecificData.length > 0) {
                                    // Normalize the data structure to match our expected format
                                    const normalizedData = deviceSpecificData.map(permit => ({
                                        permit_number: permit.job_filing_number || permit.job_number,
                                        permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                            `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                            permit.applicant_businessname || 'N/A',
                                        issuance_date: permit.filing_date,
                                        expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                        house_number: permit.house_number,
                                        street_name: permit.street_name,
                                        application_type: permit.filing_type,
                                        work_type: permit.elevatordevicetype,
                                        filing_status: permit.filing_status,
                                        job_filing_number: permit.job_filing_number,
                                        business_name: permit.applicant_businessname || permit.owner_businessname,
                                        description: permit.descriptionofwork,
                                        device_specific: true
                                    }));
                                    allPermits = [...normalizedData];
                                    success = true;
                                }
                            }
                            
                            // If no exact match found, try looking for permits that might be for this device
                            if (allPermits.length === 0) {
                                // Get all permits for this BIN
                                const binResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?bin=${binNumber}`);
                                if (binResponse.ok) {
                                    const binData = await binResponse.json();
                                    
                                    // Get the device type and other identifiers
                                    const deviceType = device.device_type ? device.device_type.toUpperCase() : 'ELEVATOR';
                                    const deviceLocation = device.device_location || '';
                                    
                                    // Look for permits that might be for this specific device
                                    const potentialMatches = binData.filter(permit => {
                                        if (!permit.descriptionofwork) return false;
                                        
                                        const desc = permit.descriptionofwork.toUpperCase();
                                        
                                        // Check for exact device number match
                                        if (desc.includes(deviceNumber)) return true;
                                        
                                        // Check for location match if available
                                        if (deviceLocation && desc.includes(deviceLocation.toUpperCase())) return true;
                                        
                                        // Check for specific identifiers that might indicate this device
                                        // For example, "Car 3" or "Elevator #3" if device number ends with 3
                                        const deviceNumberEnd = deviceNumber.slice(-1);
                                        if (desc.includes(`CAR ${deviceNumberEnd}`) || 
                                            desc.includes(`ELEVATOR #${deviceNumberEnd}`) ||
                                            desc.includes(`ELEVATOR ${deviceNumberEnd}`)) {
                                            return true;
                                        }
                                        
                                        return false;
                                    });
                                    
                                    if (potentialMatches.length > 0) {
                                        const normalizedData = potentialMatches.map(permit => ({
                                            permit_number: permit.job_filing_number || permit.job_number,
                                            permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                                `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                                permit.applicant_businessname || 'N/A',
                                            issuance_date: permit.filing_date,
                                            expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                            house_number: permit.house_number,
                                            street_name: permit.street_name,
                                            application_type: permit.filing_type,
                                            work_type: permit.elevatordevicetype,
                                            filing_status: permit.filing_status,
                                            job_filing_number: permit.job_filing_number,
                                            business_name: permit.applicant_businessname || permit.owner_businessname,
                                            description: permit.descriptionofwork,
                                            device_specific: permit.descriptionofwork.includes(deviceNumber)
                                        }));
                                        allPermits = [...normalizedData];
                                        success = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching device-specific permits:', error);
                        }
                    }
                    
                    // Return the permits found
                    return {
                        success: success,
                        device: device,
                        permits: allPermits,
                        deviceNumber: deviceNumber
                    };
                }
                
                return {
                    success: false,
                    message: 'No device or BIN information found'
                };
            } catch (error) {
                console.error('Error fetching permit information:', error);
                return {
                    success: false,
                    message: 'Error fetching permit information'
                };
            }
        }
        
        // Add this function to toggle permit information display for a device
        async function togglePermitInfo(deviceNumber) {
            const permitElement = document.getElementById(`permits_${deviceNumber}`);
            const button = document.getElementById(`permitsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (permitElement.style.display === 'none') {
                permitElement.style.display = 'block';
                arrow.textContent = 'â–²';
                if (buttonText) {
                    buttonText.textContent = 'Hide Permit Information';
                }
                
                // Check if permit info is already loaded
                if (permitElement.getAttribute('data-loaded') !== 'true') {
                    permitElement.innerHTML = '<span style="color: var(--text-color);">Loading permit information...</span>';
                    
                    const result = await fetchPermitInfo(deviceNumber);
                    
                    if (result.success && result.permits.length > 0) {
                        // Sort permits by device-specific first, then by issue date (newest first)
                        const permits = result.permits.filter(permit => permit.issuance_date);
                        permits.sort((a, b) => {
                            // First prioritize device-specific permits
                            if (a.device_specific && !b.device_specific) return -1;
                            if (!a.device_specific && b.device_specific) return 1;
                            
                            // Then sort by date (newest first)
                            return new Date(b.issuance_date) - new Date(a.issuance_date);
                        });
                        
                        // Get the most recent permits (up to 5)
                        const recentPermits = permits.slice(0, 5);
                        
                        let html = `
                            <div style="margin-bottom: 5px; color: var(--header-color);">
                                <strong>Permit Information for Device #${deviceNumber} (${permits.length} total):</strong>
                                                    </div>
                            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                        `;
                        
                        recentPermits.forEach(permit => {
                            const issueDate = permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'Unknown';
                            const expirationDate = permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'Unknown';
                            
                            // Add a special highlight for device-specific permits
                            const isDeviceSpecific = permit.device_specific || 
                                (permit.description && (
                                    permit.description.includes(deviceNumber) || 
                                    permit.description.includes(result.deviceNumber)
                                ));
                            
                            html += `
                                <div style="margin-bottom: 12px; padding: 8px; background: ${isDeviceSpecific ? 'rgba(74, 158, 255, 0.1)' : 'var(--input-bg)'}; 
                                     border-radius: 4px; border: 1px solid ${isDeviceSpecific ? '#4a9eff' : 'var(--input-border)'};">
                                    ${isDeviceSpecific ? 
                                        `<div style="margin-bottom: 8px; padding: 4px; background: #4a9eff; color: white; border-radius: 3px; font-size: 0.85em; display: inline-block;">
                                            Device-Specific Permit
                                        </div>` : ''
                                    }
                                    <div><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Issue Date:</strong> ${issueDate}</div>
                                    <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${expirationDate}</div>
                                    <div><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                    ${permit.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                    ${permit.description ? 
                                        `<div style="margin-top: 8px;">
                                            <strong style="color: var(--header-color);">Description:</strong> 
                                            <div style="margin-top: 4px; padding: 8px; background: var(--panel-bg); border-radius: 4px; white-space: pre-wrap; font-size: 0.9em;">
                                                ${permit.description}
                                                </div>
                                        </div>` : ''
                                    }
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                        permitElement.innerHTML = html;
                        permitElement.setAttribute('data-loaded', 'true');
                    } else {
                        // Try to provide more helpful information when no permits are found
                        let message = '';
                        
                        if (result.success) {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>No permits found for device #${deviceNumber} in the NYC DOB database.</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">This could be because:</p>
                                    <ul style="text-align: left; margin-top: 5px; font-size: 0.9em;">
                                        <li>The permit may be filed under a different BIN</li>
                                        <li>The permit may be older and not included in the digital records</li>
                                        <li>The device may not require a specific permit</li>
                                        <li>The permit may not specifically mention this device number</li>
                                    </ul>
                                    <p style="margin-top: 10px; font-size: 0.9em;">You can try searching directly on the <a href="https://a810-dobnow.nyc.gov/publish/Index.html#!/" target="_blank" style="color: #4a9eff;">DOB NOW portal</a> using the BIN number: ${result.device?.bin || 'N/A'}</p>
                                </div>
                            `;
                        } else {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>${result.message || 'Error fetching permit information'}</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">Please try again later or check the device information.</p>
                                </div>
                            `;
                        }
                        
                        permitElement.innerHTML = message;
                        permitElement.setAttribute('data-loaded', 'true');
                    }
                }
            } else {
                permitElement.style.display = 'none';
                arrow.textContent = 'â–¼';
                if (buttonText) {
                    buttonText.textContent = 'Show Permit Information';
                }
            }
        }

        // Add this new function to fetch detailed device information from the API
        async function fetchDeviceInfo(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/juyv-2jek.json?device_id=${deviceNumber}`);
                
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Error fetching device info:', error);
                return null;
            }
        }

        // Add this function to handle the "X" button clicks
        function handleClearButtonClick(event) {
            const button = event.target;
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Add event listeners for the "X" buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Find all clear buttons (X buttons) next to the lookup buttons
            const clearButtons = document.querySelectorAll('button[onclick="clearDeviceSearch()"]');
            clearButtons.forEach(button => {
                button.addEventListener('click', handleClearButtonClick);
            });
            
            // Initialize BIN display styling
            updateBinDisplayStyle();
        });

        // Function to update BIN display styling based on content
        function updateBinDisplayStyle() {
            const binSpan = document.getElementById('quickBinValue');
            if (binSpan) {
                const binValue = binSpan.textContent.replace('ðŸ“‹', '').trim();
                if (binValue && binValue !== '-') {
                    // BIN is available - make it clickable
                    binSpan.style.cursor = 'pointer';
                    binSpan.style.color = '#4a9eff';
                    binSpan.style.borderColor = '#4a9eff';
                    binSpan.title = 'Click to copy BIN';
                    binSpan.style.opacity = '1';
                    
                    // Add the copy icon if not already present
                    if (!binSpan.querySelector('svg')) {
                        binSpan.innerHTML = `${binValue}<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;"><path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
                    }
                    
                    // Add hover effect
                    binSpan.addEventListener('mouseenter', function() {
                        const currentBin = this.textContent.replace('ðŸ“‹', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'rgba(74, 158, 255, 0.1)';
                        }
                    });
                    binSpan.addEventListener('mouseleave', function() {
                        const currentBin = this.textContent.replace('ðŸ“‹', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'transparent';
                        }
                    });
                } else {
                    // No BIN available - make it non-clickable
                    binSpan.style.cursor = 'default';
                    binSpan.style.color = 'var(--text-color)';
                    binSpan.style.borderColor = 'transparent';
                    binSpan.title = '';
                    binSpan.style.opacity = '0.7';
                    binSpan.innerHTML = '-'; // Remove any icon
                }
            }
        }

        // Add this new function to handle copying BIN to clipboard
        async function copyBinToClipboard(bin, event) {
            try {
                // Prevent any default behavior
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Don't copy if BIN is empty or just a dash
                if (!bin || bin.trim() === '-' || bin.trim() === '') {
                    return;
                }

                // Get the clicked element
                const span = event ? event.target.closest('span') : document.querySelector(`span[onclick*="${bin}"]`);
                if (!span) return;

                // Store original styles
                const originalBg = span.style.backgroundColor;
                const originalColor = span.style.color;
                const originalBorder = span.style.borderColor;

                // Try modern clipboard API first
                try {
                    await navigator.clipboard.writeText(bin);
                } catch (err) {
                    // Fallback for browsers that don't support clipboard API
                    const textarea = document.createElement('textarea');
                    textarea.value = bin;
                    textarea.style.position = 'fixed';  // Prevent scrolling to bottom
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                // Show success state
                span.style.backgroundColor = '#4CAF50';
                span.style.color = 'white';
                span.style.borderColor = '#4CAF50';
                span.title = 'Copied!';

                // Find the SVG and change its color
                const svg = span.querySelector('svg');
                if (svg) {
                    svg.style.opacity = '1';
                }

                // Reset after 2 seconds
                setTimeout(() => {
                    span.style.backgroundColor = originalBg;
                    span.style.color = originalColor;
                    span.style.borderColor = originalBorder;
                    span.title = 'Click to copy';
                    if (svg) {
                        svg.style.opacity = '0.7';
                    }
                }, 2000);
            } catch (err) {
                console.error('Failed to copy BIN:', err);
                alert('Failed to copy BIN to clipboard');
            }
        }

        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            return daysSinceInspection >= 91;
        }

        function toggleTestEligibilityFilter() {
            const button = document.getElementById('testEligibilityFilterBtn');
            if (!button) return;
            
            const currentFilter = button.getAttribute('data-filter') || 'all';
            const deviceItems = document.querySelectorAll('.device-item');
            
            let newFilter;
            if (currentFilter === 'all') {
                newFilter = 'eligible';
                button.textContent = 'Show Not Ready Only';
                button.style.background = '#4CAF50';
            } else if (currentFilter === 'eligible') {
                newFilter = 'not-eligible';
                button.textContent = 'Show All Devices';
                button.style.background = '#ff6b6b';
            } else {
                newFilter = 'all';
                button.textContent = 'Show Ready Only';
                button.style.background = 'var(--panel-bg)';
            }
            
            button.setAttribute('data-filter', newFilter);
            
            deviceItems.forEach(item => {
                const testStatusElement = item.querySelector('[data-test-status]');
                const isEligible = testStatusElement?.getAttribute('data-test-status') === 'true';
                
                if (newFilter === 'all' || 
                    (newFilter === 'eligible' && isEligible) || 
                    (newFilter === 'not-eligible' && !isEligible)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateDeviceTypeSectionVisibility();
        }

        // ELV3 Lookup Log Functions
        function saveToLogWithResults(numValue, letterValue, secondaryNumValue, numResult, letterResult, secondaryNumResult) {
            // Only save if there was actual content to log
            if (!numValue && !letterValue && !secondaryNumValue && !numResult && !letterResult && !secondaryNumResult) {
                return;
            }
            
            // Create log entry
            const logEntry = {
                timestamp: new Date().toLocaleString(),
                inputs: {
                    partNumber: numValue || '',
                    violatingCondition: letterValue || '',
                    suggestedRemedy: secondaryNumValue || ''
                },
                outputs: {
                    partNumberResult: numResult || '',
                    violatingConditionResult: letterResult || '',
                    suggestedRemedyResult: secondaryNumResult || ''
                }
            };
            
            // Get existing log entries
            let logEntries = JSON.parse(localStorage.getItem('elv3LookupLog') || '[]');
            
            // Add new entry to the beginning of the array
            logEntries.unshift(logEntry);
            
            // Keep only the last 50 entries to prevent excessive storage
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }
            
            // Save back to localStorage
            localStorage.setItem('elv3LookupLog', JSON.stringify(logEntries));
            
            // If the log section is currently visible, refresh it immediately
            const logSection = document.getElementById('inlineLogSection');
            if (logSection && logSection.style.display === 'block') {
                displayInlineLogEntries();
            }
        }

        function toggleLogModal() {
            const logSection = document.getElementById('inlineLogSection');
            
            if (logSection.style.display === 'none' || logSection.style.display === '') {
                displayInlineLogEntries();
                logSection.style.display = 'block';
            } else {
                logSection.style.display = 'none';
            }
        }

        function displayInlineLogEntries() {
            const logEntries = JSON.parse(localStorage.getItem('elv3LookupLog') || '[]');
            const logContainer = document.getElementById('inlineLogEntries');
            
            if (logEntries.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; font-size: 1em;">No log entries yet.</p>';
                return;
            }
            
            let html = '';
            // Show only the last 5 entries for inline display
            const recentEntries = logEntries.slice(0, 5);
            recentEntries.forEach((entry, index) => {
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--panel-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <strong style="color: var(--text-color); font-size: 0.95em;">Entry #${logEntries.length - index}</strong>
                            <span style="color: #666; font-size: 0.85em;">${entry.timestamp}</span>
                        </div>
                        
                        <div style="font-size: 0.9em; line-height: 1.3;">
                            ${entry.inputs.partNumber ? `<div><strong>Input:</strong> ${entry.inputs.partNumber} â†’ <em>${entry.outputs.partNumberResult}</em></div>` : ''}
                            ${entry.inputs.violatingCondition ? `<div><strong>Condition:</strong> ${entry.inputs.violatingCondition} â†’ <em>${entry.outputs.violatingConditionResult}</em></div>` : ''}
                            ${entry.inputs.suggestedRemedy ? `<div><strong>Remedy:</strong> ${entry.inputs.suggestedRemedy} â†’ <em>${entry.outputs.suggestedRemedyResult}</em></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (logEntries.length > 5) {
                html += `<p style="text-align: center; color: #666; font-style: italic; font-size: 0.9em;">Showing 5 most recent entries (${logEntries.length} total)</p>`;
            }
            
            logContainer.innerHTML = html;
        }

        function clearLogEntries() {
            if (confirm('Are you sure you want to clear all log entries? This action cannot be undone.')) {
                localStorage.removeItem('elv3LookupLog');
                displayInlineLogEntries(); // Refresh the inline display
            }
        }

        // Main tab history functions
        function saveToMainLogWithResults(numValue, letterValue, secondaryNumValue, numResult, letterResult, secondaryNumResult) {
            // Only save if there was actual content to log
            if (!numValue && !letterValue && !secondaryNumValue && !numResult && !letterResult && !secondaryNumResult) {
                return;
            }
            
            // Create log entry
            const logEntry = {
                timestamp: new Date().toLocaleString(),
                inputs: {
                    partNumber: numValue || '',
                    violatingCondition: letterValue || '',
                    suggestedRemedy: secondaryNumValue || ''
                },
                outputs: {
                    partNumberResult: numResult || '',
                    violatingConditionResult: letterResult || '',
                    suggestedRemedyResult: secondaryNumResult || ''
                }
            };
            
            // Get existing log entries
            let logEntries = JSON.parse(localStorage.getItem('elv3MainTabLog') || '[]');
            
            // Add new entry to the beginning of the array
            logEntries.unshift(logEntry);
            
            // Keep only the last 50 entries to prevent excessive storage
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }
            
            // Save back to localStorage
            localStorage.setItem('elv3MainTabLog', JSON.stringify(logEntries));
            
            // If the log section is currently visible, refresh it immediately
            const logSection = document.getElementById('mainLogSection');
            if (logSection && logSection.style.display === 'block') {
                displayMainLogEntries();
            }
        }

        function toggleMainLogModal() {
            const logSection = document.getElementById('mainLogSection');
            
            if (logSection.style.display === 'none' || logSection.style.display === '') {
                displayMainLogEntries();
                logSection.style.display = 'block';
            } else {
                logSection.style.display = 'none';
            }
        }

        function displayMainLogEntries() {
            const logEntries = JSON.parse(localStorage.getItem('elv3MainTabLog') || '[]');
            const logContainer = document.getElementById('mainLogEntries');
            
            if (logEntries.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; font-size: 1em;">No log entries yet.</p>';
                return;
            }
            
            let html = '';
            // Show only the last 5 entries for inline display
            const recentEntries = logEntries.slice(0, 5);
            recentEntries.forEach((entry, index) => {
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--panel-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <strong style="color: var(--text-color); font-size: 0.95em;">Entry #${logEntries.length - index}</strong>
                            <span style="color: #666; font-size: 0.85em;">${entry.timestamp}</span>
                        </div>
                        
                        <div style="font-size: 0.9em; line-height: 1.3;">
                            ${entry.inputs.partNumber ? `<div><strong>Input:</strong> ${entry.inputs.partNumber} â†’ <em>${entry.outputs.partNumberResult}</em></div>` : ''}
                            ${entry.inputs.violatingCondition ? `<div><strong>Condition:</strong> ${entry.inputs.violatingCondition} â†’ <em>${entry.outputs.violatingConditionResult}</em></div>` : ''}
                            ${entry.inputs.suggestedRemedy ? `<div><strong>Remedy:</strong> ${entry.inputs.suggestedRemedy} â†’ <em>${entry.outputs.suggestedRemedyResult}</em></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (logEntries.length > 5) {
                html += `<p style="text-align: center; color: #666; font-style: italic; font-size: 0.9em;">Showing 5 most recent entries (${logEntries.length} total)</p>`;
            }
            
            logContainer.innerHTML = html;
        }

        function clearMainLogEntries() {
            if (confirm('Are you sure you want to clear all log entries? This action cannot be undone.')) {
                localStorage.removeItem('elv3MainTabLog');
                displayMainLogEntries(); // Refresh the inline display
            }
        }

        // Device number search functions for ELV3 Lookup panel
        function updateMainDeviceField(deviceNumber) {
            // Update the main device number field in DOB tab if it exists
            const deviceInput = document.getElementById('deviceNumber');
            if (deviceInput) {
                deviceInput.value = deviceNumber || '';
                // Fire input event so any listeners can react to the change
                deviceInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        async function searchDeviceInLookup(deviceNumber) {
            const resultDiv = document.getElementById('quickDeviceResult');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber || deviceNumber.trim() === '') {
                resultDiv.style.display = 'none';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                
                // Show address search when device field is cleared
                if (typeof toggleAddressSearchVisibility === 'function') {
                    toggleAddressSearchVisibility('');
                }
                return;
            }

            // Show loading state
            resultDiv.innerHTML = '<span style="color: var(--text-color); font-size: 12px;">Searching device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber.trim()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Device not found</span>';
                    quickBinValue.textContent = '-';
                    updateBinDisplayStyle();
                    return;
                }

                const device = data[0];
                const binNumber = device.bin || 'Not available';
                const address = device.house_number && device.street_name ? 
                    `${device.house_number} ${device.street_name}` : 'Address not available';

                // Update BIN display
                quickBinValue.textContent = binNumber;
                updateBinDisplayStyle();

                // Show device result
                resultDiv.innerHTML = `
                    <div style="font-size: 12px; line-height: 1.3;">
                        <strong>BIN:</strong> ${binNumber}<br>
                        <strong>Address:</strong> ${address}
                    </div>
                `;

                // Also update the main DOB tab BIN field if it exists
                const mainBinInput = document.getElementById('binNumber');
                if (mainBinInput && binNumber !== 'Not available') {
                    mainBinInput.value = binNumber;
                }

                // Hide address search when device number is populated
                if (typeof toggleAddressSearchVisibility === 'function') {
                    toggleAddressSearchVisibility(deviceNumber.trim());
                }

                // Automatically trigger the main DOB search for this device
                if (typeof lookupBIN === 'function') {
                    // Small delay to ensure the main device field is updated first
                    setTimeout(() => {
                        lookupBIN();
                    }, 100);
                }

            } catch (error) {
                console.error('Error searching device:', error);
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Error searching device</span>';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Toggle device search dropdown
        function toggleDeviceSearch() {
            const fields = document.getElementById('deviceSearchFields');
            const arrow = document.getElementById('deviceSearchArrow');
            
            if (fields.style.display === 'none' || fields.style.display === '') {
                fields.style.display = 'block';
                arrow.textContent = 'â–²';
            } else {
                fields.style.display = 'none';
                arrow.textContent = 'â–¼';
            }
        }

        // Refresh device lookup in both ELV3 Lookup panel and main DOB tab
        function refreshDeviceLookup() {
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            const deviceNumber = quickDeviceInput ? quickDeviceInput.value.trim() : '';
            
            if (!deviceNumber) {
                alert('Please enter a device number first');
                return;
            }
            
            // Refresh the ELV3 Lookup panel device search
            searchDeviceInLookup(deviceNumber);
            
            // Also refresh the main DOB tab if we're on the DOB tab or if it exists
            const mainDeviceInput = document.getElementById('deviceNumber');
            if (mainDeviceInput) {
                // Update the main device field if it's different
                if (mainDeviceInput.value !== deviceNumber) {
                    mainDeviceInput.value = deviceNumber;
                }
                
                // Trigger the main DOB lookup
                if (typeof lookupBIN === 'function') {
                    lookupBIN();
                }
            }
        }

        // Clear device lookup input and results
        function clearDeviceLookup() {
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            if (quickDeviceInput) {
                quickDeviceInput.value = '';
                quickDeviceInput.focus();
                updateMainDeviceField('');
                searchDeviceInLookup('');

                // Also clear the main BIN input
                const mainBinInput = document.getElementById('binNumber');
                if (mainBinInput) {
                    mainBinInput.value = '';
                    mainBinInput.dispatchEvent(new Event('input', { bubbles: true }));
                }

                // Also clear outputs on the main DOB page for both Device and BIN searches
                const binResult = document.getElementById('binResult');
                if (binResult) {
                    binResult.innerHTML = '';
                    binResult.style.display = 'none';
                }

                const deviceResult = document.getElementById('deviceResult');
                if (deviceResult) {
                    deviceResult.innerHTML = '';
                    deviceResult.style.display = 'none';
                }

                const exportButton = document.getElementById('binExportButton');
                if (exportButton) {
                    exportButton.style.display = 'none';
                }
            }
        }


    </script>

    <script src="device-filter-functions.js"></script>

    <button onclick="submitFeedback()" class="feedback-button">Submit Feedback</button>
    <div class="credit-text">Created by <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">Michael Montesano</a></div>
</body>
</html>
