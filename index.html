<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELV3 Terminal</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-weight: 900;
            margin: 20px 0;
        }

        .logo {
            display: block;
            margin: 5px auto;
            max-width: 100px;
            height: auto;
        }

        .input-group {
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        input {
            width: 80%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 5px auto;
            display: block;
        }

        .result {
            margin: 10px auto;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            width: 80%;
            display: block;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #333;
        }

        .image-viewer {
            width: 100%;
            height: 80vh;
            margin: 20px 0;
        }

        .image-viewer iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #fff;
            }

            input {
                background-color: #333;
                color: #fff;
                border-color: #666;
            }

            .result {
                background-color: #333;
            }

            button {
                background-color: #fff;
                color: #000;
            }

            button:hover {
                background-color: #ccc;
            }
        }

        @media (max-width: 600px) {
            .input-group {
                width: 90%;
            }
            
            input, .result {
                width: 90%;
            }

            .notes-textarea {
                width: 90%;
            }

            .date-buttons-group {
                display: none !important;
            }
            .date-dropdown-group {
                display: block !important;
            }
        }

        .feedback-button {
            margin-top: 40px;
            margin-bottom: 40px;
        }

        .notes-container {
            max-width: 500px;
            margin: 30px auto;
            text-align: center;
        }

        .notes-textarea {
            width: 80%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            margin: 10px auto;
            resize: vertical;
            display: block;
        }

        @media (prefers-color-scheme: dark) {
            .notes-textarea {
                background-color: #333;
                color: #fff;
                border-color: #666;
            }
        }

        .credit-text {
            text-align: center;
            color: #666;  /* grey color */
            opacity: 0.7;  /* adds transparency */
            font-size: 0.9em;
            margin: 20px 0;
        }

        .social-icons {
            display: flex;
            justify-content: center;
            gap: 20px;  /* space between icons */
            margin: 15px 0;
        }

        .social-icon {
            width: 24px;  /* size of icons */
            height: 24px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .social-icon:hover {
            opacity: 1;
        }

        .dob-viewer {
            width: 100%;
            height: 80vh;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: both;
            overflow: hidden;
            min-height: 300px;
            min-width: 300px;
            max-height: 90vh;
            max-width: 100%;
            position: relative;
        }

        .dob-viewer iframe {
            width: 150%;
            height: 150%;
            border: none;
            transform: scale(0.67);
            transform-origin: 0 0;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;     /* Changed from 2px to 15px for a larger gap */
            margin: 20px 0;
        }

        .tab-button {
            margin: 0;
            border-radius: 0;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .disclaimer {
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        /* Show buttons by default; hide dropdown */
        #tabButtons {
            display: flex;
        }

        #tabDropdown {
            display: none;
        }

        /* For small screens, hide buttons and show dropdown */
        @media (max-width: 900px) {
            #tabButtons {
                display: none;
            }
            #tabDropdown {
                display: block;
            }
            
            .dropdown {
                position: static;
                margin: 10px auto;
                text-align: center;
            }
            
            .dropdown-button {
                display: block;
                margin: 10px auto;
                width: fit-content;
            }

            .dropdown-content {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 200px;
            }
        }

        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-left {
            flex: 1;
            min-width: 0;  /* Prevents flex item from overflowing */
        }

        .reference-panel {
            width: 350px;  /* Slightly wider to accommodate content */
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 80vh;  /* Set a fixed height */
            overflow-y: auto;  /* Enable scrolling */
            display: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .reference-panel ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .reference-panel li {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .reference-panel h3 {
            background-color: #f5f5f5;
            padding: 10px 0;
            margin: 0;
            clear: both;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel {
                background-color: #333;
                box-shadow: 0 0 10px rgba(255,255,255,0.1);
            }
            .reference-panel h3 {
                background-color: #333;
            }
        }

        @media (max-width: 900px) {
            .reference-panel {
                width: 90%;
                max-height: 80vh;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        }

        .show-reference-mobile {
            display: none;
        }

        @media (max-width: 900px) {
            .show-reference-mobile {
                display: block;
                margin: 10px auto;
            }
        }

        .toggle-reference {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1001;
            padding: 8px 16px;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Add this media query to adjust button position on smaller screens */
        @media (max-width: 900px) {
            .toggle-reference {
                position: static;  /* Change from fixed to static positioning */
                display: block;
                margin: 10px auto;  /* Center the button */
                width: fit-content;
            }
        }

        /* Existing dark mode styles */
        @media (prefers-color-scheme: dark) {
            .toggle-reference {
                background-color: #fff;
                color: #000;
            }
            .toggle-reference:hover {
                background-color: #ccc;
            }
        }

        /* Add these styles to your existing CSS */
        .reference-panel {
            /* ... existing styles ... */
            position: fixed;
            z-index: 1000;
        }

        .reference-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .close-reference {
            position: sticky;  /* Change from absolute to sticky */
            top: 0;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;  /* Make it slightly bigger */
            cursor: pointer;
            color: #666;
            padding: 5px 10px;
            float: right;     /* Add float to position it on the right */
            z-index: 2;       /* Ensure it's above other content */
            margin-top: -5px; /* Adjust vertical position */
        }

        .reference-panel h3 {
            background-color: #f5f5f5;
            padding: 10px 0;
            margin: 0;
            clear: both;
        }

        .close-reference:hover {
            color: #000;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel h3 {
                background-color: #333;
            }
            .close-reference {
                color: #999;
            }
            .close-reference:hover {
                color: #fff;
            }
        }

        .reference-panel ul li[style*="font-weight: bold"] {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 20px;
        }

        @media (prefers-color-scheme: dark) {
            .reference-panel ul li[style*="font-weight: bold"] {
                border-bottom-color: #666;
            }
        }

        .dropdown {
            position: fixed;  /* Change from absolute to fixed */
            top: 20px;
            left: 20px;
            z-index: 1001;  /* Ensure it stays above other content */
        }

        /* Add this media query to match Quick Reference button behavior */
        @media (max-width: 900px) {
            .dropdown {
                position: static;  /* Change from fixed to static */
                margin: 10px auto;
                text-align: center;
            }
            
            .dropdown-button {
                display: block;
                margin: 10px auto;
                width: fit-content;
            }

            .dropdown-content {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 200px;
            }
        }

        .dropdown-button {
            background-color: #000;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            margin-top: 5px;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            margin: 0;
            display: block;
            background: none;
            color: black;
            text-align: left;
            border-radius: 0;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            width: 300px;
        }

        @media (prefers-color-scheme: dark) {
            .dropdown-button {
                background-color: #fff;
                color: #000;
            }
            .dropdown-content {
                background-color: #333;
            }
            .dropdown-content button {
                color: white;
            }
            .dropdown-content button:hover {
                background-color: #444;
            }
            .settings-modal {
                background: #333;
                color: white;
            }
        }

        @media (max-width: 600px) {
            .dropdown {
                position: static;
                margin: 20px auto;
                text-align: center;
            }
            .dropdown-content {
                position: relative;
                width: 100%;
                margin: 5px auto;
            }
        }

        /* Add a search icon class */
        .search-icon {
            display: none;  /* Hidden by default */
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Add media query for small screens */
        @media (max-width: 400px) {
            .lookup-button {
                width: 40px !important;
                height: 40px !important;
                padding: 10px !important;
                border-radius: 8px !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
            }

            .lookup-button span {
                display: none;  /* Hide text */
            }

            .lookup-button .search-icon {
                display: block;  /* Show icon */
            }
        }
    </style>
</head>
<body>
    <div class="dropdown">
        <button onclick="toggleDropdown()" class="dropdown-button">Menu ☰</button>
        <div id="dropdownContent" class="dropdown-content">
            <button onclick="openSettings()">Settings</button>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal">
        <h3>Settings</h3>
        <label for="defaultTab">Default Starting Tab:</label>
        <select id="defaultTab" style="width: 100%; padding: 8px; margin: 10px 0;">
            <option value="main">ELV3 Terminal</option>
            <option value="dob">DOB Terminal</option>
            <option value="dates">Dates Terminal</option>
            <option value="pdf">PDF Terminal</option>
        </select>
        <button onclick="saveSettings()">Save</button>
        <button onclick="closeSettings()" style="background-color: #666;">Cancel</button>
    </div>

    <div id="settingsOverlay" class="reference-overlay"></div>

    <a href="javascript:window.location.reload()">
        <img src="https://github.com/mnmontesano/ELV3/blob/main/ELV3%20Cheat%20Sheet%20Icon.png?raw=true" alt="Logo" class="logo">
    </a>
    <h1 id="pageTitle">ELV3 Terminal</h1>

    <!-- Button-based Tabs (default for larger screens) -->
    <div id="tabButtons" class="tab-buttons">
         <button onclick="showTab('main')" id="mainTab" class="tab-button">Main</button>
         <button onclick="showTab('dob')" id="dobTab" class="tab-button">DOB NOW</button>
         <button onclick="showTab('dates')" id="datesTab" class="tab-button">Dates</button>
         <button onclick="showTab('pdf')" id="pdfTab" class="tab-button">PDF</button>
    </div>

    <!-- Dropdown-based Tabs (visible on small screens) -->
    <div id="tabDropdown" class="tab-dropdown" style="margin: 20px auto; text-align: center;">
         <select id="tabSelect" onchange="showTab(this.value)" style="font-size: 1.2em; padding: 5px; text-align: center; text-align-last: center;">
             <option value="main">Main</option>
             <option value="dob">DOB NOW</option>
             <option value="dates">Dates</option>
             <option value="pdf">PDF</option>
         </select>
    </div>

    <div id="mainContent" class="content-section active">
        <button class="toggle-reference" onclick="toggleReference()">Quick Reference</button>
        <div class="main-container">
            <div class="main-left">
                <div class="input-group">
                    <input type="text" id="numInput" placeholder="Enter Elevator Part Number">
                    <div id="numResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="letterInput" placeholder="Enter Violating Condition">
                    <div id="letterResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="secondaryNumInput" placeholder="Enter Suggested Remedy">
                    <div id="secondaryNumResult" class="result"></div>
                </div>

                <button onclick="clearInputs()">Clear</button>
                <button onclick="togglePdfViewer()" id="pdfToggleButton">Show PDF</button>

                <div class="image-viewer hidden" id="pdfViewer">
                    <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                        onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                        <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
                    </iframe>
                </div>

                <div class="notes-container">
                    <h3>Notes</h3>
                    <textarea id="Notes" class="notes-textarea" 
                        placeholder="Enter your notes here..."></textarea>
                </div>
            </div>
        </div>

        <!-- Add this div right after your mainContent div opens -->
        <div class="reference-overlay" onclick="toggleReference()"></div>

        <!-- Modify your reference panel div to include the close button -->
        <div class="reference-panel">
            <button class="close-reference" onclick="toggleReference()">×</button>
            <h3>Quick Reference</h3>
            
            <p><strong>Part Numbers:</strong></p>
            <ul>
                <li style="font-weight: bold; color: #666;">Inside Car (01-15)</li>
                <li>01: Emergency Stop Switch</li>
                <li>02: Alarm System</li>
                <li>03: Car Enclosure</li>
                <li>04: Side Emergency Exit</li>
                <li>05: Car Door/Gate</li>
                <li>06: Car Door/Gate Contact</li>
                <li>07: Door Reopening Device</li>
                <li>08: Car Floor to Landing Still</li>
                <li>09: Car Floor</li>
                <li>10: Car Door Gibs</li>
                <li>11: Car Button Station</li>
                <li>12: Car Lighting</li>
                <li>13: Emergency Lighting</li>
                <li>14: Car Mirror</li>
                <li>15: Certificate Frame</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Outside Hoistway (16-25)</li>
                <li>16: Hoistway Doors</li>
                <li>17: Hoistway Door Gibs</li>
                <li>18: Hoistway Door Reinforcements</li>
                <li>19: Hoistway Door Safety Retainer</li>
                <li>20: Vision Panel</li>
                <li>21: Interlocks</li>
                <li>22: Parking Device</li>
                <li>23: Hall Button Station</li>
                <li>24: Indicators</li>
                <li>25: Door Safety Retainer</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Top of Car (26-39)</li>
                <li>26: Top Emergency Exit Cover</li>
                <li>27: Governor Release Carrier</li>
                <li>28: Door Hangers & Connectors</li>
                <li>29: Door Operator</li>
                <li>30: Normal Limits</li>
                <li>31: Final Limits</li>
                <li>32: Guide Shoes / Roller Guides</li>
                <li>33: Counterweight</li>
                <li>34: Hoistway</li>
                <li>35: Electrical Wiring</li>
                <li>36: Pipes and Ducts</li>
                <li>37: Overhead & Deflector Sheave</li>
                <li>38: Traveling Cable & Junction</li>
                <li>39: Car Top</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Machine Room (40-69)</li>
                <li>40: Machine Room</li>
                <li>41: Machine Room Door</li>
                <li>42: Controller—Selector</li>
                <li>43: Reverse Phase Relay</li>
                <li>44: Traction Sheave</li>
                <li>45: Governor</li>
                <li>46: Governor Switch</li>
                <li>47: Drum</li>
                <li>48: Pump Unit</li>
                <li>49: Drum Machine Limit SW</li>
                <li>50: Generator</li>
                <li>51: Slack Rope Switch</li>
                <li>52: Hoist Cables</li>
                <li>53: Governor Ropes</li>
                <li>54: Car Counterweight Rope</li>
                <li>55: Drum Counterweight Rope</li>
                <li>56: Hoist Machine</li>
                <li>57: Hoist Motor</li>
                <li>58: Worm / Gear / Bearings</li>
                <li>59: Machine Brake</li>
                <li>60: Lighting Machine Space</li>
                <li>61: Machine Disconnect SW</li>
                <li>62: Commutator</li>
                <li>63: Motor Brushes</li>
                <li>64: NYC Device #</li>
                <li>65: Unintended Car Movement</li>
                <li>66: Emergency Brake/Rope Gripper</li>
                <li>67: Communication</li>
                <li>68: Maintenance Log</li>
                <li>69: Code Data Plate</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Pit (70-82)</li>
                <li>70: Pit</li>
                <li>71: Pit Light</li>
                <li>72: Pit Stop Switch</li>
                <li>73: Car Guide-Rails & Brackets</li>
                <li>74: Cwt Guide-Rails & Brackets</li>
                <li>75: Buffers</li>
                <li>76: Car Safety & Tail Rope</li>
                <li>77: Underside Platform</li>
                <li>78: Tension Weight</li>
                <li>79: Comp / Chains / Ropes / Switch</li>
                <li>80: Counterweight Runby</li>
                <li>81: Counterweight Runby Signage</li>
                <li>82: Plunger Gripper</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Escalator/Moving Walk (83-96)</li>
                <li>83: Fire Shutters</li>
                <li>84: Skirt Switch</li>
                <li>85: Skirt Deflection Device</li>
                <li>86: Comb Plate / Comb Plate Teeth</li>
                <li>87: Landing Plate / Impact Switches</li>
                <li>88: Handrails / Handrail Safeties</li>
                <li>89: Step / Thread</li>
                <li>90: Key Switch</li>
                <li>91: Emergency Stop Button</li>
                <li>92: Decking and Ballistrades</li>
                <li>93: Ceiling Guards</li>
                <li>94: Deck Barricades</li>
                <li>95: Internal Safeties</li>
                <li>96: Safety Signage</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">All Types (97-100)</li>
                <li>97: Entire Device</li>
                <li>98: Current Five Year Tag</li>
                <li>99: Current One Year Tag</li>
                <li>100: Miscellaneous</li>
            </ul>

            <p><strong>Violations:</strong></p>
            <ul>
                <li>A: Altered</li>
                <li>B: Insufficient</li>
                <li>C: Padlocked</li>
                <li>D: Unsecured</li>
                <li>E: Rubbing</li>
                <li>F: Lost Motion</li>
                <li>G: Improper Fuses</li>
                <li>H: Worn</li>
                <li>I: Damaged</li>
                <li>J: Misaligned</li>
                <li>K: Rusted</li>
                <li>L: Defective</li>
                <li>M: Missing</li>
                <li>N: By-Passed</li>
                <li>O: Dirty</li>
                <li>P: No Means Of Access</li>
                <li>Q: Unguarded</li>
                <li>R: Illegal</li>
                <li>S: Not Fire Retardant</li>
                <li>T: Unlabeled</li>
                <li>U: Device Not Tagged</li>
                <li>V: Not Level</li>
                <li>W: Unlocked</li>
                <li>X: Inoperative</li>
                <li>Y: Oil Leak</li>
                <li>Z: Water Leak</li>
                <li>AA: Carbon Buildup</li>
                <li>BB: Expired Tag</li>
            </ul>

            <p><strong>Remedies:</strong></p>
            <ul>
                <li>01: Adjust</li>
                <li>02: Clean</li>
                <li>03: Install Guards</li>
                <li>04: Patch</li>
                <li>05: Perform & File Test</li>
                <li>06: Properly Secure</li>
                <li>07: Provide</li>
                <li>08: Regroove</li>
                <li>09: Remove</li>
                <li>10: Repair</li>
                <li>11: Replace</li>
                <li>12: Reshackle</li>
                <li>13: Seal</li>
                <li>14: Shorten</li>
                <li>15: Tag Device</li>
                <li>16: Provide Means of Access</li>
                <li>17: Re-inspection Required</li>
            </ul>
        </div>
    </div>

    <div id="dobContent" class="content-section">
        <!-- Add BIN Lookup Section at the top -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: #2c2c2c; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <h3 style="text-align: center; margin-bottom: 20px; color: #ffffff;">Device & BIN Lookup</h3>
            
            <!-- Device Number Search -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #ffffff; margin-bottom: 10px;">Search by Device Number:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="deviceNumber" 
                           placeholder="Enter Device Number"
                           oninput="this.value = this.value.toUpperCase()"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid #444; background: #1c1c1c; color: #ffffff; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupBIN()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span>Look up BIN</span>
                                <div class="search-icon"></div>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 8px; background: #333; color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; margin-left: 5px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
                <div id="binResult" class="result" style="margin-top: 15px; display: none;">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- BIN Search -->
            <div style="margin-top: 20px;">
                <h4 style="color: #ffffff; margin-bottom: 10px;">Search by BIN:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="binNumber" 
                           placeholder="Enter BIN Number"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid #444; background: #1c1c1c; color: #ffffff; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupDevices()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span>Find Devices</span>
                                <div class="search-icon"></div>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 8px; background: #333; color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; margin-left: 5px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
                <div id="deviceResult" class="result" style="margin-top: 15px; display: none;">
                    <!-- Device results will be displayed here -->
                </div>
            </div>

            <!-- Move export button here, before Clear All -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="binExportButton" 
                        onclick="exportBinToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <!-- Add Clear Button -->
            <button onclick="clearLookups()" 
                    style="display: block; margin: 25px auto 5px; padding: 12px 30px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                Clear All
            </button>
        </div>

        <!-- Add this after the existing lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: #2c2c2c; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <h3 style="text-align: center; margin-bottom: 20px; color: #ffffff;">Bulk Device Lookup</h3>
            
            <div style="margin-bottom: 15px; padding: 0 5px;">
                <textarea id="bulkDeviceNumbers" 
                         placeholder="Enter multiple device numbers (one per line)"
                         oninput="this.value = this.value.toUpperCase()"
                         style="width: calc(100% - 10px); height: 100px; padding: 12px; border-radius: 4px; border: 1px solid #444; background: #1c1c1c; color: #ffffff; resize: vertical;"></textarea>
            </div>

            <!-- Modify the bulk lookup buttons div -->
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="lookupBulkDevices()" 
                        style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Look up All Devices
                </button>
                <button onclick="clearBulkLookup()" 
                        style="padding: 12px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Clear
                </button>
                <button id="exportButton" 
                        onclick="exportToCSV()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export to CSV
                </button>
            </div>

            <div id="bulkResult" class="result" style="margin-top: 15px; display: none;">
                <!-- Results will be displayed here -->
            </div>
        </div>

        <!-- Existing DOB NOW content -->
        <div style="display: flex; justify-content: center; gap: 10px; margin: 10px auto;">
            <button onclick="refreshDOB()" style="display: inline-block; margin: 0; padding: 8px 16px;">Refresh DOB Page</button>
            <button onclick="popoutDOB()" style="display: inline-block; margin: 0; padding: 8px 16px;">Open in New Window</button>
        </div>
        <div id="dobWindows">
            <div class="dob-viewer">
                <iframe src="https://a810-dobnow.nyc.gov/publish/Index.html#!/" frameborder="0"></iframe>
            </div>
        </div>
        <button onclick="addDOBWindow()" style="display: block; margin: 10px auto 30px auto; padding: 8px 16px;">
            <span style="font-size: 20px;">+</span> Add DOB Window
        </button>
        <div class="disclaimer" style="margin-top: 20px;">
            <span style="color: red;">Disclaimer: The DOB NOW page is provided by the New York City Department of Buildings. This embeded page should not be used as an official source for filing and should only be used to quickly look up information related to a building or device.</span>
        </div>
    </div>

    <div id="datesContent" class="content-section">
        <div class="input-group">
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput">
        </div>
        
        <!-- Adding back the buttons -->
        <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="calculateDate(30)" style="display: inline-block; margin: 0;">30 Days</button>
            <button onclick="calculateDate(60)" style="display: inline-block; margin: 0;">60 Days</button>
            <button onclick="calculateDate(90)" style="display: inline-block; margin: 0;">90 Days</button>
        </div>
        
        <!-- Adding back the dropdown for small screens -->
        <div class="date-dropdown-group" style="display: none; text-align: center; margin: 10px auto;">
            <select id="daysSelect" onchange="calculateDate(parseInt(this.value))" style="padding: 8px; width: 200px;">
                <option value="">Select Days</option>
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="90">90 Days</option>
            </select>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <input type="number" id="customDays" placeholder="Enter number of days" style="width: 200px;">
            <button onclick="calculateCustomDate()" style="display: inline-block; margin: 10px;">Calculate Custom Days</button>
        </div>
        <div id="dateResult" class="result" style="width:80%;"></div>
        <div id="dateSpelledResult" class="result" style="width:80%;"></div>

        <!-- Modify the 90-day start date div -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold;">Any date before:</div>
            <div id="ninetyDayStart" style="margin: 10px 0;"></div>
        </div>

        <button onclick="clearDateInput()">Clear</button>
    </div>

    <div id="pdfContent" class="content-section">
        <div class="pdf-viewer" style="width: 100%; height: 80vh;">
            <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
            </iframe>
        </div>
    </div>

    <script>
        function numberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "00": "Invalid number",
                "01": "Emergency Stop Switch",
                "1": "Emergency Stop Switch",
                "emergency stop switch": "01",
                "02": "Alarm System",
                "2": "Alarm System",
                "alarm system": "02",
                "03": "Car Enclosure",
                "3": "Car Enclosure",
                "car enclosure": "03",
                "04": "Side Emergency Exit",
                "4": "Side Emergency Exit",
                "side emergency exit": "04",
                "05": "Car Door/Gate",
                "5": "Car Door/Gate",
                "car door/gate": "05",
                "06": "Car Door/Gate Contact",
                "6": "Car Door/Gate Contact",
                "car door/gate contact": "06",
                "07": "Door Reopening Device",
                "7": "Door Reopening Device",
                "door reopening device": "07",
                "08": "Car Floor to Landing Still",
                "8": "Car Floor to Landing Still",
                "car floor to landing still": "08",
                "09": "Car Floor",
                "9": "Car Floor",
                "car floor": "09",
                "10": "Car Door Gibs",
                "car door gibs": "10",
                "11": "Car Button Station",
                "car button station": "11",
                "12": "Car Lighting",
                "car lighting": "12",
                "13": "Emergency Lighting",
                "emergency lighting": "13",
                "14": "Car Mirror",
                "car mirror": "14",
                "15": "Certificate Frame",
                "certificate frame": "15",
                "16": "Hoistway Doors",
                "hoistway doors": "16",
                "17": "Hoistway Door Gibs",
                "hoistway door gibs": "17",
                "18": "Hoistway Door Reinforcements",
                "hoistway door reinforcements": "18",
                "19": "Hoistway Door Safety Retainer",
                "hoistway door safety retainer": "19",
                "20": "Vision Panel",
                "vision panel": "20",
                "21": "Interlocks",
                "interlocks": "21",
                "22": "Parking Device",
                "parking device": "22",
                "23": "Hall Button Station",
                "hall button station": "23",
                "24": "Indicators",
                "indicators": "24",
                "25": "Door Safety Retainer",
                "door safety retainer": "25",
                "26": "Top Emergency Exit Cover",
                "top emergency exit cover": "26",
                "27": "Governor Release Carrier",
                "governor release carrier": "27",
                "28": "Door Hangers & Connectors",
                "door hangers & connectors": "28",
                "29": "Door Operator",
                "door operator": "29",
                "30": "Normal Limits",
                "normal limits": "30",
                "31": "Final Limits",
                "final limits": "31",
                "32": "Guide Shoes / Roller Guides",
                "guide shoes / roller guides": "32",
                "33": "Counterweight",
                "counterweight": "33",
                "34": "Hoistway",
                "hoistway": "34",
                "35": "Electrical Wiring",
                "electrical wiring": "35",
                "36": "Pipes and Ducts",
                "pipes and ducts": "36",
                "37": "Overhead & Deflector Sheave",
                "overhead & deflector sheave": "37",
                "38": "Traveling Cable & Junction",
                "traveling cable & junction": "38",
                "39": "Car Top",
                "car top": "39",
                "40": "Machine Room",
                "machine room": "40",
                "41": "Machine Room Door",
                "machine room door": "41",
                "42": "Controller—Selector",
                "controller—selector": "42",
                "43": "Reverse Phase Relay",
                "reverse phase relay": "43",
                "44": "Traction Sheave",
                "traction sheave": "44",
                "45": "Governor",
                "governor": "45",
                "46": "Governor Switch",
                "governor switch": "46",
                "47": "Drum",
                "drum": "47",
                "48": "Pump Unit",
                "pump unit": "48",
                "49": "Drum Machine Limit SW",
                "drum machine limit sw": "49",
                "50": "Generator",
                "generator": "50",
                "51": "Slack Rope Switch",
                "slack rope switch": "51",
                "52": "Hoist Cables",
                "hoist cables": "52",
                "53": "Governor Ropes",
                "governor ropes": "53",
                "54": "Car Counterweight Rope",
                "car counterweight rope": "54",
                "55": "Drum Counterweight Rope",
                "drum counterweight rope": "55",
                "56": "Hoist Machine",
                "hoist machine": "56",
                "57": "Hoist Motor",
                "hoist motor": "57",
                "58": "Worm / Gear / Bearings",
                "worm / gear / bearings": "58",
                "59": "Machine Brake",
                "machine brake": "59",
                "60": "Lighting Machine Space",
                "lighting machine space": "60",
                "61": "Machine Disconnect SW",
                "machine disconnect sw": "61",
                "62": "Commutator",
                "commutator": "62",
                "63": "Motor Brushes",
                "motor brushes": "63",
                "64": "NYC Device #",
                "nyc device #": "64",
                "65": "Unintended Car Movement",
                "unintended car movement": "65",
                "66": "Emergency Brake/Rope Gripper",
                "emergency brake/rope gripper": "66",
                "67": "Communication",
                "communication": "67",
                "68": "Maintenance Log",
                "maintenance log": "68",
                "69": "Code Data Plate",
                "code data plate": "69",
                "70": "Pit",
                "pit": "70",
                "71": "Pit Light",
                "pit light": "71",
                "72": "Pit Stop Switch",
                "pit stop switch": "72",
                "73": "Car Guide-Rails & Brackets",
                "car guide-rails & brackets": "73",
                "74": "Cwt Guide-Rails & Brackets",
                "cwt guide-rails & brackets": "74",
                "75": "Buffers",
                "buffers": "75",
                "76": "Car Safety & Tail Rope",
                "car safety & tail rope": "76",
                "77": "Underside Platform",
                "underside platform": "77",
                "78": "Tension Weight",
                "tension weight": "78",
                "79": "Comp / Chains / Ropes / Switch",
                "comp / chains / ropes / switch": "79",
                "80": "Counterweight Runby",
                "counterweight runby": "80",
                "81": "Counterweight Runby Signage",
                "counterweight runby signage": "81",
                "82": "Plunger Gripper",
                "plunger gripper": "82",
                "83": "Fire Shutters",
                "fire shutters": "83",
                "84": "Skirt Switch",
                "skirt switch": "84",
                "85": "Skirt Deflection Device",
                "skirt deflection device": "85",
                "86": "Comb Plate / Comb Plate Teeth",
                "comb plate / comb plate teeth": "86",
                "87": "Landing Plate / Impact Switches",
                "landing plate / impact switches": "87",
                "88": "Handrails / Handrail Safeties",
                "handrails / handrail safeties": "88",
                "89": "Step / Thread",
                "step / thread": "89",
                "90": "Key Switch",
                "key switch": "90",
                "91": "Emergency Stop Button",
                "emergency stop button": "91",
                "92": "Decking and Ballistrades",
                "decking and ballistrades": "92",
                "93": "Ceiling Guards",
                "ceiling guards": "93",
                "94": "Deck Barricades",
                "deck barricades": "94",
                "95": "Internal Safeties",
                "internal safeties": "95",
                "96": "Safety Signage",
                "safety signage": "96",
                "97": "Entire Device",
                "entire device": "97",
                "98": "Current Five Year Tag",
                "current five year tag": "98",
                "99": "Current One Year Tag",
                "current one year tag": "99",
                "100": "Miscellaneous",
                "miscellaneous": "100"
            };

            let result = mapping[input] || "Invalid Number";
            
            // Only add location information if the result is a description (not a code)
            if (result !== "Invalid Number" && result !== "Enter Number" && !result.match(/^\d+$/)) {
                var intValue = parseInt(input);
                if (intValue >= 1 && intValue <= 15) {
                    result += " (Inside Car)";
                }
                
                if (intValue >= 16 && intValue <= 25) {
                    result += " (Outside Hoistway)";
                }
                
                if (intValue >= 26 && intValue <= 39) {
                    result += " (Top of Car)";
                }
                
                if (intValue >= 40 && intValue <= 69) {
                    result += " (Machine Room)";
                }
                
                if (intValue >= 70 && intValue <= 82) {
                    result += " (Pit)";
                }
                
                if (intValue >= 83 && intValue <= 96) {
                    result += " (Escalator/Moving Walk)";
                }
                
                if (intValue >= 97 && intValue <= 100) {
                    result += " (All Types)";
                }
            }
            
            return result;
        }

        function letterToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Letter",
                "a": "Altered",
                "altered": "A",
                "b": "Insufficient",
                "insufficient": "B",
                "c": "Padlocked",
                "padlocked": "C",
                "d": "Unsecured",
                "unsecured": "D",
                "e": "Rubbing",
                "rubbing": "E",
                "f": "Lost Motion",
                "lost motion": "F",
                "g": "Improper Fuses",
                "improper fuses": "G",
                "h": "Worn",
                "worn": "H",
                "i": "Damaged",
                "damaged": "I",
                "j": "Misaligned",
                "misaligned": "J",
                "k": "Rusted",
                "rusted": "K",
                "l": "Defective",
                "defective": "L",
                "m": "Missing",
                "missing": "M",
                "n": "By-Passed",
                "by-passed": "N",
                "o": "Dirty",
                "dirty": "O",
                "p": "No Means Of Access",
                "no means of access": "P",
                "q": "Unguarded",
                "unguarded": "Q",
                "r": "Illegal",
                "illegal": "R",
                "s": "Not Fire Retardant",
                "not fire retardant": "S",
                "t": "Unlabeled",
                "unlabeled": "T",
                "u": "Device Not Tagged",
                "device not tagged": "U",
                "v": "Not Level",
                "not level": "V",
                "w": "Unlocked",
                "unlocked": "W",
                "x": "Inoperative",
                "inoperative": "X",
                "y": "Oil Leak",
                "oil leak": "Y",
                "z": "Water Leak",
                "water leak": "Z",
                "aa": "Carbon Buildup",
                "carbon buildup": "AA",
                "bb": "Expired Tag",
                "expired tag": "BB"
            };
            
            return mapping[input] || "Invalid Letter";
        }

        function secondaryNumberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "01": "Adjust",
                "1": "Adjust", 
                "adjust": "01",
                "02": "Clean",
                "2": "Clean",
                "clean": "02", 
                "03": "Install Guards",
                "3": "Install Guards",
                "install guards": "03",
                "04": "Patch",
                "4": "Patch",
                "patch": "04",
                "05": "Perform & File Test",
                "5": "Perform & File Test", 
                "perform & file test": "05",
                "06": "Properly Secure",
                "6": "Properly Secure",
                "properly secure": "06",
                "07": "Provide",
                "7": "Provide",
                "provide": "07",
                "08": "Regroove", 
                "8": "Regroove",
                "regroove": "08",
                "09": "Remove",
                "9": "Remove",
                "remove": "09",
                "10": "Repair",
                "repair": "10",
                "11": "Replace",
                "replace": "11",
                "12": "Reshackle",
                "reshackle": "12",
                "13": "Seal",
                "seal": "13",
                "14": "Shorten",
                "shorten": "14",
                "15": "Tag Device",
                "tag device": "15",
                "16": "Provide Means of Access",
                "provide means of access": "16",
                "17": "Re-inspection Required",
                "re-inspection required": "17"
            };
            
            return mapping[input] || "Invalid Number";
        }

        document.getElementById('numInput').addEventListener('input', function(e) {
            let result = numberToWord(e.target.value);
            document.getElementById('numResult').textContent = result;
        });

        document.getElementById('letterInput').addEventListener('input', function(e) {
            let result = letterToWord(e.target.value);
            document.getElementById('letterResult').textContent = result;
        });

        document.getElementById('secondaryNumInput').addEventListener('input', function(e) {
            let result = secondaryNumberToWord(e.target.value);
            document.getElementById('secondaryNumResult').textContent = result;
        });

        function clearInputs() {
            document.getElementById('numInput').value = '';
            document.getElementById('letterInput').value = '';
            document.getElementById('secondaryNumInput').value = '';
            document.getElementById('numResult').textContent = '';
            document.getElementById('letterResult').textContent = '';
            document.getElementById('secondaryNumResult').textContent = '';
            document.getElementById('numInput').focus();
        }

        function togglePdfViewer() {
            const viewer = document.getElementById('pdfViewer');
            const button = document.getElementById('pdfToggleButton');
            viewer.classList.toggle('hidden');
            button.textContent = viewer.classList.contains('hidden') ? 'Show PDF' : 'Hide PDF';
        }

        function showTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName + 'Content').classList.add('active');
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.backgroundColor = '';
            });
            document.getElementById(tabName + 'Tab').style.backgroundColor = '#333';
            updatePageTitle(tabName);
        }

        function updatePageTitle(tabName) {
            const titleMapping = {
                main: 'ELV3 Terminal',
                dob: 'DOB Terminal',
                dates: 'Dates Terminal',
                pdf: 'PDF Terminal'
            };
            document.title = titleMapping[tabName];
            document.getElementById('pageTitle').textContent = titleMapping[tabName];
        }

        function submitFeedback() {
            window.location.href = "mailto:michaelmontesano@gmail.com?subject=ELV3 Cheat Sheet Feedback";
        }

        // Load saved notes when page loads
        window.onload = function() {
            const savedNotes = localStorage.getItem('elevatorNotes');
            if (savedNotes) {
                document.getElementById('Notes').value = savedNotes;
            }
            calculateNinetyDayStart();

            // Load default tab if set
            const defaultTab = localStorage.getItem('defaultTab');
            if (defaultTab) {
                showTab(defaultTab);
            }
        }

        // Save notes when user types
        document.getElementById('Notes').addEventListener('input', function(e) {
            localStorage.setItem('elevatorNotes', e.target.value);
        });

        function calculateDate(days) {
            const dateStr = document.getElementById('dateInput').value;
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Create date object and set to noon UTC
            const inputDate = new Date(dateStr);
            inputDate.setUTCHours(12, 0, 0, 0);
            
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            document.getElementById('dateResult').textContent = days + " days after " + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            // Spelled-out format using long options
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = "" + spelledInput + " becomes " + spelledResult;
        }

        function calculateCustomDate() {
            const dateStr = document.getElementById('dateInput').value;
            const days = parseInt(document.getElementById('customDays').value);
            
            if (isNaN(days)) {
                document.getElementById('dateResult').textContent = "Please enter a valid number.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Add maximum reasonable limit
            if (Math.abs(days) > 36500) { // 100 years
                document.getElementById('dateResult').textContent = "Please enter a more reasonable number of days.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            const inputDate = new Date(dateStr + "T12:00:00");
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = 
                absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = 
                spelledInput + " becomes " + spelledResult;
        }

        function clearDateInput() {
            document.getElementById('dateInput').value = '';
            document.getElementById('customDays').value = '';
            document.getElementById('daysSelect').value = ''; // Reset dropdown
            document.getElementById('dateResult').textContent = '';
            document.getElementById('dateSpelledResult').textContent = '';
        }

        function refreshDOB() {
            const iframe = document.querySelector('#dobContent .dob-viewer iframe');
            if (iframe) {
                // Reassigning src forces the iframe to reload
                iframe.src = iframe.src;
            }
        }

        function popoutDOB() {
            window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank', 'width=1200,height=800');
        }

        function addDOBWindow() {
            const newWindow = document.createElement('div');
            newWindow.className = 'dob-viewer';
            newWindow.innerHTML = '<iframe src="https://a810-dobnow.nyc.gov/publish/Index.html#!/" frameborder="0"></iframe>';
            document.getElementById('dobWindows').appendChild(newWindow);
        }

        function toggleReference() {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'Quick Reference';
            } else {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                button.textContent = 'Hide Reference';
            }
            
            // Prevent the click from immediately triggering the document click handler
            event.stopPropagation();
        }

        // Update the click outside handler
        document.addEventListener('click', function(event) {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            // Check if the click is outside the panel and not on the toggle button
            if (panel.style.display === 'block' && 
                !panel.contains(event.target) && 
                event.target !== button) {
                
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'Quick Reference';
            }
        });

        // Update the panel click handler
        document.querySelector('.reference-panel').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        function calculateNinetyDayStart() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 90);
            
            // Format for the simple date
            const simpleDate = startDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = startDate.toLocaleDateString('en-US', options);
            
            document.getElementById('ninetyDayStart').innerHTML = 
                `<div>Any date before: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownContent');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Load current setting
            const savedTab = localStorage.getItem('defaultTab') || 'main';
            document.getElementById('defaultTab').value = savedTab;
            
            // Close dropdown
            document.getElementById('dropdownContent').style.display = 'none';
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function saveSettings() {
            const defaultTab = document.getElementById('defaultTab').value;
            localStorage.setItem('defaultTab', defaultTab);
            closeSettings();
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-button')) {
                const dropdown = document.getElementById('dropdownContent');
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                }
            }
        }

        // Add this new function to your script section
        async function lookupBIN() {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const resultDiv = document.getElementById('binResult');
            const binInput = document.getElementById('binNumber');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: #ffffff;">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    if (device.bin) {
                        lookupDevices();
                    }

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    resultDiv.innerHTML = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">BIN:</strong> 
                                <span>${device.bin || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                                <strong style="color: #4a9eff; margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span>${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span>${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span>${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span>${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            <!-- Add More Info button and dropdown -->
                            <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                                <button onclick="toggleMoreInfo('moreInfo_${device.device_number}')"
                                        style="width: 100%; padding: 10px; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span>More Info</span>
                                    <span class="arrow">▼</span>
                                </button>
                                <div id="moreInfo_${device.device_number}" style="display: none; margin-top: 10px; padding: 10px; background: #2c2c2c; border-radius: 4px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Block:</strong> 
                                        <span>${device.block || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Lot:</strong> 
                                        <span>${device.lot || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                element.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Add event listener for Enter key
        document.getElementById('deviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupBIN();
            }
        });

        // Add the new lookupDevices function
        async function lookupDevices() {
            const binNumber = document.getElementById('binNumber').value.trim();
            const resultDiv = document.getElementById('deviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: #ffffff;">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices
                    const removedDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'REMOVED'
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Add back the device grouping code
                    const deviceTypes = {};
                    data.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!deviceTypes[type]) {
                            deviceTypes[type] = [];
                        }
                        deviceTypes[type].push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #4a9eff;">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Total Devices Found:</strong> 
                                <span>${data.length}</span>
                                <br>
                                <span style="margin-left: 20px; color: #4CAF50;">• Active Devices: ${activeDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: #ff6b6b;">• Removed Devices: ${removedDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: #ffd700;">• Dismantled Devices: ${dismantledDevices}</span>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: #4a9eff; display: block; margin-bottom: 10px;">Devices by Type:</strong>
                                <div style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                    `;
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        html += generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR']);
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    // Then display the rest of the device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        html += generateDeviceTypeSection(type, devices);
                    }
                    
                    html += `</div></div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
            }
        }

        // Helper function to generate HTML for a device type section
        function generateDeviceTypeSection(type, devices) {
            return `
                <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                        <strong style="color: #4a9eff;">${type}:</strong> ${devices.length} device(s)
                    </div>
                    <div style="padding-left: 15px;">
                        ${devices.map(device => `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                <strong style="color: #4a9eff;">Device #:</strong> ${device.device_number}<br>
                                <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('binNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupDevices();
            }
        });

        // Add this new function to your script section
        function clearLookups() {
            // Clear input fields
            document.getElementById('deviceNumber').value = '';
            document.getElementById('binNumber').value = '';
            document.getElementById('binResult').style.display = 'none';
            document.getElementById('deviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
            window.lastBinSearchResults = null;
        }

        // Add these new functions to your script section
        async function lookupBulkDevices() {
            const textarea = document.getElementById('bulkDeviceNumbers');
            const resultDiv = document.getElementById('bulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: #ffffff;">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                    } else {
                        notFound.push(deviceNumber);
                    }
                }

                let html = `
                    <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #4a9eff;">Total Devices Searched:</strong> 
                            <span>${deviceNumbers.length}</span>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices
                for (const [bin, group] of Object.entries(binGroups)) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                <strong style="color: #4a9eff;">Devices Found:</strong> ${group.devices.length}
                            </div>
                            <div style="padding-left: 15px;">
                    `;

                    group.devices.forEach(device => {
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                <strong style="color: #4a9eff;">Device Number:</strong> ${device.device_number}<br>
                                <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="color: #ff6b6b;">
                                <strong>Devices Not Found:</strong>
                                <div style="margin-top: 5px;">
                                    ${notFound.join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                document.getElementById('exportButton').style.display = 'none';
            }
        }

        function clearBulkLookup() {
            document.getElementById('bulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('bulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function lookupAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('addressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: #ffffff;">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }

                const [_, houseNumber, streetName] = match;
                
                // Build the query
                const query = `$where=UPPER(house_number)='${houseNumber}' AND UPPER(street_name) like '${streetName}%'${borough ? ` AND UPPER(borough) like '${borough}%'` : ''}`;
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${query}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Group results by BIN to avoid duplicates
                    const binGroups = {};
                    data.forEach(device => {
                        if (!binGroups[device.bin]) {
                            binGroups[device.bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[device.bin].devices.push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                            </div>
                            <div style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                    `;

                    for (const [bin, group] of Object.entries(binGroups)) {
                        html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearAddressLookup() {
            document.getElementById('fullAddress').value = '';
            const resultDiv = document.getElementById('addressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('fullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAddress();
            }
        });

        // Add this new function to your script section
        function exportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add found devices
            for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                group.devices.forEach(device => {
                    const row = [
                        device.device_number,
                        bin,
                        `${device.house_number} ${device.street_name}`,
                        device.borough,
                        device.device_type || 'N/A',
                        device.device_status || 'N/A'
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_lookup_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add all devices
            data.forEach(device => {
                const row = [
                    device.device_number,
                    device.bin,
                    `${device.house_number} ${device.street_name}`,
                    device.borough,
                    device.device_type || 'N/A',
                    device.device_status || 'N/A'
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bin_${data[0].bin}_devices.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add this function to fetch violations
        async function fetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the lookupDeviceDetails function
        async function lookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
            const violations = await fetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong>Violation #:</strong> ${v.violation_number}<br>
                                    <strong>Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong>Status:</strong> ${v.violation_status}<br>
                                    <strong>Type:</strong> ${v.violation_type}<br>
                                    <strong>Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            deviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong>Device #:</strong> ${deviceNumber}<br>
                        <strong>Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong>Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong>Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong>BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            deviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function exportToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await fetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Rest of the export function remains the same...
        }

        // Add these functions to your script section
        async function handleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to your JavaScript section
        function clearDeviceSearch() {
            document.getElementById('deviceNumber').value = '';
            document.getElementById('binNumber').value = '';
            document.getElementById('binResult').style.display = 'none';
            document.getElementById('deviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
        }
    </script>

    <button onclick="submitFeedback()" class="feedback-button">Submit Feedback</button>
    <div class="credit-text">Created by <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">Michael N. Montesano</a></div>
    <div class="social-icons">
        <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">
            <img src="linkedin-icon.svg" alt="LinkedIn" class="social-icon" onerror="this.innerText='LinkedIn'">
        </a>
    </div>
</body>
</html>
