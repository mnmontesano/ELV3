<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertical Terminal</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css">
    <!-- PDF-lib for ELV3 PDF parsing -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- Inline theme application to prevent flash: always follow system -->
    <script>
        (function() {
            document.documentElement.classList.remove('light-theme', 'dark-theme', 'system-theme');
            document.documentElement.classList.add('system-theme');
            // Pre-detect popout to avoid flashing the full UI
            try {
                var params = new URLSearchParams(window.location.search);
                if (params.get('popout') === 'lookup') {
                    document.documentElement.classList.add('lookup-popout-boot');
                }
            } catch (e) {}
        })();
    </script>
    <style>
        /* Ensure only the ELV3 Lookup panel shows in popout mode, with minimal flash */
        html.lookup-popout-boot body { max-width: none !important; margin: 0 !important; padding: 0 !important; }
        html.lookup-popout-boot body > *:not(#quickLookupPanel) { display: none !important; }
        html.lookup-popout-boot #quickLookupPanel {
            display: block !important;
            position: fixed !important;
            top: 24px !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translateX(-50%) !important;
            width: min(440px, 100% - 32px) !important;
            max-height: calc(100vh - 48px) !important;
            overflow-y: auto !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
            padding: 16px !important;
            opacity: 1 !important;
            z-index: 1 !important;
        }
    </style>
    
    <script src="theme_script.js"></script>
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet library for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body data-active-tab="main">
    <!-- Disclaimer Modal - Shows on page load (TEMPORARILY DISABLED - change display to flex to re-enable) -->
    <div id="disclaimerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
        <div style="background: var(--card-bg, #fff); border-radius: 12px; padding: 30px; max-width: 500px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.3); text-align: center;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h2 style="color: #d9534f; margin: 0 0 20px 0; font-size: 24px;">Warning</h2>
            <p style="color: var(--text-color, #333); line-height: 1.6; margin-bottom: 25px; font-size: 14px; text-align: left;">
                Use of the Vertical Terminal and the information it presents should not be taken as a primary source. All data presented should be verified with the primary source DOB (Department of Buildings) before making any decisions based on the information present.
            </p>
            <p style="color: var(--text-color, #333); line-height: 1.6; margin-bottom: 25px; font-size: 14px; text-align: left; font-weight: bold;">
                By using this webpage you acknowledge this and agree to these terms and conditions.
            </p>
            <button id="disclaimerAcceptBtn" onclick="acceptDisclaimer()" style="padding: 14px 40px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s ease;">
                I Understand and Agree
            </button>
        </div>
    </div>

    <!-- Make sure this is right after the opening <body> tag -->
    <div id="quickLookupOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <!-- Global DOB Now button (visible on all tabs/pages) -->
    <button id="dobNowBtn" onclick="window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=yes,menubar=yes,location=yes')" 
            style="position: fixed; top: 80px; right: 20px; z-index: 999; padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
        <span class="button-text">DOB Now</span>
        <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
        </svg>
    </button>

    <!-- Quick Lookup Panel moved here so it's available for all tabs -->
    <div style="position: fixed; top: 80px; right: 20px; width: 350px; max-width: calc(100% - 40px); max-height: calc(100vh - 100px); background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--card-shadow); z-index: 1000; display: none; transition: all 0.3s ease; left: auto; overflow-y: auto; overflow-x: hidden;" id="quickLookupPanel">
        <button onclick="popoutQuickLookup()" title="Open in new window" style="position: absolute; right: 44px; top: 10px; background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; transition: color 0.2s; line-height: 1;" aria-label="Pop out">‚§¢</button>
        <button onclick="toggleQuickLookup()" style="position: absolute; right: 10px; top: 10px; background: none; border: none; color: #ff6b6b; font-size: 20px; cursor: pointer; transition: color 0.2s; line-height: 1;">√ó</button>
        <h3 style="color: var(--text-color); margin-bottom: 15px; text-align: center;">ELV3 Lookup</h3>
        
        <!-- ELV3 Lookup Fields -->
        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickNumInput" 
                   placeholder="Enter Elevator Part Number"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickLetterInput" 
                   placeholder="Enter Violating Condition"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickLetterResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="quickSecondaryNumInput" 
                   placeholder="Enter Suggested Remedy"
                   style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 14px; box-sizing: border-box;">
            <div id="quickSecondaryNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 10px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word;"></div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="quickClearInputs()" 
                    style="flex: 1; padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease;">
                Clear
            </button>
            <button onclick="toggleLogModal()" 
                    style="padding: 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: all 0.3s ease; min-width: 50px; display: flex; align-items: center; justify-content: center;" 
                    title="View Lookup Log">
                üìã
            </button>
        </div>

        <!-- ELV3 Lookup Log Section -->
        <div id="inlineLogSection" style="display: none; margin: 10px 0; padding: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; max-height: 80vh; min-height: 100px; overflow-y: auto; resize: vertical;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: var(--text-color); font-size: 1.1em;">Recent Lookups</h4>
                <button onclick="clearLogEntries()" 
                        style="padding: 4px 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    Clear
                </button>
            </div>
            <div id="inlineLogEntries" style="color: var(--text-color);">
                <p style="text-align: center; color: #666; font-style: italic; font-size: 0.85em;">No log entries yet.</p>
            </div>
            <!-- Resize handle indicator -->
            <div class="resize-handle" style="text-align: center; margin-top: 10px; color: #999; font-size: 12px; cursor: ns-resize; user-select: none;">
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
            </div>
        </div>

        <!-- Add BIN display section -->
        <div id="quickBinDisplay" style="text-align: center; margin-top: 5px; padding: 8px; background: var(--panel-bg); border-radius: 4px; color: var(--text-color);">
            <strong>BIN:</strong> <span id="quickBinValue" 
                                      style="padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s ease; position: relative; display: inline-flex; align-items: center; gap: 6px;" 
                                      onclick="copyBinToClipboard(this.textContent.replace('üìã', '').trim(), event)">-</span>
        </div>
        
        <!-- Device Number Search Dropdown -->
        <div style="margin-top: 10px;">
            <button onclick="toggleDeviceSearch()" 
                    style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: all 0.3s ease;"
                    title="Search Device Number">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <span>Device Search</span>
                <span id="deviceSearchArrow" style="margin-left: auto;">‚ñº</span>
            </button>
            
            <div id="deviceSearchFields" style="display: none; margin-top: 5px; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                    <input type="text" 
                           id="quickDeviceInput" 
                           placeholder="Enter Device Number"
                           oninput="this.value = this.value.toUpperCase(); updateMainDeviceField(this.value); searchDeviceInLookup(this.value);"
                           style="flex: 1; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 14px; box-sizing: border-box; height: 40px;">
                    <button onclick="refreshDeviceLookup()"
                            style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                            title="Refresh Device Lookup">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                        </svg>
                    </button>
                    <button onclick="clearDeviceLookup()"
                            style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                            title="Clear Device Lookup">
                        ‚úï
                    </button>
                </div>
                <div id="quickDeviceResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 12px; display: none;"></div>
            </div>
        </div>

        <!-- Filing Information Section -->
        <div class="quick-filing-info-container" style="margin: 15px 0;">
                    <button onclick="toggleQuickFilingInfo()" id="quickFilingInfoToggle" class="filing-info-toggle">
            <span>Filing Information</span>
            <span id="quickFilingInfoArrow" class="filing-info-arrow">‚ñº</span>
        </button>
            
            <div id="quickFilingInfoFields" class="filing-info-fields" style="display: none;">
                <div class="field-group">
                    <label>Owner:</label>
                    <div class="field-controls">
                        <input type="text" id="quickOwnerInput" placeholder="Enter Owner Name">
                        <button onclick="copyToClipboard('quickOwnerInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickOwnerInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Elevator Company:</label>
                    <div class="field-controls">
                        <input type="text" id="quickElevatorCompanyInput" placeholder="Enter Elevator Company">
                        <button onclick="copyToClipboard('quickElevatorCompanyInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickElevatorCompanyInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>BIN #:</label>
                    <div class="field-controls">
                        <input type="text" id="quickBinInput" placeholder="Enter BIN Number">
                        <button onclick="copyToClipboard('quickBinInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickBinInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Groups:</label>
                    <div class="field-controls">
                        <input type="text" id="quickGroupsInput" placeholder="Enter Groups">
                        <button onclick="copyToClipboard('quickGroupsInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickGroupsInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Director/Co-Directors:</label>
                    <div class="field-controls">
                        <input type="text" id="quickDirectorsInput" placeholder="Enter Director/Co-Directors">
                        <button onclick="copyToClipboard('quickDirectorsInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickDirectorsInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Additional:</label>
                    <div class="field-controls">
                        <input type="text" id="quickAdditionalInput" placeholder="Enter Additional Information">
                        <button onclick="copyToClipboard('quickAdditionalInput')" class="copy-btn">Copy</button>
                        <button onclick="clearField('quickAdditionalInput')" class="clear-btn">Clear</button>
                    </div>
                </div>
                
                <!-- Clear All Button -->
                <div class="clear-all-container">
                    <button onclick="clearAllQuickFilingInfo()" class="clear-all-btn">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Add Notes section as dropdown -->
        <div class="quick-notes-container" style="margin-top: 15px;">
                    <button onclick="toggleQuickNotes()" id="quickNotesToggle" class="notes-toggle">
            <span>Notes</span>
            <span id="quickNotesArrow" class="notes-arrow">‚ñº</span>
        </button>
            
            <div id="quickNotesFields" class="notes-fields" style="display: none;">
                <textarea id="quickNotesInput" 
                          placeholder="Enter your notes here..."
                          class="notes-textarea-quick"></textarea>
                <button onclick="clearQuickNotes()" class="quick-lookup-clear-btn">
                    Clear Notes
                </button>
            </div>
        </div>

        <!-- ELV3 Reference section as dropdown inside Quick Lookup Panel -->
        <div class="quick-reference-container" style="margin-top: 15px;">
            <button onclick="toggleQuickReference()" id="quickReferenceToggle" class="filing-info-toggle">
                <span>ELV3 Reference</span>
                <span id="quickReferenceArrow" class="filing-info-arrow">‚ñº</span>
            </button>
            <div id="quickReferenceFields" class="filing-info-fields" style="display: none;">
                <div id="quickReferenceContent" style="max-height: 60vh; overflow-y: auto; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; color: var(--text-color);"></div>
            </div>
        </div>
    </div>

    

    <div id="settingsModal" class="settings-modal">
        <h3>Settings</h3>
        <label for="defaultTab">Default Starting Tab:</label>
        <select id="defaultTab" style="width: 100%; padding: 8px; margin: 10px 0;">
            <option value="main">ELV3 Terminal</option>
            <option value="dob">DOB Terminal</option>
            <option value="dates">Dates Terminal</option>
            <option value="pdf">PDF Terminal</option>
            <!-- <option value="devices">Device Lookup Terminal</option> -->
        </select>
        <button onclick="saveSettings()">Save</button>
        <button onclick="closeSettings()" style="background-color: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Cancel</button>
    </div>

    <div id="settingsOverlay" class="reference-overlay"></div>



    <img src="ELV3 Cheat Sheet Icon.png" alt="Logo" class="logo">
    <h1 id="pageTitle">ELV3 Terminal</h1>

    <!-- Button-based Tabs (default for larger screens) -->
    <div id="tabButtons" class="tab-buttons">
        <button onclick="showTab('main')" id="mainTab" class="tab-button">ELV3</button>
        <button onclick="showTab('dob')" id="dobTab" class="tab-button">DOB</button>
        <button onclick="showTab('dates')" id="datesTab" class="tab-button">DATES</button>
        <button onclick="showTab('pdf')" id="pdfTab" class="tab-button">PDF</button>
        <button onclick="showTab('devices')" id="devicesTab" class="tab-button" style="display: none;">DEVICES</button>
    </div>

    <!-- Dropdown-based Tabs (visible on small screens) -->
    <div id="tabDropdown" class="tab-dropdown" style="margin: 20px auto; text-align: center;">
        <select id="tabSelect" onchange="showTab(this.value)" style="font-size: 1.2em; padding: 5px; text-align: center; text-align-last: center;">
            <option value="main">ELV3</option>
            <option value="dob">DOB</option>
            <option value="dates">DATES</option>
            <option value="pdf">PDF</option>
            <!-- <option value="devices">DEVICES</option> -->
        </select>
    </div>

    <div id="mainContent" class="content-section active">
        <!-- Add ELV3 Lookup toggle button for Main tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        
        <div class="main-container">
            <div class="main-left">
                <div class="input-group">
                    <input type="text" id="numInput" placeholder="Enter Elevator Part Number">
                    <div id="numResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="letterInput" placeholder="Enter Violating Condition">
                    <div id="letterResult" class="result"></div>
                </div>

                <div class="input-group">
                    <input type="text" id="secondaryNumInput" placeholder="Enter Suggested Remedy">
                    <div id="secondaryNumResult" class="result"></div>
                </div>

                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px auto; width: fit-content;">
                    <button onclick="clearInputs()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear</button>
                    <button onclick="toggleMainLogModal()" 
                            style="padding: 10px 20px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; box-sizing: border-box; transition: all 0.3s ease; font-size: 1.2em; display: flex; align-items: center; justify-content: center;" 
                            title="View Lookup Log">
                        üìã
                    </button>
                </div>
                
                <!-- Upload ELV3 Button -->
                <div style="display: flex; justify-content: center; margin: 10px auto;">
                    <button onclick="showUploadELV3ScanModal()" 
                            style="padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                            title="Upload and Scan ELV3 Form">
                        <span>üìÑ</span> Upload ELV3
                    </button>
                </div>
                
                <!-- Main Tab Log Section -->
                <div id="mainLogSection" style="display: none; margin: 10px 0; padding: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; max-height: 80vh; min-height: 100px; overflow-y: auto; resize: vertical;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: var(--text-color); font-size: 1.1em;">Recent Lookups</h4>
                        <button onclick="clearMainLogEntries()" 
                                style="padding: 4px 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                            Clear
                        </button>
                    </div>
                    <div id="mainLogEntries" style="color: var(--text-color);">
                        <p style="text-align: center; color: #666; font-style: italic; font-size: 0.85em;">No log entries yet.</p>
                    </div>
                    <!-- Resize handle indicator -->
                    <div class="resize-handle" style="text-align: center; margin-top: 10px; color: #999; font-size: 12px; cursor: ns-resize; user-select: none;">
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                        <span style="display: inline-block; border-top: 2px solid #ccc; width: 30px; margin: 0 2px;"></span>
                    </div>
                </div>
                
                <!-- BIN Lookup Section -->
                <div style="margin: 30px auto; max-width: 500px;">
                    <!-- BIN Display -->
                    <div id="mainBinDisplay" style="text-align: center; margin-bottom: 10px; padding: 12px; background: var(--panel-bg); border-radius: 4px; color: var(--text-color); border: 1px solid var(--input-border);">
                        <strong>BIN:</strong> <span id="mainBinValue" 
                                              style="padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s ease; position: relative; display: inline-flex; align-items: center; gap: 6px; cursor: pointer;" 
                                              onclick="copyBinToClipboard(this.textContent.replace('üìã', '').trim(), event)">-</span>
                    </div>
                    
                    <!-- Device Number Search Dropdown -->
                    <div style="margin-bottom: 10px;">
                        <button onclick="toggleMainDeviceSearch()" 
                                style="width: 100%; padding: 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; transition: all 0.3s ease;"
                                title="Search Device Number">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            <span>Device Search</span>
                            <span id="mainDeviceSearchArrow" style="margin-left: auto;">‚ñº</span>
                        </button>
                        
                        <div id="mainDeviceSearchFields" style="display: none; margin-top: 5px; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                <input type="text" 
                                       id="mainDeviceInput" 
                                       placeholder="Enter Device Number"
                                       oninput="this.value = this.value.toUpperCase(); searchDeviceInMain(this.value);"
                                       style="flex: 1; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 14px; box-sizing: border-box; height: 40px;">
                                <button onclick="refreshMainDeviceLookup()"
                                        style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                                        title="Refresh Device Lookup">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                                    </svg>
                                </button>
                                <button onclick="clearMainDeviceLookup()"
                                        style="padding: 8px 12px; width: 40px; height: 40px; box-sizing: border-box; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;"
                                        title="Clear Device Lookup">
                                    ‚úï
                                </button>
                            </div>
                            <div id="mainDeviceResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 12px; display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Filing Information Dropdown -->
                <div class="filing-info-container" style="margin: 30px auto; max-width: 500px;">
                            <button onclick="toggleFilingInfo()" id="filingInfoToggle" class="filing-info-toggle">
            <span>Filing Information</span>
            <span id="filingInfoArrow" class="filing-info-arrow">‚ñº</span>
        </button>
                    
                    <div id="filingInfoFields" class="filing-info-fields" style="display: none;">
                        <div class="field-group">
                            <label>Owner:</label>
                            <div class="field-controls">
                                <input type="text" id="ownerInput" placeholder="Enter Owner Name">
                                <button onclick="copyToClipboard('ownerInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('ownerInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Elevator Company:</label>
                            <div class="field-controls">
                                <input type="text" id="elevatorCompanyInput" placeholder="Enter Elevator Company">
                                <button onclick="copyToClipboard('elevatorCompanyInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('elevatorCompanyInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>BIN #:</label>
                            <div class="field-controls">
                                <input type="text" id="binInput" placeholder="Enter BIN Number">
                                <button onclick="copyToClipboard('binInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('binInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Groups:</label>
                            <div class="field-controls">
                                <input type="text" id="groupsInput" placeholder="Enter Groups">
                                <button onclick="copyToClipboard('groupsInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('groupsInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Director/Co-Directors:</label>
                            <div class="field-controls">
                                <input type="text" id="directorsInput" placeholder="Enter Director/Co-Directors">
                                <button onclick="copyToClipboard('directorsInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('directorsInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label>Additional:</label>
                            <div class="field-controls">
                                <input type="text" id="additionalInput" placeholder="Enter Additional Information">
                                <button onclick="copyToClipboard('additionalInput')" class="copy-btn">Copy</button>
                                <button onclick="clearField('additionalInput')" class="clear-btn">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Clear All Button -->
                        <div class="clear-all-container">
                            <button onclick="clearAllFilingInfo()" class="clear-all-btn">Clear All</button>
                        </div>
                    </div>
                </div>
                
                <!-- ELV3 Reference section as dropdown in main ELV3 tab -->
                <div class="main-reference-container" style="margin: 30px auto; max-width: 500px;">
                    <button onclick="toggleMainReference()" id="mainReferenceToggle" class="filing-info-toggle">
                        <span>ELV3 Reference</span>
                        <span id="mainReferenceArrow" class="filing-info-arrow">‚ñº</span>
                    </button>
                    <div id="mainReferenceFields" class="filing-info-fields" style="display: none;">
                        <div id="mainReferenceContent" style="max-height: 60vh; overflow-y: auto; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; color: var(--text-color);"></div>
                    </div>
                </div>

                <button onclick="togglePdfViewer()" id="pdfToggleButton">Show PDF</button>

                <div class="image-viewer hidden" id="pdfViewer">
                    <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                        onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                        <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
                    </iframe>
                </div>

                <div class="notes-container">
                    <h3>Notes</h3>
                    <textarea id="Notes" class="notes-textarea" 
                        placeholder="Enter your notes here..."></textarea>
                    <button onclick="clearNotes()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear Notes</button>
                </div>
            </div>
        </div>

        <!-- Add this div right after your mainContent div opens -->
        <div class="reference-overlay" onclick="toggleReference()"></div>

        <!-- Modify your reference panel div to include the close button -->
        <div class="reference-panel">
            <button class="close-reference" onclick="toggleReference()" style="position: sticky; top: 0; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #ff6b6b; padding: 5px 10px; float: right; z-index: 2; margin-top: -5px;">√ó</button>
            <h3>ELV3 Reference</h3>
            
            <p><strong>Part Numbers:</strong></p>
            <ul>
                <li style="font-weight: bold; color: #666;">Inside Car (01-15)</li>
                <li>01: Emergency Stop Switch</li>
                <li>02: Alarm System</li>
                <li>03: Car Enclosure</li>
                <li>04: Side Emergency Exit</li>
                <li>05: Car Door/Gate</li>
                <li>06: Car Door/Gate Contact</li>
                <li>07: Door Reopening Device</li>
                <li>08: Car Floor to Landing Still</li>
                <li>09: Car Floor</li>
                <li>10: Car Door Gibs</li>
                <li>11: Car Button Station</li>
                <li>12: Car Lighting</li>
                <li>13: Emergency Lighting</li>
                <li>14: Car Mirror</li>
                <li>15: Certificate Frame</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Outside Hoistway (16-25)</li>
                <li>16: Hoistway Doors</li>
                <li>17: Hoistway Door Gibs</li>
                <li>18: Hoistway Door Reinforcements</li>
                <li>19: Hoistway Door Safety Retainer</li>
                <li>20: Vision Panel</li>
                <li>21: Interlocks</li>
                <li>22: Parking Device</li>
                <li>23: Hall Button Station</li>
                <li>24: Indicators</li>
                <li>25: Door Safety Retainer</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Top of Car (26-39)</li>
                <li>26: Top Emergency Exit Cover</li>
                <li>27: Governor Release Carrier</li>
                <li>28: Door Hangers & Connectors</li>
                <li>29: Door Operator</li>
                <li>30: Normal Limits</li>
                <li>31: Final Limits</li>
                <li>32: Guide Shoes / Roller Guides</li>
                <li>33: Counterweight</li>
                <li>34: Hoistway</li>
                <li>35: Electrical Wiring</li>
                <li>36: Pipes and Ducts</li>
                <li>37: Overhead & Deflector Sheave</li>
                <li>38: Traveling Cable & Junction</li>
                <li>39: Car Top</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Machine Room (40-69)</li>
                <li>40: Machine Room</li>
                <li>41: Machine Room Door</li>
                <li>42: Controller‚ÄîSelector</li>
                <li>43: Reverse Phase Relay</li>
                <li>44: Traction Sheave</li>
                <li>45: Governor</li>
                <li>46: Governor Switch</li>
                <li>47: Drum</li>
                <li>48: Pump Unit</li>
                <li>49: Drum Machine Limit SW</li>
                <li>50: Generator</li>
                <li>51: Slack Rope Switch</li>
                <li>52: Hoist Cables</li>
                <li>53: Governor Ropes</li>
                <li>54: Car Counterweight Rope</li>
                <li>55: Drum Counterweight Rope</li>
                <li>56: Hoist Machine</li>
                <li>57: Hoist Motor</li>
                <li>58: Worm / Gear / Bearings</li>
                <li>59: Machine Brake</li>
                <li>60: Lighting Machine Space</li>
                <li>61: Machine Disconnect SW</li>
                <li>62: Commutator</li>
                <li>63: Motor Brushes</li>
                <li>64: NYC Device #</li>
                <li>65: Unintended Car Movement</li>
                <li>66: Emergency Brake/Rope Gripper</li>
                <li>67: Communication</li>
                <li>68: Maintenance Log</li>
                <li>69: Code Data Plate</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Pit (70-82)</li>
                <li>70: Pit</li>
                <li>71: Pit Light</li>
                <li>72: Pit Stop Switch</li>
                <li>73: Car Guide-Rails & Brackets</li>
                <li>74: Cwt Guide-Rails & Brackets</li>
                <li>75: Buffers</li>
                <li>76: Car Safety & Tail Rope</li>
                <li>77: Underside Platform</li>
                <li>78: Tension Weight</li>
                <li>79: Comp / Chains / Ropes / Switch</li>
                <li>80: Counterweight Runby</li>
                <li>81: Counterweight Runby Signage</li>
                <li>82: Plunger Gripper</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">Escalator/Moving Walk (83-96)</li>
                <li>83: Fire Shutters</li>
                <li>84: Skirt Switch</li>
                <li>85: Skirt Deflection Device</li>
                <li>86: Comb Plate / Comb Plate Teeth</li>
                <li>87: Landing Plate / Impact Switches</li>
                <li>88: Handrails / Handrail Safeties</li>
                <li>89: Step / Thread</li>
                <li>90: Key Switch</li>
                <li>91: Emergency Stop Button</li>
                <li>92: Decking and Ballistrades</li>
                <li>93: Ceiling Guards</li>
                <li>94: Deck Barricades</li>
                <li>95: Internal Safeties</li>
                <li>96: Safety Signage</li>

                <li style="font-weight: bold; margin-top: 15px; color: #666;">All Types (97-100)</li>
                <li>97: Entire Device</li>
                <li>98: Current Five Year Tag</li>
                <li>99: Current One Year Tag</li>
                <li>100: Miscellaneous</li>
            </ul>

            <p><strong>Violations:</strong></p>
            <ul>
                <li>A: Altered</li>
                <li>B: Insufficient</li>
                <li>C: Padlocked</li>
                <li>D: Unsecured</li>
                <li>E: Rubbing</li>
                <li>F: Lost Motion</li>
                <li>G: Improper Fuses</li>
                <li>H: Worn</li>
                <li>I: Damaged</li>
                <li>J: Misaligned</li>
                <li>K: Rusted</li>
                <li>L: Defective</li>
                <li>M: Missing</li>
                <li>N: By-Passed</li>
                <li>O: Dirty</li>
                <li>P: No Means Of Access</li>
                <li>Q: Unguarded</li>
                <li>R: Illegal</li>
                <li>S: Not Fire Retardant</li>
                <li>T: Unlabeled</li>
                <li>U: Device Not Tagged</li>
                <li>V: Not Level</li>
                <li>W: Unlocked</li>
                <li>X: Inoperative</li>
                <li>Y: Oil Leak</li>
                <li>Z: Water Leak</li>
                <li>AA: Carbon Buildup</li>
                <li>BB: Expired Tag</li>
            </ul>

            <p><strong>Remedies:</strong></p>
            <ul>
                <li>01: Adjust</li>
                <li>02: Clean</li>
                <li>03: Install Guards</li>
                <li>04: Patch</li>
                <li>05: Perform & File Test</li>
                <li>06: Properly Secure</li>
                <li>07: Provide</li>
                <li>08: Regroove</li>
                <li>09: Remove</li>
                <li>10: Repair</li>
                <li>11: Replace</li>
                <li>12: Reshackle</li>
                <li>13: Seal</li>
                <li>14: Shorten</li>
                <li>15: Tag Device</li>
                <li>16: Provide Means of Access</li>
                <li>17: Re-inspection Required</li>
            </ul>
        </div>
    </div>

    <div id="dobContent" class="content-section">
        <!-- The quickLookupPanel has been moved outside the tab for access from any tab -->
        
        <!-- Add ELV3 Lookup toggle button -->
        <button id="dobLookupToggleBtn" onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>

        

        <!-- Replace the Device & BIN Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Device & BIN Lookup</h3>
            
            <!-- Add this right after the <h3>Device & BIN Lookup</h3> line, around line 986 -->
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Elevator Device API</span>
                <br>
                <span>Last Updated: <span id="apiLastUpdated">March 15, 2024</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Elevator-Device-Information/e5aq-a4j2" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
            </div>

            <!-- Device Number Search -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by Device Number:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="deviceNumber" 
                           placeholder="Enter Device Number"
                           oninput="if(this.value !== '') { this.value = this.value.toUpperCase(); }"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupBIN()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Search Device</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
                <div id="binResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- Address Search -->
            <div id="addressSearchSection" style="margin-bottom: 25px; margin-top: 20px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by Address:</h4>
                <div style="padding: 0 5px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" 
                               id="houseNumber" 
                               placeholder="House Number"
                               style="width: calc(40% - 5px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color);">
                        <input type="text" 
                               id="streetName" 
                               placeholder="Street Name"
                               oninput="this.value = this.value.toUpperCase()"
                               style="width: calc(60% - 5px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color);">
                    </div>
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupByAddress()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Search Address</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearAddressSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease, color 0.3s ease;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
                <div id="addressResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>

            <!-- BIN Search -->
            <div style="margin-top: 20px;">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Search by BIN:</h4>
                <div style="padding: 0 5px;">
                    <input type="text" 
                           id="binNumber" 
                           placeholder="Enter BIN Number"
                           style="width: calc(100% - 10px); padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <div style="position: relative; display: inline-flex; align-items: center;">
                            <button onclick="lookupDevices()" 
                                    class="lookup-button"
                                    style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 200px;">
                                <span class="button-text">Find Devices</span>
                                <svg class="button-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                            <button onclick="clearDeviceSearch()" 
                                    style="padding: 12px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 24px; margin-left: 5px; width: 42px; display: flex; align-items: center; justify-content: center;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
                <div id="deviceResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color);">
                    <!-- Device results will be displayed here -->
                </div>
            </div>

            <!-- Move export button here, before Clear All -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="binExportButton" 
                        onclick="showBinExportModal()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export Data
                </button>
            </div>

            <!-- BIN Export Format Selection Modal -->
            <div id="binExportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: var(--card-bg); border-radius: 12px; padding: 25px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--input-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                        <h3 style="margin: 0; color: var(--header-color); font-size: 1.2em;">Export BIN Data</h3>
                        <button onclick="closeBinExportModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--text-color); font-weight: 500; margin-bottom: 10px; display: block;">Select Export Format:</label>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--panel-bg); border-radius: 6px; border: 1px solid var(--input-border);">
                                <input type="radio" name="binExportFormat" value="excel" checked style="width: 18px; height: 18px; margin: 0;">
                                <span style="color: var(--text-color); font-size: 1em;">Excel File (.xlsx)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--panel-bg); border-radius: 6px; border: 1px solid var(--input-border);">
                                <input type="radio" name="binExportFormat" value="csv" style="width: 18px; height: 18px; margin: 0;">
                                <span style="color: var(--text-color); font-size: 1em;">CSV File (.csv)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeBinExportModal()" style="padding: 10px 20px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-weight: 500;">Cancel</button>
                        <button onclick="exportBinData()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Export</button>
                    </div>
                </div>
            </div>

            <!-- Add Clear Button -->
            <button onclick="clearLookups()" 
                    style="display: block; margin: 25px auto 5px; padding: 12px 30px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                Clear All
            </button>
        </div>

        <!-- Replace the Bulk Device Lookup section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Bulk Device Lookup</h3>
            
            <div style="margin-bottom: 15px; padding: 0 5px;">
                <textarea id="bulkDeviceNumbers" 
                         placeholder="Enter multiple device numbers (one per line)"
                         oninput="this.value = this.value.toUpperCase()"
                         style="width: calc(100% - 10px); height: 100px; padding: 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); resize: vertical;"></textarea>
            </div>

            <!-- Modified buttons div to stack vertically -->
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <button onclick="lookupBulkDevices()" 
                        style="padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Look up All Devices
                </button>
                <button onclick="clearBulkLookup()" 
                        style="padding: 12px 20px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Clear
                </button>
                <button id="exportButton" 
                        onclick="showExportModal()" 
                        style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    Export Data
                </button>
                <button id="mapButton" 
                        onclick="showBuildingMap()" 
                        style="padding: 12px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: none;">
                    üìç View on Map
                </button>
            </div>

            <div id="bulkResult" class="result" style="margin-top: 15px; display: none; background: var(--result-bg); color: var(--text-color); min-height: 100px; overflow-y: auto; resize: vertical; border: 2px solid var(--input-border); border-radius: 8px; padding: 10px;">
                <!-- Results will be displayed here -->
            </div>
        </div>

        <!-- Building Map Modal -->
        <div id="buildingMapModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; justify-content: center; align-items: center;">
            <div id="mapModalContainer" style="background: var(--card-bg); border-radius: 12px; width: 85%; max-width: 1400px; height: 80%; min-width: 400px; min-height: 400px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--input-border); overflow: hidden; resize: both;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 2px solid var(--input-border); background: var(--panel-bg); flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin: 0; color: var(--header-color); font-size: 1.2em;">üìç Building Locations</h3>
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1; max-width: 450px; min-width: 200px;">
                        <div style="display: flex; flex: 1; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); overflow: hidden;">
                            <input type="text" id="mapSearchInput" placeholder="Search address, BIN, or device #..." 
                                   style="flex: 1; padding: 8px 12px; border: none; background: transparent; color: var(--text-color); font-size: 0.85em; outline: none;"
                                   onkeyup="if(event.key === 'Enter') searchMapBuildings()">
                            <button onclick="searchMapBuildings()" title="Search" style="background: var(--input-bg); border: none; border-left: 1px solid var(--input-border); cursor: pointer; padding: 8px 12px; color: var(--text-color); font-size: 1em; display: flex; align-items: center;">üîç</button>
                        </div>
                        <button onclick="clearMapSearch()" title="Clear search" style="background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 6px; padding: 8px 12px; cursor: pointer; color: var(--text-color); font-size: 0.85em;">Clear</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1; max-width: 450px; min-width: 200px;">
                        <div style="display: flex; flex: 1; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); overflow: hidden;">
                            <input type="text" id="additionalLocationInput" placeholder="Add location: address, BIN, or device #..." 
                                   style="flex: 1; padding: 8px 12px; border: none; background: transparent; color: var(--text-color); font-size: 0.85em; outline: none;"
                                   onkeyup="if(event.key === 'Enter') addAdditionalLocation()">
                            <button onclick="addAdditionalLocation()" title="Add location" style="background: var(--input-bg); border: none; border-left: 1px solid var(--input-border); cursor: pointer; padding: 8px 12px; color: var(--text-color); font-size: 1em; display: flex; align-items: center;">‚ûï</button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="mapSearchResultCount" style="color: #4CAF50; font-size: 0.85em; display: none;"></span>
                        <span id="mapBuildingCount" style="color: var(--text-color); font-size: 0.9em;"></span>
                        <button onclick="toggleMapControlsPanel()" style="background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 6px; padding: 6px 12px; cursor: pointer; color: var(--text-color); font-size: 0.85em; display: flex; align-items: center; gap: 6px;">
                            <span>‚öôÔ∏è</span> <span style="display: none;" class="controls-btn-text">Controls</span>
                        </button>
                        <button onclick="closeBuildingMap()" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1;">&times;</button>
                    </div>
                </div>
                <div style="display: flex; flex: 1; min-height: 0; overflow: hidden;">
                    <div id="buildingMap" style="flex: 1; min-height: 400px;"></div>
                    <!-- Map Controls Panel -->
                    <div id="mapControlsPanel" style="display: none; width: 280px; background: var(--panel-bg); border-left: 1px solid var(--input-border); padding: 15px; overflow-y: auto; flex-shrink: 0;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--header-color); font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span style="color: #9b59b6;">‚≠ê</span> Favorites (<span id="mapFavoritesCount">0</span>)
                            </h4>
                            <p style="font-size: 11px; opacity: 0.7; margin: 0 0 10px 0;">Favorited buildings appear in purple on the map</p>
                            <button onclick="clearAllFavorites()" style="width: 100%; padding: 8px; background: var(--input-bg); color: #f59e0b; border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-size: 12px;">Clear All Favorites</button>
                        </div>
                        
                        <div style="border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--header-color); font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span style="color: #888;">üëÅÔ∏è‚Äçüó®Ô∏è</span> Hidden (<span id="mapHiddenCount">0</span>)
                            </h4>
                            <p style="font-size: 11px; opacity: 0.7; margin: 0 0 10px 0;">Hidden buildings are not shown on the map</p>
                            <div id="hiddenBuildingsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
                                <div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No hidden buildings</div>
                            </div>
                            <button onclick="unhideAllBuildings()" style="width: 100%; padding: 8px; background: var(--input-bg); color: #4CAF50; border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-size: 12px;">Show All Hidden</button>
                        </div>
                        
                        <div style="border-top: 1px solid var(--input-border); padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--header-color); font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span style="color: #17a2b8;">üìÖ</span> Month Labels (<span id="mapMonthLabelsCount">0</span>)
                            </h4>
                            <p style="font-size: 11px; opacity: 0.7; margin: 0 0 10px 0;">Categorize buildings by month for scheduling</p>
                            <div style="margin-bottom: 10px;">
                                <select id="monthFilterSelect" onchange="filterByMonth(this.value)" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 12px;">
                                    <option value="">Filter by month...</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div id="monthLabelsList" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;">
                                <div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No buildings labeled</div>
                            </div>
                            <button onclick="clearAllMonthLabels()" style="width: 100%; padding: 8px; background: var(--input-bg); color: #ff6b6b; border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-size: 12px;">Clear All Month Labels</button>
                        </div>
                        
                        <div style="border-top: 1px solid var(--input-border); padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--header-color); font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span style="color: #00bcd4;">üìç</span> Additional Locations (<span id="additionalLocationsCount">0</span>)
                            </h4>
                            <p style="font-size: 11px; opacity: 0.7; margin: 0 0 10px 0;">Custom locations appear as blue squares on the map</p>
                            <div id="additionalLocationsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
                                <div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No additional locations</div>
                            </div>
                            <button onclick="clearAllAdditionalLocations()" style="width: 100%; padding: 8px; background: var(--input-bg); color: #00bcd4; border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-size: 12px;">Clear All Additional Locations</button>
                        </div>
                        
                        <div style="border-top: 1px solid var(--input-border); padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: var(--header-color); font-size: 0.9em;">üí° Tips</h4>
                            <ul style="font-size: 11px; opacity: 0.8; margin: 0; padding-left: 16px; line-height: 1.6;">
                                <li>Click a marker to see building details</li>
                                <li>Use ‚≠ê in popup to favorite a building</li>
                                <li>Use üëÅÔ∏è in popup to hide a building</li>
                                <li>Use üìÖ dropdown to assign a month</li>
                                <li>Favorited buildings turn purple</li>
                                <li>Add custom locations with the ‚ûï button</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="padding: 10px 20px; background: var(--panel-bg); border-top: 1px solid var(--input-border); font-size: 0.85em; color: var(--text-color); display: flex; justify-content: space-between; align-items: center;">
                    <span style="opacity: 0.7;">Click a marker to view building details ‚Ä¢ Use ‚≠ê to favorite ‚Ä¢ Use üëÅÔ∏è to hide</span>
                    <span style="opacity: 0.5; font-size: 0.8em;">‚Üò Drag corner to resize</span>
                </div>
            </div>
        </div>

        <!-- Export Column Selection Modal -->
        <div id="exportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
            <div style="background: var(--card-bg); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--input-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                    <h3 style="margin: 0; color: var(--header-color); font-size: 1.2em;">Select Columns to Export</h3>
                    <button onclick="closeExportModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1;">&times;</button>
                </div>
                
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button onclick="selectAllColumns()" style="padding: 8px 16px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.9em;">Select All</button>
                    <button onclick="deselectAllColumns()" style="padding: 8px 16px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.9em;">Deselect All</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px 30px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="address" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Address</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="cat1Date" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">CAT 1 Date</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="borough" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Borough</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="cat5Date" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">CAT 5 Date</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="bin" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">BIN</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="nextCat5Due" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Next CAT 5 Due</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="deviceNumber" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Device Number</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="pviDate" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">PVI Date</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="type" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Type</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationStatuses" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Statuses</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="status" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Status</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationCount" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Count</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="block" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Block</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationNumbers" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Numbers</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="lot" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Lot</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationIssueDates" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Issue Dates</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="testStatus" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Test Status</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationTypes" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Types</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="violationDescriptions" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Violation Descriptions</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="testingEligibility" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Testing Eligibility</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="eligibleDate" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Eligible Date</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="importantInfo" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Important Information</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitCount" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Count</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitNumbers" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Numbers</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitIssueDates" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Issue Dates</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitPermittees" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Permittees</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitFilingStatus" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Filing Status</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitWorkTypes" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Work Types</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="export-column" value="permitDescriptions" checked style="width: 16px; height: 16px; margin: 0;">
                        <span style="color: var(--text-color); font-size: 0.9em;">Permit Descriptions</span>
                    </label>
                </div>
                
                <div style="margin-bottom: 15px; padding-top: 15px; border-top: 1px solid var(--input-border);">
                    <label style="color: var(--text-color); font-weight: 500; margin-bottom: 8px; display: block;">Export Format:</label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="excel" checked style="width: 16px; height: 16px; margin: 0;">
                            <span style="color: var(--text-color); font-size: 0.95em;">Excel (.xlsx)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="csv" style="width: 16px; height: 16px; margin: 0;">
                            <span style="color: var(--text-color); font-size: 0.95em;">CSV (.csv)</span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-start;">
                    <button onclick="exportData()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Export</button>
                    <button onclick="closeExportModal()" style="padding: 10px 20px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; font-weight: 500;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Bulk Device List Popup Modal -->
        <div id="bulkDeviceListModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
            <div style="position: relative; background: var(--card-bg); border-radius: 12px; padding: 25px; max-width: 1200px; width: 95%; max-height: 85vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--input-border); display: flex; flex-direction: column;">
                <!-- Close button at top-right corner of popup window -->
                <button onclick="closeBulkDeviceListModal()" 
                        style="position: absolute; top: 2px; right: 15px; background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1; transition: color 0.2s, transform 0.2s; z-index: 1;" 
                        onmouseover="this.style.color='#ff6b6b'; this.style.transform='scale(1.1)';" 
                        onmouseout="this.style.color='var(--text-color)'; this.style.transform='scale(1)';"
                        title="Close (Esc)">&times;</button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--input-border); flex-shrink: 0; padding-right: 50px;">
                    <h3 id="bulkModalTitle" style="margin: 0; color: var(--header-color); font-size: 1.3em;">Device List</h3>
                </div>
                <div id="bulkModalContent" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
        </div>

        
        <!-- Add the violations API data source section -->
        <div style="max-width: 800px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 5px; box-shadow: 0 2px 8px var(--card-shadow);">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Violations API Information</h3>
            
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <span>Data source: NYC DOB Safety Violations API</span>
                <br>
                <span>Last Updated: <span id="violationsApiLastUpdated">Loading...</span></span>
                <a href="https://data.cityofnewyork.us/Housing-Development/DOB-Safety-Violations/855j-jady" 
                   target="_blank" 
                   style="margin-left: 5px; text-decoration: underline; color: var(--header-color);">
                    (Source)
                </a>
                <div id="violationsDaysSinceUpdate" style="text-align: center; font-size: 0.9em; color: #4CAF50; opacity: 0.8; margin-top: 5px;">
                    Checking...
                </div>
                <script>
                    // Fetch actual last updated date from NYC Open Data API
                    (function() {
                        const datasetId = '855j-jady'; // DOB Safety Violations dataset ID
                        const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                        
                        fetch(metadataUrl)
                            .then(response => response.json())
                            .then(data => {
                                // Extract the last updated date from the metadata
                                const updateDateStr = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                }) : 'Unknown';
                                
                                // Update the displayed date
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement) {
                                    lastUpdatedElement.textContent = updateDateStr;
                                }
                                
                                // Calculate days since update
                                // Normalize both dates to midnight to compare calendar days, not hours
                                const today = new Date();
                                const updateDate = data.rowsUpdatedAt ? new Date(data.rowsUpdatedAt * 1000) : today;
                                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                                const timeDiff = todayMidnight - updateDateMidnight;
                                const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement) {
                                    // Display appropriate message based on days
                                    if (daysSinceUpdate <= 0) {
                                        daysSinceElement.textContent = "Updated today";
                                        daysSinceElement.style.color = "#4CAF50"; // Green for today
                                    } else if (daysSinceUpdate === 1) {
                                        daysSinceElement.textContent = "Updated 1 day ago";
                                        daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                                    } else if (daysSinceUpdate < 14) {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                                    } else if (daysSinceUpdate < 30) {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                                    } else {
                                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                        daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching dataset metadata:', error);
                                // Fallback to a default behavior on error
                                const lastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                                if (lastUpdatedElement && lastUpdatedElement.textContent === 'Loading...') {
                                    lastUpdatedElement.textContent = 'Unable to fetch update date';
                                }
                                
                                const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                                if (daysSinceElement && daysSinceElement.textContent === 'Checking...') {
                                    daysSinceElement.textContent = 'Update status unavailable';
                                    daysSinceElement.style.color = "#FFA500";
                                }
                            });
                    })();
                </script>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: var(--text-color);">
                    This website uses the NYC Department of Buildings Safety Violations API to provide up-to-date information about elevator violations.
                </p>
                <p style="color: var(--text-color);">
                    The API provides information about violations issued for elevator devices, including violation numbers, issue dates, statuses, types, and remarks.
                </p>
            </div>
        </div>
    </div>

    <div id="datesContent" class="content-section">
        <!-- Add ELV3 Lookup toggle button for Dates tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        
        <div class="input-group">
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput">
        </div>
        
        <!-- Adding back the buttons -->
        <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center;">
            <button id="days10" onclick="calculateDateWithMode(10)" style="display: inline-block; margin: 0;">10 Days</button>
            <button id="days30" onclick="calculateDateWithMode(30)" style="display: inline-block; margin: 0;">30 Days</button>
            <button id="days60" onclick="calculateDateWithMode(60)" style="display: inline-block; margin: 0;">60 Days</button>
            <button id="days91" onclick="calculateDateWithMode(91)" style="display: inline-block; margin: 0;">91 Days</button>
        </div>
        
        <!-- Adding back the dropdown for small screens -->
        <div class="date-dropdown-group" style="display: none; text-align: center; margin: 10px auto;">
            <select id="daysSelect" onchange="calculateDateWithMode(parseInt(this.value))" style="padding: 8px; width: 200px; margin-bottom: 10px;">
                <option value="">Select Days</option>
                <option value="10">10 Days</option>
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="91">91 Days</option>
            </select>
            <select id="modeSelect" onchange="toggleDateModeFromDropdown(this.value)" style="padding: 8px; width: 200px;">
                <option value="positive">Add Days</option>
                <option value="negative">Subtract Days</option>
            </select>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <!-- Mode toggle buttons above custom days input -->
            <div class="date-buttons-group" style="display: flex; justify-content: center; gap: 10px; align-items: center; margin-bottom: 15px;">
                <button id="negativeToggle" onclick="toggleDateMode('negative')" style="display: inline-block; margin: 0; background-color: #f0f0f0; color: #666; border: 1px solid #ccc; padding: 8px 16px;">Prior</button>
                <button id="positiveToggle" onclick="toggleDateMode('positive')" style="display: inline-block; margin: 0; background-color: #000; color: #fff; border: 1px solid #000; padding: 8px 16px;">Future</button>
            </div>
            <input type="number" id="customDays" placeholder="Enter number of days" style="width: 200px;">
            <button onclick="calculateCustomDate()" style="display: inline-block; margin: 10px;">Calculate Custom Days</button>
        </div>
        <div id="dateResult" class="result" style="width:80%;"></div>
        <div id="dateSpelledResult" class="result" style="width:80%;"></div>

        <!-- Modify the 90-day start date div -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                91 Days Past
                <span style="cursor: pointer; color: #4a9eff; display: inline-flex; align-items: center;" 
                      onclick="toggleExplanation(event)"
                      data-explanation="Any device tested on or before below date has past the required 91 days and the next test can be completed">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </span>
            </div>
            <div id="explanationText" style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--text-color); max-width: 400px; margin-left: auto; margin-right: auto;"></div>
            <div id="ninetyDayStart" style="margin: 10px 0;"></div>
        </div>

        <!-- 10 Days After section -->
        <div style="text-align: center; margin: 20px auto;">
            <div style="font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                10 Days After
                <span style="cursor: pointer; color: #4a9eff; display: inline-flex; align-items: center;" 
                      onclick="toggleExplanation(event)"
                      data-explanation="This date is 10 days after the current date">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </span>
            </div>
            <div id="explanationText10Days" style="display: none; margin-top: 10px; font-size: 0.9em; color: var(--text-color); max-width: 400px; margin-left: auto; margin-right: auto;"></div>
            <div id="tenDaysAfter" style="margin: 10px 0;"></div>
        </div>

        <script>
                    function toggleExplanation(event) {
            // Find the parent container and then the explanation div within it
            const parentContainer = event.currentTarget.closest('div[style*="text-align: center"]');
            const explanationDiv = parentContainer ? parentContainer.querySelector('div[id^="explanationText"]') : document.getElementById('explanationText');
            const explanation = event.currentTarget.getAttribute('data-explanation');
            
            if (explanationDiv && explanationDiv.style.display === 'none') {
                explanationDiv.textContent = explanation;
                explanationDiv.style.display = 'block';
                
                // Position the explanation
                const rect = event.currentTarget.getBoundingClientRect();
                explanationDiv.style.position = 'relative';
                explanationDiv.style.zIndex = '1000';
                
                // Add animation
                explanationDiv.style.opacity = '0';
                explanationDiv.style.transform = 'translateY(-10px)';
                explanationDiv.style.transition = 'all 0.3s ease';
                
                // Trigger animation
                setTimeout(() => {
                    explanationDiv.style.opacity = '1';
                    explanationDiv.style.transform = 'translateY(0)';
                }, 10);
            } else if (explanationDiv) {
                // Add fade-out animation
                explanationDiv.style.opacity = '0';
                explanationDiv.style.transform = 'translateY(-10px)';
                
                // Hide after animation
                setTimeout(() => {
                    explanationDiv.style.display = 'none';
                }, 300);
            }
            
            // Stop event propagation
            event.stopPropagation();
        }

        // Function to toggle Important dropdown
        function toggleImportantDropdown(deviceNumber) {
            const dropdown = document.getElementById('important_' + deviceNumber);
            const arrow = document.querySelector(`[onclick="toggleImportantDropdown('${deviceNumber}')"] .arrow`);
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle Missed Test Important dropdown
        function toggleMissedTestDropdown(deviceNumber) {
            const dropdown = document.getElementById('missed_test_' + deviceNumber);
            const arrow = document.querySelector(`[onclick="toggleMissedTestDropdown('${deviceNumber}')"] .arrow`);
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to check for missed required tests in prior years
        function getMissedRequiredTests(device) {
            const missedTests = [];
            const currentYear = new Date().getFullYear();
            
            // Get all test dates
            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
            
            // Check device type for test requirements
            const deviceType = (device.device_type || '').toUpperCase();
            const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMWAITER');
            const isConveyor = deviceType.includes('CONVEYOR');
            const isWheelchairLift = deviceType.includes('WHEELCHAIR');
            const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
            const isEscalator = deviceType.includes('ESCALATOR');
            
            // Skip if device is removed or deleted
            const deviceStatus = (device.device_status || '').toUpperCase();
            if (deviceStatus === 'REMOVED' || deviceStatus === 'DELETED') {
                return missedTests;
            }
            
            const isDismantled = deviceStatus.includes('DISMANTLED');
            
            // Check for missed CAT 1 tests (required annually for most devices, not for dismantled)
            // Conveyors only need CAT 1, other devices need CAT 1 annually
            if (!isDismantled && cat1Date) {
                const cat1Year = cat1Date.getFullYear();
                // CAT 1 is required every year - report all missed years
                for (let checkYear = cat1Year + 1; checkYear < currentYear; checkYear++) {
                    missedTests.push({
                        test: 'CAT 1',
                        year: checkYear,
                        lastTestDate: cat1Date.toLocaleDateString()
                    });
                }
            }
            
            // Check for missed PVI tests (required annually for most devices, not for conveyors)
            // Conveyors don't need PVI, dismantled devices only need PVI
            if (!isConveyor && pviDate) {
                const pviYear = pviDate.getFullYear();
                // PVI is required every year - report all missed years
                for (let checkYear = pviYear + 1; checkYear < currentYear; checkYear++) {
                    missedTests.push({
                        test: 'PVI',
                        year: checkYear,
                        lastTestDate: pviDate.toLocaleDateString()
                    });
                }
            }
            
            // Check for missed CAT 5 tests (required every 5 years for eligible device types)
            // Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, Escalators, and Dismantled don't need CAT 5
            const cat5NotRequired = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled;
            if (!cat5NotRequired && cat5Date) {
                const cat5Year = cat5Date.getFullYear();
                // CAT 5 is required every 5 years
                const nextDueYear = cat5Year + 5;
                
                // Check each year from the due year until last year (not current year) - report all missed years
                for (let checkYear = nextDueYear; checkYear < currentYear; checkYear++) {
                    if (cat5Year < checkYear) {
                        missedTests.push({
                            test: 'CAT 5',
                            year: checkYear,
                            lastTestDate: cat5Date.toLocaleDateString()
                        });
                    }
                }
            }
            
            return missedTests;
        }
            
            // Close explanation when clicking anywhere else on the page
            document.addEventListener('click', function(event) {
                const explanationDiv = document.getElementById('explanationText');
                if (explanationDiv.style.display === 'block' && !event.target.closest('[onclick="toggleExplanation(event)"]')) {
                    explanationDiv.style.opacity = '0';
                    explanationDiv.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        explanationDiv.style.display = 'none';
                    }, 300);
                }
            });
        </script>

        <button onclick="clearDateInput()" style="color: #ff6b6b; background: var(--panel-bg); border: none; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; padding: 10px 20px; font-size: 1.2em; transition: background-color 0.3s ease, color 0.3s ease;">Clear</button>
    </div>

    <div id="pdfContent" class="content-section">
        <!-- Add ELV3 Lookup toggle button for PDF tab -->
        <button onclick="toggleQuickLookup()" 
                style="position: fixed; top: 20px; right: 20px; z-index: 999; padding: 12px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease;">
            <span class="button-text">ELV3 Lookup</span>
            <svg class="button-icon" style="display: none; width: 20px; height: 20px;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12V14H7V12H12M15,15V17H7V15H15Z"/>
            </svg>
        </button>
        <div class="pdf-viewer" style="width: 100%; height: 80vh;">
            <iframe src="DOB ELV3 - CAT.pdf#view=FitH&zoom=100" type="application/pdf" width="100%" height="100%" 
                onerror="this.innerHTML='<p>PDF failed to load. Please ensure the file exists.</p>'">
                <p>Unable to display PDF file. <a href="DOB ELV3 - CAT.pdf">Download</a> instead.</p>
            </iframe>
        </div>
    </div>

    <div id="devicesContent" class="content-section" style="display: none;">
        <div style="width: 100%; height: calc(100vh - 100px); border: none;">
            <iframe src="device_search.html" 
                    style="width: 100%; height: 100%; border: none; background: #1c1c1c;"
                    title="Device Search">
            </iframe>
        </div>
    </div>

    <script>
        // Global variables for storing address suggestions state
        window.savedAddressSuggestions = null;
        window.cameFromSuggestions = false;
        window.originalSearchTerms = { houseNumber: '', streetName: '' };

        function numberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "00": "Invalid number",
                "01": "Emergency Stop Switch",
                "1": "Emergency Stop Switch",
                "emergency stop switch": "01",
                "02": "Alarm System",
                "2": "Alarm System",
                "alarm system": "02",
                "03": "Car Enclosure",
                "3": "Car Enclosure",
                "car enclosure": "03",
                "04": "Side Emergency Exit",
                "4": "Side Emergency Exit",
                "side emergency exit": "04",
                "05": "Car Door/Gate",
                "5": "Car Door/Gate",
                "car door/gate": "05",
                "06": "Car Door/Gate Contact",
                "6": "Car Door/Gate Contact",
                "car door/gate contact": "06",
                "07": "Door Reopening Device",
                "7": "Door Reopening Device",
                "door reopening device": "07",
                "08": "Car Floor to Landing Still",
                "8": "Car Floor to Landing Still",
                "car floor to landing still": "08",
                "09": "Car Floor",
                "9": "Car Floor",
                "car floor": "09",
                "10": "Car Door Gibs",
                "car door gibs": "10",
                "11": "Car Button Station",
                "car button station": "11",
                "12": "Car Lighting",
                "car lighting": "12",
                "13": "Emergency Lighting",
                "emergency lighting": "13",
                "14": "Car Mirror",
                "car mirror": "14",
                "15": "Certificate Frame",
                "certificate frame": "15",
                "16": "Hoistway Doors",
                "hoistway doors": "16",
                "17": "Hoistway Door Gibs",
                "hoistway door gibs": "17",
                "18": "Hoistway Door Reinforcements",
                "hoistway door reinforcements": "18",
                "19": "Hoistway Door Safety Retainer",
                "hoistway door safety retainer": "19",
                "20": "Vision Panel",
                "vision panel": "20",
                "21": "Interlocks",
                "interlocks": "21",
                "22": "Parking Device",
                "parking device": "22",
                "23": "Hall Button Station",
                "hall button station": "23",
                "24": "Indicators",
                "indicators": "24",
                "25": "Door Safety Retainer",
                "door safety retainer": "25",
                "26": "Top Emergency Exit Cover",
                "top emergency exit cover": "26",
                "27": "Governor Release Carrier",
                "governor release carrier": "27",
                "28": "Door Hangers & Connectors",
                "door hangers & connectors": "28",
                "29": "Door Operator",
                "door operator": "29",
                "30": "Normal Limits",
                "normal limits": "30",
                "31": "Final Limits",
                "final limits": "31",
                "32": "Guide Shoes / Roller Guides",
                "guide shoes / roller guides": "32",
                "33": "Counterweight",
                "counterweight": "33",
                "34": "Hoistway",
                "hoistway": "34",
                "35": "Electrical Wiring",
                "electrical wiring": "35",
                "36": "Pipes and Ducts",
                "pipes and ducts": "36",
                "37": "Overhead & Deflector Sheave",
                "overhead & deflector sheave": "37",
                "38": "Traveling Cable & Junction",
                "traveling cable & junction": "38",
                "39": "Car Top",
                "car top": "39",
                "40": "Machine Room",
                "machine room": "40",
                "41": "Machine Room Door",
                "machine room door": "41",
                "42": "Controller‚ÄîSelector",
                "controller‚Äîselector": "42",
                "43": "Reverse Phase Relay",
                "reverse phase relay": "43",
                "44": "Traction Sheave",
                "traction sheave": "44",
                "45": "Governor",
                "governor": "45",
                "46": "Governor Switch",
                "governor switch": "46",
                "47": "Drum",
                "drum": "47",
                "48": "Pump Unit",
                "pump unit": "48",
                "49": "Drum Machine Limit SW",
                "drum machine limit sw": "49",
                "50": "Generator",
                "generator": "50",
                "51": "Slack Rope Switch",
                "slack rope switch": "51",
                "52": "Hoist Cables",
                "hoist cables": "52",
                "53": "Governor Ropes",
                "governor ropes": "53",
                "54": "Car Counterweight Rope",
                "car counterweight rope": "54",
                "55": "Drum Counterweight Rope",
                "drum counterweight rope": "55",
                "56": "Hoist Machine",
                "hoist machine": "56",
                "57": "Hoist Motor",
                "hoist motor": "57",
                "58": "Worm / Gear / Bearings",
                "worm / gear / bearings": "58",
                "59": "Machine Brake",
                "machine brake": "59",
                "60": "Lighting Machine Space",
                "lighting machine space": "60",
                "61": "Machine Disconnect SW",
                "machine disconnect sw": "61",
                "62": "Commutator",
                "commutator": "62",
                "63": "Motor Brushes",
                "motor brushes": "63",
                "64": "NYC Device #",
                "nyc device #": "64",
                "65": "Unintended Car Movement",
                "unintended car movement": "65",
                "66": "Emergency Brake/Rope Gripper",
                "emergency brake/rope gripper": "66",
                "67": "Communication",
                "communication": "67",
                "68": "Maintenance Log",
                "maintenance log": "68",
                "69": "Code Data Plate",
                "code data plate": "69",
                "70": "Pit",
                "pit": "70",
                "71": "Pit Light",
                "pit light": "71",
                "72": "Pit Stop Switch",
                "pit stop switch": "72",
                "73": "Car Guide-Rails & Brackets",
                "car guide-rails & brackets": "73",
                "74": "Cwt Guide-Rails & Brackets",
                "cwt guide-rails & brackets": "74",
                "75": "Buffers",
                "buffers": "75",
                "76": "Car Safety & Tail Rope",
                "car safety & tail rope": "76",
                "77": "Underside Platform",
                "underside platform": "77",
                "78": "Tension Weight",
                "tension weight": "78",
                "79": "Comp / Chains / Ropes / Switch",
                "comp / chains / ropes / switch": "79",
                "80": "Counterweight Runby",
                "counterweight runby": "80",
                "81": "Counterweight Runby Signage",
                "counterweight runby signage": "81",
                "82": "Plunger Gripper",
                "plunger gripper": "82",
                "83": "Fire Shutters",
                "fire shutters": "83",
                "84": "Skirt Switch",
                "skirt switch": "84",
                "85": "Skirt Deflection Device",
                "skirt deflection device": "85",
                "86": "Comb Plate / Comb Plate Teeth",
                "comb plate / comb plate teeth": "86",
                "87": "Landing Plate / Impact Switches",
                "landing plate / impact switches": "87",
                "88": "Handrails / Handrail Safeties",
                "handrails / handrail safeties": "88",
                "89": "Step / Thread",
                "step / thread": "89",
                "90": "Key Switch",
                "key switch": "90",
                "91": "Emergency Stop Button",
                "emergency stop button": "91",
                "92": "Decking and Ballistrades",
                "decking and ballistrades": "92",
                "93": "Ceiling Guards",
                "ceiling guards": "93",
                "94": "Deck Barricades",
                "deck barricades": "94",
                "95": "Internal Safeties",
                "internal safeties": "95",
                "96": "Safety Signage",
                "safety signage": "96",
                "97": "Entire Device",
                "entire device": "97",
                "98": "Current Five Year Tag",
                "current five year tag": "98",
                "99": "Current One Year Tag",
                "current one year tag": "99",
                "100": "Miscellaneous",
                "miscellaneous": "100"
            };
            let result = mapping[input] || "Invalid Number";
            
            // Only add location information if the result is a description (not a code)
            if (result !== "Invalid Number" && result !== "Enter Number" && !result.match(/^\d+$/)) {
                var intValue = parseInt(input);
                if (intValue >= 1 && intValue <= 15) {
                    result += " (Inside Car)";
                }
                
                if (intValue >= 16 && intValue <= 25) {
                    result += " (Outside Hoistway)";
                }
                
                if (intValue >= 26 && intValue <= 39) {
                    result += " (Top of Car)";
                }
                
                if (intValue >= 40 && intValue <= 69) {
                    result += " (Machine Room)";
                }
                
                if (intValue >= 70 && intValue <= 82) {
                    result += " (Pit)";
                }
                
                if (intValue >= 83 && intValue <= 96) {
                    result += " (Escalator/Moving Walk)";
                }
                
                if (intValue >= 97 && intValue <= 100) {
                    result += " (All Types)";
                }
            }
            
            return result;
        }

        function letterToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Letter",
                "a": "Altered",
                "altered": "A",
                "b": "Insufficient",
                "insufficient": "B",
                "c": "Padlocked",
                "padlocked": "C",
                "d": "Unsecured",
                "unsecured": "D",
                "e": "Rubbing",
                "rubbing": "E",
                "f": "Lost Motion",
                "lost motion": "F",
                "g": "Improper Fuses",
                "improper fuses": "G",
                "h": "Worn",
                "worn": "H",
                "i": "Damaged",
                "damaged": "I",
                "j": "Misaligned",
                "misaligned": "J",
                "k": "Rusted",
                "rusted": "K",
                "l": "Defective",
                "defective": "L",
                "m": "Missing",
                "missing": "M",
                "n": "By-Passed",
                "by-passed": "N",
                "o": "Dirty",
                "dirty": "O",
                "p": "No Means Of Access",
                "no means of access": "P",
                "q": "Unguarded",
                "unguarded": "Q",
                "r": "Illegal",
                "illegal": "R",
                "s": "Not Fire Retardant",
                "not fire retardant": "S",
                "t": "Unlabeled",
                "unlabeled": "T",
                "u": "Device Not Tagged",
                "device not tagged": "U",
                "v": "Not Level",
                "not level": "V",
                "w": "Unlocked",
                "unlocked": "W",
                "x": "Inoperative",
                "inoperative": "X",
                "y": "Oil Leak",
                "oil leak": "Y",
                "z": "Water Leak",
                "water leak": "Z",
                "aa": "Carbon Buildup",
                "carbon buildup": "AA",
                "bb": "Expired Tag",
                "expired tag": "BB"
            };
            
            return mapping[input] || "Invalid Letter";
        }

        function secondaryNumberToWord(input) {
            // Convert input to lowercase for case-insensitive comparison
            if (typeof input === 'string') {
                input = input.toLowerCase();
            }
            
            const mapping = {
                "": "Enter Number",
                "01": "Adjust",
                "1": "Adjust", 
                "adjust": "01",
                "02": "Clean",
                "2": "Clean",
                "clean": "02", 
                "03": "Install Guards",
                "3": "Install Guards",
                "install guards": "03",
                "04": "Patch",
                "4": "Patch",
                "patch": "04",
                "05": "Perform & File Test",
                "5": "Perform & File Test", 
                "perform & file test": "05",
                "06": "Properly Secure",
                "6": "Properly Secure",
                "properly secure": "06",
                "07": "Provide",
                "7": "Provide",
                "provide": "07",
                "08": "Regroove", 
                "8": "Regroove",
                "regroove": "08",
                "09": "Remove",
                "9": "Remove",
                "remove": "09",
                "10": "Repair",
                "repair": "10",
                "11": "Replace",
                "replace": "11",
                "12": "Reshackle",
                "reshackle": "12",
                "13": "Seal",
                "seal": "13",
                "14": "Shorten",
                "shorten": "14",
                "15": "Tag Device",
                "tag device": "15",
                "16": "Provide Means of Access",
                "provide means of access": "16",
                "17": "Re-inspection Required",
                "re-inspection required": "17"
            };
            
            return mapping[input] || "Invalid Number";
        }

        const numInput = document.getElementById('numInput');
        if (numInput) {
            numInput.addEventListener('input', function(e) {
                let result = numberToWord(e.target.value);
                const numResult = document.getElementById('numResult');
                if (numResult) numResult.textContent = result;
            });
        }

        const letterInput = document.getElementById('letterInput');
        if (letterInput) {
            letterInput.addEventListener('input', function(e) {
                let result = letterToWord(e.target.value);
                const letterResult = document.getElementById('letterResult');
                if (letterResult) letterResult.textContent = result;
            });
        }

        const secondaryNumInput = document.getElementById('secondaryNumInput');
        if (secondaryNumInput) {
            secondaryNumInput.addEventListener('input', function(e) {
                let result = secondaryNumberToWord(e.target.value);
                const secondaryNumResult = document.getElementById('secondaryNumResult');
                if (secondaryNumResult) secondaryNumResult.textContent = result;
            });
        }

        function clearInputs() {
            // Capture current values before clearing
            const numInput = document.getElementById('numInput');
            const letterInput = document.getElementById('letterInput');
            const secondaryNumInput = document.getElementById('secondaryNumInput');
            const numResult = document.getElementById('numResult');
            const letterResult = document.getElementById('letterResult');
            const secondaryNumResult = document.getElementById('secondaryNumResult');
            
            const numValue = numInput ? numInput.value : '';
            const letterValue = letterInput ? letterInput.value : '';
            const secondaryNumValue = secondaryNumInput ? secondaryNumInput.value : '';
            const numResultText = numResult ? numResult.textContent : '';
            const letterResultText = letterResult ? letterResult.textContent : '';
            const secondaryNumResultText = secondaryNumResult ? secondaryNumResult.textContent : '';
            
            // Save to history before clearing
            saveToMainLogWithResults(numValue, letterValue, secondaryNumValue, numResultText, letterResultText, secondaryNumResultText);
            
            // Clear the inputs and results (only violation fields, not filing information)
            if (numInput) numInput.value = '';
            if (letterInput) letterInput.value = '';
            if (secondaryNumInput) secondaryNumInput.value = '';
            if (numResult) numResult.textContent = '';
            if (letterResult) letterResult.textContent = '';
            if (secondaryNumResult) secondaryNumResult.textContent = '';
            
            if (numInput) numInput.focus();
        }

        // Function to copy text from a specific input field to clipboard
        function copyToClipboard(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement && inputElement.value.trim() !== '') {
                navigator.clipboard.writeText(inputElement.value).then(function() {
                    // Visual feedback - briefly change button text and style
                    const copyButton = event.target;
                    const originalText = copyButton.innerHTML;
                    const originalBg = copyButton.style.background;
                    copyButton.innerHTML = 'Copied!';
                    copyButton.style.background = '#28a745';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                        copyButton.style.background = originalBg;
                    }, 1200);
                }).catch(function(err) {
                    console.error('Failed to copy text: ', err);
                });
            }
        }

        // Function to clear a specific input field
        function clearField(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.value = '';
                inputElement.focus();
                
                // Clear from localStorage as well
                localStorage.removeItem(inputId + 'Info');
                
                // Visual feedback - briefly change button style
                const clearButton = event.target;
                const originalBg = clearButton.style.background;
                clearButton.style.background = '#dc3545';
                setTimeout(() => {
                    clearButton.style.background = originalBg;
                }, 1200);
            }
        }

        // Function to toggle Filing Information dropdown
        function toggleFilingInfo() {
            const fieldsContainer = document.getElementById('filingInfoFields');
            const arrow = document.getElementById('filingInfoArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to clear all Filing Information fields
        function clearAllFilingInfo() {
            const fields = ['ownerInput', 'elevatorCompanyInput', 'binInput', 'groupsInput', 'directorsInput', 'additionalInput'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Clear from localStorage
                    localStorage.removeItem(fieldId + 'Info');
                }
            });
            
            // Focus on the first field
            document.getElementById('ownerInput').focus();
        }

        // Function to toggle Quick Filing Information dropdown
        function toggleQuickFilingInfo() {
            const fieldsContainer = document.getElementById('quickFilingInfoFields');
            const arrow = document.getElementById('quickFilingInfoArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to clear all Quick Filing Information fields
        function clearAllQuickFilingInfo() {
            const fields = ['quickOwnerInput', 'quickElevatorCompanyInput', 'quickBinInput', 'quickGroupsInput', 'quickDirectorsInput', 'quickAdditionalInput'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    // Clear from localStorage
                    localStorage.removeItem(fieldId + 'Info');
                }
            });
            
            // Focus on the first field
            const firstField = document.getElementById('quickOwnerInput');
            if (firstField) {
                firstField.focus();
            }
        }

        // Function to toggle Quick Notes dropdown
        function toggleQuickNotes() {
            const fieldsContainer = document.getElementById('quickNotesFields');
            const arrow = document.getElementById('quickNotesArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Function to toggle Quick ELV3 Reference dropdown
        function toggleQuickReference() {
            const fieldsContainer = document.getElementById('quickReferenceFields');
            const arrow = document.getElementById('quickReferenceArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Populate Quick ELV3 Reference content from the main reference panel
        document.addEventListener('DOMContentLoaded', function() {
            const quickRefContent = document.getElementById('quickReferenceContent');
            const sourcePanel = document.querySelector('.reference-panel');
            if (quickRefContent && sourcePanel && quickRefContent.childElementCount === 0) {
                const fragment = document.createDocumentFragment();
                Array.from(sourcePanel.children).forEach((child) => {
                    // Skip close button and title
                    if (child.classList && child.classList.contains('close-reference')) return;
                    if (child.tagName === 'H3') return;
                    fragment.appendChild(child.cloneNode(true));
                });
                quickRefContent.appendChild(fragment);
            }
        });

        // Function to toggle Main ELV3 Reference dropdown
        function toggleMainReference() {
            const fieldsContainer = document.getElementById('mainReferenceFields');
            const arrow = document.getElementById('mainReferenceArrow');
            
            if (fieldsContainer.style.display === 'none' || fieldsContainer.style.display === '') {
                fieldsContainer.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                fieldsContainer.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Populate Main ELV3 Reference content from the reference panel
        document.addEventListener('DOMContentLoaded', function() {
            const mainRefContent = document.getElementById('mainReferenceContent');
            const sourcePanel = document.querySelector('.reference-panel');
            if (mainRefContent && sourcePanel && mainRefContent.childElementCount === 0) {
                const fragment = document.createDocumentFragment();
                Array.from(sourcePanel.children).forEach((child) => {
                    // Skip close button and title
                    if (child.classList && child.classList.contains('close-reference')) return;
                    if (child.tagName === 'H3') return;
                    fragment.appendChild(child.cloneNode(true));
                });
                mainRefContent.appendChild(fragment);
            }
        });

        // Function to clear Notes field
        function clearNotes() {
            const notesField = document.getElementById('Notes');
            if (notesField) {
                notesField.value = '';
                // Clear from localStorage
                localStorage.removeItem('elevatorNotes');
                notesField.focus();
            }
        }

        function togglePdfViewer() {
            const viewer = document.getElementById('pdfViewer');
            const button = document.getElementById('pdfToggleButton');
            viewer.classList.toggle('hidden');
            button.textContent = viewer.classList.contains('hidden') ? 'Show PDF' : 'Hide PDF';
        }
        function showTab(tabName) {
            const panel = document.getElementById('quickLookupPanel');
            const dobContent = document.getElementById('dobContent');
            const wasDOBActive = dobContent && dobContent.classList.contains('active');
            const panelIsOpen = panel && panel.style.display === 'block';
            
            // If switching away from DOB tab, remove shift classes
            if (wasDOBActive && tabName !== 'dob') {
                document.body.classList.remove('dob-shifted-for-lookup');
                if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                if (dobContent) {
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                }
            }
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const contentElement = document.getElementById(tabName + 'Content');
            if (contentElement) {
                contentElement.classList.add('active');
            }
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.backgroundColor = '';
            });
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.backgroundColor = '#333';
            }
            updatePageTitle(tabName);
            
            // After switching to the DOB tab, fetch the update date
            if (tabName === 'dob') {
                fetchAPILastUpdateDate();
                fetchViolationsAPILastUpdateDate();
                
                // Don't apply shift classes when switching to DOB tab - panel will overlay instead
            }

            // Tag body with active tab for CSS-driven layout tweaks
            document.body.setAttribute('data-active-tab', tabName);
        }

        function updatePageTitle(tabName) {
            const titleMapping = {
                main: 'ELV3 Terminal',
                dob: 'DOB Terminal',
                dates: 'DATES Terminal',
                pdf: 'PDF Terminal',
                devices: 'Device Lookup Terminal'
            };
            // Keep document title static as "Vertical Terminal"
            document.title = "Vertical Terminal";
            // Still update the visible page title element
            const pageTitleElement = document.getElementById('pageTitle');
            if (pageTitleElement) {
                pageTitleElement.textContent = titleMapping[tabName] || titleMapping.main;
            }
        }

        function submitFeedback() {
            window.location.href = "mailto:michaelnmontesano@gmail.com?subject=Vertical Terminal Feedback";
        }

        // Add this function to initialize all event listeners
        function initializeQuickLookup() {
            // Quick Lookup panel event listeners
            const quickNumInput = document.getElementById('quickNumInput');
            const quickLetterInput = document.getElementById('quickLetterInput');
            const quickSecondaryNumInput = document.getElementById('quickSecondaryNumInput');

            if (quickNumInput) {
                quickNumInput.addEventListener('input', function(e) {
                    let result = numberToWord(e.target.value);
                    document.getElementById('quickNumResult').textContent = result;
                });
            }

            if (quickLetterInput) {
                quickLetterInput.addEventListener('input', function(e) {
                    let result = letterToWord(e.target.value);
                    document.getElementById('quickLetterResult').textContent = result;
                });
            }

            if (quickSecondaryNumInput) {
                quickSecondaryNumInput.addEventListener('input', function(e) {
                    let result = secondaryNumberToWord(e.target.value);
                    document.getElementById('quickSecondaryNumResult').textContent = result;
                });
            }
        }

        // Add this to your existing window.onload function
        window.onload = function() {
            const savedNotes = localStorage.getItem('elevatorNotes');
            if (savedNotes) {
                document.getElementById('Notes').value = savedNotes;
            }
            
            // Load all saved Filing Information fields
            const filingFields = [
                { id: 'ownerInput', key: 'ownerInputInfo' },
                { id: 'elevatorCompanyInput', key: 'elevatorCompanyInputInfo' },
                { id: 'binInput', key: 'binInputInfo' },
                { id: 'groupsInput', key: 'groupsInputInfo' },
                { id: 'directorsInput', key: 'directorsInputInfo' },
                { id: 'additionalInput', key: 'additionalInputInfo' }
            ];
            
            filingFields.forEach(field => {
                const savedValue = localStorage.getItem(field.key);
                if (savedValue) {
                    document.getElementById(field.id).value = savedValue;
                }
            });

            // Load all saved Quick Filing Information fields
            const quickFilingFields = [
                { id: 'quickOwnerInput', key: 'quickOwnerInputInfo' },
                { id: 'quickElevatorCompanyInput', key: 'quickElevatorCompanyInputInfo' },
                { id: 'quickBinInput', key: 'quickBinInputInfo' },
                { id: 'quickGroupsInput', key: 'quickGroupsInputInfo' },
                { id: 'quickDirectorsInput', key: 'quickDirectorsInputInfo' },
                { id: 'quickAdditionalInput', key: 'quickAdditionalInputInfo' }
            ];
            
            quickFilingFields.forEach(field => {
                const savedValue = localStorage.getItem(field.key);
                if (savedValue) {
                    const element = document.getElementById(field.id);
                    if (element) {
                        element.value = savedValue;
                    }
                }
            });

            // Load saved Quick Notes content
            const savedQuickNotes = localStorage.getItem('quickNotesContent');
            if (savedQuickNotes) {
                const quickNotesElement = document.getElementById('quickNotesInput');
                if (quickNotesElement) {
                    quickNotesElement.value = savedQuickNotes;
                }
            }
            
            calculateNinetyDayStart();
            calculateTenDaysAfter();

            // Load default tab if set
            const defaultTab = localStorage.getItem('defaultTab');
            if (defaultTab) {
                showTab(defaultTab);
            }

            // Initialize Quick Lookup panel
            initializeQuickLookup();
            
            // Make sure overlay click closes the panel
            document.getElementById('quickLookupOverlay').addEventListener('click', function() {
                toggleQuickLookup();
            });
            
            // Add event listeners for date calculations
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // Add direct event listener to the custom days input
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', function() {
                    if (dateInput.value && customDaysInput.value && !isNaN(parseInt(customDaysInput.value))) {
                        calculateCustomDate();
                    }
                });
            }

            // Ensure body has data-active-tab set based on currently active section
            if (!document.body.getAttribute('data-active-tab')) {
                const activeSection = document.querySelector('.content-section.active');
                if (activeSection && activeSection.id.endsWith('Content')) {
                    const tabName = activeSection.id.replace('Content', '');
                    document.body.setAttribute('data-active-tab', tabName);
                } else {
                    // Fallback to main
                    document.body.setAttribute('data-active-tab', 'main');
                }
            }
        }

        // Save notes when user types
        document.getElementById('Notes').addEventListener('input', function(e) {
            localStorage.setItem('elevatorNotes', e.target.value);
        });

        // Save all Filing Information fields when user types
        document.getElementById('ownerInput').addEventListener('input', function(e) {
            localStorage.setItem('ownerInputInfo', e.target.value);
        });
        
        document.getElementById('elevatorCompanyInput').addEventListener('input', function(e) {
            localStorage.setItem('elevatorCompanyInputInfo', e.target.value);
        });
        
        document.getElementById('binInput').addEventListener('input', function(e) {
            localStorage.setItem('binInputInfo', e.target.value);
        });
        
        document.getElementById('groupsInput').addEventListener('input', function(e) {
            localStorage.setItem('groupsInputInfo', e.target.value);
        });
        
        document.getElementById('directorsInput').addEventListener('input', function(e) {
            localStorage.setItem('directorsInputInfo', e.target.value);
        });
        
        document.getElementById('additionalInput').addEventListener('input', function(e) {
            localStorage.setItem('additionalInputInfo', e.target.value);
        });

        // Add event listeners for Quick Filing Information fields with error handling
        function addQuickFilingEventListeners() {
            const quickFilingFields = [
                { id: 'quickOwnerInput', key: 'quickOwnerInputInfo' },
                { id: 'quickElevatorCompanyInput', key: 'quickElevatorCompanyInputInfo' },
                { id: 'quickBinInput', key: 'quickBinInputInfo' },
                { id: 'quickGroupsInput', key: 'quickGroupsInputInfo' },
                { id: 'quickDirectorsInput', key: 'quickDirectorsInputInfo' },
                { id: 'quickAdditionalInput', key: 'quickAdditionalInputInfo' }
            ];

            quickFilingFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('input', function(e) {
                        localStorage.setItem(field.key, e.target.value);
                    });
                }
            });

            // Add event listener for Quick Notes
            const quickNotesInput = document.getElementById('quickNotesInput');
            if (quickNotesInput) {
                quickNotesInput.addEventListener('input', function(e) {
                    localStorage.setItem('quickNotesContent', e.target.value);
                });
            }
        }

        // Initialize quick filing event listeners when page loads
        window.addEventListener('load', function() {
            addQuickFilingEventListeners();
        });

        let lastCalculation = null; // Track the last calculation performed
        let dateMode = 'positive'; // Track whether we're adding or subtracting days ('positive' or 'negative')

        function calculateDate(days) {
            const dateStr = document.getElementById('dateInput').value;
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Clear the custom days input when using preset buttons
            document.getElementById('customDays').value = '';
            
            // Store the last calculation type and value
            lastCalculation = { type: 'standard', days: days };
            
            // Create date object and set to noon UTC
            const inputDate = new Date(dateStr);
            inputDate.setUTCHours(12, 0, 0, 0);
            
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + days);
            
            // Handle positive and negative days properly in text output
            const dayText = days > 0 ? " days after " : " days before ";
            const absDay = Math.abs(days);
            
            document.getElementById('dateResult').textContent = absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            // Spelled-out format using long options
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = "" + spelledInput + " becomes " + spelledResult;
        }

        // New function to handle mode-based date calculation
        function calculateDateWithMode(days) {
            const effectiveDays = dateMode === 'negative' ? -days : days;
            calculateDate(effectiveDays);
        }

        // Function to toggle between positive and negative date calculation modes
        function toggleDateMode(mode) {
            dateMode = mode;
            
            // Update button styles for desktop
            const negativeToggle = document.getElementById('negativeToggle');
            const positiveToggle = document.getElementById('positiveToggle');
            
            // Get the date buttons to update their text
            const days10 = document.getElementById('days10');
            const days30 = document.getElementById('days30');
            const days60 = document.getElementById('days60');
            const days91 = document.getElementById('days91');
            
            // Get the dropdown options
            const daysSelect = document.getElementById('daysSelect');
            const options = daysSelect.options;
            
            // Update mobile mode dropdown
            const modeSelect = document.getElementById('modeSelect');
            if (modeSelect) {
                modeSelect.value = mode;
            }
            
            if (mode === 'negative') {
                // Negative mode active - change button text to "Prior"
                days10.textContent = '10 Days Prior';
                days30.textContent = '30 Days Prior';
                days60.textContent = '60 Days Prior';
                days91.textContent = '91 Days Prior';
                
                // Update dropdown options (options[0] is "Select Days", so start at [1])
                options[1].textContent = '10 Days Prior';
                options[2].textContent = '30 Days Prior';
                options[3].textContent = '60 Days Prior';
                options[4].textContent = '91 Days Prior';
                
                // Update toggle button styles
                negativeToggle.style.backgroundColor = '#000';
                negativeToggle.style.color = '#fff';
                negativeToggle.style.borderColor = '#000';
                
                positiveToggle.style.backgroundColor = '#f0f0f0';
                positiveToggle.style.color = '#666';
                positiveToggle.style.borderColor = '#ccc';
            } else {
                // Positive mode active (default) - revert to original text
                days10.textContent = '10 Days';
                days30.textContent = '30 Days';
                days60.textContent = '60 Days';
                days91.textContent = '91 Days';
                
                // Update dropdown options (options[0] is "Select Days", so start at [1])
                options[1].textContent = '10 Days';
                options[2].textContent = '30 Days';
                options[3].textContent = '60 Days';
                options[4].textContent = '91 Days';
                
                // Update toggle button styles
                positiveToggle.style.backgroundColor = '#000';
                positiveToggle.style.color = '#fff';
                positiveToggle.style.borderColor = '#000';
                
                negativeToggle.style.backgroundColor = '#f0f0f0';
                negativeToggle.style.color = '#666';
                negativeToggle.style.borderColor = '#ccc';
            }
            
            // Recalculate if there's a custom days value entered
            const customDaysInput = document.getElementById('customDays');
            const dateInput = document.getElementById('dateInput');
            if (customDaysInput && dateInput && customDaysInput.value && dateInput.value && !isNaN(parseInt(customDaysInput.value))) {
                calculateCustomDate();
            }
        }

        // Function to handle mode selection from mobile dropdown
        function toggleDateModeFromDropdown(mode) {
            toggleDateMode(mode);
            
            // If there's already a day value selected, recalculate with the new mode
            const daysSelect = document.getElementById('daysSelect');
            if (daysSelect && daysSelect.value && daysSelect.value !== "") {
                calculateDateWithMode(parseInt(daysSelect.value));
            }
        }

        // Modify the calculateCustomDate function to work with event triggers
        function calculateCustomDate() {
            const dateStr = document.getElementById('dateInput').value;
            const customDaysInput = document.getElementById('customDays');
            const days = parseInt(customDaysInput.value);
            
            if (isNaN(days)) {
                document.getElementById('dateResult').textContent = "Please enter a valid number.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Add maximum reasonable limit
            if (Math.abs(days) > 36500) { // 100 years
                document.getElementById('dateResult').textContent = "Please enter a more reasonable number of days.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            if (!dateStr) {
                document.getElementById('dateResult').textContent = "Please select a date.";
                document.getElementById('dateSpelledResult').textContent = "";
                return;
            }
            
            // Store the last calculation type and value
            lastCalculation = { type: 'custom', days: days };
            
            // Apply the dateMode to determine direction (prior = negative, future = positive)
            const effectiveDays = dateMode === 'negative' ? -Math.abs(days) : Math.abs(days);
            
            const inputDate = new Date(dateStr + "T12:00:00");
            const resultDate = new Date(inputDate);
            resultDate.setDate(resultDate.getDate() + effectiveDays);
            
            const dayText = effectiveDays > 0 ? " days after " : " days before ";
            const absDay = Math.abs(effectiveDays);
            
            document.getElementById('dateResult').textContent = 
                absDay + dayText + inputDate.toLocaleDateString() + " is " + resultDate.toLocaleDateString();

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledInput = inputDate.toLocaleDateString('en-US', options);
            const spelledResult = resultDate.toLocaleDateString('en-US', options);
            document.getElementById('dateSpelledResult').textContent = 
                spelledInput + " becomes " + spelledResult;
        }

        function clearDateInput() {
            document.getElementById('dateInput').value = '';
            document.getElementById('customDays').value = '';
            document.getElementById('daysSelect').value = ''; // Reset dropdown
            document.getElementById('dateResult').textContent = '';
            document.getElementById('dateSpelledResult').textContent = '';
            lastCalculation = null; // Reset the last calculation
        }

        // Add this new function to reapply the last calculation when date changes
        function dateChanged() {
            if (lastCalculation) {
                if (lastCalculation.type === 'standard') {
                    calculateDate(lastCalculation.days);
                } else if (lastCalculation.type === 'custom') {
                    calculateCustomDate();
                }
            }
        }

        // Add event listener for the date input
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
        });



        function toggleReference() {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            if (panel.style.display === 'block') {
                // Closing animation
                overlay.style.opacity = '0';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-50%) translateY(-20px)';
                button.textContent = 'ELV3 Reference';
                
                // Wait for transition to complete before hiding
                setTimeout(() => {
                    panel.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            } else {
                // Opening animation
                panel.style.display = 'block';
                overlay.style.display = 'block';
                button.textContent = 'Hide Reference';
                
                // Small delay to ensure display is set before animating
                setTimeout(() => {
                    overlay.style.opacity = '1';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(-50%) translateY(0)';
                }, 10);
            }
            
            event.stopPropagation();
        }

        // Update the click outside handler
        document.addEventListener('click', function(event) {
            const panel = document.querySelector('.reference-panel');
            const overlay = document.querySelector('.reference-overlay');
            const button = document.querySelector('.toggle-reference');
            
            // Check if the click is outside the panel and not on the toggle button
            if (panel.style.display === 'block' && 
                !panel.contains(event.target) && 
                event.target !== button) {
                
                panel.style.display = 'none';
                overlay.style.display = 'none';
                button.textContent = 'ELV3 Reference';
            }
        });

        // Update the panel click handler
        document.querySelector('.reference-panel').addEventListener('click', function(event) {
            event.stopPropagation();
        });

        function calculateNinetyDayStart() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 91);
            
            // Format for the simple date
            const simpleDate = startDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = startDate.toLocaleDateString('en-US', options);
            
            document.getElementById('ninetyDayStart').innerHTML = 
                `<div>Any date on or before: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        function calculateTenDaysAfter() {
            const today = new Date();
            const futureDate = new Date(today);
            futureDate.setDate(today.getDate() + 10);
            
            // Format for the simple date
            const simpleDate = futureDate.toLocaleDateString();
            
            // Format for the spelled out date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const spelledDate = futureDate.toLocaleDateString('en-US', options);
            
            document.getElementById('tenDaysAfter').innerHTML = 
                `<div>Date: ${simpleDate}</div>
                 <div style="margin-top: 5px;">(${spelledDate})</div>`;
        }

        // Removed dropdown menu; function no longer needed

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            // Load current setting
            const savedTab = localStorage.getItem('defaultTab') || 'main';
            document.getElementById('defaultTab').value = savedTab;
            
            // Close dropdown
            document.getElementById('dropdownContent').style.display = 'none';

            // Add click event listener to close settings when clicking outside
            overlay.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    closeSettings();
                }
            });

            // Prevent clicks inside the modal from closing it
            modal.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('settingsOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function saveSettings() {
            const defaultTab = document.getElementById('defaultTab').value;
            localStorage.setItem('defaultTab', defaultTab);
            closeSettings();
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-button')) {
                const dropdown = document.getElementById('dropdownContent');
                if (dropdown.style.display === 'block') {
                    dropdown.style.display = 'none';
                }
            }
        }

        // Add this new function to your script section
        async function lookupBIN() {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const resultDiv = document.getElementById('binResult');
            const binInput = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    quickBinValue.textContent = device.bin || '-';
                    updateBinDisplayStyle();
                    if (device.bin) {
                        lookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);
                    
                    // Fetch permit information to check for removal permits
                    const permitResult = await fetchPermitInfo(deviceNumber);
                    const hasPermits = permitResult.success && permitResult.permits && permitResult.permits.length > 0;
                    const permitData = permitResult;

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('deviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">‚ñº</span>
                            </button>
                            <div id="deviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                    
                    resultDiv.innerHTML = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Number:</strong> 
                                <span style="${dateStyle}">${device.device_number || deviceNumber}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('device_violations_${deviceNumber}')" 
                                            id="violationsBtn_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div id="violations_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <strong style="color: var(--header-color); margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            <!-- Add Important dropdown for red devices -->
                            ${allDatesAreSame ? `
                                <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                    <button onclick="toggleImportantDropdown('device_${device.device_number || deviceNumber}')"
                                            style="width: 100%; padding: 10px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                        <span>‚ö†Ô∏è Important</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div id="important_device_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b;">
                                        <div style="margin-bottom: 8px;">
                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                        </div>
                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that a final acceptance test was performed on this device. If a final acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Add Important dropdown for missed required tests -->
                            ${(() => {
                                const missedTests = getMissedRequiredTests(device);
                                if (missedTests.length > 0) {
                                    // Check if device has a removal permit
                                    let hasRemovalPermit = false;
                                    let removalPermitNumber = '';
                                    if (hasPermits && permitData.permits) {
                                        const removalPermit = permitData.permits.find(p => {
                                            const workType = (p.work_type || '').toUpperCase();
                                            const description = (p.description || '').toUpperCase();
                                            const appType = (p.application_type || '').toUpperCase();
                                            return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                                   workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                                   description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                                   description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                                   appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                        });
                                        if (removalPermit) {
                                            hasRemovalPermit = true;
                                            removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                        }
                                    }
                                    
                                    const missedTestsList = missedTests.map(mt => 
                                        `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                            <strong style="color: #ff9800;">${mt.test}</strong> test missed in <strong>${mt.year}</strong>
                                            <br><span style="font-size: 0.9em; opacity: 0.8;">Last ${mt.test} test on record: ${mt.lastTestDate}</span>
                                        </div>`
                                    ).join('');
                                    
                                    const removalPermitNote = hasRemovalPermit ? `
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                            <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                                üìã Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''}
                                            </div>
                                            <div style="font-size: 0.85em; opacity: 0.9;">
                                                Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                            </div>
                                        </div>
                                    ` : '';
                                    
                                    return `
                                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                            <button onclick="toggleMissedTestDropdown('device_${device.device_number || deviceNumber}')"
                                                    style="width: 100%; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                                <span>‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})</span>
                                                <span class="arrow">‚ñº</span>
                                            </button>
                                            <div id="missed_test_device_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">
                                                <div style="margin-bottom: 8px;">
                                                    <strong style="color: #ff9800;">Missed Required Test Alert</strong>
                                                </div>
                                                <div style="color: var(--text-color);">
                                                    ${missedTestsList}
                                                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                                                        CAT 1 and PVI tests are required annually. CAT 5 tests are required every 5 years. Please verify this information with official DOB records.
                                                    </div>
                                                    ${removalPermitNote}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '';
                            })()}
                            
                            ${deviceSpecsHTML}
                            
                            <!-- Add More Info button and dropdown -->
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <button onclick="toggleMoreInfo('moreInfo_${device.device_number}')"
                                        style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span>More Info</span>
                                    <span class="arrow">‚ñº</span>
                                </button>
                                <div id="moreInfo_${device.device_number}" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> 
                                        <span>${device.block || 'N/A'}</span>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> 
                                        <span>${device.lot || 'N/A'}</span>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="window.open('https://a836-pts-access.nyc.gov/care/forms/htmlframe.aspx?mode=content/home.htm', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=yes,menubar=yes,location=yes')"
                                           onmouseover="this.style.opacity='0.8';"
                                           onmouseout="this.style.opacity='1';"
                                           style="display: inline-block; padding: 6px 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-weight: 500; transition: opacity 0.2s ease;">
                                            NYC Finance
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this function to toggle device information
        function toggleDeviceInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                element.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                element.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        // Add this new function to toggle building devices in bulk lookup
        function toggleBuildingDevices(bin) {
            const devicesContainer = document.getElementById(`buildingDevices_${bin}`);
            const arrow = document.getElementById(`buildingArrow_${bin}`);
            
            if (devicesContainer.style.display === 'none') {
                devicesContainer.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                devicesContainer.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Open building information in a full-screen popup modal
        function openBuildingPopup(bin) {
            // Find the building data from the allBuildings list
            const buildingData = window.bulkDeviceLists.allBuildings?.find(b => b.bin === bin);
            if (!buildingData) {
                console.error('Building not found:', bin);
                return;
            }
            
            const currentYear = new Date().getFullYear();
            
            // Sort devices: Active devices first, removed/deleted at bottom
            const sortedDevices = buildingData.devices ? [...buildingData.devices].sort((a, b) => {
                const aStatus = (a.device_status || '').toUpperCase();
                const bStatus = (b.device_status || '').toUpperCase();
                const aIsRemoved = aStatus.includes('REMOVED') || aStatus.includes('DELETED');
                const bIsRemoved = bStatus.includes('REMOVED') || bStatus.includes('DELETED');
                
                // Primary sort: Removed/deleted devices go to the bottom
                if (aIsRemoved !== bIsRemoved) {
                    return aIsRemoved ? 1 : -1;
                }
                
                // Secondary sort: By ready status (not ready first)
                if (a.isReady !== b.isReady) {
                    if (a.isReady === 'N/A') return 1;
                    if (b.isReady === 'N/A') return -1;
                    return a.isReady === 'Yes' ? 1 : -1;
                }
                
                // Tertiary sort: By violations
                return (b.violationCount || 0) - (a.violationCount || 0);
            }) : [];
            
            // Generate the device table rows with violation details
            const deviceTableRows = sortedDevices.map((d, idx) => {
                const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                let rows = `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap; font-size: 1em; color: ${d.allDatesAreSame ? '#ff6b6b' : 'var(--text-color)'};">${d.device_number}${d.allDatesAreSame ? ' ‚ö†Ô∏è' : ''}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${d.device_type}">${d.device_type}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center;">${d.device_status}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasPVIThisYear ? '600' : '400'};">${d.pvi_date}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasCat1ThisYear ? '600' : '400'};">${d.cat1_date}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat5ThisYear ? '#4CAF50' : (d.requiresCat5 ? '#ff9800' : 'var(--text-color)')}; font-weight: ${d.hasCat5ThisYear || d.requiresCat5 ? '600' : '400'};">${d.cat5_date}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '#ff9800' : 'var(--text-color)'}; font-weight: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '600' : '400'};">${d.next_cat5}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.completionColor}; font-weight: 600;">${d.completionStatus}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.isReadyColor}; font-weight: 600;">${d.isReady}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center;">${d.eligibleDate}</td>
                        <td style="padding: 12px 10px; border: 1px solid var(--input-border); text-align: center; color: ${d.violationCount > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${d.violationCount}</td>
                    </tr>
                `;
                
                // Add expandable violation details row if there are violations
                if (d.violationCount > 0 && d.violations && d.violations.length > 0) {
                    let violationRows = '';
                    d.violations.forEach(v => {
                        const issueDate = v.violation_issue_date || v.violation_date;
                        const formattedDate = issueDate ? new Date(issueDate).toLocaleDateString() : '‚Äî';
                        const description = v.violation_description || v.violation_remarks || '‚Äî';
                        const truncatedDesc = description.length > 100 ? description.substring(0, 100) + '...' : description;
                        const statusColor = v.violation_status?.toUpperCase() === 'ACTIVE' ? '#ff6b6b' : 'var(--text-color)';
                        
                        violationRows += '<tr>' +
                            '<td style="padding: 8px 10px; border: 1px solid var(--input-border); color: var(--text-color);">' + (v.violation_number || '‚Äî') + '</td>' +
                            '<td style="padding: 8px 10px; border: 1px solid var(--input-border); color: var(--text-color);">' + formattedDate + '</td>' +
                            '<td style="padding: 8px 10px; border: 1px solid var(--input-border); color: var(--text-color);">' + (v.violation_severity || '‚Äî') + '</td>' +
                            '<td style="padding: 8px 10px; border: 1px solid var(--input-border); color: ' + statusColor + '; font-weight: 600;">' + (v.violation_status || '‚Äî') + '</td>' +
                            '<td style="padding: 8px 10px; border: 1px solid var(--input-border); color: var(--text-color); max-width: 400px;" title="' + description.replace(/"/g, '&quot;') + '">' + truncatedDesc + '</td>' +
                            '</tr>';
                    });
                    
                    rows += '<tr style="background: ' + rowBg + ';">' +
                        '<td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">' +
                            '<details style="margin: 0;">' +
                                '<summary style="padding: 10px 15px; cursor: pointer; color: #ff6b6b; font-weight: 600; font-size: 0.95em; background: rgba(255, 107, 107, 0.1);">' +
                                    '‚ö† View ' + d.violationCount + ' violation' + (d.violationCount > 1 ? 's' : '') + ' for Device #' + d.device_number +
                                '</summary>' +
                                '<div style="padding: 15px; background: var(--panel-bg);">' +
                                    '<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">' +
                                        '<thead>' +
                                            '<tr style="background: var(--input-bg);">' +
                                                '<th style="padding: 10px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color); font-weight: 600;">Violation #</th>' +
                                                '<th style="padding: 10px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color); font-weight: 600;">Issue Date</th>' +
                                                '<th style="padding: 10px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color); font-weight: 600;">Severity</th>' +
                                                '<th style="padding: 10px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color); font-weight: 600;">Status</th>' +
                                                '<th style="padding: 10px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color); font-weight: 600;">Description</th>' +
                                            '</tr>' +
                                        '</thead>' +
                                        '<tbody>' +
                                            violationRows +
                                        '</tbody>' +
                                    '</table>' +
                                '</div>' +
                            '</details>' +
                        '</td>' +
                    '</tr>';
                }
                
                // Add Important dropdown row if all dates are the same
                if (d.allDatesAreSame) {
                    rows += '<tr style="background: ' + rowBg + ';">' +
                        '<td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">' +
                            '<details style="margin: 0;">' +
                                '<summary style="padding: 10px 15px; cursor: pointer; color: #ff6b6b; font-weight: 600; font-size: 0.95em; background: rgba(255, 107, 107, 0.15);">' +
                                    '‚ö†Ô∏è Important - Data Quality Alert for Device #' + d.device_number +
                                '</summary>' +
                                '<div style="padding: 15px; background: rgba(255, 107, 107, 0.1); border-top: 1px solid #ff6b6b;">' +
                                    '<div style="color: var(--text-color); font-size: 0.95em;">' +
                                        'This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection tests are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.' +
                                    '</div>' +
                                '</div>' +
                            '</details>' +
                        '</td>' +
                    '</tr>';
                }
                
                // Add Important dropdown row for missed required tests
                const missedTests = getMissedRequiredTests(d);
                if (missedTests.length > 0) {
                    // Check for removal permits for this device
                    let removalPermitNote = '';
                    const allPermits = window.bulkDeviceLists?.permits || [];
                    const devicePermits = allPermits.filter(p => p.device_number === d.device_number);
                    if (devicePermits.length > 0) {
                        const removalPermit = devicePermits.find(p => {
                            const workType = (p.work_type || '').toUpperCase();
                            const description = (p.description || '').toUpperCase();
                            const appType = (p.application_type || '').toUpperCase();
                            return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                   workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                   description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                   description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                   appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                        });
                        if (removalPermit) {
                            const permitNum = removalPermit.permit_number || removalPermit.job_filing_number || '';
                            removalPermitNote = '<div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">' +
                                '<div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">' +
                                    'üìã Removal Permit Found' + (permitNum ? ': ' + permitNum : '') +
                                '</div>' +
                                '<div style="font-size: 0.85em; opacity: 0.9;">' +
                                    'Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.' +
                                '</div>' +
                            '</div>';
                        }
                    }
                    
                    const missedTestsList = missedTests.map(mt => 
                        '<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">' +
                            '<strong style="color: #ff9800;">' + mt.test + '</strong> test missed in <strong>' + mt.year + '</strong>' +
                            '<br><span style="font-size: 0.9em; opacity: 0.8;">Last ' + mt.test + ' test on record: ' + mt.lastTestDate + '</span>' +
                        '</div>'
                    ).join('');
                    rows += '<tr style="background: ' + rowBg + ';">' +
                        '<td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">' +
                            '<details style="margin: 0;">' +
                                '<summary style="padding: 10px 15px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.95em; background: rgba(255, 152, 0, 0.15);">' +
                                    '‚ö†Ô∏è Important - Missed Required Test' + (missedTests.length > 1 ? 's' : '') + ' (' + missedTests.length + ') for Device #' + d.device_number +
                                '</summary>' +
                                '<div style="padding: 15px; background: rgba(255, 152, 0, 0.1); border-top: 1px solid #ff9800;">' +
                                    '<div style="color: var(--text-color); font-size: 0.95em;">' +
                                        missedTestsList +
                                        '<div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">CAT 1 and PVI tests are required annually. CAT 5 tests are required every 5 years. Please verify with official DOB records.</div>' +
                                        removalPermitNote +
                                    '</div>' +
                                '</div>' +
                            '</details>' +
                        '</td>' +
                    '</tr>';
                }
                
                return rows;
            }).join('') || '<tr><td colspan="11" style="padding: 20px; text-align: center; opacity: 0.7;">No devices found</td></tr>';
            
            // Calculate summary stats
            const totalDevices = buildingData.deviceCount || 0;
            const totalViolations = buildingData.violationCount || 0;
            const readyDevices = buildingData.devices?.filter(d => d.isReady === 'Yes' || d.isReady === '‚úì').length || 0;
            const notReadyDevices = totalDevices - readyDevices;
            
            // Create and show the full-screen modal
            const modalHTML = `
                    <div id="buildingPopupModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
                    <div style="position: relative; background: var(--card-bg); border-radius: 12px; width: 100%; max-width: 1400px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--input-border);">
                        <!-- Close button at top-right corner -->
                        <button onclick="closeBuildingPopup()" 
                                style="position: absolute; top: 2px; right: 15px; background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--text-color); padding: 0; line-height: 1; transition: color 0.2s, transform 0.2s; z-index: 1;"
                                onmouseover="this.style.color='#ff6b6b'; this.style.transform='scale(1.1)';"
                                onmouseout="this.style.color='var(--text-color)'; this.style.transform='scale(1)';">
                            √ó
                        </button>
                        <!-- Header -->
                        <div style="padding: 20px 25px; border-bottom: 2px solid var(--input-border); flex-shrink: 0;">
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--header-color); margin-bottom: 8px;">
                                üè¢ ${buildingData.address}
                            </div>
                            <div style="font-size: 1em; color: var(--text-color); opacity: 0.8;">
                                BIN: <strong>${buildingData.bin}</strong>
                            </div>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div style="padding: 15px 25px; background: var(--input-bg); border-bottom: 1px solid var(--input-border); display: flex; gap: 30px; flex-wrap: wrap; flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 600; color: var(--header-color);">Total Devices:</span>
                                <span style="font-size: 1.2em; font-weight: 700; color: var(--text-color);">${totalDevices}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 600; color: var(--header-color);">Ready to Test:</span>
                                <span style="font-size: 1.2em; font-weight: 700; color: #4CAF50;">${readyDevices}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 600; color: var(--header-color);">Not Ready:</span>
                                <span style="font-size: 1.2em; font-weight: 700; color: #ff6b6b;">${notReadyDevices}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 600; color: var(--header-color);">Active Violations:</span>
                                <span style="font-size: 1.2em; font-weight: 700; color: ${totalViolations > 0 ? '#ff6b6b' : '#4CAF50'};">${totalViolations}</span>
                            </div>
                        </div>
                        
                        <!-- Table Content -->
                        <div style="flex: 1; overflow: auto; padding: 0 20px 20px 20px;">
                            <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.95em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                <thead>
                                    <tr>
                                        <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Device #</th>
                                        <th style="padding: 14px 10px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Type</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Status</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">PVI</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">CAT 1</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">CAT 5</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Next CAT 5</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">${currentYear} Status</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Ready</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Eligible Date</th>
                                        <th style="padding: 14px 10px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap; background: var(--panel-bg); position: sticky; top: 0; z-index: 2;">Violations</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${deviceTableRows}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 15px 25px; border-top: 1px solid var(--input-border); display: flex; justify-content: flex-end; flex-shrink: 0;">
                            <button onclick="closeBuildingPopup()" 
                                    style="padding: 12px 30px; background: var(--header-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease;"
                                    onmouseover="this.style.opacity='0.9';"
                                    onmouseout="this.style.opacity='1';">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing popup
            const existingPopup = document.getElementById('buildingPopupModal');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Add the popup to the body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add click handler to close on background click
            document.getElementById('buildingPopupModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBuildingPopup();
                }
            });
            
            // Add escape key handler
            document.addEventListener('keydown', handleBuildingPopupEscape);
        }
        
        // Close building popup modal
        function closeBuildingPopup() {
            const popup = document.getElementById('buildingPopupModal');
            if (popup) {
                popup.remove();
            }
            document.removeEventListener('keydown', handleBuildingPopupEscape);
        }
        
        // Handle escape key to close building popup
        function handleBuildingPopupEscape(e) {
            if (e.key === 'Escape') {
                closeBuildingPopup();
            }
        }

        // Global variables to store bulk device lists for modal
        window.bulkDeviceLists = {
            bothTests: [],
            oneTest: [],
            warning: [],
            noTests: [],
            noTestRequired: [],
            permits: []
        };

        // Toggle function for bulk test completion status lists - now shows popup modal
        function toggleBulkTestList(listType) {
            const modal = document.getElementById('bulkDeviceListModal');
            const modalTitle = document.getElementById('bulkModalTitle');
            const modalContent = document.getElementById('bulkModalContent');
            
            if (!modal || !modalTitle || !modalContent) return;
            
            const listConfigs = {
                'bothTests': {
                    title: '‚úì All Tests Completed',
                    color: '#4CAF50',
                    data: window.bulkDeviceLists.bothTests,
                    groupByBuilding: true,
                    renderItem: (d) => {
                        let testInfo = d.isDismantled ? 'PVI done (Dismantled)' : 'PVI + CAT done';
                        let statusNote = d.isDismantled ? '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span> ' : '';
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #4CAF50;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                    <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span> ${statusNote}
                                </div>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                <span style="color: #4CAF50; font-weight: 600;">‚úì ${testInfo}</span>
                            </div>
                            ${missedTestHtml}
                        </div>`;
                    }
                },
                'oneTest': {
                    title: '‚ö† One Test Completed',
                    color: '#ffd700',
                    data: window.bulkDeviceLists.oneTest,
                    groupByBuilding: true,
                    renderItem: (d) => {
                        let testInfo;
                        if (d.isConveyor) {
                            testInfo = 'CAT 1 pending';
                        } else if (d.isDismantled) {
                            testInfo = 'PVI pending';
                        } else {
                            testInfo = d.hasPVI ? 'CAT pending' : 'PVI pending';
                        }
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #ffd700;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                    <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                <span style="color: #ffd700; font-weight: 600;">‚ö† ${testInfo}</span>
                            </div>
                            ${missedTestHtml}
                        </div>`;
                    }
                },
                'warning': {
                    title: '‚ö† CAT 5 Required',
                    color: '#ff9800',
                    data: window.bulkDeviceLists.warning,
                    groupByBuilding: true,
                    renderItem: (d) => {
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #ff9800;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                    <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                <span style="color: #ff9800; font-weight: 600;">‚ö† CAT 5 required (last: ${d.yearsSinceCat5} years ago)</span>
                            </div>
                            ${missedTestHtml}
                        </div>`;
                    }
                },
                'noTests': {
                    title: '‚úó No Tests Completed',
                    color: '#ff6b6b',
                    data: window.bulkDeviceLists.noTests,
                    groupByBuilding: true,
                    renderItem: (d) => {
                        let statusNote = d.isDismantled ? '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span> ' : '';
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #ff6b6b;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                    <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span> ${statusNote}
                                </div>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                <span style="color: #ff6b6b; font-weight: 600;">‚úó No tests done this year</span>
                            </div>
                            ${missedTestHtml}
                        </div>`;
                    }
                },
                'noTestRequired': {
                    title: '‚Äî No Test Required',
                    color: '#9e9e9e',
                    data: window.bulkDeviceLists.noTestRequired,
                    groupByBuilding: true,
                    renderItem: (d) => {
                        return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #9e9e9e;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                    <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span> 
                                    <span style="color: #9e9e9e; font-weight: bold;">[REMOVED]</span>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                <span style="opacity: 0.7;">Device removed from service</span>
                            </div>
                        </div>`;
                    }
                },
                'readyToTest': {
                    title: '‚úì Ready to Test',
                    color: '#4CAF50',
                    // Combine ready devices with not-ready devices from the same buildings
                    getData: () => {
                        const readyDevices = window.bulkDeviceLists.readyToTest || [];
                        const notReadyDevices = window.bulkDeviceLists.notReadyToTest || [];
                        
                        // Get all building addresses that have at least one ready device
                        const readyBuildingAddresses = new Set();
                        readyDevices.forEach(d => {
                            const address = d.buildingAddress || d.address || 'Unknown Address';
                            readyBuildingAddresses.add(address);
                        });
                        
                        // Get not-ready devices from the same buildings
                        const notReadyFromSameBuildings = notReadyDevices.filter(d => {
                            const address = d.buildingAddress || d.address || 'Unknown Address';
                            return readyBuildingAddresses.has(address);
                        });
                        
                        // Combine both lists
                        return [...readyDevices, ...notReadyFromSameBuildings];
                    },
                    get data() { return this.getData(); },
                    groupByBuilding: true,
                    showNotReadyAtTop: true,
                    renderItem: (d) => {
                        const lastInspectionStr = d.mostRecentInspection 
                            ? d.mostRecentInspection.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                            : 'No inspection on file';
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        
                        // Check if device is ready or not ready
                        if (d.isReadyToTest) {
                            return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #4CAF50;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                    <div>
                                        <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                        <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                    </div>
                                </div>
                                <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                    <span><strong>Last Inspection:</strong> ${lastInspectionStr}</span>
                                    <span style="color: #4CAF50; font-weight: 600; margin-left: 10px;">‚úì Eligible now</span>
                                </div>
                                ${missedTestHtml}
                            </div>`;
                        } else {
                            // Not ready device - show at top with special styling
                            const eligibleDateStr = d.eligibleTestDate 
                                ? d.eligibleTestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                                : 'Unknown';
                            const daysText = d.daysUntilEligible === 1 ? '1 day' : `${d.daysUntilEligible} days`;
                            return `<div style="padding: 10px 12px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border-left: 2px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                    <div>
                                        <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                        <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                        <span style="color: #ff6b6b; font-weight: 600; font-size: 0.85em; margin-left: 8px;">‚è≥ NOT READY YET</span>
                                    </div>
                                </div>
                                <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                    <span><strong>Last:</strong> ${lastInspectionStr}</span>
                                    <span style="margin-left: 10px;"><strong>Eligible:</strong> <span style="color: #ff6b6b; font-weight: 600;">${eligibleDateStr}</span></span>
                                    <span style="color: #ff6b6b; font-weight: 600; margin-left: 10px;">(${daysText})</span>
                                </div>
                                ${missedTestHtml}
                            </div>`;
                        }
                    }
                },
                'notReadyToTest': {
                    title: '‚úó Not Ready Yet',
                    color: '#ff6b6b',
                    // Combine not-ready devices with ready devices from the same buildings
                    getData: () => {
                        const readyDevices = window.bulkDeviceLists.readyToTest || [];
                        const notReadyDevices = window.bulkDeviceLists.notReadyToTest || [];
                        
                        // Get all building addresses that have at least one not-ready device
                        const notReadyBuildingAddresses = new Set();
                        notReadyDevices.forEach(d => {
                            const address = d.buildingAddress || d.address || 'Unknown Address';
                            notReadyBuildingAddresses.add(address);
                        });
                        
                        // Get ready devices from the same buildings
                        const readyFromSameBuildings = readyDevices.filter(d => {
                            const address = d.buildingAddress || d.address || 'Unknown Address';
                            return notReadyBuildingAddresses.has(address);
                        });
                        
                        // Combine both lists
                        return [...notReadyDevices, ...readyFromSameBuildings];
                    },
                    get data() { return this.getData(); },
                    groupByBuilding: true,
                    sortByEligibleDate: true,
                    showReadyAtBottom: true,
                    renderItem: (d) => {
                        const lastInspectionStr = d.mostRecentInspection 
                            ? d.mostRecentInspection.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                            : 'No inspection on file';
                        const missedTests = getMissedRequiredTests(d);
                        const missedTestHtml = missedTests.length > 0 ? `
                            <details style="margin-top: 8px;">
                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.85em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                    ‚ö†Ô∏è Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                </summary>
                                <div style="padding: 10px; margin-top: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.85em;">
                                    ${missedTests.map(mt => `<div style="margin-bottom: 4px;"><strong>${mt.test}</strong> missed in ${mt.year} (Last: ${mt.lastTestDate})</div>`).join('')}
                                </div>
                            </details>
                        ` : '';
                        
                        // Check if device is ready or not ready
                        if (!d.isReadyToTest) {
                            const eligibleDateStr = d.eligibleTestDate 
                                ? d.eligibleTestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                                : 'Unknown';
                            const daysText = d.daysUntilEligible === 1 ? '1 day' : `${d.daysUntilEligible} days`;
                            return `<div style="padding: 10px 12px; background: var(--panel-bg); border-radius: 4px; border-left: 2px solid #ff6b6b;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                    <div>
                                        <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                        <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                    </div>
                                </div>
                                <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                    <span><strong>Last:</strong> ${lastInspectionStr}</span>
                                    <span style="margin-left: 10px;"><strong>Eligible:</strong> <span style="color: #ff6b6b; font-weight: 600;">${eligibleDateStr}</span></span>
                                    <span style="color: #ff6b6b; font-weight: 600; margin-left: 10px;">‚è≥ ${daysText}</span>
                                </div>
                                ${missedTestHtml}
                            </div>`;
                        } else {
                            // Ready device - show at bottom with green styling
                            return `<div style="padding: 10px 12px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 2px solid #4CAF50;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
                                    <div>
                                        <strong style="font-size: 1em;">Device #${d.device_number}</strong> 
                                        <span style="color: var(--text-color); opacity: 0.8; font-size: 0.9em;">(${d.device_type})</span>
                                        <span style="color: #4CAF50; font-weight: 600; font-size: 0.85em; margin-left: 8px;">‚úì READY TO TEST</span>
                                    </div>
                                </div>
                                <div style="font-size: 0.8em; margin-top: 6px; opacity: 0.85;">
                                    <span><strong>Last Inspection:</strong> ${lastInspectionStr}</span>
                                    <span style="color: #4CAF50; font-weight: 600; margin-left: 10px;">‚úì Eligible now</span>
                                </div>
                                ${missedTestHtml}
                            </div>`;
                        }
                    }
                },
                'allBuildings': {
                    title: 'üè¢ All Buildings',
                    color: 'var(--header-color)',
                    data: window.bulkDeviceLists.allBuildings || [],
                    groupByBuilding: false,
                    isBuildingList: true,
                    isExpandableBuildingList: true,
                    renderItem: (b, index) => {
                        const groupId = `allBuildingsGroup_${Date.now()}_${index}`;
                        const currentYear = new Date().getFullYear();
                        
                        const deviceTableRows = b.devices ? b.devices.map((d, idx) => {
                            const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                            return `
                                <tr style="background: ${rowBg};">
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${d.device_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${d.device_type}">${d.device_type}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.device_status}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasPVIThisYear ? '600' : '400'};">${d.pvi_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasCat1ThisYear ? '600' : '400'};">${d.cat1_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat5ThisYear ? '#4CAF50' : (d.requiresCat5 ? '#ff9800' : 'var(--text-color)')}; font-weight: ${d.hasCat5ThisYear || d.requiresCat5 ? '600' : '400'};">${d.cat5_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '#ff9800' : 'var(--text-color)'}; font-weight: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '600' : '400'};">${d.next_cat5}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.completionColor}; font-weight: 600;">${d.completionStatus}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.isReadyColor}; font-weight: 600;">${d.isReady}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.eligibleDate}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.violationCount > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${d.violationCount}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="11" style="padding: 20px; text-align: center; opacity: 0.7;">No devices found</td></tr>';
                        
                        return `<div style="background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border); overflow: hidden;">
                            <div onclick="toggleBuildingGroup('${groupId}')" 
                                 style="padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: background 0.2s;"
                                 onmouseover="this.style.background='var(--panel-bg)'" 
                                 onmouseout="this.style.background='var(--input-bg)'">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="font-size: 1.2em;">üè¢</span>
                                    <div>
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                            <strong style="font-size: 1.05em;">${b.address}</strong>
                                            <span style="opacity: 0.7; font-size: 0.9em;">(BIN: ${b.bin})</span>
                                        </div>
                                        <div style="font-size: 0.85em; opacity: 0.7; margin-top: 2px; display: flex; gap: 12px;">
                                            <span>${b.deviceCount} device${b.deviceCount !== 1 ? 's' : ''}</span>
                                            <span style="color: ${b.violationCount > 0 ? '#ff6b6b' : '#4CAF50'};">${b.violationCount} violation${b.violationCount !== 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <span id="${groupId}_arrow" style="font-size: 1.2em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                            </div>
                            <div id="${groupId}" style="display: none; border-top: 1px solid var(--input-border);">
                                <div style="max-height: 300px; overflow: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                        <thead>
                                            <tr style="background: var(--panel-bg); position: sticky; top: 0; z-index: 1;">
                                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Device #</th>
                                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Type</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">PVI</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 1</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 5</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Next CAT5</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">${new Date().getFullYear()} Status</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Ready</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Eligible</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violations</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${deviceTableRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                    }
                },
                'allViolations': {
                    title: '‚ö† Total Violations',
                    color: '#ff6b6b',
                    data: window.bulkDeviceLists.allViolations || [],
                    groupByBuilding: false,
                    isBuildingList: true,
                    isExpandableBuildingList: true,
                    renderItem: (b, index) => {
                        const groupId = `allViolationsGroup_${Date.now()}_${index}`;
                        const violationsId = `${groupId}_violations`;
                        const currentYear = new Date().getFullYear();
                        
                        // Generate device rows - show ALL devices in the building
                        const deviceTableRows = b.allDevices ? b.allDevices.map((d, idx) => {
                            const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                            return `
                                <tr style="background: ${rowBg};">
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${d.device_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${d.device_type}">${d.device_type}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.device_status}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasPVIThisYear ? '600' : '400'};">${d.pvi_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasCat1ThisYear ? '600' : '400'};">${d.cat1_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat5ThisYear ? '#4CAF50' : (d.requiresCat5 ? '#ff9800' : 'var(--text-color)')}; font-weight: ${d.hasCat5ThisYear || d.requiresCat5 ? '600' : '400'};">${d.cat5_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '#ff9800' : 'var(--text-color)'}; font-weight: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '600' : '400'};">${d.next_cat5}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.completionColor}; font-weight: 600;">${d.completionStatus}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.isReadyColor}; font-weight: 600;">${d.isReady}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.eligibleDate}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.violationCount > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${d.violationCount}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="11" style="padding: 20px; text-align: center; opacity: 0.7;">No devices found</td></tr>';
                        
                        // Generate violation details rows
                        const violationRows = b.violationDetails ? b.violationDetails.map((v, idx) => {
                            const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                            const status = (v.violation_status || '').toUpperCase();
                            const statusColor = status.includes('ACTIVE') || status.includes('OPEN') ? '#ff6b6b' : 
                                               status.includes('CURED') || status.includes('CLOSED') ? '#4CAF50' : 
                                               status.includes('DISMISS') ? '#9e9e9e' : 'var(--text-color)';
                            const issueDate = v.violation_issue_date && v.violation_issue_date !== 'N/A' ? new Date(v.violation_issue_date).toLocaleDateString() : 'N/A';
                            const remarks = v.violation_remarks || 'No description';
                            const truncatedRemarks = remarks.length > 150 ? remarks.substring(0, 150) + '...' : remarks;
                            return `
                                <tr style="background: ${rowBg};">
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${v.violation_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; white-space: nowrap;">${issueDate}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${v.violation_severity}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${statusColor}; font-weight: 600;">${v.violation_status}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-size: 0.9em;" title="${remarks}">${truncatedRemarks}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="5" style="padding: 20px; text-align: center; opacity: 0.7;">No violations found</td></tr>';
                        
                        const tableHeader = `
                            <tr style="background: var(--panel-bg); position: sticky; top: 0; z-index: 1;">
                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Device #</th>
                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Type</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">PVI</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 1</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 5</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Next CAT5</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">${currentYear} Status</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Ready</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Eligible</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violations</th>
                            </tr>`;
                        
                        return `<div style="background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border); overflow: hidden;">
                            <div onclick="toggleBuildingGroup('${groupId}')" 
                                 style="padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: background 0.2s; border-left: 4px solid #ff6b6b;"
                                 onmouseover="this.style.background='var(--panel-bg)'" 
                                 onmouseout="this.style.background='var(--input-bg)'">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="font-size: 1.2em;">üè¢</span>
                                    <div>
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                            <strong style="font-size: 1.05em;">${b.address}</strong>
                                            <span style="opacity: 0.7; font-size: 0.9em;">(BIN: ${b.bin})</span>
                                        </div>
                                        <div style="font-size: 0.85em; opacity: 0.7; margin-top: 2px; display: flex; gap: 12px;">
                                            <span>${b.deviceCount} device${b.deviceCount !== 1 ? 's' : ''}</span>
                                            <span style="color: #ff6b6b; font-weight: 600;">${b.violationCount} violation${b.violationCount !== 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <span id="${groupId}_arrow" style="font-size: 1.2em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                            </div>
                            <div id="${groupId}" style="display: none; border-top: 1px solid var(--input-border);">
                                <!-- All Devices Table -->
                                <div style="padding: 10px 12px; background: var(--panel-bg); border-bottom: 1px solid var(--input-border);">
                                    <span style="font-weight: 600; font-size: 0.9em;">üìã All Devices (${b.deviceCount})</span>
                                </div>
                                <div style="max-height: 300px; overflow: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                        <thead>${tableHeader}</thead>
                                        <tbody>${deviceTableRows}</tbody>
                                    </table>
                                </div>
                                
                                <!-- Violation Details Dropdown -->
                                <div onclick="toggleViolationDetails('${violationsId}')" 
                                     style="padding: 10px 12px; background: var(--panel-bg); border-top: 1px solid var(--input-border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                                     onmouseover="this.style.background='var(--input-bg)'" 
                                     onmouseout="this.style.background='var(--panel-bg)'">
                                    <span style="font-weight: 600; font-size: 0.9em; color: #ff6b6b;">‚ö† View Violation Details (${b.violationCount})</span>
                                    <span id="${violationsId}_arrow" style="font-size: 1em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                                </div>
                                <div id="${violationsId}" style="display: none; border-top: 1px solid var(--input-border);">
                                    <div style="max-height: 250px; overflow: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                            <thead>
                                                <tr style="background: var(--panel-bg); position: sticky; top: 0; z-index: 1;">
                                                    <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violation #</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Issue Date</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Severity</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                                    <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border);">Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>${violationRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                },
                'buildingsWithViolations': {
                    title: 'üè¢ Buildings with Violations',
                    color: '#ff6b6b',
                    data: window.bulkDeviceLists.buildingsWithViolations || [],
                    groupByBuilding: false,
                    isBuildingList: true,
                    isExpandableBuildingList: true,
                    renderItem: (b, index) => {
                        const groupId = `buildingsWithViolationsGroup_${Date.now()}_${index}`;
                        const violationsId = `${groupId}_violations`;
                        const currentYear = new Date().getFullYear();
                        
                        const deviceTableRows = b.devices ? b.devices.map((d, idx) => {
                            const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                            return `
                                <tr style="background: ${rowBg};">
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${d.device_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${d.device_type}">${d.device_type}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.device_status}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasPVIThisYear ? '600' : '400'};">${d.pvi_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${d.hasCat1ThisYear ? '600' : '400'};">${d.cat1_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.hasCat5ThisYear ? '#4CAF50' : (d.requiresCat5 ? '#ff9800' : 'var(--text-color)')}; font-weight: ${d.hasCat5ThisYear || d.requiresCat5 ? '600' : '400'};">${d.cat5_date}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '#ff9800' : 'var(--text-color)'}; font-weight: ${d.nextCat5DueYear && d.nextCat5DueYear <= currentYear ? '600' : '400'};">${d.next_cat5}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.completionColor}; font-weight: 600;">${d.completionStatus}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.isReadyColor}; font-weight: 600;">${d.isReady}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${d.eligibleDate}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${d.violationCount > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${d.violationCount}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="11" style="padding: 20px; text-align: center; opacity: 0.7;">No devices found</td></tr>';
                        
                        // Generate violation details rows with device info
                        const violationRows = b.violationDetails ? b.violationDetails.map((v, idx) => {
                            const rowBg = idx % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                            const status = (v.violation_status || '').toUpperCase();
                            const statusColor = status.includes('ACTIVE') || status.includes('OPEN') ? '#ff6b6b' : 
                                               status.includes('CURED') || status.includes('CLOSED') ? '#4CAF50' : 
                                               status.includes('DISMISS') ? '#9e9e9e' : 'var(--text-color)';
                            const issueDate = v.violation_issue_date && v.violation_issue_date !== 'N/A' ? new Date(v.violation_issue_date).toLocaleDateString() : 'N/A';
                            const remarks = v.violation_remarks || 'No description';
                            const truncatedRemarks = remarks.length > 120 ? remarks.substring(0, 120) + '...' : remarks;
                            return `
                                <tr style="background: ${rowBg};">
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${v.device_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; white-space: nowrap;">${v.violation_number}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; white-space: nowrap;">${issueDate}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center;">${v.violation_severity}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${statusColor}; font-weight: 600;">${v.violation_status}</td>
                                    <td style="padding: 8px; border: 1px solid var(--input-border); font-size: 0.9em;" title="${remarks}">${truncatedRemarks}</td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="6" style="padding: 20px; text-align: center; opacity: 0.7;">No violations found</td></tr>';
                        
                        return `<div style="background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border); overflow: hidden;">
                            <div onclick="toggleBuildingGroup('${groupId}')" 
                                 style="padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: background 0.2s; border-left: 4px solid #ff6b6b;"
                                 onmouseover="this.style.background='var(--panel-bg)'" 
                                 onmouseout="this.style.background='var(--input-bg)'">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="font-size: 1.2em;">üè¢</span>
                                    <div>
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                            <strong style="font-size: 1.05em;">${b.address}</strong>
                                            <span style="opacity: 0.7; font-size: 0.9em;">(BIN: ${b.bin})</span>
                                        </div>
                                        <div style="font-size: 0.85em; opacity: 0.7; margin-top: 2px; display: flex; gap: 12px;">
                                            <span>${b.deviceCount} device${b.deviceCount !== 1 ? 's' : ''}</span>
                                            <span style="color: #ff6b6b; font-weight: 600;">${b.violationCount} violation${b.violationCount !== 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <span id="${groupId}_arrow" style="font-size: 1.2em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                            </div>
                            <div id="${groupId}" style="display: none; border-top: 1px solid var(--input-border);">
                                <!-- All Devices Table -->
                                <div style="padding: 10px 12px; background: var(--panel-bg); border-bottom: 1px solid var(--input-border);">
                                    <span style="font-weight: 600; font-size: 0.9em;">üìã All Devices (${b.deviceCount})</span>
                                </div>
                                <div style="max-height: 300px; overflow: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                        <thead>
                                            <tr style="background: var(--panel-bg); position: sticky; top: 0; z-index: 1;">
                                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Device #</th>
                                                <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Type</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">PVI</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 1</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 5</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Next CAT5</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">${new Date().getFullYear()} Status</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Ready</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Eligible</th>
                                                <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violations</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${deviceTableRows}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Violation Details Dropdown -->
                                <div onclick="toggleViolationDetails('${violationsId}')" 
                                     style="padding: 10px 12px; background: var(--panel-bg); border-top: 1px solid var(--input-border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;"
                                     onmouseover="this.style.background='var(--input-bg)'" 
                                     onmouseout="this.style.background='var(--panel-bg)'">
                                    <span style="font-weight: 600; font-size: 0.9em; color: #ff6b6b;">‚ö† View Violation Details (${b.violationCount})</span>
                                    <span id="${violationsId}_arrow" style="font-size: 1em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                                </div>
                                <div id="${violationsId}" style="display: none; border-top: 1px solid var(--input-border);">
                                    <div style="max-height: 250px; overflow: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                            <thead>
                                                <tr style="background: var(--panel-bg); position: sticky; top: 0; z-index: 1;">
                                                    <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Device #</th>
                                                    <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violation #</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Issue Date</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Severity</th>
                                                    <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                                    <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border);">Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>${violationRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                },
                'importantInfo': {
                    title: '‚ö†Ô∏è Important Information',
                    color: '#e91e63',
                    data: window.bulkDeviceLists.importantInfo || [],
                    groupByBuilding: true,
                    renderItem: (d) => {
                        const missedTests = d.missedTests || getMissedRequiredTests(d);
                        const hasMissedTests = missedTests.length > 0;
                        const hasAllDatesSame = d.allDatesAreSame;
                        
                        // Check for removal permits for this device
                        let hasRemovalPermit = false;
                        let removalPermitNumber = '';
                        const allPermits = window.bulkDeviceLists.permits || [];
                        const devicePermits = allPermits.filter(p => p.device_number === d.device_number);
                        if (devicePermits.length > 0) {
                            const removalPermit = devicePermits.find(p => {
                                const workType = (p.work_type || '').toUpperCase();
                                const description = (p.description || '').toUpperCase();
                                const appType = (p.application_type || '').toUpperCase();
                                return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                       workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                       description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                       description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                       appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                            });
                            if (removalPermit) {
                                hasRemovalPermit = true;
                                removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                            }
                        }
                        
                        let alertSections = '';
                        
                        // Data Quality Alert (all dates same)
                        if (hasAllDatesSame) {
                            alertSections += `
                                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255, 107, 107, 0.1); border-radius: 6px; border-left: 3px solid #ff6b6b;">
                                    <div style="font-weight: 600; color: #ff6b6b; margin-bottom: 6px;">‚ö†Ô∏è Data Quality Alert</div>
                                    <div style="font-size: 0.9em; color: var(--text-color); opacity: 0.9;">
                                        All three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate an acceptance test was performed on this device. If so, no additional inspection tests are required for that calendar year. Please verify with the official DOB site.
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Missed Tests Alert
                        if (hasMissedTests) {
                            // Group missed tests by test type for cleaner display
                            const groupedMissed = {};
                            missedTests.forEach(mt => {
                                if (!groupedMissed[mt.test]) {
                                    groupedMissed[mt.test] = { years: [], lastTestDate: mt.lastTestDate };
                                }
                                groupedMissed[mt.test].years.push(mt.year);
                            });
                            
                            // Count unique test types for the header
                            const uniqueTestTypes = Object.keys(groupedMissed).length;
                            
                            const missedTestsList = Object.keys(groupedMissed).map(test => {
                                const data = groupedMissed[test];
                                const sortedYears = data.years.sort((a, b) => b - a); // Sort most recent to oldest
                                return `<div style="margin-bottom: 6px; padding: 6px 8px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                    <strong style="color: #ff9800;">${test}</strong> missed in <strong>${sortedYears.join(', ')}</strong>
                                    <br><span style="font-size: 0.85em; opacity: 0.8;">Last ${test} test: ${data.lastTestDate}</span>
                                </div>`;
                            }).join('');
                            
                            // Add removal permit note if applicable
                            const removalPermitNote = (hasMissedTests && hasRemovalPermit) ? `
                                <div style="margin-top: 8px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                    <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                        üìã Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''}
                                    </div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">
                                        Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                    </div>
                                </div>
                            ` : '';
                            
                            alertSections += `
                                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; border-left: 3px solid #ff9800;">
                                    <div style="font-weight: 600; color: #ff9800; margin-bottom: 6px;">‚ö†Ô∏è Missed Required Test${uniqueTestTypes > 1 ? 's' : ''} (${uniqueTestTypes} test type${uniqueTestTypes > 1 ? 's' : ''})</div>
                                    ${missedTestsList}
                                    ${removalPermitNote}
                                </div>
                            `;
                        }
                        
                        return `<div style="padding: 12px; background: var(--panel-bg); border-radius: 6px; border-left: 3px solid #e91e63;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <strong style="color: var(--header-color);">${d.device_number}</strong>
                                    <span style="opacity: 0.7; margin-left: 8px; font-size: 0.9em;">${d.device_type}</span>
                                    ${d.isDismantled ? '<span style="color: #ffd700; font-weight: bold; margin-left: 8px;">[DISMANTLED]</span>' : ''}
                                </div>
                            </div>
                            ${alertSections}
                        </div>`;
                    }
                },
                'permits': {
                    title: 'üìã Associated Permits',
                    color: '#2196F3',
                    data: window.bulkDeviceLists.permits || [],
                    groupByBuilding: false,
                    isPermitList: true,
                    renderItem: (p, index) => {
                        const groupId = `permitsGroup_${Date.now()}_${index}`;
                        const issueDateStr = p.issuance_date ? new Date(p.issuance_date).toLocaleDateString() : 'N/A';
                        const expDateStr = p.expiration_date ? new Date(p.expiration_date).toLocaleDateString() : 'N/A';
                        const statusColor = (p.filing_status || '').toUpperCase().includes('APPROVED') ? '#4CAF50' : 
                                           (p.filing_status || '').toUpperCase().includes('PENDING') ? '#ff9800' : 
                                           (p.filing_status || '').toUpperCase().includes('DISAPPROVED') ? '#ff6b6b' : 'var(--text-color)';
                        
                        return `<div style="background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border); overflow: hidden; border-left: 3px solid #2196F3;">
                            <div onclick="toggleBuildingGroup('${groupId}')" 
                                 style="padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: background 0.2s;"
                                 onmouseover="this.style.background='var(--panel-bg)'" 
                                 onmouseout="this.style.background='var(--input-bg)'">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                        <span style="font-size: 1.1em;">üìã</span>
                                        <strong style="font-size: 1em; color: var(--header-color);">${p.permit_number || p.job_filing_number || 'N/A'}</strong>
                                        <span style="color: ${statusColor}; font-weight: 600; font-size: 0.9em;">${p.filing_status || 'N/A'}</span>
                                    </div>
                                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 4px; display: flex; flex-wrap: wrap; gap: 12px;">
                                        <span><strong>Device:</strong> ${p.device_number}</span>
                                        <span><strong>Address:</strong> ${p.address || 'N/A'}</span>
                                        <span><strong>Issued:</strong> ${issueDateStr}</span>
                                    </div>
                                </div>
                                <span id="${groupId}_arrow" style="font-size: 1.2em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                            </div>
                            <div id="${groupId}" style="display: none; border-top: 1px solid var(--input-border); padding: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9em;">
                                    <div><strong style="color: var(--header-color);">Permit #:</strong> ${p.permit_number || p.job_filing_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">BIN:</strong> ${p.bin || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Device #:</strong> ${p.device_number}</div>
                                    <div><strong style="color: var(--header-color);">Issued To:</strong> ${p.permittee_s_name || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Issue Date:</strong> ${issueDateStr}</div>
                                    <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${expDateStr}</div>
                                    <div><strong style="color: var(--header-color);">Application Type:</strong> ${p.application_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Work Type:</strong> ${p.work_type || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Filing Status:</strong> <span style="color: ${statusColor}; font-weight: 600;">${p.filing_status || 'N/A'}</span></div>
                                    ${p.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${p.business_name}</div>` : ''}
                                </div>
                                ${p.description ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--input-border);">
                                        <strong style="color: var(--header-color);">Description:</strong>
                                        <div style="margin-top: 6px; font-size: 0.9em; opacity: 0.9; line-height: 1.5;">${p.description}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>`;
                    }
                }
            };
            
            const config = listConfigs[listType];
            if (!config) return;
            
            // Set modal title with count and color - use appropriate label for item type
            let countLabel = 'devices';
            if (config.isBuildingList) countLabel = 'buildings';
            else if (config.isViolationList) countLabel = 'violations';
            else if (config.isPermitList) countLabel = 'permits';
            
            // For readyToTest and notReadyToTest, show both ready and not-ready counts
            let titleCountDisplay = `(${config.data.length} ${countLabel})`;
            if (config.showNotReadyAtTop || config.showReadyAtBottom) {
                const readyCount = config.data.filter(d => d.isReadyToTest).length;
                const notReadyCount = config.data.filter(d => !d.isReadyToTest).length;
                if (readyCount > 0 && notReadyCount > 0) {
                    titleCountDisplay = `(<span style="color: #ff6b6b;">${notReadyCount} not ready</span> + <span style="color: #4CAF50;">${readyCount} ready</span> in these buildings)`;
                } else if (notReadyCount > 0) {
                    titleCountDisplay = `(${notReadyCount} devices)`;
                } else {
                    titleCountDisplay = `(${readyCount} devices)`;
                }
            }
            modalTitle.innerHTML = `<span style="color: ${config.color};">${config.title}</span> <span style="font-size: 0.85em; opacity: 0.7;">${titleCountDisplay}</span>`;
            
            // Generate content
            if (config.data.length > 0) {
                // Check if we need to group by building
                if (config.groupByBuilding) {
                    // Group devices by building address
                    const buildingGroups = {};
                    config.data.forEach(device => {
                        const address = device.buildingAddress || device.address || 'Unknown Address';
                        if (!buildingGroups[address]) {
                            buildingGroups[address] = [];
                        }
                        buildingGroups[address].push(device);
                    });
                    
                    // Sort devices within each building and determine building sort order
                    let sortedBuildings;
                    if (config.sortByEligibleDate && config.showReadyAtBottom) {
                        // For Not Ready Yet: Sort devices with not-ready first (by eligible date), then ready at bottom
                        Object.keys(buildingGroups).forEach(address => {
                            buildingGroups[address].sort((a, b) => {
                                // Not ready devices should come first
                                if (!a.isReadyToTest && b.isReadyToTest) return -1;
                                if (a.isReadyToTest && !b.isReadyToTest) return 1;
                                // Among not-ready devices, sort by eligible date (soonest first)
                                if (!a.isReadyToTest && !b.isReadyToTest) {
                                    const dateA = a.eligibleTestDate ? a.eligibleTestDate.getTime() : Infinity;
                                    const dateB = b.eligibleTestDate ? b.eligibleTestDate.getTime() : Infinity;
                                    return dateA - dateB;
                                }
                                return 0;
                            });
                        });
                        
                        // Sort buildings: buildings with ready devices first, then by earliest eligible date
                        sortedBuildings = Object.entries(buildingGroups).sort((a, b) => {
                            const readyA = a[1].filter(d => d.isReadyToTest).length;
                            const readyB = b[1].filter(d => d.isReadyToTest).length;
                            // Buildings with ready devices come first
                            if (readyA > 0 && readyB === 0) return -1;
                            if (readyA === 0 && readyB > 0) return 1;
                            // Then sort by earliest eligible date for not-ready devices
                            const notReadyA = a[1].filter(d => !d.isReadyToTest);
                            const notReadyB = b[1].filter(d => !d.isReadyToTest);
                            const earliestA = notReadyA[0]?.eligibleTestDate ? notReadyA[0].eligibleTestDate.getTime() : Infinity;
                            const earliestB = notReadyB[0]?.eligibleTestDate ? notReadyB[0].eligibleTestDate.getTime() : Infinity;
                            return earliestA - earliestB;
                        });
                    } else if (config.sortByEligibleDate) {
                        // Sort devices within each building by eligible date (soonest first)
                        Object.keys(buildingGroups).forEach(address => {
                            buildingGroups[address].sort((a, b) => {
                                const dateA = a.eligibleTestDate ? a.eligibleTestDate.getTime() : Infinity;
                                const dateB = b.eligibleTestDate ? b.eligibleTestDate.getTime() : Infinity;
                                return dateA - dateB;
                            });
                        });
                        
                        // Sort buildings by their earliest device eligible date (soonest first)
                        sortedBuildings = Object.entries(buildingGroups).sort((a, b) => {
                            const earliestA = a[1][0]?.eligibleTestDate ? a[1][0].eligibleTestDate.getTime() : Infinity;
                            const earliestB = b[1][0]?.eligibleTestDate ? b[1][0].eligibleTestDate.getTime() : Infinity;
                            return earliestA - earliestB;
                        });
                    } else if (config.showNotReadyAtTop) {
                        // Sort devices: not-ready devices first (sorted by eligible date), then ready devices
                        Object.keys(buildingGroups).forEach(address => {
                            buildingGroups[address].sort((a, b) => {
                                // Not ready devices should come first
                                if (!a.isReadyToTest && b.isReadyToTest) return -1;
                                if (a.isReadyToTest && !b.isReadyToTest) return 1;
                                // Among not-ready devices, sort by eligible date (soonest first)
                                if (!a.isReadyToTest && !b.isReadyToTest) {
                                    const dateA = a.eligibleTestDate ? a.eligibleTestDate.getTime() : Infinity;
                                    const dateB = b.eligibleTestDate ? b.eligibleTestDate.getTime() : Infinity;
                                    return dateA - dateB;
                                }
                                return 0;
                            });
                        });
                        // Sort buildings: buildings with not-ready devices first, then by earliest eligible date
                        sortedBuildings = Object.entries(buildingGroups).sort((a, b) => {
                            const notReadyA = a[1].filter(d => !d.isReadyToTest).length;
                            const notReadyB = b[1].filter(d => !d.isReadyToTest).length;
                            // Buildings with not-ready devices come first
                            if (notReadyA > 0 && notReadyB === 0) return -1;
                            if (notReadyA === 0 && notReadyB > 0) return 1;
                            // Among buildings with not-ready devices, sort by earliest eligible date
                            if (notReadyA > 0 && notReadyB > 0) {
                                const earliestA = a[1].find(d => !d.isReadyToTest)?.eligibleTestDate?.getTime() || Infinity;
                                const earliestB = b[1].find(d => !d.isReadyToTest)?.eligibleTestDate?.getTime() || Infinity;
                                return earliestA - earliestB;
                            }
                            // Among all-ready buildings, sort by device count (most first)
                            return b[1].length - a[1].length;
                        });
                    } else {
                        // Default: Sort buildings by number of devices (most first)
                        sortedBuildings = Object.entries(buildingGroups).sort((a, b) => b[1].length - a[1].length);
                    }
                    
                    // Generate unique IDs for this modal session
                    const modalSessionId = Date.now();
                    
                    // Calculate counts for filter display
                    let filterHTML = '';
                    if (config.showNotReadyAtTop) {
                        const buildingsWithNotReady = sortedBuildings.filter(([addr, devs]) => devs.some(d => !d.isReadyToTest)).length;
                        const buildingsAllReady = sortedBuildings.filter(([addr, devs]) => devs.every(d => d.isReadyToTest)).length;
                        filterHTML = `
                            <div style="margin-bottom: 15px; padding: 12px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <label style="font-weight: 600; color: var(--header-color);">Filter Buildings:</label>
                                    <select id="readyToTestBuildingFilter" onchange="filterReadyToTestBuildings(this.value)" 
                                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; cursor: pointer;">
                                        <option value="all">All Buildings (${sortedBuildings.length})</option>
                                        <option value="has-not-ready">Has Not Ready Devices (${buildingsWithNotReady})</option>
                                        <option value="all-ready">All Devices Ready (${buildingsAllReady})</option>
                                    </select>
                                    <span id="readyToTestFilterCount" style="font-size: 0.9em; color: var(--text-color); opacity: 0.7;"></span>
                                </div>
                            </div>
                        `;
                    } else if (config.showReadyAtBottom) {
                        const buildingsWithReady = sortedBuildings.filter(([addr, devs]) => devs.some(d => d.isReadyToTest)).length;
                        const buildingsAllNotReady = sortedBuildings.filter(([addr, devs]) => devs.every(d => !d.isReadyToTest)).length;
                        filterHTML = `
                            <div style="margin-bottom: 15px; padding: 12px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <label style="font-weight: 600; color: var(--header-color);">Filter Buildings:</label>
                                    <select id="readyToTestBuildingFilter" onchange="filterReadyToTestBuildings(this.value)" 
                                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; cursor: pointer;">
                                        <option value="all">All Buildings (${sortedBuildings.length})</option>
                                        <option value="has-ready">Has Ready Devices (${buildingsWithReady})</option>
                                        <option value="all-not-ready">All Devices Not Ready (${buildingsAllNotReady})</option>
                                    </select>
                                    <span id="readyToTestFilterCount" style="font-size: 0.9em; color: var(--text-color); opacity: 0.7;"></span>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add search box for grouped building lists
                    const searchBoxHTML = `
                        <div style="margin-bottom: 15px;">
                            <input type="text" 
                                   id="groupedBuildingSearch" 
                                   placeholder="Search by address or device number..." 
                                   oninput="filterGroupedBuildingItems(this.value)"
                                   style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; box-sizing: border-box;">
                            <div id="groupedBuildingSearchCount" style="font-size: 0.85em; color: var(--text-color); opacity: 0.7; margin-top: 6px;"></div>
                        </div>
                    `;
                    
                    modalContent.innerHTML = `
                        ${searchBoxHTML}
                        ${filterHTML}
                        <div id="readyToTestBuildingsList" style="display: flex; flex-direction: column; gap: 12px;">
                            ${sortedBuildings.map(([address, devices], index) => {
                                const groupId = `buildingGroup_${modalSessionId}_${index}`;
                                const hasNotReady = devices.some(d => !d.isReadyToTest);
                                const isAllReady = devices.every(d => d.isReadyToTest);
                                
                                // Get earliest eligible date for this building (for sortByEligibleDate display)
                                let earliestDateDisplay = '';
                                if (config.sortByEligibleDate && devices[0]?.eligibleTestDate) {
                                    const earliestDate = devices[0].eligibleTestDate;
                                    const dateStr = earliestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    const daysUntil = devices[0].daysUntilEligible;
                                    const daysText = daysUntil === 1 ? '1 day' : `${daysUntil} days`;
                                    earliestDateDisplay = `<span style="font-size: 0.85em; color: #ff6b6b; margin-left: 8px;">‚è≥ Next eligible: ${dateStr} (${daysText})</span>`;
                                }
                                
                                // For showNotReadyAtTop or showReadyAtBottom, show earliest not-ready device date
                                if ((config.showNotReadyAtTop || config.showReadyAtBottom) && hasNotReady) {
                                    const notReadyDevices = devices.filter(d => !d.isReadyToTest);
                                    if (notReadyDevices[0]?.eligibleTestDate) {
                                        const earliestDate = notReadyDevices[0].eligibleTestDate;
                                        const dateStr = earliestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                        const daysUntil = notReadyDevices[0].daysUntilEligible;
                                        const daysText = daysUntil === 1 ? '1 day' : `${daysUntil} days`;
                                        earliestDateDisplay = `<span style="font-size: 0.85em; color: #ff6b6b; margin-left: 8px;">‚è≥ Next eligible: ${dateStr} (${daysText})</span>`;
                                    }
                                }
                                
                                // Calculate device count display - show breakdown for showNotReadyAtTop and showReadyAtBottom lists
                                let deviceCountDisplay = `${devices.length} device${devices.length !== 1 ? 's' : ''}`;
                                if (config.showNotReadyAtTop || config.showReadyAtBottom) {
                                    const readyCount = devices.filter(d => d.isReadyToTest).length;
                                    const notReadyCount = devices.filter(d => !d.isReadyToTest).length;
                                    deviceCountDisplay = `<strong>Total Devices:</strong> ${devices.length}`;
                                    if (readyCount > 0 && notReadyCount > 0) {
                                        deviceCountDisplay += ` <span style="margin-left: 8px;">(<span style="color: #ff6b6b;">${notReadyCount} not ready</span>, <span style="color: #4CAF50;">${readyCount} ready</span>)</span>`;
                                    }
                                }
                                
                                const hasReady = devices.some(d => d.isReadyToTest);
                                const isAllNotReady = devices.every(d => !d.isReadyToTest);
                                
                                // Collect all device numbers for search
                                const deviceNumbers = devices.map(d => d.device_number).join(' ');
                                
                                return `
                                    <div class="ready-to-test-building-item" data-has-not-ready="${hasNotReady}" data-is-all-ready="${isAllReady}" data-has-ready="${hasReady}" data-is-all-not-ready="${isAllNotReady}" data-address="${address}" data-devices="${deviceNumbers}" style="background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border); overflow: hidden;">
                                        <div onclick="toggleBuildingGroup('${groupId}')" 
                                             style="padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: background 0.2s;"
                                             onmouseover="this.style.background='var(--panel-bg)'" 
                                             onmouseout="this.style.background='var(--input-bg)'">
                                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                                <span style="font-size: 1.2em;">üìç</span>
                                                <div>
                                                    <div style="display: flex; align-items: center; flex-wrap: wrap;">
                                                        <strong style="font-size: 1.05em; color: ${config.color};">${address}</strong>
                                                        ${earliestDateDisplay}
                                                    </div>
                                                    <div style="font-size: 0.85em; opacity: 0.7; margin-top: 2px;">${deviceCountDisplay}</div>
                                                </div>
                                            </div>
                                            <span id="${groupId}_arrow" style="font-size: 1.2em; transition: transform 0.3s; transform: rotate(0deg);">‚ñº</span>
                                        </div>
                                        <div id="${groupId}" style="display: none; padding: 12px; border-top: 1px solid var(--input-border);">
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${devices.map(config.renderItem).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // For expandable building lists or permit lists, use single column layout and pass index
                    if (config.isExpandableBuildingList || config.isPermitList) {
                        const searchPlaceholder = config.isPermitList 
                            ? "Search by permit number, device number, or address..." 
                            : "Search by address, BIN, or device number...";
                        modalContent.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <input type="text" 
                                       id="buildingModalSearch" 
                                       placeholder="${searchPlaceholder}" 
                                       oninput="filterBuildingModalItems(this.value)"
                                       style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; box-sizing: border-box;">
                                <div id="buildingSearchCount" style="font-size: 0.85em; color: var(--text-color); opacity: 0.7; margin-top: 6px;"></div>
                            </div>
                            <div id="buildingModalList" style="display: flex; flex-direction: column; gap: 12px;">
                                ${config.data.map((item, index) => {
                                    // For permits, use permit-specific data attributes
                                    if (config.isPermitList) {
                                        return `<div class="building-modal-item" data-address="${item.address || ''}" data-bin="${item.bin || ''}" data-devices="${item.device_number || ''}" data-permit="${item.permit_number || item.job_filing_number || ''}">
                                            ${config.renderItem(item, index)}
                                        </div>`;
                                    }
                                    const deviceNumbers = item.devices ? item.devices.map(d => d.device_number).join(' ') : '';
                                    return `<div class="building-modal-item" data-address="${item.address}" data-bin="${item.bin}" data-devices="${deviceNumbers}">
                                        ${config.renderItem(item, index)}
                                    </div>`;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        modalContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 12px;">
                                ${config.data.map(config.renderItem).join('')}
                            </div>
                        `;
                    }
                }
            } else {
                let emptyLabel = 'devices';
                if (config.isBuildingList) emptyLabel = 'buildings';
                else if (config.isViolationList) emptyLabel = 'violations';
                modalContent.innerHTML = `<div style="text-align: center; padding: 40px; opacity: 0.7;">No ${emptyLabel} in this category</div>`;
            }
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Toggle building group in modal
        function toggleBuildingGroup(groupId) {
            const content = document.getElementById(groupId);
            const arrow = document.getElementById(groupId + '_arrow');
            if (content && arrow) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }
        
        // Filter buildings in Ready to Test / Not Ready Yet modals
        function filterReadyToTestBuildings(filterValue) {
            const buildingItems = document.querySelectorAll('.ready-to-test-building-item');
            const countDisplay = document.getElementById('readyToTestFilterCount');
            const searchInput = document.getElementById('groupedBuildingSearch');
            const searchTerm = searchInput ? searchInput.value.toUpperCase().trim() : '';
            
            let visibleCount = 0;
            
            buildingItems.forEach(item => {
                const hasNotReady = item.getAttribute('data-has-not-ready') === 'true';
                const isAllReady = item.getAttribute('data-is-all-ready') === 'true';
                const hasReady = item.getAttribute('data-has-ready') === 'true';
                const isAllNotReady = item.getAttribute('data-is-all-not-ready') === 'true';
                
                // Check dropdown filter
                let dropdownMatches = false;
                if (filterValue === 'all') {
                    dropdownMatches = true;
                } else if (filterValue === 'has-not-ready') {
                    dropdownMatches = hasNotReady;
                } else if (filterValue === 'all-ready') {
                    dropdownMatches = isAllReady;
                } else if (filterValue === 'has-ready') {
                    dropdownMatches = hasReady;
                } else if (filterValue === 'all-not-ready') {
                    dropdownMatches = isAllNotReady;
                }
                
                // Check search filter
                const address = (item.dataset.address || '').toUpperCase();
                const devices = (item.dataset.devices || '').toUpperCase();
                const searchMatches = searchTerm === '' || 
                                     address.includes(searchTerm) || 
                                     devices.includes(searchTerm);
                
                const shouldShow = dropdownMatches && searchMatches;
                
                if (shouldShow) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update count display
            if (countDisplay) {
                if (filterValue !== 'all') {
                    countDisplay.textContent = `Showing ${visibleCount} building${visibleCount !== 1 ? 's' : ''}`;
                } else {
                    countDisplay.textContent = '';
                }
            }
        }
        
        // Toggle all devices view in Total Violations modal
        function toggleAllDevicesView(allDevicesId, button) {
            const allDevicesSection = document.getElementById(allDevicesId);
            if (allDevicesSection) {
                if (allDevicesSection.style.display === 'none') {
                    allDevicesSection.style.display = 'block';
                    button.textContent = button.textContent.replace('Show', 'Hide');
                    button.style.background = '#ff6b6b';
                } else {
                    allDevicesSection.style.display = 'none';
                    button.textContent = button.textContent.replace('Hide', 'Show');
                    button.style.background = 'var(--header-color)';
                }
            }
        }
        
        // Toggle violation details dropdown
        function toggleViolationDetails(violationsId) {
            const content = document.getElementById(violationsId);
            const arrow = document.getElementById(violationsId + '_arrow');
            if (content && arrow) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }
        
        // Filter buildings in the modal
        function filterBuildingModalItems(searchTerm) {
            const term = searchTerm.toUpperCase().trim();
            const items = document.querySelectorAll('.building-modal-item');
            const countEl = document.getElementById('buildingSearchCount');
            let visibleCount = 0;
            const totalCount = items.length;
            
            // Check if this is a permit list by looking for permit data attribute
            const hasPermits = items.length > 0 && items[0].dataset.permit !== undefined;
            
            items.forEach(item => {
                const address = (item.dataset.address || '').toUpperCase();
                const bin = (item.dataset.bin || '').toUpperCase();
                const devices = (item.dataset.devices || '').toUpperCase();
                const permit = (item.dataset.permit || '').toUpperCase();
                
                const matches = term === '' || 
                               address.includes(term) || 
                               bin.includes(term) || 
                               devices.includes(term) ||
                               permit.includes(term);
                
                item.style.display = matches ? '' : 'none';
                if (matches) visibleCount++;
            });
            
            // Update count display
            if (countEl) {
                if (term === '') {
                    countEl.textContent = '';
                } else {
                    const itemType = hasPermits ? 'permit' : 'building';
                    countEl.textContent = `Showing ${visibleCount} of ${totalCount} ${itemType}${totalCount !== 1 ? 's' : ''}`;
                }
            }
        }
        
        // Filter grouped building items (for Test Completion Status, Testing Status, and Important Info modals)
        function filterGroupedBuildingItems(searchTerm) {
            const term = searchTerm.toUpperCase().trim();
            const items = document.querySelectorAll('.ready-to-test-building-item');
            const countEl = document.getElementById('groupedBuildingSearchCount');
            const dropdownFilter = document.getElementById('readyToTestBuildingFilter');
            const dropdownValue = dropdownFilter ? dropdownFilter.value : 'all';
            
            let visibleCount = 0;
            const totalCount = items.length;
            
            items.forEach(item => {
                const address = (item.dataset.address || '').toUpperCase();
                const devices = (item.dataset.devices || '').toUpperCase();
                
                // Check search match
                const searchMatches = term === '' || 
                               address.includes(term) || 
                               devices.includes(term);
                
                // Check dropdown filter match
                const hasNotReady = item.getAttribute('data-has-not-ready') === 'true';
                const isAllReady = item.getAttribute('data-is-all-ready') === 'true';
                const hasReady = item.getAttribute('data-has-ready') === 'true';
                const isAllNotReady = item.getAttribute('data-is-all-not-ready') === 'true';
                
                let dropdownMatches = true;
                if (dropdownValue === 'has-not-ready') {
                    dropdownMatches = hasNotReady;
                } else if (dropdownValue === 'all-ready') {
                    dropdownMatches = isAllReady;
                } else if (dropdownValue === 'has-ready') {
                    dropdownMatches = hasReady;
                } else if (dropdownValue === 'all-not-ready') {
                    dropdownMatches = isAllNotReady;
                }
                
                const shouldShow = searchMatches && dropdownMatches;
                item.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Update count display
            if (countEl) {
                if (term === '') {
                    countEl.textContent = '';
                } else {
                    countEl.textContent = `Showing ${visibleCount} of ${totalCount} building${totalCount !== 1 ? 's' : ''}`;
                }
            }
        }

        // Close bulk device list modal
        function closeBulkDeviceListModal() {
            const modal = document.getElementById('bulkDeviceListModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('bulkDeviceListModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeBulkDeviceListModal();
                    }
                });
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBulkDeviceListModal();
            }
        });

        // Filter function for bulk results search
        function filterBulkResults(searchTerm) {
            const term = searchTerm.toUpperCase().trim();
            
            // Filter summary table rows
            const summaryRows = document.querySelectorAll('.summary-row');
            summaryRows.forEach(row => {
                const bin = row.dataset.bin || '';
                const address = row.dataset.address || '';
                const devices = row.dataset.devices || '';
                
                const matches = bin.toUpperCase().includes(term) || 
                               address.toUpperCase().includes(term) || 
                               devices.toUpperCase().includes(term);
                
                row.style.display = matches ? '' : 'none';
            });
            
            // Filter building cards
            const buildingCards = document.querySelectorAll('.building-card');
            buildingCards.forEach(card => {
                const bin = card.dataset.bin || '';
                const address = card.dataset.address || '';
                const devices = card.dataset.devices || '';
                
                const matches = bin.toUpperCase().includes(term) || 
                               address.toUpperCase().includes(term) || 
                               devices.toUpperCase().includes(term);
                
                card.style.display = matches ? '' : 'none';
            });
        }

        // Add this new function to handle the device details dropdown toggle
        function toggleDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            const button = document.getElementById(`detailsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (detailsElement.style.display === 'none') {
                // Fetch additional device details if not already loaded
                if (detailsElement.getAttribute('data-loaded') !== 'true') {
                    fetchDeviceDetails(deviceNumber);
                }
                detailsElement.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                if (buttonText) {
                    buttonText.textContent = 'Hide Details';
                }
            } else {
                detailsElement.style.display = 'none';
                arrow.textContent = '‚ñº';
                if (buttonText) {
                    buttonText.textContent = 'Show Details';
                }
            }
        }

        // Function to fetch additional device details
        async function fetchDeviceDetails(deviceNumber) {
            const detailsElement = document.getElementById(`details_${deviceNumber}`);
            detailsElement.innerHTML = '<span style="color: var(--text-color);">Loading details...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    
                    // Get inspection dates directly from the device data
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Get recent inspections if available
                    let inspectionHistory = '';
                    try {
                        const inspResponse = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                        if (inspResponse.ok) {
                            const inspData = await inspResponse.json();
                            if (inspData && inspData.length > 0) {
                                // Sort inspections by date (newest first)
                                const inspections = inspData.filter(insp => insp.inspection_date);
                                inspections.sort((a, b) => {
                                    return new Date(b.inspection_date) - new Date(a.inspection_date);
                                });
                                
                                // Get the most recent inspections
                                const recentInspections = inspections.slice(0, 5);
                                
                                if (recentInspections.length > 0) {
                                    inspectionHistory = `
                                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Recent Inspections:</strong>
                                            ${recentInspections.map(insp => `
                                                <div style="margin-bottom: 8px; padding: 5px; background: var(--input-bg); border-radius: 4px;">
                                                    <div><strong style="color: var(--header-color);">Date:</strong> ${insp.inspection_date ? new Date(insp.inspection_date).toLocaleDateString() : 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Type:</strong> ${insp.inspection_type || 'N/A'}</div>
                                                    <div><strong style="color: var(--header-color);">Result:</strong> ${insp.inspection_result || 'N/A'}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching inspection history:', error);
                    }
                    
                    // Fetch permit information for this BIN
                    let permitInfo = '';
                    try {
                        if (binNumber) {
                            const permitResponse = await fetch(`https://data.cityofnewyork.us/resource/ipu4-2q9a.json?bin=${binNumber}`);
                            if (permitResponse.ok) {
                                const permitData = await permitResponse.json();
                                if (permitData && permitData.length > 0) {
                                    // Sort permits by issue date (newest first)
                                    const permits = permitData.filter(permit => permit.issuance_date);
                                    permits.sort((a, b) => {
                                        return new Date(b.issuance_date) - new Date(a.issuance_date);
                                    });
                                    
                                    // Get the most recent permits
                                    const recentPermits = permits.slice(0, 5);
                                    
                                    if (recentPermits.length > 0) {
                                        permitInfo = `
                                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                                                <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Permit Information:</strong>
                                                ${recentPermits.map(permit => `
                                                    <div style="margin-bottom: 12px; padding: 8px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border);">
                                                        <div><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Issue Date:</strong> ${permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Expiration Date:</strong> ${permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                                        <div><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                                        ${permit.business_name ? `<div><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching permit information:', error);
                    }
                    
                    let html = `
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Device Type:</strong> ${device.device_type || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Borough:</strong> ${device.borough || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Block:</strong> ${device.block || 'N/A'}
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong style="color: var(--header-color);">Lot:</strong> ${device.lot || 'N/A'}
                        </div>
                        ${device.house_number && device.street_name ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Address:</strong> ${device.house_number} ${device.street_name}
                            </div>
                        ` : ''}
                        ${device.bin ? `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">BIN:</strong> ${device.bin}
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 10px;">
                            <strong style="color: var(--header-color); display: block; margin-bottom: 8px;">Inspection Dates:</strong>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 1:</strong> <span style="${dateStyle}">${cat1Display}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest CAT 5:</strong> <span style="${dateStyle}">${cat5Display}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest PVI:</strong> <span style="${dateStyle}">${pviDisplay}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong style="color: var(--header-color);">Latest Inspection:</strong> <span style="${dateStyle}">${mostRecentDisplay}</span>
                                ${mostRecentDate ? 
                                    ` <span style="color: var(--text-muted); font-size: 0.9em;">
                                        (from ${
                                            mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                            mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                            'PVI'
                                        })
                                    </span>` : 
                                    ''}
                            </div>
                            ${daysSinceInspection !== null ? 
                                `<div style="margin-bottom: 5px;">
                                    <strong style="color: var(--header-color);">Days Since Last Inspection:</strong> 
                                    <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                        ${daysSinceInspection} days
                                    </span>
                                </div>` : 
                                ''}
                        </div>
                        ${permitInfo}
                        ${inspectionHistory}
                    `;
                    
                    detailsElement.innerHTML = html;
                    detailsElement.setAttribute('data-loaded', 'true');
                } else {
                    detailsElement.innerHTML = '<span style="color: var(--text-color);">No additional details found</span>';
                }
            } catch (error) {
                detailsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading details</span>';
                console.error('Error fetching device details:', error);
            }
        }

        // Add this new function to handle the violations dropdown toggle
        function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (violationsDiv.innerHTML.trim() === '') {
                    fetchViolations(deviceNumber);
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = '‚ñº';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Function to fetch violations for a device
        async function fetchViolations(deviceNumber) {
            const violationsElement = document.getElementById(`violations_${deviceNumber}`);
            violationsElement.innerHTML = '<span style="color: var(--text-color);">Loading violations...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/rzpd-6qkc.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Filter for active violations
                    const activeViolations = data.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    if (activeViolations.length > 0) {
                        let html = '';
                        activeViolations.forEach(v => {
                            html += `
                                <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                    <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Status:</strong> ${v.violation_status || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Date:</strong> ${v.violation_date ? new Date(v.violation_date).toLocaleDateString() : 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category || 'N/A'}</div>
                                    <div><strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}</div>
                                </div>
                            `;
                        });
                        violationsElement.innerHTML = html;
                    } else {
                        violationsElement.innerHTML = '<span style="color: var(--text-color);">No active violations found</span>';
                    }
                } else {
                    violationsElement.innerHTML = '<span style="color: var(--text-color);">No violations found</span>';
                }
            } catch (error) {
                violationsElement.innerHTML = '<span style="color: #ff6b6b;">Error loading violations</span>';
                console.error('Error fetching violations:', error);
            }

        }

        // Add event listener for Enter key
        document.getElementById('deviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupBIN();
            }
        });

        // Add input event listener for device number
        document.getElementById('deviceNumber').addEventListener('input', function(e) {
            const deviceNumber = e.target.value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
            
            // Toggle address search visibility based on device number field
            toggleAddressSearchVisibility(deviceNumber);
        });

        // Function to hide/show address search based on device number input
        function toggleAddressSearchVisibility(deviceNumber) {
            const addressSearchSection = document.getElementById('addressSearchSection');
            
            if (deviceNumber && deviceNumber.length > 0) {
                // Hide address search when device number has content
                if (addressSearchSection) {
                    addressSearchSection.style.display = 'none';
                }
            } else {
                // Show address search when device number is empty
                if (addressSearchSection) {
                    addressSearchSection.style.display = 'block';
                }
            }
        }

        // Add input event listener for BIN number
        document.getElementById('binNumber').addEventListener('input', function(e) {
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = e.target.value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        });

        // Add the new lookupDevices function
        async function lookupDevices() {
            const binNumber = document.getElementById('binNumber').value.trim();
            const resultDiv = document.getElementById('deviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            // Show progress bar
            resultDiv.innerHTML = `
                <div id="binProgressContainer" style="padding: 20px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                    <div style="margin-bottom: 15px; text-align: center;">
                        <span id="binProgressText" style="color: var(--text-color); font-weight: 500; font-size: 1.1em;">
                            Fetching devices for BIN ${binNumber}...
                        </span>
                    </div>
                    <div style="background: var(--panel-bg); border-radius: 10px; height: 24px; overflow: hidden; border: 1px solid var(--input-border);">
                        <div id="binProgressBar" style="background: linear-gradient(90deg, #1a73e8, #4CAF50); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <span id="binProgressStatus" style="color: var(--text-color); font-size: 0.9em; opacity: 0.8;">
                            Step 1 of 3: Retrieving device list...
                        </span>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';

            // Helper function to update BIN lookup progress
            function updateBinProgress(percentage, statusText, progressText) {
                const progressBar = document.getElementById('binProgressBar');
                const progressStatus = document.getElementById('binProgressStatus');
                const progressTextEl = document.getElementById('binProgressText');
                
                if (progressBar) progressBar.style.width = percentage + '%';
                if (progressStatus) progressStatus.textContent = statusText;
                if (progressTextEl && progressText) progressTextEl.textContent = progressText;
            }

            try {
                // Step 1: Fetch device list (0-33%)
                updateBinProgress(10, 'Step 1 of 3: Retrieving device list...', `Fetching devices for BIN ${binNumber}...`);
                
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                updateBinProgress(33, 'Step 1 of 3: Device list retrieved', `Found ${data.length} device(s)...`);
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    // Step 2: Fetch violations (33-66%)
                    updateBinProgress(40, 'Step 2 of 3: Fetching violation data...', `Loading violations for ${data.length} device(s)...`);
                    
                    // Fetch violations for all devices in this BIN
                    const violationsByDevice = await fetchViolationsForBin(binNumber);
                    
                    updateBinProgress(66, 'Step 2 of 3: Violations loaded', 'Processing device data...');
                    
                    // Step 3: Generate results (66-100%)
                    updateBinProgress(75, 'Step 3 of 3: Generating results...', 'Building device information...');
                    window.violationsByDevice = violationsByDevice; // Store for later use
                    
                    // Calculate total active violations - only for devices in the current device list
                    let totalActiveViolations = 0;
                    const deviceNumbersInBin = new Set(data.map(d => d.device_number));
                    for (const deviceNum in violationsByDevice) {
                        // Only count violations for devices that are in the current device list
                        if (deviceNumbersInBin.has(deviceNum)) {
                            const deviceViolations = violationsByDevice[deviceNum];
                            const activeDeviceViolations = deviceViolations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            totalActiveViolations += activeDeviceViolations.length;
                        }
                    }
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices (DELETED is treated as REMOVED)
                    const removedDevices = data.filter(device => 
                        device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED')
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DELETED' &&
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Calculate test eligibility counts
                    const currentYearForEligibility = new Date().getFullYear();
                    const todayForEligibility = new Date();
                    
                    // Calculate eligible devices and break down by completion status
                    // Completed devices should NOT count toward Ready count
                    let eligibleDevices = 0; // Only non-completed eligible devices
                    let eligibleCompletedDevices = 0;
                    
                    data.forEach(device => {
                        // Skip removed/deleted devices as they don't need testing
                        if (device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED')) {
                            return;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        // Check if device is completed for the year
                        const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                        const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                        const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYearForEligibility;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYearForEligibility;
                        
                        // Check if CAT 5 is required (Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing)
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                            const yearsSinceCat5 = currentYearForEligibility - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        } else {
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYearForEligibility) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYearForEligibility);
                        }
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        // CAT 1 is ALWAYS required for completion, plus CAT 5 if required
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        const bothTestsCompleted = hasPVIThisYear && hasCat1ThisYear && (!requiresCat5 || hasCat5ThisYear);
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        // Check if this is a warning device (CAT 1 & PVI done but CAT 5 required and not done)
                        const isWarningDevice = requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Check if device is completed FIRST - if completed, count as Completed regardless of eligibility
                        if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            const relevantDate = isDismantled ? pviDate : mostRecentDate;
                            const testYear = relevantDate ? relevantDate.getFullYear() : null;
                            
                            if (testYear === currentYearForEligibility && todayForEligibility.getFullYear() === currentYearForEligibility) {
                                // Device is completed - count as completed but NOT as ready (regardless of eligibility)
                                eligibleCompletedDevices++;
                            }
                        } else if (!isWarningDevice) {
                            // Device is not completed - check eligibility for Ready/Not Ready
                            let isEligible = isEligibleForTesting(mostRecentDate);
                            
                            if (isEligible) {
                                // Device is eligible but not completed - count as ready
                                eligibleDevices++;
                            }
                        }
                    });
                    
                    const notEligibleDevices = data.filter(device => {
                        // Skip removed/deleted devices as they don't need testing
                        if (device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED')) {
                            return false;
                        }
                        
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        
                        // Find most recent date
                        const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                        
                        // Check if device is eligible based on 91-day rule
                        let isEligible = isEligibleForTesting(mostRecentDate);
                        
                        // Check if this is a warning device (CAT 1 & PVI done but CAT 5 required and not done)
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                        const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                        const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYearForEligibility;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYearForEligibility;
                        
                        // Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                            const yearsSinceCat5 = currentYearForEligibility - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        } else {
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYearForEligibility) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYearForEligibility);
                        }
                        
                        // CAT 1 is ALWAYS required for completion, plus CAT 5 if required
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYearForEligibility;
                        const isWarningDevice = requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Check if device is completed
                        const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = hasPVIThisYear && hasCat1ThisYear && (!requiresCat5 || hasCat5ThisYear);
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        // Exclude completed devices from Not Ready count - they're in Completed section
                        if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            const relevantDate = isDismantled ? pviDate : mostRecentDate;
                            const testYear = relevantDate ? relevantDate.getFullYear() : null;
                            
                            if (testYear === currentYearForEligibility && todayForEligibility.getFullYear() === currentYearForEligibility) {
                                return false; // Device is completed - don't count as Not Ready
                            }
                        }
                        
                        // Exclude warning devices from Not Ready count - they're in Warning section
                        if (isWarningDevice) {
                            return false;
                        }
                        
                        return !isEligible;
                    }).length;

                    // Separate devices into active and removed (DELETED is treated as REMOVED)
                    const activeDevicesData = data.filter(device => 
                        !device.device_status || (device.device_status.toUpperCase() !== 'REMOVED' && device.device_status.toUpperCase() !== 'DELETED')
                    );
                    const removedDevicesData = data.filter(device => 
                        device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED')
                    );

                    // Group active devices by type
                    const deviceTypes = {};
                    activeDevicesData.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!deviceTypes[type]) {
                            deviceTypes[type] = [];
                        }
                        deviceTypes[type].push(device);
                    });

                    // Group removed devices by type for the removed section
                    const removedDeviceTypes = {};
                    removedDevicesData.forEach(device => {
                        const type = device.device_type || 'Unknown';
                        if (!removedDeviceTypes[type]) {
                            removedDeviceTypes[type] = [];
                        }
                        removedDeviceTypes[type].push(device);
                    });

                    // Count devices with both periodic and category tests completed in current year
                    // Note: currentYear automatically updates each year - no hardcoded year needed
                    const currentYear = new Date().getFullYear();
                    let devicesWithBothTests = 0;
                    let devicesWithOneTest = 0;
                    let devicesWithNoTests = 0;
                    let devicesWithWarning = 0;
                    const devicesWithOneTestList = []; // Store device info with one test completed
                    const devicesWithBothTestsList = []; // Store device info with both tests completed
                    const devicesWithNoTestsList = []; // Store device info with no tests completed
                    const devicesWithWarningList = []; // Store device info with CAT 5 required but not done
                    
                    // Get dismantled devices separately
                    const dismantledDevicesData = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    );
                    
                    // Count active devices (not removed or dismantled) - exclude dismantled from active devices loop
                    activeDevicesData.filter(device => 
                        !device.device_status || device.device_status.toUpperCase() !== 'DISMANTLED'
                    ).forEach(device => {
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        // Check if periodic inspection was done this year
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        
                        // Check if category test was done this year
                        // CAT 5 is only required every 5 years, so check if CAT 5 is required this year
                        // Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing
                        const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                        const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                        const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                        const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                        const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                        let requiresCat5 = false;
                        if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                            const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if a valid category test was completed this year
                        let hasCategoryTestThisYear = false;
                        if (requiresCat5) {
                            // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                            hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        } else {
                            // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                            hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                      (cat5Date && cat5Date.getFullYear() === currentYear);
                        }
                        
                        // Check if CAT 1 & PVI are done but CAT 5 is required and not done (Warning case)
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        
                        // CAT 1 is ALWAYS required for completion, plus CAT 5 if required
                        const bothTestsCompleted = hasPVIThisYear && hasCat1ThisYear && (!requiresCat5 || hasCat5ThisYear);
                        
                        if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                            // CAT 5 is required but not done, even though CAT 1 & PVI were done - add to warning list
                            devicesWithWarning++;
                            devicesWithWarningList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: false,
                                hasCat1: hasCat1ThisYear,
                                requiresCat5: true,
                                lastCat5Year: cat5Date ? cat5Date.getFullYear() : null,
                                isDismantled: false
                            });
                        } else if (conveyorCompleted || bothTestsCompleted) {
                            devicesWithBothTests++;
                            devicesWithBothTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: hasCategoryTestThisYear,
                                isDismantled: false,
                                isConveyor: isConveyor
                            });
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            devicesWithOneTest++;
                            devicesWithOneTestList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: hasCategoryTestThisYear,
                                isDismantled: false
                            });
                        } else {
                            // Device has neither PVI nor Category test completed this year
                            devicesWithNoTests++;
                            devicesWithNoTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: false,
                                hasCategory: false,
                                isDismantled: false
                            });
                        }
                    });
                    
                    // Count dismantled devices - they only need PVI to be considered completed
                    dismantledDevicesData.forEach(device => {
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        
                        // Dismantled devices only need PVI to be considered completed
                        if (hasPVIThisYear) {
                            devicesWithBothTests++;
                            devicesWithBothTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: hasPVIThisYear,
                                hasCategory: false,
                                isDismantled: true
                            });
                        } else {
                            // Dismantled device without PVI - add to no tests list
                            devicesWithNoTests++;
                            devicesWithNoTestsList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                hasPVI: false,
                                hasCategory: false,
                                isDismantled: true
                            });
                        }
                    });
                    
                    // Store the lists globally for filtering
                    window.devicesWithOneTestList = devicesWithOneTestList;
                    window.devicesWithBothTestsList = devicesWithBothTestsList;
                    window.devicesWithNoTestsList = devicesWithNoTestsList;
                    window.devicesWithWarningList = devicesWithWarningList;

                    // Build device type summary with counts
                    // Order matches the output: active device types first (in their order), then removed-only types
                    const deviceTypeSummary = (() => {
                        const typeCounts = [];
                        const processedTypes = new Set();
                        
                        // Process active device types first (in the order they appear)
                        Object.keys(deviceTypes).forEach(type => {
                            const activeCount = deviceTypes[type] ? deviceTypes[type].length : 0;
                            const removedCount = removedDeviceTypes[type] ? removedDeviceTypes[type].length : 0;
                            const totalCount = activeCount + removedCount;
                            
                            // Format the type name and handle pluralization for elevator
                            let formattedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
                            if (type.toUpperCase() === 'ELEVATOR' && totalCount > 1) {
                                formattedType = 'Elevators';
                            }
                            
                            let countStr = formattedType + ' (' + activeCount + ' active';
                            if (removedCount > 0) {
                                countStr += ', ' + removedCount + ' removed';
                            }
                            countStr += ')';
                            typeCounts.push(countStr);
                            processedTypes.add(type);
                        });
                        
                        // Add any removed-only device types (types that only exist in removed, not active)
                        Object.keys(removedDeviceTypes).forEach(type => {
                            if (!processedTypes.has(type)) {
                                const removedCount = removedDeviceTypes[type].length;
                                let formattedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
                                if (type.toUpperCase() === 'ELEVATOR' && removedCount > 1) {
                                    formattedType = 'Elevators';
                                }
                                let countStr = formattedType + ' (0 active, ' + removedCount + ' removed)';
                                typeCounts.push(countStr);
                            }
                        });
                        
                        return typeCounts.join(', ');
                    })();

                    let html = `
                        <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                            ${window.cameFromSuggestions && window.savedAddressSuggestions ? `
                            <div style="margin-bottom: 15px;">
                                <button onclick="showPreviousSuggestions()" 
                                        style="padding: 8px 16px; background: var(--panel-bg); color: var(--header-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;"
                                        onmouseover="this.style.backgroundColor='var(--input-bg)'"
                                        onmouseout="this.style.backgroundColor='var(--panel-bg)'">
                                    <span style="font-size: 1.1em;">‚Üê</span> Back to Address Suggestions
                                </button>
                            </div>
                            ` : ''}
                            <div style="margin-bottom: 20px;">
                                <strong style="color: var(--header-color);">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px; padding: 12px; background: var(--panel-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <!-- Year updates automatically via currentYear variable (new Date().getFullYear()) -->
                                    <strong style="color: var(--header-color);">${currentYear} Test Completion Status:</strong>
                                    <button onclick="toggleTestCompletionStatus()" 
                                            id="testCompletionStatusBtn"
                                            data-showing="false"
                                            style="padding: 6px 12px; background: var(--input-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; transition: all 0.2s ease;">
                                        <span id="testCompletionStatusText">Show</span>
                                    </button>
                                </div>
                                <div id="testCompletionStatusContent" style="display: none; margin-left: 10px;">
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ff9800;">‚ö† Warning (CAT 5 Required): ${devicesWithWarning}</span>
                                            ${devicesWithWarning > 0 ? `
                                                <button onclick="toggleWarningList()" 
                                                        id="warningListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="warningListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="warningDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithWarningList.map(device => {
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) - CAT 1 & PVI completed, CAT 5 required
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #4CAF50;">‚úì Both Tests Completed: ${devicesWithBothTests}</span>
                                            ${devicesWithBothTests > 0 ? `
                                                <button onclick="toggleBothTestsList()" 
                                                        id="bothTestsListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="bothTestsListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="bothTestsDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithBothTestsList.map(device => {
                                                    let testInfo = '';
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        testInfo = 'PVI completed (Dismantled devices only need PVI)';
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    } else {
                                                        const tests = [];
                                                        if (device.hasPVI) tests.push('PVI');
                                                        if (device.hasCategory) tests.push('Category test');
                                                        testInfo = tests.join(' + ');
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - ${testInfo}
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ffd700;">‚ö† One Test Completed: ${devicesWithOneTest}</span>
                                            ${devicesWithOneTest > 0 ? `
                                                <button onclick="toggleOneTestList()" 
                                                        id="oneTestListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="oneTestListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="oneTestDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithOneTestList.map(device => {
                                                    let testType = '';
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        testType = 'No PVI test (Dismantled devices only need PVI)';
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    } else {
                                                        testType = device.hasPVI ? 'PVI only' : 'Category test only';
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - ${testType}
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="color: #ff6b6b;">‚úó No Test Completed: ${devicesWithNoTests}</span>
                                            ${devicesWithNoTests > 0 ? `
                                                <button onclick="toggleNoTestsList()" 
                                                        id="noTestsListBtn"
                                                        data-showing="false"
                                                        style="padding: 4px 8px; background: var(--input-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.85em; transition: all 0.2s ease;">
                                                    <span id="noTestsListText">Show Devices</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div id="noTestsDevicesList" style="display: none; margin-top: 10px; padding: 10px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--input-border); max-height: 300px; overflow-y: auto;">
                                            <div style="font-size: 0.9em; color: var(--text-color);">
                                                ${devicesWithNoTestsList.map(device => {
                                                    let statusNote = '';
                                                    
                                                    if (device.isDismantled) {
                                                        statusNote = '<span style="color: #ffd700; font-weight: bold;">[DISMANTLED]</span>';
                                                    }
                                                    
                                                    return `<div style="margin-bottom: 5px; padding: 5px;">
                                                        <strong>Device #${device.device_number}</strong> (${device.device_type}) ${statusNote} - No tests completed this year
                                                    </div>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: var(--header-color);">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--header-color);">Total Active Violations:</strong> 
                                        <span style="color: ${totalActiveViolations > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${totalActiveViolations > 0 ? totalActiveViolations : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">‚Ä¢ Active Devices: ${activeDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">‚Ä¢ Dismantled Devices: ${dismantledDevices}</span>
                                    <br>
                                    <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">‚Ä¢ Removed/Deleted Devices: ${removedDevices}</span>
                                    <br>
                                    <div style="margin-top: 10px;">
                                        <strong style="color: var(--header-color);">Test Eligibility:</strong>
                                        <br>
                                        <span style="margin-left: 20px; color: ${devicesWithWarning > 0 ? '#ff9800' : 'var(--text-color)'};">‚Ä¢ Warning: ${devicesWithWarning}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${eligibleCompletedDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">‚Ä¢ Completed: ${eligibleCompletedDevices}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${eligibleDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">‚Ä¢ Ready: ${eligibleDevices}</span>
                                        <br>
                                        <span style="margin-left: 20px; color: ${notEligibleDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">‚Ä¢ Not Ready: ${notEligibleDevices}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; margin-bottom: 15px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                    <button 
                                        onclick="toggleViolationsFilter()" 
                                        id="violationsFilterBtn"
                                        data-filtering="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; display: flex; align-items: center; gap: 5px; width: 240px;">
                                        <span id="violationsFilterText">Show Only Devices with Violations</span>
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="testEligibilityFilter" style="color: var(--text-color); font-size: 0.9em;">Test Eligibility:</label>
                                        <select 
                                            id="testEligibilityFilter" 
                                            onchange="filterByTestEligibility()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Devices</option>
                                            <option value="eligible">Ready</option>
                                            <option value="not-eligible">Not Ready</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    
                                    <button 
                                        onclick="toggleAllViolations()" 
                                        id="toggleAllViolationsBtn"
                                        data-showing="false"
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 180px;">
                                        Show All Violations
                                    </button>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="deviceTypeFilter" style="color: var(--text-color); font-size: 0.9em;">Filter by Type:</label>
                                        <select 
                                            id="deviceTypeFilter" 
                                            onchange="filterDevicesByType()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="all">All Types</option>
                                            ${Object.keys(deviceTypes).map(type => 
                                                `<option value="${type}">${type}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="deviceNumberFilter" style="color: var(--text-color); font-size: 0.9em;">Search:</label>
                                        <input 
                                            type="text" 
                                            id="deviceNumberFilter" 
                                            placeholder="Enter device number"
                                            oninput="filterByDeviceNumber()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label for="dateSortFilter" style="color: var(--text-color); font-size: 0.9em;">Sort by Date:</label>
                                        <select 
                                            id="dateSortFilter" 
                                            onchange="sortByDateTested()"
                                            style="padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9em; width: 150px;">
                                            <option value="default">Default Order</option>
                                            <option value="oldest">Oldest First</option>
                                            <option value="newest">Newest First</option>
                                        </select>
                                    </div>
                                    
                                    <button onclick="copyAllDeviceNumbers()" 
                                            id="copyAllDevicesBtn"
                                            style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;"
                                            onmouseover="this.style.backgroundColor='var(--input-bg)'"
                                            onmouseout="this.style.backgroundColor='var(--panel-bg)'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                        <span id="copyAllDevicesBtnText">Copy All Device #s</span>
                                    </button>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button 
                                        onclick="resetFilters()" 
                                        style="padding: 8px 12px; background: var(--panel-bg); color: var(--text-color); 
                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                               font-size: 0.9em; width: 120px;">
                                        Reset Filters
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <div id="activeFilterStatus" style="display: none; padding: 10px 15px; margin-bottom: 15px; background: linear-gradient(135deg, rgba(26, 115, 232, 0.15), rgba(26, 115, 232, 0.05)); border: 1px solid rgba(26, 115, 232, 0.3); border-radius: 8px; color: var(--text-color); font-size: 0.9em;">
                                    <span style="display: flex; align-items: center; gap: 8px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="#1a73e8" style="flex-shrink: 0;">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                                        </svg>
                                        <span id="activeFilterText">You are currently viewing with filters on</span>
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color);">Active Devices by Type:</strong>
                                </div>
                                <div style="color: var(--text-color); font-size: 0.9em; margin-bottom: 10px; margin-left: 5px;">${deviceTypeSummary}</div>
                                <div id="testEligibilityCount" style="color: var(--text-color); font-size: 0.9em; font-weight: 500; margin-bottom: 10px; margin-left: 5px;"></div>
                                <div style="height: 600px; overflow-y: auto; padding-right: 10px; resize: vertical; border: 2px solid var(--input-border); border-radius: 5px; min-height: 300px;" id="deviceTypeSections">
                    `;
                    
                    // Update progress for device section generation
                    updateBinProgress(85, 'Step 3 of 3: Generating device sections...', `Processing ${data.length} device(s)...`);
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        const elevatorSection = await generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR'], violationsByDevice);
                        html += elevatorSection;
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    
                    // Then display the rest of the active device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        const deviceSection = await generateDeviceTypeSection(type, devices, violationsByDevice);
                        html += deviceSection;
                    }
                    
                    // Update progress after device sections
                    updateBinProgress(95, 'Step 3 of 3: Finalizing...', 'Almost done...');

                    html += `</div>`;

                    // Add removed devices section if there are any
                    if (removedDevicesData.length > 0) {
                        html += `
                            <div style="margin-top: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: #ff6b6b;">Removed/Deleted Devices (${removedDevicesData.length}):</strong>
                                    <button onclick="toggleRemovedDevices()" 
                                            id="removedDevicesToggleBtn"
                                            data-showing="false"
                                            style="padding: 6px 12px; background: var(--input-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                                        <span id="removedDevicesToggleText">Show</span>
                                        <svg id="removedDevicesToggleIcon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="transition: transform 0.2s ease;">
                                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div id="removedDeviceTypeSections" style="display: none; height: 400px; overflow-y: auto; padding-right: 10px; resize: vertical; border: 2px solid var(--input-border); border-radius: 5px; min-height: 200px;">
                        `;
                        
                        // Display removed devices grouped by their original type
                        for (const [type, devices] of Object.entries(removedDeviceTypes)) {
                            const removedSection = await generateRemovedDeviceTypeSection(type, devices, violationsByDevice);
                            html += removedSection;
                        }
                        
                        html += `</div>`;
                    }

                                        html += `</div></div>`;
                    
                    // Final progress update before displaying results
                    updateBinProgress(100, 'Complete!', 'Loading results...');
                    
                    resultDiv.innerHTML = html;
                    // Initialize filter count display
                    if (typeof window.applyAllFilters === 'function') {
                        window.applyAllFilters();
                    }
                        } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                    // Clear count display when no results
                    const countElement = document.getElementById('testEligibilityCount');
                    if (countElement) {
                        countElement.textContent = '';
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
                // Clear count display on error
                const countElement = document.getElementById('testEligibilityCount');
                if (countElement) {
                    countElement.textContent = '';
                }
            }
        }

        // Add this function before generateDeviceTypeSection
        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            return daysSinceInspection >= 91;
        }

        // Add function to generate removed device type section
        async function generateRemovedDeviceTypeSection(type, devices, violationsByDevice = {}) {
            // First, fetch all permit data for the devices
            const devicePermits = await Promise.all(
                devices.map(device => fetchPermitInfo(device.device_number))
            );

            return `
                <div class="device-type-section removed-devices" data-device-type="${type}" data-device-status="REMOVED">
                    <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ff6b6b;">
                        <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                            <strong style="color: #ff6b6b;">Removed/Deleted ${type} (${devices.length}):</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${devices.map((device, index) => {
                                // Get violations for this device
                                const deviceViolations = violationsByDevice[device.device_number] || [];
                                const activeViolations = deviceViolations.filter(v => 
                                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                    v.violation_status?.toUpperCase() === 'OPEN');
                                const violationCount = activeViolations.length;
                                
                                // Get the pre-fetched permit data
                                const permitData = devicePermits[index];
                                const hasPermits = permitData.success && permitData.permits && permitData.permits.length > 0;

                                // Calculate dates for red styling check
                                const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                                const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                                const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                                
                                // Check if all dates are the same (CAT 1, CAT 5, and PVI)
                                const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                    cat1Date.getTime() === cat5Date.getTime() &&
                                    cat5Date.getTime() === pviDate.getTime();
                                
                                // Apply red styling if all dates are the same
                                const deviceNumberStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';

                                return `
                                    <div class="device-item removed-device" 
                                         data-has-violations="${violationCount > 0}" 
                                         data-device-type="${type}"
                                         data-device-status="${(device.device_status || 'REMOVED').toUpperCase()}">
                                        <div style="padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid #ff6b6b; opacity: 0.8;">
                                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Device #:</strong> 
                                                    <span style="${deviceNumberStyle}">${device.device_number}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">BIN:</strong> 
                                                    ${device.bin ? `
                                                        <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                                              title="Click to copy BIN number"
                                                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                                     transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                                     border: 1px solid var(--input-border); background: var(--panel-bg);">
                                                            ${device.bin}
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                                                <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                                            </svg>
                                                        </span>
                                                    ` : '<span>N/A</span>'}
                                                </div>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Type:</strong> ${type}</div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">Status:</strong>
                                                    <span style="padding: 4px 8px; border-radius: 4px; background: #ff6b6b; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 4px;">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                        </svg>${(device.device_status || 'REMOVED').toUpperCase()}
                                                    </span>
                                                </div>
                                            </div>
                                            ${violationCount > 0 ? `
                                                <div style="margin-top: 12px; margin-bottom: 8px;">
                                                    <span style="color: #ff6b6b; font-weight: 500;">
                                                        ${violationCount} Active Violation${violationCount !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <button onclick="toggleViolations('${device.device_number}')" 
                                                        id="violationsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Violation Details</span>
                                                        <span class="arrow">‚ñº</span>
                                                    </button>
                                                    <div id="violations_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <div style="margin-top: 12px;">
                                                <button onclick="toggleDeviceDetails('${device.device_number}')" 
                                                    id="detailsBtn_${device.device_number}"
                                                    style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                           border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                           font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                    <span>Show Details</span>
                                                    <span class="arrow">‚ñº</span>
                                                </button>
                                                <div id="details_${device.device_number}" style="display: none; margin-top: 8px; 
                                                     padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 1em;">
                                                </div>
                                            </div>
                                            ${hasPermits ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="togglePermitInfo('${device.device_number}')" 
                                                        id="permitsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Permit Information</span>
                                                        <span class="arrow">‚ñº</span>
                                                    </button>
                                                    <div id="permits_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${allDatesAreSame ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="toggleImportantDropdown('bin_${device.device_number}')"
                                                            style="width: 100%; padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                        <span>‚ö†Ô∏è Important</span>
                                                        <span class="arrow">‚ñº</span>
                                                    </button>
                                                    <div id="important_bin_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b; font-size: 0.9em;">
                                                        <div style="margin-bottom: 8px;">
                                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                                        </div>
                                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${(() => {
                                                const missedTests = getMissedRequiredTests(device);
                                                if (missedTests.length > 0) {
                                                    // Check if device has a removal permit
                                                    let hasRemovalPermit = false;
                                                    let removalPermitNumber = '';
                                                    if (hasPermits && permitData.permits) {
                                                        const removalPermit = permitData.permits.find(p => {
                                                            const workType = (p.work_type || '').toUpperCase();
                                                            const description = (p.description || '').toUpperCase();
                                                            const appType = (p.application_type || '').toUpperCase();
                                                            return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                                                   workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                                                   description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                                                   description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                                                   appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                                        });
                                                        if (removalPermit) {
                                                            hasRemovalPermit = true;
                                                            removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                                        }
                                                    }
                                                    
                                                    const missedTestsList = missedTests.map(mt => 
                                                        `<div style="margin-bottom: 6px; padding: 6px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                                            <strong style="color: #ff9800;">${mt.test}</strong> missed in <strong>${mt.year}</strong>
                                                            <br><span style="font-size: 0.85em; opacity: 0.8;">Last: ${mt.lastTestDate}</span>
                                                        </div>`
                                                    ).join('');
                                                    
                                                    const removalPermitNote = hasRemovalPermit ? `
                                                        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                                            <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                                                üìã Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''}
                                                            </div>
                                                            <div style="font-size: 0.85em; opacity: 0.9;">
                                                                Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                                            </div>
                                                        </div>
                                                    ` : '';
                                                    
                                                    return `
                                                        <div style="margin-top: 10px;">
                                                            <button onclick="toggleMissedTestDropdown('bin_removed_${device.device_number}')"
                                                                    style="width: 100%; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                                <span>‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})</span>
                                                                <span class="arrow">‚ñº</span>
                                                            </button>
                                                            <div id="missed_test_bin_removed_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.9em;">
                                                                <div style="margin-bottom: 8px;">
                                                                    <strong style="color: #ff9800;">Missed Required Test Alert</strong>
                                                                </div>
                                                                <div style="color: var(--text-color);">
                                                                    ${missedTestsList}
                                                                    <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">CAT 1 and PVI are required annually. CAT 5 every 5 years.</div>
                                                                    ${removalPermitNote}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                                return '';
                                            })()}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to calculate test status for sorting
        function calculateTestStatusForSorting(device) {
            const currentYear = new Date().getFullYear();
            const today = new Date();
            
            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
            
            // Check if all dates are the same (acceptance test indicator)
            const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                cat1Date.getTime() === cat5Date.getTime() &&
                cat5Date.getTime() === pviDate.getTime();
            
            // Check if acceptance test was done in a previous year
            const acceptanceTestInPreviousYear = allDatesAreSame && 
                cat1Date.getFullYear() < currentYear;
            
            const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
            const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
            
            const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
            
            // Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing
            const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
            const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
            const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
            const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
            const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
            let requiresCat5 = false;
            if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                requiresCat5 = yearsSinceCat5 >= 5;
            }
            
            // Determine if a valid category test was completed this year
            let hasCategoryTestThisYear = false;
            if (requiresCat5) {
                // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
            } else {
                // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                          (cat5Date && cat5Date.getFullYear() === currentYear);
            }
            
            const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
            const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
            // Conveyors only need CAT 1 testing (no PVI required)
            const conveyorCompleted = isConveyor && hasCat1ThisYear;
            // CAT 1 is ALWAYS required for completion, plus CAT 5 if required
            const bothTestsCompleted = hasPVIThisYear && hasCat1ThisYear && (!requiresCat5 || hasCat5ThisYear);
            const cat5NotRequired = !requiresCat5;
            const dismantledCompleted = isDismantled && hasPVIThisYear;
            
            // Conveyors are completed when CAT 1 is done this year
            if (conveyorCompleted) {
                if (today.getFullYear() === currentYear) {
                    return 'Completed';
                } else {
                    return isEligibleForTesting(cat1Date) ? 'Ready' : 'Not Ready';
                }
            }
            
            // Check if CAT 5 is required but not done, and CAT 1 & PVI are done this year
            if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                return 'CAT 5 Required';
            }
            
            // If acceptance test was done in previous year, both tests are required in new year
            // So we can't show "Completed" unless both tests are done in current year
            if (acceptanceTestInPreviousYear) {
                // Both tests must be completed in current year to show "Completed"
                if (bothTestsCompleted) {
                    const relevantDate = mostRecentDate;
                    const testYear = relevantDate ? relevantDate.getFullYear() : null;
                    
                    if (testYear === currentYear && today.getFullYear() === currentYear) {
                        return 'Completed';
                    } else {
                        // Calendar year has ended - check eligibility based on 91 days rule
                        return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
                    }
                } else {
                    // Both tests not completed in current year - check eligibility
                    return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
                }
            } else if (bothTestsCompleted || dismantledCompleted) {
                const relevantDate = isDismantled ? pviDate : mostRecentDate;
                const testYear = relevantDate ? relevantDate.getFullYear() : null;
                
                // Only show "Completed" if tests were done in current year and we're still in current year
                if (testYear === currentYear && today.getFullYear() === currentYear) {
                    return 'Completed';
                } else {
                    // Calendar year has ended - check eligibility based on 91 days rule
                    const eligibilityDate = isDismantled ? pviDate : mostRecentDate;
                    return isEligibleForTesting(eligibilityDate) ? 'Ready' : 'Not Ready';
                }
            } else {
                return isEligibleForTesting(mostRecentDate) ? 'Ready' : 'Not Ready';
            }
        }

        // Update the generateDeviceTypeSection function
        async function generateDeviceTypeSection(type, devices, violationsByDevice = {}) {
            // First, fetch all permit data for the devices
            const devicePermits = await Promise.all(
                devices.map(device => fetchPermitInfo(device.device_number))
            );

            // Create array with devices, permits, and status for sorting
            const devicesWithStatus = devices.map((device, index) => ({
                device: device,
                permit: devicePermits[index],
                status: calculateTestStatusForSorting(device)
            }));

            // Sort devices: "CAT 5 Required" first (most important), then "Not Ready", then "Ready", then "Completed"
            devicesWithStatus.sort((a, b) => {
                const statusOrder = { 'CAT 5 Required': -1, 'Not Ready': 0, 'Ready': 1, 'Completed': 2 };
                const orderA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 3;
                const orderB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 3;
                return orderA - orderB;
            });

            return `
                <div class="device-type-section" data-device-type="${type}">
                    <div style="background: var(--panel-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">
                            <strong style="color: var(--header-color);">${type} (${devices.length}):</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${devicesWithStatus.map((item, index) => {
                                const device = item.device;
                                const permitData = item.permit;
                                // Get violations for this device
                                const deviceViolations = violationsByDevice[device.device_number] || [];
                                const activeViolations = deviceViolations.filter(v => 
                                    v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                    v.violation_status?.toUpperCase() === 'OPEN');
                                const violationCount = activeViolations.length;
                                
                                // Get the pre-fetched permit data (already from sorted array)
                                const hasPermits = permitData.success && permitData.permits && permitData.permits.length > 0;

                                // Calculate most recent inspection date
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                                
                                // Check if all dates are the same (CAT 1, CAT 5, and PVI) - acceptance test indicator
                                const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                    cat1Date.getTime() === cat5Date.getTime() &&
                                    cat5Date.getTime() === pviDate.getTime();
                                
                                // Apply red styling if all dates are the same
                                const deviceNumberStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                                
                                // Find most recent date
                                const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                                const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                                
                                // Calculate test status based on new requirements
                                const currentYear = new Date().getFullYear();
                                const today = new Date();
                                
                                // Check if acceptance test was done in a previous year
                                const acceptanceTestInPreviousYear = allDatesAreSame && 
                                    cat1Date.getFullYear() < currentYear;
                                
                                // Check if periodic inspection was done this year
                                const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                                
                                // Check if CAT 5 is required this year (Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing)
                                const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                                const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                                const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                                const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                                const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                                let requiresCat5 = false;
                                if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                                    const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                                    requiresCat5 = yearsSinceCat5 >= 5;
                                }
                                // If no CAT 5 date exists, CAT 5 is not required (CAT 1 is acceptable)
                                
                                // Determine if a valid category test was completed this year
                                let hasCategoryTestThisYear = false;
                                if (requiresCat5) {
                                    // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                                    hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                                } else {
                                    // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                                    hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                              (cat5Date && cat5Date.getFullYear() === currentYear);
                                }
                                
                                // Check if device is dismantled
                                const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                                const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                                const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                                
                                // Conveyors only need CAT 1 testing (no PVI required)
                                const conveyorCompleted = isConveyor && hasCat1ThisYear;
                                
                                // CAT 1 is ALWAYS required for completion, plus CAT 5 if required
                                const bothTestsCompleted = hasPVIThisYear && hasCat1ThisYear && (!requiresCat5 || hasCat5ThisYear);
                                const cat5NotRequired = !requiresCat5;
                                
                                // For dismantled devices, only PVI is required
                                const dismantledCompleted = isDismantled && hasPVIThisYear;
                                
                                // Determine test status
                                let testStatus = 'Not Ready';
                                let testStatusColor = '#ff6b6b';
                                let testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                            </svg>`;
                                let isEligible = false;
                                
                                // Conveyors are completed when CAT 1 is done this year
                                if (conveyorCompleted) {
                                    if (today.getFullYear() === currentYear) {
                                        testStatus = 'Completed';
                                        testStatusColor = '#4CAF50';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                            </svg>`;
                                    } else {
                                        isEligible = isEligibleForTesting(cat1Date);
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                }
                                // If acceptance test was done in previous year, both tests are required in new year
                                // So we can't show "Completed" unless both tests are done in current year
                                // Exception: Dismantled devices only need PVI, Conveyors only need CAT 1
                                else if (acceptanceTestInPreviousYear) {
                                    // For dismantled devices, only PVI is required; for regular devices, both tests must be completed
                                    if (isDismantled && hasPVIThisYear) {
                                        // Dismantled device with PVI completed this year
                                        const relevantDate = pviDate;
                                        const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                        
                                        if (testYear === currentYear && today.getFullYear() === currentYear) {
                                            // Still in the same calendar year as the PVI - show "Completed"
                                            testStatus = 'Completed';
                                            testStatusColor = '#4CAF50';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                                </svg>`;
                                        } else {
                                            // Calendar year has ended - check eligibility based on 91 days rule
                                            isEligible = isEligibleForTesting(pviDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                    } else if (bothTestsCompleted) {
                                        // Regular device - both tests must be completed in current year to show "Completed"
                                        const relevantDate = mostRecentDate;
                                        const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                        
                                        if (testYear === currentYear && today.getFullYear() === currentYear) {
                                            // Still in the same calendar year as the tests - show "Completed"
                                            testStatus = 'Completed';
                                            testStatusColor = '#4CAF50';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                                </svg>`;
                                        } else {
                                            // Calendar year has ended - check eligibility based on 91 days rule
                                            isEligible = isEligibleForTesting(mostRecentDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                    } else {
                                        // Tests not completed in current year - check eligibility
                                        // For dismantled devices without PVI, check eligibility based on PVI date
                                        if (isDismantled && !hasPVIThisYear) {
                                            // Dismantled device without PVI this year
                                            const eligibilityDate = pviDate || mostRecentDate;
                                            isEligible = isEligibleForTesting(eligibilityDate);
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        } else {
                                            // Regular device - check if CAT 5 is required but not done this year
                                            if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                                            // CAT 5 is required but not done, even though CAT 1 & PVI were done - show warning but still Ready
                                            testStatus = 'CAT 5 Required';
                                            testStatusColor = '#ff9800';
                                            testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                            </svg>`;
                                            isEligible = true; // Still count as eligible/Ready
                                        } else {
                                            isEligible = isEligibleForTesting(mostRecentDate);
                                            // If CAT 1 & PVI are done this year but CAT 5 is required and not done, still count as eligible (Ready)
                                            if (!isEligible && hasCat1ThisYear && hasPVIThisYear && requiresCat5 && !hasCat5ThisYear) {
                                                isEligible = true;
                                            }
                                            testStatus = isEligible ? 'Ready' : 'Not Ready';
                                            testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                            testStatusIcon = isEligible ? 
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                </svg>` :
                                                `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>`;
                                        }
                                        }
                                    }
                                } else if (bothTestsCompleted || dismantledCompleted) {
                                    // Check if we're still in the same calendar year as the tests
                                    // For dismantled devices, use PVI date; for regular devices, use most recent date
                                    const relevantDate = isDismantled ? pviDate : mostRecentDate;
                                    const testYear = relevantDate ? relevantDate.getFullYear() : null;
                                    
                                    // Only show "Completed" if tests were done in current year and we're still in current year
                                    if (testYear === currentYear && today.getFullYear() === currentYear) {
                                        // Still in the same calendar year as the tests - show "Completed"
                                        testStatus = 'Completed';
                                        testStatusColor = '#4CAF50';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                            </svg>`;
                                    } else {
                                        // Calendar year has ended - check eligibility based on 91 days rule
                                        // For dismantled devices, use PVI date; for regular devices, use most recent date
                                        const eligibilityDate = isDismantled ? pviDate : mostRecentDate;
                                        isEligible = isEligibleForTesting(eligibilityDate);
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                } else {
                                    // Check if CAT 5 is required but not done this year
                                    if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                                        // CAT 5 is required but not done, even though CAT 1 & PVI were done - show warning but still Ready
                                        testStatus = 'CAT 5 Required';
                                        testStatusColor = '#ff9800';
                                        testStatusIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                        </svg>`;
                                        isEligible = true; // Still count as eligible/Ready
                                    } else {
                                        // Standard eligibility check
                                        isEligible = isEligibleForTesting(mostRecentDate);
                                        // If CAT 1 & PVI are done this year but CAT 5 is required and not done, still count as eligible (Ready)
                                        if (!isEligible && hasCat1ThisYear && hasPVIThisYear && requiresCat5 && !hasCat5ThisYear) {
                                            isEligible = true;
                                        }
                                        testStatus = isEligible ? 'Ready' : 'Not Ready';
                                        testStatusColor = isEligible ? '#4CAF50' : '#ff6b6b';
                                        testStatusIcon = isEligible ? 
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                            </svg>` :
                                            `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                            </svg>`;
                                    }
                                }
                                
                                const daysSinceInspection = mostRecentDate ? 
                                    Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                                
                                // Determine which type of inspection was most recent
                                const lastInspectionType = mostRecentDate ? 
                                    mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT1' :
                                    mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT5' :
                                    'PVI' : null;
                                
                                return `
                                    <div class="device-item" 
                                         data-has-violations="${violationCount > 0}" 
                                         data-device-type="${type}"
                                         data-device-status="${(device.device_status || '').toUpperCase()}"
                                         data-original-index="${index}">
                                        <div style="padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div><strong style="color: var(--header-color);">Device #:</strong> 
                                                    <span style="${deviceNumberStyle}">${device.device_number}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">BIN:</strong> 
                                                    ${device.bin ? `
                                                        <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                                              title="Click to copy BIN number"
                                                              style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                                     transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                                     border: 1px solid var(--input-border); background: var(--panel-bg);">
                                                            ${device.bin}
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                                                <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                                            </svg>
                                                        </span>
                                                    ` : '<span>N/A</span>'}
                                                </div>
                                            </div>
                                                <div class="device-status-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <div><strong style="color: var(--header-color);">Status:</strong> ${device.device_status || 'N/A'}</div>
                                                <div class="test-status-container" style="display: flex; align-items: center; gap: 8px;">
                                                    <strong style="color: var(--header-color);">Test Status:</strong>
                                                    <span class="test-status-badge" data-test-status="${isEligible}" data-test-status-text="${testStatus}" style="padding: 4px 8px; border-radius: 4px; background: ${testStatusColor}; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 4px;">
                                                        ${testStatusIcon}${testStatus}
                                                    </span>
                                                </div>
                                            </div>
                                            ${mostRecentDate ? `
                                                <div style="margin-top: 12px; margin-bottom: 12px; color: ${testStatusColor};">
                                                    ${testStatus === 'Completed' ? `
                                                        <div style="margin-bottom: 8px; color: #4CAF50; font-weight: 500;">
                                                            ${isDismantled || isConveyor || isWheelchairLift || isHydraulic || isEscalator ? 'Testing completed for the year' : 'Both tests completed for the year'}
                                                        </div>
                                                        ${isDismantled ? `
                                                            <div style="margin-bottom: 8px; color: #ffd700; font-size: 0.9em; font-style: italic;">
                                                                Dismantled devices are required to have a PVI completed for the calendar year. If dismantled device information is contradicting please verify information with the DOB and associated building contacts.
                                                            </div>
                                                        ` : ''}
                                                    ` : ''}
                                                    ${(() => {
                                                        // Check if device has one test completed but needs another
                                                        let needsOneMoreTest = false;
                                                        let missingTest = '';
                                                        
                                                        if (isDismantled) {
                                                            // Dismantled devices only need PVI
                                                            if (!hasPVIThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'PVI';
                                                            }
                                                        } else if (isConveyor) {
                                                            // Conveyors only need CAT 1 (no PVI required)
                                                            if (!hasCat1ThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'CAT 1';
                                                            }
                                                            // If CAT 1 is done, Conveyor is complete - no warning needed
                                                        } else {
                                                            // Regular devices need both PVI and Category test
                                                            if (hasPVIThisYear && !hasCategoryTestThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = requiresCat5 ? 'CAT 5' : 'CAT 1';
                                                            } else if (!hasPVIThisYear && hasCategoryTestThisYear) {
                                                                needsOneMoreTest = true;
                                                                missingTest = 'PVI';
                                                            }
                                                        }
                                                        
                                                        if (needsOneMoreTest) {
                                                            // Calculate days remaining in the current year
                                                            const today = new Date();
                                                            const endOfYear = new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999);
                                                            const timeDiff = endOfYear - today;
                                                            const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                                                            
                                                            // Only show message if 100 days or less remaining
                                                            if (daysRemaining <= 100) {
                                                                return `
                                                                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">
                                                                        <div style="color: #ff9800; font-weight: 500; margin-bottom: 4px;">
                                                                            ‚ö† One test completed, ${missingTest} still required
                                                                        </div>
                                                                        <div style="color: var(--text-color); font-size: 0.9em;">
                                                                            ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining in ${today.getFullYear()} to complete ${missingTest}
                                                                        </div>
                                                                    </div>
                                                                `;
                                                            }
                                                        }
                                                        return '';
                                                    })()}
                                                    ${(() => {
                                                        // Check if device has missed testing in prior year(s)
                                                        const lastTestYear = mostRecentDate.getFullYear();
                                                        const priorYear = currentYear - 1;
                                                        const yearsMissed = currentYear - lastTestYear - 1; // Years completely missed (excluding current year)
                                                        
                                                        // Only show warning if the last test was before the prior year
                                                        // (meaning they missed testing in the prior year entirely)
                                                        if (lastTestYear < priorYear) {
                                                            const missedYears = [];
                                                            for (let y = lastTestYear + 1; y < currentYear; y++) {
                                                                missedYears.push(y);
                                                            }
                                                            
                                                            const yearsText = missedYears.length === 1 
                                                                ? String(missedYears[0]) 
                                                                : missedYears.slice(0, -1).join(', ') + ' and ' + missedYears.slice(-1);
                                                            
                                                            return '<div style="margin-bottom: 8px; padding: 8px; background: rgba(244, 67, 54, 0.1); border-radius: 4px; border: 1px solid #f44336;">' +
                                                                '<div style="color: #f44336; font-weight: 500; margin-bottom: 4px;">' +
                                                                    '‚ö† TESTING BEHIND SCHEDULE' +
                                                                '</div>' +
                                                                '<div style="color: var(--text-color); font-size: 0.9em;">' +
                                                                    'No tests completed in ' + yearsText + '. Last test was in ' + lastTestYear + '.' +
                                                                '</div>' +
                                                            '</div>';
                                                        } else if (lastTestYear === priorYear && testStatus !== 'Completed') {
                                                            // Last test was in prior year and current year tests not completed
                                                            return '<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">' +
                                                                '<div style="color: #ff9800; font-weight: 500; margin-bottom: 4px;">' +
                                                                    '‚ö† No tests completed in ' + currentYear +
                                                                '</div>' +
                                                                '<div style="color: var(--text-color); font-size: 0.9em;">' +
                                                                    'Last test was performed in ' + priorYear + '. Testing required for ' + currentYear + '.' +
                                                                '</div>' +
                                                            '</div>';
                                                        }
                                                        return '';
                                                    })()}
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                        <span>Last Inspection: ${mostRecentDate.toLocaleDateString()}</span>
                                                        <span style="padding: 2px 6px; background: var(--panel-bg); border-radius: 3px; color: var(--header-color);">${lastInspectionType}</span>
                                                        <span>‚Ä¢ ${daysSinceInspection} days ago</span>
                                                    </div>
                                                    ${testStatus !== 'Completed' ? `
                                                        <div style="margin-bottom: 8px; color: ${testStatusColor};">
                                                            ${(() => {
                                                                // Determine which test is required next
                                                                let requiredTest = '';
                                                                if (isDismantled) {
                                                                    // For dismantled devices, only PVI is required
                                                                    requiredTest = !hasPVIThisYear ? 'PVI' : '';
                                                                } else if (isConveyor) {
                                                                    // For Conveyors, only CAT 1 is required (no PVI)
                                                                    requiredTest = !hasCat1ThisYear ? 'CAT 1' : '';
                                                                } else {
                                                                    // For regular devices, check what's missing for current year
                                                                    if (!hasPVIThisYear && !hasCategoryTestThisYear) {
                                                                        // Both tests missing - determine which category test is needed
                                                                        requiredTest = requiresCat5 ? 'CAT 5 and PVI' : 'CAT 1 and PVI';
                                                                    } else if (!hasPVIThisYear) {
                                                                        // Only PVI missing
                                                                        requiredTest = 'PVI';
                                                                    } else if (!hasCategoryTestThisYear) {
                                                                        // Only category test missing
                                                                        requiredTest = requiresCat5 ? 'CAT 5' : 'CAT 1';
                                                                    } else {
                                                                        // Both tests completed this year, but past calendar year - both required again
                                                                        // This handles the case where tests were done last year
                                                                        requiredTest = requiresCat5 ? 'CAT 5 and PVI' : 'CAT 1 and PVI';
                                                                    }
                                                                }
                                                                
                                                                const eligibilityDate = new Date(mostRecentDate);
                                                                eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                                                                const formattedDate = eligibilityDate.toLocaleDateString('en-US', { 
                                                                    weekday: 'long',
                                                                    year: 'numeric',
                                                                    month: 'long',
                                                                    day: 'numeric'
                                                                });
                                                                
                                                                if (isEligible) {
                                                                    return requiredTest ? 
                                                                        `Eligible for ${requiredTest} testing since: ${formattedDate}` :
                                                                        `Eligible for testing since: ${formattedDate}`;
                                                                } else {
                                                                    return requiredTest ? 
                                                                        `Will be eligible for ${requiredTest} testing on: ${formattedDate}` :
                                                                        `Will be eligible for testing on: ${formattedDate}`;
                                                                }
                                                            })()}
                                                        </div>
                                                    ` : ''}
                                                    ${cat5Date ? `
                                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                                            Next CAT 5 test required: ${new Date(cat5Date.getTime() + (5 * 365 * 24 * 60 * 60 * 1000)).toLocaleDateString('en-US', { 
                                                                year: 'numeric',
                                                                month: 'long'
                                                            })}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            ${violationCount > 0 ? `
                                                <div style="margin-top: 12px; margin-bottom: 8px;">
                                                    <span style="color: #ff6b6b; font-weight: 500;">
                                                        ${violationCount} Active Violation${violationCount !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <button onclick="toggleViolations('${device.device_number}')" 
                                                        id="violationsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Violation Details</span>
                                                        <span class="arrow">‚ñº</span>
                                    </button>
                                                    <div id="violations_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;
                                                         overflow-y: auto; overflow-x: hidden; max-height: 80vh; max-width: 100%;
                                                         position: relative; border: 1px solid var(--input-border); width: 100%;
                                                         box-sizing: border-box;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                <div style="margin-top: 12px;">
                                                <button onclick="toggleDeviceDetails('${device.device_number}')" 
                                                    id="detailsBtn_${device.device_number}"
                                                    style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                           border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                           font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                    <span>Show Details</span>
                                                    <span class="arrow">‚ñº</span>
                                    </button>
                                                <div id="details_${device.device_number}" style="display: none; margin-top: 8px; 
                                                     padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 1em;">
                                </div>
                            </div>
                                            ${hasPermits ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="togglePermitInfo('${device.device_number}')" 
                                                        id="permitsBtn_${device.device_number}"
                                                        style="width: 100%; padding: 5px; background: var(--panel-bg); color: var(--text-color); 
                                                               border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                               font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                                        <span>Show Permit Information</span>
                                                        <span class="arrow">‚ñº</span>
                                                    </button>
                                                    <div id="permits_${device.device_number}" style="display: none; margin-top: 8px; 
                                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${allDatesAreSame ? `
                                                <div style="margin-top: 10px;">
                                                    <button onclick="toggleImportantDropdown('bin_${device.device_number}')"
                                                            style="width: 100%; padding: 8px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                        <span>‚ö†Ô∏è Important</span>
                                                        <span class="arrow">‚ñº</span>
                                                    </button>
                                                    <div id="important_bin_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b; font-size: 0.9em;">
                                                        <div style="margin-bottom: 8px;">
                                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                                        </div>
                                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${(() => {
                                                const missedTests = getMissedRequiredTests(device);
                                                if (missedTests.length > 0) {
                                                    // Check if device has a removal permit
                                                    let hasRemovalPermit = false;
                                                    let removalPermitNumber = '';
                                                    if (hasPermits && permitData.permits) {
                                                        const removalPermit = permitData.permits.find(p => {
                                                            const workType = (p.work_type || '').toUpperCase();
                                                            const description = (p.description || '').toUpperCase();
                                                            const appType = (p.application_type || '').toUpperCase();
                                                            return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                                                   workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                                                   description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                                                   description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                                                   appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                                        });
                                                        if (removalPermit) {
                                                            hasRemovalPermit = true;
                                                            removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                                        }
                                                    }
                                                    
                                                    const missedTestsList = missedTests.map(mt => 
                                                        `<div style="margin-bottom: 6px; padding: 6px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                                            <strong style="color: #ff9800;">${mt.test}</strong> missed in <strong>${mt.year}</strong>
                                                            <br><span style="font-size: 0.85em; opacity: 0.8;">Last: ${mt.lastTestDate}</span>
                                                        </div>`
                                                    ).join('');
                                                    
                                                    const removalPermitNote = hasRemovalPermit ? `
                                                        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                                            <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                                                üìã Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''}
                                                            </div>
                                                            <div style="font-size: 0.85em; opacity: 0.9;">
                                                                Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                                            </div>
                                                        </div>
                                                    ` : '';
                                                    
                                                    return `
                                                        <div style="margin-top: 10px;">
                                                            <button onclick="toggleMissedTestDropdown('bin_active_${device.device_number}')"
                                                                    style="width: 100%; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9em;">
                                                                <span>‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})</span>
                                                                <span class="arrow">‚ñº</span>
                                                            </button>
                                                            <div id="missed_test_bin_active_${device.device_number}" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800; font-size: 0.9em;">
                                                                <div style="margin-bottom: 8px;">
                                                                    <strong style="color: #ff9800;">Missed Required Test Alert</strong>
                                                                </div>
                                                                <div style="color: var(--text-color);">
                                                                    ${missedTestsList}
                                                                    <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">CAT 1 and PVI are required annually. CAT 5 every 5 years.</div>
                                                                    ${removalPermitNote}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                                return '';
                                            })()}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Add this function to toggle violations display for a device
        async function toggleViolations(deviceNumber) {
            const violationsDiv = document.getElementById(`violations_${deviceNumber}`);
            const violationsBtn = document.getElementById(`violationsBtn_${deviceNumber}`);
            const arrow = violationsBtn.querySelector('.arrow');
            const buttonText = violationsBtn.querySelector('span:first-child');
            
            if (violationsDiv.style.display === 'none') {
                violationsDiv.style.display = 'block';
                // Remove any fixed height to allow auto-expansion
                violationsDiv.style.height = 'auto';
                violationsDiv.style.overflowY = 'visible';
                violationsDiv.style.maxHeight = 'none';
                arrow.textContent = '‚ñ≤';
                if (buttonText) {
                    buttonText.textContent = 'Hide Violation Details';
                }
                
                // Check if this is a pre-rendered violations section (from device search)
                if (deviceNumber.startsWith('device_violations_') || deviceNumber.startsWith('quick_device_violations_')) {
                    // The violations are already pre-rendered in the HTML, so we don't need to do anything
                    return;
                }
                
                // Use pre-fetched violations if available
                let activeViolations = [];
                if (window.violationsByDevice && window.violationsByDevice[deviceNumber]) {
                    const deviceViolations = window.violationsByDevice[deviceNumber];
                    activeViolations = deviceViolations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                } else {
                    // Fallback to fetching for this specific device if needed
                    const violations = await fetchViolations(deviceNumber);
                    activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                }
                
                if (activeViolations.length > 0) {
                    let violationsHtml = `
                        <div style="margin-bottom: 8px; color: var(--header-color);">
                            <strong>Active Violations (${activeViolations.length}):</strong>
                        </div>
                        <div style="overflow: visible; padding-right: 5px;">
                    `;
                    
                    activeViolations.forEach(v => {
                        const issueDate = v.violation_issue_date ? new Date(v.violation_issue_date).toLocaleDateString() : 'Unknown';
                        violationsHtml += `
                            <div style="margin-bottom: 8px; padding: 8px; background: var(--input-bg); 
                                 border-radius: 4px; border: 1px solid var(--input-border); box-shadow: 0 1px 2px var(--card-shadow);">
                                <div><strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number || 'Unknown'}</div>
                                <div><strong style="color: var(--header-color);">Issued:</strong> ${issueDate}</div>
                                <div><strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'Not specified'}</div>
                                ${v.violation_category ? 
                                    `<div><strong style="color: var(--header-color);">Category:</strong> ${v.violation_category}</div>` : ''}
                                ${v.violation_severity ? 
                                    `<div><strong style="color: var(--header-color);">Severity:</strong> ${v.violation_severity}</div>` : ''}
                                ${v.violation_remarks ? 
                                    `<div style="margin-top: 5px;"><strong style="color: var(--header-color);">Remarks:</strong> 
                                        <div style="white-space: pre-wrap; margin-top: 3px;">${v.violation_remarks}</div>
                                    </div>` : ''}
                            </div>
                        `;
                    });
                    
                    violationsHtml += `</div>`;
                    violationsDiv.innerHTML = violationsHtml;
                    // After content is loaded, check if we need to enable scrolling
                    setTimeout(() => {
                        const rect = violationsDiv.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        // If content exceeds 80% of viewport, enable scrolling
                        if (rect.height > viewportHeight * 0.8) {
                            violationsDiv.style.maxHeight = '80vh';
                            violationsDiv.style.overflowY = 'auto';
                        }
                    }, 50);
                } else {
                    violationsDiv.innerHTML = `<div style="text-align: center; color: var(--text-color);">No active violations found</div>`;
                }
            } else {
                violationsDiv.style.display = 'none';
                arrow.textContent = '‚ñº';
                if (buttonText) {
                    buttonText.textContent = 'Show Violation Details';
                }
            }
        }

        // Update the exportBinToCSV function to include all information displayed in the output field
        async function exportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Show loading message
            const exportButton = document.getElementById('binExportButton');
            const originalText = exportButton.textContent;
            exportButton.textContent = 'Exporting...';
            exportButton.disabled = true;

            try {
                // Get building address from first device
                const buildingAddress = data[0] ? `${data[0].house_number || ''} ${data[0].street_name || ''}, ${data[0].borough || ''}`.trim() : 'N/A';
                const binNumber = data[0]?.bin || 'N/A';
                const currentYear = new Date().getFullYear();

                // Create CSV header with reordered fields (user requested order first, then others)
                let csvContent = 'BIN,Device Number,Device Type,Status,Address,Borough,ZIP Code,Block,Lot,' +
                    `Latest CAT 1,Latest CAT 5,Latest PVI,Category Test ${currentYear},PVI ${currentYear},Test Completion Status,` +
                    'Building Address,Latest Inspection,' +
                    'Violation Count,Violation Numbers,Violation Issue Dates,Violation Statuses,Violation Types,Violation Descriptions,' +
                    'Manufacturer,Machine Type,Governor Type,Car Buffer Type,Mode Operation,Safety Type,Fireman Service,Working Pressure,' +
                    'Controller Manufacturer,Elevator Control,Capacity (lbs),Speed (fpm)\n';

                // Create an array of promises to fetch all data for each device
                const promises = data.map(async device => {
                    // Fetch violations
                    const violations = await fetchViolations(device.device_number);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    // Fetch device info
                    const deviceInfo = await fetchDeviceInfo(device.device_number);
                    
                    // Calculate inspection dates
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Format dates for CSV
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check test completion status for current year
                    const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                    
                    // Check if category test was done this year (Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators do not need CAT 5 testing)
                    const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                    const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                    const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                    const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                    const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                    let requiresCat5 = false;
                    if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                        const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                        requiresCat5 = yearsSinceCat5 >= 5;
                    }
                    
                    // Determine if a valid category test was completed this year
                    let hasCategoryTestThisYear = false;
                    if (requiresCat5) {
                        // CAT 5 is required (5+ years since last CAT 5), so only CAT 5 done this year counts
                        hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                    } else {
                        // CAT 5 not required, so CAT 1 or CAT 5 done this year counts
                        hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                  (cat5Date && cat5Date.getFullYear() === currentYear);
                    }
                    
                    // Check if device is dismantled or removed (DELETED is treated as REMOVED)
                    const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                    const isRemoved = device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED');
                    
                    // For dismantled devices, only PVI is required
                    // For Conveyors, only CAT 1 is required
                    // For removed/deleted devices, set test completion status to N/A
                    const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                    let testCompletionStatus = 'N/A';
                    if (isRemoved) {
                        testCompletionStatus = 'N/A';
                    } else if (isDismantled) {
                        testCompletionStatus = hasPVIThisYear ? 'Complete (PVI only required)' : 'Incomplete';
                    } else if (isConveyor) {
                        testCompletionStatus = hasCat1ThisYear ? 'Complete (CAT 1 only required)' : 'Incomplete';
                    } else if (isWheelchairLift) {
                        // Wheelchair lifts need PVI + CAT 1 (no CAT 5)
                        if (hasPVIThisYear && hasCategoryTestThisYear) {
                            testCompletionStatus = 'Complete (CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else if (isHydraulic) {
                        // Hydraulic elevators need PVI + CAT 1 (no CAT 5)
                        if (hasPVIThisYear && hasCat1ThisYear) {
                            testCompletionStatus = 'Complete (Hydraulic - CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCat1ThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else if (isEscalator) {
                        // Escalators need PVI + CAT 1 (no CAT 5)
                        if (hasPVIThisYear && hasCat1ThisYear) {
                            testCompletionStatus = 'Complete (Escalator - CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCat1ThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else {
                        if (hasPVIThisYear && hasCategoryTestThisYear) {
                            testCompletionStatus = 'Complete (Both tests)';
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    }
                    
                    // Set Category Test to N/A for dismantled and removed devices
                    let categoryTestValue = 'N/A';
                    if (!isDismantled && !isRemoved) {
                        categoryTestValue = hasCategoryTestThisYear ? 'Yes' : 'No';
                    }
                    
                    // Set PVI to N/A for removed devices
                    let pviValue = 'N/A';
                    if (!isRemoved) {
                        pviValue = hasPVIThisYear ? 'Yes' : 'No';
                    }
                    
                    // Format violation details
                    const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                    const violationIssueDates = activeViolations.map(v => {
                        const date = v.violation_issue_date || v.violation_date;
                        return date ? new Date(date).toLocaleDateString() : 'N/A';
                    }).join('; ');
                    const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                    const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                    // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                    const violationDescriptions = activeViolations.map(v => {
                        const desc = v.violation_description || v.violation_remarks || 'N/A';
                        return desc.replace(/"/g, '""');
                    }).join('; ');
                    
                    // Build CSV row in the requested order
                    const row = [
                        // 1-15: User requested order
                        binNumber,
                        device.device_number || 'N/A',
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        `${device.house_number || ''} ${device.street_name || ''}`.trim() || 'N/A',
                        device.borough || 'N/A',
                        device.zip_code || 'N/A',
                        device.block || 'N/A',
                        device.lot || 'N/A',
                        cat1Display,
                        cat5Display,
                        pviDisplay,
                        categoryTestValue,
                        pviValue,
                        testCompletionStatus,
                        // Then all other fields
                        buildingAddress,
                        mostRecentDisplay,
                        activeViolations.length,
                        violationNumbers || 'N/A',
                        violationIssueDates || 'N/A',
                        violationStatuses || 'N/A',
                        violationTypes || 'N/A',
                        violationDescriptions || 'N/A',
                        deviceInfo?.elevator_manufacturer || 'N/A',
                        deviceInfo?.machine_type || 'N/A',
                        deviceInfo?.governor || 'N/A',
                        deviceInfo?.car_buffer_type || 'N/A',
                        deviceInfo?.mode_of_operation || 'N/A',
                        deviceInfo?.car_safety_type || 'N/A',
                        deviceInfo?.fire_emergency_phase || 'N/A',
                        deviceInfo?.working_pressure || 'N/A',
                        deviceInfo?.controller_manufacturer || 'N/A',
                        deviceInfo?.elevator_control || 'N/A',
                        deviceInfo?.elevator_capacity_lbs || 'N/A',
                        deviceInfo?.elevator_speed_fpm || 'N/A'
                    ].map(field => {
                        // Escape quotes and wrap in quotes
                        const fieldStr = String(field || '');
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }).join(',');
                    
                    return row;
                });

                // Wait for all promises to resolve
                const rows = await Promise.all(promises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `bin_${binNumber}_complete_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Restore button
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            }
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('binNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupDevices();
            }
        });

        // Add this new function to your script section
        function clearLookups() {
            // Clear input fields
            document.getElementById('deviceNumber').value = '';
            document.getElementById('binNumber').value = '';
            document.getElementById('houseNumber').value = '';
            document.getElementById('streetName').value = '';
            
            // Clear and hide result displays
            document.getElementById('binResult').innerHTML = '';
            document.getElementById('binResult').style.display = 'none';
            document.getElementById('deviceResult').innerHTML = '';
            document.getElementById('deviceResult').style.display = 'none';
            document.getElementById('addressResult').innerHTML = '';
            document.getElementById('addressResult').style.display = 'none';
            
            document.getElementById('binExportButton').style.display = 'none';
            document.getElementById('quickBinValue').textContent = '-'; // Add this line to clear the BIN in ELV3 Lookup
            window.lastBinSearchResults = null;
            
            // Also clear the Filing Information BIN field
            const filingBinInput = document.getElementById('binInput');
            if (filingBinInput) {
                filingBinInput.value = '';
                localStorage.removeItem('binInputInfo');
            }
        }

        // Helper function to update bulk lookup progress indicator
        function updateBulkProgress(processed, total, deviceTimes) {
            const progressText = document.getElementById('bulkProgressText');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressEstimate = document.getElementById('bulkProgressEstimate');
            
            if (!progressText || !progressBar || !progressEstimate) return;
            
            const percentage = Math.round((processed / total) * 100);
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Processing device ${processed} of ${total}...`;
            
            // Calculate estimated time remaining based on average time per device
            if (deviceTimes.length >= 3) {
                // Use the last 10 times for a more accurate recent average
                const recentTimes = deviceTimes.slice(-10);
                const avgTime = recentTimes.reduce((a, b) => a + b, 0) / recentTimes.length;
                const remainingDevices = total - processed;
                const estimatedMs = Math.round(avgTime * remainingDevices);
                
                if (estimatedMs > 60000) {
                    const minutes = Math.floor(estimatedMs / 60000);
                    const seconds = Math.round((estimatedMs % 60000) / 1000);
                    progressEstimate.textContent = `Estimated time remaining: ${minutes}m ${seconds}s`;
                } else if (estimatedMs > 1000) {
                    progressEstimate.textContent = `Estimated time remaining: ${Math.round(estimatedMs / 1000)}s`;
                } else {
                    progressEstimate.textContent = 'Almost done...';
                }
            } else {
                progressEstimate.textContent = 'Calculating estimated time...';
            }
        }

        // Add these new functions to your script section
        async function lookupBulkDevices() {
            const textarea = document.getElementById('bulkDeviceNumbers');
            const resultDiv = document.getElementById('bulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            // Create progress indicator HTML
            resultDiv.innerHTML = `
                <div id="bulkProgressContainer" style="padding: 20px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                    <div style="margin-bottom: 15px; text-align: center;">
                        <span id="bulkProgressText" style="color: var(--text-color); font-weight: 500; font-size: 1.1em;">
                            Preparing to look up ${deviceNumbers.length} devices...
                        </span>
                    </div>
                    <div style="background: var(--panel-bg); border-radius: 10px; height: 24px; overflow: hidden; border: 1px solid var(--input-border);">
                        <div id="bulkProgressBar" style="background: linear-gradient(90deg, #1a73e8, #4CAF50); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <span id="bulkProgressEstimate" style="color: var(--text-color); font-size: 0.9em; opacity: 0.8;">
                            Calculating estimated time...
                        </span>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];
                let processedCount = 0;
                const deviceTimes = []; // Track time per device for estimation

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const deviceStartTime = Date.now();
                    
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        // Fetch violations for this device
                        const violations = await fetchViolations(deviceNumber);
                        const activeViolations = violations.filter(v => 
                            v.violation_status?.toUpperCase() === 'ACTIVE' || 
                            v.violation_status?.toUpperCase() === 'OPEN');
                        
                        // Store violations with device
                        device.violations = activeViolations;
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: [],
                                latitude: device.latitude || null,
                                longitude: device.longitude || null
                            };
                        }
                        // Update lat/lng if this device has them and the group doesn't yet
                        if (!binGroups[bin].latitude && device.latitude) {
                            binGroups[bin].latitude = device.latitude;
                            binGroups[bin].longitude = device.longitude;
                        }
                        binGroups[bin].devices.push(device);
                        
                        processedCount++;
                        const deviceDuration = Date.now() - deviceStartTime;
                        deviceTimes.push(deviceDuration);
                        
                        // Update progress indicator
                        updateBulkProgress(processedCount, deviceNumbers.length, deviceTimes);
                    } else {
                        notFound.push(deviceNumber);
                        processedCount++;
                        const deviceDuration = Date.now() - deviceStartTime;
                        deviceTimes.push(deviceDuration);
                        
                        // Update progress indicator
                        updateBulkProgress(processedCount, deviceNumbers.length, deviceTimes);
                    }
                }

                    let html = `
                        <div style="background: var(--input-bg); padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                            <div style="font-size: 1.15em; font-weight: 600; color: var(--header-color);">
                                Total Devices Searched: 
                                <span style="color: var(--text-color);">${deviceNumbers.length}</span>
                            </div>
                        </div>
                `;

                // Generate building summary
                const buildingCount = Object.keys(binGroups).length;
                const totalViolationsAll = Object.values(binGroups).reduce((sum, group) =>
                    sum + group.devices.reduce((dSum, device) =>
                        dSum + (device.violations ? device.violations.length : 0), 0), 0);
                const buildingsWithViolations = Object.values(binGroups).filter(group =>
                    group.devices.some(device => device.violations && device.violations.length > 0)).length;
                
                // Create lists for clickable summary items
                const currentYear = new Date().getFullYear();
                const allBuildingsList = Object.entries(binGroups).map(([bin, group]) => ({
                    bin,
                    address: group.address,
                    deviceCount: group.devices.length,
                    violationCount: group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0),
                    devices: group.devices.map(d => {
                        const pviDate = d.periodic_latest_inspection ? new Date(d.periodic_latest_inspection) : null;
                        const cat1Date = d.cat1_latest_report_filed ? new Date(d.cat1_latest_report_filed) : null;
                        const cat5Date = d.cat5_latest_report_filed ? new Date(d.cat5_latest_report_filed) : null;
                        
                        // Check if all dates are the same (acceptance test indicator)
                        const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                            cat1Date.getTime() === cat5Date.getTime() &&
                            cat5Date.getTime() === pviDate.getTime();
                        
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        const deviceType = (d.device_type || '').toUpperCase();
                        const deviceStatus = (d.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                        const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                        const isConveyor = deviceType.includes('CONVEYOR');
                        const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                        const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                        const isEscalator = deviceType.includes('ESCALATOR');
                        const noTestRequired = isRemoved;
                        
                        // CAT 5 requirements
                        let requiresCat5 = false;
                        let nextCat5DueYear = null;
                        const cat5NotApplicable = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled || isRemoved;
                        if (!cat5NotApplicable && cat5Date) {
                            const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                            nextCat5DueYear = cat5Date.getFullYear() + 5;
                        }
                        
                        // Calculate eligibility
                        const testDates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentTestDate = testDates.length > 0 ? new Date(Math.max.apply(null, testDates)) : null;
                        let isReadyForTesting = false;
                        let eligibilityDate = null;
                        if (mostRecentTestDate) {
                            const daysSince = Math.floor((new Date() - mostRecentTestDate) / (1000 * 60 * 60 * 24));
                            isReadyForTesting = daysSince >= 91;
                            eligibilityDate = new Date(mostRecentTestDate);
                            eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                        }
                        
                        // Determine completion status
                        let completionStatus, completionColor;
                        if (noTestRequired) {
                            completionStatus = 'N/A'; completionColor = '#9e9e9e';
                        } else if (isConveyor && hasCat1ThisYear) {
                            completionStatus = 'Complete'; completionColor = '#4CAF50';
                        } else if (isDismantled && hasPVIThisYear) {
                            completionStatus = 'Complete'; completionColor = '#4CAF50';
                        } else if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                            completionStatus = 'CAT 5 Needed'; completionColor = '#ff9800';
                        } else if ((isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) && hasPVIThisYear && hasCat1ThisYear) {
                            completionStatus = 'Complete'; completionColor = '#4CAF50';
                        } else if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && !isDismantled) {
                            if (requiresCat5) {
                                if (hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear) {
                                    completionStatus = 'Complete'; completionColor = '#4CAF50';
                                } else {
                                    let missing = [];
                                    if (!hasPVIThisYear) missing.push('PVI');
                                    if (!hasCat1ThisYear) missing.push('CAT1');
                                    if (!hasCat5ThisYear) missing.push('CAT5');
                                    completionStatus = missing.join('+');
                                    completionColor = missing.length === 3 ? '#ff6b6b' : '#ffd700';
                                }
                            } else {
                                if (hasPVIThisYear && hasCat1ThisYear) {
                                    completionStatus = 'Complete'; completionColor = '#4CAF50';
                                } else {
                                    let missing = [];
                                    if (!hasPVIThisYear) missing.push('PVI');
                                    if (!hasCat1ThisYear) missing.push('CAT1');
                                    completionStatus = missing.join('+');
                                    completionColor = missing.length === 2 ? '#ff6b6b' : '#ffd700';
                                }
                            }
                        } else if (isDismantled && !hasPVIThisYear) {
                            completionStatus = 'PVI'; completionColor = '#ff6b6b';
                        } else if (isConveyor && !hasCat1ThisYear) {
                            completionStatus = 'CAT1'; completionColor = '#ff6b6b';
                        } else {
                            completionStatus = 'Incomplete'; completionColor = '#ff6b6b';
                        }
                        
                        return {
                            device_number: d.device_number,
                            device_type: d.device_type || 'Unknown',
                            device_status: d.device_status || 'N/A',
                            violationCount: d.violations ? d.violations.length : 0,
                            violations: d.violations || [],
                            pvi_date: pviDate ? pviDate.toLocaleDateString() : '‚Äî',
                            cat1_date: cat1Date ? cat1Date.toLocaleDateString() : '‚Äî',
                            cat5_date: cat5Date ? cat5Date.toLocaleDateString() : '‚Äî',
                            next_cat5: cat5NotApplicable ? 'N/A' : (nextCat5DueYear ? nextCat5DueYear : '‚Äî'),
                            completionStatus,
                            completionColor,
                            isReady: noTestRequired ? 'N/A' : (isReadyForTesting ? 'Yes' : 'No'),
                            isReadyColor: noTestRequired ? '#9e9e9e' : (isReadyForTesting ? '#4CAF50' : '#ff9800'),
                            eligibleDate: noTestRequired ? 'N/A' : (eligibilityDate ? eligibilityDate.toLocaleDateString() : '‚Äî'),
                            hasPVIThisYear,
                            hasCat1ThisYear,
                            hasCat5ThisYear,
                            requiresCat5,
                            nextCat5DueYear,
                            allDatesAreSame,
                            // Preserve raw date fields for getMissedRequiredTests function
                            cat5_latest_report_filed: d.cat5_latest_report_filed,
                            cat1_latest_report_filed: d.cat1_latest_report_filed,
                            periodic_latest_inspection: d.periodic_latest_inspection
                        };
                    })
                }));
                
                // Helper function to calculate device info for lists
                const calculateDeviceInfo = (d) => {
                    const pviDate = d.periodic_latest_inspection ? new Date(d.periodic_latest_inspection) : null;
                    const cat1Date = d.cat1_latest_report_filed ? new Date(d.cat1_latest_report_filed) : null;
                    const cat5Date = d.cat5_latest_report_filed ? new Date(d.cat5_latest_report_filed) : null;
                    
                    const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                    const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                    const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                    
                    const deviceType = (d.device_type || '').toUpperCase();
                    const deviceStatus = (d.device_status || '').toUpperCase();
                    const isDismantled = deviceStatus.includes('DISMANTLED');
                    const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                    const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                    const isConveyor = deviceType.includes('CONVEYOR');
                    const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                    const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                    const isEscalator = deviceType.includes('ESCALATOR');
                    const noTestRequired = isRemoved;
                    
                    let requiresCat5 = false;
                    let nextCat5DueYear = null;
                    const cat5NotApplicable = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled || isRemoved;
                    if (!cat5NotApplicable && cat5Date) {
                        const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                        requiresCat5 = yearsSinceCat5 >= 5;
                        nextCat5DueYear = cat5Date.getFullYear() + 5;
                    }
                    
                    const testDates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentTestDate = testDates.length > 0 ? new Date(Math.max.apply(null, testDates)) : null;
                    let isReadyForTesting = false;
                    let eligibilityDate = null;
                    if (mostRecentTestDate) {
                        const daysSince = Math.floor((new Date() - mostRecentTestDate) / (1000 * 60 * 60 * 24));
                        isReadyForTesting = daysSince >= 91;
                        eligibilityDate = new Date(mostRecentTestDate);
                        eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                    }
                    
                    let completionStatus, completionColor;
                    if (noTestRequired) {
                        completionStatus = 'N/A'; completionColor = '#9e9e9e';
                    } else if (isConveyor && hasCat1ThisYear) {
                        completionStatus = 'Complete'; completionColor = '#4CAF50';
                    } else if (isDismantled && hasPVIThisYear) {
                        completionStatus = 'Complete'; completionColor = '#4CAF50';
                    } else if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                        completionStatus = 'CAT 5 Needed'; completionColor = '#ff9800';
                    } else if ((isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) && hasPVIThisYear && hasCat1ThisYear) {
                        completionStatus = 'Complete'; completionColor = '#4CAF50';
                    } else if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && !isDismantled) {
                        if (requiresCat5) {
                            if (hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear) {
                                completionStatus = 'Complete'; completionColor = '#4CAF50';
                            } else {
                                let missing = [];
                                if (!hasPVIThisYear) missing.push('PVI');
                                if (!hasCat1ThisYear) missing.push('CAT1');
                                if (!hasCat5ThisYear) missing.push('CAT5');
                                completionStatus = missing.join('+');
                                completionColor = missing.length === 3 ? '#ff6b6b' : '#ffd700';
                            }
                        } else {
                            if (hasPVIThisYear && hasCat1ThisYear) {
                                completionStatus = 'Complete'; completionColor = '#4CAF50';
                            } else {
                                let missing = [];
                                if (!hasPVIThisYear) missing.push('PVI');
                                if (!hasCat1ThisYear) missing.push('CAT1');
                                completionStatus = missing.join('+');
                                completionColor = missing.length === 2 ? '#ff6b6b' : '#ffd700';
                            }
                        }
                    } else if (isDismantled && !hasPVIThisYear) {
                        completionStatus = 'PVI'; completionColor = '#ff6b6b';
                    } else if (isConveyor && !hasCat1ThisYear) {
                        completionStatus = 'CAT1'; completionColor = '#ff6b6b';
                    } else {
                        completionStatus = 'Incomplete'; completionColor = '#ff6b6b';
                    }
                    
                    return {
                        device_number: d.device_number,
                        device_type: d.device_type || 'Unknown',
                        device_status: d.device_status || 'N/A',
                        violationCount: d.violations ? d.violations.length : 0,
                        violations: d.violations || [],
                        pvi_date: pviDate ? pviDate.toLocaleDateString() : '‚Äî',
                        cat1_date: cat1Date ? cat1Date.toLocaleDateString() : '‚Äî',
                        cat5_date: cat5Date ? cat5Date.toLocaleDateString() : '‚Äî',
                        next_cat5: cat5NotApplicable ? 'N/A' : (nextCat5DueYear ? nextCat5DueYear : '‚Äî'),
                        completionStatus,
                        completionColor,
                        isReady: noTestRequired ? 'N/A' : (isReadyForTesting ? 'Yes' : 'No'),
                        isReadyColor: noTestRequired ? '#9e9e9e' : (isReadyForTesting ? '#4CAF50' : '#ff9800'),
                        eligibleDate: noTestRequired ? 'N/A' : (eligibilityDate ? eligibilityDate.toLocaleDateString() : '‚Äî'),
                        hasPVIThisYear,
                        hasCat1ThisYear,
                        hasCat5ThisYear,
                        requiresCat5,
                        nextCat5DueYear
                    };
                };
                
                // All Violations - grouped by building with device details
                const allViolationsList = Object.entries(binGroups)
                    .filter(([bin, group]) => group.devices.some(d => d.violations && d.violations.length > 0))
                    .map(([bin, group]) => {
                        // Collect all violation details
                        const violationDetails = [];
                        group.devices.forEach(device => {
                            if (device.violations && device.violations.length > 0) {
                                device.violations.forEach(v => {
                                    violationDetails.push({
                                        device_number: device.device_number,
                                        device_type: device.device_type || 'Unknown',
                                        violation_number: v.violation_number || 'N/A',
                                        violation_issue_date: v.violation_issue_date || v.violation_date || v.issue_date || 'N/A',
                                        violation_severity: v.violation_severity || v.violation_type || v.violation_category || 'N/A',
                                        violation_status: v.violation_status || 'N/A',
                                        violation_remarks: v.violation_remarks || v.violation_description || v.description || 'No description'
                                    });
                                });
                            }
                        });
                        
                        return {
                            bin,
                            address: group.address,
                            deviceCount: group.devices.length,
                            violationCount: group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0),
                            devicesWithViolations: group.devices.filter(d => d.violations && d.violations.length > 0).length,
                            devices: group.devices.filter(d => d.violations && d.violations.length > 0).map(calculateDeviceInfo),
                            allDevices: group.devices.map(calculateDeviceInfo),
                            violationDetails: violationDetails
                        };
                    });
                
                // Buildings with Violations - same format with full device info
                const buildingsWithViolationsList = Object.entries(binGroups)
                    .filter(([bin, group]) => group.devices.some(d => d.violations && d.violations.length > 0))
                    .map(([bin, group]) => {
                        // Collect violation details with device info
                        const violationDetails = [];
                        group.devices.forEach(device => {
                            if (device.violations && device.violations.length > 0) {
                                device.violations.forEach(v => {
                                    violationDetails.push({
                                        device_number: device.device_number,
                                        device_type: device.device_type || 'Unknown',
                                        violation_number: v.violation_number || 'N/A',
                                        violation_issue_date: v.violation_issue_date || v.violation_date || v.issue_date || 'N/A',
                                        violation_severity: v.violation_severity || v.violation_type || v.violation_category || 'N/A',
                                        violation_status: v.violation_status || 'N/A',
                                        violation_remarks: v.violation_remarks || v.violation_description || v.description || 'No description'
                                    });
                                });
                            }
                        });
                        
                        return {
                            bin,
                            address: group.address,
                            deviceCount: group.devices.length,
                            violationCount: group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0),
                            devicesWithViolations: group.devices.filter(d => d.violations && d.violations.length > 0).length,
                            devices: group.devices.map(calculateDeviceInfo),
                            violationDetails: violationDetails
                        };
                    });

                // Calculate test completion statistics for the current year (currentYear already declared above)
                let devicesWithBothTests = 0;
                let devicesWithOneTest = 0;
                let devicesWithNoTests = 0;
                let devicesNoTestRequired = 0;
                let devicesWithWarning = 0;
                let totalDevicesFound = 0;
                
                // Store device lists for each category
                const bulkDevicesWithBothTestsList = [];
                const bulkDevicesWithOneTestList = [];
                const bulkDevicesWithNoTestsList = [];
                const bulkDevicesNoTestRequiredList = [];
                const bulkDevicesWithWarningList = [];
                
                // 91-day testing eligibility lists
                const bulkDevicesReadyToTestList = [];
                const bulkDevicesNotReadyToTestList = [];
                let devicesReadyToTest = 0;
                let devicesNotReadyToTest = 0;
                
                // Important Information list (devices with data quality alerts or missed tests)
                const bulkDevicesWithImportantInfoList = [];
                let devicesWithImportantInfo = 0;

                // Count test completion across all devices
                Object.values(binGroups).forEach(group => {
                    group.devices.forEach(device => {
                        totalDevicesFound++;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        // Check device type and status (DELETED is treated as REMOVED)
                        const deviceType = (device.device_type || '').toUpperCase();
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                        const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                        const isConveyor = deviceType.includes('CONVEYOR');
                        const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                        const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                        const isEscalator = deviceType.includes('ESCALATOR');
                        
                        // Removed/deleted devices don't require any tests
                        if (isRemoved) {
                            devicesNoTestRequired++;
                            bulkDevicesNoTestRequiredList.push({
                                device_number: device.device_number,
                                device_type: device.device_type || 'Unknown',
                                address: `${device.house_number} ${device.street_name}`,
                                bin: device.bin
                            });
                            return;
                        }
                        
                        // Calculate 91-day testing eligibility
                        // For dismantled devices, only consider PVI date (that's all they need)
                        // For regular devices, consider all inspection dates
                        let mostRecentInspection;
                        if (isDismantled) {
                            mostRecentInspection = pviDate;
                        } else {
                            const allInspectionDates = [pviDate, cat1Date, cat5Date].filter(d => d !== null);
                            mostRecentInspection = allInspectionDates.length > 0 
                                ? new Date(Math.max(...allInspectionDates.map(d => d.getTime())))
                                : null;
                        }
                        
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        let eligibleTestDate = null;
                        let daysUntilEligible = null;
                        let isReadyToTest = true;
                        
                        if (mostRecentInspection) {
                            eligibleTestDate = new Date(mostRecentInspection);
                            eligibleTestDate.setDate(eligibleTestDate.getDate() + 91);
                            eligibleTestDate.setHours(0, 0, 0, 0);
                            
                            const timeDiff = eligibleTestDate.getTime() - today.getTime();
                            daysUntilEligible = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                            isReadyToTest = daysUntilEligible <= 0;
                        }
                        
                        const testingEligibilityInfo = {
                            device_number: device.device_number,
                            device_type: device.device_type || 'Unknown',
                            address: `${device.house_number} ${device.street_name}`,
                            bin: device.bin,
                            buildingAddress: group.address,
                            mostRecentInspection: mostRecentInspection,
                            eligibleTestDate: eligibleTestDate,
                            daysUntilEligible: daysUntilEligible,
                            isReadyToTest: isReadyToTest,
                            isDismantled: isDismantled
                        };
                        
                        // Add all devices to testing eligibility lists (including dismantled - they need PVI)
                        if (isReadyToTest) {
                            devicesReadyToTest++;
                            bulkDevicesReadyToTestList.push(testingEligibilityInfo);
                        } else {
                            devicesNotReadyToTest++;
                            bulkDevicesNotReadyToTestList.push(testingEligibilityInfo);
                        }
                        
                        // CAT 5 is only required every 5 years (Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators don't need CAT 5)
                        let requiresCat5 = false;
                        let yearsSinceCat5 = null;
                        if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                            yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                        }
                        
                        // Determine if all required tests are completed this year
                        // Regular elevators need: PVI + CAT 1 every year, and CAT 5 every 5 years
                        let allTestsCompleted = false;
                        if (isDismantled) {
                            // Dismantled devices only need PVI
                            allTestsCompleted = hasPVIThisYear;
                        } else if (isConveyor) {
                            // Conveyors only need CAT 1 (no PVI required)
                            allTestsCompleted = hasCat1ThisYear;
                        } else if (isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) {
                            // Dumbwaiters, Wheelchair Lifts, Hydraulic elevators, and Escalators need PVI + CAT 1 (no CAT 5)
                            allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                        } else if (requiresCat5) {
                            // Regular elevator with CAT 5 required - need PVI + CAT 1 + CAT 5
                            allTestsCompleted = hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear;
                        } else {
                            // Regular elevator, CAT 5 not required - need PVI + CAT 1
                            allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                        }
                        
                        // Check for Warning case: CAT 1 & PVI done but CAT 5 required and not done
                        const isWarningDevice = requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear;
                        
                        // Conveyors only need CAT 1 testing (no PVI required)
                        const conveyorCompleted = isConveyor && hasCat1ThisYear;
                        const bothTestsCompleted = allTestsCompleted;
                        const dismantledCompleted = isDismantled && hasPVIThisYear;
                        
                        // Check if all dates are the same (potential acceptance test indicator)
                        const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                            cat1Date.getTime() === cat5Date.getTime() &&
                            cat5Date.getTime() === pviDate.getTime();
                        
                        // Get missed tests for this device
                        const missedTests = getMissedRequiredTests(device);
                        
                        const deviceInfo = {
                            device_number: device.device_number,
                            device_type: device.device_type || 'Unknown',
                            address: `${device.house_number} ${device.street_name}`,
                            buildingAddress: group.address,
                            bin: device.bin,
                            hasPVI: hasPVIThisYear,
                            hasCat1: hasCat1ThisYear,
                            hasCat5: hasCat5ThisYear,
                            hasCategory: hasCat1ThisYear,
                            isDismantled: isDismantled,
                            isDumbwaiter: isDumbwaiter,
                            isConveyor: isConveyor,
                            isWheelchairLift: isWheelchairLift,
                            isHydraulic: isHydraulic,
                            isEscalator: isEscalator,
                            requiresCat5: requiresCat5,
                            yearsSinceCat5: yearsSinceCat5,
                            allDatesAreSame: allDatesAreSame,
                            missedTests: missedTests,
                            // Store raw device data for getMissedRequiredTests
                            cat1_latest_report_filed: device.cat1_latest_report_filed,
                            cat5_latest_report_filed: device.cat5_latest_report_filed,
                            periodic_latest_inspection: device.periodic_latest_inspection,
                            device_status: device.device_status
                        };
                        
                        // Track devices with Important Information
                        if (allDatesAreSame || missedTests.length > 0) {
                            devicesWithImportantInfo++;
                            bulkDevicesWithImportantInfoList.push(deviceInfo);
                        }
                        
                        if (isWarningDevice) {
                            devicesWithWarning++;
                            bulkDevicesWithWarningList.push(deviceInfo);
                        } else if (conveyorCompleted || bothTestsCompleted || dismantledCompleted) {
                            devicesWithBothTests++;
                            bulkDevicesWithBothTestsList.push(deviceInfo);
                        } else if (hasPVIThisYear || hasCat1ThisYear) {
                            devicesWithOneTest++;
                            bulkDevicesWithOneTestList.push(deviceInfo);
                        } else {
                            devicesWithNoTests++;
                            bulkDevicesWithNoTestsList.push(deviceInfo);
                        }
                    });
                });

                // Fetch permit information for all devices
                const bulkPermitsList = [];
                let totalPermitsCount = 0;
                
                // Get all unique device numbers from the search
                const allDeviceNumbers = Object.values(binGroups).flatMap(group => 
                    group.devices.map(d => ({
                        device_number: d.device_number,
                        bin: d.bin,
                        address: `${d.house_number} ${d.street_name}`
                    }))
                );
                
                // Fetch permits for all devices (in batches to avoid overwhelming the API)
                const permitPromises = allDeviceNumbers.map(async (deviceInfo) => {
                    try {
                        const result = await fetchPermitInfo(deviceInfo.device_number);
                        if (result.success && result.permits && result.permits.length > 0) {
                            return result.permits.map(permit => ({
                                ...permit,
                                device_number: deviceInfo.device_number,
                                bin: deviceInfo.bin,
                                address: deviceInfo.address
                            }));
                        }
                        return [];
                    } catch (error) {
                        console.error(`Error fetching permits for ${deviceInfo.device_number}:`, error);
                        return [];
                    }
                });
                
                try {
                    const permitResults = await Promise.all(permitPromises);
                    permitResults.forEach(permits => {
                        bulkPermitsList.push(...permits);
                    });
                    totalPermitsCount = bulkPermitsList.length;
                } catch (error) {
                    console.error('Error fetching permit data:', error);
                }

                // Store device lists in global variable for modal access
                window.bulkDeviceLists = {
                    bothTests: bulkDevicesWithBothTestsList,
                    oneTest: bulkDevicesWithOneTestList,
                    warning: bulkDevicesWithWarningList,
                    noTests: bulkDevicesWithNoTestsList,
                    noTestRequired: bulkDevicesNoTestRequiredList,
                    readyToTest: bulkDevicesReadyToTestList,
                    notReadyToTest: bulkDevicesNotReadyToTestList,
                    allBuildings: allBuildingsList,
                    allViolations: allViolationsList,
                    buildingsWithViolations: buildingsWithViolationsList,
                    importantInfo: bulkDevicesWithImportantInfoList,
                    permits: bulkPermitsList
                };

                // Sort buildings by violations (those with violations first)
                const sortedBinEntries = Object.entries(binGroups).sort((a, b) => {
                    const aViolations = a[1].devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                    const bViolations = b[1].devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                    return bViolations - aViolations;
                });

                // Pre-calculate ready/not ready for Building Breakdown table sorting
                const todayForBreakdown = new Date();
                todayForBreakdown.setHours(0, 0, 0, 0);
                
                const buildingBreakdownData = sortedBinEntries.map(([bin, group]) => {
                    let readyCount = 0;
                    let notReadyCount = 0;
                    
                    group.devices.forEach(device => {
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                        
                        if (isRemoved) return;
                        
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        let mostRecent;
                        if (isDismantled) {
                            mostRecent = pviDate;
                        } else {
                            const allDates = [pviDate, cat1Date, cat5Date].filter(d => d !== null);
                            mostRecent = allDates.length > 0 ? new Date(Math.max(...allDates.map(d => d.getTime()))) : null;
                        }
                        
                        if (mostRecent) {
                            const eligibleDate = new Date(mostRecent);
                            eligibleDate.setDate(eligibleDate.getDate() + 91);
                            eligibleDate.setHours(0, 0, 0, 0);
                            
                            if (eligibleDate <= todayForBreakdown) {
                                readyCount++;
                            } else {
                                notReadyCount++;
                            }
                        } else {
                            readyCount++;
                        }
                    });
                    
                    const violations = group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0);
                    const deviceNumbers = group.devices.map(d => d.device_number).join(' ');
                    
                    return { bin, group, readyCount, notReadyCount, violations, deviceNumbers };
                });
                
                // Sort Building Breakdown: All ready first, then some ready, then none ready
                buildingBreakdownData.sort((a, b) => {
                    const aAllReady = a.notReadyCount === 0 && a.readyCount > 0;
                    const bAllReady = b.notReadyCount === 0 && b.readyCount > 0;
                    const aSomeReady = a.readyCount > 0 && a.notReadyCount > 0;
                    const bSomeReady = b.readyCount > 0 && b.notReadyCount > 0;
                    
                    // Priority: All ready (0) > Some ready (1) > None ready (2)
                    const aPriority = aAllReady ? 0 : (aSomeReady ? 1 : 2);
                    const bPriority = bAllReady ? 0 : (bSomeReady ? 1 : 2);
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority;
                    }
                    
                    // Within same priority, sort by ready count descending
                    return b.readyCount - a.readyCount;
                });

                html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                Summary
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div onclick="toggleBulkTestList('allBuildings')" style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--header-color);">${buildingCount}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Buildings</div>
                                </div>
                                <div onclick="toggleBulkTestList('allViolations')" style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${totalViolationsAll > 0 ? '#ff6b6b' : '#4CAF50'};">${totalViolationsAll}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Total Violations</div>
                                </div>
                                <div onclick="toggleBulkTestList('buildingsWithViolations')" style="padding: 12px; background: var(--input-bg); border-radius: 6px; text-align: center; border: 1px solid var(--input-border); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${buildingsWithViolations > 0 ? '#ff6b6b' : '#4CAF50'};">${buildingsWithViolations}</div>
                                    <div style="font-size: 0.9em; color: var(--text-color);">Buildings w/ Violations</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px; padding: 15px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="font-size: 1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                    ${currentYear} Test Completion Status <span style="font-size: 0.8em; font-weight: 400; opacity: 0.7;">(click to view devices)</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                                    <div onclick="toggleBulkTestList('bothTests')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #4CAF50; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(76,175,80,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #4CAF50;">${devicesWithBothTests}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">‚úì All Tests Done</div>
                                    </div>
                                    <div onclick="toggleBulkTestList('oneTest')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ffd700; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,215,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ffd700;">${devicesWithOneTest}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">‚ö† One Test Done</div>
                                    </div>
                                    ${devicesWithWarning > 0 ? `
                                    <div onclick="toggleBulkTestList('warning')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ff9800; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,152,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ff9800;">${devicesWithWarning}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">‚ö† CAT 5 Required</div>
                                    </div>
                                    ` : ''}
                                    <div onclick="toggleBulkTestList('noTests')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ff6b6b; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #ff6b6b;">${devicesWithNoTests}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">‚úó No Tests Done</div>
                                    </div>
                                    ${devicesNoTestRequired > 0 ? `
                                    <div onclick="toggleBulkTestList('noTestRequired')" style="padding: 10px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #9e9e9e; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(158,158,158,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.3em; font-weight: 700; color: #9e9e9e;">${devicesNoTestRequired}</div>
                                        <div style="font-size: 0.75em; color: var(--text-color);">‚Äî No Test Required</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="font-size: 1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                    ${currentYear} Testing Status <span style="font-size: 0.8em; font-weight: 400; opacity: 0.7;">(91-day rule - click to view devices)</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                    <div onclick="toggleBulkTestList('readyToTest')" style="padding: 12px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #4CAF50; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(76,175,80,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.5em; font-weight: 700; color: #4CAF50;">${devicesReadyToTest}</div>
                                        <div style="font-size: 0.8em; color: var(--text-color);">‚úì Ready to Test</div>
                                    </div>
                                    <div onclick="toggleBulkTestList('notReadyToTest')" style="padding: 12px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #ff6b6b; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.5em; font-weight: 700; color: #ff6b6b;">${devicesNotReadyToTest}</div>
                                        <div style="font-size: 0.8em; color: var(--text-color);">‚úó Not Ready Yet</div>
                                    </div>
                                </div>
                            </div>
                            ${(devicesWithImportantInfo > 0 || totalPermitsCount > 0) ? `
                            <div style="margin-top: 15px; padding: 15px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--input-border);">
                                <div style="font-size: 1em; font-weight: 600; color: var(--header-color); margin-bottom: 12px;">
                                    Additional Information <span style="font-size: 0.8em; font-weight: 400; opacity: 0.7;">(click to view details)</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                    ${devicesWithImportantInfo > 0 ? `
                                    <div onclick="toggleBulkTestList('importantInfo')" style="padding: 12px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #e91e63; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(233,30,99,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.5em; font-weight: 700; color: #e91e63;">${devicesWithImportantInfo}</div>
                                        <div style="font-size: 0.8em; color: var(--text-color);">‚ö†Ô∏è Important Info</div>
                                    </div>
                                    ` : ''}
                                    ${totalPermitsCount > 0 ? `
                                    <div onclick="toggleBulkTestList('permits')" style="padding: 12px; background: var(--panel-bg); border-radius: 6px; text-align: center; border-left: 3px solid #2196F3; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(33,150,243,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                        <div style="font-size: 1.5em; font-weight: 700; color: #2196F3;">${totalPermitsCount}</div>
                                        <div style="font-size: 0.8em; color: var(--text-color);">üìã Permits</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 0.95em; font-weight: 600; color: var(--header-color); margin-top: 15px; margin-bottom: 12px;">Search</div>
                                <input type="text" 
                                       id="bulkResultsSearch" 
                                       placeholder="Search by address, BIN, or device number..."
                                       oninput="filterBulkResults(this.value)"
                                       style="width: 100%; padding: 10px 12px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 0.95em; box-sizing: border-box;">
                            </div>
                            <!-- Building Breakdown Section - Currently Hidden -->
                            <div style="display: none;">
                                <div style="font-size: 0.95em; font-weight: 600; color: var(--header-color); margin-bottom: 10px;">
                                    Building Breakdown:
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                        <thead>
                                            <tr style="background: var(--input-bg); position: sticky; top: 0;">
                                                <th style="padding: 8px 10px; text-align: left; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Address</th>
                                                <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Devices</th>
                                                <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Ready</th>
                                                <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Not Ready</th>
                                                <th style="padding: 8px 10px; text-align: center; color: var(--header-color); border-bottom: 2px solid var(--input-border);">Violations</th>
                                            </tr>
                                        </thead>
                                        <tbody id="summaryTableBody">
                                            ${buildingBreakdownData.map(item => `
                                                <tr class="summary-row" data-bin="${item.bin}" data-address="${item.group.address}" data-devices="${item.deviceNumbers}" style="border-bottom: 1px solid var(--input-border);">
                                                    <td style="padding: 8px 10px; color: var(--text-color);">${item.group.address}</td>
                                                    <td style="padding: 8px 10px; text-align: center; color: var(--text-color); font-weight: 500;">${item.group.devices.length}</td>
                                                    <td style="padding: 8px 10px; text-align: center; font-weight: 600; color: ${item.readyCount > 0 ? '#4CAF50' : 'var(--text-color)'};">${item.readyCount}</td>
                                                    <td style="padding: 8px 10px; text-align: center; font-weight: 600; color: ${item.notReadyCount > 0 ? '#ff6b6b' : 'var(--text-color)'};">${item.notReadyCount}</td>
                                                    <td style="padding: 8px 10px; text-align: center; font-weight: 600; color: ${item.violations > 0 ? '#ff6b6b' : '#4CAF50'};">${item.violations}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="buildingsContainer" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices (using sorted entries - same order as Building Breakdown)
                for (const item of buildingBreakdownData) {
                    const bin = item.bin;
                    const group = item.group;
                    // Count violations across all devices in this building
                    const totalViolations = group.devices.reduce((sum, device) => 
                        sum + (device.violations ? device.violations.length : 0), 0);
                    const deviceNumbers = group.devices.map(d => d.device_number).join(' ');
                    
                    html += `
                        <div class="building-card" data-bin="${bin}" data-address="${group.address}" data-devices="${deviceNumbers}" style="background: var(--panel-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                            <div onclick="toggleBuildingDevices('${bin}')" style="cursor: pointer; padding-bottom: 15px; border-bottom: 2px solid var(--input-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.1em; margin-bottom: 8px;">
                                            <strong style="color: var(--header-color); font-size: 1.2em;">Address:</strong> 
                                            <span style="font-weight: 600; color: var(--text-color);">${group.address}</span>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong style="color: var(--header-color);">BIN:</strong> 
                                            <span style="color: var(--text-color);">${bin}</span>
                                        </div>
                                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                            <div>
                                                <strong style="color: var(--header-color);">Devices:</strong> 
                                                <span style="color: var(--text-color); font-weight: 600;">${group.devices.length}</span>
                                            </div>
                                            <div>
                                                <strong style="color: var(--header-color);">Ready:</strong> 
                                                <span style="color: ${item.readyCount > 0 ? '#4CAF50' : 'var(--text-color)'}; font-weight: 600;">${item.readyCount}</span>
                                            </div>
                                            <div>
                                                <strong style="color: var(--header-color);">Not Ready:</strong> 
                                                <span style="color: ${item.notReadyCount > 0 ? '#ff6b6b' : 'var(--text-color)'}; font-weight: 600;">${item.notReadyCount}</span>
                                            </div>
                                            <div>
                                                <strong style="color: var(--header-color);">Active Violations:</strong> 
                                                <span style="color: ${totalViolations > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${totalViolations}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <button onclick="event.stopPropagation(); openBuildingPopup('${bin}')" 
                                                style="width: 36px; height: 36px; background: var(--header-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
                                                onmouseover="this.style.opacity='0.8'; this.style.transform='scale(1.1)';"
                                                onmouseout="this.style.opacity='1'; this.style.transform='scale(1)';"
                                                title="Open in full-screen view">
                                            ‚õ∂
                                        </button>
                                        <div id="buildingArrow_${bin}" style="font-size: 1.5em; color: var(--header-color); transition: transform 0.3s ease; transform: rotate(0deg);">
                                            ‚ñº
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="buildingDevices_${bin}" style="display: none; margin-top: 15px;">
                    `;

                    // Sort devices: Active devices first (removed/deleted at bottom), then not ready first, then by violations
                    const todayForSort = new Date();
                    todayForSort.setHours(0, 0, 0, 0);
                    
                    const sortedDevices = [...group.devices].sort((a, b) => {
                        // Calculate readiness for device A (DELETED is treated as REMOVED)
                        const aStatus = (a.device_status || '').toUpperCase();
                        const aIsDismantled = aStatus.includes('DISMANTLED');
                        const aIsRemoved = aStatus.includes('REMOVED') || aStatus.includes('DELETED');
                        
                        let aIsReady = true;
                        if (!aIsRemoved) {
                            const aPviDate = a.periodic_latest_inspection ? new Date(a.periodic_latest_inspection) : null;
                            const aCat1Date = a.cat1_latest_report_filed ? new Date(a.cat1_latest_report_filed) : null;
                            const aCat5Date = a.cat5_latest_report_filed ? new Date(a.cat5_latest_report_filed) : null;
                            
                            let aMostRecent;
                            if (aIsDismantled) {
                                aMostRecent = aPviDate;
                            } else {
                                const aDates = [aPviDate, aCat1Date, aCat5Date].filter(d => d !== null);
                                aMostRecent = aDates.length > 0 ? new Date(Math.max(...aDates.map(d => d.getTime()))) : null;
                            }
                            
                            if (aMostRecent) {
                                const aEligible = new Date(aMostRecent);
                                aEligible.setDate(aEligible.getDate() + 91);
                                aEligible.setHours(0, 0, 0, 0);
                                aIsReady = aEligible <= todayForSort;
                            }
                        }
                        
                        // Calculate readiness for device B (DELETED is treated as REMOVED)
                        const bStatus = (b.device_status || '').toUpperCase();
                        const bIsDismantled = bStatus.includes('DISMANTLED');
                        const bIsRemoved = bStatus.includes('REMOVED') || bStatus.includes('DELETED');
                        
                        let bIsReady = true;
                        if (!bIsRemoved) {
                            const bPviDate = b.periodic_latest_inspection ? new Date(b.periodic_latest_inspection) : null;
                            const bCat1Date = b.cat1_latest_report_filed ? new Date(b.cat1_latest_report_filed) : null;
                            const bCat5Date = b.cat5_latest_report_filed ? new Date(b.cat5_latest_report_filed) : null;
                            
                            let bMostRecent;
                            if (bIsDismantled) {
                                bMostRecent = bPviDate;
                            } else {
                                const bDates = [bPviDate, bCat1Date, bCat5Date].filter(d => d !== null);
                                bMostRecent = bDates.length > 0 ? new Date(Math.max(...bDates.map(d => d.getTime()))) : null;
                            }
                            
                            if (bMostRecent) {
                                const bEligible = new Date(bMostRecent);
                                bEligible.setDate(bEligible.getDate() + 91);
                                bEligible.setHours(0, 0, 0, 0);
                                bIsReady = bEligible <= todayForSort;
                            }
                        }
                        
                        // Primary sort: Removed/deleted devices go to the bottom
                        if (aIsRemoved !== bIsRemoved) {
                            return aIsRemoved ? 1 : -1; // Removed devices last
                        }
                        
                        // Secondary sort: Not ready devices first (aIsReady=false should come before aIsReady=true)
                        if (aIsReady !== bIsReady) {
                            return aIsReady ? 1 : -1; // Not ready (false) comes first
                        }
                        
                        // Tertiary sort by violations
                        const aViolations = a.violations ? a.violations.length : 0;
                        const bViolations = b.violations ? b.violations.length : 0;
                        return bViolations - aViolations;
                    });

                    // Excel-style table header
                    html += `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;">
                                <thead>
                                    <tr style="background: var(--panel-bg); border-bottom: 2px solid var(--input-border);">
                                        <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Device #</th>
                                        <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Type</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Status</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">PVI</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 1</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">CAT 5</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Next CAT 5</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">${currentYear} Status</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Ready</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Eligible Date</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--header-color); border: 1px solid var(--input-border); white-space: nowrap;">Violations</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    sortedDevices.forEach((device, index) => {
                        // Calculate test completion status for this device
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        
                        const pviDisplay = pviDate ? pviDate.toLocaleDateString() : '‚Äî';
                        const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : '‚Äî';
                        const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : '‚Äî';
                        
                        // Check if all dates are the same (CAT 1, CAT 5, and PVI) - acceptance test indicator
                        const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                            cat1Date.getTime() === cat5Date.getTime() &&
                            cat5Date.getTime() === pviDate.getTime();
                        
                        const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                        const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                        
                        // Check device type and status (DELETED is treated as REMOVED)
                        const deviceType = (device.device_type || '').toUpperCase();
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                        const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                        const isConveyor = deviceType.includes('CONVEYOR');
                        const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                        const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                        const isEscalator = deviceType.includes('ESCALATOR');
                        const noTestRequired = isRemoved;
                        
                        // CAT 5 requirements
                        let requiresCat5 = false;
                        let yearsSinceCat5 = null;
                        let nextCat5DueYear = null;
                        const cat5NotApplicable = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled || isRemoved;
                        if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                            yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                            requiresCat5 = yearsSinceCat5 >= 5;
                            nextCat5DueYear = cat5Date.getFullYear() + 5;
                        }
                        
                        // Calculate test eligibility based on 91-day rule
                        const testDates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                        const mostRecentTestDate = testDates.length > 0 ? new Date(Math.max.apply(null, testDates)) : null;
                        const today = new Date();
                        let isReadyForTesting = false;
                        let daysSinceLastTest = null;
                        let eligibilityDate = null;
                        let daysUntilEligible = null;
                        
                        if (mostRecentTestDate) {
                            const timeDiff = today - mostRecentTestDate;
                            daysSinceLastTest = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                            isReadyForTesting = daysSinceLastTest >= 91;
                            eligibilityDate = new Date(mostRecentTestDate);
                            eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                            if (!isReadyForTesting) {
                                daysUntilEligible = 91 - daysSinceLastTest;
                            }
                        }
                        
                        // Determine completion status
                        let completionStatus, completionColor;
                        if (noTestRequired) {
                            completionStatus = 'N/A';
                            completionColor = '#9e9e9e';
                        } else if (isConveyor && hasCat1ThisYear) {
                            completionStatus = 'Complete';
                            completionColor = '#4CAF50';
                        } else if (isDismantled && hasPVIThisYear) {
                            completionStatus = 'Complete';
                            completionColor = '#4CAF50';
                        } else if (requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear) {
                            completionStatus = 'CAT 5 Needed';
                            completionColor = '#ff9800';
                        } else if ((isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) && hasPVIThisYear && hasCat1ThisYear) {
                            completionStatus = 'Complete';
                            completionColor = '#4CAF50';
                        } else if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && !isDismantled) {
                            if (requiresCat5) {
                                if (hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear) {
                                    completionStatus = 'Complete';
                                    completionColor = '#4CAF50';
                            } else {
                                    let missing = [];
                                    if (!hasPVIThisYear) missing.push('PVI');
                                    if (!hasCat1ThisYear) missing.push('CAT1');
                                    if (!hasCat5ThisYear) missing.push('CAT5');
                                    completionStatus = missing.join('+');
                                    completionColor = missing.length === 3 ? '#ff6b6b' : '#ffd700';
                                }
                            } else {
                                if (hasPVIThisYear && hasCat1ThisYear) {
                                    completionStatus = 'Complete';
                                    completionColor = '#4CAF50';
                                } else {
                                    let missing = [];
                                    if (!hasPVIThisYear) missing.push('PVI');
                                    if (!hasCat1ThisYear) missing.push('CAT1');
                                    completionStatus = missing.join('+');
                                    completionColor = missing.length === 2 ? '#ff6b6b' : '#ffd700';
                                }
                            }
                        } else if (isDismantled && !hasPVIThisYear) {
                            completionStatus = 'PVI';
                            completionColor = '#ff6b6b';
                        } else if (isConveyor && !hasCat1ThisYear) {
                            completionStatus = 'CAT1';
                            completionColor = '#ff6b6b';
                        } else {
                            completionStatus = 'Incomplete';
                            completionColor = '#ff6b6b';
                        }
                        
                        const violationCount = device.violations ? device.violations.length : 0;
                        const rowBg = index % 2 === 0 ? 'var(--input-bg)' : 'var(--panel-bg)';
                        const eligibilityDisplay = mostRecentTestDate ? eligibilityDate.toLocaleDateString() : '‚Äî';
                        const nextCat5Display = cat5NotApplicable ? 'N/A' : (nextCat5DueYear ? nextCat5DueYear : (cat5Date ? cat5Date.getFullYear() + 5 : '‚Äî'));
                        
                        html += `
                            <tr style="background: ${rowBg};" class="device-row" data-device="${device.device_number}">
                                <td style="padding: 8px; border: 1px solid var(--input-border); font-weight: 600; color: ${allDatesAreSame ? '#ff6b6b' : 'var(--text-color)'};">${device.device_number}${allDatesAreSame ? ' ‚ö†Ô∏è' : ''}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); color: var(--text-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${device.device_type || 'N/A'}">${device.device_type || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: var(--text-color);">${device.device_status || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${hasPVIThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${hasPVIThisYear ? '600' : '400'};">${pviDisplay}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${hasCat1ThisYear ? '#4CAF50' : 'var(--text-color)'}; font-weight: ${hasCat1ThisYear ? '600' : '400'};">${cat1Display}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${hasCat5ThisYear ? '#4CAF50' : (requiresCat5 ? '#ff9800' : 'var(--text-color)')}; font-weight: ${hasCat5ThisYear || requiresCat5 ? '600' : '400'};">${cat5Display}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${nextCat5DueYear && nextCat5DueYear <= currentYear ? '#ff9800' : 'var(--text-color)'}; font-weight: ${nextCat5DueYear && nextCat5DueYear <= currentYear ? '600' : '400'};">${nextCat5Display}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${completionColor}; font-weight: 600;">${completionStatus}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${isReadyForTesting ? '#4CAF50' : '#ff9800'}; font-weight: 600;">${noTestRequired ? 'N/A' : (isReadyForTesting ? 'Yes' : 'No')}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: var(--text-color);">${noTestRequired ? 'N/A' : eligibilityDisplay}</td>
                                <td style="padding: 8px; border: 1px solid var(--input-border); text-align: center; color: ${violationCount > 0 ? '#ff6b6b' : '#4CAF50'}; font-weight: 600;">${violationCount}</td>
                            </tr>
                        `;
                        
                        // Add expandable violation details row if there are violations
                        if (violationCount > 0) {
                            html += `
                                <tr style="background: ${rowBg};">
                                    <td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">
                                        <details style="margin: 0;">
                                            <summary style="padding: 8px 12px; cursor: pointer; color: #ff6b6b; font-weight: 500; font-size: 0.9em;">
                                                View ${violationCount} violation${violationCount > 1 ? 's' : ''}
                                            </summary>
                                            <div style="padding: 10px 15px; background: var(--panel-bg);">
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                                    <thead>
                                                        <tr style="background: var(--input-bg);">
                                                            <th style="padding: 6px 8px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color);">Violation #</th>
                                                            <th style="padding: 6px 8px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color);">Issue Date</th>
                                                            <th style="padding: 6px 8px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color);">Severity</th>
                                                            <th style="padding: 6px 8px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color);">Status</th>
                                                            <th style="padding: 6px 8px; text-align: left; border: 1px solid var(--input-border); color: var(--header-color);">Description</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                            `;
                            
                            device.violations.forEach(v => {
                                const issueDate = v.violation_issue_date || v.violation_date;
                                const formattedDate = issueDate ? new Date(issueDate).toLocaleDateString() : '‚Äî';
                                const description = v.violation_description || v.violation_remarks || '‚Äî';
                                const truncatedDesc = description.length > 100 ? description.substring(0, 100) + '...' : description;
                                
                                html += `
                                    <tr>
                                        <td style="padding: 6px 8px; border: 1px solid var(--input-border); color: var(--text-color);">${v.violation_number || '‚Äî'}</td>
                                        <td style="padding: 6px 8px; border: 1px solid var(--input-border); color: var(--text-color);">${formattedDate}</td>
                                        <td style="padding: 6px 8px; border: 1px solid var(--input-border); color: var(--text-color);">${v.violation_severity || '‚Äî'}</td>
                                        <td style="padding: 6px 8px; border: 1px solid var(--input-border); color: ${v.violation_status?.toUpperCase() === 'ACTIVE' ? '#ff6b6b' : 'var(--text-color)'};">${v.violation_status || '‚Äî'}</td>
                                        <td style="padding: 6px 8px; border: 1px solid var(--input-border); color: var(--text-color); max-width: 300px;" title="${description}">${truncatedDesc}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                                    </tbody>
                                                </table>
                                    </div>
                                        </details>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        // Add Important dropdown row if all dates are the same
                        if (allDatesAreSame) {
                            html += `
                                <tr style="background: ${rowBg};">
                                    <td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">
                                        <details style="margin: 0;">
                                            <summary style="padding: 8px 12px; cursor: pointer; color: #ff6b6b; font-weight: 600; font-size: 0.9em; background: rgba(255, 107, 107, 0.1);">
                                                ‚ö†Ô∏è Important - Data Quality Alert
                                            </summary>
                                            <div style="padding: 12px 15px; background: rgba(255, 107, 107, 0.1); border-top: 1px solid #ff6b6b;">
                                                <div style="color: var(--text-color); font-size: 0.9em;">
                                                    This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection tests are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                                </div>
                                            </div>
                                        </details>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        // Add Important dropdown row for missed required tests
                        const missedTests = getMissedRequiredTests(device);
                        if (missedTests.length > 0) {
                            // Check for removal permits for this device
                            let removalPermitNote = '';
                            const allPermits = window.bulkDeviceLists?.permits || [];
                            const devicePermits = allPermits.filter(p => p.device_number === device.device_number);
                            if (devicePermits.length > 0) {
                                const removalPermit = devicePermits.find(p => {
                                    const workType = (p.work_type || '').toUpperCase();
                                    const description = (p.description || '').toUpperCase();
                                    const appType = (p.application_type || '').toUpperCase();
                                    return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                           workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                           description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                           description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                           appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                });
                                if (removalPermit) {
                                    const permitNum = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                    removalPermitNote = `
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                            <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                                üìã Removal Permit Found${permitNum ? ': ' + permitNum : ''}
                                            </div>
                                            <div style="font-size: 0.85em; opacity: 0.9;">
                                                Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                            
                            const missedTestsList = missedTests.map(mt => 
                                `<div style="margin-bottom: 6px; padding: 6px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                    <strong style="color: #ff9800;">${mt.test}</strong> missed in <strong>${mt.year}</strong>
                                    <br><span style="font-size: 0.85em; opacity: 0.8;">Last: ${mt.lastTestDate}</span>
                                </div>`
                            ).join('');
                            html += `
                                <tr style="background: ${rowBg};">
                                    <td colspan="11" style="padding: 0; border: 1px solid var(--input-border);">
                                        <details style="margin: 0;">
                                            <summary style="padding: 8px 12px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.9em; background: rgba(255, 152, 0, 0.1);">
                                                ‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                            </summary>
                                            <div style="padding: 12px 15px; background: rgba(255, 152, 0, 0.1); border-top: 1px solid #ff9800;">
                                                <div style="color: var(--text-color); font-size: 0.9em;">
                                                    ${missedTestsList}
                                                    <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">CAT 1 and PVI are required annually. CAT 5 every 5 years.</div>
                                                    ${removalPermitNote}
                                                </div>
                                            </div>
                                        </details>
                                    </td>
                                </tr>
                            `;
                        }
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: var(--panel-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; margin-top: 20px; border: 2px solid #ff6b6b; border-left: 4px solid #ff6b6b; box-shadow: 0 2px 4px var(--card-shadow);">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: var(--header-color); font-size: 1.1em;">Devices Not Found:</strong>
                                <span style="color: #ff6b6b; font-weight: 600; margin-left: 8px;">${notFound.length}</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                ${notFound.map(deviceNum => `
                                    <span style="display: inline-block; padding: 6px 12px; background: var(--input-bg); border-radius: 4px; border: 1px solid #ff6b6b; color: #ff6b6b; font-weight: 500; font-family: monospace;">
                                        ${deviceNum}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button and map button if we have results
                document.getElementById('exportButton').style.display = 'block';
                document.getElementById('mapButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearBulkLookup() {
            document.getElementById('bulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('bulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            document.getElementById('mapButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Map functionality for bulk device lookup
        let buildingMap = null;
        let mapMarkers = [];

        // Favorites, Hidden Buildings, Month Labels, and Additional Locations Storage
        const MAP_FAVORITES_KEY = 'elv3_map_favorites';
        const MAP_HIDDEN_KEY = 'elv3_map_hidden';
        const MAP_MONTH_LABELS_KEY = 'elv3_map_month_labels';
        const MAP_ADDITIONAL_LOCATIONS_KEY = 'elv3_map_additional_locations';
        
        // Additional locations storage
        let additionalLocationMarkers = [];
        
        function getAdditionalLocations() {
            try {
                return JSON.parse(localStorage.getItem(MAP_ADDITIONAL_LOCATIONS_KEY)) || [];
            } catch (e) {
                return [];
            }
        }
        
        function setAdditionalLocations(locations) {
            try {
                localStorage.setItem(MAP_ADDITIONAL_LOCATIONS_KEY, JSON.stringify(locations));
            } catch (e) {
                console.error('Error saving additional locations:', e);
            }
        }
        
        async function addAdditionalLocation() {
            const input = document.getElementById('additionalLocationInput');
            const searchTerm = input.value.trim();
            
            if (!searchTerm) {
                showMapNotification('Please enter an address, BIN, or device number', '#ff6b6b');
                return;
            }
            
            // Show loading state
            const originalValue = input.value;
            input.value = 'Looking up...';
            input.disabled = true;
            
            let locationAdded = false;
            
            try {
                let location = null;
                
                // Check if it's a BIN number (numeric, 6-7 digits)
                if (/^\d{6,7}$/.test(searchTerm)) {
                    location = await lookupLocationByBin(searchTerm);
                }
                // Check if it's a device number (format: XXXX-XXXX or similar)
                else if (/^[A-Z0-9]+-[A-Z0-9]+/.test(searchTerm.toUpperCase())) {
                    location = await lookupLocationByDevice(searchTerm);
                }
                // Otherwise treat as address
                else {
                    location = await lookupLocationByAddress(searchTerm);
                }
                
                if (location) {
                    const locations = getAdditionalLocations();
                    // Check if location already exists
                    const exists = locations.some(loc => 
                        loc.latitude === location.latitude && 
                        loc.longitude === location.longitude
                    );
                    
                    if (exists) {
                        showMapNotification('This location is already on the map', '#ff6b6b');
                        input.value = originalValue; // Restore original value
                    } else {
                        locations.push(location);
                        setAdditionalLocations(locations);
                        input.value = ''; // Clear input on success
                        locationAdded = true;
                        showMapNotification(`Added location: ${location.label}`, '#00bcd4');
                        
                        // Update the controls panel
                        updateAdditionalLocationsPanel();
                        
                        // Refresh map if it's open
                        if (buildingMap && window.lastBulkSearchResults) {
                            initBuildingMap(window.lastBulkSearchResults.binGroups, true);
                        }
                    }
                } else {
                    showMapNotification('Could not find location. Please check the address, BIN, or device number.', '#ff6b6b');
                    input.value = originalValue; // Restore original value
                }
            } catch (error) {
                console.error('Error adding location:', error);
                showMapNotification('Error looking up location. Please try again.', '#ff6b6b');
                input.value = originalValue; // Restore original value
            } finally {
                input.disabled = false;
                input.focus();
            }
        }
        
        async function lookupLocationByBin(bin) {
            try {
                // Use NYC open data to get all devices for this BIN
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$where=bin='${bin}'`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const building = data[0];
                    const address = `${building.house_number} ${building.street_name}, ${building.borough}`;
                    
                    // Fetch violations for all devices
                    const devicesWithViolations = await Promise.all(data.map(async (device) => {
                        const violations = await fetchViolations(device.device_number);
                        const activeViolations = violations.filter(v => 
                            v.violation_status?.toUpperCase() === 'ACTIVE' || 
                            v.violation_status?.toUpperCase() === 'OPEN');
                        return {
                            ...device,
                            violations: activeViolations
                        };
                    }));
                    
                    // Try to get coordinates from the API response
                    if (building.latitude && building.longitude) {
                        return {
                            label: address,
                            latitude: parseFloat(building.latitude),
                            longitude: parseFloat(building.longitude),
                            bin: bin,
                            type: 'bin',
                            devices: devicesWithViolations
                        };
                    }
                    
                    // If no coordinates, try geocoding the address
                    const location = await geocodeAddress(address, bin);
                    if (location) {
                        location.devices = devicesWithViolations;
                    }
                    return location;
                }
                return null;
            } catch (error) {
                console.error('Error looking up BIN:', error);
                return null;
            }
        }
        
        async function lookupLocationByDevice(deviceNumber) {
            try {
                // Use NYC open data to get device info
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$where=UPPER(device_number)='${deviceNumber.toUpperCase()}'&$limit=1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const address = `${device.house_number} ${device.street_name}, ${device.borough}`;
                    
                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    const deviceWithViolations = {
                        ...device,
                        violations: activeViolations
                    };
                    
                    // Try to get coordinates from the API response
                    if (device.latitude && device.longitude) {
                        return {
                            label: `${address} (Device: ${deviceNumber})`,
                            latitude: parseFloat(device.latitude),
                            longitude: parseFloat(device.longitude),
                            bin: device.bin,
                            deviceNumber: deviceNumber,
                            type: 'device',
                            devices: [deviceWithViolations]
                        };
                    }
                    
                    // If no coordinates, try geocoding the address
                    const location = await geocodeAddress(address, device.bin, deviceNumber);
                    if (location) {
                        location.devices = [deviceWithViolations];
                    }
                    return location;
                }
                return null;
            } catch (error) {
                console.error('Error looking up device:', error);
                return null;
            }
        }
        
        async function lookupLocationByAddress(address) {
            try {
                // Parse address into components
                const addressParts = address.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';
                
                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    // Try geocoding the full address as-is
                    return await geocodeAddress(address);
                }
                
                const [_, houseNumber, streetName] = match;
                
                // Build query
                const escapeQuotes = value => value.replace(/'/g, "''");
                const whereParts = [
                    `UPPER(house_number)='${escapeQuotes(houseNumber)}'`,
                    `UPPER(street_name) like '${escapeQuotes(streetName)}%'`
                ];
                
                if (borough) {
                    whereParts.push(`UPPER(borough) like '${escapeQuotes(borough)}%'`);
                }
                
                const params = new URLSearchParams();
                params.set('$where', whereParts.join(' AND '));
                params.set('$limit', '1');
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const building = data[0];
                    const fullAddress = `${building.house_number} ${building.street_name}, ${building.borough}`;
                    
                    // Try to get coordinates from the API response
                    if (building.latitude && building.longitude) {
                        return {
                            label: fullAddress,
                            latitude: parseFloat(building.latitude),
                            longitude: parseFloat(building.longitude),
                            bin: building.bin,
                            type: 'address'
                        };
                    }
                    
                    // If no coordinates, try geocoding
                    return await geocodeAddress(fullAddress, building.bin);
                }
                
                // If no match in NYC data, try geocoding the original address
                return await geocodeAddress(address);
            } catch (error) {
                console.error('Error looking up address:', error);
                // Fallback to geocoding
                return await geocodeAddress(address);
            }
        }
        
        async function geocodeAddress(address, bin = null, deviceNumber = null) {
            try {
                // Use Nominatim (OpenStreetMap geocoding) - free and no API key required
                const encodedAddress = encodeURIComponent(address + ', New York, NY');
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'ELV3-Cheat-Sheet/1.0'
                    }
                });
                
                if (!response.ok) throw new Error('Geocoding failed');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    return {
                        label: address,
                        latitude: parseFloat(result.lat),
                        longitude: parseFloat(result.lon),
                        bin: bin,
                        deviceNumber: deviceNumber,
                        type: bin ? (deviceNumber ? 'device' : 'bin') : 'address'
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }
        
        function formatDeviceInfoForPopup(devices) {
            if (!devices || devices.length === 0) return '';
            
            const currentYear = new Date().getFullYear();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #00bcd4;">
                    <div style="font-weight: 600; font-size: 13px; color: #00bcd4; margin-bottom: 10px;">
                        Device Information (${devices.length} device${devices.length !== 1 ? 's' : ''})
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            devices.forEach((device, idx) => {
                const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                
                const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                
                const deviceType = (device.device_type || '').toUpperCase();
                const deviceStatus = (device.device_status || '').toUpperCase();
                const isDismantled = deviceStatus.includes('DISMANTLED');
                const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER');
                const isConveyor = deviceType.includes('CONVEYOR');
                const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                const isEscalator = deviceType.includes('ESCALATOR');
                
                // Calculate completion status
                let completionStatus, completionColor;
                if (isRemoved) {
                    completionStatus = 'N/A'; completionColor = '#9e9e9e';
                } else if (isConveyor && hasCat1ThisYear) {
                    completionStatus = 'Complete'; completionColor = '#4CAF50';
                } else if (isDismantled && hasPVIThisYear) {
                    completionStatus = 'Complete'; completionColor = '#4CAF50';
                } else if ((isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) && hasPVIThisYear && hasCat1ThisYear) {
                    completionStatus = 'Complete'; completionColor = '#4CAF50';
                } else {
                    let requiresCat5 = false;
                    if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                        const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                        requiresCat5 = yearsSinceCat5 >= 5;
                    }
                    
                    if (requiresCat5) {
                        if (hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear) {
                            completionStatus = 'Complete'; completionColor = '#4CAF50';
                        } else {
                            let missing = [];
                            if (!hasPVIThisYear) missing.push('PVI');
                            if (!hasCat1ThisYear) missing.push('CAT1');
                            if (!hasCat5ThisYear) missing.push('CAT5');
                            completionStatus = missing.join('+');
                            completionColor = missing.length === 3 ? '#ff6b6b' : '#ffd700';
                        }
                    } else {
                        if (hasPVIThisYear && hasCat1ThisYear) {
                            completionStatus = 'Complete'; completionColor = '#4CAF50';
                        } else {
                            let missing = [];
                            if (!hasPVIThisYear) missing.push('PVI');
                            if (!hasCat1ThisYear) missing.push('CAT1');
                            completionStatus = missing.join('+');
                            completionColor = missing.length === 2 ? '#ff6b6b' : '#ffd700';
                        }
                    }
                }
                
                // Calculate 91-day eligibility
                let mostRecentTest;
                if (isDismantled) {
                    mostRecentTest = pviDate;
                } else {
                    const allDates = [pviDate, cat1Date, cat5Date].filter(d => d !== null);
                    mostRecentTest = allDates.length > 0 ? new Date(Math.max(...allDates.map(d => d.getTime()))) : null;
                }
                
                let isReady = 'N/A';
                let isReadyColor = '#9e9e9e';
                let eligibleDate = '‚Äî';
                
                if (!isRemoved && mostRecentTest) {
                    const eligible = new Date(mostRecentTest);
                    eligible.setDate(eligible.getDate() + 91);
                    eligible.setHours(0, 0, 0, 0);
                    isReady = eligible <= today ? 'Yes' : 'No';
                    isReadyColor = eligible <= today ? '#4CAF50' : '#ff9800';
                    eligibleDate = eligible.toLocaleDateString();
                }
                
                const violationCount = device.violations ? device.violations.length : 0;
                
                html += `
                    <div style="background: var(--input-bg); padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--input-border);">
                        <div style="font-weight: 600; font-size: 12px; color: var(--header-color); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${device.device_number || 'N/A'}</span>
                            ${violationCount > 0 ? `<span style="color: #ff6b6b; font-size: 11px;">‚ö† ${violationCount} violation${violationCount !== 1 ? 's' : ''}</span>` : ''}
                        </div>
                        <div style="font-size: 11px; margin-bottom: 4px;">
                            <strong>Type:</strong> ${device.device_type || 'N/A'}
                        </div>
                        <div style="font-size: 11px; margin-bottom: 4px;">
                            <strong>Status:</strong> <span style="color: ${isRemoved ? '#ff6b6b' : (deviceStatus.includes('ACTIVE') ? '#4CAF50' : '#ff9800')};">${device.device_status || 'N/A'}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--input-border);">
                            <div style="font-size: 10px;">
                                <strong>PVI:</strong> ${pviDate ? pviDate.toLocaleDateString() : '‚Äî'}
                            </div>
                            <div style="font-size: 10px;">
                                <strong>CAT 1:</strong> ${cat1Date ? cat1Date.toLocaleDateString() : '‚Äî'}
                            </div>
                            <div style="font-size: 10px;">
                                <strong>CAT 5:</strong> ${cat5Date ? cat5Date.toLocaleDateString() : '‚Äî'}
                            </div>
                            <div style="font-size: 10px;">
                                <strong>${currentYear} Status:</strong> <span style="color: ${completionColor};">${completionStatus}</span>
                            </div>
                            <div style="font-size: 10px;">
                                <strong>Ready:</strong> <span style="color: ${isReadyColor};">${isReady}</span>
                            </div>
                            <div style="font-size: 10px;">
                                <strong>Eligible:</strong> ${eligibleDate}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function removeAdditionalLocation(index) {
            const locations = getAdditionalLocations();
            if (index >= 0 && index < locations.length) {
                const removed = locations.splice(index, 1)[0];
                setAdditionalLocations(locations);
                showMapNotification(`Removed location: ${removed.label}`, '#00bcd4');
                
                // Update the controls panel
                updateAdditionalLocationsPanel();
                
                // Refresh map if it's open
                if (buildingMap && window.lastBulkSearchResults) {
                    initBuildingMap(window.lastBulkSearchResults.binGroups, true);
                }
            }
        }
        
        function removeAdditionalLocationByCoords(latitude, longitude) {
            const locations = getAdditionalLocations();
            const index = locations.findIndex(loc => 
                Math.abs(loc.latitude - latitude) < 0.0001 && 
                Math.abs(loc.longitude - longitude) < 0.0001
            );
            if (index >= 0) {
                removeAdditionalLocation(index);
            }
        }
        
        function clearAllAdditionalLocations() {
            if (confirm('Are you sure you want to remove all additional locations?')) {
                setAdditionalLocations([]);
                showMapNotification('All additional locations cleared', '#00bcd4');
                
                // Update the controls panel
                updateAdditionalLocationsPanel();
                
                // Refresh map if it's open
                if (buildingMap && window.lastBulkSearchResults) {
                    initBuildingMap(window.lastBulkSearchResults.binGroups, true);
                }
            }
        }
        
        function updateAdditionalLocationsPanel() {
            const locations = getAdditionalLocations();
            const countEl = document.getElementById('additionalLocationsCount');
            const listEl = document.getElementById('additionalLocationsList');
            
            if (countEl) {
                countEl.textContent = locations.length;
            }
            
            if (listEl) {
                if (locations.length === 0) {
                    listEl.innerHTML = '<div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No additional locations</div>';
                } else {
                    listEl.innerHTML = locations.map((loc, index) => `
                        <div style="background: var(--input-bg); padding: 8px; border-radius: 4px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border);">
                            <div style="flex: 1; font-size: 11px; color: var(--text-color);">
                                <div style="font-weight: 500; margin-bottom: 2px;">${loc.label}</div>
                                <div style="opacity: 0.7; font-size: 10px;">${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}</div>
                            </div>
                            <button onclick="removeAdditionalLocation(${index})" 
                                    style="background: rgba(255,107,107,0.1); color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 8px;"
                                    title="Remove location">‚úï</button>
                        </div>
                    `).join('');
                }
            }
        }
        
        // Month label functions
        function getMapMonthLabels() {
            try {
                return JSON.parse(localStorage.getItem(MAP_MONTH_LABELS_KEY)) || {};
            } catch (e) {
                return {};
            }
        }
        
        function setMonthLabel(bin, month) {
            const labels = getMapMonthLabels();
            if (month === '' || month === null) {
                delete labels[bin];
            } else {
                labels[bin] = month;
            }
            localStorage.setItem(MAP_MONTH_LABELS_KEY, JSON.stringify(labels));
            updateMonthLabelCounts();
        }
        
        function getMonthLabel(bin) {
            const labels = getMapMonthLabels();
            return labels[bin] || '';
        }
        
        function updateMonthLabelCounts() {
            const labels = getMapMonthLabels();
            const counts = {};
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            months.forEach(m => counts[m] = 0);
            
            Object.values(labels).forEach(month => {
                if (counts[month] !== undefined) {
                    counts[month]++;
                }
            });
            
            // Update the month labels list in the controls panel
            const listContainer = document.getElementById('monthLabelsList');
            if (listContainer) {
                const totalLabeled = Object.keys(labels).length;
                if (totalLabeled === 0) {
                    listContainer.innerHTML = '<div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No buildings labeled</div>';
                } else {
                    let html = '';
                    months.forEach(month => {
                        if (counts[month] > 0) {
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px;">
                                <span>${month}</span>
                                <span style="background: var(--input-bg); padding: 2px 8px; border-radius: 10px;">${counts[month]}</span>
                            </div>`;
                        }
                    });
                    listContainer.innerHTML = html;
                }
                
                // Update total count
                const totalEl = document.getElementById('mapMonthLabelsCount');
                if (totalEl) {
                    totalEl.textContent = totalLabeled;
                }
            }
        }
        
        function clearAllMonthLabels() {
            if (confirm('Clear all month labels from all buildings?')) {
                localStorage.setItem(MAP_MONTH_LABELS_KEY, JSON.stringify({}));
                updateMonthLabelCounts();
                // Refresh map to update markers
                if (window.lastBulkSearchResults && window.lastBulkSearchResults.binGroups) {
                    initBuildingMap(window.lastBulkSearchResults.binGroups, true);
                }
            }
        }
        
        function filterByMonth(month) {
            if (!mapBuildingsData || mapBuildingsData.length === 0) return;
            
            const labels = getMapMonthLabels();
            const resultCount = document.getElementById('mapSearchResultCount');
            
            if (!month) {
                // Clear filter - show all markers
                clearMapSearch();
                return;
            }
            
            const matches = mapBuildingsData.filter(building => labels[building.bin] === month);
            
            if (matches.length === 0) {
                resultCount.textContent = `No buildings labeled "${month}"`;
                resultCount.style.display = 'inline';
                resultCount.style.color = '#ff6b6b';
                // Hide all markers since none match
                mapMarkers.forEach(marker => {
                    if (buildingMap.hasLayer(marker)) {
                        buildingMap.removeLayer(marker);
                    }
                });
                return;
            }
            
            resultCount.textContent = `Showing ${matches.length} "${month}" building${matches.length !== 1 ? 's' : ''}`;
            resultCount.style.display = 'inline';
            resultCount.style.color = '#17a2b8';
            
            // Hide non-matching markers and show matching ones
            const bounds = L.latLngBounds();
            
            mapMarkers.forEach((marker, index) => {
                const building = mapBuildingsData[index];
                if (building && labels[building.bin] === month) {
                    // Show matching marker
                    if (!buildingMap.hasLayer(marker)) {
                        buildingMap.addLayer(marker);
                    }
                    bounds.extend(marker.getLatLng());
                } else {
                    // Hide non-matching marker
                    if (buildingMap.hasLayer(marker)) {
                        buildingMap.removeLayer(marker);
                    }
                }
            });
            
            // Zoom to show matching buildings
            if (matches.length === 1) {
                const match = matches[0];
                const marker = mapMarkers.find((m, i) => {
                    const building = mapBuildingsData[i];
                    return building && labels[building.bin] === month;
                });
                
                if (marker && buildingMap) {
                    buildingMap.setView(marker.getLatLng(), 17);
                    marker.openPopup();
                }
            } else if (bounds.isValid()) {
                if (buildingMap) {
                    buildingMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        function getMapFavorites() {
            try {
                const stored = localStorage.getItem(MAP_FAVORITES_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error reading map favorites:', e);
                return {};
            }
        }

        function setMapFavorites(favorites) {
            try {
                localStorage.setItem(MAP_FAVORITES_KEY, JSON.stringify(favorites));
            } catch (e) {
                console.error('Error saving map favorites:', e);
            }
        }

        function getMapHidden() {
            try {
                const stored = localStorage.getItem(MAP_HIDDEN_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error reading hidden buildings:', e);
                return {};
            }
        }

        function setMapHidden(hidden) {
            try {
                localStorage.setItem(MAP_HIDDEN_KEY, JSON.stringify(hidden));
            } catch (e) {
                console.error('Error saving hidden buildings:', e);
            }
        }

        function toggleMapFavorite(bin, address) {
            const favorites = getMapFavorites();
            if (favorites[bin]) {
                delete favorites[bin];
                showMapNotification(`Building ${bin} removed from favorites`, '#f59e0b');
            } else {
                favorites[bin] = { address, timestamp: Date.now() };
                showMapNotification(`Building ${bin} added to favorites`, '#9b59b6');
            }
            setMapFavorites(favorites);
            // Refresh the map to update marker colors
            if (window.lastBulkSearchResults && window.lastBulkSearchResults.binGroups) {
                initBuildingMap(window.lastBulkSearchResults.binGroups, true);
            }
        }

        function toggleMapHidden(bin, address) {
            const hidden = getMapHidden();
            if (hidden[bin]) {
                delete hidden[bin];
                showMapNotification(`Building ${bin} is now visible`, '#4CAF50');
            } else {
                hidden[bin] = { address, timestamp: Date.now() };
                showMapNotification(`Building ${bin} hidden from map`, '#ff6b6b');
            }
            setMapHidden(hidden);
            // Refresh the map to update visibility
            if (window.lastBulkSearchResults && window.lastBulkSearchResults.binGroups) {
                initBuildingMap(window.lastBulkSearchResults.binGroups, true);
            }
        }

        function unhideAllBuildings() {
            setMapHidden({});
            showMapNotification('All buildings are now visible', '#4CAF50');
            if (window.lastBulkSearchResults && window.lastBulkSearchResults.binGroups) {
                initBuildingMap(window.lastBulkSearchResults.binGroups, true);
            }
        }

        function clearAllFavorites() {
            if (confirm('Are you sure you want to remove all favorites?')) {
                setMapFavorites({});
                showMapNotification('All favorites cleared', '#f59e0b');
                if (window.lastBulkSearchResults && window.lastBulkSearchResults.binGroups) {
                    initBuildingMap(window.lastBulkSearchResults.binGroups, true);
                }
            }
        }

        function showMapNotification(message, color) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 10003;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function updateMapControlsPanel() {
            const favorites = getMapFavorites();
            const hidden = getMapHidden();
            const favoritesCount = Object.keys(favorites).length;
            const hiddenCount = Object.keys(hidden).length;

            const favCountEl = document.getElementById('mapFavoritesCount');
            const hiddenCountEl = document.getElementById('mapHiddenCount');
            const hiddenListEl = document.getElementById('hiddenBuildingsList');

            if (favCountEl) favCountEl.textContent = favoritesCount;
            if (hiddenCountEl) hiddenCountEl.textContent = hiddenCount;

            if (hiddenListEl) {
                if (hiddenCount > 0) {
                    hiddenListEl.innerHTML = Object.entries(hidden).map(([bin, data]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--input-bg); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${data.address || bin}">
                                <strong>${bin}</strong>${data.address ? ` - ${data.address.substring(0, 25)}...` : ''}
                            </span>
                            <button onclick="toggleMapHidden('${bin}')" style="background: #4CAF50; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-left: 8px;">Show</button>
                        </div>
                    `).join('');
                } else {
                    hiddenListEl.innerHTML = '<div style="font-size: 12px; opacity: 0.6; text-align: center; padding: 8px;">No hidden buildings</div>';
                }
            }
            
            // Update additional locations panel
            updateAdditionalLocationsPanel();
        }

        // Copy BIN from map popup
        function copyMapBin(bin) {
            navigator.clipboard.writeText(bin).then(() => {
                // Show brief feedback
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #4CAF50;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    z-index: 10002;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                notification.textContent = `BIN ${bin} copied to clipboard!`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            }).catch(err => {
                console.error('Failed to copy BIN:', err);
                alert('Failed to copy BIN. Please copy manually: ' + bin);
            });
        }

        function showBuildingMap() {
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || !deviceData.binGroups) {
                alert('No data to display on map. Please perform a search first.');
                return;
            }

            const modal = document.getElementById('buildingMapModal');
            modal.style.display = 'flex';

            // Prevent body scrolling when map modal is open
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';

            // Track mouse activity to prevent accidental closes during resize
            let mouseDownOnContainer = false;
            let mouseMoved = false;
            const mapContainer = document.getElementById('mapModalContainer');
            
            const handleContainerMouseDown = (e) => {
                mouseDownOnContainer = true;
                mouseMoved = false;
            };
            
            const handleMouseMove = () => {
                if (mouseDownOnContainer) {
                    mouseMoved = true;
                }
            };
            
            const handleMouseUp = () => {
                // Reset after a short delay to allow events to settle
                setTimeout(() => {
                    mouseDownOnContainer = false;
                    mouseMoved = false;
                }, 100);
            };
            
            if (mapContainer) {
                mapContainer.addEventListener('mousedown', handleContainerMouseDown);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                modal._containerMouseDownHandler = handleContainerMouseDown;
                modal._mouseMoveHandler = handleMouseMove;
                modal._mouseUpHandler = handleMouseUp;
            }
            
            // Add event listener to close modal when clicking on backdrop
            // Use mousedown instead of click to avoid conflicts with resize
            const handleBackdropClick = (e) => {
                // Don't close if user was interacting with container (resizing, dragging, etc.)
                if (mouseDownOnContainer || mouseMoved) {
                    return;
                }
                
                // Only close if clicking directly on the backdrop (modal itself), not on container or children
                const mapContainer = document.getElementById('mapModalContainer');
                if (e.target === modal && (!mapContainer || !mapContainer.contains(e.target))) {
                    // Prevent the click from propagating
                    e.stopPropagation();
                    closeBuildingMap();
                }
            };
            modal.addEventListener('mousedown', handleBackdropClick);
            modal._backdropClickHandler = handleBackdropClick;

            // Add event listener to close modal on ESC key
            const handleEscKey = (e) => {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    closeBuildingMap();
                }
            };
            document.addEventListener('keydown', handleEscKey);
            modal._escKeyHandler = handleEscKey;

            // Small delay to ensure modal is visible before initializing map
            setTimeout(() => {
                initBuildingMap(deviceData.binGroups);
            }, 100);
        }

        function closeBuildingMap() {
            const modal = document.getElementById('buildingMapModal');
            modal.style.display = 'none';
            
            // Re-enable body scrolling when map modal is closed
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            
            // Remove event listeners
            if (modal._backdropClickHandler) {
                modal.removeEventListener('mousedown', modal._backdropClickHandler);
                delete modal._backdropClickHandler;
            }
            if (modal._escKeyHandler) {
                document.removeEventListener('keydown', modal._escKeyHandler);
                delete modal._escKeyHandler;
            }
            if (modal._containerMouseDownHandler) {
                const mapContainer = document.getElementById('mapModalContainer');
                if (mapContainer) {
                    mapContainer.removeEventListener('mousedown', modal._containerMouseDownHandler);
                }
                delete modal._containerMouseDownHandler;
            }
            if (modal._mouseMoveHandler) {
                document.removeEventListener('mousemove', modal._mouseMoveHandler);
                delete modal._mouseMoveHandler;
            }
            if (modal._mouseUpHandler) {
                document.removeEventListener('mouseup', modal._mouseUpHandler);
                delete modal._mouseUpHandler;
            }
            
            // Clean up map
            if (buildingMap) {
                buildingMap.remove();
                buildingMap = null;
            }
            mapMarkers = [];
            additionalLocationMarkers = [];
            mapBuildingsData = [];
            
            // Clear search
            const searchInput = document.getElementById('mapSearchInput');
            const resultCount = document.getElementById('mapSearchResultCount');
            if (searchInput) searchInput.value = '';
            if (resultCount) resultCount.style.display = 'none';
            
            // Clear additional location input
            const additionalInput = document.getElementById('additionalLocationInput');
            if (additionalInput) additionalInput.value = '';
        }

        function toggleMapControlsPanel() {
            const panel = document.getElementById('mapControlsPanel');
            if (panel) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';
                // Invalidate map size when panel toggles
                if (buildingMap) {
                    setTimeout(() => buildingMap.invalidateSize(), 100);
                }
            }
        }

        function initBuildingMap(binGroups, preserveView) {
            const mapContainer = document.getElementById('buildingMap');
            
            // Save current view if preserving
            let savedCenter = null;
            let savedZoom = null;
            if (preserveView && buildingMap) {
                savedCenter = buildingMap.getCenter();
                savedZoom = buildingMap.getZoom();
            }
            
            // Clear any existing map
            if (buildingMap) {
                buildingMap.remove();
                buildingMap = null;
            }
            mapMarkers = [];
            additionalLocationMarkers = [];

            // Get favorites and hidden buildings
            const favorites = getMapFavorites();
            const hidden = getMapHidden();

            // Update controls panel
            updateMapControlsPanel();

            // Get all buildings with valid coordinates
            const buildingsWithCoords = [];
            let totalDevices = 0;
            let hiddenCount = 0;
            
            for (const [bin, group] of Object.entries(binGroups)) {
                // Skip hidden buildings
                if (hidden[bin]) {
                    hiddenCount++;
                    continue;
                }
                
                if (group.latitude && group.longitude) {
                    const lat = parseFloat(group.latitude);
                    const lng = parseFloat(group.longitude);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Calculate completion stats and testing eligibility for this building
                        const currentYear = new Date().getFullYear();
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        let complete = 0, incomplete = 0;
                        const readyDevices = [];
                        const notReadyDevices = [];
                        const removedDeletedDevices = []; // Track removed/deleted devices (not dismantled - they still need PVI)
                        
                        group.devices.forEach(device => {
                            const deviceStatus = (device.device_status || '').toUpperCase();
                            const deviceType = (device.device_type || '').toUpperCase();
                            const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                            const isDismantled = deviceStatus.includes('DISMANTLED');
                            
                            // Track only removed/deleted devices - dismantled devices still need PVI tests
                            if (isRemoved) {
                                const statusDate = device.status_date ? new Date(device.status_date).toLocaleDateString() : 'N/A';
                                removedDeletedDevices.push({
                                    number: device.device_number,
                                    type: device.device_type || 'Unknown',
                                    status: device.device_status || 'N/A',
                                    statusDate: statusDate
                                });
                            }
                            
                            // Skip removed devices from testing calculations
                            if (isRemoved) return;
                            
                            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                            const hasPVI = pviDate && pviDate.getFullYear() === currentYear;
                            const hasCat1 = cat1Date && cat1Date.getFullYear() === currentYear;
                            
                            if (hasPVI && hasCat1) complete++;
                            else incomplete++;
                            
                            // Calculate 91-day testing eligibility
                            let mostRecentTest;
                            if (isDismantled) {
                                mostRecentTest = pviDate;
                            } else {
                                const allDates = [pviDate, cat1Date, cat5Date].filter(d => d !== null);
                                mostRecentTest = allDates.length > 0 ? new Date(Math.max(...allDates.map(d => d.getTime()))) : null;
                            }
                            
                            let isReady = true;
                            let eligibleDate = null;
                            let daysUntil = null;
                            
                            if (mostRecentTest) {
                                eligibleDate = new Date(mostRecentTest);
                                eligibleDate.setDate(eligibleDate.getDate() + 91);
                                eligibleDate.setHours(0, 0, 0, 0);
                                daysUntil = Math.ceil((eligibleDate - today) / (1000 * 60 * 60 * 24));
                                isReady = daysUntil <= 0;
                            }
                            
                            const deviceInfo = {
                                number: device.device_number,
                                type: device.device_type || 'Unknown',
                                status: device.device_status || 'N/A',
                                hasPVI,
                                hasCat1,
                                eligibleDate,
                                daysUntil,
                                mostRecentTest
                            };
                            
                            if (isReady) {
                                readyDevices.push(deviceInfo);
                            } else {
                                notReadyDevices.push(deviceInfo);
                            }
                        });
                        
                        // Collect violation details for this building
                        const violationDetails = [];
                        group.devices.forEach(device => {
                            if (device.violations && device.violations.length > 0) {
                                device.violations.forEach(v => {
                                    violationDetails.push({
                                        deviceNumber: device.device_number,
                                        description: v.violation_description || v.violation_remarks || 'No description available',
                                        status: v.violation_status || 'Unknown',
                                        type: v.violation_type || 'N/A',
                                        issueDate: v.violation_issue_date || v.violation_date || null
                                    });
                                });
                            }
                        });
                        
                        buildingsWithCoords.push({
                            bin,
                            address: group.address,
                            latitude: lat,
                            longitude: lng,
                            deviceCount: group.devices.length,
                            complete,
                            incomplete,
                            violations: group.devices.reduce((sum, d) => sum + (d.violations ? d.violations.length : 0), 0),
                            violationDetails,
                            readyDevices,
                            notReadyDevices,
                            removedDeletedDevices
                        });
                        totalDevices += group.devices.length;
                    }
                }
            }

            // Update building count display
            const countDisplay = document.getElementById('mapBuildingCount');
            const hiddenText = hiddenCount > 0 ? ` (${hiddenCount} hidden)` : '';
            countDisplay.textContent = `${buildingsWithCoords.length} buildings with ${totalDevices} devices${hiddenText}`;

            if (buildingsWithCoords.length === 0) {
                mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-color);"><p>No buildings with location data found. The API may not have coordinates for these addresses.</p></div>';
                return;
            }
            
            // Store buildings data for search functionality
            mapBuildingsData = buildingsWithCoords;
            
            // Update month labels count in controls panel
            updateMonthLabelCounts();

            // Initialize the map centered on NYC
            buildingMap = L.map(mapContainer).setView([40.7128, -74.0060], 11);
            
            // Set up ResizeObserver to handle map container resizing
            const modalContainer = document.getElementById('mapModalContainer');
            if (modalContainer && window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(() => {
                    if (buildingMap) {
                        buildingMap.invalidateSize();
                    }
                });
                resizeObserver.observe(modalContainer);
            }

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(buildingMap);

            // Create markers for each building
            const bounds = L.latLngBounds();
            
            buildingsWithCoords.forEach(building => {
                // Check if building is favorited
                const isFavorited = favorites[building.bin] ? true : false;
                
                // Determine marker color based on favorite status or testing readiness
                let markerColor;
                
                if (isFavorited) {
                    markerColor = '#9b59b6'; // Purple - favorited building
                } else if (building.notReadyDevices.length === 0 && building.readyDevices.length > 0) {
                    markerColor = '#4CAF50'; // Green - all devices ready to test
                } else if (building.readyDevices.length > 0 && building.notReadyDevices.length > 0) {
                    markerColor = '#ffc107'; // Yellow - some devices ready to test
                } else {
                    markerColor = '#ff6b6b'; // Red - no devices ready to test
                }

                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-map-marker',
                    html: `<div style="
                        background: ${markerColor};
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 11px;
                    ">${building.deviceCount}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([building.latitude, building.longitude], { icon })
                    .addTo(buildingMap);

                // Create popup content with detailed device testing info
                const readyList = building.readyDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                        <span>${d.number}</span>
                        <span style="opacity: 0.7; font-size: 10px;">${d.hasPVI && d.hasCat1 ? '‚úì Done' : 'Needs tests'}</span>
                    </div>`
                ).join('');
                
                const notReadyList = building.notReadyDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                        <span>${d.number}</span>
                        <span style="opacity: 0.7; font-size: 10px;">${d.daysUntil > 0 ? d.daysUntil + ' days' : ''}</span>
                    </div>`
                ).join('');
                
                // Generate list for removed/deleted devices (not dismantled - they still need PVI tests)
                const removedDeletedList = building.removedDeletedDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 3px 0; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(128,128,128,0.2);">
                        <span style="font-weight: 500;">${d.number}</span>
                        <span style="color: #ff6b6b; font-size: 10px; font-weight: 500;">
                            ${d.status.toUpperCase().includes('DELETED') ? 'Deleted' : 'Removed'}
                        </span>
                    </div>`
                ).join('');
                
                // Generate list for violation details
                const violationDetailsList = building.violationDetails.slice(0, 10).map(v => {
                    const truncatedDesc = v.description.length > 80 ? v.description.substring(0, 80) + '...' : v.description;
                    const issueDate = v.issueDate ? new Date(v.issueDate).toLocaleDateString() : '';
                    return `<div style="font-size: 11px; padding: 6px 0; border-bottom: 1px solid rgba(255,107,107,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <span style="font-weight: 600; color: #ff6b6b;">Device: ${v.deviceNumber}</span>
                            ${issueDate ? `<span style="font-size: 9px; opacity: 0.7;">${issueDate}</span>` : ''}
                        </div>
                        <div style="font-size: 10px; color: #ccc; line-height: 1.3;">${truncatedDesc}</div>
                    </div>`;
                }).join('');
                
                // Escape address for use in onclick attributes
                const escapedAddress = building.address.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // Get current month label for this building
                const currentMonthLabel = getMonthLabel(building.bin);
                
                const popupContent = `
                    <div class="map-popup-content" style="min-width: 280px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid ${isFavorited ? '#9b59b6' : '#1a73e8'};">
                            <div style="font-weight: bold; font-size: 14px; flex: 1;">${building.address}</div>
                            <div style="display: flex; gap: 4px; margin-left: 8px;">
                                <button onclick="toggleMapFavorite('${building.bin}', '${escapedAddress}')" 
                                        title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}"
                                        style="background: ${isFavorited ? '#9b59b6' : 'rgba(155,89,182,0.1)'}; 
                                               color: ${isFavorited ? 'white' : '#9b59b6'}; 
                                               border: 1px solid #9b59b6; 
                                               border-radius: 4px; 
                                               padding: 4px 8px; 
                                               cursor: pointer; 
                                               font-size: 14px;
                                               transition: all 0.2s;">‚≠ê</button>
                                <button onclick="toggleMapHidden('${building.bin}', '${escapedAddress}')" 
                                        title="Hide this building from map"
                                        style="background: rgba(136,136,136,0.1); 
                                               color: #888; 
                                               border: 1px solid #888; 
                                               border-radius: 4px; 
                                               padding: 4px 8px; 
                                               cursor: pointer; 
                                               font-size: 14px;
                                               transition: all 0.2s;">üëÅÔ∏è</button>
                            </div>
                        </div>
                        
                        ${isFavorited ? `
                        <div style="font-size: 11px; color: #9b59b6; font-weight: 600; margin-bottom: 10px; padding: 4px 8px; background: rgba(155,89,182,0.1); border-radius: 4px; text-align: center;">
                            ‚≠ê Favorited Building
                        </div>` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px;">
                                <strong>BIN:</strong> 
                                <span onclick="copyMapBin('${building.bin}')" 
                                      style="cursor: pointer; padding: 2px 6px; background: rgba(26,115,232,0.1); border-radius: 4px; transition: all 0.2s;"
                                      onmouseover="this.style.background='rgba(26,115,232,0.2)'"
                                      onmouseout="this.style.background='rgba(26,115,232,0.1)'"
                                      title="Click to copy BIN">
                                    ${building.bin} üìã
                                </span>
                            </div>
                            <div style="font-size: 12px;">
                                <strong>Devices:</strong> ${building.deviceCount}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px; padding: 8px; background: rgba(23,162,184,0.1); border-radius: 6px; border: 1px solid rgba(23,162,184,0.3);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #17a2b8; font-weight: 600;">üìÖ Month:</span>
                                <select onchange="setMonthLabel('${building.bin}', this.value); this.style.borderColor = this.value ? '#17a2b8' : 'var(--input-border)';" 
                                        style="flex: 1; padding: 4px 8px; border-radius: 4px; border: 1px solid ${currentMonthLabel ? '#17a2b8' : 'var(--input-border)'}; background: var(--input-bg); color: var(--text-color); font-size: 11px; cursor: pointer;">
                                    <option value="" ${!currentMonthLabel ? 'selected' : ''}>Select month...</option>
                                    <option value="January" ${currentMonthLabel === 'January' ? 'selected' : ''}>January</option>
                                    <option value="February" ${currentMonthLabel === 'February' ? 'selected' : ''}>February</option>
                                    <option value="March" ${currentMonthLabel === 'March' ? 'selected' : ''}>March</option>
                                    <option value="April" ${currentMonthLabel === 'April' ? 'selected' : ''}>April</option>
                                    <option value="May" ${currentMonthLabel === 'May' ? 'selected' : ''}>May</option>
                                    <option value="June" ${currentMonthLabel === 'June' ? 'selected' : ''}>June</option>
                                    <option value="July" ${currentMonthLabel === 'July' ? 'selected' : ''}>July</option>
                                    <option value="August" ${currentMonthLabel === 'August' ? 'selected' : ''}>August</option>
                                    <option value="September" ${currentMonthLabel === 'September' ? 'selected' : ''}>September</option>
                                    <option value="October" ${currentMonthLabel === 'October' ? 'selected' : ''}>October</option>
                                    <option value="November" ${currentMonthLabel === 'November' ? 'selected' : ''}>November</option>
                                    <option value="December" ${currentMonthLabel === 'December' ? 'selected' : ''}>December</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px;">
                                <span style="color: #4CAF50; font-weight: 600;">‚úì ${building.complete} Complete</span>
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #ff9800; font-weight: 600;">‚óã ${building.incomplete} Incomplete</span>
                            </div>
                        </div>
                        
                        ${building.violations > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.violation-arrow').textContent = this.nextElementSibling.style.display === 'none' ? '‚ñº' : '‚ñ≤';" 
                                 style="font-size: 12px; color: #ff6b6b; font-weight: 600; padding: 8px 10px; background: rgba(255,107,107,0.1); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,107,107,0.3); transition: all 0.2s;"
                                 onmouseover="this.style.background='rgba(255,107,107,0.2)'"
                                 onmouseout="this.style.background='rgba(255,107,107,0.1)'">
                                <span>‚ö†Ô∏è ${building.violations} Active Violation${building.violations !== 1 ? 's' : ''}</span>
                                <span class="violation-arrow" style="font-size: 10px; transition: transform 0.2s;">‚ñº</span>
                            </div>
                            <div style="display: none; margin-top: 6px; padding: 10px; background: rgba(255,107,107,0.05); border-radius: 4px; border: 1px solid rgba(255,107,107,0.2); max-height: 200px; overflow-y: auto;">
                                <div style="font-size: 10px; color: #ff6b6b; margin-bottom: 8px; font-weight: 600;">Click to view violation details:</div>
                                ${violationDetailsList}
                                ${building.violationDetails.length > 10 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 6px; text-align: center;">+${building.violationDetails.length - 10} more violations...</div>` : ''}
                            </div>
                        </div>` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(76,175,80,0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(76,175,80,0.3);">
                                <div style="font-size: 11px; font-weight: 600; color: #4CAF50; margin-bottom: 6px;">
                                    ‚úÖ Ready to Test (${building.readyDevices.length})
                                </div>
                                ${building.readyDevices.length > 0 ? readyList : '<div style="font-size: 11px; opacity: 0.6;">None</div>'}
                                ${building.readyDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">+${building.readyDevices.length - 5} more...</div>` : ''}
                            </div>
                            <div style="background: rgba(255,152,0,0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(255,152,0,0.3);">
                                <div style="font-size: 11px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                    ‚è≥ Not Ready (${building.notReadyDevices.length})
                                </div>
                                ${building.notReadyDevices.length > 0 ? notReadyList : '<div style="font-size: 11px; opacity: 0.6;">None</div>'}
                                ${building.notReadyDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">+${building.notReadyDevices.length - 5} more...</div>` : ''}
                            </div>
                        </div>
                        
                        ${building.removedDeletedDevices.length > 0 ? `
                        <div style="margin-top: 10px; background: rgba(128,128,128,0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(128,128,128,0.3);">
                            <div style="font-size: 11px; font-weight: 600; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 14px;">üö´</span> Removed/Deleted Devices (${building.removedDeletedDevices.length})
                            </div>
                            <div style="font-size: 10px; color: #888; margin-bottom: 8px; font-style: italic;">
                                These devices no longer require testing
                            </div>
                            ${removedDeletedList}
                            ${building.removedDeletedDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 6px;">+${building.removedDeletedDevices.length - 5} more...</div>` : ''}
                        </div>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent);
                mapMarkers.push(marker);
                bounds.extend([building.latitude, building.longitude]);
            });

            // Clear existing additional location markers
            additionalLocationMarkers.forEach(marker => {
                if (buildingMap.hasLayer(marker)) {
                    buildingMap.removeLayer(marker);
                }
            });
            additionalLocationMarkers = [];

            // Add markers for additional locations (custom locations)
            const additionalLocations = getAdditionalLocations();
            additionalLocations.forEach(location => {
                // Process devices if available (same logic as buildings)
                let deviceCount = 0;
                let complete = 0;
                let incomplete = 0;
                const readyDevices = [];
                const notReadyDevices = [];
                const removedDeletedDevices = [];
                const violationDetails = [];
                
                if (location.devices && location.devices.length > 0) {
                    deviceCount = location.devices.length;
                    const currentYear = new Date().getFullYear();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    location.devices.forEach(device => {
                        const deviceStatus = (device.device_status || '').toUpperCase();
                        const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                        const isDismantled = deviceStatus.includes('DISMANTLED');
                        
                        // Track removed/deleted devices
                        if (isRemoved) {
                            const statusDate = device.status_date ? new Date(device.status_date).toLocaleDateString() : 'N/A';
                            removedDeletedDevices.push({
                                number: device.device_number,
                                type: device.device_type || 'Unknown',
                                status: device.device_status || 'N/A',
                                statusDate: statusDate
                            });
                        }
                        
                        // Skip removed devices from testing calculations
                        if (isRemoved) return;
                        
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const hasPVI = pviDate && pviDate.getFullYear() === currentYear;
                        const hasCat1 = cat1Date && cat1Date.getFullYear() === currentYear;
                        
                        if (hasPVI && hasCat1) complete++;
                        else incomplete++;
                        
                        // Calculate 91-day testing eligibility
                        let mostRecentTest;
                        if (isDismantled) {
                            mostRecentTest = pviDate;
                        } else {
                            const allDates = [pviDate, cat1Date, cat5Date].filter(d => d !== null);
                            mostRecentTest = allDates.length > 0 ? new Date(Math.max(...allDates.map(d => d.getTime()))) : null;
                        }
                        
                        let isReady = true;
                        let eligibleDate = null;
                        let daysUntil = null;
                        
                        if (mostRecentTest) {
                            eligibleDate = new Date(mostRecentTest);
                            eligibleDate.setDate(eligibleDate.getDate() + 91);
                            eligibleDate.setHours(0, 0, 0, 0);
                            daysUntil = Math.ceil((eligibleDate - today) / (1000 * 60 * 60 * 24));
                            isReady = daysUntil <= 0;
                        }
                        
                        const deviceInfo = {
                            number: device.device_number,
                            type: device.device_type || 'Unknown',
                            status: device.device_status || 'N/A',
                            hasPVI,
                            hasCat1,
                            eligibleDate,
                            daysUntil,
                            mostRecentTest
                        };
                        
                        if (isReady) {
                            readyDevices.push(deviceInfo);
                        } else {
                            notReadyDevices.push(deviceInfo);
                        }
                        
                        // Collect violation details
                        if (device.violations && device.violations.length > 0) {
                            device.violations.forEach(v => {
                                violationDetails.push({
                                    deviceNumber: device.device_number,
                                    description: v.violation_description || v.violation_remarks || 'No description available',
                                    status: v.violation_status || 'Unknown',
                                    type: v.violation_type || 'N/A',
                                    issueDate: v.violation_issue_date || v.violation_date || null
                                });
                            });
                        }
                    });
                }
                
                // Determine icon based on device count
                const iconText = deviceCount > 0 ? deviceCount : 'üìç';
                
                // Create circular icon for additional locations (same style as building markers but different color)
                const additionalIcon = L.divIcon({
                    className: 'custom-map-marker-additional',
                    html: `<div style="
                        background: #00bcd4;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 11px;
                    ">${iconText}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const additionalMarker = L.marker([location.latitude, location.longitude], { icon: additionalIcon })
                    .addTo(buildingMap);

                // Create popup content matching building popup format
                const readyList = readyDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                        <span>${d.number}</span>
                        <span style="opacity: 0.7; font-size: 10px;">${d.hasPVI && d.hasCat1 ? '‚úì Done' : 'Needs tests'}</span>
                    </div>`
                ).join('');
                
                const notReadyList = notReadyDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                        <span>${d.number}</span>
                        <span style="opacity: 0.7; font-size: 10px;">${d.daysUntil > 0 ? d.daysUntil + ' days' : ''}</span>
                    </div>`
                ).join('');
                
                const removedDeletedList = removedDeletedDevices.slice(0, 5).map(d => 
                    `<div style="font-size: 11px; padding: 3px 0; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(128,128,128,0.2);">
                        <span style="font-weight: 500;">${d.number}</span>
                        <span style="color: #ff6b6b; font-size: 10px; font-weight: 500;">
                            ${d.status.toUpperCase().includes('DELETED') ? 'Deleted' : 'Removed'}
                        </span>
                    </div>`
                ).join('');
                
                const violationDetailsList = violationDetails.slice(0, 10).map(v => {
                    const truncatedDesc = v.description.length > 80 ? v.description.substring(0, 80) + '...' : v.description;
                    const issueDate = v.issueDate ? new Date(v.issueDate).toLocaleDateString() : '';
                    return `<div style="font-size: 11px; padding: 6px 0; border-bottom: 1px solid rgba(255,107,107,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <span style="font-weight: 600; color: #ff6b6b;">Device: ${v.deviceNumber}</span>
                            ${issueDate ? `<span style="font-size: 9px; opacity: 0.7;">${issueDate}</span>` : ''}
                        </div>
                        <div style="font-size: 10px; color: #ccc; line-height: 1.3;">${truncatedDesc}</div>
                    </div>`;
                }).join('');
                
                const totalViolations = violationDetails.length;
                const escapedAddress = location.label.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const currentMonthLabel = location.bin ? getMonthLabel(location.bin) : null;
                
                // Build popup content matching building popup format
                const additionalPopupContent = `
                    <div class="map-popup-content" style="min-width: 280px; max-width: 320px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #00bcd4;">
                            <div style="font-weight: bold; font-size: 14px; flex: 1;">${location.label.toUpperCase()}</div>
                            <div style="display: flex; gap: 4px; margin-left: 8px;">
                                <button onclick="removeAdditionalLocationByCoords(${location.latitude}, ${location.longitude})" 
                                        title="Remove location"
                                        style="background: rgba(255,107,107,0.1); 
                                               color: #ff6b6b; 
                                               border: 1px solid #ff6b6b; 
                                               border-radius: 4px; 
                                               padding: 4px 8px; 
                                               cursor: pointer; 
                                               font-size: 14px;
                                               transition: all 0.2s;">‚úï</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px;">
                                <strong>BIN:</strong> 
                                ${location.bin ? `
                                <span onclick="copyMapBin('${location.bin}')" 
                                      style="cursor: pointer; padding: 2px 6px; background: rgba(26,115,232,0.1); border-radius: 4px; transition: all 0.2s;"
                                      onmouseover="this.style.background='rgba(26,115,232,0.2)'"
                                      onmouseout="this.style.background='rgba(26,115,232,0.1)'"
                                      title="Click to copy BIN">
                                    ${location.bin} üìã
                                </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="font-size: 12px;">
                                <strong>Devices:</strong> ${deviceCount}
                            </div>
                        </div>
                        
                        ${location.bin ? `
                        <div style="margin-bottom: 10px; padding: 8px; background: rgba(23,162,184,0.1); border-radius: 6px; border: 1px solid rgba(23,162,184,0.3);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #17a2b8; font-weight: 600;">üìÖ Month:</span>
                                <select onchange="setMonthLabel('${location.bin}', this.value); this.style.borderColor = this.value ? '#17a2b8' : 'var(--input-border)';" 
                                        style="flex: 1; padding: 4px 8px; border-radius: 4px; border: 1px solid ${currentMonthLabel ? '#17a2b8' : 'var(--input-border)'}; background: var(--input-bg); color: var(--text-color); font-size: 11px; cursor: pointer;">
                                    <option value="" ${!currentMonthLabel ? 'selected' : ''}>Select month...</option>
                                    <option value="January" ${currentMonthLabel === 'January' ? 'selected' : ''}>January</option>
                                    <option value="February" ${currentMonthLabel === 'February' ? 'selected' : ''}>February</option>
                                    <option value="March" ${currentMonthLabel === 'March' ? 'selected' : ''}>March</option>
                                    <option value="April" ${currentMonthLabel === 'April' ? 'selected' : ''}>April</option>
                                    <option value="May" ${currentMonthLabel === 'May' ? 'selected' : ''}>May</option>
                                    <option value="June" ${currentMonthLabel === 'June' ? 'selected' : ''}>June</option>
                                    <option value="July" ${currentMonthLabel === 'July' ? 'selected' : ''}>July</option>
                                    <option value="August" ${currentMonthLabel === 'August' ? 'selected' : ''}>August</option>
                                    <option value="September" ${currentMonthLabel === 'September' ? 'selected' : ''}>September</option>
                                    <option value="October" ${currentMonthLabel === 'October' ? 'selected' : ''}>October</option>
                                    <option value="November" ${currentMonthLabel === 'November' ? 'selected' : ''}>November</option>
                                    <option value="December" ${currentMonthLabel === 'December' ? 'selected' : ''}>December</option>
                                </select>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${deviceCount > 0 ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-size: 12px;">
                                <span style="color: #4CAF50; font-weight: 600;">‚úì ${complete} Complete</span>
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #ff9800; font-weight: 600;">‚óã ${incomplete} Incomplete</span>
                            </div>
                        </div>
                        
                        ${totalViolations > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.violation-arrow').textContent = this.nextElementSibling.style.display === 'none' ? '‚ñº' : '‚ñ≤';" 
                                 style="font-size: 12px; color: #ff6b6b; font-weight: 600; padding: 8px 10px; background: rgba(255,107,107,0.1); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,107,107,0.3); transition: all 0.2s;"
                                 onmouseover="this.style.background='rgba(255,107,107,0.2)'"
                                 onmouseout="this.style.background='rgba(255,107,107,0.1)'">
                                <span>‚ö†Ô∏è ${totalViolations} Active Violation${totalViolations !== 1 ? 's' : ''}</span>
                                <span class="violation-arrow" style="font-size: 10px; transition: transform 0.2s;">‚ñº</span>
                            </div>
                            <div style="display: none; margin-top: 6px; padding: 10px; background: rgba(255,107,107,0.05); border-radius: 4px; border: 1px solid rgba(255,107,107,0.2); max-height: 200px; overflow-y: auto;">
                                <div style="font-size: 10px; color: #ff6b6b; margin-bottom: 8px; font-weight: 600;">Click to view violation details:</div>
                                ${violationDetailsList}
                                ${violationDetails.length > 10 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 6px; text-align: center;">+${violationDetails.length - 10} more violations...</div>` : ''}
                            </div>
                        </div>` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(76,175,80,0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(76,175,80,0.3);">
                                <div style="font-size: 11px; font-weight: 600; color: #4CAF50; margin-bottom: 6px;">
                                    ‚úÖ Ready to Test (${readyDevices.length})
                                </div>
                                ${readyDevices.length > 0 ? readyList : '<div style="font-size: 11px; opacity: 0.6;">None</div>'}
                                ${readyDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">+${readyDevices.length - 5} more...</div>` : ''}
                            </div>
                            <div style="background: rgba(255,152,0,0.1); padding: 8px; border-radius: 6px; border: 1px solid rgba(255,152,0,0.3);">
                                <div style="font-size: 11px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                    ‚è≥ Not Ready (${notReadyDevices.length})
                                </div>
                                ${notReadyDevices.length > 0 ? notReadyList : '<div style="font-size: 11px; opacity: 0.6;">None</div>'}
                                ${notReadyDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">+${notReadyDevices.length - 5} more...</div>` : ''}
                            </div>
                        </div>
                        
                        ${removedDeletedDevices.length > 0 ? `
                        <div style="margin-top: 10px; background: rgba(128,128,128,0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(128,128,128,0.3);">
                            <div style="font-size: 11px; font-weight: 600; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 14px;">üö´</span> Removed/Deleted Devices (${removedDeletedDevices.length})
                            </div>
                            <div style="font-size: 10px; color: #888; margin-bottom: 8px; font-style: italic;">
                                These devices no longer require testing
                            </div>
                            ${removedDeletedList}
                            ${removedDeletedDevices.length > 5 ? `<div style="font-size: 10px; opacity: 0.6; margin-top: 6px;">+${removedDeletedDevices.length - 5} more...</div>` : ''}
                        </div>` : ''}
                        ` : ''}
                    </div>
                `;

                additionalMarker.bindPopup(additionalPopupContent);
                additionalLocationMarkers.push(additionalMarker);
                bounds.extend([location.latitude, location.longitude]);
            });

            // Restore saved view or fit map to show all markers
            if (savedCenter && savedZoom) {
                buildingMap.setView(savedCenter, savedZoom);
            } else {
                const allMarkersCount = buildingsWithCoords.length + additionalLocations.length;
                if (allMarkersCount > 0) {
                    buildingMap.fitBounds(bounds, { padding: [30, 30] });
                }
            }

            // Add legend with hide/show functionality
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                // Use CSS variables for theme-aware styling
                div.style.cssText = 'background: var(--panel-bg, #2c2c2c); padding: 10px 12px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 11px; line-height: 1.8; border: 1px solid var(--input-border, #444);';
                
                // Check if legend should be hidden from localStorage
                const isLegendHidden = localStorage.getItem('mapLegendHidden') === 'true';
                
                div.innerHTML = `
                    <div id="mapLegendContent" style="display: ${isLegendHidden ? 'none' : 'block'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: bold; font-size: 12px; color: var(--text-color, #fff);">Map Legend</span>
                            <button onclick="toggleMapLegend()" title="Hide legend" style="background: var(--input-bg, #333); border: 1px solid var(--input-border, #555); border-radius: 4px; cursor: pointer; font-size: 12px; padding: 2px 6px; color: var(--text-color, #fff); font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Hide</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #9b59b6; flex-shrink: 0;"></span><span style="color: var(--text-color, #fff);">‚≠ê Favorited</span></div>
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #4CAF50; flex-shrink: 0;"></span><span style="color: var(--text-color, #fff);">All Devices Ready</span></div>
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #ffc107; flex-shrink: 0;"></span><span style="color: var(--text-color, #fff);">Some Devices Ready</span></div>
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #ff6b6b; flex-shrink: 0;"></span><span style="color: var(--text-color, #fff);">No Devices Ready</span></div>
                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 6px;"><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #00bcd4; flex-shrink: 0;"></span><span style="color: var(--text-color, #fff);">üìç Custom Location</span></div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--input-border, #444); font-size: 10px; color: var(--text-color, #fff); opacity: 0.8;">
                            Ready = 91+ days since last test<br>
                            Click marker for favorite/hide options<br>
                            Use ‚ûï button to add custom locations
                        </div>
                    </div>
                    <div id="mapLegendCollapsed" style="display: ${isLegendHidden ? 'block' : 'none'};">
                        <button onclick="toggleMapLegend()" title="Show legend" style="background: var(--input-bg, #333); border: 1px solid var(--input-border, #555); border-radius: 4px; cursor: pointer; font-size: 12px; padding: 4px 8px; display: flex; align-items: center; gap: 4px; color: var(--text-color, #fff); font-weight: 500; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            <span style="font-size: 14px;">üìç</span> Show Legend
                        </button>
                    </div>
                `;
                return div;
            };
            legend.addTo(buildingMap);
        }
        
        // Toggle map legend visibility
        function toggleMapLegend() {
            const content = document.getElementById('mapLegendContent');
            const collapsed = document.getElementById('mapLegendCollapsed');
            
            if (content && collapsed) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                collapsed.style.display = isHidden ? 'none' : 'block';
                
                // Save preference to localStorage
                localStorage.setItem('mapLegendHidden', !isHidden);
            }
        }
        
        // Store buildings data for search functionality
        let mapBuildingsData = [];
        
        // Search buildings on the map
        function searchMapBuildings() {
            const searchInput = document.getElementById('mapSearchInput');
            const resultCount = document.getElementById('mapSearchResultCount');
            const searchTerm = searchInput.value.trim().toUpperCase();
            
            if (!searchTerm) {
                clearMapSearch();
                return;
            }
            
            if (!mapBuildingsData || mapBuildingsData.length === 0) {
                resultCount.textContent = 'No data loaded';
                resultCount.style.display = 'inline';
                resultCount.style.color = '#ff6b6b';
                return;
            }
            
            // Search through buildings for matching address, BIN, or device numbers
            const matches = mapBuildingsData.filter(building => {
                const addressMatch = building.address.toUpperCase().includes(searchTerm);
                const binMatch = building.bin.toString().includes(searchTerm);
                const deviceMatch = building.readyDevices.some(d => d.number.toUpperCase().includes(searchTerm)) ||
                                   building.notReadyDevices.some(d => d.number.toUpperCase().includes(searchTerm)) ||
                                   (building.removedDeletedDevices && building.removedDeletedDevices.some(d => d.number.toUpperCase().includes(searchTerm)));
                return addressMatch || binMatch || deviceMatch;
            });
            
            if (matches.length === 0) {
                resultCount.textContent = 'No matches found';
                resultCount.style.display = 'inline';
                resultCount.style.color = '#ff6b6b';
                return;
            }
            
            // Show result count
            resultCount.textContent = `Found ${matches.length} building${matches.length !== 1 ? 's' : ''}`;
            resultCount.style.display = 'inline';
            resultCount.style.color = '#4CAF50';
            
            // Find the markers for matching buildings and zoom to them
            if (matches.length === 1) {
                // Single match - zoom to it and open popup
                const match = matches[0];
                const marker = mapMarkers.find(m => {
                    const latLng = m.getLatLng();
                    return Math.abs(latLng.lat - match.latitude) < 0.0001 && 
                           Math.abs(latLng.lng - match.longitude) < 0.0001;
                });
                
                if (marker && buildingMap) {
                    buildingMap.setView([match.latitude, match.longitude], 17);
                    marker.openPopup();
                }
            } else {
                // Multiple matches - fit bounds to show all
                const bounds = L.latLngBounds();
                matches.forEach(match => {
                    bounds.extend([match.latitude, match.longitude]);
                    
                    // Highlight matching markers by opening their popups briefly
                    const marker = mapMarkers.find(m => {
                        const latLng = m.getLatLng();
                        return Math.abs(latLng.lat - match.latitude) < 0.0001 && 
                               Math.abs(latLng.lng - match.longitude) < 0.0001;
                    });
                });
                
                if (buildingMap) {
                    buildingMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // Clear map search
        function clearMapSearch() {
            const searchInput = document.getElementById('mapSearchInput');
            const resultCount = document.getElementById('mapSearchResultCount');
            const monthFilter = document.getElementById('monthFilterSelect');
            
            if (searchInput) searchInput.value = '';
            if (resultCount) resultCount.style.display = 'none';
            if (monthFilter) monthFilter.value = '';
            
            // Show all markers that may have been hidden by month filter
            if (buildingMap && mapMarkers.length > 0) {
                const bounds = L.latLngBounds();
                mapMarkers.forEach(marker => {
                    // Re-add marker to map if it was removed
                    if (!buildingMap.hasLayer(marker)) {
                        buildingMap.addLayer(marker);
                    }
                    bounds.extend(marker.getLatLng());
                });
                if (bounds.isValid()) {
                    buildingMap.fitBounds(bounds, { padding: [30, 30] });
                }
            }
        }

        // Add this new function to your script section
        async function lookupAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('addressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }
                const [_, houseNumber, streetName] = match;
                
                // Build a safely encoded SoQL query
                const escapeQuotes = value => value.replace(/'/g, "''");
                const whereParts = [
                    `UPPER(house_number)='${escapeQuotes(houseNumber)}'`,
                    `UPPER(street_name) like '${escapeQuotes(streetName)}%'`
                ];

                if (borough) {
                    whereParts.push(`UPPER(borough) like '${escapeQuotes(borough)}%'`);
                }

                const params = new URLSearchParams();
                params.set('$where', whereParts.join(' AND '));
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${params.toString()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
            // Group results by BIN to avoid duplicates
            const binGroups = {};
            data.forEach(device => {
                if (!binGroups[device.bin]) {
                    binGroups[device.bin] = {
                        address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                        devices: []
                    };
                }
                binGroups[device.bin].devices.push(device);
            });

            let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                    <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                    </div>
                    <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
            `;

            for (const [bin, group] of Object.entries(binGroups)) {
                html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;
            resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearAddressLookup() {
            document.getElementById('fullAddress').value = '';
            const resultDiv = document.getElementById('addressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            
            // Clear saved address suggestions state
            window.savedAddressSuggestions = null;
            window.cameFromSuggestions = false;
            window.originalSearchTerms = { houseNumber: '', streetName: '' };
        }

        // Add event listener for Enter key
        document.getElementById('fullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAddress();
            }
        });

        // Export Modal Functions
        function showExportModal() {
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            document.getElementById('exportModal').style.display = 'flex';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // BIN Export Modal Functions
        function showBinExportModal() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            document.getElementById('binExportModal').style.display = 'flex';
        }
        
        function closeBinExportModal() {
            document.getElementById('binExportModal').style.display = 'none';
        }

        // Close BIN export modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('binExportModal');
            if (e.target === modal) {
                closeBinExportModal();
            }
        });

        // Main export function that handles both CSV and Excel for bulk export
        async function exportData() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            if (format === 'csv') {
                await exportToCSV();
            } else {
                await exportToExcel();
            }
        }

        // BIN export function that handles both formats
        async function exportBinData() {
            const format = document.querySelector('input[name="binExportFormat"]:checked').value;
            closeBinExportModal();
            if (format === 'csv') {
                await exportBinToCSV();
            } else {
                await exportBinToExcel();
            }
        }

        // Export BIN data to Excel format
        async function exportBinToExcel() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Show loading message
            const exportButton = document.getElementById('binExportButton');
            const originalText = exportButton.textContent;
            exportButton.textContent = 'Exporting...';
            exportButton.disabled = true;

            try {
                // Get building address from first device
                const buildingAddress = data[0] ? `${data[0].house_number || ''} ${data[0].street_name || ''}, ${data[0].borough || ''}`.trim() : 'N/A';
                const binNumber = data[0]?.bin || 'N/A';
                const currentYear = new Date().getFullYear();

                // Define headers
                const headers = [
                    'BIN', 'Device Number', 'Device Type', 'Status', 'Address', 'Borough', 'ZIP Code', 'Block', 'Lot',
                    `Latest CAT 1`, `Latest CAT 5`, `Latest PVI`, `Category Test ${currentYear}`, `PVI ${currentYear}`, 'Test Completion Status',
                    'Building Address', 'Latest Inspection',
                    'Violation Count', 'Violation Numbers', 'Violation Issue Dates', 'Violation Statuses', 'Violation Types', 'Violation Descriptions',
                    'Manufacturer', 'Machine Type', 'Governor Type', 'Car Buffer Type', 'Mode Operation', 'Safety Type', 'Fireman Service', 'Working Pressure',
                    'Controller Manufacturer', 'Elevator Control', 'Capacity (lbs)', 'Speed (fpm)'
                ];

                // Create an array of promises to fetch all data for each device
                const promises = data.map(async device => {
                    // Fetch violations
                    const violations = await fetchViolations(device.device_number);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    
                    // Fetch device info
                    const deviceInfo = await fetchDeviceInfo(device.device_number);
                    
                    // Calculate inspection dates
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Format dates
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check test completion status for current year
                    const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                    
                    // Check if category test was done this year
                    const isDumwaiter = device.device_type && device.device_type.toUpperCase().includes('DUMWAITER');
                    const isConveyor = device.device_type && device.device_type.toUpperCase().includes('CONVEYOR');
                    const isWheelchairLift = device.device_type && device.device_type.toUpperCase().includes('WHEELCHAIR');
                    const isHydraulic = device.device_type && (device.device_type.toUpperCase().includes('HYDRAULIC') || device.device_type.toUpperCase().includes('HYDRO'));
                    const isEscalator = device.device_type && device.device_type.toUpperCase().includes('ESCALATOR');
                    let requiresCat5 = false;
                    if (!isDumwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                        const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                        requiresCat5 = yearsSinceCat5 >= 5;
                    }
                    
                    // Determine if a valid category test was completed this year
                    let hasCategoryTestThisYear = false;
                    if (requiresCat5) {
                        hasCategoryTestThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                    } else {
                        hasCategoryTestThisYear = (cat1Date && cat1Date.getFullYear() === currentYear) || 
                                                  (cat5Date && cat5Date.getFullYear() === currentYear);
                    }
                    
                    // Check if device is dismantled or removed
                    const isDismantled = device.device_status && device.device_status.toUpperCase() === 'DISMANTLED';
                    const isRemoved = device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED');
                    
                    const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                    let testCompletionStatus = 'N/A';
                    if (isRemoved) {
                        testCompletionStatus = 'N/A';
                    } else if (isDismantled) {
                        testCompletionStatus = hasPVIThisYear ? 'Complete (PVI only required)' : 'Incomplete';
                    } else if (isConveyor) {
                        testCompletionStatus = hasCat1ThisYear ? 'Complete (CAT 1 only required)' : 'Incomplete';
                    } else if (isWheelchairLift) {
                        if (hasPVIThisYear && hasCategoryTestThisYear) {
                            testCompletionStatus = 'Complete (CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else if (isHydraulic) {
                        if (hasPVIThisYear && hasCat1ThisYear) {
                            testCompletionStatus = 'Complete (Hydraulic - CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCat1ThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else if (isEscalator) {
                        if (hasPVIThisYear && hasCat1ThisYear) {
                            testCompletionStatus = 'Complete (Escalator - CAT 5 not required)';
                        } else if (hasPVIThisYear || hasCat1ThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    } else {
                        if (hasPVIThisYear && hasCategoryTestThisYear) {
                            testCompletionStatus = 'Complete (Both tests)';
                        } else if (hasPVIThisYear || hasCategoryTestThisYear) {
                            testCompletionStatus = 'Partial (One test)';
                        } else {
                            testCompletionStatus = 'Incomplete';
                        }
                    }
                    
                    let categoryTestValue = 'N/A';
                    if (!isDismantled && !isRemoved) {
                        categoryTestValue = hasCategoryTestThisYear ? 'Yes' : 'No';
                    }
                    
                    let pviValue = 'N/A';
                    if (!isRemoved) {
                        pviValue = hasPVIThisYear ? 'Yes' : 'No';
                    }
                    
                    // Format violation details
                    const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                    const violationIssueDates = activeViolations.map(v => {
                        const date = v.violation_issue_date || v.violation_date;
                        return date ? new Date(date).toLocaleDateString() : 'N/A';
                    }).join('; ');
                    const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                    const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                    const violationDescriptions = activeViolations.map(v => {
                        const desc = v.violation_description || v.violation_remarks || 'N/A';
                        return desc;
                    }).join('; ');
                    
                    // Build row data
                    return [
                        binNumber,
                        device.device_number || 'N/A',
                        device.device_type || 'N/A',
                        device.device_status || 'N/A',
                        `${device.house_number || ''} ${device.street_name || ''}`.trim() || 'N/A',
                        device.borough || 'N/A',
                        device.zip_code || 'N/A',
                        device.block || 'N/A',
                        device.lot || 'N/A',
                        cat1Display,
                        cat5Display,
                        pviDisplay,
                        categoryTestValue,
                        pviValue,
                        testCompletionStatus,
                        buildingAddress,
                        mostRecentDisplay,
                        activeViolations.length,
                        violationNumbers || 'N/A',
                        violationIssueDates || 'N/A',
                        violationStatuses || 'N/A',
                        violationTypes || 'N/A',
                        violationDescriptions || 'N/A',
                        deviceInfo?.elevator_manufacturer || 'N/A',
                        deviceInfo?.machine_type || 'N/A',
                        deviceInfo?.governor || 'N/A',
                        deviceInfo?.car_buffer_type || 'N/A',
                        deviceInfo?.mode_of_operation || 'N/A',
                        deviceInfo?.car_safety_type || 'N/A',
                        deviceInfo?.fire_emergency_phase || 'N/A',
                        deviceInfo?.working_pressure || 'N/A',
                        deviceInfo?.controller_manufacturer || 'N/A',
                        deviceInfo?.elevator_control || 'N/A',
                        deviceInfo?.elevator_capacity_lbs || 'N/A',
                        deviceInfo?.elevator_speed_fpm || 'N/A'
                    ];
                });

                // Wait for all promises to resolve
                const rows = await Promise.all(promises);
                
                // Create worksheet data with headers
                const wsData = [headers, ...rows];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set column widths for better readability
                ws['!cols'] = headers.map((h, i) => ({ wch: Math.max(h.length, 12) }));
                
                XLSX.utils.book_append_sheet(wb, ws, 'BIN Export');
                
                // Generate and download the file
                XLSX.writeFile(wb, `bin_${binNumber}_complete_export_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                // Restore button
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('Error exporting Excel. Please try again.');
                exportButton.textContent = originalText;
                exportButton.disabled = false;
            }
        }

        // Export bulk data to Excel format
        async function exportToExcel() {
            // Fixed custom column order for export
            const COLUMN_ORDER = [
                'address',
                'bin',
                'block',
                'lot',
                'borough',
                'deviceNumber',
                'status',
                'type',
                'cat1Date',
                'cat5Date',
                'nextCat5Due',
                'pviDate',
                'testingEligibility',
                'testStatus',
                'eligibleDate',
                'violationCount',
                'violationStatuses',
                'violationIssueDates',
                'violationNumbers',
                'violationTypes',
                'violationDescriptions',
                'importantInfo',
                'permitCount',
                'permitNumbers',
                'permitIssueDates',
                'permitPermittees',
                'permitFilingStatus',
                'permitWorkTypes',
                'permitDescriptions'
            ];
            
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            
            // Get selected columns in the custom fixed order
            const checkedValues = Array.from(document.querySelectorAll('.export-column:checked')).map(cb => cb.value);
            const selectedColumns = COLUMN_ORDER.filter(col => checkedValues.includes(col));
            
            if (selectedColumns.length === 0) {
                alert('Please select at least one column to export.');
                return;
            }
            
            // Close the modal
            closeExportModal();

            // Show loading message
            const exportButton = document.getElementById('exportButton');
            const originalText = exportButton ? exportButton.textContent : 'Export Data';
            if (exportButton) {
                exportButton.textContent = 'Exporting...';
                exportButton.disabled = true;
            }

            try {
                // Define column mappings
                const columnHeaders = {
                    address: 'Address',
                    borough: 'Borough',
                    bin: 'BIN',
                    deviceNumber: 'Device Number',
                    type: 'Type',
                    status: 'Status',
                    block: 'Block',
                    lot: 'Lot',
                    testStatus: 'Test Status',
                    cat1Date: 'CAT 1 Date',
                    cat5Date: 'CAT 5 Date',
                    nextCat5Due: 'Next CAT 5 Due',
                    pviDate: 'PVI Date',
                    violationStatuses: 'Violation Statuses',
                    violationCount: 'Violation Count',
                    violationNumbers: 'Violation Numbers',
                    violationIssueDates: 'Violation Issue Dates',
                    violationTypes: 'Violation Types',
                    violationDescriptions: 'Violation Descriptions',
                    testingEligibility: 'Testing Eligibility',
                    eligibleDate: 'Eligible Date',
                    importantInfo: 'Important Information',
                    permitCount: 'Permit Count',
                    permitNumbers: 'Permit Numbers',
                    permitIssueDates: 'Permit Issue Dates',
                    permitPermittees: 'Permit Permittees',
                    permitFilingStatus: 'Permit Filing Status',
                    permitWorkTypes: 'Permit Work Types',
                    permitDescriptions: 'Permit Descriptions'
                };
                
                const currentYear = new Date().getFullYear();
                const headers = selectedColumns.map(col => columnHeaders[col]);

                // Create an array of promises to fetch data for all devices
                const devicePromises = [];
                const binGroups = deviceData.binGroups || {};
                for (const [bin, group] of Object.entries(binGroups)) {
                    group.devices.forEach(device => {
                        devicePromises.push((async () => {
                            // Fetch violations for this device
                            const violations = await fetchViolations(device.device_number);
                            const activeViolations = violations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            
                            // Fetch permit information for this device
                            const permitData = await fetchPermitInfo(device.device_number);
                            const permits = (permitData.success && permitData.permits) ? permitData.permits : [];
                            
                            // Format permit details
                            const permitNumbers = permits.map(p => p.permit_number || p.job_filing_number || 'N/A').join('; ');
                            const permitIssueDates = permits.map(p => {
                                const date = p.issuance_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const permitPermittees = permits.map(p => p.permittee_s_name || p.business_name || 'N/A').join('; ');
                            const permitFilingStatus = permits.map(p => p.filing_status || 'N/A').join('; ');
                            const permitWorkTypes = permits.map(p => p.work_type || p.application_type || 'N/A').join('; ');
                            const permitDescriptions = permits.map(p => {
                                const desc = p.description || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');
                            
                            // Format violation details
                            const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                            const violationIssueDates = activeViolations.map(v => {
                                const date = v.violation_issue_date || v.violation_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                            const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                            const violationDescriptions = activeViolations.map(v => {
                                const desc = v.violation_description || v.violation_remarks || 'N/A';
                                return desc;
                            }).join('; ');

                            // Calculate test completion status
                            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                            
                            const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                            const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                            const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                            
                            const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                            const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                            
                            // Check device type and status
                            const deviceType = (device.device_type || '').toUpperCase();
                            const deviceStatus = (device.device_status || '').toUpperCase();
                            const isDismantled = deviceStatus.includes('DISMANTLED');
                            const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                            const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                            const isConveyor = deviceType.includes('CONVEYOR');
                            const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                            const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                            const isEscalator = deviceType.includes('ESCALATOR');
                            const cat5NotApplicable = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled || isRemoved;
                            
                            let requiresCat5 = false;
                            let nextCat5Due = 'N/A';
                            if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                                const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                                requiresCat5 = yearsSinceCat5 >= 5;
                                nextCat5Due = String(cat5Date.getFullYear() + 5);
                            } else if (cat5NotApplicable) {
                                nextCat5Due = 'Not Required';
                            } else {
                                nextCat5Due = 'No CAT 5 on file';
                            }
                            
                            // Determine test status
                            let testStatus;
                            if (isRemoved) {
                                testStatus = 'No Test Required';
                            } else {
                                let allTestsCompleted = false;
                                if (isDismantled) {
                                    allTestsCompleted = hasPVIThisYear;
                                } else if (isConveyor) {
                                    allTestsCompleted = hasCat1ThisYear;
                                } else if (isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                                } else if (requiresCat5) {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear;
                                } else {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                                }
                                
                                const isWarningDevice = requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear;
                                const someTestsDone = hasPVIThisYear || hasCat1ThisYear || hasCat5ThisYear;
                                
                                if (isConveyor && hasCat1ThisYear) {
                                    testStatus = 'Testing Completed';
                                } else if (isWarningDevice) {
                                    testStatus = 'CAT 5 Required (Warning)';
                                } else if (allTestsCompleted) {
                                    testStatus = 'All Tests Completed';
                                } else if (someTestsDone) {
                                    let missingTests = [];
                                    if (isConveyor) {
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                    } else if (isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) {
                                        if (!hasPVIThisYear) missingTests.push('PVI');
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                    } else {
                                        if (!hasPVIThisYear) missingTests.push('PVI');
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                        if (requiresCat5 && !hasCat5ThisYear) missingTests.push('CAT 5');
                                    }
                                    testStatus = `Pending: ${missingTests.join(' & ')}`;
                                } else {
                                    testStatus = 'No Tests Completed';
                                }
                            }

                            // Calculate testing eligibility
                            const testDates = [pviDate, cat1Date, cat5Date].filter(date => date !== null);
                            const mostRecentTestDate = testDates.length > 0 ? new Date(Math.max.apply(null, testDates)) : null;
                            let testingEligibility = 'N/A';
                            let eligibleDateDisplay = 'N/A';
                            
                            if (isRemoved) {
                                testingEligibility = 'No Test Required';
                            } else if (mostRecentTestDate) {
                                const today = new Date();
                                const timeDiff = today - mostRecentTestDate;
                                const daysSinceLastTest = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                testingEligibility = daysSinceLastTest >= 91 ? 'Ready' : 'Not Ready';
                                
                                const eligibilityDate = new Date(mostRecentTestDate);
                                eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                                eligibleDateDisplay = eligibilityDate.toLocaleDateString();
                            }

                            // Check for Important Information
                            // All dates same check (acceptance test indicator)
                            const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                cat1Date.getTime() === cat5Date.getTime() &&
                                cat5Date.getTime() === pviDate.getTime();
                            
                            // Get missed required tests
                            const missedTests = getMissedRequiredTests(device);
                            
                            // Check for removal permits
                            let hasRemovalPermit = false;
                            let removalPermitNumber = '';
                            if (permits.length > 0) {
                                const removalPermit = permits.find(p => {
                                    const workType = (p.work_type || '').toUpperCase();
                                    const description = (p.description || '').toUpperCase();
                                    const appType = (p.application_type || '').toUpperCase();
                                    return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                           workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                           description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                           description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                           appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                });
                                if (removalPermit) {
                                    hasRemovalPermit = true;
                                    removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                }
                            }
                            
                            // Build important info string
                            let importantInfoParts = [];
                            if (allDatesAreSame) {
                                importantInfoParts.push('Data Quality Alert: All inspection dates identical (possible acceptance test)');
                            }
                            if (missedTests.length > 0) {
                                // Group missed tests by test type for cleaner display
                                const groupedMissed = {};
                                missedTests.forEach(mt => {
                                    if (!groupedMissed[mt.test]) {
                                        groupedMissed[mt.test] = [];
                                    }
                                    groupedMissed[mt.test].push(mt.year);
                                });
                                const missedTestStr = Object.keys(groupedMissed).map(test => {
                                    const years = groupedMissed[test].sort((a, b) => b - a); // Sort most recent to oldest
                                    return `${test} missed in ${years.join(', ')}`;
                                }).join('; ');
                                importantInfoParts.push(`Missed Tests: ${missedTestStr}`);
                                
                                // Add removal permit note if applicable
                                if (hasRemovalPermit) {
                                    importantInfoParts.push(`Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''} - Testing may not have been performed due to device being slated for removal`);
                                }
                            }
                            const importantInfo = importantInfoParts.length > 0 ? importantInfoParts.join(' | ') : '';

                            // Build row data object
                            const rowData = {
                                address: `${device.house_number} ${device.street_name}`,
                                borough: device.borough,
                                bin: bin,
                                deviceNumber: device.device_number,
                                type: device.device_type || 'N/A',
                                status: device.device_status || 'N/A',
                                block: device.block || 'N/A',
                                lot: device.lot || 'N/A',
                                testStatus: testStatus,
                                cat1Date: cat1Display,
                                cat5Date: cat5Display,
                                nextCat5Due: nextCat5Due,
                                pviDate: pviDisplay,
                                violationStatuses: violationStatuses || 'N/A',
                                violationCount: activeViolations.length,
                                violationNumbers: violationNumbers || 'N/A',
                                violationIssueDates: violationIssueDates || 'N/A',
                                violationTypes: violationTypes || 'N/A',
                                violationDescriptions: violationDescriptions || 'N/A',
                                testingEligibility: testingEligibility,
                                eligibleDate: eligibleDateDisplay,
                                importantInfo: importantInfo,
                                permitCount: permits.length,
                                permitNumbers: permitNumbers || 'N/A',
                                permitIssueDates: permitIssueDates || 'N/A',
                                permitPermittees: permitPermittees || 'N/A',
                                permitFilingStatus: permitFilingStatus || 'N/A',
                                permitWorkTypes: permitWorkTypes || 'N/A',
                                permitDescriptions: permitDescriptions || 'N/A'
                            };
                            
                            // Return array of selected column values
                            return selectedColumns.map(col => rowData[col] || '');
                        })());
                    });
                }

                // Wait for all promises to resolve
                const rows = await Promise.all(devicePromises);

                // Add not found devices
                if (deviceData.notFound && deviceData.notFound.length > 0) {
                    deviceData.notFound.forEach(deviceNumber => {
                        const notFoundData = {
                            address: 'N/A',
                            borough: 'N/A',
                            bin: 'Not Found',
                            deviceNumber: deviceNumber,
                            type: 'N/A',
                            status: 'N/A',
                            block: 'N/A',
                            lot: 'N/A',
                            testStatus: 'N/A',
                            cat1Date: 'N/A',
                            cat5Date: 'N/A',
                            nextCat5Due: 'N/A',
                            pviDate: 'N/A',
                            violationStatuses: 'N/A',
                            violationCount: 'N/A',
                            violationNumbers: 'N/A',
                            violationIssueDates: 'N/A',
                            violationTypes: 'N/A',
                            violationDescriptions: 'N/A',
                            testingEligibility: 'N/A',
                            eligibleDate: 'N/A',
                            importantInfo: '',
                            permitCount: 0,
                            permitNumbers: 'N/A',
                            permitIssueDates: 'N/A',
                            permitPermittees: 'N/A',
                            permitFilingStatus: 'N/A',
                            permitWorkTypes: 'N/A',
                            permitDescriptions: 'N/A'
                        };
                        rows.push(selectedColumns.map(col => notFoundData[col] || ''));
                    });
                }
                
                // Create worksheet data with headers
                const wsData = [headers, ...rows];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set column widths for better readability
                // Make certain columns wider for better display
                ws['!cols'] = headers.map((h, i) => {
                    const headerName = String(h).toLowerCase();
                    // Wide columns for descriptions and important info
                    if (headerName.includes('violation description') || headerName.includes('important information') || headerName.includes('permit description')) {
                        return { wch: 80 };
                    }
                    // Medium-wide columns
                    if (headerName.includes('violation type') || headerName === 'address' || headerName.includes('permit permittee') || headerName.includes('permit work')) {
                        return { wch: 40 };
                    }
                    // Default width
                    return { wch: Math.max(String(h).length, 15) };
                });
                
                XLSX.utils.book_append_sheet(wb, ws, 'Device Lookup');
                
                // Generate and download the file
                XLSX.writeFile(wb, `device_lookup_results_${new Date().toISOString().split('T')[0]}.xlsx`);

                // Restore button
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            } catch (error) {
                console.error('Error exporting Excel:', error);
                console.error('Error stack:', error.stack);
                alert('Error exporting Excel: ' + error.message);
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            }
        }
        
        function selectAllColumns() {
            document.querySelectorAll('.export-column').forEach(cb => cb.checked = true);
        }
        
        function deselectAllColumns() {
            document.querySelectorAll('.export-column').forEach(cb => cb.checked = false);
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('exportModal');
            if (e.target === modal) {
                closeExportModal();
            }
        });

        // Add this new function to your script section
        async function exportToCSV() {
            // Fixed custom column order for CSV export
            const CSV_COLUMN_ORDER = [
                'address',
                'bin',
                'block',
                'lot',
                'borough',
                'deviceNumber',
                'status',
                'type',
                'cat1Date',
                'cat5Date',
                'nextCat5Due',
                'pviDate',
                'testingEligibility',
                'testStatus',
                'eligibleDate',
                'violationCount',
                'violationStatuses',
                'violationIssueDates',
                'violationNumbers',
                'violationTypes',
                'violationDescriptions',
                'importantInfo',
                'permitCount',
                'permitNumbers',
                'permitIssueDates',
                'permitPermittees',
                'permitFilingStatus',
                'permitWorkTypes',
                'permitDescriptions'
            ];
            
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            
            // Get selected columns in the custom fixed order
            const checkedValues = Array.from(document.querySelectorAll('.export-column:checked')).map(cb => cb.value);
            const selectedColumns = CSV_COLUMN_ORDER.filter(col => checkedValues.includes(col));
            
            if (selectedColumns.length === 0) {
                alert('Please select at least one column to export.');
                return;
            }
            
            // Close the modal
            closeExportModal();

            // Show loading message
            const exportButton = document.getElementById('exportButton');
            const originalText = exportButton ? exportButton.textContent : 'Export to CSV';
            if (exportButton) {
                exportButton.textContent = 'Exporting...';
                exportButton.disabled = true;
            }

            try {
                // Define column mappings
                const columnHeaders = {
                    address: 'Address',
                    borough: 'Borough',
                    bin: 'BIN',
                    deviceNumber: 'Device Number',
                    type: 'Type',
                    status: 'Status',
                    block: 'Block',
                    lot: 'Lot',
                    testStatus: 'Test Status',
                    cat1Date: 'CAT 1 Date',
                    cat5Date: 'CAT 5 Date',
                    nextCat5Due: 'Next CAT 5 Due',
                    pviDate: 'PVI Date',
                    violationStatuses: 'Violation Statuses',
                    violationCount: 'Violation Count',
                    violationNumbers: 'Violation Numbers',
                    violationIssueDates: 'Violation Issue Dates',
                    violationTypes: 'Violation Types',
                    violationDescriptions: 'Violation Descriptions',
                    testingEligibility: 'Testing Eligibility',
                    eligibleDate: 'Eligible Date',
                    importantInfo: 'Important Information',
                    permitCount: 'Permit Count',
                    permitNumbers: 'Permit Numbers',
                    permitIssueDates: 'Permit Issue Dates',
                    permitPermittees: 'Permit Permittees',
                    permitFilingStatus: 'Permit Filing Status',
                    permitWorkTypes: 'Permit Work Types',
                    permitDescriptions: 'Permit Descriptions'
                };
                
                // Create CSV content with selected columns only
                const currentYear = new Date().getFullYear();
                let csvContent = selectedColumns.map(col => columnHeaders[col]).join(',') + '\n';

                // Create an array of promises to fetch violations for all devices
                const devicePromises = [];
                const binGroups = deviceData.binGroups || {};
                for (const [bin, group] of Object.entries(binGroups)) {
                    group.devices.forEach(device => {
                        devicePromises.push((async () => {
                            // Fetch violations for this device
                            const violations = await fetchViolations(device.device_number);
                            const activeViolations = violations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            
                            // Format violation details (same format as BIN export)
                            const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                            const violationIssueDates = activeViolations.map(v => {
                                const date = v.violation_issue_date || v.violation_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                            const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                            // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                            const violationDescriptions = activeViolations.map(v => {
                                const desc = v.violation_description || v.violation_remarks || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');
                            
                            // Fetch permit information for this device
                            const permitData = await fetchPermitInfo(device.device_number);
                            const permits = (permitData.success && permitData.permits) ? permitData.permits : [];
                            
                            // Format permit details
                            const permitNumbers = permits.map(p => p.permit_number || p.job_filing_number || 'N/A').join('; ');
                            const permitIssueDates = permits.map(p => {
                                const date = p.issuance_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const permitPermittees = permits.map(p => p.permittee_s_name || p.business_name || 'N/A').join('; ');
                            const permitFilingStatus = permits.map(p => p.filing_status || 'N/A').join('; ');
                            const permitWorkTypes = permits.map(p => p.work_type || p.application_type || 'N/A').join('; ');
                            const permitDescriptions = permits.map(p => {
                                const desc = p.description || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');

                            // Calculate test completion status
                            const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                            const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                            const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                            
                            const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                            const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                            const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                            
                            const hasPVIThisYear = pviDate && pviDate.getFullYear() === currentYear;
                            const hasCat1ThisYear = cat1Date && cat1Date.getFullYear() === currentYear;
                            const hasCat5ThisYear = cat5Date && cat5Date.getFullYear() === currentYear;
                            
                            // Check device type and status (DELETED is treated as REMOVED)
                            const deviceType = (device.device_type || '').toUpperCase();
                            const deviceStatus = (device.device_status || '').toUpperCase();
                            const isDismantled = deviceStatus.includes('DISMANTLED');
                            const isRemoved = deviceStatus.includes('REMOVED') || deviceStatus.includes('DELETED');
                            const isDumbwaiter = deviceType.includes('DUMBWAITER') || deviceType.includes('DUMB WAITER') || deviceType.includes('DUMWAITER');
                            const isConveyor = deviceType.includes('CONVEYOR');
                            const isWheelchairLift = deviceType.includes('WHEELCHAIR');
                            const isHydraulic = deviceType.includes('HYDRAULIC') || deviceType.includes('HYDRO');
                            const isEscalator = deviceType.includes('ESCALATOR');
                            const cat5NotApplicable = isDumbwaiter || isConveyor || isWheelchairLift || isHydraulic || isEscalator || isDismantled || isRemoved;
                            
                            // CAT 5 is only required every 5 years (Dumbwaiters, Conveyors, Wheelchair Lifts, Hydraulic elevators, and Escalators don't need CAT 5)
                            let requiresCat5 = false;
                            let nextCat5Due = 'N/A';
                            if (!isDumbwaiter && !isConveyor && !isWheelchairLift && !isHydraulic && !isEscalator && cat5Date) {
                                const yearsSinceCat5 = currentYear - cat5Date.getFullYear();
                                requiresCat5 = yearsSinceCat5 >= 5;
                                nextCat5Due = String(cat5Date.getFullYear() + 5);
                            } else if (cat5NotApplicable) {
                                nextCat5Due = 'Not Required';
                            } else {
                                nextCat5Due = 'No CAT 5 on file';
                            }
                            
                            // Determine test status
                            let testStatus;
                            if (isRemoved) {
                                testStatus = 'No Test Required';
                            } else {
                                // Determine if all required tests are completed this year
                                let allTestsCompleted = false;
                                if (isDismantled) {
                                    allTestsCompleted = hasPVIThisYear;
                                } else if (isConveyor) {
                                    allTestsCompleted = hasCat1ThisYear;
                                } else if (isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                                } else if (requiresCat5) {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear && hasCat5ThisYear;
                                } else {
                                    allTestsCompleted = hasPVIThisYear && hasCat1ThisYear;
                                }
                                
                                // Check for Warning case: CAT 1 & PVI done but CAT 5 required and not done
                                const isWarningDevice = requiresCat5 && !hasCat5ThisYear && hasCat1ThisYear && hasPVIThisYear;
                                
                                const someTestsDone = hasPVIThisYear || hasCat1ThisYear || hasCat5ThisYear;
                                
                                if (isConveyor && hasCat1ThisYear) {
                                    testStatus = 'Testing Completed';
                                } else if (isWarningDevice) {
                                    testStatus = 'CAT 5 Required (Warning)';
                                } else if (allTestsCompleted) {
                                    testStatus = 'All Tests Completed';
                                } else if (someTestsDone) {
                                    // Determine what tests are still needed
                                    let missingTests = [];
                                    if (isConveyor) {
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                    } else if (isDumbwaiter || isWheelchairLift || isHydraulic || isEscalator) {
                                        if (!hasPVIThisYear) missingTests.push('PVI');
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                    } else {
                                        if (!hasPVIThisYear) missingTests.push('PVI');
                                        if (!hasCat1ThisYear) missingTests.push('CAT 1');
                                        if (requiresCat5 && !hasCat5ThisYear) missingTests.push('CAT 5');
                                    }
                                    testStatus = `Pending: ${missingTests.join(' & ')}`;
                                } else {
                                    testStatus = 'No Tests Completed';
                                }
                            }

                            // Calculate testing eligibility based on 91-day rule
                            const testDates = [pviDate, cat1Date, cat5Date].filter(date => date !== null);
                            const mostRecentTestDate = testDates.length > 0 ? new Date(Math.max.apply(null, testDates)) : null;
                            let testingEligibility = 'N/A';
                            let eligibleDateDisplay = 'N/A';
                            
                            if (isRemoved) {
                                testingEligibility = 'No Test Required';
                                eligibleDateDisplay = 'N/A';
                            } else if (mostRecentTestDate) {
                                const today = new Date();
                                const timeDiff = today - mostRecentTestDate;
                                const daysSinceLastTest = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                testingEligibility = daysSinceLastTest >= 91 ? 'Ready' : 'Not Ready';
                                
                                // Calculate eligibility date (91 days after most recent test)
                                const eligibilityDate = new Date(mostRecentTestDate);
                                eligibilityDate.setDate(eligibilityDate.getDate() + 91);
                                eligibleDateDisplay = eligibilityDate.toLocaleDateString();
                            }

                            // Check for Important Information
                            // All dates same check (acceptance test indicator)
                            const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                                cat1Date.getTime() === cat5Date.getTime() &&
                                cat5Date.getTime() === pviDate.getTime();
                            
                            // Get missed required tests
                            const missedTests = getMissedRequiredTests(device);
                            
                            // Check for removal permits
                            let hasRemovalPermit = false;
                            let removalPermitNumber = '';
                            if (permits.length > 0) {
                                const removalPermit = permits.find(p => {
                                    const workType = (p.work_type || '').toUpperCase();
                                    const description = (p.description || '').toUpperCase();
                                    const appType = (p.application_type || '').toUpperCase();
                                    return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                           workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                           description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                           description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                           appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                });
                                if (removalPermit) {
                                    hasRemovalPermit = true;
                                    removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                }
                            }
                            
                            // Build important info string
                            let importantInfoParts = [];
                            if (allDatesAreSame) {
                                importantInfoParts.push('Data Quality Alert: All inspection dates identical (possible acceptance test)');
                            }
                            if (missedTests.length > 0) {
                                // Group missed tests by test type for cleaner display
                                const groupedMissed = {};
                                missedTests.forEach(mt => {
                                    if (!groupedMissed[mt.test]) {
                                        groupedMissed[mt.test] = [];
                                    }
                                    groupedMissed[mt.test].push(mt.year);
                                });
                                const missedTestStr = Object.keys(groupedMissed).map(test => {
                                    const years = groupedMissed[test].sort((a, b) => b - a); // Sort most recent to oldest
                                    return `${test} missed in ${years.join(', ')}`;
                                }).join('; ');
                                importantInfoParts.push(`Missed Tests: ${missedTestStr}`);
                                
                                // Add removal permit note if applicable
                                if (hasRemovalPermit) {
                                    importantInfoParts.push(`Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''} - Testing may not have been performed due to device being slated for removal`);
                                }
                            }
                            const importantInfo = importantInfoParts.length > 0 ? importantInfoParts.join(' | ') : '';

                            // Build row data object
                            const rowData = {
                                address: `${device.house_number} ${device.street_name}`,
                                borough: device.borough,
                                bin: bin,
                                deviceNumber: device.device_number,
                                type: device.device_type || 'N/A',
                                status: device.device_status || 'N/A',
                                block: device.block || 'N/A',
                                lot: device.lot || 'N/A',
                                testStatus: testStatus,
                                cat1Date: cat1Display,
                                cat5Date: cat5Display,
                                nextCat5Due: nextCat5Due,
                                pviDate: pviDisplay,
                                violationStatuses: violationStatuses || 'N/A',
                                violationCount: activeViolations.length,
                                violationNumbers: violationNumbers || 'N/A',
                                violationIssueDates: violationIssueDates || 'N/A',
                                violationTypes: violationTypes || 'N/A',
                                violationDescriptions: violationDescriptions || 'N/A',
                                testingEligibility: testingEligibility,
                                eligibleDate: eligibleDateDisplay,
                                importantInfo: importantInfo,
                                permitCount: permits.length,
                                permitNumbers: permitNumbers || 'N/A',
                                permitIssueDates: permitIssueDates || 'N/A',
                                permitPermittees: permitPermittees || 'N/A',
                                permitFilingStatus: permitFilingStatus || 'N/A',
                                permitWorkTypes: permitWorkTypes || 'N/A',
                                permitDescriptions: permitDescriptions || 'N/A'
                            };
                            
                            // Only include selected columns
                            const row = selectedColumns.map(col => {
                                const fieldStr = String(rowData[col] || '');
                                return `"${fieldStr.replace(/"/g, '""')}"`;
                            }).join(',');
                            
                            return row;
                        })());
                    });
                }

                // Wait for all promises to resolve
                const rows = await Promise.all(devicePromises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Add not found devices
                if (deviceData.notFound && deviceData.notFound.length > 0) {
                    deviceData.notFound.forEach(deviceNumber => {
                        const notFoundData = {
                            address: 'N/A',
                            borough: 'N/A',
                            bin: 'Not Found',
                            deviceNumber: deviceNumber,
                            type: 'N/A',
                            status: 'N/A',
                            block: 'N/A',
                            lot: 'N/A',
                            testStatus: 'N/A',
                            cat1Date: 'N/A',
                            cat5Date: 'N/A',
                            nextCat5Due: 'N/A',
                            pviDate: 'N/A',
                            violationStatuses: 'N/A',
                            violationCount: 'N/A',
                            violationNumbers: 'N/A',
                            violationIssueDates: 'N/A',
                            violationTypes: 'N/A',
                            violationDescriptions: 'N/A',
                            testingEligibility: 'N/A',
                            eligibleDate: 'N/A',
                            importantInfo: '',
                            permitCount: 0,
                            permitNumbers: 'N/A',
                            permitIssueDates: 'N/A',
                            permitPermittees: 'N/A',
                            permitFilingStatus: 'N/A',
                            permitWorkTypes: 'N/A',
                            permitDescriptions: 'N/A'
                        };
                        const notFoundRow = selectedColumns.map(col => {
                            const fieldStr = String(notFoundData[col] || '');
                            return `"${fieldStr.replace(/"/g, '""')}"`;
                        }).join(',');
                        csvContent += notFoundRow + '\n';
                    });
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'device_lookup_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Restore button
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                console.error('Error stack:', error.stack);
                alert('Error exporting CSV: ' + error.message);
                if (exportButton) {
                    exportButton.textContent = originalText;
                    exportButton.disabled = false;
                }
            }
        }


        // Add this function to fetch violations
        async function fetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the lookupDeviceDetails function
        async function lookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
                const violations = await fetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong>Violation #:</strong> ${v.violation_number}<br>
                                    <strong>Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong>Status:</strong> ${v.violation_status}<br>
                                    <strong>Type:</strong> ${v.violation_type}<br>
                                    <strong>Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            deviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong>Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            deviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function exportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await fetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function handleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to your JavaScript section
        function clearDeviceSearch() {
            const deviceNumber = document.getElementById('deviceNumber');
            const binNumber = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            
            // Force clear all device-related fields with explicit empty values
            if (deviceNumber) {
                deviceNumber.value = '';
                // Force trigger input event to clear any cached values
                deviceNumber.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            if (quickDeviceInput) {
                quickDeviceInput.value = '';
            }
            
            // If this was triggered by an X button next to BIN search
            if (binNumber && (binNumber === document.activeElement || binNumber.value)) {
                binNumber.value = '';
                document.getElementById('deviceResult').style.display = 'none';
            }
            
            // Clear all result displays
            document.getElementById('binResult').innerHTML = '';
            document.getElementById('binResult').style.display = 'none';
            const quickDeviceResult = document.getElementById('quickDeviceResult');
            if (quickDeviceResult) {
                quickDeviceResult.innerHTML = '';
                quickDeviceResult.style.display = 'none';
            }
            
            // Clear BIN display
            quickBinValue.textContent = '-';
            updateBinDisplayStyle();
            
            // Hide export button
            document.getElementById('binExportButton').style.display = 'none';
            
            // Show address search section when device number is cleared
            toggleAddressSearchVisibility('');
            
            // Clear saved address suggestions state
            window.savedAddressSuggestions = null;
            window.cameFromSuggestions = false;
            window.originalSearchTerms = { houseNumber: '', streetName: '' };
            
            // Small delay to ensure all clearing operations complete
            setTimeout(() => {
                if (deviceNumber) deviceNumber.value = '';
                if (quickDeviceInput) quickDeviceInput.value = '';
            }, 10);
        }

        // Add address lookup function
        async function lookupByAddress() {
            const houseNumber = document.getElementById('houseNumber').value.trim();
            const streetName = document.getElementById('streetName').value.trim();
            const resultDiv = document.getElementById('addressResult');
            const binInput = document.getElementById('binNumber');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!houseNumber || !streetName) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter both house number and street name</span>';
                resultDiv.style.display = 'block';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // First try exact match
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?house_number=${houseNumber}&street_name=${streetName}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Exact match found - proceed as normal
                    const binNumber = data[0].bin;
                    
                    if (binNumber) {
                        resultDiv.innerHTML = '<span style="color: var(--text-color);">Found address. Searching for all devices in building...</span>';
                        
                        binInput.value = binNumber;
                        quickBinValue.textContent = binNumber;
                        updateBinDisplayStyle();
                        
                        await lookupDevices();
                        resultDiv.style.display = 'none';
                    } else {
                        resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No BIN number found for this address</span>';
                    }
                } else {
                    // No exact match found - search for similar addresses
                    resultDiv.innerHTML = '<span style="color: var(--text-color);">No exact match found. Searching for similar addresses...</span>';
                    
                    await searchForSimilarAddresses(houseNumber, streetName, resultDiv, binInput, quickBinValue);
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Function to search for similar addresses when exact match fails
        async function searchForSimilarAddresses(targetHouseNumber, streetName, resultDiv, binInput, quickBinValue) {
            // Reset the cameFromSuggestions flag since we're showing new suggestions
            window.cameFromSuggestions = false;
            
            try {
                // Search for all addresses on the same street
                const streetResponse = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?street_name=${streetName}&$limit=1000`);
                
                if (!streetResponse.ok) {
                    throw new Error('Street search failed');
                }

                const streetData = await streetResponse.json();
                
                if (streetData && streetData.length > 0) {
                    const targetNum = parseInt(targetHouseNumber);
                    
                    // Get unique addresses and calculate distance from target
                    const uniqueAddresses = {};
                    const deviceCounts = {};
                    
                    streetData.forEach(device => {
                        const houseNum = device.house_number;
                        const key = `${houseNum}_${device.street_name}`;
                        
                        // Count devices per address
                        if (!deviceCounts[key]) {
                            deviceCounts[key] = 0;
                        }
                        deviceCounts[key]++;
                        
                        if (!uniqueAddresses[key] && houseNum) {
                            const numDiff = Math.abs(parseInt(houseNum) - targetNum);
                            uniqueAddresses[key] = {
                                house_number: houseNum,
                                street_name: device.street_name,
                                borough: device.borough,
                                bin: device.bin,
                                distance: numDiff,
                                deviceCount: deviceCounts[key]
                            };
                        } else if (uniqueAddresses[key]) {
                            // Update device count for existing address
                            uniqueAddresses[key].deviceCount = deviceCounts[key];
                        }
                    });
                    
                    // Sort by distance and get top 10 closest
                    const suggestions = Object.values(uniqueAddresses)
                        .filter(addr => addr.distance <= 50) // Only show addresses within 50 numbers
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 10);
                    
                    if (suggestions.length > 0) {
                        let suggestionsHtml = `
                            <div style="background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border);">
                                <h4 style="color: var(--header-color); margin-bottom: 15px;">No exact match for "${targetHouseNumber} ${streetName}"</h4>
                                <p style="margin-bottom: 15px; color: var(--text-color);">Did you mean one of these addresses?</p>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        `;
                        
                        suggestions.forEach(addr => {
                            const fullAddress = `${addr.house_number} ${addr.street_name}`;
                            const deviceText = addr.deviceCount === 1 ? 'device' : 'devices';
                            suggestionsHtml += `
                                <div style="padding: 10px; background: var(--panel-bg); border-radius: 4px; border: 1px solid var(--input-border); cursor: pointer; transition: background-color 0.2s ease;"
                                     onclick="selectSuggestedAddress('${addr.house_number}', '${addr.street_name}')"
                                     onmouseover="this.style.backgroundColor='rgba(26, 115, 232, 0.1)'"
                                     onmouseout="this.style.backgroundColor='var(--panel-bg)'">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <strong style="color: var(--header-color);">${fullAddress}</strong>
                                            ${addr.borough ? `<span style="color: var(--text-color); opacity: 0.8;"> ‚Ä¢ ${addr.borough}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 15px; font-size: 0.9em;">
                                            <span style="color: var(--header-color); font-weight: 500;">
                                                ${addr.deviceCount} ${deviceText}
                                            </span>
                                            <span style="color: var(--text-color); opacity: 0.7;">
                                                ${addr.distance === 0 ? 'Exact match' : `¬±${addr.distance} numbers`}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        suggestionsHtml += `
                                </div>
                                <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                                    Click on any address above to search for devices at that location.
                                </p>
                            </div>
                        `;
                        
                        // Save the suggestions HTML and original search terms for "Back to Suggestions" feature
                        window.savedAddressSuggestions = suggestionsHtml;
                        window.originalSearchTerms = { houseNumber: targetHouseNumber, streetName: streetName };
                        
                        resultDiv.innerHTML = suggestionsHtml;
                    } else {
                        resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No similar addresses found on this street</span>';
                    }
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No addresses found on this street</span>';
                }
            } catch (error) {
                console.error('Error searching for similar addresses:', error);
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error searching for similar addresses</span>';
            }
        }

        // Function to handle clicking on a suggested address
        async function selectSuggestedAddress(houseNumber, streetName) {
            // Set flag to indicate we came from suggestions (for "Back to Suggestions" feature)
            window.cameFromSuggestions = true;
            
            // Update the input fields
            document.getElementById('houseNumber').value = houseNumber;
            document.getElementById('streetName').value = streetName;
            
            // Trigger a new search with the selected address
            await lookupByAddress();
        }

        // Function to go back to the address suggestions list
        function showPreviousSuggestions() {
            if (window.savedAddressSuggestions) {
                const resultDiv = document.getElementById('addressResult');
                const deviceResultDiv = document.getElementById('deviceResult');
                
                // Show the saved suggestions
                resultDiv.innerHTML = window.savedAddressSuggestions;
                resultDiv.style.display = 'block';
                
                // Hide the device results
                deviceResultDiv.innerHTML = '';
                deviceResultDiv.style.display = 'none';
                
                // Restore original search terms in the input fields
                if (window.originalSearchTerms) {
                    document.getElementById('houseNumber').value = window.originalSearchTerms.houseNumber;
                    document.getElementById('streetName').value = window.originalSearchTerms.streetName;
                }
                
                // Reset the flag
                window.cameFromSuggestions = false;
                
                // Clear BIN value since we're going back to suggestions
                document.getElementById('binNumber').value = '';
                document.getElementById('quickBinValue').textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Function to load full device details from the address search results
        async function loadDeviceDetails(deviceNumber) {
            const detailsContainer = document.getElementById(`details_${deviceNumber}`);
            if (!detailsContainer) return;

            detailsContainer.innerHTML = '<span style="color: var(--text-color);">Loading full details...</span>';
            
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('deviceInfo_${deviceNumber}_inline')"
                                    style="width: 100%; padding: 10px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">‚ñº</span>
                            </button>
                            <div id="deviceInfo_${deviceNumber}_inline" style="display: none; margin-top: 10px; padding: 10px; background: var(--panel-bg); border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${Object.entries({
                                    'Manufacturer': deviceInfo.elevator_manufacturer,
                                    'Machine Type': deviceInfo.machine_type,
                                    'Governor Type': deviceInfo.governor,
                                    'Car Buffer Type': deviceInfo.car_buffer_type,
                                    'Mode Operation': deviceInfo.mode_of_operation,
                                    'Safety Type': deviceInfo.car_safety_type,
                                    'Fireman\'s Service': deviceInfo.fire_emergency_phase,
                                    'Working Pressure': deviceInfo.working_pressure,
                                    'Controller Manufacturer': deviceInfo.controller_manufacturer,
                                    'Elevator Control': deviceInfo.elevator_control,
                                    'Capacity': deviceInfo.elevator_capacity_lbs ? `${deviceInfo.elevator_capacity_lbs} lbs` : null,
                                    'Speed': deviceInfo.elevator_speed_fpm ? `${deviceInfo.elevator_speed_fpm} fpm` : null
                                }).filter(([key, value]) => value).map(([key, value]) => `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 160px;">${key}:</strong> 
                                        <span>${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '';
                    
                    detailsContainer.innerHTML = `
                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--card-shadow); color: var(--text-color); border: 1px solid var(--input-border); margin-top: 15px;">
                            <h4 style="color: var(--header-color); margin-bottom: 15px; border-bottom: 1px solid var(--input-border); padding-bottom: 10px;">Complete Device Details</h4>
                            
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Block:</strong> 
                                <span>${device.block || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Lot:</strong> 
                                <span>${device.lot || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: var(--header-color); display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('device_violations_${deviceNumber}_inline')" 
                                            id="violationsBtn_device_violations_${deviceNumber}_inline"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div id="violations_device_violations_${deviceNumber}_inline" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 15px; border-top: 1px solid var(--input-border); padding-top: 15px;">
                                <strong style="color: var(--header-color); margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: var(--header-color); display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: var(--header-color); display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            ${deviceSpecsHTML}
                        </div>
                    `;
                } else {
                    detailsContainer.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Device details not found</span>';
                }
            } catch (error) {
                detailsContainer.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error loading device details. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        // Clear address search function
        function clearAddressSearch() {
            document.getElementById('houseNumber').value = '';
            document.getElementById('streetName').value = '';
            document.getElementById('addressResult').innerHTML = '';
            document.getElementById('addressResult').style.display = 'none';
            
            // Clear saved address suggestions state
            window.savedAddressSuggestions = null;
            window.cameFromSuggestions = false;
            window.originalSearchTerms = { houseNumber: '', streetName: '' };
        }

        // Add this new function to your script section
        async function quickLookupBIN() {
            const deviceNumber = document.getElementById('quickDeviceNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            const binInput = document.getElementById('quickBinNumber');
            
            if (!deviceNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    binInput.value = device.bin || '';
                    if (device.bin) {
                        quickLookupDevices();
                    }

                    // Fetch violations for this device
                    const violations = await fetchViolations(deviceNumber);
                    const activeViolations = violations.filter(v => 
                        v.violation_status?.toUpperCase() === 'ACTIVE' || 
                        v.violation_status?.toUpperCase() === 'OPEN');
                    const violationCount = activeViolations.length;

                    // Fetch detailed device information
                    const deviceInfo = await fetchDeviceInfo(deviceNumber);
                    
                    // Fetch permit information to check for removal permits
                    const permitResult = await fetchPermitInfo(deviceNumber);
                    const hasPermits = permitResult.success && permitResult.permits && permitResult.permits.length > 0;
                    const permitData = permitResult;

                    // Format dates and calculate most recent inspection
                    const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                    const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                    const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                    
                    // Find most recent date
                    const dates = [cat1Date, cat5Date, pviDate].filter(date => date !== null);
                    const mostRecentDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    
                    // Calculate days since most recent inspection
                    const today = new Date();
                    const daysSinceInspection = mostRecentDate ? 
                        Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    // Format dates for display
                    const cat1Display = cat1Date ? cat1Date.toLocaleDateString() : 'N/A';
                    const cat5Display = cat5Date ? cat5Date.toLocaleDateString() : 'N/A';
                    const pviDisplay = pviDate ? pviDate.toLocaleDateString() : 'N/A';
                    const mostRecentDisplay = mostRecentDate ? mostRecentDate.toLocaleDateString() : 'N/A';
                    
                    // Check if all dates are the same (CAT 1, CAT 5, PVI, and Latest Inspection)
                    const allDatesAreSame = cat1Date && cat5Date && pviDate && mostRecentDate &&
                        cat1Date.getTime() === cat5Date.getTime() &&
                        cat5Date.getTime() === pviDate.getTime() &&
                        pviDate.getTime() === mostRecentDate.getTime();
                    
                    // Apply red styling if all dates are the same
                    const dateStyle = allDatesAreSame ? 'color: red; font-weight: bold;' : '';
                    
                    // Generate device specification HTML if available
                    const deviceSpecsHTML = deviceInfo ? `
                        <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                            <button onclick="toggleDeviceInfo('quickDeviceInfo_${deviceNumber}')"
                                    style="width: 100%; padding: 10px; background: #2c2c2c; color: #ffffff; border: 1px solid #444; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>Device Information</span>
                                <span class="arrow">‚ñº</span>
                            </button>
                            <div id="quickDeviceInfo_${deviceNumber}" style="display: none; margin-top: 10px; padding: 10px; background: #2c2c2c; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                ${deviceInfo.elevator_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Manufacturer:</strong> 
                                        <span>${deviceInfo.elevator_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.machine_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Machine Type:</strong> 
                                        <span>${deviceInfo.machine_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.governor ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Governor Type:</strong> 
                                        <span>${deviceInfo.governor || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_buffer_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Car Buffer Type:</strong> 
                                        <span>${deviceInfo.car_buffer_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.mode_of_operation ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Mode Operation:</strong> 
                                        <span>${deviceInfo.mode_of_operation || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.car_safety_type ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Safety Type:</strong> 
                                        <span>${deviceInfo.car_safety_type || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.fire_emergency_phase ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Fireman's Service:</strong> 
                                        <span>${deviceInfo.fire_emergency_phase || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.working_pressure ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Working Pressure:</strong> 
                                        <span>${deviceInfo.working_pressure || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.controller_manufacturer ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Controller Manufacturer:</strong> 
                                        <span>${deviceInfo.controller_manufacturer || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_control ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Elevator Control:</strong> 
                                        <span>${deviceInfo.elevator_control || 'N/A'}</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_capacity_lbs ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Capacity:</strong> 
                                        <span>${deviceInfo.elevator_capacity_lbs || 'N/A'} lbs</span>
                                    </div>` : ''}
                                ${deviceInfo.elevator_speed_fpm ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 160px;">Speed:</strong> 
                                        <span>${deviceInfo.elevator_speed_fpm || 'N/A'} fpm</span>
                                    </div>` : ''}
                            </div>
                        </div>
                    ` : '';
                        
                    resultDiv.innerHTML = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Number:</strong> 
                                <span style="${dateStyle}">${device.device_number || deviceNumber}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">BIN:</strong> 
                                ${device.bin ? `
                                    <span onclick="copyBinToClipboard('${device.bin}', event)" 
                                          title="Click to copy"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; 
                                                 transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
                                                 border: 1px solid var(--input-border); background: var(--panel-bg);">
                                        ${device.bin}
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;">
                                            <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                    </span>
                                ` : '<span>N/A</span>'}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Address:</strong> 
                                <span>${device.house_number ? device.house_number + ' ' + device.street_name : 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Borough:</strong> 
                                <span>${device.borough || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Device Type:</strong> 
                                <span>${device.device_type || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Status:</strong> 
                                <span>${device.device_status || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">ZIP Code:</strong> 
                                <span>${device.zip_code || 'N/A'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4a9eff; display: inline-block; width: 120px;">Violations:</strong> 
                                <span style="color: ${violationCount > 0 ? '#ff6b6b' : '#ffffff'}">
                                    ${violationCount > 0 ? `${violationCount} active` : 'None'}
                                </span>
                            </div>
                            ${violationCount > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button onclick="toggleViolations('quick_device_violations_${deviceNumber}')" 
                                            id="violationsBtn_quick_device_violations_${deviceNumber}"
                                            style="width: 100%; padding: 8px; background: var(--panel-bg); color: var(--text-color); 
                                                   border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; 
                                                   font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Show Violation Details</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div id="violations_quick_device_violations_${deviceNumber}" style="display: none; margin-top: 8px; 
                                         padding: 8px; background: var(--panel-bg); border-radius: 4px; font-size: 0.9em; max-height: 200px; overflow-y: auto; border: 1px solid var(--input-border); box-shadow: 0 2px 4px var(--card-shadow);">
                                        ${activeViolations.map(v => `
                                            <div style="margin-bottom: 10px; padding: 10px; background: var(--input-bg); border-radius: 5px; border: 1px solid var(--input-border);">
                                                <strong style="color: var(--header-color);">Violation #:</strong> ${v.violation_number}<br>
                                                <strong style="color: var(--header-color);">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                                <strong style="color: var(--header-color);">Status:</strong> ${v.violation_status}<br>
                                                <strong style="color: var(--header-color);">Type:</strong> ${v.violation_type || 'N/A'}<br>
                                                <strong style="color: var(--header-color);">Remarks:</strong> ${v.violation_remarks || 'N/A'}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                                <strong style="color: #4a9eff; margin-bottom: 10px; display: block;">Inspection History:</strong>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 1:</strong> 
                                    <span style="${dateStyle}">${cat1Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest CAT 5:</strong> 
                                    <span style="${dateStyle}">${cat5Display}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest PVI:</strong> 
                                    <span style="${dateStyle}">${pviDisplay}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4a9eff; display: inline-block; width: 120px;">Latest Inspection:</strong> 
                                    <span style="${dateStyle}">${mostRecentDisplay}</span>
                                    ${mostRecentDate ? 
                                        `<br><span style="color: #888; margin-left: 120px; font-size: 0.9em;">
                                            (from ${
                                                mostRecentDate.getTime() === cat1Date?.getTime() ? 'CAT 1' :
                                                mostRecentDate.getTime() === cat5Date?.getTime() ? 'CAT 5' :
                                                'PVI'
                                            })
                                        </span>` : 
                                        ''}
                                </div>
                                ${daysSinceInspection !== null ? 
                                    `<div style="margin-bottom: 10px;">
                                        <strong style="color: #4a9eff; display: inline-block; width: 120px;">Days Since Last Inspection:</strong> 
                                        <span style="color: ${daysSinceInspection >= 90 ? '#4CAF50' : '#ff6b6b'}">
                                            ${daysSinceInspection} days
                                        </span>
                                    </div>` : 
                                    ''}
                            </div>
                            
                            <!-- Add Important dropdown for red devices -->
                            ${allDatesAreSame ? `
                                <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                                    <button onclick="toggleImportantDropdown('quick_device_${device.device_number || deviceNumber}')"
                                            style="width: 100%; padding: 10px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                        <span>‚ö†Ô∏è Important</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div id="important_quick_device_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b;">
                                        <div style="margin-bottom: 8px;">
                                            <strong style="color: #ff6b6b;">Data Quality Alert</strong>
                                        </div>
                                        <div style="margin-bottom: 8px; color: var(--text-color);">
                                            This device is highlighted in red because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection test are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Add Important dropdown for missed required tests -->
                            ${(() => {
                                const missedTests = getMissedRequiredTests(device);
                                if (missedTests.length > 0) {
                                    // Check if device has a removal permit
                                    let hasRemovalPermit = false;
                                    let removalPermitNumber = '';
                                    if (hasPermits && permitData.permits) {
                                        const removalPermit = permitData.permits.find(p => {
                                            const workType = (p.work_type || '').toUpperCase();
                                            const description = (p.description || '').toUpperCase();
                                            const appType = (p.application_type || '').toUpperCase();
                                            return workType.includes('REMOVAL') || workType.includes('REMOVE') || 
                                                   workType.includes('DISMANTLE') || workType.includes('DISCONTINUE') ||
                                                   description.includes('REMOVAL') || description.includes('REMOVE ELEVATOR') ||
                                                   description.includes('DISMANTLE') || description.includes('DISCONTINUE') ||
                                                   appType.includes('REMOVAL') || appType.includes('DISMANTLE');
                                        });
                                        if (removalPermit) {
                                            hasRemovalPermit = true;
                                            removalPermitNumber = removalPermit.permit_number || removalPermit.job_filing_number || '';
                                        }
                                    }
                                    
                                    const missedTestsList = missedTests.map(mt => 
                                        `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                            <strong style="color: #ff9800;">${mt.test}</strong> test missed in <strong>${mt.year}</strong>
                                            <br><span style="font-size: 0.9em; opacity: 0.8;">Last ${mt.test} test on record: ${mt.lastTestDate}</span>
                                        </div>`
                                    ).join('');
                                    
                                    const removalPermitNote = hasRemovalPermit ? `
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; border: 1px solid #2196F3;">
                                            <div style="color: #2196F3; font-weight: 500; margin-bottom: 4px;">
                                                üìã Removal Permit Found${removalPermitNumber ? ': ' + removalPermitNumber : ''}
                                            </div>
                                            <div style="font-size: 0.85em; opacity: 0.9;">
                                                Testing may not have been performed due to the device being slated for removal. Please verify the current status with the DOB.
                                            </div>
                                        </div>
                                    ` : '';
                                    
                                    return `
                                        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                                            <button onclick="toggleMissedTestDropdown('quick_device_${device.device_number || deviceNumber}')"
                                                    style="width: 100%; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                                                <span>‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})</span>
                                                <span class="arrow">‚ñº</span>
                                            </button>
                                            <div id="missed_test_quick_device_${device.device_number || deviceNumber}" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">
                                                <div style="margin-bottom: 8px;">
                                                    <strong style="color: #ff9800;">Missed Required Test Alert</strong>
                                                </div>
                                                <div style="color: var(--text-color);">
                                                    ${missedTestsList}
                                                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                                                        CAT 1 and PVI tests are required annually. CAT 5 tests are required every 5 years. Please verify this information with official DOB records.
                                                    </div>
                                                    ${removalPermitNote}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                                return '';
                            })()}
                            
                            ${deviceSpecsHTML}
                            
                        </div>`;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No device found with this number</span>';
                    binInput.value = '';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up device. Please try again later.</span>';
                console.error('Error:', error);
                binInput.value = '';
            }
        }

        // Add this new function to handle the dropdown toggle
        function toggleMoreInfo(elementId) {
            const element = document.getElementById(elementId);
            const button = element.previousElementSibling;
            const arrow = button.querySelector('.arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                element.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        // Add event listener for Enter key
        document.getElementById('quickDeviceNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupBIN();
            }
        });

        // Add the new lookupDevices function
        async function quickLookupDevices() {
            const binNumber = document.getElementById('quickBinNumber').value.trim();
            const resultDiv = document.getElementById('quickDeviceResult');
            
            if (!binNumber) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter a BIN number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?bin=${binNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Store the data for CSV export
                    window.lastBinSearchResults = data;
                    document.getElementById('binExportButton').style.display = 'block';
                    
                    const address = `${data[0].house_number} ${data[0].street_name}, ${data[0].borough}`;
                    
                    // Count active, removed, and dismantled devices (DELETED is treated as REMOVED)
                    const removedDevices = data.filter(device => 
                        device.device_status && (device.device_status.toUpperCase() === 'REMOVED' || device.device_status.toUpperCase() === 'DELETED')
                    ).length;
                    const dismantledDevices = data.filter(device => 
                        device.device_status && device.device_status.toUpperCase() === 'DISMANTLED'
                    ).length;
                    const activeDevices = data.filter(device => 
                        !device.device_status || 
                        (device.device_status.toUpperCase() !== 'REMOVED' && 
                         device.device_status.toUpperCase() !== 'DELETED' &&
                         device.device_status.toUpperCase() !== 'DISMANTLED')
                    ).length;

                    // Add back the device grouping code
                    const deviceTypes = {};
                    data.forEach(device => {
                            const type = device.device_type || 'Unknown';
                            if (!deviceTypes[type]) {
                                deviceTypes[type] = [];
                            }
                            deviceTypes[type].push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #4a9eff;">Building Address:</strong> 
                                <span>${address}</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: #4a9eff;">Total Devices Found:</strong> 
                                        <span>${data.length}</span>
                                    </div>
                                    <div>
                                        <strong style="color: #4a9eff;">Total Active Violations:</strong> 
                                        <span style="color: ${activeDevices > 0 ? '#ff6b6b' : 'var(--text-color)'}">
                                            ${activeDevices > 0 ? activeDevices : 'None'}
                                        </span>
                                    </div>
                                </div>
                                <span style="margin-left: 20px; color: ${activeDevices > 0 ? '#4CAF50' : 'var(--text-color)'};">‚Ä¢ Active Devices: ${activeDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${dismantledDevices > 0 ? '#ffd700' : 'var(--text-color)'};">‚Ä¢ Dismantled Devices: ${dismantledDevices}</span>
                                <br>
                                <span style="margin-left: 20px; color: ${removedDevices > 0 ? '#ff6b6b' : 'var(--text-color)'};">‚Ä¢ Removed/Deleted Devices: ${removedDevices}</span>
                            </div>
                            <div style="margin-top: 20px;">
                                <strong style="color: #4a9eff; display: block; margin-bottom: 10px;">Devices by Type:</strong>
                                <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;
                    
                    // First display elevators if they exist
                    if (deviceTypes['ELEVATOR']) {
                        html += generateDeviceTypeSection('ELEVATOR', deviceTypes['ELEVATOR']);
                        delete deviceTypes['ELEVATOR']; // Remove elevators so they're not shown again
                    }
                    
                    // Then display the rest of the device types
                    for (const [type, devices] of Object.entries(deviceTypes)) {
                        html += generateDeviceTypeSection(type, devices);
                    }
                    
                    html += `</div></div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No devices found for this BIN number</span>';
                    window.lastBinSearchResults = null;
                    document.getElementById('binExportButton').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                window.lastBinSearchResults = null;
                document.getElementById('binExportButton').style.display = 'none';
            }
        }

        // Add event listener for Enter key on BIN input
        document.getElementById('quickBinNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupDevices();
            }
        });

        // Add this new function to your script section
        function clearQuickLookups() {
            // Clear input fields
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickBinResult').style.display = 'none';
            document.getElementById('quickDeviceResult').style.display = 'none';
            document.getElementById('binExportButton').style.display = 'none';
            window.lastBinSearchResults = null;
            
            // Also clear the Quick Filing Information BIN field
            const quickBinInput = document.getElementById('quickBinInput');
            if (quickBinInput) {
                quickBinInput.value = '';
                localStorage.removeItem('quickBinInputInfo');
            }
        }

        // Add these new functions to your script section
        async function quickLookupBulkDevices() {
            const textarea = document.getElementById('quickBulkDeviceNumbers');
            const resultDiv = document.getElementById('quickBulkResult');
            
            const deviceNumbers = textarea.value.split('\n')
                .map(num => num.trim())
                .filter(num => num !== '');

            if (deviceNumbers.length === 0) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter at least one device number</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up devices...</span>';
            resultDiv.style.display = 'block';

            try {
                // Create an object to group devices by BIN
                const binGroups = {};
                const notFound = [];

                // Look up each device
                for (const deviceNumber of deviceNumbers) {
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const device = data[0];
                        const bin = device.bin || 'Unknown BIN';
                        
                        if (!binGroups[bin]) {
                            binGroups[bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[bin].devices.push(device);
                    } else {
                        notFound.push(deviceNumber);
                    }
                }

                    let html = `
                    <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #4a9eff;">Total Devices Searched:</strong> 
                            <span>${deviceNumbers.length}</span>
                            </div>
                        <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                `;

                // Display grouped devices
                for (const [bin, group] of Object.entries(binGroups)) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                <strong style="color: #4a9eff;">Devices Found:</strong> ${group.devices.length}
                            </div>
                            <div style="padding-left: 15px;">
                    `;

                    group.devices.forEach(device => {
                        // Check if all dates are the same (acceptance test indicator)
                        const cat1Date = device.cat1_latest_report_filed ? new Date(device.cat1_latest_report_filed) : null;
                        const cat5Date = device.cat5_latest_report_filed ? new Date(device.cat5_latest_report_filed) : null;
                        const pviDate = device.periodic_latest_inspection ? new Date(device.periodic_latest_inspection) : null;
                        const allDatesAreSame = cat1Date && cat5Date && pviDate &&
                            cat1Date.getTime() === cat5Date.getTime() &&
                            cat5Date.getTime() === pviDate.getTime();
                        
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px; ${allDatesAreSame ? 'border-left: 3px solid #ff6b6b;' : ''}">
                                <strong style="color: #4a9eff;">Device Number:</strong> <span style="${allDatesAreSame ? 'color: #ff6b6b; font-weight: bold;' : ''}">${device.device_number}${allDatesAreSame ? ' ‚ö†Ô∏è' : ''}</span><br>
                                <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Block:</strong> ${device.block || 'N/A'}<br>
                                <strong style="color: #4a9eff;">Lot:</strong> ${device.lot || 'N/A'}
                                ${allDatesAreSame ? `
                                <div style="margin-top: 10px;">
                                    <details style="margin: 0;">
                                        <summary style="padding: 6px 10px; cursor: pointer; color: #ff6b6b; font-weight: 600; font-size: 0.9em; background: rgba(255, 107, 107, 0.15); border-radius: 4px;">
                                            ‚ö†Ô∏è Important - Data Quality Alert
                                        </summary>
                                        <div style="padding: 10px; margin-top: 8px; background: rgba(255, 107, 107, 0.1); border-radius: 4px; border: 1px solid #ff6b6b;">
                                            <div style="color: #ffffff; font-size: 0.9em;">
                                                This device is highlighted because all three inspection dates (CAT 1, CAT 5, and PVI) are identical. This may indicate that an acceptance test was performed on this device. If acceptance test was performed no additional inspection tests are required for that calendar year. Please check the official DOB site to verify the legitimacy of this information.
                                            </div>
                                        </div>
                                    </details>
                                </div>
                                ` : ''}
                                ${(() => {
                                    const missedTests = getMissedRequiredTests(device);
                                    if (missedTests.length > 0) {
                                        const missedTestsList = missedTests.map(mt => 
                                            `<div style="margin-bottom: 6px; padding: 6px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                                <strong style="color: #ff9800;">${mt.test}</strong> missed in <strong>${mt.year}</strong>
                                                <br><span style="font-size: 0.85em; opacity: 0.8;">Last: ${mt.lastTestDate}</span>
                                            </div>`
                                        ).join('');
                                        return `
                                        <div style="margin-top: 10px;">
                                            <details style="margin: 0;">
                                                <summary style="padding: 6px 10px; cursor: pointer; color: #ff9800; font-weight: 600; font-size: 0.9em; background: rgba(255, 152, 0, 0.15); border-radius: 4px;">
                                                    ‚ö†Ô∏è Important - Missed Required Test${missedTests.length > 1 ? 's' : ''} (${missedTests.length})
                                                </summary>
                                                <div style="padding: 10px; margin-top: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border: 1px solid #ff9800;">
                                                    <div style="color: #ffffff; font-size: 0.9em;">
                                                        ${missedTestsList}
                                                        <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">CAT 1 and PVI are required annually. CAT 5 every 5 years.</div>
                                                    </div>
                                                </div>
                                            </details>
                                        </div>
                                        `;
                                    }
                                    return '';
                                })()}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Display devices not found
                if (notFound.length > 0) {
                    html += `
                        <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="color: #ff6b6b;">
                                <strong>Devices Not Found:</strong>
                                <div style="margin-top: 5px;">
                                    ${notFound.join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;

                // Store the results for CSV export
                window.lastBulkSearchResults = {
                    binGroups: binGroups,
                    notFound: notFound
                };

                // Show the export button if we have results
                document.getElementById('exportButton').style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up devices. Please try again later.</span>';
                console.error('Error:', error);
                document.getElementById('exportButton').style.display = 'none';
            }
        }

        function clearQuickBulkLookup() {
            document.getElementById('quickBulkDeviceNumbers').value = '';
            const resultDiv = document.getElementById('quickBulkResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            document.getElementById('exportButton').style.display = 'none';
            window.lastBulkSearchResults = null;
        }

        // Add this new function to your script section
        async function quickLookupAddress() {
            const fullAddress = document.getElementById('quickFullAddress').value.trim().toUpperCase();
            const resultDiv = document.getElementById('quickAddressResult');
            
            if (!fullAddress) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter an address</span>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<span style="color: var(--text-color);">Looking up address...</span>';
            resultDiv.style.display = 'block';

            try {
                // Parse address into components (e.g., "120 Broadway, Manhattan")
                const addressParts = fullAddress.split(',').map(part => part.trim());
                const streetAddress = addressParts[0];
                const borough = addressParts[1] || '';

                // Split street address into house number and street name
                const match = streetAddress.match(/^(\d+)\s+(.+)$/);
                if (!match) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Please enter address in format: "123 Street Name, Borough"</span>';
                    return;
                }

                const [_, houseNumber, streetName] = match;
                
                // Build the query
                const query = `$where=UPPER(house_number)='${houseNumber}' AND UPPER(street_name) like '${streetName}%'${borough ? ` AND UPPER(borough) like '${borough}%'` : ''}`;
                const url = `https://data.cityofnewyork.us/resource/e5aq-a4j2.json?${query}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    // Group results by BIN to avoid duplicates
                    const binGroups = {};
                    data.forEach(device => {
                        if (!binGroups[device.bin]) {
                            binGroups[device.bin] = {
                                address: `${device.house_number} ${device.street_name}, ${device.borough}`,
                                devices: []
                            };
                        }
                        binGroups[device.bin].devices.push(device);
                    });

                    let html = `
                        <div style="background: #1c1c1c; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: #ffffff; border: 1px solid #333;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #4a9eff;">Buildings Found:</strong> ${Object.keys(binGroups).length}
                            </div>
                            <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                    `;

                    for (const [bin, group] of Object.entries(binGroups)) {
                        html += `
                            <div style="background: #2c2c2c; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                                    <strong style="color: #4a9eff;">BIN:</strong> ${bin}<br>
                                    <strong style="color: #4a9eff;">Address:</strong> ${group.address}<br>
                                    <strong style="color: #4a9eff;">Total Devices:</strong> ${group.devices.length}
                                </div>
                            </div>
                        `;
                    }

                    html += `</div></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">No buildings found at this address</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-weight: 500;">Error looking up address. Please try again later.</span>';
                console.error('Error:', error);
            }
        }

        function clearQuickAddressLookup() {
            document.getElementById('quickFullAddress').value = '';
            const resultDiv = document.getElementById('quickAddressResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        // Add event listener for Enter key
        document.getElementById('quickFullAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                quickLookupAddress();
            }
        });

        // Add this new function to your script section
        async function quickExportToCSV() {
            // Get the stored data from the last search
            const deviceData = window.lastBulkSearchResults;
            if (!deviceData || (!deviceData.binGroups && !deviceData.notFound)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            try {
                // Create CSV content with violation columns
                let csvContent = 'Device Number,BIN,Address,Borough,Type,Status,Block,Lot,' +
                    'Violation Count,Violation Numbers,Violation Issue Dates,Violation Statuses,Violation Types,Violation Descriptions\n';
                
                // Create an array of promises to fetch violations for all devices
                const devicePromises = [];
                for (const [bin, group] of Object.entries(deviceData.binGroups)) {
                    group.devices.forEach(device => {
                        devicePromises.push((async () => {
                            // Fetch violations for this device
                            const violations = await fetchViolations(device.device_number);
                            const activeViolations = violations.filter(v => 
                                v.violation_status?.toUpperCase() === 'ACTIVE' || 
                                v.violation_status?.toUpperCase() === 'OPEN');
                            
                            // Format violation details (same format as BIN export)
                            const violationNumbers = activeViolations.map(v => v.violation_number || 'N/A').join('; ');
                            const violationIssueDates = activeViolations.map(v => {
                                const date = v.violation_issue_date || v.violation_date;
                                return date ? new Date(date).toLocaleDateString() : 'N/A';
                            }).join('; ');
                            const violationStatuses = activeViolations.map(v => v.violation_status || 'N/A').join('; ');
                            const violationTypes = activeViolations.map(v => v.violation_type || 'N/A').join('; ');
                            // Get violation descriptions (use violation_description if available, otherwise use violation_remarks)
                            const violationDescriptions = activeViolations.map(v => {
                                const desc = v.violation_description || v.violation_remarks || 'N/A';
                                return desc.replace(/"/g, '""');
                            }).join('; ');

                            const row = [
                                device.device_number,
                                bin,
                                `${device.house_number} ${device.street_name}`,
                                device.borough,
                                device.device_type || 'N/A',
                                device.device_status || 'N/A',
                                device.block || 'N/A',
                                device.lot || 'N/A',
                                activeViolations.length,
                                violationNumbers || 'N/A',
                                violationIssueDates || 'N/A',
                                violationStatuses || 'N/A',
                                violationTypes || 'N/A',
                                violationDescriptions || 'N/A'
                            ].map(field => {
                                // Escape quotes and wrap in quotes
                                const fieldStr = String(field || '');
                                return `"${fieldStr.replace(/"/g, '""')}"`;
                            }).join(',');
                            
                            return row;
                        })());
                    });
                }

                // Wait for all promises to resolve
                const rows = await Promise.all(devicePromises);
                
                // Add all rows to CSV content
                rows.forEach(row => {
                    csvContent += row + '\n';
                });

                // Add not found devices
                if (deviceData.notFound && deviceData.notFound.length > 0) {
                    deviceData.notFound.forEach(deviceNumber => {
                        csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                    });
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'device_lookup_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please try again.');
            }
        }

        function quickExportBinToCSV() {
            const data = window.lastBinSearchResults;
            if (!data || data.length === 0) {
                alert('No data to export. Please perform a search first.');
                return;
            }
            // Create CSV content
            let csvContent = 'Device Number,BIN,Address,Borough,Type,Status\n';

            // Add all devices
            data.forEach(device => {
                const row = [
                    device.device_number,
                    device.bin,
                    `${device.house_number} ${device.street_name}`,
                    device.borough,
                    device.device_type || 'N/A',
                    device.device_status || 'N/A'
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bin_${data[0].bin}_devices.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add this function to fetch violations
        async function quickFetchViolations(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?device_number=${deviceNumber}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching violations:', error);
                return [];
            }
        }

        // Update the quickLookupDeviceDetails function
        async function quickLookupDeviceDetails(deviceNumber) {
            // ... existing device lookup code ...

            // Add violations lookup
            const violations = await quickFetchViolations(deviceNumber);
            
            // Add violations to the details display
            let violationsHtml = '';
            if (violations.length > 0) {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${violations.map(v => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #1c1c1c; border-radius: 5px;">
                                    <strong style="color: #4a9eff;">Violation #:</strong> ${v.violation_number}<br>
                                    <strong style="color: #4a9eff;">Issue Date:</strong> ${new Date(v.violation_issue_date).toLocaleDateString()}<br>
                                    <strong style="color: #4a9eff;">Status:</strong> ${v.violation_status}<br>
                                    <strong style="color: #4a9eff;">Type:</strong> ${v.violation_type}<br>
                                    <strong style="color: #4a9eff;">Remarks:</strong> ${v.violation_remarks}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                violationsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                        <h4 style="color: #4a9eff;">Violations:</h4>
                        <p>No violations found for this device.</p>
                    </div>
                `;
            }

            // Update the details display to include violations
            quickDeviceDetailsDiv.innerHTML = `
                <div style="background: #2c2c2c; padding: 20px; border-radius: 5px; margin-top: 20px;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px;">Device Details</h3>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #4a9eff;">Device #:</strong> ${deviceNumber}<br>
                        <strong style="color: #4a9eff;">Status:</strong> ${device.device_status || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Type:</strong> ${device.device_type || 'N/A'}<br>
                        <strong style="color: #4a9eff;">Address:</strong> ${device.house_number} ${device.street_name}, ${device.borough}<br>
                        <strong style="color: #4a9eff;">BIN:</strong> ${device.bin || 'N/A'}
                    </div>
                    ${violationsHtml}
                </div>
            `;
            quickDeviceDetailsDiv.style.display = 'block';
        }

        // Update the CSV export to include violations
        function quickExportDevicesToCSV() {
            const deviceData = window.lastSearchResults;
            if (!deviceData || (!deviceData.found || deviceData.found.length === 0) && (!deviceData.notFound || deviceData.notFound.length === 0)) {
                alert('No data to export. Please perform a search first.');
                return;
            }

            // Create CSV content with violations
            let csvContent = 'Device Number,Status,Type,Address,BIN,Violations\n';

            // Add found devices
            if (deviceData.found) {
                deviceData.found.forEach(async device => {
                    const violations = await quickFetchViolations(device.device_number);
                    const violationCount = violations.length;
                    const violationStatus = violations.map(v => v.violation_status).join('; ');
                    
                    const row = [
                        device.device_number,
                        device.device_status || 'N/A',
                        device.device_type || 'N/A',
                        `${device.house_number} ${device.street_name}, ${device.borough}`,
                        device.bin || 'N/A',
                        `${violationCount} (${violationStatus})`
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            }

            // Add not found devices
            if (deviceData.notFound && deviceData.notFound.length > 0) {
                deviceData.notFound.forEach(deviceNumber => {
                    csvContent += `"${deviceNumber}","Not Found","N/A","N/A","N/A","N/A"\n`;
                });
            }

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'quick_device_search_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add these functions to your script section
        async function quickHandleDOBLogin() {
            // Get stored credentials or prompt user
            const username = prompt("Enter DOB NOW username:");
            const password = prompt("Enter DOB NOW password:");
            
            if (!username || !password) {
                alert("Username and password are required");
                return;
            }

            try {
                // Open DOB NOW in a new window
                const dobWindow = window.open('https://a810-dobnow.nyc.gov/publish/Index.html#!/', '_blank');
                
                if (!dobWindow) {
                    alert("Please allow pop-ups to use this feature");
                    return;
                }

                // Wait for the page to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Attempt to fill in credentials
                dobWindow.postMessage({
                    type: 'LOGIN',
                    username: username,
                    password: password
                }, 'https://a810-dobnow.nyc.gov');

            } catch (error) {
                console.error('Login failed:', error);
                alert('Login automation failed. Please try logging in manually.');
            }
        }

        // Add this function to ensure proper light/dark mode in results
        function applyColorTheme() {
            // Force theme on any elements with hardcoded dark backgrounds
            document.querySelectorAll('[style*="background: #1c1c1c"], [style*="background: #2c2c2c"]').forEach(el => {
                el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--input-bg');
                el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
            });
        }

        // Call this function after generating results
        // Add these lines at the end of the lookupDevices() function
        resultDiv.innerHTML = html;
        applyColorTheme();

        // Updated function to also display days since the last update
        async function fetchAPILastUpdateDate() {
            try {
                // Get reference to the element displaying the update date
                const apiLastUpdatedElement = document.getElementById('apiLastUpdated');
                if (!apiLastUpdatedElement) return;
                
                // Set loading state
                apiLastUpdatedElement.textContent = "Loading...";
                
                try {
                    // Get the dataset metadata using the correct endpoint format (same as violations API)
                    const datasetId = 'e5aq-a4j2'; // DOB Elevator Device dataset ID
                    const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                    
                    const metadataResponse = await fetch(metadataUrl);
                    if (!metadataResponse.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    
                    const metadata = await metadataResponse.json();
                    
                    // Extract the last updated date from the metadata
                    // rowsUpdatedAt is typically a Unix timestamp in seconds, so multiply by 1000
                    let updateDate;
                    if (metadata.rowsUpdatedAt) {
                        // Handle Unix timestamp (seconds) - multiply by 1000 to get milliseconds
                        updateDate = new Date(metadata.rowsUpdatedAt * 1000);
                    } else if (metadata.dataUpdatedAt) {
                        // Try dataUpdatedAt as fallback
                        updateDate = new Date(metadata.dataUpdatedAt * 1000);
                    } else if (metadata.viewLastModified) {
                        // Try viewLastModified as fallback
                        updateDate = new Date(metadata.viewLastModified);
                    } else {
                        throw new Error('No update date found in metadata');
                    }
                    
                    // Only update if we got a valid date
                    if (!isNaN(updateDate.getTime())) {
                        const formattedDate = updateDate.toLocaleDateString('en-US', { 
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric'
                        });
                        apiLastUpdatedElement.textContent = formattedDate;
                        console.log("API data last updated:", formattedDate);
                    } else {
                        throw new Error('Invalid date format from API');
                    }
                    
                    // Calculate days since update
                    // Normalize both dates to midnight to compare calendar days, not hours
                    const today = new Date();
                    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                    const timeDiff = todayMidnight - updateDateMidnight;
                    const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Get or create the days since element
                    let daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (!daysSinceElement) {
                        daysSinceElement = document.createElement('div');
                        daysSinceElement.id = 'daysSinceUpdate';
                        daysSinceElement.style.textAlign = 'center';
                        daysSinceElement.style.fontSize = '0.9em';
                        daysSinceElement.style.color = 'var(--text-color)';
                        daysSinceElement.style.opacity = '0.8';
                        daysSinceElement.style.marginTop = '5px';
                        
                        // Insert after the apiLastUpdated parent element
                        const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                        parentElement.appendChild(daysSinceElement);
                    }
                    
                    // Display appropriate message based on days with new color thresholds
                    if (daysSinceUpdate <= 0) {
                        daysSinceElement.textContent = "Updated today";
                        daysSinceElement.style.color = "#4CAF50"; // Green for today
                    } else if (daysSinceUpdate === 1) {
                        daysSinceElement.textContent = "Updated 1 day ago";
                        daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                    } else if (daysSinceUpdate < 14) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                    } else if (daysSinceUpdate < 30) {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                    } else {
                        daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                        daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                    }
                } catch (innerError) {
                    console.error('Error in primary fetch:', innerError);
                    
                    // If we can't fetch the date, try to fetch from the actual dataset with a fallback
                    try {
                        const apiResponse = await fetch('https://data.cityofnewyork.us/resource/e5aq-a4j2.json?$query=SELECT%20:created_at,%20:updated_at%20LIMIT%201');
                        if (apiResponse.ok) {
                            const apiData = await apiResponse.json();
                            if (apiData && apiData.length > 0) {
                                // Try to get the updated_at timestamp from the actual data
                                let updateTimeString = apiData[0][":updated_at"] || apiData[0][":created_at"];
                                if (updateTimeString) {
                                    const updateDate = new Date(updateTimeString);
                                    if (!isNaN(updateDate.getTime())) {
                                        const formattedDate = updateDate.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        });
                                        
                                        apiLastUpdatedElement.textContent = formattedDate;
                                        
                                        // Calculate and display days since update
                                        // Normalize both dates to midnight to compare calendar days, not hours
                                        const today = new Date();
                                        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                        const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                                        const timeDiff = todayMidnight - updateDateMidnight;
                                        const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                        
                                        let daysSinceElement = document.getElementById('daysSinceUpdate');
                                        if (!daysSinceElement) {
                                            daysSinceElement = document.createElement('div');
                                            daysSinceElement.id = 'daysSinceUpdate';
                                            daysSinceElement.style.textAlign = 'center';
                                            daysSinceElement.style.fontSize = '0.9em';
                                            daysSinceElement.style.color = 'var(--text-color)';
                                            daysSinceElement.style.opacity = '0.8';
                                            daysSinceElement.style.marginTop = '5px';
                                            
                                            const parentElement = apiLastUpdatedElement.parentElement.parentElement;
                                            parentElement.appendChild(daysSinceElement);
                                        }
                                        
                                        // Display appropriate message based on days
                                        if (daysSinceUpdate <= 0) {
                                            daysSinceElement.textContent = "Updated today";
                                            daysSinceElement.style.color = "#4CAF50"; // Green for today
                                        } else if (daysSinceUpdate === 1) {
                                            daysSinceElement.textContent = "Updated 1 day ago";
                                            daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                                        } else if (daysSinceUpdate < 14) {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                                        } else if (daysSinceUpdate < 30) {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                                        } else {
                                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                                            daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                                        }
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Fallback fetch also failed:', fallbackError);
                    }
                    
                    // If all else fails, display an error message
                    apiLastUpdatedElement.textContent = "Unable to fetch update date";
                    
                    // Remove the days since update element if it exists
                    const daysSinceElement = document.getElementById('daysSinceUpdate');
                    if (daysSinceElement) {
                        daysSinceElement.parentElement.removeChild(daysSinceElement);
                    }
                }
            } catch (outerError) {
                console.error('Outer error in fetchAPILastUpdateDate:', outerError);
            }
        }

        // Call this function when the DOB tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on the DOB tab initially or when tab changes
            const dobTab = document.getElementById('dobTab');
            if (dobTab) {
                dobTab.addEventListener('click', function() {
                    fetchAPILastUpdateDate();
                    fetchViolationsAPILastUpdateDate();
                });
            }
            
            // Check if DOB tab is the default tab on load or if DOB content is currently active
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            const dobContent = document.getElementById('dobContent');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            
            if (defaultTab === 'dob' || isDOBActive) {
                fetchAPILastUpdateDate();
                fetchViolationsAPILastUpdateDate();
            }
        });
        // Restore the missing functions for ELV3 lookup functionality
        function toggleQuickLookup() {
            const panel = document.getElementById('quickLookupPanel');
            const overlay = document.getElementById('quickLookupOverlay');
            const dobContent = document.getElementById('dobContent');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            const dobLookupToggleBtn = document.getElementById('dobLookupToggleBtn');
            const dobNowBtn = document.getElementById('dobNowBtn');

            const opening = (panel.style.display === 'none' || panel.style.display === '');

            if (opening) {
                panel.style.display = 'block';

                // If we're on the DOB tab, don't show overlay (no shading)
                if (isDOBActive) {
                    // Don't shift the page and don't show overlay - panel overlays without dimming
                    overlay.style.display = 'none';
                    document.body.style.overflow = '';
                } else {
                    // Mobile or other tabs: use overlay to focus the panel
                    overlay.style.display = 'block';
                    // Prevent background scrolling when overlay is used
                    document.body.style.overflow = 'hidden';
                }

                // Hide the floating DOB buttons while panel is open on DOB tab (all sizes)
                if (isDOBActive) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                }

                // Position panel based on screen width
                if (window.innerWidth <= 600) {
                    panel.classList.add('panel-centered-mobile');
                } else {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }

                // Add a small delay before adding opacity for smooth transition
                setTimeout(() => {
                    if (overlay.style.display === 'block') overlay.style.opacity = '1';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(0)';
                }, 10);

                // Ensure the panel is visible regardless of which tab is active
                panel.style.zIndex = '2000';

                // Bring the panel to the front of all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    if (panel.parentElement === section) {
                        document.body.appendChild(panel);
                    }
                });
            } else {
                // Closing
                if (isDOBActive) {
                    document.body.classList.remove('dob-shifted-for-lookup');
                    if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                    if (dobContent) {
                        dobContent.style.marginRight = '';
                        dobContent.style.marginLeft = '';
                    }
                }
                // Show the floating DOB buttons again
                if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                if (dobNowBtn) dobNowBtn.style.display = '';

                // Restore background scrolling when panel is closed
                document.body.style.overflow = '';

                overlay.style.opacity = '0';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-20px)';

                // Wait for transition to complete before hiding
                setTimeout(() => {
                    panel.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        // Add click handler to close panel when clicking overlay
        document.getElementById('quickLookupOverlay').addEventListener('click', function() {
            toggleQuickLookup();
        });

        // Open the ELV3 Lookup panel in a dedicated window
        function popoutQuickLookup() {
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('popout', 'lookup');
                const features = 'width=440,height=720,resizable=yes,scrollbars=yes';
                window.open(url.toString(), '_blank', features);
            } catch (e) {
                // Fallback if URL API not supported
                const href = window.location.href + (window.location.search ? '&' : '?') + 'popout=lookup';
                window.open(href, '_blank', 'width=440,height=720,resizable=yes,scrollbars=yes');
            }
        }

        // If opened with popout=lookup, render only the ELV3 Lookup panel full-screen
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('popout') === 'lookup') {
                document.body.classList.add('lookup-popout-mode');

                const panel = document.getElementById('quickLookupPanel');
                const overlay = document.getElementById('quickLookupOverlay');

                if (panel) {
                    panel.style.display = 'block';
                    panel.style.opacity = '1';
                    panel.style.transform = 'none';
                    panel.style.zIndex = '1';

                    // Make the close button close the window in popout mode
                    const closeBtn = panel.querySelector('button[onclick="toggleQuickLookup()"]');
                    if (closeBtn) {
                        closeBtn.title = 'Close window';
                        closeBtn.onclick = function() { window.close(); };
                    }
                    // Reposition popout icon away from the edge in popout mode and align with X
                    const popBtn = panel.querySelector('button[onclick="popoutQuickLookup()"]');
                    if (popBtn) {
                        popBtn.style.right = '44px';
                        popBtn.style.top = '10px';
                        popBtn.style.fontSize = '20px';
                    }
                }
                if (overlay) {
                    overlay.style.display = 'none';
                }

                // Hide everything except the panel
                const hideSelectors = ['.content-section', '#dobNowBtn'];
                hideSelectors.forEach(sel => {
                    document.querySelectorAll(sel).forEach(el => { el.style.display = 'none'; });
                });
            }
        });

        // Add scroll event handling to prevent background scrolling
        document.addEventListener('DOMContentLoaded', function() {
            const panel = document.getElementById('quickLookupPanel');
            
            if (panel) {
                // Prevent scroll events from bubbling up to the document
                panel.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                    
                    // Check if the panel is scrollable and at the boundary
                    const scrollTop = panel.scrollTop;
                    const scrollHeight = panel.scrollHeight;
                    const clientHeight = panel.clientHeight;
                    
                    // If scrolling up and already at the top
                    if (e.deltaY < 0 && scrollTop === 0) {
                        e.preventDefault();
                        panel.scrollTop = 0;
                    }
                    // If scrolling down and already at the bottom
                    else if (e.deltaY > 0 && scrollTop + clientHeight >= scrollHeight) {
                        e.preventDefault();
                        panel.scrollTop = scrollHeight - clientHeight;
                    }
                }, { passive: false });
                
                // Handle touch events for mobile
                panel.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }
        });
        // Add these new functions for the quick lookup panel
        document.getElementById('quickNumInput').addEventListener('input', function(e) {
            let result = numberToWord(e.target.value);
            document.getElementById('quickNumResult').textContent = result;
        });

        document.getElementById('quickLetterInput').addEventListener('input', function(e) {
            let result = letterToWord(e.target.value);
            document.getElementById('quickLetterResult').textContent = result;
        });

        document.getElementById('quickSecondaryNumInput').addEventListener('input', function(e) {
            let result = secondaryNumberToWord(e.target.value);
            document.getElementById('quickSecondaryNumResult').textContent = result;
        });

        function quickClearInputs() {
            const numInput = document.getElementById('quickNumInput');
            const letterInput = document.getElementById('quickLetterInput');
            const secondaryNumInput = document.getElementById('quickSecondaryNumInput');
            const numResult = document.getElementById('quickNumResult');
            const letterResult = document.getElementById('quickLetterResult');
            const secondaryNumResult = document.getElementById('quickSecondaryNumResult');
            
            // Capture input and result values BEFORE clearing
            const numValue = numInput.value;
            const letterValue = letterInput.value;
            const secondaryNumValue = secondaryNumInput.value;
            const numResultValue = numResult.textContent;
            const letterResultValue = letterResult.textContent;
            const secondaryNumResultValue = secondaryNumResult.textContent;
            
            // Save to log before clearing
            saveToLogWithResults(numValue, letterValue, secondaryNumValue, numResultValue, letterResultValue, secondaryNumResultValue);
            
            // Now clear everything
            numInput.value = '';
            letterInput.value = '';
            secondaryNumInput.value = '';
            numResult.textContent = '';
            letterResult.textContent = '';
            secondaryNumResult.textContent = '';
            numInput.focus();
        }

        function clearQuickNotes() {
            const notesField = document.getElementById('quickNotesInput');
            if (notesField) {
                notesField.value = '';
                // Clear from localStorage
                localStorage.removeItem('quickNotesContent');
                notesField.focus();
            }
        }

        function quickClearDeviceSearch() {
            document.getElementById('quickDeviceNumber').value = '';
            document.getElementById('quickBinNumber').value = '';
            document.getElementById('quickDeviceResult').style.display = 'none';
        }

        // Add this function to fetch violations for all devices by BIN
        async function fetchViolationsForBin(bin) {
            try {
                // This will get all violations for the given BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/855j-jady.json?$where=bin='${bin}'`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Group violations by device number for easier lookup
                const violationsByDevice = {};
                data.forEach(violation => {
                    const deviceNum = violation.device_number;
                    if (!violationsByDevice[deviceNum]) {
                        violationsByDevice[deviceNum] = [];
                    }
                    violationsByDevice[deviceNum].push(violation);
                });
                
                return violationsByDevice;
            } catch (error) {
                console.error('Error fetching violations for BIN:', error);
                return {};
            }
        }

        // Add this function to handle custom days input changes
        function customDaysChanged() {
            const dateStr = document.getElementById('dateInput').value;
            const customDays = document.getElementById('customDays').value;
            
            // Only perform the calculation if we have both a date and a days value
            if (dateStr && customDays && !isNaN(parseInt(customDays))) {
                calculateCustomDate();
            }
        }

        // Add event listener for the custom days input
        document.addEventListener('DOMContentLoaded', function() {
            // Existing date input listener
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', dateChanged);
            }
            
            // New custom days input listener
            const customDaysInput = document.getElementById('customDays');
            if (customDaysInput) {
                customDaysInput.addEventListener('input', customDaysChanged);
            }
        });

        // Add media query handling for responsive ELV3 Lookup button
        function handleResponsiveELV3Button() {
            const buttonTexts = document.querySelectorAll('.button-text');
            const buttonIcons = document.querySelectorAll('.button-icon');
            const lookupButton = document.querySelector('button[onclick="toggleQuickLookup()"]');
            const panel = document.getElementById('quickLookupPanel');
            const dobContent = document.getElementById('dobContent');
            const dobLookupToggleBtn = document.getElementById('dobLookupToggleBtn');
            const dobNowBtn = document.getElementById('dobNowBtn');
            const isDOBActive = dobContent && dobContent.classList.contains('active');
            const panelOpen = panel && panel.style.display === 'block';
            
            if (window.innerWidth < 600) {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'none';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'block';
                });
                // Make button more compact on mobile
                if (lookupButton) {
                    lookupButton.style.padding = '10px';
                    lookupButton.style.borderRadius = '50%';
                    lookupButton.style.width = '44px';
                    lookupButton.style.height = '44px';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.add('panel-centered-mobile');
                }
                // Hide DOB buttons if panel open on DOB
                if (isDOBActive && panelOpen) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                }
            } else if (window.innerWidth <= 900) {
                // Medium screens: remove body/content shift; keep overlay behavior
                document.body.classList.remove('dob-shifted-for-lookup');
                if (dobContent) dobContent.classList.remove('dob-shifted-for-lookup');
                if (dobContent) {
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                }
                
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'block';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'none';
                });
                if (lookupButton) {
                    lookupButton.style.padding = '12px 20px';
                    lookupButton.style.borderRadius = '4px';
                    lookupButton.style.width = 'auto';
                    lookupButton.style.height = 'auto';
                }
                if (panel && panel.style.display === 'block') {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
                // Hide DOB buttons if panel open on DOB
                if (isDOBActive && panelOpen) {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                } else {
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                    if (dobNowBtn) dobNowBtn.style.display = '';
                }
            } else {
                buttonTexts.forEach(buttonText => {
                    buttonText.style.display = 'block';
                });
                buttonIcons.forEach(buttonIcon => {
                    buttonIcon.style.display = 'none';
                });
                // Restore button style on desktop
                if (lookupButton) {
                    lookupButton.style.padding = '12px 20px';
                    lookupButton.style.borderRadius = '4px';
                    lookupButton.style.width = 'auto';
                    lookupButton.style.height = 'auto';
                }
                // Reposition panel if it's visible
                if (panel && panel.style.display === 'block') {
                    panel.classList.remove('panel-centered-mobile');
                    panel.style.right = '20px';
                    panel.style.left = 'auto';
                    panel.style.margin = '0';
                }
                // If panel open on DOB, compute centered margins and hide buttons
                if (isDOBActive && panelOpen) {
                    // Ensure inline margins cleared; class drives spacing
                    dobContent.style.marginRight = '';
                    dobContent.style.marginLeft = '';
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = 'none';
                    if (dobNowBtn) dobNowBtn.style.display = 'none';
                } else {
                    if (dobContent) {
                        dobContent.style.marginRight = '';
                        dobContent.style.marginLeft = '';
                    }
                    if (dobLookupToggleBtn) dobLookupToggleBtn.style.display = '';
                    if (dobNowBtn) dobNowBtn.style.display = '';
                }
            }
        }
        
        // Run on page load
        handleResponsiveELV3Button();
        
        // Run on window resize
        window.addEventListener('resize', handleResponsiveELV3Button);



        // Function to fetch the last update date for the violations API
        async function fetchViolationsAPILastUpdateDate() {
            try {
                // Get reference to the element displaying the update date
                const violationsApiLastUpdatedElement = document.getElementById('violationsApiLastUpdated');
                if (!violationsApiLastUpdatedElement) return;
                
                // Set loading state
                violationsApiLastUpdatedElement.textContent = "Loading...";
                
                try {
                    // Get the dataset metadata using the correct endpoint format
                    const datasetId = '855j-jady'; // DOB Safety Violations dataset ID
                    const metadataUrl = `https://data.cityofnewyork.us/api/views/${datasetId}.json`;
                    
                    const metadataResponse = await fetch(metadataUrl);
                    if (!metadataResponse.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    
                    const metadata = await metadataResponse.json();
                    
                    // Extract the last updated date from the metadata
                    // rowsUpdatedAt is typically a Unix timestamp in seconds, so multiply by 1000
                    let updateDate;
                    if (metadata.rowsUpdatedAt) {
                        // Handle Unix timestamp (seconds) - multiply by 1000 to get milliseconds
                        updateDate = new Date(metadata.rowsUpdatedAt * 1000);
                    } else if (metadata.dataUpdatedAt) {
                        // Try dataUpdatedAt as fallback
                        updateDate = new Date(metadata.dataUpdatedAt * 1000);
                    } else if (metadata.viewLastModified) {
                        // Try viewLastModified as fallback
                        updateDate = new Date(metadata.viewLastModified);
                    } else {
                        throw new Error('No update date found in metadata');
                    }
                    
                    // Only update if we got a valid date
                    if (!isNaN(updateDate.getTime())) {
                        const formattedDate = updateDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        violationsApiLastUpdatedElement.textContent = formattedDate;
                        console.log("Violations API data last updated:", formattedDate);
                    } else {
                        throw new Error('Invalid date format from API');
                    }
                    
                    // Calculate days since update
                    // Normalize both dates to midnight to compare calendar days, not hours
                    const today = new Date();
                    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const updateDateMidnight = new Date(updateDate.getFullYear(), updateDate.getMonth(), updateDate.getDate());
                    const timeDiff = todayMidnight - updateDateMidnight;
                    const daysSinceUpdate = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Get the days since element
                    const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                    
                    if (daysSinceElement) {
                        // Display appropriate message based on days
                        if (daysSinceUpdate <= 0) {
                            daysSinceElement.textContent = "Updated today";
                            daysSinceElement.style.color = "#4CAF50"; // Green for today
                        } else if (daysSinceUpdate === 1) {
                            daysSinceElement.textContent = "Updated 1 day ago";
                            daysSinceElement.style.color = "#4CAF50"; // Green for 1 day
                        } else if (daysSinceUpdate < 14) {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#4CAF50"; // Green for data less than 14 days old
                        } else if (daysSinceUpdate < 30) {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#FFA500"; // Yellow/Orange for data 14-29 days old
                        } else {
                            daysSinceElement.textContent = `Updated ${daysSinceUpdate} days ago`;
                            daysSinceElement.style.color = "#FF6B6B"; // Red for data 30+ days old
                        }
                    }
                } catch (innerError) {
                    console.error('Error in primary fetch:', innerError);
                    
                    // If we can't fetch the date, show an error message
                    violationsApiLastUpdatedElement.textContent = "Unable to fetch update date";
                    
                    // Remove the days since update element if it exists
                    const daysSinceElement = document.getElementById('violationsDaysSinceUpdate');
                    if (daysSinceElement) {
                        daysSinceElement.parentElement.removeChild(daysSinceElement);
                    }
                }
            } catch (outerError) {
                console.error('Outer error in fetchViolationsAPILastUpdateDate:', outerError);
            }
        }

        // Add event listener to call the function when the violations tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Call the function immediately when the page loads
            fetchViolationsAPILastUpdateDate();
            
            // Also set up the tab click listener
            const violationsTab = document.getElementById('violationsTab');
            if (violationsTab) {
                violationsTab.addEventListener('click', fetchViolationsAPILastUpdateDate);
            }
            
            // Also check if violations tab is the default tab on load
            const defaultTab = localStorage.getItem('defaultTab') || 'main';
            if (defaultTab === 'violations') {
                fetchViolationsAPILastUpdateDate();
            }
            
            // Update API data on page load
            updateAllAPIData();
        });

        // Function to update all API data
        function updateAllAPIData() {
            // Update both APIs immediately
            fetchAPILastUpdateDate();
            fetchViolationsAPILastUpdateDate();
            console.log(`API data updated at ${new Date().toLocaleTimeString()}`);
        }

        // Add these new functions for filtering
        function toggleViolationsFilter() {
            const button = document.getElementById('violationsFilterBtn');
            const buttonText = document.getElementById('violationsFilterText');
            const isFiltering = button.getAttribute('data-filtering') === 'true';
            
            if (!isFiltering) {
                // Enable filtering - show only devices with violations
                button.setAttribute('data-filtering', 'true');
                buttonText.textContent = 'Show All Devices';
                button.style.background = '#1a73e8';
                button.style.color = 'white';
                button.style.width = '240px';
            } else {
                // Disable filtering - show all devices
                button.setAttribute('data-filtering', 'false');
                buttonText.textContent = 'Show Only Devices with Violations';
                button.style.background = 'var(--panel-bg)';
                button.style.color = 'var(--text-color)';
                button.style.width = '240px';
            }
            
            // Re-apply all filters using the centralized function
            if (typeof window.applyAllFilters === 'function') {
                window.applyAllFilters();
            } else {
                filterDevicesByType();
            }
        }
        
        function filterDevicesByType() {
            const deviceTypeFilter = document.getElementById('deviceTypeFilter');
            if (!deviceTypeFilter) return;
            
            const typeFilter = deviceTypeFilter.value;
            const deviceItems = document.querySelectorAll('.device-item');
            const violationsFilterBtn = document.getElementById('violationsFilterBtn');
            const violationsFiltering = violationsFilterBtn ? violationsFilterBtn.getAttribute('data-filtering') === 'true' : false;
            
            deviceItems.forEach(item => {
                const deviceType = item.getAttribute('data-device-type');
                const deviceStatus = item.getAttribute('data-device-status');
                const hasViolations = item.getAttribute('data-has-violations') === 'true';
                
                let shouldShow = false;
                
                if (typeFilter === 'all') {
                    shouldShow = true;
                } else if (typeFilter === 'REMOVED') {
                    // Show only removed/deleted devices regardless of their original type
                    shouldShow = deviceStatus === 'REMOVED' || deviceStatus === 'DELETED';
                } else {
                    // Show devices of specific type that are not removed/deleted
                    shouldShow = deviceType === typeFilter && deviceStatus !== 'REMOVED' && deviceStatus !== 'DELETED';
                }
                
                // Apply violations filter if active
                if (shouldShow && violationsFiltering && !hasViolations) {
                    shouldShow = false;
                }
                
                item.style.display = shouldShow ? '' : 'none';
            });
            
            updateDeviceTypeSectionVisibility();
        }
        
        function toggleBothTestsList() {
            const button = document.getElementById('bothTestsListBtn');
            const listDiv = document.getElementById('bothTestsDevicesList');
            const buttonText = document.getElementById('bothTestsListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#4CAF50';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleOneTestList() {
            const button = document.getElementById('oneTestListBtn');
            const listDiv = document.getElementById('oneTestDevicesList');
            const buttonText = document.getElementById('oneTestListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ffd700';
                button.style.color = '#000';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleNoTestsList() {
            const button = document.getElementById('noTestsListBtn');
            const listDiv = document.getElementById('noTestsDevicesList');
            const buttonText = document.getElementById('noTestsListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ff6b6b';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleWarningList() {
            const button = document.getElementById('warningListBtn');
            const listDiv = document.getElementById('warningDevicesList');
            const buttonText = document.getElementById('warningListText');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the list
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide Devices';
                button.style.background = '#ff9800';
                button.style.color = '#fff';
            } else {
                // Hide the list
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show Devices';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleRemovedDevices() {
            const button = document.getElementById('removedDevicesToggleBtn');
            const listDiv = document.getElementById('removedDeviceTypeSections');
            const buttonText = document.getElementById('removedDevicesToggleText');
            const icon = document.getElementById('removedDevicesToggleIcon');
            
            if (!button || !listDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the removed devices
                button.setAttribute('data-showing', 'true');
                listDiv.style.display = 'block';
                buttonText.textContent = 'Hide';
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
                button.style.background = '#ff6b6b';
                button.style.color = '#fff';
            } else {
                // Hide the removed devices
                button.setAttribute('data-showing', 'false');
                listDiv.style.display = 'none';
                buttonText.textContent = 'Show';
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function toggleTestCompletionStatus() {
            const button = document.getElementById('testCompletionStatusBtn');
            const contentDiv = document.getElementById('testCompletionStatusContent');
            const buttonText = document.getElementById('testCompletionStatusText');
            
            if (!button || !contentDiv) return;
            
            const isShowing = button.getAttribute('data-showing') === 'true';
            
            if (!isShowing) {
                // Show the content
                button.setAttribute('data-showing', 'true');
                contentDiv.style.display = 'block';
                buttonText.textContent = 'Hide';
                button.style.background = 'var(--header-color)';
                button.style.color = '#fff';
            } else {
                // Hide the content
                button.setAttribute('data-showing', 'false');
                contentDiv.style.display = 'none';
                buttonText.textContent = 'Show';
                button.style.background = 'var(--input-bg)';
                button.style.color = 'var(--text-color)';
            }
        }
        
        function resetFilters() {
            // Reset violations filter
            const violationsFilterBtn = document.getElementById('violationsFilterBtn');
            if (violationsFilterBtn) {
                violationsFilterBtn.setAttribute('data-filtering', 'false');
                violationsFilterBtn.style.background = 'var(--panel-bg)';
                violationsFilterBtn.style.color = 'var(--text-color)';
                violationsFilterBtn.style.width = '240px';
            }
            
            const violationsFilterText = document.getElementById('violationsFilterText');
            if (violationsFilterText) {
                violationsFilterText.textContent = 'Show Only Devices with Violations';
            }
            
            // Reset type filter
            const deviceTypeFilter = document.getElementById('deviceTypeFilter');
            if (deviceTypeFilter) {
                deviceTypeFilter.value = 'all';
            }
            
            // Reset test eligibility filter
            const testEligibilityFilter = document.getElementById('testEligibilityFilter');
            if (testEligibilityFilter) {
                testEligibilityFilter.value = 'all';
            }
            
            // Hide both tests list if it's showing
            const bothTestsListBtn = document.getElementById('bothTestsListBtn');
            if (bothTestsListBtn && bothTestsListBtn.getAttribute('data-showing') === 'true') {
                toggleBothTestsList();
            }
            
            // Hide one test list if it's showing
            const oneTestListBtn = document.getElementById('oneTestListBtn');
            if (oneTestListBtn && oneTestListBtn.getAttribute('data-showing') === 'true') {
                toggleOneTestList();
            }
            
            // Hide warning list if it's showing
            const warningListBtn = document.getElementById('warningListBtn');
            if (warningListBtn && warningListBtn.getAttribute('data-showing') === 'true') {
                toggleWarningList();
            }
            
            // Show all devices
            document.querySelectorAll('.device-item').forEach(item => {
                item.style.display = '';
            });
            
            // Show all sections
            document.querySelectorAll('.device-type-section').forEach(section => {
                section.style.display = '';
            });
            
            // Show removed devices section if it exists
            const removedDevicesContainer = document.getElementById('removedDeviceTypeSections');
            if (removedDevicesContainer && removedDevicesContainer.parentElement) {
                removedDevicesContainer.parentElement.style.display = '';
            }
        }
        
        function updateDeviceTypeSectionVisibility() {
            // Hide sections that have no visible devices
            document.querySelectorAll('.device-type-section').forEach(section => {
                const visibleDevices = section.querySelectorAll('.device-item:not([style*="display: none"])');
                const totalDevices = section.querySelectorAll('.device-item');
                
                if (visibleDevices.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            });
            
            // Also handle the removed devices section container
            const removedDevicesContainer = document.getElementById('removedDeviceTypeSections');
            if (removedDevicesContainer) {
                const visibleRemovedSections = removedDevicesContainer.querySelectorAll('.device-type-section:not([style*="display: none"])');
                const removedSectionTitle = removedDevicesContainer.previousElementSibling;
                
                if (visibleRemovedSections.length === 0) {
                    removedDevicesContainer.parentElement.style.display = 'none';
                } else {
                    removedDevicesContainer.parentElement.style.display = '';
                }
            }
        }
        
        // Function to toggle all violations (show or hide)
        function toggleAllViolations() {
            const toggleButton = document.getElementById('toggleAllViolationsBtn');
            const isShowing = toggleButton.getAttribute('data-showing') === 'true';
            
            // Find all devices with violations
            const devicesWithViolations = document.querySelectorAll('.device-item[data-has-violations="true"]');
            
            if (!isShowing) {
                // Show all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display === 'none') {
                                // Only click if violations are not already shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Hide All Violations';
                toggleButton.setAttribute('data-showing', 'true');
            } else {
                // Hide all violations
                devicesWithViolations.forEach(device => {
                    // Find the violations button within this device item
                    const violationsButtons = device.querySelectorAll('button');
                    violationsButtons.forEach(button => {
                        if (button.id.startsWith('violationsBtn_')) {
                            const violationsDiv = document.getElementById('violations_' + button.id.replace('violationsBtn_', ''));
                            if (violationsDiv && violationsDiv.style.display !== 'none') {
                                // Only click if violations are currently shown
                                button.click();
                            }
                        }
                    });
                });
                
                // Update button text and state
                toggleButton.textContent = 'Show All Violations';
                toggleButton.setAttribute('data-showing', 'false');
            }
        }

        // Function to fetch permit information for a device's BIN
        async function fetchPermitInfo(deviceNumber) {
            try {
                // First get the device details to get the BIN
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const device = data[0];
                    const binNumber = device.bin;
                    let allPermits = [];
                    let success = false;
                    
                    // Try to find permits that specifically mention this device number
                    if (binNumber) {
                        try {
                            // First try to find permits that specifically mention this device number in the description
                            const deviceQuery = `$where=bin='${binNumber}' AND descriptionofwork like '%${deviceNumber}%'`;
                            const deviceSpecificResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?${deviceQuery}`);
                            
                            if (deviceSpecificResponse.ok) {
                                const deviceSpecificData = await deviceSpecificResponse.json();
                                if (deviceSpecificData && deviceSpecificData.length > 0) {
                                    // Normalize the data structure to match our expected format
                                    const normalizedData = deviceSpecificData.map(permit => ({
                                        permit_number: permit.job_filing_number || permit.job_number,
                                        permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                            `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                            permit.applicant_businessname || 'N/A',
                                        issuance_date: permit.filing_date,
                                        expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                        house_number: permit.house_number,
                                        street_name: permit.street_name,
                                        application_type: permit.filing_type,
                                        work_type: permit.elevatordevicetype,
                                        filing_status: permit.filing_status,
                                        job_filing_number: permit.job_filing_number,
                                        business_name: permit.applicant_businessname || permit.owner_businessname,
                                        description: permit.descriptionofwork,
                                        device_specific: true
                                    }));
                                    allPermits = [...normalizedData];
                                    success = true;
                                }
                            }
                            
                            // If no exact match found, try looking for permits that might be for this device
                            if (allPermits.length === 0) {
                                // Get all permits for this BIN
                                const binResponse = await fetch(`https://data.cityofnewyork.us/resource/kfp4-dz4h.json?bin=${binNumber}`);
                                if (binResponse.ok) {
                                    const binData = await binResponse.json();
                                    
                                    // Get the device type and other identifiers
                                    const deviceType = device.device_type ? device.device_type.toUpperCase() : 'ELEVATOR';
                                    const deviceLocation = device.device_location || '';
                                    
                                    // Look for permits that might be for this specific device
                                    const potentialMatches = binData.filter(permit => {
                                        if (!permit.descriptionofwork) return false;
                                        
                                        const desc = permit.descriptionofwork.toUpperCase();
                                        
                                        // Check for exact device number match
                                        if (desc.includes(deviceNumber)) return true;
                                        
                                        // Check for location match if available
                                        if (deviceLocation && desc.includes(deviceLocation.toUpperCase())) return true;
                                        
                                        // Check for specific identifiers that might indicate this device
                                        // For example, "Car 3" or "Elevator #3" if device number ends with 3
                                        const deviceNumberEnd = deviceNumber.slice(-1);
                                        if (desc.includes(`CAR ${deviceNumberEnd}`) || 
                                            desc.includes(`ELEVATOR #${deviceNumberEnd}`) ||
                                            desc.includes(`ELEVATOR ${deviceNumberEnd}`)) {
                                            return true;
                                        }
                                        
                                        return false;
                                    });
                                    
                                    if (potentialMatches.length > 0) {
                                        const normalizedData = potentialMatches.map(permit => ({
                                            permit_number: permit.job_filing_number || permit.job_number,
                                            permittee_s_name: permit.applicant_firstname && permit.applicant_lastname ? 
                                                `${permit.applicant_firstname} ${permit.applicant_lastname}` : 
                                                permit.applicant_businessname || 'N/A',
                                            issuance_date: permit.filing_date,
                                            expiration_date: permit.gl_expirationdate || permit.worker_compensation,
                                            house_number: permit.house_number,
                                            street_name: permit.street_name,
                                            application_type: permit.filing_type,
                                            work_type: permit.elevatordevicetype,
                                            filing_status: permit.filing_status,
                                            job_filing_number: permit.job_filing_number,
                                            business_name: permit.applicant_businessname || permit.owner_businessname,
                                            description: permit.descriptionofwork,
                                            device_specific: permit.descriptionofwork.includes(deviceNumber)
                                        }));
                                        allPermits = [...normalizedData];
                                        success = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching device-specific permits:', error);
                        }
                    }
                    
                    // Return the permits found
                    return {
                        success: success,
                        device: device,
                        permits: allPermits,
                        deviceNumber: deviceNumber
                    };
                }
                
                return {
                    success: false,
                    message: 'No device or BIN information found'
                };
            } catch (error) {
                console.error('Error fetching permit information:', error);
                return {
                    success: false,
                    message: 'Error fetching permit information'
                };
            }
        }
        
        // Add this function to toggle permit information display for a device
        async function togglePermitInfo(deviceNumber) {
            const permitElement = document.getElementById(`permits_${deviceNumber}`);
            const button = document.getElementById(`permitsBtn_${deviceNumber}`);
            const arrow = button.querySelector('.arrow');
            const buttonText = button.querySelector('span:first-child');
            
            if (permitElement.style.display === 'none') {
                permitElement.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                if (buttonText) {
                    buttonText.textContent = 'Hide Permit Information';
                }
                
                // Check if permit info is already loaded
                if (permitElement.getAttribute('data-loaded') !== 'true') {
                    permitElement.innerHTML = '<span style="color: var(--text-color);">Loading permit information...</span>';
                    
                    const result = await fetchPermitInfo(deviceNumber);
                    
                    if (result.success && result.permits.length > 0) {
                        // Sort permits by device-specific first, then by issue date (newest first)
                        const permits = result.permits.filter(permit => permit.issuance_date);
                        permits.sort((a, b) => {
                            // First prioritize device-specific permits
                            if (a.device_specific && !b.device_specific) return -1;
                            if (!a.device_specific && b.device_specific) return 1;
                            
                            // Then sort by date (newest first)
                            return new Date(b.issuance_date) - new Date(a.issuance_date);
                        });
                        
                        // Get the most recent permits (up to 5)
                        const recentPermits = permits.slice(0, 5);
                        
                        let html = `
                            <div style="margin-bottom: 5px; color: var(--header-color);">
                                <strong>Permit Information for Device #${deviceNumber} (${permits.length} total):</strong>
                                                    </div>
                            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                        `;
                        
                        recentPermits.forEach(permit => {
                            const issueDate = permit.issuance_date ? new Date(permit.issuance_date).toLocaleDateString() : 'Unknown';
                            const expirationDate = permit.expiration_date ? new Date(permit.expiration_date).toLocaleDateString() : 'Unknown';
                            
                            // Add a special highlight for device-specific permits
                            const isDeviceSpecific = permit.device_specific || 
                                (permit.description && (
                                    permit.description.includes(deviceNumber) || 
                                    permit.description.includes(result.deviceNumber)
                                ));
                            
                            html += `
                                <div style="margin-bottom: 12px; padding: 8px; background: ${isDeviceSpecific ? 'rgba(74, 158, 255, 0.1)' : 'var(--input-bg)'}; 
                                     border-radius: 4px; border: 1px solid ${isDeviceSpecific ? '#4a9eff' : 'var(--input-border)'};">
                                    ${isDeviceSpecific ? 
                                        `<div style="margin-bottom: 8px; padding: 4px; background: #4a9eff; color: white; border-radius: 3px; font-size: 0.85em; display: inline-block;">
                                            Device-Specific Permit
                                        </div>` : ''
                                    }
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Permit #:</strong> ${permit.permit_number || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Issued To:</strong> ${permit.permittee_s_name || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Issue Date:</strong> ${issueDate}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Expiration Date:</strong> ${expirationDate}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Address:</strong> ${permit.house_number || ''} ${permit.street_name || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Application Type:</strong> ${permit.application_type || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Work Type:</strong> ${permit.work_type || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Filing Status:</strong> ${permit.filing_status || 'N/A'}</div>
                                    <div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Job/Filing Number:</strong> ${permit.job_filing_number || 'N/A'}</div>
                                    ${permit.business_name ? `<div style="margin-bottom: 5px;"><strong style="color: var(--header-color);">Business Name:</strong> ${permit.business_name}</div>` : ''}
                                    ${permit.description ? 
                                        `<div style="margin-top: 8px;">
                                            <strong style="color: var(--header-color);">Description:</strong> 
                                            <div style="margin-top: 4px; padding: 8px; background: var(--panel-bg); border-radius: 4px; white-space: pre-wrap; font-size: 0.9em; text-align: left;">${permit.description.trim()}</div>
                                        </div>` : ''
                                    }
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                        permitElement.innerHTML = html;
                        permitElement.setAttribute('data-loaded', 'true');
                    } else {
                        // Try to provide more helpful information when no permits are found
                        let message = '';
                        
                        if (result.success) {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>No permits found for device #${deviceNumber} in the NYC DOB database.</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">This could be because:</p>
                                    <ul style="text-align: left; margin-top: 5px; font-size: 0.9em;">
                                        <li>The permit may be filed under a different BIN</li>
                                        <li>The permit may be older and not included in the digital records</li>
                                        <li>The device may not require a specific permit</li>
                                        <li>The permit may not specifically mention this device number</li>
                                    </ul>
                                    <p style="margin-top: 10px; font-size: 0.9em;">You can try searching directly on the <a href="https://a810-dobnow.nyc.gov/publish/Index.html#!/" target="_blank" style="color: #4a9eff;">DOB NOW portal</a> using the BIN number: ${result.device?.bin || 'N/A'}</p>
                                </div>
                            `;
                        } else {
                            message = `
                                <div style="text-align: center; color: var(--text-color); padding: 10px;">
                                    <p>${result.message || 'Error fetching permit information'}</p>
                                    <p style="margin-top: 10px; font-size: 0.9em;">Please try again later or check the device information.</p>
                                </div>
                            `;
                        }
                        
                        permitElement.innerHTML = message;
                        permitElement.setAttribute('data-loaded', 'true');
                    }
                }
            } else {
                permitElement.style.display = 'none';
                arrow.textContent = '‚ñº';
                if (buttonText) {
                    buttonText.textContent = 'Show Permit Information';
                }
            }
        }

        // Add this new function to fetch detailed device information from the API
        async function fetchDeviceInfo(deviceNumber) {
            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/juyv-2jek.json?device_id=${deviceNumber}`);
                
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Error fetching device info:', error);
                return null;
            }
        }

        // Add this function to handle the "X" button clicks
        function handleClearButtonClick(event) {
            const button = event.target;
            const deviceNumber = document.getElementById('deviceNumber').value.trim();
            const binNumber = document.getElementById('binNumber').value.trim();
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber && !binNumber) {
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Add event listeners for the "X" buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Find all clear buttons (X buttons) next to the lookup buttons
            const clearButtons = document.querySelectorAll('button[onclick="clearDeviceSearch()"]');
            clearButtons.forEach(button => {
                button.addEventListener('click', handleClearButtonClick);
            });
            
            // Initialize BIN display styling
            updateBinDisplayStyle();
        });

        // Function to update BIN display styling based on content
        function updateBinDisplayStyle() {
            const binSpan = document.getElementById('quickBinValue');
            if (binSpan) {
                const binValue = binSpan.textContent.replace('üìã', '').trim();
                if (binValue && binValue !== '-') {
                    // BIN is available - make it clickable
                    binSpan.style.cursor = 'pointer';
                    binSpan.style.color = '#4a9eff';
                    binSpan.style.borderColor = '#4a9eff';
                    binSpan.title = 'Click to copy BIN';
                    binSpan.style.opacity = '1';
                    
                    // Add the copy icon if not already present
                    if (!binSpan.querySelector('svg')) {
                        binSpan.innerHTML = `${binValue}<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;"><path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
                    }
                    
                    // Add hover effect
                    binSpan.addEventListener('mouseenter', function() {
                        const currentBin = this.textContent.replace('üìã', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'rgba(74, 158, 255, 0.1)';
                        }
                    });
                    binSpan.addEventListener('mouseleave', function() {
                        const currentBin = this.textContent.replace('üìã', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'transparent';
                        }
                    });
                } else {
                    // No BIN available - make it non-clickable
                    binSpan.style.cursor = 'default';
                    binSpan.style.color = 'var(--text-color)';
                    binSpan.style.borderColor = 'transparent';
                    binSpan.title = '';
                    binSpan.style.opacity = '0.7';
                    binSpan.innerHTML = '-'; // Remove any icon
                }
            }
        }

        function updateMainBinDisplayStyle() {
            const binSpan = document.getElementById('mainBinValue');
            if (binSpan) {
                const binValue = binSpan.textContent.replace('üìã', '').trim();
                if (binValue && binValue !== '-') {
                    binSpan.style.cursor = 'pointer';
                    binSpan.style.color = '#4a9eff';
                    binSpan.style.borderColor = '#4a9eff';
                    binSpan.title = 'Click to copy BIN';
                    binSpan.style.opacity = '1';
                    
                    if (!binSpan.querySelector('svg')) {
                        binSpan.innerHTML = `${binValue}<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.7;"><path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
                    }
                    
                    binSpan.addEventListener('mouseenter', function() {
                        const currentBin = this.textContent.replace('üìã', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'rgba(74, 158, 255, 0.1)';
                        }
                    });
                    binSpan.addEventListener('mouseleave', function() {
                        const currentBin = this.textContent.replace('üìã', '').trim();
                        if (currentBin !== '-') {
                            this.style.backgroundColor = 'transparent';
                        }
                    });
                } else {
                    binSpan.style.cursor = 'default';
                    binSpan.style.color = 'var(--text-color)';
                    binSpan.style.borderColor = 'transparent';
                    binSpan.title = '';
                    binSpan.style.opacity = '0.7';
                    binSpan.innerHTML = '-';
                }
            }
        }

        // Add this new function to handle copying BIN to clipboard
        async function copyBinToClipboard(bin, event) {
            try {
                // Prevent any default behavior
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Don't copy if BIN is empty or just a dash
                if (!bin || bin.trim() === '-' || bin.trim() === '') {
                    return;
                }

                // Get the clicked element
                const span = event ? event.target.closest('span') : document.querySelector(`span[onclick*="${bin}"]`);
                if (!span) return;

                // Store original styles
                const originalBg = span.style.backgroundColor;
                const originalColor = span.style.color;
                const originalBorder = span.style.borderColor;

                // Try modern clipboard API first
                try {
                    await navigator.clipboard.writeText(bin);
                } catch (err) {
                    // Fallback for browsers that don't support clipboard API
                    const textarea = document.createElement('textarea');
                    textarea.value = bin;
                    textarea.style.position = 'fixed';  // Prevent scrolling to bottom
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                // Show success state
                const originalHTML = span.innerHTML;
                span.style.backgroundColor = '#4CAF50';
                span.style.color = 'white';
                span.style.borderColor = '#4CAF50';
                span.title = 'Copied!';
                span.innerHTML = `‚úì Copied!`;

                // Reset after 2 seconds
                setTimeout(() => {
                    span.innerHTML = originalHTML;
                    span.style.backgroundColor = originalBg;
                    span.style.color = originalColor;
                    span.style.borderColor = originalBorder;
                    span.title = 'Click to copy BIN';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy BIN:', err);
                alert('Failed to copy BIN to clipboard');
            }
        }

        // Function to copy all device numbers from BIN search results
        async function copyAllDeviceNumbers() {
            try {
                const data = window.lastBinSearchResults;
                if (!data || data.length === 0) {
                    alert('No devices to copy');
                    return;
                }

                // Extract all device numbers
                const deviceNumbers = data.map(device => device.device_number).filter(num => num);
                
                if (deviceNumbers.length === 0) {
                    alert('No device numbers found');
                    return;
                }

                // Join with newlines for easy pasting
                const deviceNumbersText = deviceNumbers.join('\n');

                // Get the button and text elements
                const btn = document.getElementById('copyAllDevicesBtn');
                const btnText = document.getElementById('copyAllDevicesBtnText');
                
                // Try modern clipboard API first
                try {
                    await navigator.clipboard.writeText(deviceNumbersText);
                } catch (err) {
                    // Fallback for browsers that don't support clipboard API
                    const textarea = document.createElement('textarea');
                    textarea.value = deviceNumbersText;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                // Show success state
                if (btn && btnText) {
                    const originalText = btnText.textContent;
                    const originalBg = btn.style.backgroundColor;
                    
                    btn.style.backgroundColor = '#4CAF50';
                    btn.style.borderColor = '#4CAF50';
                    btn.style.color = 'white';
                    btnText.textContent = `Copied ${deviceNumbers.length} Device #s!`;

                    // Reset after 2 seconds
                    setTimeout(() => {
                        btn.style.backgroundColor = '';
                        btn.style.borderColor = '';
                        btn.style.color = '';
                        btnText.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy device numbers:', err);
                alert('Failed to copy device numbers to clipboard');
            }
        }

        function isEligibleForTesting(lastInspectionDate) {
            if (!lastInspectionDate) return false;
            
            const today = new Date();
            const lastInspection = new Date(lastInspectionDate);
            const timeDiff = today - lastInspection;
            const daysSinceInspection = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            return daysSinceInspection >= 91;
        }

        function toggleTestEligibilityFilter() {
            const button = document.getElementById('testEligibilityFilterBtn');
            if (!button) return;
            
            const currentFilter = button.getAttribute('data-filter') || 'all';
            const deviceItems = document.querySelectorAll('.device-item');
            
            let newFilter;
            if (currentFilter === 'all') {
                newFilter = 'eligible';
                button.textContent = 'Show Not Ready Only';
                button.style.background = '#4CAF50';
            } else if (currentFilter === 'eligible') {
                newFilter = 'not-eligible';
                button.textContent = 'Show All Devices';
                button.style.background = '#ff6b6b';
            } else {
                newFilter = 'all';
                button.textContent = 'Show Ready Only';
                button.style.background = 'var(--panel-bg)';
            }
            
            button.setAttribute('data-filter', newFilter);
            
            deviceItems.forEach(item => {
                const testStatusElement = item.querySelector('[data-test-status]');
                const isEligible = testStatusElement?.getAttribute('data-test-status') === 'true';
                
                if (newFilter === 'all' || 
                    (newFilter === 'eligible' && isEligible) || 
                    (newFilter === 'not-eligible' && !isEligible)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateDeviceTypeSectionVisibility();
        }

        // ELV3 Lookup Log Functions
        function saveToLogWithResults(numValue, letterValue, secondaryNumValue, numResult, letterResult, secondaryNumResult) {
            // Only save if there was actual content to log
            if (!numValue && !letterValue && !secondaryNumValue && !numResult && !letterResult && !secondaryNumResult) {
                return;
            }
            
            // Create log entry
            const logEntry = {
                timestamp: new Date().toLocaleString(),
                inputs: {
                    partNumber: numValue || '',
                    violatingCondition: letterValue || '',
                    suggestedRemedy: secondaryNumValue || ''
                },
                outputs: {
                    partNumberResult: numResult || '',
                    violatingConditionResult: letterResult || '',
                    suggestedRemedyResult: secondaryNumResult || ''
                }
            };
            
            // Get existing log entries
            let logEntries = JSON.parse(localStorage.getItem('elv3LookupLog') || '[]');
            
            // Add new entry to the beginning of the array
            logEntries.unshift(logEntry);
            
            // Keep only the last 50 entries to prevent excessive storage
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }
            
            // Save back to localStorage
            localStorage.setItem('elv3LookupLog', JSON.stringify(logEntries));
            
            // If the log section is currently visible, refresh it immediately
            const logSection = document.getElementById('inlineLogSection');
            if (logSection && logSection.style.display === 'block') {
                displayInlineLogEntries();
            }
        }

        function toggleLogModal() {
            const logSection = document.getElementById('inlineLogSection');
            
            if (logSection.style.display === 'none' || logSection.style.display === '') {
                displayInlineLogEntries();
                logSection.style.display = 'block';
            } else {
                logSection.style.display = 'none';
            }
        }

        function displayInlineLogEntries() {
            const logEntries = JSON.parse(localStorage.getItem('elv3LookupLog') || '[]');
            const logContainer = document.getElementById('inlineLogEntries');
            
            if (logEntries.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; font-size: 1em;">No log entries yet.</p>';
                return;
            }
            
            let html = '';
            // Show only the last 5 entries for inline display
            const recentEntries = logEntries.slice(0, 5);
            recentEntries.forEach((entry, index) => {
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--panel-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <strong style="color: var(--text-color); font-size: 0.95em;">Entry #${logEntries.length - index}</strong>
                            <span style="color: #666; font-size: 0.85em;">${entry.timestamp}</span>
                        </div>
                        
                        <div style="font-size: 0.9em; line-height: 1.3;">
                            ${entry.inputs.partNumber ? `<div><strong>Input:</strong> ${entry.inputs.partNumber} ‚Üí <em>${entry.outputs.partNumberResult}</em></div>` : ''}
                            ${entry.inputs.violatingCondition ? `<div><strong>Condition:</strong> ${entry.inputs.violatingCondition} ‚Üí <em>${entry.outputs.violatingConditionResult}</em></div>` : ''}
                            ${entry.inputs.suggestedRemedy ? `<div><strong>Remedy:</strong> ${entry.inputs.suggestedRemedy} ‚Üí <em>${entry.outputs.suggestedRemedyResult}</em></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (logEntries.length > 5) {
                html += `<p style="text-align: center; color: #666; font-style: italic; font-size: 0.9em;">Showing 5 most recent entries (${logEntries.length} total)</p>`;
            }
            
            logContainer.innerHTML = html;
        }

        function clearLogEntries() {
            if (confirm('Are you sure you want to clear all log entries? This action cannot be undone.')) {
                localStorage.removeItem('elv3LookupLog');
                displayInlineLogEntries(); // Refresh the inline display
            }
        }

        // Main tab history functions
        function saveToMainLogWithResults(numValue, letterValue, secondaryNumValue, numResult, letterResult, secondaryNumResult) {
            // Only save if there was actual content to log
            if (!numValue && !letterValue && !secondaryNumValue && !numResult && !letterResult && !secondaryNumResult) {
                return;
            }
            
            // Create log entry
            const logEntry = {
                timestamp: new Date().toLocaleString(),
                inputs: {
                    partNumber: numValue || '',
                    violatingCondition: letterValue || '',
                    suggestedRemedy: secondaryNumValue || ''
                },
                outputs: {
                    partNumberResult: numResult || '',
                    violatingConditionResult: letterResult || '',
                    suggestedRemedyResult: secondaryNumResult || ''
                }
            };
            
            // Get existing log entries
            let logEntries = JSON.parse(localStorage.getItem('elv3MainTabLog') || '[]');
            
            // Add new entry to the beginning of the array
            logEntries.unshift(logEntry);
            
            // Keep only the last 50 entries to prevent excessive storage
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }
            
            // Save back to localStorage
            localStorage.setItem('elv3MainTabLog', JSON.stringify(logEntries));
            
            // If the log section is currently visible, refresh it immediately
            const logSection = document.getElementById('mainLogSection');
            if (logSection && logSection.style.display === 'block') {
                displayMainLogEntries();
            }
        }

        function toggleMainLogModal() {
            const logSection = document.getElementById('mainLogSection');
            
            if (logSection.style.display === 'none' || logSection.style.display === '') {
                displayMainLogEntries();
                logSection.style.display = 'block';
            } else {
                logSection.style.display = 'none';
            }
        }

        function displayMainLogEntries() {
            const logEntries = JSON.parse(localStorage.getItem('elv3MainTabLog') || '[]');
            const logContainer = document.getElementById('mainLogEntries');
            
            if (logEntries.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; font-size: 1em;">No log entries yet.</p>';
                return;
            }
            
            let html = '';
            // Show only the last 5 entries for inline display
            const recentEntries = logEntries.slice(0, 5);
            recentEntries.forEach((entry, index) => {
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--panel-bg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <strong style="color: var(--text-color); font-size: 0.95em;">Entry #${logEntries.length - index}</strong>
                            <span style="color: #666; font-size: 0.85em;">${entry.timestamp}</span>
                        </div>
                        
                        <div style="font-size: 0.9em; line-height: 1.3;">
                            ${entry.inputs.partNumber ? `<div><strong>Input:</strong> ${entry.inputs.partNumber} ‚Üí <em>${entry.outputs.partNumberResult}</em></div>` : ''}
                            ${entry.inputs.violatingCondition ? `<div><strong>Condition:</strong> ${entry.inputs.violatingCondition} ‚Üí <em>${entry.outputs.violatingConditionResult}</em></div>` : ''}
                            ${entry.inputs.suggestedRemedy ? `<div><strong>Remedy:</strong> ${entry.inputs.suggestedRemedy} ‚Üí <em>${entry.outputs.suggestedRemedyResult}</em></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (logEntries.length > 5) {
                html += `<p style="text-align: center; color: #666; font-style: italic; font-size: 0.9em;">Showing 5 most recent entries (${logEntries.length} total)</p>`;
            }
            
            logContainer.innerHTML = html;
        }

        function clearMainLogEntries() {
            if (confirm('Are you sure you want to clear all log entries? This action cannot be undone.')) {
                localStorage.removeItem('elv3MainTabLog');
                displayMainLogEntries(); // Refresh the inline display
            }
        }

        // Device number search functions for ELV3 Lookup panel
        function updateMainDeviceField(deviceNumber) {
            // Update the main device number field in DOB tab if it exists
            const deviceInput = document.getElementById('deviceNumber');
            if (deviceInput) {
                deviceInput.value = deviceNumber || '';
                // Fire input event so any listeners can react to the change
                deviceInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        async function searchDeviceInLookup(deviceNumber) {
            const resultDiv = document.getElementById('quickDeviceResult');
            const quickBinValue = document.getElementById('quickBinValue');
            
            if (!deviceNumber || deviceNumber.trim() === '') {
                resultDiv.style.display = 'none';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
                
                // Show address search when device field is cleared
                if (typeof toggleAddressSearchVisibility === 'function') {
                    toggleAddressSearchVisibility('');
                }
                return;
            }

            // Show loading state
            resultDiv.innerHTML = '<span style="color: var(--text-color); font-size: 12px;">Searching device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber.trim()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Device not found</span>';
                    quickBinValue.textContent = '-';
                    updateBinDisplayStyle();
                    return;
                }

                const device = data[0];
                const binNumber = device.bin || 'Not available';
                const address = device.house_number && device.street_name ? 
                    `${device.house_number} ${device.street_name}` : 'Address not available';

                // Update BIN display
                quickBinValue.textContent = binNumber;
                updateBinDisplayStyle();

                // Show device result
                resultDiv.innerHTML = `
                    <div style="font-size: 12px; line-height: 1.3;">
                        <strong>BIN:</strong> ${binNumber}<br>
                        <strong>Address:</strong> ${address}
                    </div>
                `;

                // Also update the main DOB tab BIN field if it exists
                const mainBinInput = document.getElementById('binNumber');
                if (mainBinInput && binNumber !== 'Not available') {
                    mainBinInput.value = binNumber;
                }

                // Also update the Quick Filing Information BIN field in ELV3 Lookup
                const quickBinInput = document.getElementById('quickBinInput');
                if (quickBinInput && binNumber !== 'Not available') {
                    quickBinInput.value = binNumber;
                    localStorage.setItem('quickBinInputInfo', binNumber);
                }

                // Hide address search when device number is populated
                if (typeof toggleAddressSearchVisibility === 'function') {
                    toggleAddressSearchVisibility(deviceNumber.trim());
                }

                // Automatically trigger the main DOB search for this device
                if (typeof lookupBIN === 'function') {
                    // Small delay to ensure the main device field is updated first
                    setTimeout(() => {
                        lookupBIN();
                    }, 100);
                }

            } catch (error) {
                console.error('Error searching device:', error);
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Error searching device</span>';
                quickBinValue.textContent = '-';
                updateBinDisplayStyle();
            }
        }

        // Toggle device search dropdown
        function toggleDeviceSearch() {
            const fields = document.getElementById('deviceSearchFields');
            const arrow = document.getElementById('deviceSearchArrow');
            
            if (fields.style.display === 'none' || fields.style.display === '') {
                fields.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                fields.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        // Refresh device lookup in both ELV3 Lookup panel and main DOB tab
        function refreshDeviceLookup() {
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            const deviceNumber = quickDeviceInput ? quickDeviceInput.value.trim() : '';
            
            if (!deviceNumber) {
                alert('Please enter a device number first');
                return;
            }
            
            // Refresh the ELV3 Lookup panel device search
            searchDeviceInLookup(deviceNumber);
            
            // Also refresh the main DOB tab if we're on the DOB tab or if it exists
            const mainDeviceInput = document.getElementById('deviceNumber');
            if (mainDeviceInput) {
                // Update the main device field if it's different
                if (mainDeviceInput.value !== deviceNumber) {
                    mainDeviceInput.value = deviceNumber;
                }
                
                // Trigger the main DOB lookup
                if (typeof lookupBIN === 'function') {
                    lookupBIN();
                }
            }
        }

        // Clear device lookup input and results
        function clearDeviceLookup() {
            const quickDeviceInput = document.getElementById('quickDeviceInput');
            if (quickDeviceInput) {
                quickDeviceInput.value = '';
                quickDeviceInput.focus();
                updateMainDeviceField('');
                searchDeviceInLookup('');

                // Also clear the Quick Filing Information BIN field
                const quickBinInput = document.getElementById('quickBinInput');
                if (quickBinInput) {
                    quickBinInput.value = '';
                    localStorage.removeItem('quickBinInputInfo');
                }

                // Also clear the main BIN input
                const mainBinInput = document.getElementById('binNumber');
                if (mainBinInput) {
                    mainBinInput.value = '';
                    mainBinInput.dispatchEvent(new Event('input', { bubbles: true }));
                }

                // Also clear outputs on the main DOB page for both Device and BIN searches
                const binResult = document.getElementById('binResult');
                if (binResult) {
                    binResult.innerHTML = '';
                    binResult.style.display = 'none';
                }

                const deviceResult = document.getElementById('deviceResult');
                if (deviceResult) {
                    deviceResult.innerHTML = '';
                    deviceResult.style.display = 'none';
                }

                const exportButton = document.getElementById('binExportButton');
                if (exportButton) {
                    exportButton.style.display = 'none';
                }
            }
        }

        // ========== Main ELV3 Tab Device Search Functions ==========
        
        // Toggle main device search dropdown
        function toggleMainDeviceSearch() {
            const fields = document.getElementById('mainDeviceSearchFields');
            const arrow = document.getElementById('mainDeviceSearchArrow');
            
            if (fields.style.display === 'none' || fields.style.display === '') {
                fields.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                fields.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        // Search device in main ELV3 tab
        async function searchDeviceInMain(deviceNumber) {
            const resultDiv = document.getElementById('mainDeviceResult');
            const mainBinValue = document.getElementById('mainBinValue');
            
            if (!deviceNumber || deviceNumber.trim() === '') {
                resultDiv.style.display = 'none';
                mainBinValue.textContent = '-';
                updateMainBinDisplayStyle();
                return;
            }

            // Show loading state
            resultDiv.innerHTML = '<span style="color: var(--text-color); font-size: 12px;">Searching device...</span>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${deviceNumber.trim()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Device not found</span>';
                    mainBinValue.textContent = '-';
                    updateMainBinDisplayStyle();
                    return;
                }

                const device = data[0];
                const binNumber = device.bin || 'Not available';
                const address = device.house_number && device.street_name ? 
                    `${device.house_number} ${device.street_name}` : 'Address not available';

                // Update BIN display
                mainBinValue.textContent = binNumber;
                updateMainBinDisplayStyle();

                // Show device result
                resultDiv.innerHTML = `
                    <div style="font-size: 12px; line-height: 1.3;">
                        <strong>BIN:</strong> ${binNumber}<br>
                        <strong>Address:</strong> ${address}
                    </div>
                `;

                // Also update the Filing Information BIN field if it exists
                const filingBinInput = document.getElementById('binInput');
                if (filingBinInput && binNumber !== 'Not available') {
                    filingBinInput.value = binNumber;
                    localStorage.setItem('binInputInfo', binNumber);
                }

            } catch (error) {
                console.error('Error searching device:', error);
                resultDiv.innerHTML = '<span style="color: #ff6b6b; font-size: 12px;">Error searching device</span>';
                mainBinValue.textContent = '-';
                updateMainBinDisplayStyle();
            }
        }

        // Refresh main device lookup
        function refreshMainDeviceLookup() {
            const mainDeviceInput = document.getElementById('mainDeviceInput');
            const deviceNumber = mainDeviceInput ? mainDeviceInput.value.trim() : '';
            
            if (!deviceNumber) {
                alert('Please enter a device number first');
                return;
            }
            
            searchDeviceInMain(deviceNumber);
        }

        // Clear main device lookup
        function clearMainDeviceLookup() {
            const mainDeviceInput = document.getElementById('mainDeviceInput');
            const mainDeviceResult = document.getElementById('mainDeviceResult');
            const mainBinValue = document.getElementById('mainBinValue');
            
            if (mainDeviceInput) {
                mainDeviceInput.value = '';
                mainDeviceInput.focus();
            }
            if (mainDeviceResult) {
                mainDeviceResult.style.display = 'none';
                mainDeviceResult.innerHTML = '';
            }
            if (mainBinValue) {
                mainBinValue.textContent = '-';
                updateMainBinDisplayStyle();
            }
            
            // Also clear the Filing Information BIN field
            const filingBinInput = document.getElementById('binInput');
            if (filingBinInput) {
                filingBinInput.value = '';
                localStorage.removeItem('binInputInfo');
            }
        }

        // Disclaimer Modal Functions
        function acceptDisclaimer() {
            const modal = document.getElementById('disclaimerModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Store acceptance in sessionStorage (resets when browser is closed)
            sessionStorage.setItem('disclaimerAccepted', 'true');
        }

        // Check if disclaimer was already accepted this session
        function checkDisclaimerStatus() {
            const accepted = sessionStorage.getItem('disclaimerAccepted');
            const modal = document.getElementById('disclaimerModal');
            if (accepted === 'true' && modal) {
                modal.style.display = 'none';
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', checkDisclaimerStatus);


    </script>

    <script src="device-filter-functions.js"></script>

    <!-- Upload ELV3 Scan Modal -->
    <div id="uploadELV3ScanModal" class="elv3-scan-modal" style="display: none;">
        <div class="elv3-scan-modal-content">
            <div class="elv3-scan-modal-header">
                <h3>Scan ELV3 Inspection Form</h3>
                <button class="elv3-scan-header-pdf-toggle" id="headerPdfToggle" onclick="togglePdfPreview()" style="display: none;">üìÑ Hide PDF</button>
                <button class="elv3-scan-header-reset-btn" id="headerResetView" onclick="resetScanView()" style="display: none;">‚Ü∫ Reset View</button>
                <button class="elv3-scan-close-btn" onclick="closeUploadELV3ScanModal()">&times;</button>
            </div>
            <div class="elv3-scan-modal-body">
                <!-- Left side: Upload controls and results -->
                <div class="elv3-scan-left-panel">
                    <div class="elv3-scan-upload-area" id="elv3ScanUploadArea">
                        <div class="elv3-scan-upload-icon">üìÑ</div>
                        <p>Drag & drop your ELV3 PDFs here</p>
                        <p class="elv3-scan-upload-hint">or click to select one or more files</p>
                        <input type="file" id="elv3ScanFileInput" accept=".pdf" multiple style="display: none;" onchange="handleELV3FileScan(event)">
                    </div>
                    
                    <div id="elv3ScanProgress" class="elv3-scan-progress" style="display: none;">
                        <div class="elv3-scan-progress-bar">
                            <div class="elv3-scan-progress-fill" id="elv3ScanProgressFill"></div>
                        </div>
                        <p id="elv3ScanStatusText">Parsing ELV3 form...</p>
                    </div>
                    
                    <div id="elv3ScanResult" class="elv3-scan-result" style="display: none;">
                        <div id="elv3ScanResultContent"></div>
                    </div>
                    
                    <div id="elv3ScanError" class="elv3-scan-error" style="display: none;"></div>
                </div>
                
                <!-- Resize handle between Violations and PDF -->
                <div class="elv3-scan-resize-handle" id="elv3ScanResizeHandle1" data-left="elv3-scan-left-panel" data-right="elv3ScanPdfPreviewPanel"></div>
                
                <!-- Center: PDF Preview -->
                <div class="elv3-scan-right-panel" id="elv3ScanPdfPreviewPanel" style="display: none;">
                    <div class="elv3-scan-pdf-preview-header">
                        <button type="button" class="elv3-scan-nav-btn" id="elv3ScanPrevBtn" onclick="showPrevELV3Pdf()" title="Previous PDF" style="display: none;">‚Üê Previous</button>
                        <span class="elv3-scan-pdf-counter" id="elv3ScanPdfCounter" style="display: none;">PDF 1 of 1</span>
                        <button type="button" class="elv3-scan-nav-btn" id="elv3ScanNextBtn" onclick="showNextELV3Pdf()" title="Next PDF" style="display: none;">Next ‚Üí</button>
                    </div>
                    <div class="elv3-scan-pdf-preview-container">
                        <iframe id="elv3ScanPdfPreviewFrame" class="elv3-scan-pdf-preview-frame"></iframe>
                    </div>
                </div>

                <!-- Resize handle between PDF and ELV3 Lookup -->
                <div class="elv3-scan-resize-handle" id="elv3ScanResizeHandle2" data-left="elv3ScanPdfPreviewPanel" data-right="elv3ScanLookupPanel"></div>

                <!-- Right side: ELV3 Lookup Panel -->
                <div class="elv3-scan-lookup-panel" id="elv3ScanLookupPanel">
                    <h3 style="color: var(--text-color); margin: 0 0 12px 0; text-align: center; font-size: 14px;">ELV3 Lookup</h3>

                    <div style="margin-bottom: 12px;">
                        <input type="text" id="scanNumInput" placeholder="Enter Elevator Part Number"
                               style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 13px; box-sizing: border-box;">
                        <div id="scanNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 8px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 13px;"></div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <input type="text" id="scanLetterInput" placeholder="Enter Violating Condition"
                               style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 13px; box-sizing: border-box;">
                        <div id="scanLetterResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 8px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 13px;"></div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <input type="text" id="scanSecondaryNumInput" placeholder="Enter Suggested Remedy"
                               style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); margin-bottom: 5px; font-size: 13px; box-sizing: border-box;">
                        <div id="scanSecondaryNumResult" style="width: 100%; background: var(--result-bg); padding: 8px; border-radius: 4px; margin-bottom: 8px; color: var(--text-color); min-height: 20px; border: 1px solid var(--input-border); box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; font-size: 13px;"></div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button onclick="scanClearLookupInputs()"
                                style="flex: 1; padding: 10px; background: var(--panel-bg); color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background-color 0.3s ease;">
                            Clear
                        </button>
                    </div>

                    <!-- Filing Information -->
                    <div class="quick-filing-info-container" style="margin: 10px 0;">
                        <button onclick="toggleScanFilingInfo()" class="filing-info-toggle">
                            <span>Filing Information</span>
                            <span id="scanFilingInfoArrow" class="filing-info-arrow">‚ñº</span>
                        </button>
                        <div id="scanFilingInfoFields" class="filing-info-fields" style="display: none;">
                            <div class="field-group">
                                <label>Owner:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanOwnerInput" placeholder="Enter Owner Name">
                                    <button onclick="copyToClipboard('scanOwnerInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanOwnerInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Elevator Company:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanElevatorCompanyInput" placeholder="Enter Elevator Company">
                                    <button onclick="copyToClipboard('scanElevatorCompanyInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanElevatorCompanyInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>BIN #:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanBinInput" placeholder="Enter BIN Number">
                                    <button onclick="copyToClipboard('scanBinInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanBinInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Groups:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanGroupsInput" placeholder="Enter Groups">
                                    <button onclick="copyToClipboard('scanGroupsInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanGroupsInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Director/Co-Directors:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanDirectorsInput" placeholder="Enter Director/Co-Directors">
                                    <button onclick="copyToClipboard('scanDirectorsInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanDirectorsInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Additional:</label>
                                <div class="field-controls">
                                    <input type="text" id="scanAdditionalInput" placeholder="Enter Additional Information">
                                    <button onclick="copyToClipboard('scanAdditionalInput')" class="copy-btn">Copy</button>
                                    <button onclick="clearField('scanAdditionalInput')" class="clear-btn">Clear</button>
                                </div>
                            </div>
                            <div class="clear-all-container">
                                <button onclick="scanClearAllFilingInfo()" class="clear-all-btn">Clear All</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="quick-notes-container" style="margin-top: 10px;">
                        <button onclick="toggleScanNotes()" class="notes-toggle">
                            <span>Notes</span>
                            <span id="scanNotesArrow" class="notes-arrow">‚ñº</span>
                        </button>
                        <div id="scanNotesFields" class="notes-fields" style="display: none;">
                            <textarea id="scanNotesInput" placeholder="Enter your notes here..." class="notes-textarea-quick"></textarea>
                            <button onclick="scanClearNotes()" class="quick-lookup-clear-btn">Clear Notes</button>
                        </div>
                    </div>

                    <!-- ELV3 Reference -->
                    <div class="quick-reference-container" style="margin-top: 10px;">
                        <button onclick="toggleScanReference()" class="filing-info-toggle">
                            <span>ELV3 Reference</span>
                            <span id="scanReferenceArrow" class="filing-info-arrow">‚ñº</span>
                        </button>
                        <div id="scanReferenceFields" class="filing-info-fields" style="display: none;">
                            <div id="scanReferenceContent" style="max-height: 50vh; overflow-y: auto; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; color: var(--text-color);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // ELV3 PDF Scanner Functions
    // ============================================

    let elv3ScanItems = [];
    let elv3ScanCurrentIndex = 0;

    // ELV3 Code Mappings
    const ELV3_PART_CODES = {
        "01": "Emergency Stop Switch",
        "02": "Alarm System",
        "03": "Car Enclosure",
        "04": "Side Emergency Exit",
        "05": "Car Door/Gate",
        "06": "Car Door/Gate Contact",
        "07": "Door Reopening Device",
        "08": "Car Floor to Landing Sill",
        "09": "Car Floor",
        "10": "Car Door Gibs",
        "11": "Car Button Station",
        "12": "Car Lighting",
        "13": "Emergency Lighting",
        "14": "Car Mirror",
        "15": "Certificate Frame",
        "16": "Hoistway Doors",
        "17": "Hoistway Door Gibs",
        "18": "Hoistway Door Reinforcements",
        "19": "Hoistway Door Safety Retainer",
        "20": "Vision Panel",
        "21": "Interlocks",
        "22": "Parking Device",
        "23": "Hall Button Station",
        "24": "Indicators",
        "25": "Door Safety Retainer",
        "26": "Top Emergency Exit Cover",
        "27": "Governor Release Carrier",
        "28": "Door Hangers & Connectors",
        "29": "Door Operator",
        "30": "Normal Limits",
        "31": "Final Limits",
        "32": "Guide Shoes / Roller Guides",
        "33": "Counterweight",
        "34": "Hoistway",
        "35": "Electrical Wiring",
        "36": "Pipes and Ducts",
        "37": "Overhead & Deflector Sheave",
        "38": "Traveling Cable & Junction",
        "39": "Car Top",
        "40": "Machine Room",
        "41": "Machine Room Door",
        "42": "Controller‚ÄîSelector",
        "43": "Reverse Phase Relay",
        "44": "Traction Sheave",
        "45": "Governor",
        "46": "Governor Switch",
        "47": "Drum",
        "48": "Pump Unit",
        "49": "Drum Machine Limit SW",
        "50": "Generator",
        "51": "Slack Rope Switch",
        "52": "Hoist Cables",
        "53": "Governor Ropes",
        "54": "Car Counterweight Rope",
        "55": "Drum Counterweight Rope",
        "56": "Hoist Machine",
        "57": "Hoist Motor",
        "58": "Worm / Gear / Bearings",
        "59": "Machine Brake",
        "60": "Lighting Machine Space",
        "61": "Machine Disconnect SW",
        "62": "Commutator",
        "63": "Motor Brushes",
        "64": "NYC Device #",
        "65": "Unintended Car Movement",
        "66": "Emergency Brake/Rope Gripper",
        "67": "Communication",
        "68": "Maintenance Log",
        "69": "Code Data Plate",
        "70": "Pit",
        "71": "Pit Light",
        "72": "Pit Stop Switch",
        "73": "Car Guide-Rails & Brackets",
        "74": "Cwt Guide-Rails & Brackets",
        "75": "Buffers",
        "76": "Car Safety & Tail Rope",
        "77": "Underside Platform",
        "78": "Tension Weight",
        "79": "Comp / Chains / Ropes / Switch",
        "80": "Counterweight Runby",
        "81": "Counterweight Runby Signage",
        "82": "Plunger Gripper",
        "83": "Fire Shutters",
        "84": "Skirt Switch",
        "85": "Skirt Deflection Device",
        "86": "Comb Plate / Comb Plate Teeth",
        "87": "Landing Plate / Impact Switches",
        "88": "Handrails / Handrail Safeties",
        "89": "Step / Thread",
        "90": "Key Switch",
        "91": "Emergency Stop Button",
        "92": "Decking and Balustrades",
        "93": "Ceiling Guards",
        "94": "Deck Barricades",
        "95": "Internal Safeties",
        "96": "Safety Signage",
        "97": "Entire Device",
        "98": "Current Five Year Tag",
        "99": "Current One Year Tag",
        "100": "Miscellaneous"
    };

    const ELV3_CONDITION_CODES = {
        "A": "Altered",
        "B": "Insufficient",
        "C": "Padlocked",
        "D": "Unsecured",
        "E": "Rubbing",
        "F": "Lost Motion",
        "G": "Improper Fuses",
        "H": "Worn",
        "I": "Damaged",
        "J": "Misaligned",
        "K": "Rusted",
        "L": "Defective",
        "M": "Missing",
        "N": "By-passed",
        "O": "Dirty",
        "P": "No Means of Access",
        "Q": "Unguarded",
        "R": "Illegal",
        "S": "Not Fire Retardant",
        "T": "Unlabeled",
        "U": "Device Not Tagged",
        "V": "Not Level",
        "W": "Unlocked",
        "X": "Inoperative",
        "Y": "Oil Leak",
        "Z": "Water Leak",
        "AA": "Carbon Buildup",
        "BB": "Expired Tag"
    };

    const ELV3_REMEDY_CODES = {
        "01": "Adjust",
        "02": "Clean",
        "03": "Install Guards",
        "04": "Patch",
        "05": "Perform & File Test",
        "06": "Properly Secure",
        "07": "Provide",
        "08": "Regroove",
        "09": "Remove",
        "10": "Repair",
        "11": "Replace",
        "12": "Reshackle",
        "13": "Seal",
        "14": "Shorten",
        "15": "Tag Device",
        "16": "Provide Means of Access",
        "17": "Re-inspection Required"
    };

    /**
     * Get the location suffix for a part code based on its numeric range
     */
    function getELV3PartLocation(partCode) {
        const intValue = parseInt(partCode, 10);
        
        if (intValue >= 1 && intValue <= 15) return " (Inside Car)";
        if (intValue >= 16 && intValue <= 25) return " (Outside Hoistway)";
        if (intValue >= 26 && intValue <= 39) return " (Top of Car)";
        if (intValue >= 40 && intValue <= 69) return " (Machine Room)";
        if (intValue >= 70 && intValue <= 82) return " (Pit)";
        if (intValue >= 83 && intValue <= 96) return " (Escalator/Moving Walk)";
        if (intValue >= 97 && intValue <= 100) return " (All Types)";
        
        return "";
    }

    /**
     * Get full part description including location
     */
    function getELV3PartDescriptionWithLocation(partCode) {
        const baseName = ELV3_PART_CODES[partCode] || `Part ${partCode}`;
        const location = getELV3PartLocation(partCode);
        return baseName + location;
    }

    /**
     * Show the upload ELV3 scan modal
     */
    function showUploadELV3ScanModal() {
        const modal = document.getElementById('uploadELV3ScanModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Reset state
        document.getElementById('elv3ScanUploadArea').style.display = 'flex';
        document.getElementById('elv3ScanProgress').style.display = 'none';
        document.getElementById('elv3ScanResult').style.display = 'none';
        document.getElementById('elv3ScanError').style.display = 'none';
        document.getElementById('elv3ScanPdfPreviewPanel').style.display = 'none';

        var headerToggle = document.getElementById('headerPdfToggle');
        if (headerToggle) headerToggle.style.display = 'none';
        var resetBtn = document.getElementById('headerResetView');
        if (resetBtn) resetBtn.style.display = 'none';

        var modalBody = document.querySelector('.elv3-scan-modal-body');
        if (modalBody) modalBody.classList.remove('elv3-scan-pdf-hidden');

        // Before a PDF is loaded, center the upload area by expanding the left panel
        const leftPanel = document.querySelector('.elv3-scan-left-panel');
        leftPanel.classList.add('elv3-scan-upload-centered');

        initScanLookupPanel();
        resetResizePanels();
        initResizeHandles();
        
        // Setup drag and drop
        const uploadArea = document.getElementById('elv3ScanUploadArea');
        uploadArea.onclick = () => document.getElementById('elv3ScanFileInput').click();
        
        uploadArea.ondragover = (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        };
        
        uploadArea.ondragleave = () => {
            uploadArea.classList.remove('drag-over');
        };
        
        uploadArea.ondrop = (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            if (files.length > 0) {
                processELV3ScanBatch(files);
            } else {
                document.getElementById('elv3ScanError').textContent = 'Please upload PDF file(s)';
                document.getElementById('elv3ScanError').style.display = 'block';
            }
        };
    }

    /**
     * Close the upload ELV3 scan modal
     */
    function closeUploadELV3ScanModal() {
        const modal = document.getElementById('uploadELV3ScanModal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // Revoke all blob URLs and clear state
        for (const item of elv3ScanItems) {
            if (item.blobUrl) URL.revokeObjectURL(item.blobUrl);
        }
        elv3ScanItems = [];
        elv3ScanCurrentIndex = 0;
        
        const previewPanel = document.getElementById('elv3ScanPdfPreviewPanel');
        const previewFrame = document.getElementById('elv3ScanPdfPreviewFrame');
        previewFrame.src = '';
        previewPanel.style.display = 'none';
        previewPanel.classList.remove('elv3-scan-pdf-fullscreen');
        
        document.getElementById('elv3ScanFileInput').value = '';

        var headerToggle = document.getElementById('headerPdfToggle');
        if (headerToggle) headerToggle.style.display = 'none';
        var resetBtn = document.getElementById('headerResetView');
        if (resetBtn) resetBtn.style.display = 'none';

        var modalBody = document.querySelector('.elv3-scan-modal-body');
        if (modalBody) modalBody.classList.remove('elv3-scan-pdf-hidden');

        resetResizePanels();
    }

    // ============================================
    // Scan Modal ELV3 Lookup Panel Functions
    // ============================================

    function initScanLookupPanel() {
        const numInput = document.getElementById('scanNumInput');
        const letterInput = document.getElementById('scanLetterInput');
        const secondaryInput = document.getElementById('scanSecondaryNumInput');

        if (numInput) {
            numInput.addEventListener('input', function(e) {
                document.getElementById('scanNumResult').textContent = numberToWord(e.target.value);
            });
        }
        if (letterInput) {
            letterInput.addEventListener('input', function(e) {
                document.getElementById('scanLetterResult').textContent = letterToWord(e.target.value);
            });
        }
        if (secondaryInput) {
            secondaryInput.addEventListener('input', function(e) {
                document.getElementById('scanSecondaryNumResult').textContent = secondaryNumberToWord(e.target.value);
            });
        }

        // Populate ELV3 Reference content
        const scanRefContent = document.getElementById('scanReferenceContent');
        const sourcePanel = document.querySelector('.reference-panel');
        if (scanRefContent && sourcePanel && scanRefContent.childElementCount === 0) {
            const fragment = document.createDocumentFragment();
            Array.from(sourcePanel.children).forEach(function(child) {
                if (child.classList && child.classList.contains('close-reference')) return;
                if (child.tagName === 'H3') return;
                fragment.appendChild(child.cloneNode(true));
            });
            scanRefContent.appendChild(fragment);
        }
    }

    function scanClearLookupInputs() {
        ['scanNumInput', 'scanLetterInput', 'scanSecondaryNumInput'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = '';
        });
        ['scanNumResult', 'scanLetterResult', 'scanSecondaryNumResult'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.textContent = '';
        });
    }

    function toggleScanFilingInfo() {
        var fields = document.getElementById('scanFilingInfoFields');
        var arrow = document.getElementById('scanFilingInfoArrow');
        if (fields.style.display === 'none' || fields.style.display === '') {
            fields.style.display = 'block';
            arrow.textContent = '‚ñ≤';
        } else {
            fields.style.display = 'none';
            arrow.textContent = '‚ñº';
        }
    }

    function scanClearAllFilingInfo() {
        ['scanOwnerInput', 'scanElevatorCompanyInput', 'scanBinInput', 'scanGroupsInput', 'scanDirectorsInput', 'scanAdditionalInput'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = '';
        });
    }

    function toggleScanNotes() {
        var fields = document.getElementById('scanNotesFields');
        var arrow = document.getElementById('scanNotesArrow');
        if (fields.style.display === 'none' || fields.style.display === '') {
            fields.style.display = 'block';
            arrow.textContent = '‚ñ≤';
        } else {
            fields.style.display = 'none';
            arrow.textContent = '‚ñº';
        }
    }

    function scanClearNotes() {
        var el = document.getElementById('scanNotesInput');
        if (el) el.value = '';
    }

    function toggleScanReference() {
        var fields = document.getElementById('scanReferenceFields');
        var arrow = document.getElementById('scanReferenceArrow');
        if (fields.style.display === 'none' || fields.style.display === '') {
            fields.style.display = 'block';
            arrow.textContent = '‚ñ≤';
        } else {
            fields.style.display = 'none';
            arrow.textContent = '‚ñº';
        }
    }

    /**
     * Toggle PDF preview visibility
     */
    function togglePdfPreview() {
        const pdfPanel = document.getElementById('elv3ScanPdfPreviewPanel');
        const handle1 = document.getElementById('elv3ScanResizeHandle1');
        const handle2 = document.getElementById('elv3ScanResizeHandle2');
        const toggleBtn = document.querySelector('.elv3-scan-toggle-pdf-btn');
        const headerToggle = document.getElementById('headerPdfToggle');
        const modalBody = document.querySelector('.elv3-scan-modal-body');

        resetResizePanels();
        
        if (pdfPanel.style.display === 'none' || pdfPanel.classList.contains('hidden')) {
            pdfPanel.style.display = 'flex';
            pdfPanel.classList.remove('hidden');
            if (handle1) handle1.style.display = '';
            if (handle2) handle2.style.display = '';
            modalBody.classList.remove('elv3-scan-pdf-hidden');
            if (toggleBtn) {
                toggleBtn.querySelector('.toggle-text').textContent = 'Hide PDF';
                toggleBtn.classList.remove('pdf-hidden');
            }
            if (headerToggle) headerToggle.textContent = 'üìÑ Hide PDF';
        } else {
            pdfPanel.style.display = 'none';
            pdfPanel.classList.add('hidden');
            if (handle1) handle1.style.display = 'none';
            if (handle2) handle2.style.display = 'none';
            modalBody.classList.add('elv3-scan-pdf-hidden');
            if (toggleBtn) {
                toggleBtn.querySelector('.toggle-text').textContent = 'Show PDF';
                toggleBtn.classList.add('pdf-hidden');
            }
            if (headerToggle) headerToggle.textContent = 'üìÑ Show PDF';
        }
    }

    /**
     * Copy BIN to clipboard (unified - handles ELV3 Lookup, main tab, and scan results)
     */
    async function copyBinToClipboard(bin, event) {
        try {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            if (!bin || String(bin).trim() === '-' || String(bin).trim() === '') return;

            const span = event ? event.target.closest('span') : document.querySelector('.elv3-scan-bin-copy');
            if (!span) return;

            const originalHTML = span.innerHTML;
            const originalBg = span.style.backgroundColor;
            const originalColor = span.style.color;
            const originalBorder = span.style.borderColor;

            try {
                await navigator.clipboard.writeText(String(bin).trim());
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = bin;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }

            span.style.backgroundColor = '#4CAF50';
            span.style.color = 'white';
            span.style.borderColor = '#4CAF50';
            span.title = 'Copied!';
            span.innerHTML = '‚úì Copied!';

            setTimeout(() => {
                span.innerHTML = originalHTML;
                span.style.backgroundColor = originalBg;
                span.style.color = originalColor;
                span.style.borderColor = originalBorder;
                span.title = 'Click to copy BIN';
            }, 2000);
        } catch (err) {
            console.error('Failed to copy BIN:', err);
            alert('Failed to copy BIN to clipboard');
        }
    }

    /**
     * Handle file selection (supports multiple files)
     */
    function handleELV3FileScan(event) {
        const files = event.target.files;
        if (files && files.length > 0) {
            const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf');
            if (pdfFiles.length > 0) {
                processELV3ScanBatch(pdfFiles);
            } else {
                document.getElementById('elv3ScanError').textContent = 'Please upload PDF file(s)';
                document.getElementById('elv3ScanError').style.display = 'block';
            }
        }
    }

    /**
     * Show the PDF and scan result at the given index
     */
    function showCurrentELV3Pdf(index) {
        if (!elv3ScanItems.length || index < 0 || index >= elv3ScanItems.length) return;
        
        elv3ScanCurrentIndex = index;
        const item = elv3ScanItems[index];
        const previewPanel = document.getElementById('elv3ScanPdfPreviewPanel');
        const previewFrame = document.getElementById('elv3ScanPdfPreviewFrame');
        const resultContent = document.getElementById('elv3ScanResultContent');
        const prevBtn = document.getElementById('elv3ScanPrevBtn');
        const nextBtn = document.getElementById('elv3ScanNextBtn');
        const counter = document.getElementById('elv3ScanPdfCounter');
        
        previewFrame.src = item.blobUrl;
        renderELV3ScanResult(item.result, resultContent);
        
        const total = elv3ScanItems.length;
        counter.textContent = `PDF ${index + 1} of ${total}`;
        counter.style.display = 'inline';
        prevBtn.style.display = total > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = total > 1 ? 'inline-block' : 'none';
        prevBtn.disabled = index <= 0;
        nextBtn.disabled = index >= total - 1;
        
        previewPanel.style.display = 'flex';

        const headerToggle = document.getElementById('headerPdfToggle');
        if (headerToggle) {
            headerToggle.style.display = 'inline-block';
            headerToggle.textContent = 'üìÑ Hide PDF';
        }
        const resetBtn = document.getElementById('headerResetView');
        if (resetBtn) resetBtn.style.display = 'inline-block';
    }

    /**
     * Show previous PDF
     */
    function showPrevELV3Pdf() {
        if (elv3ScanCurrentIndex > 0) {
            showCurrentELV3Pdf(elv3ScanCurrentIndex - 1);
        }
    }

    /**
     * Show next PDF
     */
    function showNextELV3Pdf() {
        if (elv3ScanCurrentIndex < elv3ScanItems.length - 1) {
            showCurrentELV3Pdf(elv3ScanCurrentIndex + 1);
        }
    }

    /**
     * Toggle PDF fullscreen mode
     */
    function togglePdfScanFullscreen() {
        const previewPanel = document.getElementById('elv3ScanPdfPreviewPanel');
        previewPanel.classList.toggle('elv3-scan-pdf-fullscreen');
        
        const btn = previewPanel.querySelector('.elv3-scan-fullscreen-btn');
        if (previewPanel.classList.contains('elv3-scan-pdf-fullscreen')) {
            btn.textContent = '‚úï Exit Fullscreen';
        } else {
            btn.textContent = '‚õ∂ Fullscreen';
        }
    }

    /**
     * Drag-to-resize handles between scan modal panels.
     * Works for horizontal (wide) and vertical (narrow) layouts.
     */
    function initResizeHandles() {
        var handles = document.querySelectorAll('.elv3-scan-resize-handle');
        handles.forEach(function(handle) {
            handle.removeEventListener('mousedown', handle._onDown);
            handle.removeEventListener('touchstart', handle._onDown);
        });

        handles.forEach(function(handle) {
            function getAdjacentPanels() {
                var isNarrow = window.innerWidth <= 900;
                var modalBody = handle.closest('.elv3-scan-modal-body');
                if (!modalBody) return null;

                var children = Array.from(modalBody.children).filter(function(el) {
                    return el.offsetParent !== null;
                });

                if (isNarrow) {
                    children.sort(function(a, b) {
                        return (parseInt(getComputedStyle(a).order) || 0) - (parseInt(getComputedStyle(b).order) || 0);
                    });
                }

                var idx = children.indexOf(handle);
                if (idx < 1 || idx >= children.length - 1) return null;
                return { before: children[idx - 1], after: children[idx + 1], isNarrow: isNarrow };
            }

            function onDown(e) {
                var panels = getAdjacentPanels();
                if (!panels) return;
                e.preventDefault();

                var isTouch = e.type === 'touchstart';
                var startPos = isTouch ? e.touches[0] : e;
                var startX = startPos.clientX;
                var startY = startPos.clientY;

                var beforeRect = panels.before.getBoundingClientRect();
                var afterRect = panels.after.getBoundingClientRect();
                var startBeforeW = beforeRect.width;
                var startAfterW = afterRect.width;
                var startBeforeH = beforeRect.height;
                var startAfterH = afterRect.height;
                var isNarrow = panels.isNarrow;
                var beforeEl = panels.before;
                var afterEl = panels.after;

                handle.classList.add('dragging');
                var modalBody = handle.closest('.elv3-scan-modal-body');
                if (modalBody) modalBody.classList.add('elv3-scan-resizing');

                function onMove(ev) {
                    var pos = ev.type.includes('touch') ? ev.touches[0] : ev;
                    if (isNarrow) {
                        var dy = pos.clientY - startY;
                        var newBH = Math.max(100, startBeforeH + dy);
                        var newAH = Math.max(100, startAfterH - dy);
                        beforeEl.style.height = newBH + 'px';
                        beforeEl.style.flex = '0 0 auto';
                        afterEl.style.height = newAH + 'px';
                        afterEl.style.flex = '0 0 auto';
                    } else {
                        var dx = pos.clientX - startX;
                        var newBW = Math.max(150, startBeforeW + dx);
                        var newAW = Math.max(150, startAfterW - dx);
                        beforeEl.style.width = newBW + 'px';
                        beforeEl.style.flex = '0 0 auto';
                        afterEl.style.width = newAW + 'px';
                        afterEl.style.flex = '0 0 auto';
                    }
                }

                function onUp() {
                    handle.classList.remove('dragging');
                    if (modalBody) modalBody.classList.remove('elv3-scan-resizing');
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onUp);
                }

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onUp);
            }

            handle._onDown = onDown;
            handle.addEventListener('mousedown', onDown);
            handle.addEventListener('touchstart', onDown, { passive: false });
        });
    }

    /**
     * Clear all custom resize styles from scan modal panels and handles
     */
    function resetResizePanels() {
        var panels = document.querySelectorAll('.elv3-scan-left-panel, .elv3-scan-right-panel, .elv3-scan-lookup-panel');
        panels.forEach(function(p) {
            p.style.width = '';
            p.style.height = '';
            p.style.flex = '';
        });
        var modalBody = document.querySelector('.elv3-scan-modal-body');
        if (modalBody) modalBody.classList.remove('elv3-scan-resizing');
    }

    function resetScanView() {
        resetResizePanels();

        var pdfPanel = document.getElementById('elv3ScanPdfPreviewPanel');
        var handle1 = document.getElementById('elv3ScanResizeHandle1');
        var handle2 = document.getElementById('elv3ScanResizeHandle2');
        var modalBody = document.querySelector('.elv3-scan-modal-body');
        var toggleBtn = document.querySelector('.elv3-scan-toggle-pdf-btn');
        var headerToggle = document.getElementById('headerPdfToggle');

        if (pdfPanel && elv3ScanItems.length > 0) {
            pdfPanel.style.display = 'flex';
            pdfPanel.classList.remove('hidden');
        }
        if (handle1) handle1.style.display = '';
        if (handle2) handle2.style.display = '';
        if (modalBody) modalBody.classList.remove('elv3-scan-pdf-hidden');
        if (toggleBtn) {
            toggleBtn.querySelector('.toggle-text').textContent = 'Hide PDF';
            toggleBtn.classList.remove('pdf-hidden');
        }
        if (headerToggle) headerToggle.textContent = 'üìÑ Hide PDF';
    }

    /**
     * Process and parse multiple ELV3 PDF files
     */
    async function processELV3ScanBatch(files) {
        const uploadArea = document.getElementById('elv3ScanUploadArea');
        const progressDiv = document.getElementById('elv3ScanProgress');
        const progressFill = document.getElementById('elv3ScanProgressFill');
        const statusText = document.getElementById('elv3ScanStatusText');
        const resultDiv = document.getElementById('elv3ScanResult');
        const errorDiv = document.getElementById('elv3ScanError');

        for (const item of elv3ScanItems) {
            if (item.blobUrl) URL.revokeObjectURL(item.blobUrl);
        }
        elv3ScanItems = [];
        elv3ScanCurrentIndex = 0;

        document.querySelector('.elv3-scan-left-panel').classList.remove('elv3-scan-upload-centered');
        uploadArea.style.display = 'none';
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        progressFill.classList.add('indeterminate');

        const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf');
        const total = pdfFiles.length;

        for (let i = 0; i < pdfFiles.length; i++) {
            const file = pdfFiles[i];
            statusText.textContent = total > 1 ? `Processing PDF ${i + 1} of ${total}...` : 'Parsing ELV3 form...';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await parseELV3PDFClient(arrayBuffer);

                if (result.devices.length > 0 && !result.bin) {
                    statusText.textContent = total > 1 ? `Looking up BIN for PDF ${i + 1}...` : 'Looking up BIN number...';
                    const firstDevice = result.devices[0];
                    const deviceNumber = firstDevice.deviceNumber || firstDevice;
                    try {
                        const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${encodeURIComponent(deviceNumber)}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.length > 0 && data[0].bin) {
                                result.bin = data[0].bin;
                                if (!result.address && data[0].house_number && data[0].street_name) {
                                    result.address = `${data[0].house_number} ${data[0].street_name}`.trim();
                                }
                            }
                        }
                    } catch (apiError) {
                        console.log('Could not fetch BIN from API:', apiError);
                    }
                }

                const blobUrl = URL.createObjectURL(file);
                elv3ScanItems.push({ file, result, blobUrl });
            } catch (error) {
                console.error('Failed to parse PDF:', file.name, error);
                const blobUrl = URL.createObjectURL(file);
                elv3ScanItems.push({
                    file,
                    result: { success: false, errorMessage: error.message, violations: [], violationsByDevice: {}, devices: [], satisfactoryDevices: [] },
                    blobUrl
                });
            }
        }

        progressFill.classList.remove('indeterminate');
        progressDiv.style.display = 'none';

        if (elv3ScanItems.length === 0) {
            errorDiv.textContent = 'No PDFs could be parsed. Please try valid ELV3 PDF files.';
            errorDiv.style.display = 'block';
            uploadArea.style.display = 'flex';
            document.querySelector('.elv3-scan-left-panel').classList.add('elv3-scan-upload-centered');
            return;
        }

        resultDiv.style.display = '';
        resultDiv.classList.remove('error');
        showCurrentELV3Pdf(0);
    }

    /**
     * Process and parse a single ELV3 PDF file (legacy ‚Äì use processELV3ScanBatch for multiple)
     */
    async function processELV3Scan(file) {
        const uploadArea = document.getElementById('elv3ScanUploadArea');
        const progressDiv = document.getElementById('elv3ScanProgress');
        const progressFill = document.getElementById('elv3ScanProgressFill');
        const statusText = document.getElementById('elv3ScanStatusText');
        const resultDiv = document.getElementById('elv3ScanResult');
        const errorDiv = document.getElementById('elv3ScanError');
        
        // Hide upload area, show progress
        document.querySelector('.elv3-scan-left-panel').classList.remove('elv3-scan-upload-centered');
        uploadArea.style.display = 'none';
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        progressFill.classList.add('indeterminate');
        statusText.textContent = 'Parsing ELV3 form...';
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            const result = await parseELV3PDFClient(arrayBuffer);
            
            // Try to fetch BIN from DOB API using the first device number
            if (result.devices.length > 0 && !result.bin) {
                statusText.textContent = 'Looking up BIN number...';
                const firstDevice = result.devices[0];
                const deviceNumber = firstDevice.deviceNumber || firstDevice;
                console.log(`Looking up BIN for device: ${deviceNumber}`);
                try {
                    // Use the same API as the rest of the site: e5aq-a4j2.json?device_number=
                    const response = await fetch(`https://data.cityofnewyork.us/resource/e5aq-a4j2.json?device_number=${encodeURIComponent(deviceNumber)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0 && data[0].bin) {
                            result.bin = data[0].bin;
                            // Also get address if not already set
                            if (!result.address && data[0].house_number && data[0].street_name) {
                                result.address = `${data[0].house_number} ${data[0].street_name}`.trim();
                            }
                            console.log(`BIN fetched from API: ${result.bin}, Address: ${result.address}`);
                        }
                    }
                } catch (apiError) {
                    console.log('Could not fetch BIN from API:', apiError);
                }
            }
            
            progressFill.classList.remove('indeterminate');
            progressDiv.style.display = 'none';
            
            // Show success result
            resultDiv.style.display = '';
            resultDiv.classList.remove('error');
            
            renderELV3ScanResult(result);
            
        } catch (error) {
            progressFill.classList.remove('indeterminate');
            progressDiv.style.display = 'none';
            
            resultDiv.style.display = '';
            resultDiv.classList.add('error');
            document.getElementById('elv3ScanResultContent').innerHTML = `
                <h4>‚úó Scan Failed</h4>
                <div class="elv3-scan-result-details">
                    <p>${error.message}</p>
                </div>
            `;
            
            setTimeout(() => {
                uploadArea.style.display = 'flex';
                document.querySelector('.elv3-scan-left-panel').classList.add('elv3-scan-upload-centered');
            }, 2000);
        }
    }

    /**
     * Parse ELV3 PDF client-side using pdf-lib
     */
    async function parseELV3PDFClient(arrayBuffer) {
        const result = {
            success: false,
            address: null,
            bin: null,
            devices: [],
            violations: [],
            violationsByDevice: {},
            satisfactoryDevices: [],
            devicesWithViolations: []
        };
        
        try {
            // Check if PDFLib is loaded
            if (typeof PDFLib === 'undefined') {
                throw new Error('PDF library not loaded. Please refresh the page and try again.');
            }
            
            console.log('PDFLib loaded:', typeof PDFLib);
            console.log('PDFLib.PDFDocument:', typeof PDFLib.PDFDocument);
            
            const { PDFDocument } = PDFLib;
            console.log('Loading PDF, buffer size:', arrayBuffer.byteLength);
            
            const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
            console.log('PDF loaded successfully, pages:', pdfDoc.getPageCount());
            
            const form = pdfDoc.getForm();
            console.log('Form object:', form);
            
            const fields = form.getFields();
            console.log('Raw fields array:', fields);
            
            console.log('Total PDF form fields found:', fields.length);
            
            // Extract all form field values
            const formData = {};
            const allFieldNames = [];
            
            for (const field of fields) {
                const name = field.getName();
                allFieldNames.push(name);
                let value = null;
                
                // Log field type info for debugging
                const fieldMethods = [];
                if (typeof field.getText === 'function') fieldMethods.push('getText');
                if (typeof field.isChecked === 'function') fieldMethods.push('isChecked');
                if (typeof field.getSelected === 'function') fieldMethods.push('getSelected');
                if (typeof field.getOptions === 'function') fieldMethods.push('getOptions');
                
                try {
                    // Use duck typing instead of constructor.name (which can be minified in browser)
                    // Check for getText method (PDFTextField)
                    if (typeof field.getText === 'function') {
                        value = field.getText();
                    }
                    // Check for isChecked method (PDFCheckBox)
                    else if (typeof field.isChecked === 'function') {
                        value = field.isChecked();
                    }
                    // Check for getSelected method (PDFDropdown, PDFRadioGroup)
                    else if (typeof field.getSelected === 'function') {
                        value = field.getSelected();
                    }
                    // Check for getOptions method (PDFOptionList)
                    else if (typeof field.getOptions === 'function') {
                        value = field.getSelected ? field.getSelected() : null;
                    }
                } catch (e) {
                    // Field might not have a value, try alternative approaches
                    console.log(`Could not get value for field "${name}" (methods: ${fieldMethods.join(', ')}):`, e.message);
                }
                
                // Store all values including empty ones for debugging
                if (value !== null && value !== undefined) {
                    if (value !== '') {
                        formData[name] = value;
                    }
                    console.log(`Field "${name}" [${fieldMethods.join(', ')}] = "${value}"`);
                } else {
                    console.log(`Field "${name}" [${fieldMethods.join(', ')}] = (no value)`);
                }
            }
            
            console.log('Fields with values:', Object.keys(formData).length);
            console.log('All field names:', allFieldNames);
            console.log('All form data:', formData);
            
            // Parse the form data
            parseELV3FormData(formData, result, allFieldNames);
            
            // Match server-side logic: success if devices OR violations found
            result.success = result.devices.length > 0 || result.violations.length > 0;
            
            if (!result.success) {
                // Log debug info to help diagnose
                console.log('=== DEBUG: No devices or violations found ===');
                console.log('Total fields:', allFieldNames.length);
                console.log('Fields with values:', Object.keys(formData).length);
                
                // Show more helpful error message
                if (allFieldNames.length === 0) {
                    throw new Error('PDF has no form fields. This may not be a fillable ELV3 form.');
                } else if (Object.keys(formData).length === 0) {
                    throw new Error('PDF form fields are empty. The form may not be filled out.');
                } else {
                    throw new Error('Could not find device numbers in form. Check browser console (F12) for field names.');
                }
            }
            
        } catch (error) {
            console.error('PDF parsing error:', error);
            throw new Error(`Failed to parse PDF: ${error.message}`);
        }
        
        return result;
    }

    /**
     * Parse ELV3 form data into structured result
     * This is a direct port of the server's parseXFAFormFields function
     */
    function parseELV3FormData(formData, result, allFieldNames) {
        console.log('Parsing XFA form fields, total fields:', Object.keys(formData).length);
        
        // Detect which pages exist in the form
        const pagesFound = new Set();
        for (const fieldName of Object.keys(formData)) {
            const pageMatch = fieldName.match(/Page(\d+)/i);
            if (pageMatch) {
                pagesFound.add(parseInt(pageMatch[1]));
            }
        }
        console.log('Pages found in PDF:', Array.from(pagesFound).sort((a,b) => a-b));
        
        // Step 1: Extract all devices and their numbers from ALL pages
        const devices = {}; // Global device index -> deviceNumber
        const deviceAdditionalText = {}; // Global device index -> additional text from Device # field
        let globalDeviceIndex = 0;
        
        // Sort pages to process in order
        const sortedPages = Array.from(pagesFound).sort((a, b) => a - b);
        
        // First, look for devices on Page1 (devices 6+ have _N_Device pattern on Page1)
        for (const [fieldName, value] of Object.entries(formData)) {
            if (!value || value === '') continue;
            if (!fieldName.includes('Page1')) continue;
            
            // Look for device fields with pattern like _6_Device, _7_Device etc. (devices 6+)
            const deviceMatch = fieldName.match(/_(\d+)_Device/i);
            if (deviceMatch) {
                const deviceIndex = parseInt(deviceMatch[1]);
                // Only capture devices 6+ from Page1 (devices 1-5 come from Page2)
                if (deviceIndex >= 6) {
                    const deviceNumber = extractELV3DeviceNumber(value);
                    if (deviceNumber && !devices[deviceIndex]) {
                        devices[deviceIndex] = deviceNumber;
                        globalDeviceIndex = Math.max(globalDeviceIndex, deviceIndex);
                        
                        if (!result.devices.find(d => d.deviceNumber === deviceNumber)) {
                            result.devices.push({
                                deviceNumber: deviceNumber,
                                satisfactory: false,
                                deviceType: 'Elevator'
                            });
                        }
                        console.log(`Found device on Page1: index ${deviceIndex} = ${deviceNumber}`);
                    }
                }
            }
        }
        
        // Then process Page2+ for devices 1-5 and devices 10+
        for (const pageNum of sortedPages) {
            // Skip Page1 as devices 1-5 are detailed on Page2+
            if (pageNum < 2) continue;
            
            const pagePattern = new RegExp(`Page${pageNum}`, 'i');
            
            for (const [fieldName, value] of Object.entries(formData)) {
                if (!value || value === '') continue;
                if (!pagePattern.test(fieldName)) continue;
                
                // Look for device fields with pattern like _1_Device_0_ or _2_Device_0_ etc.
                // Support device indices from 1-99 to handle many devices
                const deviceMatch = fieldName.match(/_(\d+)_Device/i);
                if (deviceMatch) {
                    const localIndex = parseInt(deviceMatch[1]);
                    const deviceNumber = extractELV3DeviceNumber(value);
                    
                    // Also extract full text to capture any additional info after device number
                    const fullInfo = extractDeviceFieldFullText(value);
                    const additionalText = fullInfo ? fullInfo.additionalText : null;
                    
                    if (deviceNumber) {
                        // Calculate global index based on page and local index
                        // Page 2: devices 1-5, Page 3: devices 6-10, etc. (5 per page)
                        // But devices 10+ on Page2 use their actual index
                        let globalIdx;
                        if (localIndex >= 10) {
                            // Device 10+ on Page2 uses actual index
                            globalIdx = localIndex;
                        } else {
                            // Devices 1-5 per page
                            const devicesPerPage = 5;
                            const pageOffset = (pageNum - 2) * devicesPerPage;
                            globalIdx = pageOffset + localIndex;
                        }
                        
                        if (!devices[globalIdx]) {
                            devices[globalIdx] = deviceNumber;
                            globalDeviceIndex = Math.max(globalDeviceIndex, globalIdx);
                            
                            // Store additional text for this device index (for later use in comments)
                            if (additionalText) {
                                deviceAdditionalText[globalIdx] = additionalText;
                                console.log(`Found additional text for device ${deviceNumber}: "${additionalText}"`);
                            }
                            
                            // Add to result devices if not already there
                            if (!result.devices.find(d => d.deviceNumber === deviceNumber)) {
                                result.devices.push({
                                    deviceNumber: deviceNumber,
                                    satisfactory: false,
                                    deviceType: 'Elevator'
                                });
                            }
                            console.log(`Found device on Page${pageNum}: index ${globalIdx} = ${deviceNumber}${additionalText ? ` (${additionalText})` : ''}`);
                        }
                    }
                }
                
                // Extract address from first Page2 field found
                const lowerName = fieldName.toLowerCase();
                if (lowerName.includes('textfield1_0_') && pageNum === 2 && !result.address) {
                    result.address = value.toString().trim();
                }
            }
        }
        
        console.log('Total devices found:', Object.keys(devices).length, devices);
        
        // Step 1b: Extract satisfactory/unsatisfactory status from Page1 checkboxes
        // On Page1, devices are listed with Satisfactory and Unsatisfactory checkboxes
        // Based on analysis:
        // Devices 1-5:   SAT = 34-38,  UNSAT = 39-43
        // Devices 6-10:  SAT = 44-48,  UNSAT = 49-53
        // Devices 11-15: SAT = 54-58,  UNSAT = 59-63
        // Devices 16-20: SAT = 64-68,  UNSAT = 69-73
        // Devices 21-25: SAT = 74-78,  UNSAT = 79-83
        const deviceStatus = {}; // deviceIndex -> { satisfactory: bool, unsatisfactory: bool }
        
        for (const [fieldName, value] of Object.entries(formData)) {
            if (!fieldName.includes('Page1')) continue;
            
            // Look for satisfactory checkbox pattern
            const checkboxMatch = fieldName.match(/CheckBox1_(\d+)/);
            if (checkboxMatch && value === true) {
                const checkboxNum = parseInt(checkboxMatch[1]);
                
                // Determine which device row (0=devices 1-5, 1=devices 6-10, etc.)
                // and whether it's SAT or UNSAT
                // Pattern: Each row of 5 devices has 5 SAT checkboxes then 5 UNSAT checkboxes
                // Row 0: 34-38 SAT, 39-43 UNSAT
                // Row 1: 44-48 SAT, 49-53 UNSAT
                // etc.
                
                if (checkboxNum >= 34) {
                    const adjustedNum = checkboxNum - 34;
                    const rowOf10 = Math.floor(adjustedNum / 10); // Each row has 10 checkboxes (5 SAT + 5 UNSAT)
                    const posInRow = adjustedNum % 10;
                    
                    const isSatisfactory = posInRow < 5;
                    const deviceInRow = posInRow < 5 ? posInRow : posInRow - 5;
                    const deviceIdx = (rowOf10 * 5) + deviceInRow + 1;
                    
                    if (!deviceStatus[deviceIdx]) deviceStatus[deviceIdx] = {};
                    
                    if (isSatisfactory) {
                        deviceStatus[deviceIdx].satisfactory = true;
                        console.log(`Device ${deviceIdx} marked as SATISFACTORY (CheckBox1_${checkboxNum})`);
                    } else {
                        deviceStatus[deviceIdx].unsatisfactory = true;
                        console.log(`Device ${deviceIdx} marked as UNSATISFACTORY (CheckBox1_${checkboxNum})`);
                    }
                }
            }
        }
        
        // Update device satisfactory status in result
        for (const device of result.devices) {
            const deviceIdx = Object.entries(devices).find(([idx, num]) => num === device.deviceNumber)?.[0];
            if (deviceIdx && deviceStatus[deviceIdx]) {
                device.satisfactory = deviceStatus[deviceIdx].satisfactory === true && !deviceStatus[deviceIdx].unsatisfactory;
            }
        }
        
        console.log('Device status:', deviceStatus);
        
        // Step 2: Extract violations from main Elevator_Part fields (Row 1 for each device)
        // Scan ALL pages for violation data
        const mainViolations = {}; // globalDeviceIndex -> {partCode, conditionCode, remedyCode}
        
        for (const pageNum of sortedPages) {
            if (pageNum < 2) continue;
            
            const pagePattern = new RegExp(`Page${pageNum}`, 'i');
            const devicesPerPage = 5;
            const pageOffset = (pageNum - 2) * devicesPerPage;
            
            for (const [fieldName, value] of Object.entries(formData)) {
                if (!value || value === '') continue;
                if (!pagePattern.test(fieldName)) continue;
                
                // Elevator_Part_0_ = device 1 (index 0 maps to device index 1)
                // Elevator_Part_2_0_ = device 2 (index 2 maps to device index 2)
                // Elevator_Part_3_0_ = device 3, etc.
                const partMatch = fieldName.match(/Elevator_Part(?:_(\d+))?_0_/i);
                if (partMatch) {
                    const fieldIndex = partMatch[1] ? parseInt(partMatch[1]) : 0;
                    // Map field index to device: 0->1, 2->2, 3->3, 4->4, 5->5 (local to page)
                    const localDeviceIndex = fieldIndex === 0 ? 1 : fieldIndex;
                    const globalDeviceIdx = pageOffset + localDeviceIndex;
                    if (!mainViolations[globalDeviceIdx]) mainViolations[globalDeviceIdx] = {};
                    mainViolations[globalDeviceIdx].partCode = value.toString().trim().padStart(2, '0');
                }
                
                const conditionMatch = fieldName.match(/Violation_Condition(?:_(\d+))?_0_/i);
                if (conditionMatch) {
                    const fieldIndex = conditionMatch[1] ? parseInt(conditionMatch[1]) : 0;
                    const localDeviceIndex = fieldIndex === 0 ? 1 : fieldIndex;
                    const globalDeviceIdx = pageOffset + localDeviceIndex;
                    if (!mainViolations[globalDeviceIdx]) mainViolations[globalDeviceIdx] = {};
                    mainViolations[globalDeviceIdx].conditionCode = value.toString().trim().toUpperCase();
                }
                
                const remedyMatch = fieldName.match(/Suggested_Remedy(?:_(\d+))?_0_/i);
                if (remedyMatch) {
                    const fieldIndex = remedyMatch[1] ? parseInt(remedyMatch[1]) : 0;
                    const localDeviceIndex = fieldIndex === 0 ? 1 : fieldIndex;
                    const globalDeviceIdx = pageOffset + localDeviceIndex;
                    if (!mainViolations[globalDeviceIdx]) mainViolations[globalDeviceIdx] = {};
                    mainViolations[globalDeviceIdx].remedyCode = value.toString().trim().padStart(2, '0');
                }
            }
        }
        
        // Step 2b: Extract violations for devices 10+ using Elevator_Part_6[N] pattern
        // This section uses array indices: [1] = device 12, [2] = device 13, etc.
        // Formula: device_number = 11 + array_index
        const devices10PlusViolations = {}; // deviceIndex -> { partCode, conditionCode, remedyCode }
        
        for (const [fieldName, value] of Object.entries(formData)) {
            if (!value || value === '') continue;
            if (!fieldName.includes('Page2')) continue;
            
            // Match Elevator_Part_6[N] pattern (NOT Elevator_Part_6_0 which is underscore format)
            const partMatch6 = fieldName.match(/Elevator_Part_6\[(\d+)\]/i);
            if (partMatch6) {
                const arrayIndex = parseInt(partMatch6[1]);
                if (arrayIndex > 0) { // [0] is usually empty, [1]+ are devices 12+
                    const deviceIdx = 11 + arrayIndex; // [1] = device 12, [2] = device 13
                    if (!devices10PlusViolations[deviceIdx]) devices10PlusViolations[deviceIdx] = {};
                    devices10PlusViolations[deviceIdx].partCode = value.toString().trim().padStart(2, '0');
                    console.log(`Found device 10+ violation part: Device ${deviceIdx}, Part ${value}`);
                }
            }
            
            const conditionMatch6 = fieldName.match(/Violation_Condition_6\[(\d+)\]/i);
            if (conditionMatch6) {
                const arrayIndex = parseInt(conditionMatch6[1]);
                if (arrayIndex > 0) {
                    const deviceIdx = 11 + arrayIndex;
                    if (!devices10PlusViolations[deviceIdx]) devices10PlusViolations[deviceIdx] = {};
                    devices10PlusViolations[deviceIdx].conditionCode = value.toString().trim().toUpperCase();
                }
            }
            
            const remedyMatch6 = fieldName.match(/Suggested_Remedy_6\[(\d+)\]/i);
            if (remedyMatch6) {
                const arrayIndex = parseInt(remedyMatch6[1]);
                if (arrayIndex > 0) {
                    const deviceIdx = 11 + arrayIndex;
                    if (!devices10PlusViolations[deviceIdx]) devices10PlusViolations[deviceIdx] = {};
                    devices10PlusViolations[deviceIdx].remedyCode = value.toString().trim().padStart(2, '0');
                }
            }
        }
        
        // Add devices 10+ violations to mainViolations
        for (const [deviceIdx, viol] of Object.entries(devices10PlusViolations)) {
            if (viol.partCode) {
                mainViolations[deviceIdx] = viol;
            }
        }
        
        // Add main violations to result
        for (const [deviceIndex, viol] of Object.entries(mainViolations)) {
            const deviceNumber = devices[deviceIndex];
            if (deviceNumber && viol.partCode) {
                // Include additional text from Device # field if present
                const additionalInfo = deviceAdditionalText[deviceIndex] || null;
                const violation = {
                    deviceNumber: deviceNumber,
                    partCode: viol.partCode,
                    partDescription: getELV3PartDescriptionWithLocation(viol.partCode),
                    conditionCode: viol.conditionCode || null,
                    conditionDescription: ELV3_CONDITION_CODES[viol.conditionCode] || viol.conditionCode,
                    remedyCode: viol.remedyCode || null,
                    remedyDescription: ELV3_REMEDY_CODES[viol.remedyCode] || `Remedy ${viol.remedyCode}`,
                    comments: null, // Will be filled by actual comments later
                    deviceFieldText: additionalInfo // Store the extra text from Device # field separately
                };
                result.violations.push(violation);
                console.log(`Found main violation: Device ${violation.deviceNumber}, Part ${violation.partCode}, Condition ${violation.conditionCode}, Remedy ${violation.remedyCode}${additionalInfo ? `, Additional: ${additionalInfo}` : ''}`);
            }
        }
        
        // Step 3: Extract additional violation rows from TextField1_ fields
        // Scan ALL pages for TextField data
        const textFieldsByPage = {}; // pageNum -> { fieldNum -> value }
        
        for (const pageNum of sortedPages) {
            if (pageNum < 2) continue;
            
            const pagePattern = new RegExp(`Page${pageNum}`, 'i');
            textFieldsByPage[pageNum] = {};
            
            for (const [fieldName, value] of Object.entries(formData)) {
                if (!value) continue;
                if (!pagePattern.test(fieldName)) continue;
                
                const match = fieldName.match(/TextField1_(\d+)_/);
                if (match) {
                    const num = parseInt(match[1]);
                    textFieldsByPage[pageNum][num] = value.toString().trim();
                }
            }
        }
        
        // Step 3b: Also collect TextField1[N] bracket notation (used for devices 10+ additional violations)
        const bracketTextFields = {}; // fieldNum -> value
        for (const [fieldName, value] of Object.entries(formData)) {
            if (!value) continue;
            if (!fieldName.includes('Page2')) continue;
            
            // Match TextField1[N] (bracket notation, not underscore)
            const bracketMatch = fieldName.match(/TextField1\[(\d+)\]$/);
            if (bracketMatch) {
                const num = parseInt(bracketMatch[1]);
                bracketTextFields[num] = value.toString().trim();
            }
        }
        
        // Scan for violation triplets (Part, Condition, Remedy)
        // Part: 2-digit number (01-99)
        // Condition: 1-2 letters (A-Z, BB, etc.)
        // Remedy: 2-digit number (01-99)
        const partPattern = /^\d{1,2}$/;
        const conditionPattern = /^[A-Z]{1,2}$/i;  // Allow 1-2 letters for conditions like "BB"
        const remedyPattern = /^\d{1,2}$/;
        
        // Each device section has ~27 fields (9 rows x 3 fields)
        const FIELDS_PER_DEVICE = 27;
        const FIRST_DEVICE_OFFSET = 7;
        const devicesPerPage = 5;
        
        // Find all valid triplets from ALL pages
        const foundTriplets = [];
        
        for (const pageNum of sortedPages) {
            if (pageNum < 2) continue;
            
            const textFields = textFieldsByPage[pageNum] || {};
            const pageOffset = (pageNum - 2) * devicesPerPage;
            
            // Scan up to 500 fields to handle many devices
            for (let i = 0; i <= 500; i++) {
                const a = textFields[i];
                const b = textFields[i + 1];
                const c = textFields[i + 2];
                
                if (a && b && c) {
                    const aClean = a.trim();
                    const bClean = b.trim().toUpperCase();
                    const cClean = c.trim();
                    
                    if (partPattern.test(aClean) && conditionPattern.test(bClean) && remedyPattern.test(cClean)) {
                        // Determine which device this belongs to based on field offset
                        const offset = i - FIRST_DEVICE_OFFSET;
                        const localDeviceIndex = Math.floor(offset / FIELDS_PER_DEVICE) + 1;
                        const globalDeviceIndex = pageOffset + localDeviceIndex;
                        
                        foundTriplets.push({
                            page: pageNum,
                            fieldStart: i,
                            deviceIndex: globalDeviceIndex,
                            partCode: aClean.padStart(2, '0'),
                            conditionCode: bClean,
                            remedyCode: cClean.padStart(2, '0')
                        });
                    }
                }
            }
        }
        
        console.log(`Found ${foundTriplets.length} potential violation triplets across all pages`);
        
        // Step 3c: Find violation triplets in bracket notation TextField1[N] (for devices 10+)
        const bracketTriplets = [];
        const bracketIndices = Object.keys(bracketTextFields).map(Number).sort((a, b) => a - b);
        
        for (let i = 0; i < bracketIndices.length - 2; i++) {
            const idx1 = bracketIndices[i];
            const idx2 = bracketIndices[i + 1];
            const idx3 = bracketIndices[i + 2];
            
            // Check if they're consecutive
            if (idx2 === idx1 + 1 && idx3 === idx1 + 2) {
                const a = bracketTextFields[idx1];
                const b = bracketTextFields[idx2];
                const c = bracketTextFields[idx3];
                
                if (a && b && c) {
                    const aClean = a.trim();
                    const bClean = b.trim().toUpperCase();
                    const cClean = c.trim();
                    
                    if (partPattern.test(aClean) && conditionPattern.test(bClean) && remedyPattern.test(cClean)) {
                        // For bracket notation, device mapping based on field range
                        let targetDevice = null;
                        if (idx1 >= 80 && idx1 < 90) targetDevice = 13;
                        else if (idx1 >= 70 && idx1 < 80) targetDevice = 12;
                        else if (idx1 >= 90 && idx1 < 100) targetDevice = 14;
                        
                        if (targetDevice && devices[targetDevice]) {
                            bracketTriplets.push({
                                fieldStart: idx1,
                                deviceIndex: targetDevice,
                                partCode: aClean.padStart(2, '0'),
                                conditionCode: bClean,
                                remedyCode: cClean.padStart(2, '0')
                            });
                            console.log(`Found bracket violation: TextField1[${idx1}] -> Device ${targetDevice}, Part ${aClean}, Condition ${bClean}, Remedy ${cClean}`);
                        }
                    }
                }
            }
        }
        
        // Add bracket triplet violations to result
        for (const triplet of bracketTriplets) {
            const deviceNumber = devices[triplet.deviceIndex];
            if (deviceNumber) {
                // Include additional text from Device # field if present
                const additionalInfo = deviceAdditionalText[triplet.deviceIndex] || null;
                const violation = {
                    deviceNumber: deviceNumber,
                    partCode: triplet.partCode,
                    partDescription: getELV3PartDescriptionWithLocation(triplet.partCode),
                    conditionCode: triplet.conditionCode,
                    conditionDescription: ELV3_CONDITION_CODES[triplet.conditionCode] || triplet.conditionCode,
                    remedyCode: triplet.remedyCode,
                    remedyDescription: ELV3_REMEDY_CODES[triplet.remedyCode] || `Remedy ${triplet.remedyCode}`,
                    comments: null, // Will be filled by actual comments later
                    deviceFieldText: additionalInfo
                };
                result.violations.push(violation);
                console.log(`Found bracket additional violation: Device ${violation.deviceNumber}, Part ${violation.partCode}, Condition ${violation.conditionCode}, Remedy ${violation.remedyCode}`);
            }
        }
        
        // Add TextField violations to result
        for (const triplet of foundTriplets) {
            const deviceNumber = devices[triplet.deviceIndex];
            if (deviceNumber) {
                // Check if this exact violation already exists (from main fields)
                const exists = result.violations.some(v => 
                    v.deviceNumber === deviceNumber && 
                    v.partCode === triplet.partCode && 
                    v.conditionCode === triplet.conditionCode &&
                    v.remedyCode === triplet.remedyCode
                );
                
                if (!exists) {
                    // Include additional text from Device # field if present
                    const additionalInfo = deviceAdditionalText[triplet.deviceIndex] || null;
                    const violation = {
                        deviceNumber: deviceNumber,
                        partCode: triplet.partCode,
                        partDescription: getELV3PartDescriptionWithLocation(triplet.partCode),
                        conditionCode: triplet.conditionCode,
                        conditionDescription: ELV3_CONDITION_CODES[triplet.conditionCode] || triplet.conditionCode,
                        remedyCode: triplet.remedyCode,
                        remedyDescription: ELV3_REMEDY_CODES[triplet.remedyCode] || `Remedy ${triplet.remedyCode}`,
                        comments: null, // Will be filled by actual comments later
                        deviceFieldText: additionalInfo
                    };
                    result.violations.push(violation);
                    console.log(`Found additional violation (Page${triplet.page} TextField1_${triplet.fieldStart}): Device ${violation.deviceNumber}, Part ${violation.partCode}, Condition ${violation.conditionCode}, Remedy ${violation.remedyCode}`);
                }
            } else {
                console.log(`Warning: Found triplet at Page${triplet.page} TextField1_${triplet.fieldStart} but couldn't map to device index ${triplet.deviceIndex}`);
            }
        }
        
        // Step 4: Look for comments in "Text Field" fields (note the space)
        const deviceComments = {};
        const COMMENT_FIELDS_PER_DEVICE = 3;
        
        for (const [fieldName, value] of Object.entries(formData)) {
            if (!value) continue;
            
            const strValue = value.toString().trim();
            if (!strValue) continue;
            
            // Look for "Text Field" pattern (with space) - these are the comment fields
            const textFieldMatch = fieldName.match(/Text Field(\d+)/);
            if (textFieldMatch) {
                const fieldNum = parseInt(textFieldMatch[1]);
                const deviceIndex = Math.floor(fieldNum / COMMENT_FIELDS_PER_DEVICE) + 1;
                const rowIndex = fieldNum % COMMENT_FIELDS_PER_DEVICE;
                
                if (devices[deviceIndex]) {
                    if (!deviceComments[deviceIndex]) deviceComments[deviceIndex] = [];
                    deviceComments[deviceIndex].push({
                        row: rowIndex,
                        comment: strValue
                    });
                    console.log(`Found comment for device ${deviceIndex} (${devices[deviceIndex]}) row ${rowIndex}: ${strValue.substring(0, 50)}...`);
                }
            }
            
            // Also check for Comment_N_ patterns
            const commentMatch = fieldName.match(/Comments?_(\d+)?/i);
            if (commentMatch && strValue.length > 0) {
                const deviceIdx = commentMatch[1] ? parseInt(commentMatch[1]) : 1;
                if (!deviceComments[deviceIdx]) deviceComments[deviceIdx] = [];
                deviceComments[deviceIdx].push({ row: 0, comment: strValue });
            }
        }
        
        console.log(`Found comments for ${Object.keys(deviceComments).length} devices`);
        
        // Attach comments to violations
        for (const [deviceIndex, comments] of Object.entries(deviceComments)) {
            const deviceNumber = devices[deviceIndex];
            if (deviceNumber && comments.length > 0) {
                const combinedComment = comments.map(c => c.comment).join(' | ');
                for (const violation of result.violations) {
                    if (violation.deviceNumber === deviceNumber && !violation.comments) {
                        violation.comments = combinedComment;
                    }
                }
                console.log(`Attached comments to device ${deviceNumber}: ${combinedComment.substring(0, 80)}...`);
            }
        }
        
        // Step 5: Group violations by device for easier display
        result.violationsByDevice = {};
        for (const violation of result.violations) {
            if (!result.violationsByDevice[violation.deviceNumber]) {
                result.violationsByDevice[violation.deviceNumber] = [];
            }
            result.violationsByDevice[violation.deviceNumber].push(violation);
        }
        
        // Step 6: Separate devices into those with violations and satisfactory ones
        result.devicesWithViolations = [];
        result.satisfactoryDevices = [];
        
        for (const device of result.devices) {
            const hasViolations = result.violationsByDevice[device.deviceNumber]?.length > 0;
            if (hasViolations) {
                result.devicesWithViolations.push(device);
            } else if (device.satisfactory) {
                result.satisfactoryDevices.push(device);
            } else {
                // Device has no violations but wasn't marked satisfactory
                // Still include in satisfactory list (it was tested)
                result.satisfactoryDevices.push({
                    ...device,
                    satisfactory: true
                });
            }
        }
        
        console.log('Total violations found:', result.violations.length);
        console.log('Devices with violations:', result.devicesWithViolations.length);
        console.log('Satisfactory devices:', result.satisfactoryDevices.length);
    }

    /**
     * Extract device number from a string
     */
    function extractELV3DeviceNumber(value) {
        if (!value) return null;
        const str = value.toString().trim().toUpperCase();
        // Pattern: 1 digit, 1 letter, 3-8 digits (e.g., 1P49414, 1P0989351)
        const match = str.match(/(\d[A-Z]\d{3,8})/);
        return match ? match[1] : null;
    }
    
    /**
     * Extract the full text from a Device # field (device number + any additional text)
     */
    function extractDeviceFieldFullText(value) {
        if (!value) return null;
        const str = value.toString().trim();
        const deviceNumber = extractELV3DeviceNumber(str);
        if (!deviceNumber) return null;
        
        // Get any text after the device number
        const upperStr = str.toUpperCase();
        const deviceIndex = upperStr.indexOf(deviceNumber);
        if (deviceIndex === -1) return null;
        
        const afterDevice = str.substring(deviceIndex + deviceNumber.length).trim();
        // Clean up common separators at the start
        const additionalText = afterDevice.replace(/^[-‚Äì‚Äî:,\s]+/, '').trim();
        
        return {
            deviceNumber: deviceNumber,
            additionalText: additionalText || null,
            fullText: str
        };
    }

    async function copyAllViolations(event) {
        if (!elv3ScanItems.length) return;
        var item = elv3ScanItems[elv3ScanCurrentIndex];
        if (!item || !item.result) return;
        var data = item.result;

        var lines = [];
        if (data.address) lines.push('Address: ' + data.address);
        if (data.bin) lines.push('BIN: ' + data.bin);
        lines.push('Devices Scanned: ' + (data.devices || []).length);

        var vbd = data.violationsByDevice || {};
        var devicesWithV = Object.keys(vbd).length;
        var satisfactory = data.satisfactoryDevices || [];
        lines.push('Devices with Violations: ' + devicesWithV);
        lines.push('Satisfactory Devices: ' + satisfactory.length);
        lines.push('Total Violations: ' + (data.violations || []).length);
        lines.push('');

        if (data.violations && data.violations.length > 0) {
            lines.push('--- DEVICES WITH VIOLATIONS ---');
            lines.push('');
            Object.entries(vbd).forEach(function(entry) {
                var deviceNumber = entry[0];
                var violations = entry[1];
                var fieldText = violations[0] && violations[0].deviceFieldText ? ' (' + violations[0].deviceFieldText + ')' : '';
                lines.push(deviceNumber + fieldText + '  ‚Äî  ' + violations.length + ' violation' + (violations.length > 1 ? 's' : ''));
                violations.forEach(function(v) {
                    lines.push('  Part ' + v.partCode + ' | Cond ' + (v.conditionCode || '-') + ' | Remedy ' + (v.remedyCode || '-'));
                    lines.push('  ' + v.partDescription);
                    var details = (v.conditionDescription || '') + ' ‚Üí ' + (v.remedyDescription || '');
                    if (details.trim() !== '‚Üí') lines.push('  ' + details.trim());
                    if (v.comments) lines.push('  "' + v.comments + '"');
                });
                lines.push('');
            });
        }

        if (satisfactory.length > 0) {
            lines.push('--- SATISFACTORY DEVICES ---');
            satisfactory.forEach(function(d) {
                lines.push(d.deviceNumber + '  ‚úì Satisfactory');
            });
            lines.push('');
        }

        var text = lines.join('\n');

        try {
            await navigator.clipboard.writeText(text);
        } catch (e) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }

        var btn = event && event.target ? event.target.closest('.elv3-scan-copy-all-btn') : null;
        if (btn) {
            var origHTML = btn.innerHTML;
            btn.innerHTML = '<span class="copy-icon">‚úì</span><span class="copy-text">Copied!</span>';
            btn.style.borderColor = '#10b981';
            btn.style.color = '#10b981';
            setTimeout(function() {
                btn.innerHTML = origHTML;
                btn.style.borderColor = '';
                btn.style.color = '';
            }, 2000);
        }
    }

    /**
     * Render the ELV3 scan result
     */
    function renderELV3ScanResult(data, targetEl) {
        const container = targetEl || document.getElementById('elv3ScanResultContent');
        if (data.success === false) {
            if (container) {
                container.innerHTML = `
                    <h4>‚úó Scan Failed</h4>
                    <div class="elv3-scan-result-details">
                        <p>${data.errorMessage || 'Could not parse this PDF.'}</p>
                    </div>
                `;
            }
            return;
        }
        const devicesWithViolationsCount = Object.keys(data.violationsByDevice || {}).length;
        const satisfactoryDevices = data.satisfactoryDevices || [];
        const totalDevices = (data.devices || []).length;
        
        let resultHtml = `
            <h4>‚úì Scan Complete</h4>
            <div class="elv3-scan-result-details">
                ${data.address ? `<p><strong>Address:</strong> ${data.address}</p>` : ''}
                ${data.bin ? `<p><strong>BIN:</strong> <span class="elv3-scan-bin-copy" onclick="copyBinToClipboard('${data.bin}', event)" title="Click to copy">${data.bin}</span></p>` : ''}
                <p><strong>Devices Scanned:</strong> ${totalDevices}</p>
                <p><strong>Devices with Violations:</strong> ${devicesWithViolationsCount}</p>
                <p><strong>Satisfactory Devices:</strong> ${satisfactoryDevices.length}</p>
                <p><strong>Total Violations:</strong> ${data.violations.length}</p>
            </div>
            <div class="elv3-scan-action-row">
                <button class="elv3-scan-copy-all-btn" onclick="copyAllViolations(event)">
                    <span class="copy-icon">üìã</span>
                    <span class="copy-text">Copy All</span>
                </button>
            </div>
        `;
        
        resultHtml += `<div class="elv3-scan-results-scroll">`;
        
        // Show devices with violations
        if (data.violations.length > 0) {
            resultHtml += `
                <h5 class="elv3-scan-section-title violations">‚ö† Devices with Violations</h5>
                ${Object.entries(data.violationsByDevice).map(([deviceNumber, violations]) => {
                    // Get device field text from first violation (they all share the same device)
                    const deviceFieldText = violations[0]?.deviceFieldText || null;
                    return `
                    <div class="elv3-scan-device-group">
                        <div class="elv3-scan-device-header violations">
                            <span class="elv3-scan-device-number">${deviceNumber}${deviceFieldText ? ` <span class="elv3-scan-device-note">${deviceFieldText}</span>` : ''}</span>
                            <span class="elv3-scan-device-count">${violations.length} violation${violations.length > 1 ? 's' : ''}</span>
                        </div>
                        <div class="elv3-scan-device-violations">
                            ${violations.map(v => `
                                <div class="elv3-scan-violation-item">
                                    <div class="elv3-scan-violation-codes">
                                        <span class="elv3-scan-code-badge"><span class="code">${v.partCode}</span> Part</span>
                                        <span class="elv3-scan-code-badge"><span class="code">${v.conditionCode || '-'}</span> Cond</span>
                                        <span class="elv3-scan-code-badge"><span class="code">${v.remedyCode || '-'}</span> Remedy</span>
                                    </div>
                                    <div class="elv3-scan-violation-part">${v.partDescription}</div>
                                    <div class="elv3-scan-violation-details">${v.conditionDescription || ''} ‚Üí ${v.remedyDescription || ''}</div>
                                    ${v.comments ? `<div class="elv3-scan-violation-comment">"${v.comments}"</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `}).join('')}
            `;
        }
        
        // Show satisfactory devices
        if (satisfactoryDevices.length > 0) {
            resultHtml += `
                <h5 class="elv3-scan-section-title satisfactory">‚úì Satisfactory Devices</h5>
                <div class="elv3-scan-satisfactory-list">
                    ${satisfactoryDevices.map(device => `
                        <div class="elv3-scan-satisfactory-item">
                            <span class="elv3-scan-device-number">${device.deviceNumber}</span>
                            <span class="elv3-scan-satisfactory-badge">‚úì Satisfactory</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        resultHtml += `</div>`;
        
        if (container) container.innerHTML = resultHtml;
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('uploadELV3ScanModal');
            if (modal && modal.style.display !== 'none') {
                closeUploadELV3ScanModal();
            }
        }
    });

    // Close modal on outside click
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('elv3-scan-modal')) {
            closeUploadELV3ScanModal();
        }
    });
    </script>

    <button onclick="submitFeedback()" class="feedback-button">Submit Feedback</button>
    <div class="credit-text">Created by <a href="https://www.linkedin.com/in/michaelmontesano/" target="_blank">Michael Montesano</a></div>
</body>
</html>
